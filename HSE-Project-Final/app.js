/* ========================================
           Ù†Ø¸Ø§Ù… Ø§Ù„Ø³Ù„Ø§Ù…Ø© Ø§Ù„Ù…Ù‡Ù†ÙŠØ© - Ø£Ù…Ø±ÙŠÙƒØ§Ù†Ø§ HSE
   JavaScript Module - Ù…Ù†Ø¸Ù… ÙˆÙ…Ø­Ø³Ù‘Ù†
   ======================================== */

// ===== Permissions System =====
const Permissions = {
    /**
     * Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù…Ø¯ÙŠÙˆÙ„ Ù…Ø¹ÙŠÙ†
     */
    hasAccess(moduleName) {
        const user = AppState.currentUser;
        if (!user) return false;
        
        // Ø§Ù„Ù…Ø¯ÙŠØ± Ù„Ø¯ÙŠÙ‡ ØµÙ„Ø§Ø­ÙŠØ§Øª ÙƒØ§Ù…Ù„Ø©
        if (user.role === 'admin') return true;
        
        // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù„Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø®ØµØµØ©
        const users = AppState.appData.users || [];
        const dbUser = users.find(u => u.email && u.email.toLowerCase() === user.email.toLowerCase());
        
        if (dbUser && dbUser.permissions) {
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù„Ø¯Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØµÙ„Ø§Ø­ÙŠØ§Øª Ù…Ø®ØµØµØ©ØŒ Ù†ØªØ­Ù‚Ù‚ Ù…Ù†Ù‡Ø§ Ø£ÙˆÙ„Ø§Ù‹
            if (dbUser.permissions.hasOwnProperty(moduleName)) {
                return dbUser.permissions[moduleName] === true;
            }
            // Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© Ù…Ø­Ø¯Ø¯Ø© ÙÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø®ØµØµØ©ØŒ Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
        }
        
        // Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø¯ÙˆØ±
        // Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¹Ø§Ø¯ÙŠ Ù„Ø§ ÙŠÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ© - ÙŠØ¬Ø¨ Ù…Ù†Ø­Ù‡Ø§ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø¯ÙŠØ±
        const defaultPermissions = {
            'safety_officer': {
                'dashboard': true,
                'incidents': true,
                'nearmiss': true,
                'ptw': true,
                'training': true,
                'clinic': false,
                'fire-equipment': true,
                'ppe': true,
                'violations': true,
                'contractors': true,
                'employees': true,
                'behavior-monitoring': true,
                'chemical-safety': true,
                'daily-observations': true,
                'iso': false,
                'emergency': true,
                'action-tracking': true,
                'half-yearly-statistics': true,
                'users': false,
                'settings': false
            },
            'user': {
                // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¹Ø§Ø¯ÙŠ Ù„Ø§ ÙŠÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ© - ÙŠØ¬Ø¨ Ù…Ù†Ø­Ù‡Ø§ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø¯ÙŠØ±
                'dashboard': true, // ÙÙ‚Ø· Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
                'incidents': false,
                'nearmiss': false,
                'ptw': false,
                'training': false,
                'clinic': false,
                'fire-equipment': false,
                'ppe': false,
                'violations': false,
                'contractors': false,
                'employees': false,
                'behavior-monitoring': false,
                'chemical-safety': false,
                'daily-observations': false,
                'iso': false,
                'emergency': false,
                'action-tracking': false,
                'users': false,
                'settings': false
            }
        };
        
        const rolePermissions = defaultPermissions[user.role] || {};
        return rolePermissions[moduleName] === true;
    },
    
    /**
     * Ø¥Ø®ÙØ§Ø¡/Ø¥Ø¸Ù‡Ø§Ø± Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø­Ø³Ø¨ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
     */
    updateNavigation() {
        const navItems = document.querySelectorAll('.nav-item');
        navItems.forEach(item => {
            const module = item.getAttribute('data-section');
            if (module && !this.hasAccess(module)) {
                item.style.display = 'none';
            } else if (module) {
                item.style.display = '';
            }
        });
    },
    
    /**
     * Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ù‚Ø¨Ù„ Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø³Ù…
     */
    checkBeforeShow(moduleName) {
        if (!this.hasAccess(moduleName)) {
            Notification.error('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù…');
            return false;
        }
        return true;
    }
};

// ===== Global State =====
const AppState = {
    currentUser: null,
    currentSection: 'dashboard',
    currentLanguage: 'ar',
    appData: {
        users: [],
        incidents: [],
        nearmiss: [],
        ptw: [],
        training: [],
        clinicVisits: [],
        medications: [],
        sickLeave: [],
        clinicInventory: [],
        fireEquipment: [],
        ppe: [],
        violations: [],
        contractors: [],
        employees: [],
        behaviorMonitoring: [],
        chemicalSafety: [],
        dailyObservations: [],
        isoDocuments: [],
        isoProcedures: [],
        isoForms: [],
        emergencyAlerts: [],
        emergencyPlans: [],
        riskAssessments: [],
        sopJHA: [],
        legalDocuments: [], // Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠØ© ÙˆØ§Ù„ØªØ´Ø±ÙŠØ¹ÙŠØ©
        hseAudits: [], // Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚ ÙˆØ§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©
        hseNonConformities: [], // Ø¹Ø¯Ù… Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©
        hseCorrectiveActions: [], // Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„ØªØµØ­ÙŠØ­ÙŠØ©
        hseObjectives: [], // Ø£Ù‡Ø¯Ø§Ù HSE
        hseRiskAssessments: [], // ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø§Ù„Ù…Ø®Ø§Ø·Ø± HSE
        environmentalAspects: [], // Ø§Ù„Ø¬ÙˆØ§Ù†Ø¨ Ø§Ù„Ø¨ÙŠØ¦ÙŠØ©
        environmentalMonitoring: [], // Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø¨ÙŠØ¦ÙŠØ©
        sustainability: [], // Ø§Ù„Ø§Ø³ØªØ¯Ø§Ù…Ø© Ø§Ù„Ø¨ÙŠØ¦ÙŠØ©
        carbonFootprint: [], // Ø§Ù„Ø¨ØµÙ…Ø© Ø§Ù„ÙƒØ±Ø¨ÙˆÙ†ÙŠØ©
        wasteManagement: [], // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†ÙØ§ÙŠØ§Øª
        energyEfficiency: [], // ÙƒÙØ§Ø¡Ø© Ø§Ù„Ø·Ø§Ù‚Ø©
        waterManagement: [], // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙŠØ§Ù‡
        recyclingPrograms: [], // Ø¨Ø±Ø§Ù…Ø¬ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¯ÙˆÙŠØ±
        employeeTrainingMatrix: {}, // Ù…ØµÙÙˆÙØ© Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ù„ÙƒÙ„ Ù…ÙˆØ¸Ù
        employeePPEMatrix: {}, // Ù…ØµÙÙˆÙØ© Ù…Ù‡Ù…Ø§Øª Ø§Ù„ÙˆÙ‚Ø§ÙŠØ© Ù„ÙƒÙ„ Ù…ÙˆØ¸Ù Ø­Ø³Ø¨ Ø§Ù„ÙˆØ¸ÙŠÙØ©
        employeePPEMatrixByCode: {}, // Ù…ØµÙÙˆÙØ© Ù…Ù‡Ù…Ø§Øª Ø§Ù„ÙˆÙ‚Ø§ÙŠØ© Ù„ÙƒÙ„ Ù…ÙˆØ¸Ù Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ
        actionTrackingRegister: [], // Ø³Ø¬Ù„ Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª
        halfYearlyStatistics: {
            workInjuries: [], // Ø¥ØµØ§Ø¨Ø§Øª Ø§Ù„Ø¹Ù…Ù„ (Ù†Ù…ÙˆØ°Ø¬ Ø±Ù‚Ù… 2)
            ordinaryDiseases: [], // Ø§Ù„Ø£Ù…Ø±Ø§Ø¶ Ø§Ù„Ø¹Ø§Ø¯ÙŠØ© ÙˆØ§Ù„Ù…Ø²Ù…Ù†Ø© (Ù†Ù…ÙˆØ°Ø¬ Ø±Ù‚Ù… 5)
            occupationalDiseases: [], // Ø§Ù„Ø£Ù…Ø±Ø§Ø¶ Ø§Ù„Ù…Ù‡Ù†ÙŠØ© (Ù†Ù…ÙˆØ°Ø¬ Ø±Ù‚Ù… 3)
            seriousAccidents: [], // Ø§Ù„Ø­ÙˆØ§Ø¯Ø« Ø§Ù„Ø¬Ø³ÙŠÙ…Ø© (Ù†Ù…ÙˆØ°Ø¬ Ø±Ù‚Ù… 4)
            statisticsAppendix: {} // Ù…Ù„Ø­Ù‚ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ©
        }
    },
    googleConfig: {
        appsScript: {
            enabled: false,
            scriptUrl: ''
        },
        sheets: {
            enabled: false,
            spreadsheetId: '',
            apiKey: ''
        }
    },
    companyLogo: '',
    companySettings: {
        name: 'Ø§Ù„Ø´Ø±ÙƒØ© Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ© Ù„Ù„Ø§Ù†ØªØ§Ø¬ ÙˆØ§Ù„ØªØµÙ†ÙŠØ¹ Ø§Ù„Ø²Ø±Ø§Ø¹ÙŠ',
        address: '',
        phone: '',
        email: ''
    },
    dateFormat: 'gregorian', // 'gregorian' or 'hijri'
    notificationEmails: [], // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„Ø§Øª Ù„Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
    legalPortalUrl: '', // Ø±Ø§Ø¨Ø· Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„ØªØ´Ø±ÙŠØ¹Ø§Øª
    legalKeywords: [], // ÙƒÙ„Ù…Ø§Øª Ù…ÙØªØ§Ø­ÙŠØ© Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠØ©
    legalAutoNotify: false // ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ù„Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠØ©
};

// ===== Utility Functions =====
const Utils = {
    /**
     * ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù†Øµ Ù„Ù…Ù†Ø¹ XSS
     */
    escapeHTML(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = String(text);
            return div.innerHTML;
    },

    /**
     * Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
     */
    isValidEmail(email) {
        if (!email || typeof email !== 'string') return false;
        const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return re.test(email.trim());
    },

    /**
     * ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ®
     */
    formatDate(date, locale = null) {
        if (!date) return '-';
        
        const dateFormat = (typeof AppState !== 'undefined' && AppState.dateFormat) ? AppState.dateFormat : 'gregorian';
        const useLocale = locale || (dateFormat === 'hijri' ? 'ar-SA-u-ca-islamic' : 'en-GB');
        
        try {
            const d = new Date(date);
            if (isNaN(d.getTime())) return '-';
            
            return d.toLocaleDateString(useLocale, {
            year: 'numeric',
            month: 'long',
                day: 'numeric',
                calendar: dateFormat === 'hijri' ? 'islamic' : 'gregory'
            });
        } catch (error) {
            console.error('Ø®Ø·Ø£ ÙÙŠ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ®:', error);
            return '-';
        }
    },
    
    /**
     * ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª
     */
    formatDateTime(date, locale = null) {
        if (!date) return '-';
        
        const dateFormat = (typeof AppState !== 'undefined' && AppState.dateFormat) ? AppState.dateFormat : 'gregorian';
        const useLocale = locale || (dateFormat === 'hijri' ? 'ar-SA-u-ca-islamic' : 'en-GB');
        
        try {
            const d = new Date(date);
            if (isNaN(d.getTime())) return '-';
            
            return d.toLocaleString(useLocale, {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                calendar: dateFormat === 'hijri' ? 'islamic' : 'gregory'
            });
        } catch (error) {
            console.error('Ø®Ø·Ø£ ÙÙŠ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª:', error);
            return '-';
        }
    },

    /**
     * Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¹Ø±Ù ÙØ±ÙŠØ¯
     */
    generateId(prefix = 'ID') {
        return `${prefix}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    },
    
    /**
     * ØªØ´ÙÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… SHA-256
     */
    async hashPassword(password) {
        if (!password) return '';
        const encoder = new TextEncoder();
        const data = encoder.encode(password);
        const hashBuffer = await crypto.subtle.digest('SHA-256', data);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    },
    
    /**
     * Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (Ø¯Ø¹Ù… Ø§Ù„Ù†Øµ Ø§Ù„Ø¹Ø§Ø¯ÙŠ ÙˆØ§Ù„ØªØ´ÙÙŠØ±)
     */
    async verifyPassword(password, storedPassword) {
        if (!password || !storedPassword) return false;
        // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø®Ø²Ù†Ø© Ù†Øµ Ø¹Ø§Ø¯ÙŠ (Ù„Ù„ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø§Ù„Ø¥ØµØ¯Ø§Ø±Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©)
        if (storedPassword.length < 64) {
            return storedPassword === password;
        }
        // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…Ø´ÙØ±Ø©ØŒ Ù†Ù‚Ø§Ø±Ù† Ø§Ù„ØªØ´ÙÙŠØ±
        const hashedPassword = await this.hashPassword(password);
        return hashedPassword === storedPassword;
    },
    
    /**
     * Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù…Ø´ÙØ±Ø©
     */
    isHashedPassword(password) {
        return password && password.length === 64 && /^[a-f0-9]+$/i.test(password);
    }
};

// ===== Notification System =====
const Notification = {
    /**
     * Ø¹Ø±Ø¶ Ø¥Ø´Ø¹Ø§Ø±
     */
    show(message, type = 'info', duration = 3000) {
        const container = document.getElementById('notification-container');
        if (!container) return;

        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        
        const icons = {
            success: 'fa-check-circle',
            error: 'fa-exclamation-circle',
            warning: 'fa-exclamation-triangle',
            info: 'fa-info-circle'
        };

        notification.innerHTML = `
            <i class="fas ${icons[type] || icons.info} notification-icon"></i>
            <div class="notification-content">
                <div class="notification-message">${Utils.escapeHTML(message)}</div>
            </div>
        `;

        container.appendChild(notification);

        setTimeout(() => {
            notification.style.animation = 'slideOutLeft 0.3s ease';
            setTimeout(() => notification.remove(), 300);
        }, duration);
    },

    success(message) { this.show(message, 'success'); },
    error(message) { this.show(message, 'error'); },
    warning(message) { this.show(message, 'warning'); },
    info(message) { this.show(message, 'info'); }
};

// ===== Loading System =====
const Loading = {
    show() {
        const overlay = document.getElementById('loading-overlay');
        if (overlay) overlay.style.display = 'flex';
    },

    hide() {
        const overlay = document.getElementById('loading-overlay');
        if (overlay) overlay.style.display = 'none';
    }
};

// ===== Data Management =====
const DataManager = {
        /**
         * ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† localStorage
     */
    load() {
        try {
            const saved = localStorage.getItem('hse_app_data');
            if (saved) {
                const parsedData = JSON.parse(saved);
                // Ø¯Ù…Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© (Ù„Ø§ Ù†Ø³ØªØ¨Ø¯Ù„Ù‡Ø§ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„)
                // Ù„ÙƒÙ† Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
                Object.keys(parsedData).forEach(key => {
                    if (parsedData[key] && Array.isArray(parsedData[key])) {
                        AppState.appData[key] = parsedData[key];
                    }
                });
            }
            return true;
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
            Notification.error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©');
            return false;
            }
    },

        /**
         * Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ localStorage
         */
    save() {
            try {
            localStorage.setItem('hse_app_data', JSON.stringify(AppState.appData));
                return true;
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
            Notification.error('ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
                return false;
            }
    },

    /**
     * ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Google
     */
    loadGoogleConfig() {
        try {
            const config = localStorage.getItem('hse_google_config');
            if (config) {
                AppState.googleConfig = JSON.parse(config);
            }
        } catch (error) {
            console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Google:', error);
        }
    },

    /**
     * Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Google
     */
    saveGoogleConfig() {
        try {
            localStorage.setItem('hse_google_config', JSON.stringify(AppState.googleConfig));
            return true;
        } catch (error) {
            console.error('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Google:', error);
            return false;
        }
    }
};

// ===== Google Integration =====
const GoogleIntegration = {
    /**
     * Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙÙŠ Google Sheets (Ø®Ù„ÙÙŠØ©ØŒ Ø¨Ø¯ÙˆÙ† Ø¥Ø¸Ù‡Ø§Ø± Ø£Ø®Ø·Ø§Ø¡ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…)
     */
    async autoSave(sheetName, data) {
        if (!AppState.googleConfig.appsScript.enabled || !AppState.googleConfig.appsScript.scriptUrl) {
            return;
        }

        try {
            const spreadsheetId = AppState.googleConfig.sheets.spreadsheetId;
            if (!spreadsheetId || spreadsheetId.trim() === '') {
                return; // Ù„Ø§ Ù†Ø¹Ø±Ø¶ Ø®Ø·Ø£ØŒ ÙÙ‚Ø· Ù†ØªØ¬Ø§Ù‡Ù„
            }

            await this.sendToAppsScript('saveToSheet', {
                sheetName,
                data,
                spreadsheetId: spreadsheetId.trim()
            });
        } catch (error) {
            // Ù„Ø§ Ù†Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ù„Ù„Ø­ÙØ¸ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØŒ ÙÙ‚Ø· Ù†ÙƒØªØ¨ ÙÙŠ console
            console.log(`Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù€ ${sheetName} ÙØ´Ù„ (Ø³ÙŠØªÙ… Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø¹Ù†Ø¯ Ø§Ù„Ø­ÙØ¸ Ø§Ù„ÙŠØ¯ÙˆÙŠ):`, error.message);
        }
    },

    /**
     * Ø¥Ø±Ø³Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Google Apps Script
     */
    async sendToAppsScript(action, data) {
        if (!AppState.googleConfig.appsScript.enabled || !AppState.googleConfig.appsScript.scriptUrl) {
            return Promise.reject(new Error('Google Apps Script ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„'));
        }

        const scriptUrl = AppState.googleConfig.appsScript.scriptUrl.trim();
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© URL
        if (!scriptUrl || !scriptUrl.includes('script.google.com') || !scriptUrl.endsWith('/exec')) {
            throw new Error('URL ØºÙŠØ± ØµØ­ÙŠØ­. ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø±Ø§Ø¨Ø· Google Apps Script ÙˆÙŠÙ†ØªÙ‡ÙŠ Ø¨Ù€ /exec');
        }

        try {
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… text/plain Ù„ØªØ¬Ù†Ø¨ preflight CORS requests
            // Google Apps Script ÙŠØ¯Ø¹Ù… Ù‡Ø°Ø§ Ø§Ù„Ù†ÙˆØ¹ Ù…Ù† Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø¨Ø¯ÙˆÙ† Ù…Ø´Ø§ÙƒÙ„ CORS
            const response = await fetch(scriptUrl, {
                method: 'POST',
                mode: 'cors',
                credentials: 'omit',
                headers: { 
                    'Content-Type': 'text/plain;charset=utf-8'
                },
                body: JSON.stringify({ 
                    action, 
                    data, 
                    timestamp: new Date().toISOString() 
                })
            });

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©
            if (!response.ok) {
                // Ù…Ø­Ø§ÙˆÙ„Ø© Ù‚Ø±Ø§Ø¡Ø© Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ Ù…Ù† Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©
                let errorMessage = `HTTP error! status: ${response.status}`;
                try {
                    const errorData = await response.text();
                    if (errorData) {
                        const parsed = JSON.parse(errorData);
                        errorMessage = parsed.message || errorMessage;
                    }
                } catch (e) {
                    // Ø¥Ø°Ø§ ÙØ´Ù„ parsingØŒ Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
                }
                
                throw new Error(errorMessage);
            }

            const resultText = await response.text();
            let result;
            
            try {
                result = JSON.parse(resultText);
            } catch (e) {
                // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† JSON ØµØ§Ù„Ø­Ø§Ù‹
                throw new Error(`Ø§Ø³ØªØ¬Ø§Ø¨Ø© ØºÙŠØ± ØµØ§Ù„Ø­Ø© Ù…Ù† Google Apps Script: ${resultText.substring(0, 100)}`);
            }

            if (!result.success) {
                throw new Error(result.message || 'ÙØ´Ù„ ØªÙ†ÙÙŠØ° Ø§Ù„Ø¹Ù…Ù„ÙŠØ©');
            }

            return result;
        } catch (error) {
            console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
            
            // ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ø®Ø·Ø£ ÙˆØ¥Ø±Ø¬Ø§Ø¹ Ø±Ø³Ø§Ù„Ø© Ù…Ù†Ø§Ø³Ø¨Ø©
            let errorMessage = error.message;
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø®Ø·Ø£ CORS Ø£Ùˆ Network
            if (error.message.includes('Failed to fetch') || 
                error.message.includes('NetworkError') || 
                error.message.includes('CORS') ||
                error.name === 'TypeError') {
                
                errorMessage = `ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ù…Ø¹ Google Apps Script. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù†:
1. Ù†Ø´Ø± Web App Ù…Ø¹ "Who has access: Anyone"
2. Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¢Ø®Ø± Ø¥ØµØ¯Ø§Ø± Ù…Ù† Ø§Ù„Ù†Ø´Ø± (New deployment)
3. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† URL Ø§Ù„ØµØ­ÙŠØ­ (ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙ†ØªÙ‡ÙŠ Ø¨Ù€ /exec)
4. ØªÙØ¹ÙŠÙ„ Google Apps Script API ÙÙŠ Google Cloud Console
Ø§Ù„Ø®Ø·Ø£: ${error.message}`;
            } else if (error.message.includes('HTTP error')) {
                errorMessage = `ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Google Apps Script. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù†:
1. Ù†Ø´Ø± Web App Ù…Ø¹ "Who has access: Anyone"
2. Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¢Ø®Ø± Ø¥ØµØ¯Ø§Ø± Ù…Ù† Ø§Ù„Ù†Ø´Ø±
3. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† URL Ø§Ù„ØµØ­ÙŠØ­
Ø§Ù„Ø®Ø·Ø£: ${error.message}`;
            }
            
            return Promise.reject(new Error(errorMessage));
        }
    },

    /**
     * Ù‚Ø±Ø§Ø¡Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Google Sheets Ø¹Ø¨Ø± Apps Script
     */
    async readFromSheets(sheetName) {
        if (!AppState.googleConfig.appsScript.enabled || !AppState.googleConfig.appsScript.scriptUrl) {
            return Promise.reject(new Error('Google Apps Script ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„'));
        }

        try {
            const spreadsheetId = AppState.googleConfig.sheets.spreadsheetId || '';
            const url = new URL(AppState.googleConfig.appsScript.scriptUrl);
            url.searchParams.append('action', 'getData');
            url.searchParams.append('sheetName', sheetName);
            if (spreadsheetId) {
                url.searchParams.append('spreadsheetId', spreadsheetId);
            }

            // Ø§Ø³ØªØ®Ø¯Ø§Ù… mode: 'no-cors' Ù„Ù„Ù‚Ø±Ø§Ø¡Ø© Ù…Ù† Google Apps Script
            // Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ø§Ù… JSONP
            const response = await fetch(url.toString(), {
                method: 'GET',
                mode: 'cors', // Ù†Ø­Ø§ÙˆÙ„ cors Ø£ÙˆÙ„Ø§Ù‹
                credentials: 'omit',
                headers: {
                    'Accept': 'application/json'
                }
            }).catch(async () => {
                // Ø¥Ø°Ø§ ÙØ´Ù„ CORSØŒ Ù†Ø­Ø§ÙˆÙ„ Ø¨Ø·Ø±ÙŠÙ‚Ø© Ø£Ø®Ø±Ù‰
                console.warn('Ù…Ø­Ø§ÙˆÙ„Ø© Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø·Ø±ÙŠÙ‚Ø© Ø¨Ø¯ÙŠÙ„Ø©...');
                // ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ®Ø¯Ø§Ù… JSONP Ø£Ùˆ Ø·Ø±ÙŠÙ‚Ø© Ø£Ø®Ø±Ù‰ Ù‡Ù†Ø§
                return { ok: false };
            });

            if (!response || !response.ok) {
                // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ®Ø¯Ø§Ù… script tag injection Ù„Ù„Ù€ JSONP
                console.warn('ÙØ´Ù„ CORS - ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Google Apps Script');
                return [];
            }

            const result = await response.json();
            if (result.success && result.data) {
                return result.data;
            }
            return [];
        } catch (error) {
            console.error('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
            // Ø¥Ø±Ø¬Ø§Ø¹ Ù…ØµÙÙˆÙØ© ÙØ§Ø±ØºØ© Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø±ÙØ¶ Promise
            console.warn('Ø³ÙŠØªÙ… Ø§Ù„Ø¹Ù…Ù„ Ø¨Ø¯ÙˆÙ† Google Sheets Ø­ØªÙ‰ ÙŠØªÙ… Ø¥ØµÙ„Ø§Ø­ CORS');
            return [];
        }
    },

    /**
     * Ø­ÙØ¸ ÙÙŠ Google Sheets (Ø§Ø³ØªØ¨Ø¯Ø§Ù„ ÙƒØ§Ù…Ù„)
     */
    async saveToSheets(sheetName, data) {
        if (!AppState.googleConfig.appsScript.enabled) {
            console.warn('Google Apps Script ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„');
            return { success: false, message: 'Google Apps Script ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„' };
        }

        try {
            const result = await this.sendToAppsScript('saveToSheet', { 
                sheetName, 
                data 
            });
            return result;
        } catch (error) {
            console.warn('ÙØ´Ù„ Ø­ÙØ¸ ÙÙŠ Google Sheets:', error);
            return { success: false, message: error.message };
        }
    },

    /**
     * Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù†Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ø¥Ù„Ù‰ Google Sheets (Ø¨Ø¯ÙˆÙ† Ø§Ø³ØªØ¨Ø¯Ø§Ù„)
     */
    async appendToSheets(sheetName, data) {
        if (!AppState.googleConfig.appsScript.enabled || !AppState.googleConfig.appsScript.scriptUrl) {
            console.warn('Google Apps Script ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„');
            return { success: false, message: 'Google Apps Script ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„' };
        }

        try {
            // Ø¥Ø¶Ø§ÙØ© spreadsheetId Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
            const payload = { 
                sheetName, 
                data 
            };
            
            if (AppState.googleConfig.sheets.spreadsheetId) {
                payload.spreadsheetId = AppState.googleConfig.sheets.spreadsheetId;
            }
            
            const result = await this.sendToAppsScript('appendToSheet', payload);
            
            if (result && result.success) {
                console.log(`ØªÙ… Ø­ÙØ¸ ${sheetName} Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ Google Sheets`);
            } else {
                console.warn(`ÙØ´Ù„ Ø­ÙØ¸ ${sheetName}:`, result?.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ');
            }
            
            return result;
        } catch (error) {
            console.warn('ÙØ´Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
            return { success: false, message: error.message };
        }
    },
    
    /**
     * Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Google Sheets (Ø§Ø³ØªØ¨Ø¯Ø§Ù„ ÙƒØ§Ù…Ù„)
     */
    async saveAllToSheets() {
        if (!AppState.googleConfig.appsScript.enabled || !AppState.googleConfig.appsScript.scriptUrl) {
            return { success: false, message: 'Google Apps Script ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„' };
        }

        try {
            Loading.show();
            const sheets = {
                'Users': AppState.appData.users || [],
                'Incidents': AppState.appData.incidents || [],
                'NearMiss': AppState.appData.nearmiss || [],
                'PTW': AppState.appData.ptw || [],
                'Training': AppState.appData.training || [],
                'ClinicVisits': AppState.appData.clinicVisits || [],
                'Medications': AppState.appData.medications || [],
                'SickLeave': AppState.appData.sickLeave || [],
                'Injuries': AppState.appData.injuries || [],
                'ClinicInventory': AppState.appData.clinicInventory || [],
                'FireEquipment': AppState.appData.fireEquipment || [],
                'PPE': AppState.appData.ppe || [],
                'Violations': AppState.appData.violations || [],
                'Contractors': AppState.appData.contractors || [],
                'Employees': AppState.appData.employees || [],
                'BehaviorMonitoring': AppState.appData.behaviorMonitoring || [],
                'ChemicalSafety': AppState.appData.chemicalSafety || [],
                'DailyObservations': AppState.appData.dailyObservations || [],
                'ISODocuments': AppState.appData.isoDocuments || [],
                'ISOProcedures': AppState.appData.isoProcedures || [],
                'ISOForms': AppState.appData.isoForms || [],
                'SOPJHA': AppState.appData.sopJHA || [],
                'RiskAssessments': AppState.appData.riskAssessments || [],
                'LegalDocuments': AppState.appData.legalDocuments || [],
                'ActionTrackingRegister': AppState.appData.actionTrackingRegister || []
            };

            let successCount = 0;
            let failCount = 0;

            const spreadsheetId = AppState.googleConfig.sheets.spreadsheetId;
            
            if (!spreadsheetId || spreadsheetId.trim() === '') {
                Loading.hide();
                Notification.error('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¹Ø±Ù Google Sheets ÙÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø£ÙˆÙ„Ø§Ù‹');
                return { success: false, message: 'Ù…Ø¹Ø±Ù Google Sheets ØºÙŠØ± Ù…Ø­Ø¯Ø¯' };
            }

            for (const [sheetName, data] of Object.entries(sheets)) {
                try {
                    await this.sendToAppsScript('saveToSheet', {
                        sheetName,
                        data,
                        spreadsheetId: spreadsheetId.trim()
                    });
                    successCount++;
                } catch (error) {
                    console.warn(`ÙØ´Ù„ Ø­ÙØ¸ ${sheetName}:`, error);
                    failCount++;
                }
            }

            Loading.hide();
            
            if (failCount === 0) {
                Notification.success(`ØªÙ… Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Google Sheets Ø¨Ù†Ø¬Ø§Ø­`);
                return { success: true };
            } else {
                Notification.warning(`ØªÙ… Ø­ÙØ¸ ${successCount} ÙˆØ±Ù‚Ø©ØŒ ÙØ´Ù„ ${failCount} ÙˆØ±Ù‚Ø©`);
                return { success: false, message: `ÙØ´Ù„ Ø­ÙØ¸ ${failCount} ÙˆØ±Ù‚Ø©` };
            }
        } catch (error) {
            Loading.hide();
            Notification.error('ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + error.message);
            return { success: false, message: error.message };
        }
    },

    /**
     * Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙÙŠ Google Sheets
     */
    async initializeSheets() {
        if (!AppState.googleConfig.appsScript.enabled || !AppState.googleConfig.appsScript.scriptUrl) {
            return Promise.reject(new Error('Google Apps Script ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„'));
        }

        try {
            Loading.show();
            const spreadsheetId = AppState.googleConfig.sheets.spreadsheetId || '';
            
            const result = await this.sendToAppsScript('initializeSheets', { 
                spreadsheetId: spreadsheetId || undefined
            });

            Loading.hide();
            if (result.success) {
                Notification.success('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ Ø¨Ù†Ø¬Ø§Ø­');
                return true;
            } else {
                Notification.error('ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø£ÙˆØ±Ø§Ù‚: ' + result.message);
                return false;
            }
        } catch (error) {
            Loading.hide();
            Notification.error('ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø£ÙˆØ±Ø§Ù‚: ' + error.message);
            return Promise.reject(error);
        }
    },

    /**
     * Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹ Google Sheets
     */
    async syncData() {
        if (!AppState.googleConfig.appsScript.enabled || !AppState.googleConfig.sheets.spreadsheetId) {
            console.log('Google Sheets ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„ Ø£Ùˆ spreadsheetId ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ - Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©');
            return false;
        }

        try {
            console.log('ğŸ”„ Ø¨Ø¯Ø¡ Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Google Sheets...');

            // Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ÙˆØ±Ø§Ù‚
            const sheets = ['Users', 'Incidents', 'NearMiss', 'PTW', 'Training', 'ClinicVisits', 'Medications', 'SickLeave', 'Injuries', 'ClinicInventory', 'FireEquipment', 'PPE', 'Violations', 'Contractors', 'Employees', 'BehaviorMonitoring', 'ChemicalSafety', 'DailyObservations', 'ISODocuments', 'ISOProcedures', 'ISOForms', 'SOPJHA', 'RiskAssessments', 'LegalDocuments', 'HSEAudits', 'HSENonConformities', 'HSECorrectiveActions', 'HSEObjectives', 'HSERiskAssessments', 'EnvironmentalAspects', 'EnvironmentalMonitoring', 'Sustainability', 'CarbonFootprint', 'WasteManagement', 'EnergyEfficiency', 'WaterManagement', 'RecyclingPrograms', 'ActionTrackingRegister'];
            const sheetMapping = {
                'Users': 'users',
                'Incidents': 'incidents',
                'NearMiss': 'nearmiss',
                'PTW': 'ptw',
                'Training': 'training',
                'ClinicVisits': 'clinicVisits',
                'Medications': 'medications',
                'SickLeave': 'sickLeave',
                'Injuries': 'injuries',
                'ClinicInventory': 'clinicInventory',
                'FireEquipment': 'fireEquipment',
                'PPE': 'ppe',
                'Violations': 'violations',
                'Contractors': 'contractors',
                'Employees': 'employees',
                'BehaviorMonitoring': 'behaviorMonitoring',
                'ChemicalSafety': 'chemicalSafety',
                'DailyObservations': 'dailyObservations',
                'ISODocuments': 'isoDocuments',
                'ISOProcedures': 'isoProcedures',
                'ISOForms': 'isoForms',
                'SOPJHA': 'sopJHA',
                'RiskAssessments': 'riskAssessments',
                'LegalDocuments': 'legalDocuments',
                'HSEAudits': 'hseAudits',
                'HSENonConformities': 'hseNonConformities',
                'HSECorrectiveActions': 'hseCorrectiveActions',
                'HSEObjectives': 'hseObjectives',
                'HSERiskAssessments': 'hseRiskAssessments',
                'EnvironmentalAspects': 'environmentalAspects',
                'EnvironmentalMonitoring': 'environmentalMonitoring',
                'Sustainability': 'sustainability',
                'CarbonFootprint': 'carbonFootprint',
                'WasteManagement': 'wasteManagement',
                'EnergyEfficiency': 'energyEfficiency',
                'WaterManagement': 'waterManagement',
                'RecyclingPrograms': 'recyclingPrograms',
                'ActionTrackingRegister': 'actionTrackingRegister'
            };

            let syncedCount = 0;
            let failedCount = 0;

            for (const sheetName of sheets) {
                try {
                    const data = await this.readFromSheets(sheetName);
                    const key = sheetMapping[sheetName];
                    if (key && Array.isArray(data)) {
                        // Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Google Sheets (Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Google Sheets)
                        // Ø­ØªÙ‰ Ù„Ùˆ ÙƒØ§Ù†Øª ÙØ§Ø±ØºØ©ØŒ Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Google Sheets Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªÙˆØ§ÙÙ‚
                        AppState.appData[key] = data;
                        if (data.length > 0) {
                            syncedCount++;
                            console.log(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${data.length} Ø³Ø¬Ù„ Ù…Ù† ${sheetName}`);
                        } else {
                            // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙØ§Ø±ØºØ© ÙÙŠ Google SheetsØŒ Ù†Ø³ØªØ®Ø¯Ù… Ù…ØµÙÙˆÙØ© ÙØ§Ø±ØºØ©
                            AppState.appData[key] = [];
                            console.log(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${sheetName} (ÙØ§Ø±Øº - ØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø¨Ù…ØµÙÙˆÙØ© ÙØ§Ø±ØºØ©)`);
                        }
                    }
                } catch (error) {
                    console.warn(`âš ï¸ ÙØ´Ù„ Ù‚Ø±Ø§Ø¡Ø© ${sheetName}:`, error);
                    failedCount++;
                    // ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„ÙØ´Ù„ØŒ Ù†Ø­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ù„ØªÙ„Ùƒ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ ÙÙ‚Ø·
                }
            }

            // Ø­ÙØ¸ ÙÙŠ localStorage Ø¨Ø¹Ø¯ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© (Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ) - Ù‡Ø°Ø§ ÙŠØ¶Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙŠØ­ØµÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            DataManager.save();

            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø£Ù…Ø§Ù…ÙŠØ© Ø¨Ø¹Ø¯ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù„Ø¶Ù…Ø§Ù† Ø¸Ù‡ÙˆØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            console.log('ğŸ”„ ØªÙ… ØªØ­Ø¯ÙŠØ« AppState.appData Ø¨Ø¹Ø¯ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©ØŒ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ø¹Ø±Ø¶');

            console.log(`âœ… Ø§ÙƒØªÙ…Ù„Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©: ${syncedCount} Ø¬Ø¯ÙˆÙ„ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§ØªØŒ ${failedCount} Ø¬Ø¯ÙˆÙ„ ÙØ´Ù„`);
            
            // Ø¥Ø±Ø¬Ø§Ø¹ true Ø¥Ø°Ø§ ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø£ÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ùˆ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ù…ØªØ§Ø­Ø© (Ø­ØªÙ‰ Ù„Ùˆ ÙƒØ§Ù†Øª ÙØ§Ø±ØºØ©)
            // Ù‡Ø°Ø§ ÙŠØ¶Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙŠØ­ØµÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø­ØªÙ‰ Ù„Ùˆ ÙƒØ§Ù†Øª ÙØ§Ø±ØºØ© ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
            if (syncedCount > 0 || sheets.length - failedCount > 0) {
                // Ø­ØªÙ‰ Ù„Ùˆ Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§ØªØŒ Ù„ÙƒÙ† ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ù†ÙŠØ©
            return true;
            } else {
                console.warn('âš ï¸ Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø£ÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Google Sheets');
                return false;
            }
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©:', error);
            return false;
        }
    }
};

// ===== Authentication System =====
const Auth = {
    // Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ†ÙˆØ§ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙ‚Ø·
    // Ù„Ø§ ÙŠØªÙ… ØªØ®Ø²ÙŠÙ† ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ Ù„Ø£Ø³Ø¨Ø§Ø¨ Ø£Ù…Ù†ÙŠØ©
    validUsers: {
        // ØªÙ… Ø¥Ø²Ø§Ù„Ø© ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± Ù…Ù† Ø§Ù„ÙƒÙˆØ¯ Ù„Ø£Ø³Ø¨Ø§Ø¨ Ø£Ù…Ù†ÙŠØ©
        // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ø§Ù„Ø¢Ù† ÙŠÙØ­Ù…Ù„ÙˆÙ† Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙ‚Ø·
    },

    /**
     * ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
     */
    async login(email, password, remember = false) {
        console.log('ğŸ” Ø¨Ø¯Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„:', { email, passwordLength: password?.length, remember });
        
        if (!email || !password) {
            console.warn('âŒ Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©:', { email: !!email, password: !!password });
            Notification.error('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±');
            return false;
        }

        email = email.trim().toLowerCase();
        console.log('âœ… Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ†Ø¸ÙŠÙ:', email);

        if (!Utils.isValidEmail(email)) {
            console.warn('âŒ Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­:', email);
            Notification.error('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØµØ­ÙŠØ­');
            return false;
        }

        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Google Sheets Ù‚Ø¨Ù„ Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        // Ù‡Ø°Ø§ ÙŠØ¶Ù…Ù† Ø£Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ø¯Ø«Ø© Ø¯Ø§Ø¦Ù…Ø§Ù‹
        if (AppState.googleConfig.appsScript.enabled && AppState.googleConfig.sheets.spreadsheetId) {
            try {
                console.log('ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ù† Google Sheets Ù‚Ø¨Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...');
                await GoogleIntegration.syncData();
                console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ù† Google Sheets');
            } catch (error) {
                console.warn('âš ï¸ ÙØ´Ù„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Google Sheets:', error);
                // Ù†Ø³ØªÙ…Ø± ÙÙŠ Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
            }
        }

        // Ù…Ù„Ø§Ø­Ø¸Ø©: ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø«Ø§Ø¨ØªÙŠÙ† Ù„Ø£Ø³Ø¨Ø§Ø¨ Ø£Ù…Ù†ÙŠØ©
        // Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ†ÙˆØ§ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙ‚Ø·
        let user = null; // ØªÙ… Ø¥Ø²Ø§Ù„Ø© validUsers Ù„Ø£Ø³Ø¨Ø§Ø¨ Ø£Ù…Ù†ÙŠØ©
        
        // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ù† Google Sheets
        let foundUser = null;
        let users = AppState.appData.users || [];
        
        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ø°Ø§ ÙƒØ§Ù†Øª ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ JSON strings (Ù…Ù† Google Sheets)
        if (users.length > 0) {
            users = users.map(u => {
                // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª permissions Ø¹Ø¨Ø§Ø±Ø© Ø¹Ù† string JSONØŒ Ù†Ø­ÙˆÙ„Ù‡Ø§ Ø¥Ù„Ù‰ ÙƒØ§Ø¦Ù†
                if (typeof u.permissions === 'string' && u.permissions.trim() !== '') {
                    try {
                        u.permissions = JSON.parse(u.permissions);
                    } catch (e) {
                        console.warn('âš ï¸ ÙØ´Ù„ ØªØ­Ù„ÙŠÙ„ permissions:', e);
                        u.permissions = {};
                    }
                }
                // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª loginHistory Ø¹Ø¨Ø§Ø±Ø© Ø¹Ù† string JSONØŒ Ù†Ø­ÙˆÙ„Ù‡Ø§ Ø¥Ù„Ù‰ Ù…ØµÙÙˆÙØ©
                if (typeof u.loginHistory === 'string' && u.loginHistory.trim() !== '') {
                    try {
                        u.loginHistory = JSON.parse(u.loginHistory);
                    } catch (e) {
                        console.warn('âš ï¸ ÙØ´Ù„ ØªØ­Ù„ÙŠÙ„ loginHistory:', e);
                        u.loginHistory = [];
                    }
                }
                return u;
            });
        }
        
        console.log('ğŸ” Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŒ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†:', users.length);
        
        if (users.length > 0) {
            // Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¹Ø¯Ø© Ø·Ø±Ù‚ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            foundUser = users.find(u => {
                if (!u || !u.email) return false;
                const userEmail = typeof u.email === 'string' ? u.email.toLowerCase().trim() : '';
                return userEmail === email;
            });
            console.log('ğŸ” Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', foundUser ? 'âœ… Ù…ÙˆØ¬ÙˆØ¯' : 'âŒ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
            
            if (foundUser) {
                console.log('ğŸ“‹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯:', {
                    email: foundUser.email,
                    name: foundUser.name,
                    role: foundUser.role,
                    active: foundUser.active,
                    hasPassword: !!foundUser.password
                });
            }
        }
        
        // Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„ÙŠÙ‡ ÙÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø«Ø§Ø¨ØªÙŠÙ†ØŒ Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        if (!user && foundUser) {
            console.log('âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø³Ø§Ø¨ (Ø¥Ø°Ø§ ÙƒØ§Ù†Øª active ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø© Ø£Ùˆ trueØŒ Ù†Ø¹ØªØ¨Ø±Ù‡Ø§ Ù…ÙØ¹Ù‘Ù„Ø©)
            if (foundUser.active === false || foundUser.active === 'false') {
                console.warn('âŒ Ø§Ù„Ø­Ø³Ø§Ø¨ ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„');
                Notification.error('Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨ ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù…Ø¯ÙŠØ±');
                return false;
            }
            
            user = {
                name: foundUser.name || 'Ù…Ø³ØªØ®Ø¯Ù…',
                password: foundUser.password || '',
                role: foundUser.role || 'user',
                department: foundUser.department || '',
                permissions: foundUser.permissions || {},
                id: foundUser.id,
                email: foundUser.email
            };
        } else if (!user && !foundUser) {
            console.warn('âŒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
            Notification.error('Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
            return false;
        }

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        if (!user) {
            console.error('âŒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
            Notification.error('Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
            return false;
        }
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
        if (!user.password || user.password.trim() === '') {
            console.error('âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…');
            Notification.error('Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
            return false;
        }
        
        console.log('ğŸ”‘ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:', { 
            expectedLength: user.password?.length, 
            receivedLength: password?.length, 
            match: user.password === password 
        });
        
        // Ù…Ù‚Ø§Ø±Ù†Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (Ù…Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ø³Ø§ÙØ§Øª)
        const userPassword = user.password.trim();
        const inputPassword = password.trim();
        
        if (userPassword !== inputPassword) {
            console.error('âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
            console.log('ğŸ” ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø©:', {
                expected: userPassword.substring(0, 3) + '***',
                received: inputPassword.substring(0, 3) + '***',
                expectedLength: userPassword.length,
                receivedLength: inputPassword.length
            });
            Notification.error('Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
            return false;
        }

        const loginTime = new Date().toISOString();
        
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„ÙƒØ§Ù…Ù„Ø© Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù† ÙˆØ¬Ø¯Øª
        const fullUserData = foundUser || (users.find(u => {
            if (!u || !u.email) return false;
            const userEmail = typeof u.email === 'string' ? u.email.toLowerCase().trim() : '';
            return userEmail === email;
        }));

        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø¥Ø°Ø§ ÙƒØ§Ù†Øª JSON string
        let userPermissions = user.permissions || {};
        if (fullUserData && fullUserData.permissions) {
            if (typeof fullUserData.permissions === 'string') {
                try {
                    userPermissions = JSON.parse(fullUserData.permissions);
                } catch (e) {
                    console.warn('âš ï¸ ÙØ´Ù„ ØªØ­Ù„ÙŠÙ„ permissions:', e);
                    userPermissions = {};
                }
            } else {
                userPermissions = fullUserData.permissions;
            }
        }

        AppState.currentUser = {
            email,
            name: user.name,
            role: user.role || 'user',
            department: user.department || '',
            permissions: userPermissions,
            id: fullUserData?.id || user.id,
            loginTime: loginTime
        };

        console.log('âœ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù†Ø§Ø¬Ø­:', AppState.currentUser);
        console.log('ğŸ“‹ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª:', AppState.currentUser.permissions);

        // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const usersList = AppState.appData.users || [];
        const userIndex = usersList.findIndex(u => u.email && u.email.toLowerCase() === email);
        if (userIndex !== -1) {
            usersList[userIndex].lastLogin = loginTime;
            usersList[userIndex].isOnline = true;
            usersList[userIndex].loginHistory = usersList[userIndex].loginHistory || [];
            usersList[userIndex].loginHistory.push({
                time: loginTime,
                ip: 'N/A',
                userAgent: navigator.userAgent.substring(0, 100)
            });
            // Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø¢Ø®Ø± 10 Ø¹Ù…Ù„ÙŠØ§Øª ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ ÙÙ‚Ø·
            if (usersList[userIndex].loginHistory.length > 10) {
                usersList[userIndex].loginHistory = usersList[userIndex].loginHistory.slice(-10);
            }
            AppState.appData.users = usersList;
            DataManager.save();
            // Ù…Ø­Ø§ÙˆÙ„Ø© Ø­ÙØ¸ ÙÙŠ Google Sheets (Ø®Ù„ÙÙŠØ©)
            if (AppState.googleConfig.appsScript.enabled) {
                GoogleIntegration.appendToSheets('Users', [usersList[userIndex]]).catch(err => {
                    console.warn('âš ï¸ ÙØ´Ù„ Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙÙŠ Google Sheets:', err);
                });
            }
        } else if (!foundUser && user) {
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù„Ù‰ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¬Ø¯ÙŠØ¯Ø§Ù‹)
            const newUser = {
                id: Utils.generateId('USER'),
                email: email,
                name: user.name,
                password: user.password,
                role: user.role || 'user',
                department: user.department || '',
                active: true,
                permissions: user.permissions || {},
                lastLogin: loginTime,
                isOnline: true,
                loginHistory: [{
                    time: loginTime,
                    ip: 'N/A',
                    userAgent: navigator.userAgent.substring(0, 100)
                }],
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            AppState.appData.users.push(newUser);
            DataManager.save();
            // Ù…Ø­Ø§ÙˆÙ„Ø© Ø­ÙØ¸ ÙÙŠ Google Sheets (Ø®Ù„ÙÙŠØ©)
            if (AppState.googleConfig.appsScript.enabled) {
                GoogleIntegration.appendToSheets('Users', [newUser]).catch(err => {
                    console.warn('âš ï¸ ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙÙŠ Google Sheets:', err);
                });
            }
        }

        // Ø­ÙØ¸ Ø§Ù„Ø¬Ù„Ø³Ø© Ø¯Ø§Ø¦Ù…Ø§Ù‹ (Ù„Ù„Ù…ØªØµÙØ­ Ø§Ù„Ø­Ø§Ù„ÙŠ)
        sessionStorage.setItem('hse_current_session', JSON.stringify(AppState.currentUser));
        console.log('ğŸ’¾ ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¬Ù„Ø³Ø© ÙÙŠ sessionStorage');
        
        // Ø¥Ø°Ø§ Ø§Ø®ØªØ§Ø± "ØªØ°ÙƒØ±Ù†ÙŠ"ØŒ Ù†Ø­ÙØ¸ ÙÙŠ localStorage Ø£ÙŠØ¶Ø§Ù‹
        if (remember) {
            localStorage.setItem('hse_remember_user', JSON.stringify(AppState.currentUser));
            console.log('ğŸ’¾ ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¬Ù„Ø³Ø© ÙÙŠ localStorage (ØªØ°ÙƒØ±Ù†ÙŠ)');
        } else {
            // Ø¥Ø°Ø§ Ù„Ù… ÙŠØ®ØªØ± "ØªØ°ÙƒØ±Ù†ÙŠ"ØŒ Ù†Ø­ÙØ¸ ÙÙ‚Ø· ÙÙŠ sessionStorage
            localStorage.removeItem('hse_remember_user');
            console.log('ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù localStorage (Ù„Ù… ÙŠØ®ØªØ± ØªØ°ÙƒØ±Ù†ÙŠ)');
        }

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„ Ø£Ùˆ Ø¹Ø¯Ù… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
        const isFirstLogin = !fullUserData?.lastLogin || fullUserData?.lastLogin === null;
        const passwordNotChanged = !fullUserData?.passwordChanged || fullUserData?.passwordChanged === false;
        const requiresPasswordChange = isFirstLogin || passwordNotChanged;
        
        if (!requiresPasswordChange) {
            Notification.success(`Ù…Ø±Ø­Ø¨Ø§Ù‹ ${user.name}`);
        }
        
        // Ø¥Ø±Ø¬Ø§Ø¹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ù† Ø­Ø§Ù„Ø© ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
        return {
            success: true,
            requiresPasswordChange: requiresPasswordChange,
            isFirstLogin: isFirstLogin
        };
    },

    /**
     * ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
     */
    logout() {
        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù„Ù‰ ØºÙŠØ± Ù…ØªØµÙ„
        if (AppState.currentUser && AppState.currentUser.email) {
            const users = AppState.appData.users || [];
            const userIndex = users.findIndex(u => u.email && u.email.toLowerCase() === AppState.currentUser.email.toLowerCase());
            if (userIndex !== -1) {
                users[userIndex].isOnline = false;
                users[userIndex].lastLogout = new Date().toISOString();
                AppState.appData.users = users;
                DataManager.save();
                // Ù…Ø­Ø§ÙˆÙ„Ø© Ø­ÙØ¸ ÙÙŠ Google Sheets (Ø®Ù„ÙÙŠØ©)
                if (AppState.googleConfig.appsScript.enabled) {
                    GoogleIntegration.appendToSheets('Users', [users[userIndex]]).catch(err => {
                        console.warn('âš ï¸ ÙØ´Ù„ Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ ÙÙŠ Google Sheets:', err);
                    });
                }
            }
        }
        
        AppState.currentUser = null;
        localStorage.removeItem('hse_remember_user');
        sessionStorage.removeItem('hse_current_session');
        Notification.info('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­');
        UI.showLoginScreen();
    },

    /**
     * Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø­ÙÙˆØ¸
     */
    checkRememberedUser() {
        try {
            // Ø£ÙˆÙ„Ø§Ù‹: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† sessionStorage (Ù„Ù„Ù…ØªØµÙØ­ Ø§Ù„Ø­Ø§Ù„ÙŠ)
            let sessionData = sessionStorage.getItem('hse_current_session');
            if (sessionData) {
                try {
                    const user = JSON.parse(sessionData);
                    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØµØ­ÙŠØ­Ø© ÙˆØ£Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø§ Ø²Ø§Ù„ Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
                    if (user && user.email) {
                        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                        const email = user.email.toLowerCase();
                        // ØªÙ… Ø¥Ø²Ø§Ù„Ø© validUsers Ù„Ø£Ø³Ø¨Ø§Ø¨ Ø£Ù…Ù†ÙŠØ© - Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙ‚Ø·
                        const users = AppState.appData.users || [];
                        let foundUser = users.find(u => u.email && u.email.toLowerCase() === email);
                        
                        if (foundUser && foundUser.active === false) {
                            // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„
                            sessionStorage.removeItem('hse_current_session');
                            localStorage.removeItem('hse_remember_user');
                            return false;
                        }
                        
                        if (foundUser || user) {
                            AppState.currentUser = user;
                            return true;
                        }
                    }
                } catch (e) {
                    sessionStorage.removeItem('hse_current_session');
                }
            }

            // Ø«Ø§Ù†ÙŠØ§Ù‹: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† localStorage (Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ø®ØªØ§Ø± "ØªØ°ÙƒØ±Ù†ÙŠ")
            const remembered = localStorage.getItem('hse_remember_user');
            if (remembered) {
                try {
                    const user = JSON.parse(remembered);
                    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ£Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø§ Ø²Ø§Ù„ Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
                    if (user && user.email) {
                        const email = user.email.toLowerCase();
                        // ØªÙ… Ø¥Ø²Ø§Ù„Ø© validUsers Ù„Ø£Ø³Ø¨Ø§Ø¨ Ø£Ù…Ù†ÙŠØ© - Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙ‚Ø·
                        const users = AppState.appData.users || [];
                        let foundUser = users.find(u => u.email && u.email.toLowerCase() === email);
                        
                        if (foundUser && foundUser.active === false) {
                            localStorage.removeItem('hse_remember_user');
                            return false;
                        }
                        
                        if (foundUser || user) {
                            AppState.currentUser = user;
                            // Ø­ÙØ¸ ÙÙŠ sessionStorage Ø£ÙŠØ¶Ø§Ù‹
                            sessionStorage.setItem('hse_current_session', remembered);
                return true;
                        }
                    }
                } catch (e) {
                    localStorage.removeItem('hse_remember_user');
                }
            }
        } catch (error) {
            console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', error);
        }
        return false;
    },

    /**
     * Ø§Ø³ØªØ¹Ø§Ø¯Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
     */
    async resetPassword(email) {
        if (!email || !Utils.isValidEmail(email)) {
            Notification.error('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØµØ­ÙŠØ­');
        return false;
        }

        email = email.trim().toLowerCase();
        
        // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
        const user = AppState.appData.users.find(u => u.email === email);
        
        if (!user) {
            Notification.error('Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± Ù…Ø³Ø¬Ù„ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…');
            return false;
        }

        // Ø¥Ù†Ø´Ø§Ø¡ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ù…Ø¤Ù‚ØªØ©
        const tempPassword = 'Temp' + Math.random().toString(36).substring(2, 10) + '!';
        
        // ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
        user.password = tempPassword;
        user.updatedAt = new Date().toISOString();
        
        // Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
        DataManager.save();
        
        // Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙÙŠ Google Sheets
        await GoogleIntegration.autoSave('Users', AppState.appData.users);

        // ÙÙŠ Ø§Ù„Ø¥Ù†ØªØ§Ø¬ØŒ ÙŠØ¬Ø¨ Ø¥Ø±Ø³Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø¤Ù‚ØªØ© Ø¹Ø¨Ø± Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
        // Ù‡Ù†Ø§ Ø³Ù†Ø¹Ø±Ø¶Ù‡Ø§ ÙÙ‚Ø· Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
        Notification.success(`ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ù…Ø¤Ù‚ØªØ©: ${tempPassword}\n\nÙŠØ±Ø¬Ù‰ ØªØºÙŠÙŠØ±Ù‡Ø§ Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„`);
        return true;
    }
};

// ===== UI Management =====
const UI = {
    /**
     * Ø¹Ø±Ø¶ Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
     */
    showLoginScreen() {
        document.getElementById('login-screen').style.display = 'flex';
        document.getElementById('main-app').style.display = 'none';
        document.getElementById('username').focus();
        
        // ØªÙØ¹ÙŠÙ„ Ø²Ø± Ø¥Ø¸Ù‡Ø§Ø± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
        setTimeout(() => {
            const passwordToggleBtn = document.getElementById('password-toggle-btn');
            if (passwordToggleBtn) {
                // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¥Ù† ÙˆØ¬Ø¯
                const newBtn = passwordToggleBtn.cloneNode(true);
                passwordToggleBtn.parentNode.replaceChild(newBtn, passwordToggleBtn);
                
                newBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    UI.togglePasswordVisibility();
                });
            }
            
            // ØªÙØ¹ÙŠÙ„ Ø±Ø§Ø¨Ø· Ø§Ø³ØªØ¹Ø§Ø¯Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
            const forgotPasswordLink = document.getElementById('forgot-password-link');
            if (forgotPasswordLink) {
                // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¥Ù† ÙˆØ¬Ø¯
                const newLink = forgotPasswordLink.cloneNode(true);
                forgotPasswordLink.parentNode.replaceChild(newLink, forgotPasswordLink);
                
                newLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    UI.showForgotPasswordModal();
                });
            }
        }, 100);
    },

    /**
     * Ø¹Ø±Ø¶ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
     */
    async showMainApp() {
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('main-app').style.display = 'flex';
        this.updateUserProfile();
        this.setupNavigationListeners();
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø­Ø³Ø¨ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
        Permissions.updateNavigation();
        
        // Ø¹Ø±Ø¶ ØµÙˆØ±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ
        this.updateUserProfilePhoto();
        
        // Ø¥Ø¸Ù‡Ø§Ø± Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù‡ÙŠØ¯Ø± (Theme Toggle & Notifications)
        this.showHeaderActions();
        
        // Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹ Google Sheets Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ (Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Google Sheets)
        // Ù‡Ø°Ø§ Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø¬Ø¯Ø¯ Ø§Ù„Ø°ÙŠÙ† Ù„Ø§ ÙŠÙ…Ù„ÙƒÙˆÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ©
        if (AppState.googleConfig.appsScript.enabled && AppState.googleConfig.sheets.spreadsheetId) {
            try {
                Loading.show();
                console.log('ğŸ”„ Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Google Sheets Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯...');
                const synced = await GoogleIntegration.syncData();
                Loading.hide();
                if (synced) {
                    console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Google Sheets Ø¨Ù†Ø¬Ø§Ø­');
                    console.log('ğŸ“Š Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©:', Object.keys(AppState.appData).filter(key => Array.isArray(AppState.appData[key]) && AppState.appData[key].length > 0));
                    // Ø¥Ø¸Ù‡Ø§Ø± Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
                    Notification.success('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Google Sheets Ø¨Ù†Ø¬Ø§Ø­');
                } else {
                    console.warn('âš ï¸ Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Google SheetsØŒ Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©');
                }
            } catch (error) {
                Loading.hide();
                console.error('âŒ ÙØ´Ù„Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©:', error);
                console.warn('âš ï¸ Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© (Ø¥Ù† ÙˆØ¬Ø¯Øª)');
                Notification.warning('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Google SheetsØŒ Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©');
            }
        } else {
            console.log('â„¹ï¸ Google Sheets ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„ØŒ Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© ÙÙ‚Ø·');
            // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Google Sheets Ù…ÙØ¹Ù‘Ù„ØŒ Ù†ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ©
            const hasLocalData = Object.keys(AppState.appData).some(key => 
                Array.isArray(AppState.appData[key]) && AppState.appData[key].length > 0
            );
            if (!hasLocalData) {
                Notification.info('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ©. ÙŠØ±Ø¬Ù‰ ØªÙØ¹ÙŠÙ„ Google Sheets Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©.');
            }
        }
        
        // Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø¹Ø§Ø± Ø§Ù„Ø´Ø±ÙƒØ© ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø±
        this.updateCompanyLogoHeader();
        
        // ØªØ­Ø¯ÙŠØ« Ø´Ø¹Ø§Ø± Ø§Ù„Ø´Ø±ÙƒØ© ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
        this.updateDashboardLogo();
        
        // Ø¹Ø±Ø¶ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ÙˆØ¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        this.showSection('dashboard');
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø¹Ø¯ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©
        setTimeout(() => {
            if (typeof Dashboard !== 'undefined' && Dashboard.load && typeof Dashboard.load === 'function') {
                const loadResult = Dashboard.load();
                if (loadResult && typeof loadResult.catch === 'function') {
                    loadResult.catch(err => console.warn('âš ï¸ ÙØ´Ù„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…:', err));
                }
            }
        }, 500);
    },
    
    /**
     * ØªØ­Ø¯ÙŠØ« Ø´Ø¹Ø§Ø± Ø§Ù„Ø´Ø±ÙƒØ© ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø±
     */
    updateCompanyLogoHeader() {
        const header = document.getElementById('company-logo-header');
        const logoImg = document.getElementById('header-company-logo');
        const logoImgRight = document.getElementById('header-company-logo-right');
        
        if (header) {
            if (AppState.companyLogo) {
                header.style.display = 'flex';
                header.style.justifyContent = 'space-between';
                header.style.alignItems = 'center';
                header.style.padding = '10px 20px';
                
                // Ø§Ù„Ø´Ø¹Ø§Ø± ÙÙŠ Ø§Ù„Ø¬Ø§Ù†Ø¨ Ø§Ù„Ø£ÙŠØ³Ø± ÙÙ‚Ø· (ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø´Ø¹Ø§Ø± Ø§Ù„Ø£ÙŠÙ…Ù†)
                if (logoImg) {
                    logoImg.src = AppState.companyLogo;
                    logoImg.style.display = 'block';
                    logoImg.style.maxHeight = '50px';
                    logoImg.style.maxWidth = '150px';
                    logoImg.style.objectFit = 'contain';
                }
                
                // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø´Ø¹Ø§Ø± Ø§Ù„Ø£ÙŠÙ…Ù† (ØªÙ… Ø¥Ø²Ø§Ù„ØªÙ‡ Ø­Ø³Ø¨ Ø§Ù„Ø·Ù„Ø¨)
                if (logoImgRight) {
                    logoImgRight.style.display = 'none';
                }
            } else {
                header.style.display = 'none';
                if (logoImg) logoImg.style.display = 'none';
                if (logoImgRight) logoImgRight.style.display = 'none';
            }
            
            // Ø¥Ø¶Ø§ÙØ© padding-top Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø¹Ù†Ø¯ Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù‡ÙŠØ¯Ø±
            const allSections = document.querySelectorAll('.section');
            allSections.forEach(section => {
                if (header && header.style.display === 'flex') {
                    section.style.paddingTop = '70px';
                } else {
                    section.style.paddingTop = '0';
                }
            });
        }
    },

    /**
     * ØªØ­Ø¯ÙŠØ« Ø´Ø¹Ø§Ø± Ø§Ù„Ø´Ø±ÙƒØ© ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
     * ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø´Ø¹Ø§Ø± Ù…Ù† Dashboard Ø­Ø³Ø¨ Ø§Ù„Ø·Ù„Ø¨ - Ø§Ù„Ø´Ø¹Ø§Ø± ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø±
     */
    updateDashboardLogo() {
        // ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø´Ø¹Ø§Ø± Ù…Ù† Dashboard Ø­Ø³Ø¨ Ø§Ù„Ø·Ù„Ø¨ - Ø§Ù„Ø´Ø¹Ø§Ø± ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø±
        const dashboardLogoDiv = document.getElementById('dashboard-company-logo');
        if (dashboardLogoDiv) {
            dashboardLogoDiv.style.display = 'none';
        }
        
        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø´Ø¹Ø§Ø±Ø§Øª Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ¯ÙŠÙˆÙ„Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰ Ø£ÙŠØ¶Ø§Ù‹
        const allSections = document.querySelectorAll('.section');
        allSections.forEach(section => {
            const sectionLogoDiv = section.querySelector('.section-company-logo');
            if (sectionLogoDiv) {
                sectionLogoDiv.remove();
            }
        });
    },
    
    /**
     * Ø¥Ø¹Ø¯Ø§Ø¯ event listeners Ù„Ù„ØªÙ†Ù‚Ù„
     */
    setupNavigationListeners() {
        // Ø¥Ø²Ø§Ù„Ø© event listeners Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© (Ø¥Ù† ÙˆØ¬Ø¯Øª)
        const navItems = document.querySelectorAll('.nav-item');
        navItems.forEach(item => {
            // Ø§Ø³ØªÙ†Ø³Ø§Ø® Ø§Ù„Ø¹Ù†ØµØ± Ù„Ø¥Ø²Ø§Ù„Ø© Ø¬Ù…ÙŠØ¹ event listeners
            const newItem = item.cloneNode(true);
            item.parentNode.replaceChild(newItem, item);
        });

        // Ø¥Ø¶Ø§ÙØ© event listeners Ø¬Ø¯ÙŠØ¯Ø©
        const newNavItems = document.querySelectorAll('.nav-item');
        newNavItems.forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                const section = this.getAttribute('data-section');
                if (section) {
                    UI.showSection(section);
                }
            });
        });

        // Ø¥Ø¶Ø§ÙØ© event listener Ù„Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
        const logoutBtn = document.getElementById('logout-btn');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', function(e) {
                e.preventDefault();
                if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) {
                    Auth.logout();
                }
            });
        }
    },

    /**
     * Ø¹Ø±Ø¶ Ù†Ø§ÙØ°Ø© Ø§Ø³ØªØ¹Ø§Ø¯Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
     */
    showForgotPasswordModal() {
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 400px;">
                <div class="modal-header">
                    <h2 class="modal-title">Ø§Ø³ØªØ¹Ø§Ø¯Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</h2>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <p class="mb-4 text-gray-700">Ø£Ø¯Ø®Ù„ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆØ³Ù†Ù‚ÙˆÙ… Ø¨Ø¥Ù†Ø´Ø§Ø¡ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ù…Ø¤Ù‚ØªØ©:</p>
                    <form id="forgot-password-form">
                        <div class="mb-4">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
                            </label>
                            <input 
                                type="email" 
                                id="forgot-password-email" 
                                required
                                class="form-input"
                                placeholder="example@americana.com"
                                autocomplete="email"
                            >
                        </div>
                        <div class="flex gap-3 justify-end">
                            <button type="button" class="btn-secondary" onclick="this.closest('.modal-overlay').remove()">
                                Ø¥Ù„ØºØ§Ø¡
                            </button>
                            <button type="submit" class="btn-primary">
                                <i class="fas fa-key ml-2"></i>
                                Ø¥Ø±Ø³Ø§Ù„
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        const form = document.getElementById('forgot-password-form');
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('forgot-password-email').value.trim();
            
            Loading.show();
            try {
                const success = await Auth.resetPassword(email);
                if (success) {
                    setTimeout(() => {
                        modal.remove();
                        Loading.hide();
                    }, 1500);
                } else {
                    Loading.hide();
                }
            } catch (error) {
                Loading.hide();
                Notification.error('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ø³ØªØ¹Ø§Ø¯Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±');
            }
        });
        
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
        });
    },

    /**
     * ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
     */
    updateUserProfile() {
        if (AppState.currentUser) {
            const nameEl = document.getElementById('userDisplayName');
            const emailEl = document.getElementById('adminEmail');
            if (nameEl) nameEl.textContent = AppState.currentUser.name;
            if (emailEl) emailEl.textContent = AppState.currentUser.email;
        }
        // ØªØ­Ø¯ÙŠØ« ØµÙˆØ±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        this.updateUserProfilePhoto();
    },
    
    /**
     * ØªØ­Ø¯ÙŠØ« ØµÙˆØ±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ
     */
    updateUserProfilePhoto() {
        if (!AppState.currentUser) return;
        
        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ù…Ø¹ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±)
        let user = AppState.appData.users.find(u => {
            if (!u || !u.email || !AppState.currentUser.email) return false;
            return u.email.toLowerCase().trim() === AppState.currentUser.email.toLowerCase().trim();
        });
        
        // Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŒ Ù†Ø­Ø§ÙˆÙ„ Ø§Ù„Ø¨Ø­Ø« Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø¨Ø¹Ø¯ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        if (!user) {
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ù† localStorage
            const savedData = localStorage.getItem('hse_app_data');
            if (savedData) {
                try {
                    const parsedData = JSON.parse(savedData);
                    if (parsedData.users) {
                        AppState.appData.users = parsedData.users;
                        user = AppState.appData.users.find(u => {
                            if (!u || !u.email || !AppState.currentUser.email) return false;
                            return u.email.toLowerCase().trim() === AppState.currentUser.email.toLowerCase().trim();
                        });
                    }
                } catch (e) {
                    console.warn('âš ï¸ ÙØ´Ù„ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©:', e);
                }
            }
        }
        
        const profilePhoto = document.getElementById('user-profile-photo');
        const profileIcon = document.getElementById('user-profile-icon');
        
        if (user && user.photo && profilePhoto && profileIcon) {
            // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„ØµÙˆØ±Ø© ØµØ§Ù„Ø­Ø©
            const img = new Image();
            img.onload = () => {
                profilePhoto.src = user.photo;
                profilePhoto.style.display = 'block';
                profileIcon.style.display = 'none';
            };
            img.onerror = () => {
                // Ø¥Ø°Ø§ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©ØŒ Ù†Ø¹Ø±Ø¶ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø©
                profilePhoto.style.display = 'none';
                profileIcon.style.display = 'block';
            };
            img.src = user.photo;
        } else if (profilePhoto && profileIcon) {
            profilePhoto.style.display = 'none';
            profileIcon.style.display = 'block';
        }
    },
    
    /**
     * Ø¥Ø¸Ù‡Ø§Ø± Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù‡ÙŠØ¯Ø± (Theme Toggle & Notifications)
     */
    showHeaderActions() {
        const headerThemeToggle = document.getElementById('header-theme-toggle');
        const headerNotificationsBtn = document.getElementById('header-notifications-btn');
        const companyLogoHeader = document.getElementById('company-logo-header');
        
        if (companyLogoHeader && companyLogoHeader.style.display !== 'none') {
            if (headerThemeToggle) headerThemeToggle.style.display = 'flex';
            if (headerNotificationsBtn) headerNotificationsBtn.style.display = 'flex';
        }
    },

    /**
     * Ø¹Ø±Ø¶ Ù‚Ø³Ù… Ù…Ø¹ÙŠÙ†
     */
    showSection(sectionName) {
        console.log('Ù…Ø­Ø§ÙˆÙ„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø³Ù…:', sectionName); // Ù„Ù„Øª debug
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
        if (!Permissions.checkBeforeShow(sectionName)) {
            // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù„Ø¯ÙŠÙ‡ ØµÙ„Ø§Ø­ÙŠØ©ØŒ Ù†Ø¹Ø±Ø¶ Dashboard Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù†Ù‡
            if (sectionName !== 'dashboard' && Permissions.hasAccess('dashboard')) {
                sectionName = 'dashboard';
            } else {
                return;
            }
        }
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† main-app Ù…Ø¹Ø±ÙˆØ¶
        const mainApp = document.getElementById('main-app');
        if (!mainApp || mainApp.style.display === 'none') {
            console.error('main-app ØºÙŠØ± Ù…Ø±Ø¦ÙŠ');
            return;
        }

        // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø¨Ø´ÙƒÙ„ ØµØ±ÙŠØ­
        const sections = document.querySelectorAll('.section');
        console.log('Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©:', sections.length);
        sections.forEach(section => {
            section.classList.remove('active');
            section.style.display = 'none'; // Ø¥Ø®ÙØ§Ø¡ ØµØ±ÙŠØ­
        });

        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙØ¹ÙŠÙ„ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
        const navItems = document.querySelectorAll('.nav-item');
        console.log('Ø¹Ø¯Ø¯ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©:', navItems.length);
        navItems.forEach(item => {
            item.classList.remove('active');
            item.removeAttribute('aria-current');
        });

        // Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
        const sectionId = `${sectionName}-section`;
        let section = document.getElementById(sectionId);
        console.log('ğŸ” Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰:', sectionId, section ? 'âœ… Ù…ÙˆØ¬ÙˆØ¯' : 'âŒ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
        
        if (!section) {
            console.warn('âš ï¸ Ø§Ù„Ù‚Ø³Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ DOMØŒ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…...');
            // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ù„Ù„ØªØ£ÙƒØ¯
            const allSections = document.querySelectorAll('.section');
            console.log('ğŸ“‹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©:', Array.from(allSections).map(s => s.id).join(', '));
            
            // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù‚Ø³Ù… Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
            const mainContent = document.querySelector('.main-content');
            if (mainContent) {
                console.log('ğŸ”¨ Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø³Ù… Ø¬Ø¯ÙŠØ¯:', sectionId);
                section = document.createElement('section');
                section.id = sectionId;
                section.className = 'section';
                section.setAttribute('role', 'region');
                section.setAttribute('aria-label', `Ù‚Ø³Ù… ${sectionName}`);
                
                // Ø¥Ø¯Ø±Ø§Ø¬ Ø§Ù„Ù‚Ø³Ù… ÙÙŠ Ø§Ù„Ù…ÙƒØ§Ù† Ø§Ù„ØµØ­ÙŠØ­ (Ø¨Ø¹Ø¯ users-section)
                const usersSection = document.getElementById('users-section');
                if (usersSection && sectionName === 'employees') {
                    usersSection.insertAdjacentElement('afterend', section);
                    console.log('âœ… ØªÙ… Ø¥Ø¯Ø±Ø§Ø¬ Ù‚Ø³Ù… employees-section Ø¨Ø¹Ø¯ users-section');
                } else {
                    mainContent.appendChild(section);
                    console.log('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¥Ù„Ù‰ main-content');
                }
            } else {
                console.error('âŒ main-content ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!');
            }
        }
        
        if (section) {
            section.classList.add('active');
            section.style.display = 'block'; // Ø¹Ø±Ø¶ ØµØ±ÙŠØ­
            console.log('âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù‚Ø³Ù…:', sectionId);
        } else {
            console.error('âŒ ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø£Ùˆ Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù‚Ø³Ù…:', sectionId);
        }

        // ØªÙØ¹ÙŠÙ„ Ø¹Ù†ØµØ± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
        const navItem = document.querySelector(`[data-section="${sectionName}"]`);
        if (navItem) {
            navItem.classList.add('active');
            navItem.setAttribute('aria-current', 'page');
            console.log('ØªÙ… ØªÙØ¹ÙŠÙ„ Ø¹Ù†ØµØ± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©');
        } else {
            console.error('Ø¹Ù†ØµØ± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯:', sectionName);
        }

        AppState.currentSection = sectionName;
        
        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯ Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø³Ù… Ù…Ø¨Ø§Ø´Ø±Ø©
        setTimeout(() => {
        this.loadSectionData(sectionName);
        }, 50);
    },

    /**
     * ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø³Ù…
     */
    loadSectionData(sectionName) {
        console.log('ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø³Ù…:', sectionName);
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ø¹Ø§Ø± ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø± Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø£ÙŠ Ù‚Ø³Ù…
        this.updateCompanyLogoHeader();
        this.updateDashboardLogo();
        
        try {
            switch (sectionName) {
                case 'dashboard':
                    if (typeof Dashboard !== 'undefined' && Dashboard.load) {
                        Dashboard.load();
                    } else {
                        console.warn('ÙˆØ­Ø¯Ø© Dashboard ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
                    }
                    break;
                case 'users':
                    if (typeof Users !== 'undefined' && Users.load) {
                        Users.load();
                    } else {
                        console.warn('ÙˆØ­Ø¯Ø© Users ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
                    }
                    break;
                case 'employees':
                    console.log('ğŸ” ØªØ­Ù…ÙŠÙ„ Ù…Ø¯ÙŠÙˆÙ„ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† (Employees) ÙÙŠ Ù‚Ø³Ù… employees-section');
                    if (typeof Employees !== 'undefined' && Employees.load) {
                        Employees.load();
                    } else {
                        console.error('âŒ ÙˆØ­Ø¯Ø© Employees ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
                    }
                    break;
                case 'incidents':
                    console.log('ğŸ” ØªØ­Ù…ÙŠÙ„ Ù…Ø¯ÙŠÙˆÙ„ Ø§Ù„Ø­ÙˆØ§Ø¯Ø« (Incidents) ÙÙŠ Ù‚Ø³Ù… incidents-section');
                    if (typeof Incidents !== 'undefined' && Incidents.load) {
                        Incidents.load();
                    } else {
                        console.error('âŒ ÙˆØ­Ø¯Ø© Incidents ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
                    }
                    break;
                case 'nearmiss':
                    console.log('ğŸ” ØªØ­Ù…ÙŠÙ„ Ù…Ø¯ÙŠÙˆÙ„ Ø§Ù„Ø­ÙˆØ§Ø¯Ø« Ø§Ù„ÙˆØ´ÙŠÙƒØ© (NearMiss) ÙÙŠ Ù‚Ø³Ù… nearmiss-section');
                    if (typeof NearMiss !== 'undefined' && NearMiss.load) {
                        NearMiss.load();
                    } else {
                        console.error('âŒ ÙˆØ­Ø¯Ø© NearMiss ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
                    }
                    break;
                case 'ptw':
                    console.log('ğŸ” ØªØ­Ù…ÙŠÙ„ Ù…Ø¯ÙŠÙˆÙ„ ØªØµØ§Ø±ÙŠØ­ Ø§Ù„Ø¹Ù…Ù„ (PTW) ÙÙŠ Ù‚Ø³Ù… ptw-section');
                    if (typeof PTW !== 'undefined' && PTW.load) {
                        PTW.load();
                    } else {
                        console.error('âŒ ÙˆØ­Ø¯Ø© PTW ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
                    }
                    break;
                case 'training':
                    console.log('ğŸ” ØªØ­Ù…ÙŠÙ„ Ù…Ø¯ÙŠÙˆÙ„ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ (Training) ÙÙŠ Ù‚Ø³Ù… training-section');
                    if (typeof Training !== 'undefined' && Training.load) {
                        Training.load();
                    } else {
                        console.error('âŒ ÙˆØ­Ø¯Ø© Training ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
                    }
                    break;
                case 'clinic':
                    console.log('ğŸ” ØªØ­Ù…ÙŠÙ„ Ù…Ø¯ÙŠÙˆÙ„ Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© (Clinic) ÙÙŠ Ù‚Ø³Ù… clinic-section');
                    if (typeof Clinic !== 'undefined' && Clinic.load) {
                        Clinic.load();
                    } else {
                        console.error('âŒ ÙˆØ­Ø¯Ø© Clinic ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
                    }
                    break;
                case 'fire-equipment':
                    if (typeof FireEquipment !== 'undefined' && FireEquipment.load) {
                        FireEquipment.load();
                    } else {
                        console.warn('ÙˆØ­Ø¯Ø© FireEquipment ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
                    }
                    break;
                case 'ppe':
                    if (typeof PPE !== 'undefined' && PPE.load) {
                        PPE.load();
                    } else {
                        console.warn('ÙˆØ­Ø¯Ø© PPE ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
                    }
                    break;
                case 'violations':
                    if (typeof Violations !== 'undefined' && Violations.load) {
                        Violations.load();
                    } else {
                        console.warn('ÙˆØ­Ø¯Ø© Violations ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
                    }
                    break;
                case 'contractors':
                    if (typeof Contractors !== 'undefined' && Contractors.load) {
                        Contractors.load();
                    } else {
                        console.warn('ÙˆØ­Ø¯Ø© Contractors ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
                    }
                    break;
                case 'behavior-monitoring':
                    if (typeof BehaviorMonitoring !== 'undefined' && BehaviorMonitoring.load) {
                        BehaviorMonitoring.load();
                    } else {
                        console.warn('ÙˆØ­Ø¯Ø© BehaviorMonitoring ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
                    }
                    break;
                case 'chemical-safety':
                    if (typeof ChemicalSafety !== 'undefined' && ChemicalSafety.load) {
                        ChemicalSafety.load();
                    } else {
                        console.warn('ÙˆØ­Ø¯Ø© ChemicalSafety ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
                    }
                    break;
                case 'daily-observations':
                    if (typeof DailyObservations !== 'undefined' && DailyObservations.load) {
                        DailyObservations.load();
                    } else {
                        console.warn('ÙˆØ­Ø¯Ø© DailyObservations ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
                    }
                    break;
                case 'iso':
                    if (typeof ISO !== 'undefined' && ISO.load) {
                        ISO.load();
                    } else {
                        console.warn('ÙˆØ­Ø¯Ø© ISO ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
                    }
                    break;
                case 'emergency':
                    if (typeof Emergency !== 'undefined' && Emergency.load) {
                        Emergency.load();
                    } else {
                        console.warn('ÙˆØ­Ø¯Ø© Emergency ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
                    }
                    break;
                case 'risk-assessment':
                    if (typeof RiskAssessment !== 'undefined' && RiskAssessment.load) {
                        RiskAssessment.load();
                    } else {
                        console.warn('ÙˆØ­Ø¯Ø© RiskAssessment ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
                    }
                    break;
                case 'sop-jha':
                    if (typeof SOPJHA !== 'undefined' && SOPJHA.load) {
                        SOPJHA.load();
                    } else {
                        console.warn('ÙˆØ­Ø¯Ø© SOPJHA ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
                    }
                    break;
                case 'legal-documents':
                    if (typeof LegalDocuments !== 'undefined' && LegalDocuments.load) {
                        LegalDocuments.load();
                    } else {
                        console.warn('ÙˆØ­Ø¯Ø© LegalDocuments ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
                    }
                    break;
                case 'sustainability':
                    if (typeof Sustainability !== 'undefined' && Sustainability.load) {
                        Sustainability.load();
                    } else {
                        console.warn('ÙˆØ­Ø¯Ø© Sustainability ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
                    }
                    break;
                case 'ai-assistant':
                    if (typeof AIAssistant !== 'undefined' && AIAssistant.load) {
                        AIAssistant.load();
                    } else {
                        console.warn('ÙˆØ­Ø¯Ø© AIAssistant ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
                    }
                    break;
                case 'settings':
                    if (typeof Settings !== 'undefined' && Settings.load) {
                        Settings.load();
                    } else {
                        console.warn('ÙˆØ­Ø¯Ø© Settings ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
                    }
                    break;
                case 'action-tracking':
                    if (typeof ActionTrackingRegister !== 'undefined' && ActionTrackingRegister.load) {
                        ActionTrackingRegister.load();
                    } else {
                        console.warn('ÙˆØ­Ø¯Ø© ActionTrackingRegister ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
                    }
                    break;
                case 'half-yearly-statistics':
                    if (typeof HalfYearlyStatistics !== 'undefined' && HalfYearlyStatistics.load) {
                        HalfYearlyStatistics.load();
                    } else {
                        console.warn('ÙˆØ­Ø¯Ø© HalfYearlyStatistics ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
                    }
                    break;
                default:
                    console.warn('Ù‚Ø³Ù… ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ:', sectionName);
            }
        } catch (error) {
            console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø³Ù…:', error);
            Notification.error('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø³Ù…: ' + error.message);
        }
    },

    /**
     * ØªØ¨Ø¯ÙŠÙ„ Ø¥Ø¸Ù‡Ø§Ø± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
     */
    togglePasswordVisibility() {
        const passwordInput = document.getElementById('password');
        const toggleIcon = document.getElementById('password-toggle-icon');
        const toggleBtn = document.getElementById('password-toggle-btn');
        
        if (!passwordInput || !toggleIcon) {
            console.warn('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¹Ù†Ø§ØµØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±');
            return;
        }
        
        if (passwordInput.type === 'password') {
            passwordInput.type = 'text';
            toggleIcon.classList.remove('fa-eye');
            toggleIcon.classList.add('fa-eye-slash');
            if (toggleBtn) {
                toggleBtn.setAttribute('aria-label', 'Ø¥Ø®ÙØ§Ø¡ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±');
                toggleBtn.setAttribute('title', 'Ø¥Ø®ÙØ§Ø¡ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±');
            }
        } else {
            passwordInput.type = 'password';
            toggleIcon.classList.remove('fa-eye-slash');
            toggleIcon.classList.add('fa-eye');
            if (toggleBtn) {
                toggleBtn.setAttribute('aria-label', 'Ø¥Ø¸Ù‡Ø§Ø± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±');
                toggleBtn.setAttribute('title', 'Ø¥Ø¸Ù‡Ø§Ø± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±');
            }
        }
        
        // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
        passwordInput.focus();
    }
};

// ===== Dashboard Module =====
const Dashboard = {
    /**
     * ØªØ­Ù…ÙŠÙ„ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
     */
    load() {
        this.updateKPIs();
        this.loadRecentActivities();
        this.updateStats();
        this.loadReportsWidget();
        this.loadEmployeeReportWidget();
    },
    
    /**
     * ØªØ­Ù…ÙŠÙ„ Ù‚Ø³Ù… Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙÙŠ Dashboard
     */
    loadReportsWidget() {
        const container = document.getElementById('dashboard-reports-widget');
        if (!container) return;
        
        const data = AppState.appData;
        const stats = {
            incidents: (data.incidents || []).length,
            training: (data.training || []).length,
            ptw: (data.ptw || []).length,
            violations: (data.violations || []).length
        };
        
        container.innerHTML = `
            <div class="content-card">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-chart-bar ml-2"></i>
                        Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
                    </h2>
                </div>
                <div class="card-body">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                        <div class="text-center p-4 bg-red-50 rounded-lg">
                            <div class="text-3xl font-bold text-red-600 mb-2">${stats.incidents}</div>
                            <div class="text-sm text-gray-600">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­ÙˆØ§Ø¯Ø«</div>
                        </div>
                        <div class="text-center p-4 bg-blue-50 rounded-lg">
                            <div class="text-3xl font-bold text-blue-600 mb-2">${stats.training}</div>
                            <div class="text-sm text-gray-600">Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„ØªØ¯Ø±ÙŠØ¨</div>
                        </div>
                        <div class="text-center p-4 bg-green-50 rounded-lg">
                            <div class="text-3xl font-bold text-green-600 mb-2">${stats.ptw}</div>
                            <div class="text-sm text-gray-600">ØªØµØ§Ø±ÙŠØ­ Ø§Ù„Ø¹Ù…Ù„</div>
                        </div>
                        <div class="text-center p-4 bg-yellow-50 rounded-lg">
                            <div class="text-3xl font-bold text-yellow-600 mb-2">${stats.violations}</div>
                            <div class="text-sm text-gray-600">Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª</div>
                        </div>
                    </div>
                    <div class="border-t pt-4">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                            <button onclick="Reports.generateAndExport('incidents')" class="btn-secondary">
                                <i class="fas fa-file-pdf ml-2"></i>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø­ÙˆØ§Ø¯Ø«
                            </button>
                            <button onclick="Reports.generateAndExport('training')" class="btn-secondary">
                                <i class="fas fa-file-pdf ml-2"></i>ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªØ¯Ø±ÙŠØ¨
                            </button>
                            <button onclick="Reports.generateAndExport('full')" class="btn-primary">
                                <i class="fas fa-file-pdf ml-2"></i>ØªÙ‚Ø±ÙŠØ± Ø´Ø§Ù…Ù„
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    },
    
    /**
     * ØªØ­Ù…ÙŠÙ„ Ù‚Ø³Ù… ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…ÙˆØ¸Ù
     */
    loadEmployeeReportWidget() {
        const container = document.getElementById('employee-report-widget');
        if (!container) return;
        
        container.innerHTML = `
            <div class="content-card">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-user-search ml-2"></i>
                        Ø§Ù„Ø¨Ø­Ø« Ø¨ÙƒÙˆØ¯ Ø§Ù„Ù…ÙˆØ¸Ù - ØªÙ‚Ø±ÙŠØ± Ø´Ø§Ù…Ù„
                    </h2>
                </div>
                <div class="card-body">
                    <div class="mb-6">
                        <div class="flex items-center gap-4 mb-4">
                            <div class="flex-1">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <i class="fas fa-id-card ml-2"></i>
                                    Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ
                                </label>
                                <div class="relative">
                                    <input type="text" id="employee-code-search" class="form-input" 
                                        placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ Ù„Ù„Ù…ÙˆØ¸Ù">
                                    <button id="search-employee-btn" class="absolute left-3 top-1/2 transform -translate-y-1/2 btn-primary">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="mt-6">
                                <button id="export-employee-report-btn" class="btn-success" disabled>
                                    <i class="fas fa-file-pdf ml-2"></i>ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ± PDF
                                </button>
                            </div>
                        </div>
                    </div>
                    <div id="employee-report-content" class="hidden">
                        <div id="employee-report-data"></div>
                    </div>
                </div>
            </div>
        `;
        
        const searchBtn = document.getElementById('search-employee-btn');
        const exportBtn = document.getElementById('export-employee-report-btn');
        const searchInput = document.getElementById('employee-code-search');
        
        if (searchBtn) {
            searchBtn.addEventListener('click', () => {
                const code = searchInput?.value.trim();
                if (code) {
                    this.generateEmployeeReport(code);
                } else {
                    Notification.warning('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ');
                }
            });
        }
        
        if (searchInput) {
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    const code = searchInput.value.trim();
                    if (code) {
                        this.generateEmployeeReport(code);
                    }
                }
            });
        }
        
        if (exportBtn) {
            exportBtn.addEventListener('click', () => {
                const code = searchInput?.value.trim();
                if (code) {
                    this.exportEmployeeReportPDF(code);
                }
            });
        }
    },
    
    /**
     * ØªÙˆÙ„ÙŠØ¯ ØªÙ‚Ø±ÙŠØ± Ø´Ø§Ù…Ù„ Ù„Ù„Ù…ÙˆØ¸Ù
     */
    generateEmployeeReport(employeeCode) {
        const data = AppState.appData;
        // Ø§Ù„Ø¨Ø­Ø« Ø¨ÙƒÙˆØ¯ Ø§Ù„Ù…ÙˆØ¸Ù Ù…Ø¹ ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø¨Ø­Ø«
        let employee = null;
        const employees = data.employees || [];
        
        // Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¯Ù‚ÙŠÙ‚ Ø£ÙˆÙ„Ø§Ù‹
        employee = employees.find(emp => 
            emp.employeeNumber === employeeCode || 
            emp.sapId === employeeCode ||
            emp.id === employeeCode
        );
        
        // Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ±ØŒ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¬Ø²Ø¦ÙŠ (ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰)
        if (!employee) {
            employee = employees.find(emp => {
                const code = String(emp.employeeNumber || emp.sapId || emp.id || '').trim();
                const searchCode = String(employeeCode).trim();
                return code.includes(searchCode) || searchCode.includes(code);
            });
        }
        
        // Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ±ØŒ Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… (Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙƒÙˆØ¯ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ø³Ù…)
        if (!employee && employeeCode.length > 3) {
            employee = employees.find(emp => {
                const name = String(emp.name || '').toLowerCase().trim();
                const searchTerm = String(employeeCode).toLowerCase().trim();
                return name.includes(searchTerm) || searchTerm.includes(name);
            });
        }
        
        if (!employee) {
            Notification.error('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¸Ù Ø¨Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯');
            const contentContainer = document.getElementById('employee-report-content');
            if (contentContainer) contentContainer.classList.add('hidden');
            return;
        }
        
        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…ØªØ¹Ù„Ù‚Ø© Ø¨Ø§Ù„Ù…ÙˆØ¸Ù
        const violations = (data.violations || []).filter(v => 
            v.employeeCode === employeeCode || 
            v.employeeNumber === employeeCode ||
            (v.employeeName && employee.name && v.employeeName.includes(employee.name.split(' ')[0]))
        );
        
        const sickLeave = (data.sickLeave || []).filter(s => 
            s.employeeCode === employeeCode || 
            s.employeeNumber === employeeCode ||
            (s.employeeName && employee.name && s.employeeName.includes(employee.name.split(' ')[0]))
        );
        
        const training = (data.training || []).filter(t => {
            if (t.participants && Array.isArray(t.participants)) {
                return t.participants.some(p => 
                    p.employeeCode === employeeCode || 
                    p.code === employeeCode ||
                    (p.name && employee.name && p.name.includes(employee.name.split(' ')[0]))
                );
            }
            return false;
        });
        
        const ppe = (data.ppe || []).filter(p => 
            p.employeeCode === employeeCode || 
            p.employeeNumber === employeeCode ||
            (p.employeeName && employee.name && p.employeeName.includes(employee.name.split(' ')[0]))
        );
        
        const behaviorMonitoring = (data.behaviorMonitoring || []).filter(b => 
            b.employeeId === employeeCode || 
            b.employeeCode === employeeCode ||
            (b.employeeName && employee.name && b.employeeName.includes(employee.name.split(' ')[0]))
        );
        
        const clinicVisits = (data.clinicVisits || []).filter(c => 
            c.employeeCode === employeeCode || 
            c.employeeNumber === employeeCode ||
            (c.employeeName && employee.name && c.employeeName.includes(employee.name.split(' ')[0]))
        );
        
        const incidents = (data.incidents || []).filter(i => 
            i.employeeCode === employeeCode || 
            i.employeeNumber === employeeCode ||
            (i.employeeName && employee.name && i.employeeName.includes(employee.name.split(' ')[0]))
        );
        
        const reportContainer = document.getElementById('employee-report-data');
        const contentContainer = document.getElementById('employee-report-content');
        const exportBtn = document.getElementById('export-employee-report-btn');
        
        reportContainer.innerHTML = `
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">
                            <i class="fas fa-user ml-2"></i>
                            ${Utils.escapeHTML(employee.name || '')}
                        </h3>
                        <p class="text-gray-600">
                            <i class="fas fa-id-card ml-2"></i>
                            Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ: <strong>${Utils.escapeHTML(employee.employeeNumber || employee.sapId || employeeCode)}</strong>
                        </p>
                        ${employee.department ? `<p class="text-gray-600 mt-1"><i class="fas fa-building ml-2"></i>Ø§Ù„Ù‚Ø³Ù…: ${Utils.escapeHTML(employee.department)}</p>` : ''}
                        ${employee.position ? `<p class="text-gray-600 mt-1"><i class="fas fa-briefcase ml-2"></i>Ø§Ù„Ù…Ù†ØµØ¨: ${Utils.escapeHTML(employee.position)}</p>` : ''}
                    </div>
                    ${employee.photo ? `<img src="${employee.photo}" alt="ØµÙˆØ±Ø© Ø§Ù„Ù…ÙˆØ¸Ù" class="w-24 h-24 rounded-full object-cover border-2 border-blue-500">` : ''}
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <div class="bg-red-50 border border-red-200 rounded-lg p-4 text-center">
                    <div class="text-3xl font-bold text-red-600 mb-2">${violations.length}</div>
                    <div class="text-sm text-gray-700 font-semibold">Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª</div>
                </div>
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-center">
                    <div class="text-3xl font-bold text-blue-600 mb-2">${sickLeave.length}</div>
                    <div class="text-sm text-gray-700 font-semibold">Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª Ø§Ù„Ù…Ø±Ø¶ÙŠØ©</div>
                </div>
                <div class="bg-green-50 border border-green-200 rounded-lg p-4 text-center">
                    <div class="text-3xl font-bold text-green-600 mb-2">${training.length}</div>
                    <div class="text-sm text-gray-700 font-semibold">Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„ØªØ¯Ø±ÙŠØ¨</div>
                </div>
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 text-center">
                    <div class="text-3xl font-bold text-yellow-600 mb-2">${ppe.length}</div>
                    <div class="text-sm text-gray-700 font-semibold">Ù…Ù‡Ù…Ø§Øª Ø§Ù„ÙˆÙ‚Ø§ÙŠØ©</div>
                </div>
                <div class="bg-purple-50 border border-purple-200 rounded-lg p-4 text-center">
                    <div class="text-3xl font-bold text-purple-600 mb-2">${behaviorMonitoring.length}</div>
                    <div class="text-sm text-gray-700 font-semibold">Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø³Ù„ÙˆÙƒÙŠØ§Øª</div>
                </div>
                <div class="bg-pink-50 border border-pink-200 rounded-lg p-4 text-center">
                    <div class="text-3xl font-bold text-pink-600 mb-2">${clinicVisits.length}</div>
                    <div class="text-sm text-gray-700 font-semibold">Ø§Ù„ØªØ±Ø¯Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©</div>
                </div>
                <div class="bg-orange-50 border border-orange-200 rounded-lg p-4 text-center">
                    <div class="text-3xl font-bold text-orange-600 mb-2">${incidents.length}</div>
                    <div class="text-sm text-gray-700 font-semibold">Ø§Ù„Ø­ÙˆØ§Ø¯Ø«</div>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                ${violations.length > 0 ? `
                    <div class="content-card">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-exclamation-circle ml-2"></i>Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª (${violations.length})</h3>
                        </div>
                        <div class="card-body">
                            <div class="space-y-3">
                                ${violations.slice(0, 5).map(v => `
                                    <div class="border rounded p-3">
                                        <div class="flex items-center justify-between mb-2">
                                            <span class="font-semibold">${Utils.escapeHTML(v.violationType || '')}</span>
                                            <span class="badge badge-${v.severity === 'Ø¹Ø§Ù„ÙŠØ©' ? 'danger' : 'warning'}">${v.severity || ''}</span>
                                        </div>
                                        <p class="text-sm text-gray-600">${Utils.escapeHTML((v.actionTaken || '').substring(0, 100))}</p>
                                        <p class="text-xs text-gray-500 mt-2">${v.violationDate ? Utils.formatDate(v.violationDate) : ''}</p>
                                    </div>
                                `).join('')}
                                ${violations.length > 5 ? `<p class="text-sm text-gray-500 text-center mt-2">Ùˆ ${violations.length - 5} Ù…Ø®Ø§Ù„ÙØ§Øª Ø£Ø®Ø±Ù‰...</p>` : ''}
                            </div>
                        </div>
                    </div>
                ` : ''}
                
                ${sickLeave.length > 0 ? `
                    <div class="content-card">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-calendar-times ml-2"></i>Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª Ø§Ù„Ù…Ø±Ø¶ÙŠØ© (${sickLeave.length})</h3>
                        </div>
                        <div class="card-body">
                            <div class="space-y-3">
                                ${sickLeave.slice(0, 5).map(s => `
                                    <div class="border rounded p-3">
                                        <div class="flex items-center justify-between mb-2">
                                            <span class="font-semibold">Ù…Ù† ${s.startDate ? Utils.formatDate(s.startDate) : ''} Ø¥Ù„Ù‰ ${s.endDate ? Utils.formatDate(s.endDate) : ''}</span>
                                        </div>
                                        <p class="text-sm text-gray-600">${Utils.escapeHTML(s.reason || '')}</p>
                                        ${s.medicalNotes ? `<p class="text-xs text-gray-500 mt-2">${Utils.escapeHTML(s.medicalNotes)}</p>` : ''}
                                    </div>
                                `).join('')}
                                ${sickLeave.length > 5 ? `<p class="text-sm text-gray-500 text-center mt-2">Ùˆ ${sickLeave.length - 5} Ø¥Ø¬Ø§Ø²Ø© Ø£Ø®Ø±Ù‰...</p>` : ''}
                            </div>
                        </div>
                    </div>
                ` : ''}
                
                ${training.length > 0 ? `
                    <div class="content-card">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-graduation-cap ml-2"></i>Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ (${training.length})</h3>
                        </div>
                        <div class="card-body">
                            <div class="space-y-3">
                                ${training.slice(0, 5).map(t => `
                                    <div class="border rounded p-3">
                                        <div class="flex items-center justify-between mb-2">
                                            <span class="font-semibold">${Utils.escapeHTML(t.name || '')}</span>
                                            <span class="badge badge-${t.status === 'Ù…ÙƒØªÙ…Ù„' ? 'success' : 'warning'}">${t.status || ''}</span>
                                        </div>
                                        <p class="text-sm text-gray-600">Ø§Ù„Ù…Ø¯Ø±Ø¨: ${Utils.escapeHTML(t.trainer || '')}</p>
                                        <p class="text-xs text-gray-500 mt-2">${t.startDate ? Utils.formatDate(t.startDate) : ''}</p>
                                    </div>
                                `).join('')}
                                ${training.length > 5 ? `<p class="text-sm text-gray-500 text-center mt-2">Ùˆ ${training.length - 5} Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø¢Ø®Ø±...</p>` : ''}
                            </div>
                        </div>
                    </div>
                ` : ''}
                
                ${ppe.length > 0 ? `
                    <div class="content-card">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-hard-hat ml-2"></i>Ù…Ù‡Ù…Ø§Øª Ø§Ù„ÙˆÙ‚Ø§ÙŠØ© (${ppe.length})</h3>
                        </div>
                        <div class="card-body">
                            <div class="space-y-3">
                                ${ppe.slice(0, 5).map(p => `
                                    <div class="border rounded p-3">
                                        <div class="flex items-center justify-between mb-2">
                                            <span class="font-semibold">${Utils.escapeHTML(p.equipmentType || '')}</span>
                                            <span class="badge badge-success">${p.receiptNumber || p.id}</span>
                                        </div>
                                        <p class="text-sm text-gray-600">Ø§Ù„ÙƒÙ…ÙŠØ©: ${p.quantity || 0}</p>
                                        <p class="text-xs text-gray-500 mt-2">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…: ${p.receiptDate ? Utils.formatDate(p.receiptDate) : ''}</p>
                                    </div>
                                `).join('')}
                                ${ppe.length > 5 ? `<p class="text-sm text-gray-500 text-center mt-2">Ùˆ ${ppe.length - 5} Ø§Ø³ØªÙ„Ø§Ù… Ø¢Ø®Ø±...</p>` : ''}
                            </div>
                        </div>
                    </div>
                ` : ''}
                
                ${behaviorMonitoring.length > 0 ? `
                    <div class="content-card">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-user-check ml-2"></i>Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø³Ù„ÙˆÙƒÙŠØ§Øª (${behaviorMonitoring.length})</h3>
                        </div>
                        <div class="card-body">
                            <div class="space-y-3">
                                ${behaviorMonitoring.slice(0, 5).map(b => `
                                    <div class="border rounded p-3">
                                        <div class="flex items-center justify-between mb-2">
                                            <span class="font-semibold">${Utils.escapeHTML(b.behaviorType || '')}</span>
                                            <span class="badge badge-${b.rating >= 4 ? 'success' : b.rating >= 3 ? 'warning' : 'danger'}">${b.rating || 0}/5</span>
                                        </div>
                                        <p class="text-sm text-gray-600">${Utils.escapeHTML((b.description || '').substring(0, 100))}</p>
                                        <p class="text-xs text-gray-500 mt-2">${b.date ? Utils.formatDate(b.date) : ''}</p>
                                    </div>
                                `).join('')}
                                ${behaviorMonitoring.length > 5 ? `<p class="text-sm text-gray-500 text-center mt-2">Ùˆ ${behaviorMonitoring.length - 5} ØªØ³Ø¬ÙŠÙ„ Ø¢Ø®Ø±...</p>` : ''}
                            </div>
                        </div>
                    </div>
                ` : ''}
                
                ${clinicVisits.length > 0 ? `
                    <div class="content-card">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-hospital ml-2"></i>Ø§Ù„ØªØ±Ø¯Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© (${clinicVisits.length})</h3>
                        </div>
                        <div class="card-body">
                            <div class="space-y-3">
                                ${clinicVisits.slice(0, 5).map(c => `
                                    <div class="border rounded p-3">
                                        <div class="flex items-center justify-between mb-2">
                                            <span class="font-semibold">${Utils.escapeHTML(c.reason || 'Ø²ÙŠØ§Ø±Ø© Ø¹Ø§Ø¯ÙŠØ©')}</span>
                                        </div>
                                        ${c.diagnosis ? `<p class="text-sm text-gray-600">Ø§Ù„ØªØ´Ø®ÙŠØµ: ${Utils.escapeHTML(c.diagnosis)}</p>` : ''}
                                        ${c.treatment ? `<p class="text-sm text-gray-600">Ø§Ù„Ø¹Ù„Ø§Ø¬: ${Utils.escapeHTML(c.treatment)}</p>` : ''}
                                        <p class="text-xs text-gray-500 mt-2">${c.visitDate ? Utils.formatDate(c.visitDate) : ''}</p>
                                    </div>
                                `).join('')}
                                ${clinicVisits.length > 5 ? `<p class="text-sm text-gray-500 text-center mt-2">Ùˆ ${clinicVisits.length - 5} Ø²ÙŠØ§Ø±Ø© Ø£Ø®Ø±Ù‰...</p>` : ''}
                            </div>
                        </div>
                    </div>
                ` : ''}
            </div>
        `;
        
        contentContainer.classList.remove('hidden');
        if (exportBtn) exportBtn.disabled = false;
        
        // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ù„Ù„ØªØµØ¯ÙŠØ±
        window.currentEmployeeReport = {
            employee,
            employeeCode,
            violations,
            sickLeave,
            training,
            ppe,
            behaviorMonitoring,
            clinicVisits,
            incidents
        };
    },
    
    /**
     * ØªØµØ¯ÙŠØ± ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…ÙˆØ¸Ù ÙƒÙ€ PDF
     */
    async exportEmployeeReportPDF(employeeCode) {
        if (!window.currentEmployeeReport || window.currentEmployeeReport.employeeCode !== employeeCode) {
            this.generateEmployeeReport(employeeCode);
            await new Promise(resolve => setTimeout(resolve, 500));
        }
        
        const report = window.currentEmployeeReport;
        if (!report) {
            Notification.error('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ØªÙ‚Ø±ÙŠØ±');
            return;
        }
        
        try {
            Loading.show();
            
            const formCode = `EMP-REPORT-${employeeCode}-${new Date().toISOString().slice(0, 10)}`;
            const formTitle = `ØªÙ‚Ø±ÙŠØ± Ø´Ø§Ù…Ù„ Ù„Ù„Ù…ÙˆØ¸Ù: ${report.employee.name || ''}`;
            
            let content = `
                <table style="margin-bottom: 30px;">
                    <tr><th>Ø§Ù„Ø§Ø³Ù…</th><td>${Utils.escapeHTML(report.employee.name || '')}</td></tr>
                    <tr><th>Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</th><td>${Utils.escapeHTML(report.employee.employeeNumber || report.employee.sapId || employeeCode)}</td></tr>
                    ${report.employee.department ? `<tr><th>Ø§Ù„Ù‚Ø³Ù…</th><td>${Utils.escapeHTML(report.employee.department)}</td></tr>` : ''}
                    ${report.employee.position ? `<tr><th>Ø§Ù„Ù…Ù†ØµØ¨</th><td>${Utils.escapeHTML(report.employee.position)}</td></tr>` : ''}
                </table>
                
                <div class="section-title">Ù…Ù„Ø®Øµ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</div>
                <table>
                    <tr><th>Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª</th><td>${report.violations.length}</td></tr>
                    <tr><th>Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª Ø§Ù„Ù…Ø±Ø¶ÙŠØ©</th><td>${report.sickLeave.length}</td></tr>
                    <tr><th>Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„ØªØ¯Ø±ÙŠØ¨</th><td>${report.training.length}</td></tr>
                    <tr><th>Ù…Ù‡Ù…Ø§Øª Ø§Ù„ÙˆÙ‚Ø§ÙŠØ©</th><td>${report.ppe.length}</td></tr>
                    <tr><th>Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø³Ù„ÙˆÙƒÙŠØ§Øª</th><td>${report.behaviorMonitoring.length}</td></tr>
                    <tr><th>Ø§Ù„ØªØ±Ø¯Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©</th><td>${report.clinicVisits.length}</td></tr>
                    <tr><th>Ø§Ù„Ø­ÙˆØ§Ø¯Ø«</th><td>${report.incidents.length}</td></tr>
                </table>
            `;
            
            if (report.violations.length > 0) {
                content += `
                    <div class="section-title">Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª (${report.violations.length})</div>
                    <table>
                        <tr>
                            <th>Ø§Ù„Ù†ÙˆØ¹</th>
                            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                            <th>Ø§Ù„Ø´Ø¯Ø©</th>
                            <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù…ØªØ®Ø°</th>
                            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                        </tr>
                        ${report.violations.map(v => `
                            <tr>
                                <td>${Utils.escapeHTML(v.violationType || '')}</td>
                                <td>${v.violationDate ? Utils.formatDate(v.violationDate) : ''}</td>
                                <td>${Utils.escapeHTML(v.severity || '')}</td>
                                <td>${Utils.escapeHTML(v.actionTaken || '')}</td>
                                <td>${Utils.escapeHTML(v.status || '')}</td>
                            </tr>
                        `).join('')}
                    </table>
                `;
            }
            
            if (report.sickLeave.length > 0) {
                content += `
                    <div class="section-title">Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª Ø§Ù„Ù…Ø±Ø¶ÙŠØ© (${report.sickLeave.length})</div>
                    <table>
                        <tr>
                            <th>Ù…Ù† ØªØ§Ø±ÙŠØ®</th>
                            <th>Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</th>
                            <th>Ø§Ù„Ø³Ø¨Ø¨</th>
                            <th>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ©</th>
                        </tr>
                        ${report.sickLeave.map(s => `
                            <tr>
                                <td>${s.startDate ? Utils.formatDate(s.startDate) : ''}</td>
                                <td>${s.endDate ? Utils.formatDate(s.endDate) : ''}</td>
                                <td>${Utils.escapeHTML(s.reason || '')}</td>
                                <td>${Utils.escapeHTML(s.medicalNotes || '')}</td>
                            </tr>
                        `).join('')}
                    </table>
                `;
            }
            
            if (report.training.length > 0) {
                content += `
                    <div class="section-title">Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ (${report.training.length})</div>
                    <table>
                        <tr>
                            <th>Ø§Ø³Ù… Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬</th>
                            <th>Ø§Ù„Ù…Ø¯Ø±Ø¨</th>
                            <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡</th>
                            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                        </tr>
                        ${report.training.map(t => `
                            <tr>
                                <td>${Utils.escapeHTML(t.name || '')}</td>
                                <td>${Utils.escapeHTML(t.trainer || '')}</td>
                                <td>${t.startDate ? Utils.formatDate(t.startDate) : ''}</td>
                                <td>${Utils.escapeHTML(t.status || '')}</td>
                            </tr>
                        `).join('')}
                    </table>
                `;
            }
            
            if (report.ppe.length > 0) {
                content += `
                    <div class="section-title">Ù…Ù‡Ù…Ø§Øª Ø§Ù„ÙˆÙ‚Ø§ÙŠØ© (${report.ppe.length})</div>
                    <table>
                        <tr>
                            <th>Ø±Ù‚Ù… Ø§Ù„Ø¥ÙŠØµØ§Ù„</th>
                            <th>Ù†ÙˆØ¹ Ø§Ù„Ù…Ø¹Ø¯Ø©</th>
                            <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                            <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</th>
                            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                        </tr>
                        ${report.ppe.map(p => `
                            <tr>
                                <td>${Utils.escapeHTML(p.receiptNumber || p.id || '')}</td>
                                <td>${Utils.escapeHTML(p.equipmentType || '')}</td>
                                <td>${p.quantity || 0}</td>
                                <td>${p.receiptDate ? Utils.formatDate(p.receiptDate) : ''}</td>
                                <td>${Utils.escapeHTML(p.status || '')}</td>
                            </tr>
                        `).join('')}
                    </table>
                `;
            }
            
            if (report.behaviorMonitoring.length > 0) {
                content += `
                    <div class="section-title">Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø³Ù„ÙˆÙƒÙŠØ§Øª (${report.behaviorMonitoring.length})</div>
                    <table>
                        <tr>
                            <th>Ù†ÙˆØ¹ Ø§Ù„Ø³Ù„ÙˆÙƒ</th>
                            <th>Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</th>
                            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                            <th>Ø§Ù„ÙˆØµÙ</th>
                        </tr>
                        ${report.behaviorMonitoring.map(b => `
                            <tr>
                                <td>${Utils.escapeHTML(b.behaviorType || '')}</td>
                                <td>${b.rating || 0}/5</td>
                                <td>${b.date ? Utils.formatDate(b.date) : ''}</td>
                                <td>${Utils.escapeHTML(b.description || '')}</td>
                            </tr>
                        `).join('')}
                    </table>
                `;
            }
            
            if (report.clinicVisits.length > 0) {
                content += `
                    <div class="section-title">Ø§Ù„ØªØ±Ø¯Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© (${report.clinicVisits.length})</div>
                    <table>
                        <tr>
                            <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø²ÙŠØ§Ø±Ø©</th>
                            <th>Ø§Ù„Ø³Ø¨Ø¨</th>
                            <th>Ø§Ù„ØªØ´Ø®ÙŠØµ</th>
                            <th>Ø§Ù„Ø¹Ù„Ø§Ø¬</th>
                        </tr>
                        ${report.clinicVisits.map(c => `
                            <tr>
                                <td>${c.visitDate ? Utils.formatDate(c.visitDate) : ''}</td>
                                <td>${Utils.escapeHTML(c.reason || '')}</td>
                                <td>${Utils.escapeHTML(c.diagnosis || '')}</td>
                                <td>${Utils.escapeHTML(c.treatment || '')}</td>
                            </tr>
                        `).join('')}
                    </table>
                `;
            }
            
            const htmlContent = typeof FormHeader !== 'undefined' && FormHeader.generatePDFHTML
                ? FormHeader.generatePDFHTML(formCode, formTitle, content, false, true)
                : `<html><body>${content}</body></html>`;
            
            const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const printWindow = window.open(url, '_blank');
            
            if (printWindow) {
                printWindow.onload = () => {
                    setTimeout(() => {
                        printWindow.print();
                        setTimeout(() => {
                            URL.revokeObjectURL(url);
                            Loading.hide();
                            Notification.success('ØªÙ… ÙØªØ­ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©/Ø§Ù„Ø­ÙØ¸ ÙƒÙ€ PDF');
                        }, 1000);
                    }, 500);
                };
            } else {
                Loading.hide();
                Notification.error('ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ù„Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±');
            }
        } catch (error) {
            Loading.hide();
            console.error('Ø®Ø·Ø£ ÙÙŠ ØªØµØ¯ÙŠØ± PDF:', error);
            Notification.error('ÙØ´Ù„ ØªØµØ¯ÙŠØ± PDF: ' + error.message);
        }
    },

    /**
     * ØªØ­Ø¯ÙŠØ« Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡
     */
    updateKPIs() {
        const data = AppState.appData;
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¨Ù„ Ø§Ø³ØªØ®Ø¯Ø§Ù… filter
        const incidents = data.incidents || [];
        const users = data.users || [];
        const ptw = data.ptw || [];
        const nearmiss = data.nearmiss || [];
        const training = data.training || [];
        const violations = data.violations || [];
        const clinicVisits = data.clinicVisits || [];
        const fireEquipment = data.fireEquipment || [];
        const employees = data.employees || [];
        
        // ØªØ­Ø¯ÙŠØ« KPIs Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
        const totalIncidentsEl = document.getElementById('total-incidents');
        if (totalIncidentsEl) totalIncidentsEl.textContent = incidents.length;
        
        const activeUsersEl = document.getElementById('active-users');
        if (activeUsersEl) activeUsersEl.textContent = users.filter(u => u && u.active !== false).length;
        
        const activePTWEl = document.getElementById('active-ptw');
        if (activePTWEl) activePTWEl.textContent = ptw.filter(p => p && p.status !== 'Ù…ØºÙ„Ù‚').length;
        
        // Ø­Ø³Ø§Ø¨ Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø§Ù…ØªØ«Ø§Ù„ Ø¨Ø´ÙƒÙ„ Ø£ÙØ¶Ù„
        const totalItems = incidents.length + nearmiss.length;
        const resolvedItems = (incidents.filter(i => i && (i.status === 'Ù…ØºÙ„Ù‚' || i.status === 'Ù…Ø­Ù„ÙˆÙ„')).length) + 
                             (nearmiss.filter(n => n && (n.status === 'Ù…ØºÙ„Ù‚' || n.status === 'Ù…Ø­Ù„ÙˆÙ„')).length);
        const complianceRate = totalItems > 0 ? Math.round((resolvedItems / totalItems) * 100) : 100;
        const complianceRateEl = document.getElementById('compliance-rate');
        if (complianceRateEl) {
            complianceRateEl.textContent = `${complianceRate}%`;
            // Ø¥Ø¶Ø§ÙØ© Ù„ÙˆÙ† Ø­Ø³Ø¨ Ø§Ù„Ù†Ø³Ø¨Ø©
            complianceRateEl.className = complianceRate >= 90 ? 'kpi-value text-green-600' : 
                                         complianceRate >= 70 ? 'kpi-value text-yellow-600' : 'kpi-value text-red-600';
        }
        
        // ØªØ­Ø¯ÙŠØ« KPIs Ø¥Ø¶Ø§ÙÙŠØ© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
        const weekIncidentsEl = document.getElementById('week-incidents');
        const openPTWEl = document.getElementById('open-ptw');
        const completedTrainingEl = document.getElementById('completed-training');
        
        if (weekIncidentsEl) {
            const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
            const weekIncidents = incidents.filter(i => i && new Date(i.createdAt) > weekAgo).length;
            weekIncidentsEl.textContent = weekIncidents;
        }
        
        if (openPTWEl) {
            const openPTW = ptw.filter(p => p && (p.status === 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©' || p.status === 'Ù…ÙØªÙˆØ­' || p.status === 'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±')).length;
            openPTWEl.textContent = openPTW;
        }
        
        if (completedTrainingEl) {
            completedTrainingEl.textContent = training.filter(t => t && (t.status === 'Ù…ÙƒØªÙ…Ù„' || t.status === 'Ù…Ù†ØªÙ‡ÙŠ')).length;
        }
        
        // Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„
        const totalWorkHoursEl = document.getElementById('total-work-hours');
        if (totalWorkHoursEl) {
            const totalEmployees = employees.filter(e => e && e.active !== false).length || 200;
            const hoursPerDay = 8;
            const workDaysPerMonth = 22;
            const monthsPerYear = 12;
            const totalWorkHours = totalEmployees * hoursPerDay * workDaysPerMonth * monthsPerYear;
            
            // Ø§Ù„Ø­ØµÙˆÙ„ Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØªØ§Ø­Ø§Ù‹
            const savedTotalHours = localStorage.getItem('hse_total_work_hours');
            const actualTotalHours = savedTotalHours ? parseFloat(savedTotalHours) : totalWorkHours;
            
            totalWorkHoursEl.textContent = actualTotalHours.toLocaleString('ar-SA');
        }
        
        // Ø­Ø³Ø§Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ÙŠØ§Ù… Ù…Ù†Ø° Ø¢Ø®Ø± Ø­Ø§Ø¯Ø« (Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­ÙˆØ§Ø¯Ø« ÙˆÙ„ÙŠØ³ ÙÙ‚Ø· Ø§Ù„Ø¥ØµØ§Ø¨Ø§Øª)
        const daysWithoutInjuryEl = document.getElementById('days-without-injury');
        if (daysWithoutInjuryEl) {
            // Ø¬Ù…Ø¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­ÙˆØ§Ø¯Ø« (incidents) ÙˆÙ„ÙŠØ³ ÙÙ‚Ø· Ø§Ù„Ø¥ØµØ§Ø¨Ø§Øª
            const allIncidents = incidents.filter(i => i && (i.incidentDate || i.date || i.createdAt));
            
            if (allIncidents.length > 0) {
                // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø­ÙˆØ§Ø¯Ø« Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® (Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹)
                const sortedIncidents = allIncidents.sort((a, b) => {
                    const dateA = new Date(a.incidentDate || a.date || a.createdAt);
                    const dateB = new Date(b.incidentDate || b.date || b.createdAt);
                    return dateB - dateA;
                });
                
                // Ø¢Ø®Ø± Ø­Ø§Ø¯Ø«
                const lastIncidentDate = new Date(sortedIncidents[0].incidentDate || sortedIncidents[0].date || sortedIncidents[0].createdAt);
                const today = new Date();
                const daysDiff = Math.floor((today - lastIncidentDate) / (1000 * 60 * 60 * 24));
                daysWithoutInjuryEl.textContent = daysDiff >= 0 ? daysDiff : 0;
            } else {
                daysWithoutInjuryEl.textContent = 'N/A';
            }
        }
        
        // Ø­Ø³Ø§Ø¨ Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø³Ù„Ø§Ù…Ø© (Safety Metrics)
        this.calculateSafetyMetrics(incidents, employees);
    },
    
    /**
     * Ø­Ø³Ø§Ø¨ Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø³Ù„Ø§Ù…Ø© Ø§Ù„Ù…Ù‡Ù†ÙŠØ©
     * LTI, TIR, FA, TRIR
     */
    calculateSafetyMetrics(incidents, employees) {
        // Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„ (ÙŠÙ…ÙƒÙ† ØªØ­Ø¯ÙŠØ«Ù‡ Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª)
        // Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹: 200 Ù…ÙˆØ¸Ù Ã— 8 Ø³Ø§Ø¹Ø§Øª Ã— 22 ÙŠÙˆÙ… Ø¹Ù…Ù„ Ã— 12 Ø´Ù‡Ø± = 4,224,000 Ø³Ø§Ø¹Ø© Ø³Ù†ÙˆÙŠØ§Ù‹
        // Ø£Ùˆ ÙŠÙ…ÙƒÙ† Ø­Ø³Ø§Ø¨Ù‡Ø§ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„ÙØ¹Ù„ÙŠ
        const totalEmployees = employees.filter(e => e && e.active !== false).length || 200;
        const hoursPerDay = 8;
        const workDaysPerMonth = 22;
        const monthsPerYear = 12;
        const totalWorkHours = totalEmployees * hoursPerDay * workDaysPerMonth * monthsPerYear;
        
        // Ø§Ù„Ø­ØµÙˆÙ„ Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØªØ§Ø­Ø§Ù‹
        const savedTotalHours = localStorage.getItem('hse_total_work_hours');
        const actualTotalHours = savedTotalHours ? parseFloat(savedTotalHours) : totalWorkHours;
        
        // Ø­Ø³Ø§Ø¨ LTI (Lost Time Injury) - Ø§Ù„Ø­ÙˆØ§Ø¯Ø« Ø§Ù„ØªÙŠ ØªØ³Ø¨Ø¨Øª ÙÙŠ ÙÙ‚Ø¯Ø§Ù† ÙˆÙ‚Øª Ø§Ù„Ø¹Ù…Ù„
        // Ù†Ø¹ØªØ¨Ø± Ø£Ù† Ø§Ù„Ø­ÙˆØ§Ø¯Ø« Ø§Ù„ØªÙŠ Ù„Ù‡Ø§ severity = 'Ø¹Ø§Ù„ÙŠØ©' Ø£Ùˆ 'Ø­Ø±Ø¬Ø©' Ù‡ÙŠ LTI
        const ltiIncidents = incidents.filter(i => i && (
            i.severity === 'Ø¹Ø§Ù„ÙŠØ©' || 
            i.severity === 'Ø­Ø±Ø¬Ø©' || 
            i.severity === 'high' ||
            i.severity === 'critical' ||
            i.lostTime === true ||
            i.lostTimeDays > 0
        )).length;
        
        // Ø­Ø³Ø§Ø¨ TIR (Total Injury Rate) - Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø¥ØµØ§Ø¨Ø§Øª Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
        // TIR = (Ø¹Ø¯Ø¯ Ø§Ù„Ø­ÙˆØ§Ø¯Ø« / Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†) Ã— 100
        const tir = totalEmployees > 0 ? ((incidents.length / totalEmployees) * 100).toFixed(2) : '0.00';
        
        // Ø­Ø³Ø§Ø¨ FA (Frequency Rate) - Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªÙƒØ±Ø§Ø±
        // FA = (Ø¹Ø¯Ø¯ Ø§Ù„Ø­ÙˆØ§Ø¯Ø« Ã— 1,000,000) / Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„
        const fa = actualTotalHours > 0 ? ((incidents.length * 1000000) / actualTotalHours).toFixed(2) : '0.00';
        
        // Ø­Ø³Ø§Ø¨ TRIR (Total Recordable Injury Rate) - Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø¥ØµØ§Ø¨Ø§Øª Ø§Ù„Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ³Ø¬ÙŠÙ„
        // TRIR = (Ø¹Ø¯Ø¯ Ø§Ù„Ø¥ØµØ§Ø¨Ø§Øª Ø§Ù„Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ³Ø¬ÙŠÙ„ Ã— 200,000) / Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„
        // Ù†Ø¹ØªØ¨Ø± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­ÙˆØ§Ø¯Ø« Ø§Ù„Ù…Ø³Ø¬Ù„Ø© Ù‡ÙŠ Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ³Ø¬ÙŠÙ„
        const recordableInjuries = incidents.length;
        const trir = actualTotalHours > 0 ? ((recordableInjuries * 200000) / actualTotalHours).toFixed(2) : '0.00';
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ÙŠÙ… ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        const ltiEl = document.getElementById('lti-value');
        if (ltiEl) ltiEl.textContent = ltiIncidents;
        
        const tirEl = document.getElementById('tir-value');
        if (tirEl) tirEl.textContent = tir;
        
        const faEl = document.getElementById('fa-value');
        if (faEl) faEl.textContent = fa;
        
        const trirEl = document.getElementById('trir-value');
        if (trirEl) trirEl.textContent = trir;
        
        console.log('ğŸ“Š Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø³Ù„Ø§Ù…Ø©:', {
            LTI: ltiIncidents,
            TIR: tir,
            FA: fa,
            TRIR: trir,
            totalWorkHours: actualTotalHours,
            totalEmployees: totalEmployees,
            totalIncidents: incidents.length
        });
    },

    /**
     * ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ø§Ù„Ø£Ø®ÙŠØ±Ø©
     */
    loadRecentActivities() {
        const container = document.getElementById('recent-activities');
            if (!container) return;
            
        const activities = [];
        
        // Ø¬Ù…Ø¹ Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØµØ§Ø¯Ø±
        const incidents = AppState.appData.incidents || [];
        incidents.slice(-5).forEach(incident => {
            if (!incident) return;
            activities.push({
                type: 'incident',
                title: `ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø­Ø§Ø¯Ø«: ${incident.type}`,
                time: this.getTimeAgo(incident.createdAt),
                icon: 'fa-exclamation-triangle',
                color: 'text-red-500'
            });
        });

        activities.sort((a, b) => new Date(b.time) - new Date(a.time));

        if (activities.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-inbox text-4xl text-gray-300 mb-4"></i>
                    <p class="text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù†Ø´Ø·Ø© Ø­Ø¯ÙŠØ«Ø©</p>
                </div>
            `;
            return;
        }

        container.innerHTML = activities.slice(0, 5).map(activity => `
            <div class="activity-item">
                <div class="activity-icon ${activity.color} bg-gray-100">
                    <i class="fas ${activity.icon}"></i>
                        </div>
                <div class="activity-content">
                    <div class="activity-title">${activity.title}</div>
                    <div class="activity-time">${activity.time}</div>
                        </div>
                    </div>
                `).join('');
    },

    /**
     * ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
     */
    updateStats() {
        const data = AppState.appData;
        const now = new Date();
        const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);

        const incidents = data.incidents || [];
        const ptw = data.ptw || [];
        const training = data.training || [];

        const weekIncidents = incidents.filter(i => i && new Date(i.createdAt) > weekAgo).length;
        const openPTW = ptw.filter(p => p && (p.status === 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©' || p.status === 'Ù…ÙØªÙˆØ­')).length;
        
        document.getElementById('week-incidents').textContent = weekIncidents;
        document.getElementById('open-ptw').textContent = openPTW;
        document.getElementById('completed-training').textContent = training.filter(t => t && t.status === 'Ù…ÙƒØªÙ…Ù„').length;
    },

    /**
     * Ø­Ø³Ø§Ø¨ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ù†Ù‚Ø¶ÙŠ
     */
    getTimeAgo(date) {
        const now = new Date();
        const past = new Date(date);
        const diff = now - past;
        const minutes = Math.floor(diff / 60000);
        const hours = Math.floor(minutes / 60);
        const days = Math.floor(hours / 24);

        if (minutes < 1) return 'Ø§Ù„Ø¢Ù†';
        if (minutes < 60) return `Ù…Ù†Ø° ${minutes} Ø¯Ù‚ÙŠÙ‚Ø©`;
        if (hours < 24) return `Ù…Ù†Ø° ${hours} Ø³Ø§Ø¹Ø©`;
        return `Ù…Ù†Ø° ${days} ÙŠÙˆÙ…`;
    },

    /**
     * ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ©
     */
    loadCharts() {
        const container = document.getElementById('dashboard-charts');
        if (!container) {
            // Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø³Ù… Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
            const dashboardSection = document.getElementById('dashboard-section');
            if (dashboardSection) {
                const chartsDiv = document.createElement('div');
                chartsDiv.id = 'dashboard-charts';
                chartsDiv.className = 'mt-6';
                dashboardSection.appendChild(chartsDiv);
            } else {
                return;
            }
        }

        const data = AppState.appData;
        const now = new Date();
        const last30Days = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);

        // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©
        const incidentsData = (data.incidents || []).filter(i => new Date(i.createdAt || i.date) >= last30Days);
        const ptwData = (data.ptw || []).filter(p => new Date(p.createdAt || p.startDate) >= last30Days);
        const trainingData = (data.training || []).filter(t => new Date(t.createdAt || t.startDate) >= last30Days);

        // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®
        const incidentsByDate = {};
        const ptwByDate = {};
        const trainingByDate = {};

        incidentsData.forEach(i => {
            const date = new Date(i.createdAt || i.date).toLocaleDateString('ar-SA');
            incidentsByDate[date] = (incidentsByDate[date] || 0) + 1;
        });

        ptwData.forEach(p => {
            const date = new Date(p.createdAt || p.startDate).toLocaleDateString('ar-SA');
            ptwByDate[date] = (ptwByDate[date] || 0) + 1;
        });

        trainingData.forEach(t => {
            const date = new Date(t.createdAt || t.startDate).toLocaleDateString('ar-SA');
            trainingByDate[date] = (trainingByDate[date] || 0) + 1;
        });

        const chartsHTML = `
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <div class="content-card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <i class="fas fa-chart-line ml-2"></i>
                            Ø§Ù„Ø­ÙˆØ§Ø¯Ø« - Ø¢Ø®Ø± 30 ÙŠÙˆÙ…
                        </h2>
                    </div>
                    <div class="card-body">
                        <div class="chart-container" style="height: 250px; position: relative;">
                            <canvas id="incidents-chart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="content-card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <i class="fas fa-chart-pie ml-2"></i>
                            ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø­ÙˆØ§Ø¯Ø« Ø­Ø³Ø¨ Ø§Ù„Ø®Ø·ÙˆØ±Ø©
                        </h2>
                    </div>
                    <div class="card-body">
                        <div class="chart-container" style="height: 250px; position: relative;">
                            ${this.renderSeverityChart(data.incidents || [])}
                        </div>
                    </div>
                </div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="content-card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <i class="fas fa-chart-bar ml-2"></i>
                            ØªØµØ§Ø±ÙŠØ­ Ø§Ù„Ø¹Ù…Ù„ - Ø¢Ø®Ø± 30 ÙŠÙˆÙ…
                        </h2>
                    </div>
                    <div class="card-body">
                        <div class="chart-container" style="height: 250px; position: relative;">
                            ${this.renderBarChart(ptwByDate, 'ØªØµØ§Ø±ÙŠØ­ Ø§Ù„Ø¹Ù…Ù„')}
                        </div>
                    </div>
                </div>
                <div class="content-card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <i class="fas fa-chart-area ml-2"></i>
                            Ø§Ù„ØªØ¯Ø±ÙŠØ¨ - Ø¢Ø®Ø± 30 ÙŠÙˆÙ…
                        </h2>
                    </div>
                    <div class="card-body">
                        <div class="chart-container" style="height: 250px; position: relative;">
                            ${this.renderBarChart(trainingByDate, 'Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„ØªØ¯Ø±ÙŠØ¨')}
                        </div>
                    </div>
                </div>
            </div>
        `;

        container.innerHTML = chartsHTML;

        // Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø³Ù… Ø¨ÙŠØ§Ù†ÙŠ ØªÙØ§Ø¹Ù„ÙŠ Ø¨Ø³ÙŠØ· Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… CSS
        setTimeout(() => {
            this.renderSimpleCharts();
        }, 100);
    },

    renderSeverityChart(incidents) {
        const severityCount = {
            'Ø¹Ø§Ù„ÙŠ': 0,
            'Ù…ØªÙˆØ³Ø·': 0,
            'Ù…Ù†Ø®ÙØ¶': 0
        };

        incidents.forEach(i => {
            const severity = i.severity || '';
            if (severity.includes('Ø¹Ø§Ù„ÙŠ') || severity.includes('Ø¹Ø§Ù„ÙŠØ©') || severity.includes('Ø¹Ø§Ù„ÙŠØ© Ø¬Ø¯Ø§Ù‹')) {
                severityCount['Ø¹Ø§Ù„ÙŠ']++;
            } else if (severity.includes('Ù…ØªÙˆØ³Ø·') || severity.includes('Ù…ØªÙˆØ³Ø·Ø©')) {
                severityCount['Ù…ØªÙˆØ³Ø·']++;
            } else {
                severityCount['Ù…Ù†Ø®ÙØ¶']++;
            }
        });

        const total = severityCount['Ø¹Ø§Ù„ÙŠ'] + severityCount['Ù…ØªÙˆØ³Ø·'] + severityCount['Ù…Ù†Ø®ÙØ¶'];
        if (total === 0) {
            return '<div class="empty-state"><p class="text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</p></div>';
        }

        const highPercent = (severityCount['Ø¹Ø§Ù„ÙŠ'] / total) * 100;
        const mediumPercent = (severityCount['Ù…ØªÙˆØ³Ø·'] / total) * 100;
        const lowPercent = (severityCount['Ù…Ù†Ø®ÙØ¶'] / total) * 100;

        return `
            <div class="flex flex-col gap-4">
                <div class="space-y-2">
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-semibold">Ø¹Ø§Ù„ÙŠ</span>
                        <span class="text-sm font-bold text-red-600">${severityCount['Ø¹Ø§Ù„ÙŠ']}</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-4">
                        <div class="bg-red-600 h-4 rounded-full transition-all duration-500" style="width: ${highPercent}%"></div>
                    </div>
                </div>
                <div class="space-y-2">
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-semibold">Ù…ØªÙˆØ³Ø·</span>
                        <span class="text-sm font-bold text-yellow-600">${severityCount['Ù…ØªÙˆØ³Ø·']}</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-4">
                        <div class="bg-yellow-600 h-4 rounded-full transition-all duration-500" style="width: ${mediumPercent}%"></div>
                    </div>
                </div>
                <div class="space-y-2">
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-semibold">Ù…Ù†Ø®ÙØ¶</span>
                        <span class="text-sm font-bold text-green-600">${severityCount['Ù…Ù†Ø®ÙØ¶']}</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-4">
                        <div class="bg-green-600 h-4 rounded-full transition-all duration-500" style="width: ${lowPercent}%"></div>
                    </div>
                </div>
            </div>
        `;
    },

    renderBarChart(dataByDate, title) {
        const dates = Object.keys(dataByDate).sort();
        if (dates.length === 0) {
            return '<div class="empty-state"><p class="text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</p></div>';
        }

        const maxValue = Math.max(...Object.values(dataByDate), 1);

        return `
            <div class="space-y-2" style="height: 100%; display: flex; flex-direction: column; justify-content: flex-end;">
                ${dates.slice(-7).map(date => {
                    const value = dataByDate[date] || 0;
                    const percent = (value / maxValue) * 100;
                    return `
                        <div class="flex items-end gap-2" style="height: 100%;">
                            <div class="flex-1 bg-gray-200 rounded-t" style="position: relative; height: 100%;">
                                <div class="bg-blue-500 rounded-t transition-all duration-500 hover:bg-blue-600" style="width: 100%; height: ${percent}%; position: absolute; bottom: 0;" title="${date}: ${value}"></div>
                            </div>
                            <span class="text-xs text-gray-600" style="writing-mode: vertical-rl; text-orientation: mixed;">${date.substring(0, 5)}</span>
                        </div>
                    `;
                }).join('')}
            </div>
        `;
    },

    renderSimpleCharts() {
        // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ù…ÙƒØªØ¨Ø© Chart.js Ù‡Ù†Ø§ Ù„Ø±Ø³ÙˆÙ… Ø¨ÙŠØ§Ù†ÙŠØ© Ø£ÙƒØ«Ø± ØªÙØµÙŠÙ„Ø§Ù‹
        console.log('Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© Ø¬Ø§Ù‡Ø²Ø©');
    }
};

// ===== Users Module =====
const Users = {
    currentView: 'list', // list, form, edit
    currentEditId: null,

    async load() {
        const section = document.getElementById('users-section');
        if (!section) return;

        section.innerHTML = `
            <div class="section-header">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="section-title">
                            <i class="fas fa-users ml-3" aria-hidden="true"></i>
                            Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
                        </h1>
                        <p class="section-subtitle">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙˆØµÙ„Ø§Ø­ÙŠØ§ØªÙ‡Ù…</p>
                    </div>
                    <button id="add-user-btn" class="btn-primary">
                        <i class="fas fa-plus ml-2" aria-hidden="true"></i>
                        Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯
                    </button>
                </div>
            </div>

            <div id="users-content" class="mt-6">
                ${await this.renderList()}
            </div>
        `;

        this.setupEventListeners();
        this.loadUsersList();
    },

    async renderList() {
        return `
            <div class="content-card">
                <div class="card-header">
                    <div class="flex items-center justify-between">
                        <h2 class="card-title">
                            <i class="fas fa-list ml-2" aria-hidden="true"></i>
                            Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
                        </h2>
                        <div class="flex items-center gap-4">
                            <input 
                                type="text" 
                                id="users-search" 
                                class="form-input" 
                                style="max-width: 300px;"
                                placeholder="Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ø³ØªØ®Ø¯Ù…..."
                            >
                            <select id="users-filter-role" class="form-input" style="max-width: 200px;">
                                <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¯ÙˆØ§Ø±</option>
                                <option value="admin">Ù…Ø¯ÙŠØ±</option>
                                <option value="safety_officer">Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ø³Ù„Ø§Ù…Ø©</option>
                                <option value="user">Ù…Ø³ØªØ®Ø¯Ù…</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div id="users-table-container">
                        <div class="empty-state">
                            <i class="fas fa-spinner fa-spin text-4xl text-gray-300 mb-4"></i>
                            <p class="text-gray-500">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
                        </div>
                    </div>
                </div>
            </div>
        `;
    },

    async renderForm(userData = null) {
        const isEdit = !!userData;
        return `
            <div class="content-card">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-${isEdit ? 'edit' : 'user-plus'} ml-2" aria-hidden="true"></i>
                        ${isEdit ? 'ØªØ¹Ø¯ÙŠÙ„ Ù…Ø³ØªØ®Ø¯Ù…' : 'Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯'}
                    </h2>
                </div>
                <div class="card-body">
                    <form id="user-form" class="space-y-6">
                        <div class="grid grid-cols-2 gap-6">
                            <div class="col-span-2">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <i class="fas fa-image ml-2"></i>
                                    ØµÙˆØ±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                                </label>
                                <div class="flex items-center gap-4">
                                    <div class="w-24 h-24 rounded-full border-2 border-gray-300 overflow-hidden bg-gray-100 flex items-center justify-center">
                                        <img id="user-photo-preview" src="${userData?.photo || ''}" alt="ØµÙˆØ±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" style="width: 100%; height: 100%; object-fit: cover; display: ${userData?.photo ? 'block' : 'none'};">
                                        <i id="user-photo-icon" class="fas fa-user text-3xl text-gray-400" style="display: ${userData?.photo ? 'none' : 'block'}"></i>
                                    </div>
                                    <div class="flex-1">
                                        <input 
                                            type="file" 
                                            id="user-photo-input" 
                                            accept="image/*"
                                            class="form-input"
                                            style="padding: 0.5rem;"
                                        >
                                        <p class="text-xs text-gray-500 mt-1">ÙŠÙÙØ¶Ù„ ØµÙˆØ±Ø© Ù…Ø±Ø¨Ø¹Ø© Ø¨Ø­Ø¬Ù… Ù„Ø§ ÙŠØªØ¬Ø§ÙˆØ² 2MB</p>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <i class="fas fa-user ml-2"></i>
                                    Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ *
                                </label>
                                <input 
                                    type="text" 
                                    id="user-name" 
                                    name="name" 
                                    required
                                    class="form-input"
                                    value="${userData?.name || ''}"
                                    placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„"
                                >
                            </div>

                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <i class="fas fa-envelope ml-2"></i>
                                    Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ *
                                </label>
                                <input 
                                    type="email" 
                                    id="user-email" 
                                    name="email" 
                                    required
                                    class="form-input"
                                    value="${userData?.email || ''}"
                                    placeholder="example@americana.com"
                                    ${isEdit ? 'readonly' : ''}
                                >
                            </div>

                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <i class="fas fa-key ml-2"></i>
                                    ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ${isEdit ? '(Ø§ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºØ§Ù‹ Ù„Ù„Ø¥Ø¨Ù‚Ø§Ø¡ Ø¹Ù„Ù‰ Ø§Ù„Ù‚Ø¯ÙŠÙ…)' : '*'}
                                </label>
                                <input 
                                    type="password" 
                                    id="user-password" 
                                    name="password" 
                                    autocomplete="current-password"
                                    ${isEdit ? '' : 'required'}
                                    class="form-input"
                                    placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                                >
                            </div>

                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <i class="fas fa-user-tag ml-2"></i>
                                    Ø§Ù„Ø¯ÙˆØ± *
                                </label>
                                <select id="user-role" name="role" required class="form-input">
                                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¯ÙˆØ±</option>
                                    <option value="admin" ${userData?.role === 'admin' ? 'selected' : ''}>Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…</option>
                                    <option value="safety_officer" ${userData?.role === 'safety_officer' ? 'selected' : ''}>Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ø³Ù„Ø§Ù…Ø©</option>
                                    <option value="user" ${userData?.role === 'user' ? 'selected' : ''}>Ù…Ø³ØªØ®Ø¯Ù…</option>
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <i class="fas fa-building ml-2"></i>
                                    Ø§Ù„Ù‚Ø³Ù… *
                                </label>
                                <input 
                                    type="text" 
                                    id="user-department" 
                                    name="department" 
                                    required
                                    class="form-input"
                                    value="${userData?.department || ''}"
                                    placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù‚Ø³Ù…"
                                >
                            </div>

                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <i class="fas fa-toggle-on ml-2"></i>
                                    Ø§Ù„Ø­Ø§Ù„Ø©
                                </label>
                                <label class="flex items-center mt-2">
                                    <input 
                                        type="checkbox" 
                                        id="user-active" 
                                        name="active"
                                        class="rounded border-gray-300 text-blue-600"
                                        ${userData?.active !== false ? 'checked' : ''}
                                    >
                                    <span class="mr-2 text-sm text-gray-700">Ù†Ø´Ø·</span>
                                </label>
                            </div>
                        </div>

                        <div class="border-t pt-4 mt-4">
                            <label class="block text-sm font-semibold text-gray-700 mb-3">
                                <i class="fas fa-shield-alt ml-2"></i>
                                ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙˆØ­Ø¯Ø§Øª
                            </label>
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                                ${[
                                    { key: 'dashboard', label: 'Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…', icon: 'fa-dashboard' },
                                    { key: 'incidents', label: 'Ø§Ù„Ø­ÙˆØ§Ø¯Ø«', icon: 'fa-exclamation-triangle' },
                                    { key: 'nearmiss', label: 'Ø§Ù„Ø­ÙˆØ§Ø¯Ø« Ø§Ù„ÙˆØ´ÙŠÙƒØ©', icon: 'fa-exclamation-circle' },
                                    { key: 'ptw', label: 'ØªØµØ§Ø±ÙŠØ­ Ø§Ù„Ø¹Ù…Ù„', icon: 'fa-id-card' },
                                    { key: 'training', label: 'Ø§Ù„ØªØ¯Ø±ÙŠØ¨', icon: 'fa-graduation-cap' },
                                    { key: 'clinic', label: 'Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©', icon: 'fa-hospital' },
                                    { key: 'fire-equipment', label: 'Ù…Ø¹Ø¯Ø§Øª Ø§Ù„Ø¥Ø·ÙØ§Ø¡', icon: 'fa-fire-extinguisher' },
                                    { key: 'ppe', label: 'Ù…Ù‡Ù…Ø§Øª Ø§Ù„ÙˆÙ‚Ø§ÙŠØ©', icon: 'fa-hard-hat' },
                                    { key: 'violations', label: 'Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª', icon: 'fa-ban' },
                                    { key: 'contractors', label: 'Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ÙŠÙ†', icon: 'fa-users' },
                                    { key: 'employees', label: 'Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†', icon: 'fa-database' },
                                    { key: 'behavior-monitoring', label: 'Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ØªØµØ±ÙØ§Øª', icon: 'fa-user-check' },
                                    { key: 'chemical-safety', label: 'Ø§Ù„Ø³Ù„Ø§Ù…Ø© Ø§Ù„ÙƒÙŠÙ…ÙŠØ§Ø¦ÙŠØ©', icon: 'fa-flask' },
                                    { key: 'daily-observations', label: 'Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©', icon: 'fa-eye' },
                                    { key: 'iso', label: 'Ù†Ø¸Ø§Ù… ISO', icon: 'fa-certificate' },
                                    { key: 'emergency', label: 'ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø·ÙˆØ§Ø±Ø¦', icon: 'fa-bell' }
                                ].map(module => {
                                    const hasPermission = userData?.permissions && userData.permissions[module.key] === true;
                                    const selectedRole = document.getElementById('user-role')?.value || userData?.role;
                                    const isAdmin = selectedRole === 'admin' || userData?.role === 'admin';
                                    return `
                                        <label class="flex items-center p-2 border rounded hover:bg-gray-50 cursor-pointer ${isAdmin ? 'opacity-50 cursor-not-allowed' : ''}">
                                            <input 
                                                type="checkbox" 
                                                class="user-permission-checkbox rounded border-gray-300 text-blue-600 mr-2" 
                                                data-module="${module.key}"
                                                ${hasPermission ? 'checked' : ''}
                                                ${isAdmin ? 'disabled' : ''}
                                                ${isAdmin ? 'title="Ø§Ù„Ù…Ø¯ÙŠØ± Ù„Ø¯ÙŠÙ‡ ØµÙ„Ø§Ø­ÙŠØ§Øª ÙƒØ§Ù…Ù„Ø©"' : ''}
                                            >
                                            <i class="fas ${module.icon} ml-1 text-gray-600"></i>
                                            <span class="text-sm text-gray-700">${module.label}</span>
                                        </label>
                                    `;
                                }).join('')}
                            </div>
                            <p class="text-xs text-gray-500 mt-2">
                                <i class="fas fa-info-circle ml-1"></i>
                                ÙŠÙ…ÙƒÙ†Ùƒ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„ØªÙŠ ÙŠÙ…ÙƒÙ† Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„ÙŠÙ‡Ø§. Ø§Ù„Ù…Ø¯ÙŠØ± Ù„Ø¯ÙŠÙ‡ ØµÙ„Ø§Ø­ÙŠØ§Øª ÙƒØ§Ù…Ù„Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.
                            </p>
                        </div>

                        <div class="flex items-center justify-end gap-4 pt-4 border-t">
                            <button type="button" id="cancel-user-btn" class="btn-secondary">
                                Ø¥Ù„ØºØ§Ø¡
                            </button>
                            <button type="submit" class="btn-primary">
                                <i class="fas fa-save ml-2" aria-hidden="true"></i>
                                ${isEdit ? 'Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª' : 'Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…'}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        `;
    },

    async loadUsersList() {
        const container = document.getElementById('users-table-container');
        if (!container) return;

        const users = AppState.appData.users || [];
        
        if (users.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-users text-4xl text-gray-300 mb-4"></i>
                    <p class="text-gray-500">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</p>
                    <button id="add-user-empty-btn" class="btn-primary mt-4">
                        <i class="fas fa-plus ml-2"></i>
                        Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯
                    </button>
                </div>
            `;
            return;
        }

        const tableHTML = `
            <div class="table-wrapper" style="overflow-x: auto;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Ø§Ù„Ø§Ø³Ù…</th>
                            <th>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</th>
                            <th>Ø§Ù„Ø¯ÙˆØ±</th>
                            <th>Ø§Ù„Ù‚Ø³Ù…</th>
                            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                            <th>Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„</th>
                            <th>Ø¢Ø®Ø± ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</th>
                            <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡</th>
                            <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${users.map(user => {
                            const isOnline = user.isOnline === true;
                            const lastLoginTime = user.lastLogin ? Utils.formatDateTime(user.lastLogin) : '-';
                            return `
                            <tr>
                                <td>
                                    <div class="flex items-center gap-3">
                                        ${user.photo ? `<img src="${user.photo}" alt="${Utils.escapeHTML(user.name || '')}" class="w-10 h-10 rounded-full object-cover">` : `<div class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center"><i class="fas fa-user text-gray-400"></i></div>`}
                                        <span>${Utils.escapeHTML(user.name || '')}</span>
                                    </div>
                                </td>
                                <td>${Utils.escapeHTML(user.email || '')}</td>
                                <td>
                                    <span class="badge badge-${this.getRoleBadgeClass(user.role)}">
                                        ${this.getRoleName(user.role)}
                                    </span>
                                </td>
                                <td>${Utils.escapeHTML(user.department || '')}</td>
                                <td>
                                    <span class="badge badge-${user.active !== false ? 'success' : 'danger'}">
                                        ${user.active !== false ? 'Ù†Ø´Ø·' : 'ØºÙŠØ± Ù†Ø´Ø·'}
                                    </span>
                                </td>
                                <td>
                                    <div class="flex items-center gap-2">
                                        <div class="w-3 h-3 rounded-full ${isOnline ? 'bg-green-500' : 'bg-gray-400'}" style="animation: ${isOnline ? 'pulse 2s infinite' : 'none'};"></div>
                                        <span class="text-sm ${isOnline ? 'text-green-600' : 'text-gray-500'}">
                                            ${isOnline ? 'Ù…ØªØµÙ„' : 'ØºÙŠØ± Ù…ØªØµÙ„'}
                                        </span>
                                    </div>
                                </td>
                                <td>
                                    <span class="text-sm text-gray-600" title="${user.lastLogin || '-'}">
                                        ${lastLoginTime}
                                    </span>
                                </td>
                                <td>${user.createdAt ? Utils.formatDate(user.createdAt) : '-'}</td>
                                <td>
                                    <div class="flex items-center gap-2">
                                        <button 
                                            onclick="Users.editUser('${user.id}')" 
                                            class="btn-icon btn-icon-primary"
                                            title="ØªØ¹Ø¯ÙŠÙ„"
                                        >
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button 
                                            onclick="Users.deleteUser('${user.id}')" 
                                            class="btn-icon btn-icon-danger"
                                            title="Ø­Ø°Ù"
                                        >
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
        `;

        container.innerHTML = tableHTML;
    },

    getRoleName(role) {
        const roles = {
            'admin': 'Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…',
            'safety_officer': 'Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ø³Ù„Ø§Ù…Ø©',
            'user': 'Ù…Ø³ØªØ®Ø¯Ù…'
        };
        return roles[role] || role;
    },

    getRoleBadgeClass(role) {
        const classes = {
            'admin': 'danger',
            'safety_officer': 'warning',
            'user': 'info'
        };
        return classes[role] || 'secondary';
    },

    setupEventListeners() {
        // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯
        setTimeout(() => {
            const addBtn = document.getElementById('add-user-btn');
            const addEmptyBtn = document.getElementById('add-user-empty-btn');
            
            if (addBtn) {
                addBtn.addEventListener('click', () => this.showForm());
            }
            if (addEmptyBtn) {
                addEmptyBtn.addEventListener('click', () => this.showForm());
            }

            // Ø§Ø³ØªÙŠØ±Ø§Ø¯ Excel
            const importExcelBtn = document.getElementById('import-excel-btn');
            if (importExcelBtn) {
                importExcelBtn.addEventListener('click', () => this.showImportExcel());
            }

            // Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ØªØµÙÙŠØ©
            const searchInput = document.getElementById('users-search');
            const filterRole = document.getElementById('users-filter-role');
            
            if (searchInput) {
                searchInput.addEventListener('input', (e) => this.filterUsers(e.target.value, filterRole?.value));
            }
            if (filterRole) {
                filterRole.addEventListener('change', (e) => this.filterUsers(searchInput?.value, e.target.value));
            }

            // Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            const userForm = document.getElementById('user-form');
            if (userForm) {
                userForm.addEventListener('submit', (e) => this.handleSubmit(e));
            }

            const cancelBtn = document.getElementById('cancel-user-btn');
            if (cancelBtn) {
                cancelBtn.addEventListener('click', () => this.showList());
            }
            
            this.setupPhotoPreview();
        }, 100);
    },

    async showForm(userData = null) {
        console.log('ğŸ”§ Ø¹Ø±Ø¶ Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ Ù…Ø³ØªØ®Ø¯Ù…:', userData ? 'ØªØ¹Ø¯ÙŠÙ„' : 'Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯');
        this.currentEditId = userData?.id || null;
        const content = document.getElementById('users-content');
        if (content) {
            content.innerHTML = await this.renderForm(userData);
            this.setupEventListeners();
            
            // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ø¯ÙˆØ±
            setTimeout(() => {
                const roleSelect = document.getElementById('user-role');
                if (roleSelect) {
                    roleSelect.addEventListener('change', () => {
                        this.updatePermissionsUI();
                    });
                }
                
                // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
                this.updatePermissionsUI();
            }, 100);
        } else {
            console.error('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ users-content');
        }
    },

    updatePermissionsUI() {
        const roleSelect = document.getElementById('user-role');
        const selectedRole = roleSelect?.value;
        const checkboxes = document.querySelectorAll('.user-permission-checkbox');
        
        checkboxes.forEach(checkbox => {
            const isAdmin = selectedRole === 'admin';
            if (isAdmin) {
                checkbox.disabled = true;
                checkbox.checked = true;
                checkbox.parentElement.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                checkbox.disabled = false;
                checkbox.parentElement.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        });
    },

    async showList() {
        this.currentEditId = null;
        const content = document.getElementById('users-content');
        if (content) {
            content.innerHTML = await this.renderList();
            this.setupEventListeners();
            this.loadUsersList();
        }
    },

    async handleSubmit(e) {
        e.preventDefault();
        
        const userData = this.currentEditId ? AppState.appData.users.find(u => u.id === this.currentEditId) : null;
        
        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø©
        let photoBase64 = userData?.photo || '';
        const photoInput = document.getElementById('user-photo-input');
        if (photoInput && photoInput.files.length > 0) {
            const file = photoInput.files[0];
            if (file.size > 2 * 1024 * 1024) {
                Notification.error('Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹. Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 2MB');
                return;
            }
            photoBase64 = await this.convertImageToBase64(file);
        }
        
        const formData = {
            id: this.currentEditId || Utils.generateId('USER'),
            name: document.getElementById('user-name').value.trim(),
            email: document.getElementById('user-email').value.trim().toLowerCase(),
            password: document.getElementById('user-password').value || userData?.password,
            role: document.getElementById('user-role').value,
            department: document.getElementById('user-department').value.trim(),
            active: document.getElementById('user-active').checked,
            photo: photoBase64,
            permissions: this.collectPermissions(),
            createdAt: this.currentEditId 
                ? AppState.appData.users.find(u => u.id === this.currentEditId)?.createdAt 
                : new Date().toISOString(),
            updatedAt: new Date().toISOString(),
            // Ø¥Ø¶Ø§ÙØ© Ø­Ù‚ÙˆÙ„ Ø¬Ø¯ÙŠØ¯Ø© Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
            lastLogin: userData?.lastLogin || null,
            lastLogout: userData?.lastLogout || null,
            isOnline: userData?.isOnline || false,
            loginHistory: userData?.loginHistory || []
        };

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        if (!formData.name || !formData.email || !formData.role || !formData.department) {
            Notification.error('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©');
            return;
        }

        if (!Utils.isValidEmail(formData.email)) {
            Notification.error('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØµØ­ÙŠØ­');
            return;
        }

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ØªÙƒØ±Ø§Ø± Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
        const existingUser = AppState.appData.users.find(u => 
            u.email === formData.email && u.id !== formData.id
        );
        if (existingUser) {
            Notification.error('Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„');
            return;
        }

        Loading.show();

        try {
            if (this.currentEditId) {
                // ØªØ¹Ø¯ÙŠÙ„ Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯
                const index = AppState.appData.users.findIndex(u => u.id === this.currentEditId);
                if (index !== -1) {
                    // Ø¹Ø¯Ù… ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¥Ø°Ø§ ÙƒØ§Ù†Øª ÙØ§Ø±ØºØ©
                    if (!formData.password) {
                        delete formData.password;
                        const oldUser = AppState.appData.users[index];
                        formData.password = oldUser.password; // Ø§Ù„Ø¥Ø¨Ù‚Ø§Ø¡ Ø¹Ù„Ù‰ Ø§Ù„Ù‚Ø¯ÙŠÙ…
                    } else {
                        // ØªØ´ÙÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø¥Ø°Ø§ ØªÙ… ØªØºÙŠÙŠØ±Ù‡Ø§
                        formData.password = await Utils.hashPassword(formData.password);
                    }
                    AppState.appData.users[index] = formData;
                }
                Notification.success('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­');
            } else {
                // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯
                if (!formData.password) {
                    Notification.error('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù…Ø·Ù„ÙˆØ¨Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø¬Ø¯Ø¯');
                    Loading.hide();
                    return;
                }
                
                // ØªØ´ÙÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸
                const plainPassword = formData.password;
                formData.password = await Utils.hashPassword(plainPassword);
                
                // Ø¥Ø®ÙØ§Ø¡ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙÙŠ Google Sheets (Ø§Ø³ØªØ®Ø¯Ø§Ù… "***" Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ù†Øµ)
                const userForSheets = { ...formData };
                userForSheets.password = '***'; // Ø¥Ø®ÙØ§Ø¡ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙÙŠ Google Sheets
                
                AppState.appData.users.push(formData);
                Notification.success('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­');
                
                // Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙÙŠ Google Sheets (Ø¨ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ù…Ø®ÙÙŠØ©)
                try {
                    await GoogleIntegration.appendToSheets('Users', [userForSheets]);
                } catch (error) {
                    console.warn('âš ï¸ ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Google Sheets:', error);
                }
            }

            // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            DataManager.save();
            
            // Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙÙŠ Google Sheets (Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø§Ù„Ù…Ø´ÙØ±Ø©)
            if (this.currentEditId) {
                // Ø¹Ù†Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ØŒ Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø§Ù„Ù…Ø´ÙØ±Ø©
                await GoogleIntegration.autoSave('Users', AppState.appData.users);
            }
            
            // ØªØ­Ø¯ÙŠØ« ØµÙˆØ±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
            if (AppState.currentUser && formData.email === AppState.currentUser.email) {
                AppState.currentUser = { ...AppState.currentUser, ...formData };
                UI.updateUserProfilePhoto();
            }

            Loading.hide();
            this.showList();
        } catch (error) {
            Loading.hide();
            Notification.error('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
        }
    },

    async editUser(userId) {
        const user = AppState.appData.users.find(u => u.id === userId);
        if (user) {
            await this.showForm(user);
        }
    },

    async deleteUser(userId) {
        if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ')) {
            return;
        }

        Loading.show();

        try {
            AppState.appData.users = AppState.appData.users.filter(u => u.id !== userId);
            DataManager.save();
            
            // Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙÙŠ Google Sheets
            await GoogleIntegration.autoSave('Users', AppState.appData.users);

            Loading.hide();
            Notification.success('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­');
            this.loadUsersList();
        } catch (error) {
            Loading.hide();
            Notification.error('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
        }
    },

    filterUsers(searchTerm = '', roleFilter = '') {
        const users = AppState.appData.users || [];
        let filtered = users;

        if (searchTerm) {
            const term = searchTerm.toLowerCase();
            filtered = filtered.filter(user => 
                user.name?.toLowerCase().includes(term) ||
                user.email?.toLowerCase().includes(term) ||
                user.department?.toLowerCase().includes(term)
            );
        }

        if (roleFilter) {
            filtered = filtered.filter(user => user.role === roleFilter);
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„
        const tbody = document.querySelector('#users-table-container tbody');
        if (tbody) {
            if (filtered.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-gray-500 py-8">
                            Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬
                        </td>
                    </tr>
                `;
            } else {
                tbody.innerHTML = filtered.map(user => `
                    <tr>
                        <td>${Utils.escapeHTML(user.name || '')}</td>
                        <td>${Utils.escapeHTML(user.email || '')}</td>
                        <td>
                            <span class="badge badge-${this.getRoleBadgeClass(user.role)}">
                                ${this.getRoleName(user.role)}
                            </span>
                        </td>
                        <td>${Utils.escapeHTML(user.department || '')}</td>
                        <td>
                            <span class="badge badge-${user.active !== false ? 'success' : 'danger'}">
                                ${user.active !== false ? 'Ù†Ø´Ø·' : 'ØºÙŠØ± Ù†Ø´Ø·'}
                            </span>
                        </td>
                        <td>${user.createdAt ? Utils.formatDate(user.createdAt) : '-'}</td>
                        <td>
                            <div class="flex items-center gap-2">
                                <button 
                                    onclick="Users.editUser('${user.id}')" 
                                    class="btn-icon btn-icon-primary"
                                    title="ØªØ¹Ø¯ÙŠÙ„"
                                >
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button 
                                    onclick="Users.deleteUser('${user.id}')" 
                                    class="btn-icon btn-icon-danger"
                                    title="Ø­Ø°Ù"
                                >
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            }
        }
    },

    async showImportExcel() {
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 700px;">
                <div class="modal-header">
                    <h2 class="modal-title"><i class="fas fa-file-excel ml-2"></i>Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ù…Ù† Ù…Ù„Ù Excel</h2>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="space-y-4">
                        <div class="bg-blue-50 border border-blue-200 rounded p-4">
                            <p class="text-sm text-blue-800 mb-2"><strong>Ù…Ù„Ø§Ø­Ø¸Ø© Ù…Ù‡Ù…Ø©:</strong></p>
                            <p class="text-sm text-blue-700">ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ù…Ù„Ù Excel Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©:</p>
                            <ul class="text-sm text-blue-700 list-disc mr-6 mt-2">
                                <li><strong>Ø§Ù„Ø§Ø³Ù…</strong> Ø£Ùˆ <strong>Name</strong> - Ø¥Ù„Ø²Ø§Ù…ÙŠ</li>
                                <li><strong>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</strong> Ø£Ùˆ <strong>Email</strong> - Ø¥Ù„Ø²Ø§Ù…ÙŠ</li>
                                <li><strong>Ø§Ù„Ø¯ÙˆØ±</strong> Ø£Ùˆ <strong>Role</strong> (Ù…Ø¯ÙŠØ±ØŒ Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ø³Ù„Ø§Ù…Ø©ØŒ Ù…Ø³ØªØ®Ø¯Ù…)</li>
                                <li><strong>Ø§Ù„Ù‚Ø³Ù…</strong> Ø£Ùˆ <strong>Department</strong></li>
                            </ul>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                <i class="fas fa-file-excel ml-2"></i>
                                Ø§Ø®ØªØ± Ù…Ù„Ù Excel (.xlsx, .xls)
                            </label>
                            <input type="file" id="excel-file-input" accept=".xlsx,.xls" class="form-input">
                        </div>
                        <div id="import-preview" class="hidden">
                            <h3 class="text-sm font-semibold mb-2">Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø£ÙˆÙ„ 5 ØµÙÙˆÙ):</h3>
                            <div class="max-h-60 overflow-auto border rounded">
                                <table class="data-table text-xs">
                                    <thead id="preview-head"></thead>
                                    <tbody id="preview-body"></tbody>
                                </table>
                            </div>
                            <p id="preview-count" class="text-sm text-gray-600 mt-2"></p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" onclick="this.closest('.modal-overlay').remove()">Ø¥Ù„ØºØ§Ø¡</button>
                    <button id="confirm-import-btn" class="btn-primary" disabled>
                        <i class="fas fa-upload ml-2"></i>Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                    </button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        
        const fileInput = document.getElementById('excel-file-input');
        const confirmBtn = document.getElementById('confirm-import-btn');
        let importedData = [];
        
        // ØªØ­Ù…ÙŠÙ„ SheetJS Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…Ø­Ù…Ù„Ø§Ù‹
        const loadSheetJS = () => {
            if (typeof XLSX === 'undefined') {
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
                script.onload = () => {
                    fileInput.addEventListener('change', (e) => {
                        importedData = [];
                        this.handleExcelFile(e.target.files[0], modal, confirmBtn, (data) => {
                            importedData = data;
                        });
                    });
                };
                document.head.appendChild(script);
            } else {
                fileInput.addEventListener('change', (e) => {
                    importedData = [];
                    this.handleExcelFile(e.target.files[0], modal, confirmBtn, (data) => {
                        importedData = data;
                    });
                });
            }
        };
        
        loadSheetJS();
        
        confirmBtn.addEventListener('click', async () => {
            if (importedData.length === 0) {
                Notification.error('ÙŠØ±Ø¬Ù‰ ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Excel Ø£ÙˆÙ„Ø§Ù‹');
                return;
            }
            await this.processImport(importedData, modal);
        });
        
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
        });
    },

    handleExcelFile(file, modal, confirmBtn, callback) {
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                Loading.show();
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet);
                
                if (jsonData.length === 0) {
                    Loading.hide();
                    Notification.error('Ø§Ù„Ù…Ù„Ù ÙØ§Ø±Øº Ø£Ùˆ ØºÙŠØ± ØµØ­ÙŠØ­');
                    return;
                }
                
                if (callback) callback(jsonData);
                
                // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
                const preview = document.getElementById('import-preview');
                const previewHead = document.getElementById('preview-head');
                const previewBody = document.getElementById('preview-body');
                const previewCount = document.getElementById('preview-count');
                
                if (preview && jsonData.length > 0) {
                    const headers = Object.keys(jsonData[0]);
                    previewHead.innerHTML = `<tr>${headers.map(h => `<th class="px-2 py-1">${Utils.escapeHTML(h)}</th>`).join('')}</tr>`;
                    previewBody.innerHTML = jsonData.slice(0, 5).map(row => 
                        `<tr>${headers.map(h => `<td class="px-2 py-1">${Utils.escapeHTML(String(row[h] || ''))}</td>`).join('')}</tr>`
                    ).join('');
                    previewCount.textContent = `Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØµÙÙˆÙ: ${jsonData.length}`;
                    preview.classList.remove('hidden');
                    confirmBtn.disabled = false;
                }
                
                Loading.hide();
            } catch (error) {
                Loading.hide();
                Notification.error('ÙØ´Ù„ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù: ' + error.message);
            }
        };
        reader.readAsArrayBuffer(file);
    },

    async processImport(data, modal) {
        try {
            Loading.show();
            let successCount = 0;
            let errorCount = 0;
            const errors = [];
            
            for (const row of data) {
                try {
                    const nameField = row['Ø§Ù„Ø§Ø³Ù…'] || row['Name'] || row['name'] || row['NAME'] || '';
                    const emailField = row['Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ'] || row['Email'] || row['email'] || row['EMAIL'] || '';
                    const roleField = row['Ø§Ù„Ø¯ÙˆØ±'] || row['Role'] || row['role'] || row['ROLE'] || 'user';
                    const deptField = row['Ø§Ù„Ù‚Ø³Ù…'] || row['Department'] || row['department'] || row['DEPARTMENT'] || '';
                    
                    if (!nameField || !emailField) {
                        errorCount++;
                        errors.push(`ØµÙ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù… Ø£Ùˆ Ø¨Ø±ÙŠØ¯: ${JSON.stringify(row)}`);
                        continue;
                    }
                    
                    if (!Utils.isValidEmail(emailField)) {
                        errorCount++;
                        errors.push(`Ø¨Ø±ÙŠØ¯ ØºÙŠØ± ØµØ­ÙŠØ­: ${emailField}`);
                        continue;
                    }
                    
                    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… Ø§Ù„ØªÙƒØ±Ø§Ø±
                    const existing = AppState.appData.users.find(u => u.email === emailField.toLowerCase());
                    if (existing) {
                        errorCount++;
                        continue;
                    }
                    
                    const user = {
                        id: Utils.generateId('USER'),
                        name: nameField.trim(),
                        email: emailField.toLowerCase().trim(),
                        password: 'Temp123!',
                        role: this.mapRole(roleField),
                        department: deptField.trim(),
                        active: true,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    };
                    
                    AppState.appData.users.push(user);
                    successCount++;
                } catch (err) {
                    errorCount++;
                }
            }
            
            DataManager.save();
            
            // Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙÙŠ Google Sheets
            if (successCount > 0) {
                await GoogleIntegration.autoSave('Users', AppState.appData.users);
            }
            
            Loading.hide();
            Notification.success(`ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ${successCount} Ù…ÙˆØ¸Ù${errorCount > 0 ? ` (ÙØ´Ù„ ${errorCount})` : ''}`);
            modal.remove();
            this.loadUsersList();
        } catch (error) {
            Loading.hide();
            Notification.error('ÙØ´Ù„ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯: ' + error.message);
        }
    },

    mapRole(roleText) {
        const text = String(roleText || '').toLowerCase().trim();
        if (text.includes('Ù…Ø¯ÙŠØ±') || text.includes('admin')) return 'admin';
        if (text.includes('Ø³Ù„Ø§Ù…Ø©') || text.includes('safety')) return 'safety_officer';
        return 'user';
    },

    async convertImageToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    },

    collectPermissions() {
        const permissions = {};
        const checkboxes = document.querySelectorAll('.user-permission-checkbox');
        checkboxes.forEach(checkbox => {
            if (checkbox.checked && !checkbox.disabled) {
                const module = checkbox.getAttribute('data-module');
                if (module) {
                    permissions[module] = true;
                }
            }
        });
        return Object.keys(permissions).length > 0 ? permissions : undefined;
    },

    setupPhotoPreview() {
        const photoInput = document.getElementById('user-photo-input');
        const preview = document.getElementById('user-photo-preview');
        const icon = document.getElementById('user-photo-icon');
        
        if (photoInput && preview && icon) {
            photoInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        preview.src = e.target.result;
                        preview.style.display = 'block';
                        icon.style.display = 'none';
                    };
                    reader.readAsDataURL(file);
                }
            });
        }
    }
};

// ===== Incidents Module (Ø§Ù„Ø­ÙˆØ§Ø¯Ø«) =====
const Incidents = {
    currentEditId: null,

    async load() {
        const section = document.getElementById('incidents-section');
        if (!section) {
            console.error('âŒ Ù‚Ø³Ù… incidents-section ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!');
            return;
        }
        console.log('âœ… Ù…Ø¯ÙŠÙˆÙ„ Incidents ÙŠÙƒØªØ¨ ÙÙŠ Ù‚Ø³Ù…: incidents-section');

        section.innerHTML = `
            <div class="section-header">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="section-title">
                            <i class="fas fa-exclamation-triangle ml-3"></i>
                            Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­ÙˆØ§Ø¯Ø«
                        </h1>
                        <p class="section-subtitle">ØªØ³Ø¬ÙŠÙ„ ÙˆÙ…ØªØ§Ø¨Ø¹Ø© Ø­ÙˆØ§Ø¯Ø« Ø§Ù„Ø³Ù„Ø§Ù…Ø© Ø§Ù„Ù…Ù‡Ù†ÙŠØ©</p>
                    </div>
                    <button id="add-incident-btn" class="btn-primary">
                        <i class="fas fa-plus ml-2"></i>
                        ØªØ³Ø¬ÙŠÙ„ Ø­Ø§Ø¯Ø« Ø¬Ø¯ÙŠØ¯
                    </button>
                </div>
            </div>
            <div id="incidents-content" class="mt-6">
                ${await this.renderList()}
            </div>
        `;

        this.setupEventListeners();
        this.loadIncidentsList();
    },

    async renderList() {
        return `
            <div class="content-card">
                <div class="card-header">
                    <div class="flex items-center justify-between">
                        <h2 class="card-title">
                            <i class="fas fa-list ml-2"></i>
                            Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­ÙˆØ§Ø¯Ø«
                        </h2>
                        <div class="flex items-center gap-4">
                            <input 
                                type="text" 
                                id="incidents-search" 
                                class="form-input" 
                                style="max-width: 300px;"
                                placeholder="Ø§Ù„Ø¨Ø­Ø«..."
                            >
                            <select id="incidents-filter-status" class="form-input" style="max-width: 200px;">
                                <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
                                <option value="Ù…ÙØªÙˆØ­">Ù…ÙØªÙˆØ­</option>
                                <option value="Ù‚ÙŠØ¯ Ø§Ù„ØªØ­Ù‚ÙŠÙ‚">Ù‚ÙŠØ¯ Ø§Ù„ØªØ­Ù‚ÙŠÙ‚</option>
                                <option value="Ù…ØºÙ„Ù‚">Ù…ØºÙ„Ù‚</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div id="incidents-table-container">
                        <div class="empty-state">
                            <i class="fas fa-spinner fa-spin text-4xl text-gray-300 mb-4"></i>
                            <p class="text-gray-500">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
                        </div>
                    </div>
                </div>
            </div>
        `;
    },

    async loadIncidentsList() {
        const container = document.getElementById('incidents-table-container');
        if (!container) return;

        const incidents = AppState.appData.incidents || [];
        
        if (incidents.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-exclamation-triangle text-4xl text-gray-300 mb-4"></i>
                    <p class="text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­ÙˆØ§Ø¯Ø« Ù…Ø³Ø¬Ù„Ø©</p>
                    <button id="add-incident-empty-btn" class="btn-primary mt-4">
                        <i class="fas fa-plus ml-2"></i>
                        ØªØ³Ø¬ÙŠÙ„ Ø­Ø§Ø¯Ø« Ø¬Ø¯ÙŠØ¯
                    </button>
                </div>
            `;
            return;
        }

        const tableHTML = `
            <div class="table-wrapper" style="overflow-x: auto;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
                            <th>Ø§Ù„Ù…ÙˆÙ‚Ø¹</th>
                            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                            <th>Ø§Ù„Ø´Ø¯Ø©</th>
                            <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                            <th>Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</th>
                            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                            <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${incidents.map(incident => `
                            <tr>
                                <td>${Utils.escapeHTML(incident.title || '')}</td>
                                <td>${Utils.escapeHTML(incident.location || '')}</td>
                                <td>${incident.date ? Utils.formatDate(incident.date) : '-'}</td>
                                <td>
                                    <span class="badge badge-${this.getSeverityBadgeClass(incident.severity)}">
                                        ${incident.severity || '-'}
                                    </span>
                                </td>
                                <td>${Utils.escapeHTML(incident.reportedBy || '')}</td>
                                <td>${Utils.escapeHTML(incident.employeeCode || incident.employeeNumber || '-')}</td>
                                <td>
                                    <span class="badge badge-${this.getStatusBadgeClass(incident.status)}">
                                        ${incident.status || '-'}
                                    </span>
                                </td>
                                <td>
                                    <div class="flex items-center gap-2">
                                        <button onclick="Incidents.viewIncident('${incident.id}')" class="btn-icon btn-icon-info" title="Ø¹Ø±Ø¶">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button onclick="Incidents.editIncident('${incident.id}')" class="btn-icon btn-icon-primary" title="ØªØ¹Ø¯ÙŠÙ„">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button onclick="Incidents.deleteIncident('${incident.id}')" class="btn-icon btn-icon-danger" title="Ø­Ø°Ù">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;

        container.innerHTML = tableHTML;
    },

    getSeverityBadgeClass(severity) {
        const classes = {
            'Ø¹Ø§Ù„ÙŠØ©': 'danger',
            'Ù…ØªÙˆØ³Ø·Ø©': 'warning',
            'Ù…Ù†Ø®ÙØ¶Ø©': 'info'
        };
        return classes[severity] || 'secondary';
    },

    getStatusBadgeClass(status) {
        const classes = {
            'Ù…ÙØªÙˆØ­': 'danger',
            'Ù‚ÙŠØ¯ Ø§Ù„ØªØ­Ù‚ÙŠÙ‚': 'warning',
            'Ù…ØºÙ„Ù‚': 'success'
        };
        return classes[status] || 'secondary';
    },

    setupEventListeners() {
        setTimeout(() => {
            const addBtn = document.getElementById('add-incident-btn');
            const addEmptyBtn = document.getElementById('add-incident-empty-btn');
            
            if (addBtn) addBtn.addEventListener('click', () => this.showForm());
            if (addEmptyBtn) addEmptyBtn.addEventListener('click', () => this.showForm());

                    const searchInput = document.getElementById('incidents-search');
                    const filterStatus = document.getElementById('incidents-filter-status');
                    
                    if (searchInput) searchInput.addEventListener('input', (e) => this.filterIncidents(e.target.value, filterStatus?.value));
                    if (filterStatus) filterStatus.addEventListener('change', (e) => this.filterIncidents(searchInput?.value, e.target.value));

            const form = document.getElementById('incident-form');
            if (form) form.addEventListener('submit', (e) => this.handleSubmit(e));
            const cancelBtn = document.getElementById('cancel-incident-btn');
            if (cancelBtn) cancelBtn.addEventListener('click', () => this.showList());
        }, 100);
    },

    async showForm(incidentData = null) {
        this.currentEditId = incidentData?.id || null;
        const content = document.getElementById('incidents-content');
        if (!content) return;
        
        content.innerHTML = await this.renderForm(incidentData);
        this.setupEventListeners();
    },

    async renderForm(incidentData = null) {
        const isEdit = !!incidentData;
        const isoCode = incidentData?.isoCode || this.generateISOCode('INC');
        const companyLogo = (typeof AppState !== 'undefined' && AppState.companyLogo) ? AppState.companyLogo : '';
        
        return `
            <div class="content-card">
                ${companyLogo ? `
                    <div class="mb-4 pb-4 border-b" style="direction: ltr; text-align: left;">
                        <img src="${companyLogo}" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ø´Ø±ÙƒØ©" style="max-height: 60px; max-width: 150px;">
                    </div>
                ` : ''}
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-${isEdit ? 'edit' : 'plus-circle'} ml-2"></i>
                        ${isEdit ? 'ØªØ¹Ø¯ÙŠÙ„ Ø­Ø§Ø¯Ø«' : 'ØªØ³Ø¬ÙŠÙ„ Ø­Ø§Ø¯Ø« Ø¬Ø¯ÙŠØ¯'}
                    </h2>
                </div>
                <div class="card-body">
                    <form id="incident-form" class="space-y-6">
                        <div class="grid grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <i class="fas fa-id-card ml-2"></i>
                                    Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ Ù„Ù„Ù…Ø¨Ù„Øº *
                                </label>
                                <input 
                                    type="text" 
                                    id="incident-employee-code" 
                                    required
                                    class="form-input"
                                    value="${incidentData?.employeeCode || incidentData?.employeeNumber || ''}"
                                    placeholder="Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ"
                                >
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <i class="fas fa-code ml-2"></i>
                                    ÙƒÙˆØ¯ ISO *
                                </label>
                                <input 
                                    type="text" 
                                    id="incident-iso-code" 
                                    class="form-input"
                                    value="${isoCode}"
                                    readonly
                                    style="background-color: #f3f4f6;"
                                >
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <i class="fas fa-heading ml-2"></i>
                                    Ø§Ù„Ø¹Ù†ÙˆØ§Ù† *
                                </label>
                                <input 
                                    type="text" 
                                    id="incident-title" 
                                    required
                                    class="form-input"
                                    value="${incidentData?.title || ''}"
                                    placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø­Ø§Ø¯Ø«"
                                >
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <i class="fas fa-map-marker-alt ml-2"></i>
                                    Ø§Ù„Ù…ÙˆÙ‚Ø¹ *
                                </label>
                                <input 
                                    type="text" 
                                    id="incident-location" 
                                    required
                                    class="form-input"
                                    value="${incidentData?.location || ''}"
                                    placeholder="Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ø¯Ø«"
                                >
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <i class="fas fa-calendar ml-2"></i>
                                    Ø§Ù„ØªØ§Ø±ÙŠØ® *
                                </label>
                                <input 
                                    type="datetime-local" 
                                    id="incident-date" 
                                    required
                                    class="form-input"
                                    value="${incidentData?.date ? new Date(incidentData.date).toISOString().slice(0, 16) : ''}"
                                >
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <i class="fas fa-exclamation-circle ml-2"></i>
                                    Ø§Ù„Ø´Ø¯Ø© *
                                </label>
                                <select id="incident-severity" required class="form-input">
                                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø´Ø¯Ø©</option>
                                    <option value="Ø¹Ø§Ù„ÙŠØ©" ${incidentData?.severity === 'Ø¹Ø§Ù„ÙŠØ©' ? 'selected' : ''}>Ø¹Ø§Ù„ÙŠØ©</option>
                                    <option value="Ù…ØªÙˆØ³Ø·Ø©" ${incidentData?.severity === 'Ù…ØªÙˆØ³Ø·Ø©' ? 'selected' : ''}>Ù…ØªÙˆØ³Ø·Ø©</option>
                                    <option value="Ù…Ù†Ø®ÙØ¶Ø©" ${incidentData?.severity === 'Ù…Ù†Ø®ÙØ¶Ø©' ? 'selected' : ''}>Ù…Ù†Ø®ÙØ¶Ø©</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <i class="fas fa-user ml-2"></i>
                                    Ø§Ù„Ù…Ø¨Ù„Øº (Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù) *
                                </label>
                                <div class="relative">
                                    <input 
                                        type="text" 
                                        id="incident-reported-by" 
                                        required
                                        class="form-input"
                                        value="${incidentData?.reportedBy || ''}"
                                        placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ"
                                        autocomplete="off"
                                    >
                                    <div id="incident-reported-dropdown" class="absolute z-50 hidden w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-auto">
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <i class="fas fa-info-circle ml-2"></i>
                                    Ø§Ù„Ø­Ø§Ù„Ø© *
                                </label>
                                <select id="incident-status" required class="form-input">
                                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø­Ø§Ù„Ø©</option>
                                    <option value="Ù…ÙØªÙˆØ­" ${incidentData?.status === 'Ù…ÙØªÙˆØ­' ? 'selected' : ''}>Ù…ÙØªÙˆØ­</option>
                                    <option value="Ù‚ÙŠØ¯ Ø§Ù„ØªØ­Ù‚ÙŠÙ‚" ${incidentData?.status === 'Ù‚ÙŠØ¯ Ø§Ù„ØªØ­Ù‚ÙŠÙ‚' ? 'selected' : ''}>Ù‚ÙŠØ¯ Ø§Ù„ØªØ­Ù‚ÙŠÙ‚</option>
                                    <option value="Ù…ØºÙ„Ù‚" ${incidentData?.status === 'Ù…ØºÙ„Ù‚' ? 'selected' : ''}>Ù…ØºÙ„Ù‚</option>
                                </select>
                            </div>
                            <div class="col-span-2">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <i class="fas fa-align-right ml-2"></i>
                                    Ø§Ù„ÙˆØµÙ *
                                </label>
                                <textarea 
                                    id="incident-description" 
                                    required
                                    class="form-input" 
                                    rows="4"
                                    placeholder="ÙˆØµÙ ØªÙØµÙŠÙ„ÙŠ Ù„Ù„Ø­Ø§Ø¯Ø«"
                                >${incidentData?.description || ''}</textarea>
                            </div>
                            <div class="col-span-2">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <i class="fas fa-image ml-2"></i>
                                    ØµÙˆØ±Ø© ØªÙˆØ¶ÙŠØ­ÙŠØ© (ØºÙŠØ± Ø¥Ù„Ø²Ø§Ù…ÙŠ)
                                </label>
                                <input type="file" id="incident-image-input" accept="image/*" class="form-input">
                                <div id="incident-image-preview" class="mt-2 ${incidentData?.image ? '' : 'hidden'}">
                                    <img src="${incidentData?.image || ''}" alt="ØµÙˆØ±Ø© Ø§Ù„Ø­Ø§Ø¯Ø«" class="w-48 h-48 object-cover rounded border mt-2" id="incident-image-img">
                                    <button type="button" onclick="document.getElementById('incident-image-input').value=''; document.getElementById('incident-image-preview').classList.add('hidden');" class="mt-1 text-xs text-red-600">Ø­Ø°Ù Ø§Ù„ØµÙˆØ±Ø©</button>
                                </div>
                            </div>
                            <div class="col-span-2">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <i class="fas fa-tasks ml-2"></i>
                                    Ø§Ù„Ø®Ø·Ø© Ø§Ù„ØªØµØ­ÙŠØ­ÙŠØ© (ØºÙŠØ± Ø¥Ù„Ø²Ø§Ù…ÙŠ)
                                </label>
                                <textarea 
                                    id="incident-corrective-action" 
                                    class="form-input" 
                                    rows="4"
                                    placeholder="ÙˆØµÙ Ø§Ù„Ø®Ø·Ø© Ø§Ù„ØªØµØ­ÙŠØ­ÙŠØ© ÙˆØ§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…ØªØ®Ø°Ø©"
                                >${incidentData?.correctiveAction || ''}</textarea>
                            </div>
                        </div>
                        <div class="flex items-center justify-end gap-4 pt-4 border-t">
                            <button type="button" id="cancel-incident-btn" class="btn-secondary">
                                Ø¥Ù„ØºØ§Ø¡
                            </button>
                            <button type="submit" class="btn-primary">
                                <i class="fas fa-save ml-2"></i>
                                ${isEdit ? 'Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª' : 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø§Ø¯Ø«'}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        `;
        
        // Setup employee autocomplete
        setTimeout(() => {
            if (typeof EmployeeHelper !== 'undefined') {
                EmployeeHelper.setupAutocomplete('incident-reported-by', (employee) => {
                    if (employee) {
                        document.getElementById('incident-employee-code').value = employee.code || '';
                        document.getElementById('incident-reported-by').value = employee.name || '';
                    }
                });
            }
            
            // Setup image preview
            const imageInput = document.getElementById('incident-image-input');
            const imagePreview = document.getElementById('incident-image-preview');
            const imageImg = document.getElementById('incident-image-img');
            if (imageInput && imagePreview && imageImg) {
                imageInput.addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        if (file.size > 5 * 1024 * 1024) {
                            Notification.error('Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹. Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 5MB');
                            imageInput.value = '';
                            return;
                        }
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            imageImg.src = e.target.result;
                            imagePreview.classList.remove('hidden');
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }
        }, 100);
    },

    generateISOCode(prefix) {
        const year = new Date().getFullYear();
        const month = String(new Date().getMonth() + 1).padStart(2, '0');
        const count = (AppState.appData.incidents || []).length + 1;
        return `${prefix}-${year}${month}-${String(count).padStart(4, '0')}`;
    },

    async convertImageToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    },

    async handleSubmit(e) {
        e.preventDefault();
        
        const employeeCode = document.getElementById('incident-employee-code').value.trim();
        const reportedBy = document.getElementById('incident-reported-by').value.trim();
        
        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø©
        let imageBase64 = this.currentEditId 
            ? (AppState.appData.incidents.find(i => i.id === this.currentEditId)?.image || '') 
            : '';
        const imageInput = document.getElementById('incident-image-input');
        if (imageInput && imageInput.files.length > 0) {
            const file = imageInput.files[0];
            if (file.size > 5 * 1024 * 1024) {
                Notification.error('Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹. Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 5MB');
                return;
            }
            try {
                imageBase64 = await this.convertImageToBase64(file);
            } catch (error) {
                Notification.error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©: ' + error.message);
                return;
            }
        }
        
        const formData = {
            id: this.currentEditId || Utils.generateId('INCIDENT'),
            isoCode: document.getElementById('incident-iso-code').value.trim(),
            title: document.getElementById('incident-title').value.trim(),
            location: document.getElementById('incident-location').value.trim(),
            date: new Date(document.getElementById('incident-date').value).toISOString(),
            severity: document.getElementById('incident-severity').value,
            reportedBy: reportedBy,
            employeeCode: employeeCode,
            employeeNumber: employeeCode,
            status: document.getElementById('incident-status').value,
            description: document.getElementById('incident-description').value.trim(),
            image: imageBase64,
            correctiveAction: document.getElementById('incident-corrective-action')?.value.trim() || '',
            createdAt: this.currentEditId 
                ? AppState.appData.incidents.find(i => i.id === this.currentEditId)?.createdAt 
                : new Date().toISOString(),
            updatedAt: new Date().toISOString()
        };

        if (!formData.title || !formData.location || !formData.severity || !formData.status) {
            Notification.error('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©');
            return;
        }

        Loading.show();
        try {
            if (this.currentEditId) {
                const index = AppState.appData.incidents.findIndex(i => i.id === this.currentEditId);
                if (index !== -1) {
                    AppState.appData.incidents[index] = formData;
                }
                Notification.success('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ø¯Ø« Ø¨Ù†Ø¬Ø§Ø­');
            } else {
                AppState.appData.incidents.push(formData);
                Notification.success('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø§Ø¯Ø« Ø¨Ù†Ø¬Ø§Ø­');
            }

            DataManager.save();
            
            // Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙÙŠ Google Sheets
            await GoogleIntegration.autoSave('Incidents', AppState.appData.incidents);

            Loading.hide();
            this.showList();
        } catch (error) {
            Loading.hide();
            Notification.error('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
        }
    },

    async showList() {
        this.currentEditId = null;
        const content = document.getElementById('incidents-content');
        if (content) {
            content.innerHTML = await this.renderList();
            this.setupEventListeners();
            this.loadIncidentsList();
        }
    },

    async editIncident(id) {
        const incident = AppState.appData.incidents.find(i => i.id === id);
        if (incident) await this.showForm(incident);
    },

    async viewIncident(id) {
        const incident = AppState.appData.incidents.find(i => i.id === id);
        if (!incident) return;

        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 800px;">
                <div class="modal-header">
                    <h2 class="modal-title">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø§Ø¯Ø«</h2>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm font-semibold text-gray-600">ÙƒÙˆØ¯ ISO:</label>
                                <p class="text-gray-800 font-mono">${Utils.escapeHTML(incident.isoCode || '')}</p>
                            </div>
                            <div>
                                <label class="text-sm font-semibold text-gray-600">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</label>
                                <p class="text-gray-800">${Utils.escapeHTML(incident.title || '')}</p>
                            </div>
                            <div>
                                <label class="text-sm font-semibold text-gray-600">Ø§Ù„Ù…ÙˆÙ‚Ø¹:</label>
                                <p class="text-gray-800">${Utils.escapeHTML(incident.location || '')}</p>
                            </div>
                            <div>
                                <label class="text-sm font-semibold text-gray-600">Ø§Ù„ØªØ§Ø±ÙŠØ®:</label>
                                <p class="text-gray-800">${incident.date ? Utils.formatDate(incident.date) : '-'}</p>
                            </div>
                            <div>
                                <label class="text-sm font-semibold text-gray-600">Ø§Ù„Ø´Ø¯Ø©:</label>
                                <span class="badge badge-${this.getSeverityBadgeClass(incident.severity)}">
                                    ${incident.severity || '-'}
                                </span>
                            </div>
                            <div>
                                <label class="text-sm font-semibold text-gray-600">Ø§Ù„Ù…Ø¨Ù„Øº:</label>
                                <p class="text-gray-800">${Utils.escapeHTML(incident.reportedBy || '')}</p>
                            </div>
                            <div>
                                <label class="text-sm font-semibold text-gray-600">Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ:</label>
                                <p class="text-gray-800">${Utils.escapeHTML(incident.employeeCode || incident.employeeNumber || '-')}</p>
                            </div>
                            <div>
                                <label class="text-sm font-semibold text-gray-600">Ø§Ù„Ø­Ø§Ù„Ø©:</label>
                                <span class="badge badge-${this.getStatusBadgeClass(incident.status)}">
                                    ${incident.status || '-'}
                                </span>
                            </div>
                            <div class="col-span-2">
                                <label class="text-sm font-semibold text-gray-600">Ø§Ù„ÙˆØµÙ:</label>
                                <p class="text-gray-800 whitespace-pre-wrap">${Utils.escapeHTML(incident.description || '')}</p>
                            </div>
                            ${incident.image ? `
                            <div class="col-span-2">
                                <label class="text-sm font-semibold text-gray-600">ØµÙˆØ±Ø© ØªÙˆØ¶ÙŠØ­ÙŠØ©:</label>
                                <div class="mt-2">
                                    <img src="${incident.image}" alt="ØµÙˆØ±Ø© Ø§Ù„Ø­Ø§Ø¯Ø«" class="max-w-full h-auto rounded border" style="max-height: 400px;">
                                </div>
                            </div>
                            ` : ''}
                            ${incident.correctiveAction ? `
                            <div class="col-span-2">
                                <label class="text-sm font-semibold text-gray-600">Ø§Ù„Ø®Ø·Ø© Ø§Ù„ØªØµØ­ÙŠØ­ÙŠØ©:</label>
                                <p class="text-gray-800 whitespace-pre-wrap bg-gray-50 p-4 rounded border">${Utils.escapeHTML(incident.correctiveAction || '')}</p>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" onclick="this.closest('.modal-overlay').remove()">Ø¥ØºÙ„Ø§Ù‚</button>
                    <button class="btn-secondary" onclick="Incidents.exportPDF('${incident.id}');">
                        <i class="fas fa-file-pdf ml-2"></i>ØªØµØ¯ÙŠØ± PDF
                    </button>
                    <button class="btn-primary" onclick="Incidents.editIncident('${incident.id}'); this.closest('.modal-overlay').remove();">
                        <i class="fas fa-edit ml-2"></i>ØªØ¹Ø¯ÙŠÙ„
                    </button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
        });
    },

    async deleteIncident(id) {
        if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø­Ø§Ø¯Ø«ØŸ')) return;
        Loading.show();
        try {
            AppState.appData.incidents = (AppState.appData.incidents || []).filter(i => i.id !== id);
            DataManager.save();
            
            // Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙÙŠ Google Sheets
            await GoogleIntegration.autoSave('Incidents', AppState.appData.incidents);

            Loading.hide();
            Notification.success('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø­Ø§Ø¯Ø« Ø¨Ù†Ø¬Ø§Ø­');
            this.loadIncidentsList();
        } catch (error) {
            Loading.hide();
            Notification.error('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
        }
    },

    async exportPDF(id) {
        const incident = AppState.appData.incidents.find(i => i.id === id);
        if (!incident) {
            Notification.error('Ø§Ù„Ø­Ø§Ø¯Ø« ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
            return;
        }
        
        try {
            Loading.show();
            
            const formCode = incident.isoCode || incident.id?.substring(0, 12) || 'INCIDENT-UNKNOWN';
            const formTitle = 'ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø­Ø§Ø¯Ø«';
            
            const content = `
                <table>
                    <tr><th>ÙƒÙˆØ¯ ISO</th><td>${Utils.escapeHTML(incident.isoCode || 'N/A')}</td></tr>
                    <tr><th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th><td>${Utils.escapeHTML(incident.title || 'N/A')}</td></tr>
                    <tr><th>Ø§Ù„Ù…ÙˆÙ‚Ø¹</th><td>${Utils.escapeHTML(incident.location || 'N/A')}</td></tr>
                    <tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><td>${incident.date ? Utils.formatDate(incident.date) : 'N/A'}</td></tr>
                    <tr><th>Ø§Ù„Ø´Ø¯Ø©</th><td>${Utils.escapeHTML(incident.severity || 'N/A')}</td></tr>
                    <tr><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><td>${Utils.escapeHTML(incident.reportedBy || 'N/A')}</td></tr>
                    <tr><th>Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</th><td>${Utils.escapeHTML(incident.employeeCode || incident.employeeNumber || 'N/A')}</td></tr>
                    <tr><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><td>${Utils.escapeHTML(incident.status || 'N/A')}</td></tr>
                </table>
                <div class="section-title">Ø§Ù„ÙˆØµÙ:</div>
                <div class="description">${Utils.escapeHTML(incident.description || 'N/A')}</div>
                ${incident.correctiveAction ? `
                <div class="section-title">Ø§Ù„Ø®Ø·Ø© Ø§Ù„ØªØµØ­ÙŠØ­ÙŠØ©:</div>
                <div class="description">${Utils.escapeHTML(incident.correctiveAction || '')}</div>
                ` : ''}
                ${incident.image ? `
                <div class="section-title">ØµÙˆØ±Ø© ØªÙˆØ¶ÙŠØ­ÙŠØ©:</div>
                <div style="text-align: center; margin: 20px 0;">
                    <img src="${incident.image}" alt="ØµÙˆØ±Ø© Ø§Ù„Ø­Ø§Ø¯Ø«" style="max-width: 100%; max-height: 400px; border: 1px solid #ddd; border-radius: 8px;">
                </div>
                ` : ''}
            `;
            
            const htmlContent = typeof FormHeader !== 'undefined' && FormHeader.generatePDFHTML
                ? FormHeader.generatePDFHTML(formCode, formTitle, content, false, true, { version: '1.0' }, incident.createdAt, incident.updatedAt)
                : `<html><body>${content}</body></html>`;
            
            const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const printWindow = window.open(url, '_blank');
            
            if (printWindow) {
                printWindow.onload = () => {
                    setTimeout(() => {
                        printWindow.print();
                        setTimeout(() => {
                            URL.revokeObjectURL(url);
                            Loading.hide();
                            Notification.success('ØªÙ… ÙØªØ­ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©/Ø§Ù„Ø­ÙØ¸ ÙƒÙ€ PDF');
                        }, 1000);
                    }, 500);
                };
            } else {
                Loading.hide();
                Notification.error('ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ù„Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±');
            }
        } catch (error) {
            Loading.hide();
            console.error('Ø®Ø·Ø£ ÙÙŠ ØªØµØ¯ÙŠØ± PDF:', error);
            Notification.error('ÙØ´Ù„ ØªØµØ¯ÙŠØ± PDF: ' + error.message);
        }
    },

    filterIncidents(searchTerm = '', statusFilter = '') {
        const incidents = AppState.appData.incidents || [];
        let filtered = incidents;
        
        if (searchTerm) {
            const term = searchTerm.toLowerCase();
            filtered = filtered.filter(incident => 
                incident.title?.toLowerCase().includes(term) ||
                incident.location?.toLowerCase().includes(term) ||
                incident.reportedBy?.toLowerCase().includes(term) ||
                incident.isoCode?.toLowerCase().includes(term)
            );
        }
        
        if (statusFilter) {
            filtered = filtered.filter(incident => incident.status === statusFilter);
        }
        
        const tbody = document.querySelector('#incidents-table-container tbody');
        if (tbody) {
            tbody.innerHTML = filtered.length === 0 ? 
                '<tr><td colspan="7" class="text-center text-gray-500 py-8">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</td></tr>' :
                filtered.map(incident => `
                    <tr>
                        <td>${Utils.escapeHTML(incident.title || '')}</td>
                        <td>${Utils.escapeHTML(incident.location || '')}</td>
                        <td>${incident.date ? Utils.formatDate(incident.date) : '-'}</td>
                        <td>
                            <span class="badge badge-${this.getSeverityBadgeClass(incident.severity)}">
                                ${incident.severity || '-'}
                            </span>
                        </td>
                        <td>${Utils.escapeHTML(incident.reportedBy || '')}</td>
                        <td>
                            <span class="badge badge-${this.getStatusBadgeClass(incident.status)}">
                                ${incident.status || '-'}
                            </span>
                        </td>
                        <td>
                            <div class="flex items-center gap-2">
                                <button onclick="Incidents.viewIncident('${incident.id}')" class="btn-icon btn-icon-info">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button onclick="Incidents.editIncident('${incident.id}')" class="btn-icon btn-icon-primary">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="Incidents.deleteIncident('${incident.id}')" class="btn-icon btn-icon-danger">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('');
        }
    }
};

// ===== NearMiss Module =====
const NearMiss = {
    async load() {
        const section = document.getElementById('nearmiss-section');
        if (!section) {
            console.error('âŒ Ù‚Ø³Ù… nearmiss-section ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!');
            return;
        }
        console.log('âœ… Ù…Ø¯ÙŠÙˆÙ„ NearMiss ÙŠÙƒØªØ¨ ÙÙŠ Ù‚Ø³Ù…: nearmiss-section');

        section.innerHTML = `
            <div class="section-header">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="section-title">
                            <i class="fas fa-eye ml-3" aria-hidden="true"></i>
                            Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­ÙˆØ§Ø¯Ø« Ø§Ù„ÙˆØ´ÙŠÙƒØ©
                        </h1>
                        <p class="section-subtitle">ØªØ³Ø¬ÙŠÙ„ ÙˆÙ…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø­ÙˆØ§Ø¯Ø« Ø§Ù„ÙˆØ´ÙŠÙƒØ©</p>
                    </div>
                    <button id="add-nearmiss-btn" class="btn-primary">
                        <i class="fas fa-plus ml-2" aria-hidden="true"></i>
                        ØªØ³Ø¬ÙŠÙ„ Ø­Ø§Ø¯Ø« ÙˆØ´ÙŠÙƒ Ø¬Ø¯ÙŠØ¯
                    </button>
                </div>
            </div>

            <div id="nearmiss-content" class="mt-6">
                ${await this.renderList()}
            </div>
        `;

        this.setupEventListeners();
        this.loadNearMissList();
    },

    async renderList() {
        return `
            <div class="content-card">
                <div class="card-header">
                    <div class="flex items-center justify-between">
                        <h2 class="card-title">
                            <i class="fas fa-list ml-2" aria-hidden="true"></i>
                            Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­ÙˆØ§Ø¯Ø« Ø§Ù„ÙˆØ´ÙŠÙƒØ©
                        </h2>
                        <div class="flex items-center gap-4">
                            <input 
                                type="text" 
                                id="nearmiss-search" 
                                class="form-input" 
                                style="max-width: 300px;"
                                placeholder="Ø§Ù„Ø¨Ø­Ø«..."
                            >
                            <select id="nearmiss-filter-status" class="form-input" style="max-width: 200px;">
                                <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
                                <option value="Ù…ÙØªÙˆØ­">Ù…ÙØªÙˆØ­</option>
                                <option value="Ù…Ù‚ÙŠØ¯">Ù…Ù‚ÙŠØ¯</option>
                                <option value="Ù…ØºÙ„Ù‚">Ù…ØºÙ„Ù‚</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div id="nearmiss-table-container">
                        <div class="empty-state">
                            <i class="fas fa-spinner fa-spin text-4xl text-gray-300 mb-4"></i>
                            <p class="text-gray-500">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
                        </div>
                    </div>
                </div>
            </div>
        `;
    },

    async renderForm(nearmissData = null) {
        const isEdit = !!nearmissData;
        return `
            <div class="content-card">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-${isEdit ? 'edit' : 'plus-circle'} ml-2"></i>
                        ${isEdit ? 'ØªØ¹Ø¯ÙŠÙ„ Ø­Ø§Ø¯Ø« ÙˆØ´ÙŠÙƒ' : 'ØªØ³Ø¬ÙŠÙ„ Ø­Ø§Ø¯Ø« ÙˆØ´ÙŠÙƒ Ø¬Ø¯ÙŠØ¯'}
                    </h2>
                </div>
                <div class="card-body">
                    <form id="nearmiss-form" class="space-y-6">
                        <div class="grid grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <i class="fas fa-heading ml-2"></i>
                                    Ø§Ù„Ø¹Ù†ÙˆØ§Ù† *
                                </label>
                                <input type="text" id="nearmiss-title" name="title" required class="form-input"
                                    value="${nearmissData?.title || ''}" placeholder="Ø£Ø¯Ø®Ù„ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø­Ø§Ø¯Ø« Ø§Ù„ÙˆØ´ÙŠÙƒ">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <i class="fas fa-calendar ml-2"></i>
                                    Ø§Ù„ØªØ§Ø±ÙŠØ® *
                                </label>
                                <input type="datetime-local" id="nearmiss-date" name="date" required class="form-input"
                                    value="${nearmissData?.date ? new Date(nearmissData.date).toISOString().slice(0, 16) : ''}">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <i class="fas fa-map-marker-alt ml-2"></i>
                                    Ø§Ù„Ù…ÙˆÙ‚Ø¹ *
                                </label>
                                <input type="text" id="nearmiss-location" name="location" required class="form-input"
                                    value="${nearmissData?.location || ''}" placeholder="Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ø¯Ø« Ø§Ù„ÙˆØ´ÙŠÙƒ">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <i class="fas fa-user ml-2"></i>
                                    Ø§Ù„Ù…ÙØ¨Ù„Øº *
                                </label>
                                <input type="text" id="nearmiss-reportedBy" name="reportedBy" required class="form-input"
                                    value="${nearmissData?.reportedBy || ''}" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙØ¨Ù„Øº">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <i class="fas fa-info-circle ml-2"></i>
                                    Ø§Ù„Ø­Ø§Ù„Ø© *
                                </label>
                                <select id="nearmiss-status" name="status" required class="form-input">
                                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø­Ø§Ù„Ø©</option>
                                    <option value="Ù…ÙØªÙˆØ­" ${nearmissData?.status === 'Ù…ÙØªÙˆØ­' ? 'selected' : ''}>Ù…ÙØªÙˆØ­</option>
                                    <option value="Ù…Ù‚ÙŠØ¯" ${nearmissData?.status === 'Ù…Ù‚ÙŠØ¯' ? 'selected' : ''}>Ù…Ù‚ÙŠØ¯</option>
                                    <option value="Ù…ØºÙ„Ù‚" ${nearmissData?.status === 'Ù…ØºÙ„Ù‚' ? 'selected' : ''}>Ù…ØºÙ„Ù‚</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                <i class="fas fa-align-right ml-2"></i>
                                Ø§Ù„ÙˆØµÙ *
                            </label>
                            <textarea id="nearmiss-description" name="description" required class="form-input" rows="4"
                                placeholder="Ø£Ø¯Ø®Ù„ ÙˆØµÙØ§Ù‹ ØªÙØµÙŠÙ„ÙŠØ§Ù‹">${nearmissData?.description || ''}</textarea>
                        </div>
                        <div class="flex items-center justify-end gap-4 pt-4 border-t">
                            <button type="button" id="cancel-nearmiss-btn" class="btn-secondary">Ø¥Ù„ØºØ§Ø¡</button>
                            <button type="submit" class="btn-primary">
                                <i class="fas fa-save ml-2"></i>
                                ${isEdit ? 'Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª' : 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø§Ø¯Ø« Ø§Ù„ÙˆØ´ÙŠÙƒ'}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        `;
    },

    async loadNearMissList() {
        const container = document.getElementById('nearmiss-table-container');
        if (!container) return;

        const items = AppState.appData.nearmiss || [];
        
        if (items.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-eye text-4xl text-gray-300 mb-4"></i>
                    <p class="text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­ÙˆØ§Ø¯Ø« ÙˆØ´ÙŠÙƒØ© Ù…Ø³Ø¬Ù„Ø©</p>
                    <button id="add-nearmiss-empty-btn" class="btn-primary mt-4">
                        <i class="fas fa-plus ml-2"></i>
                        ØªØ³Ø¬ÙŠÙ„ Ø­Ø§Ø¯Ø« ÙˆØ´ÙŠÙƒ Ø¬Ø¯ÙŠØ¯
                    </button>
                </div>
            `;
            return;
        }

        container.innerHTML = `
            <div class="table-wrapper" style="overflow-x: auto;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
                            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                            <th>Ø§Ù„Ù…ÙˆÙ‚Ø¹</th>
                            <th>Ø§Ù„Ù…ÙØ¨Ù„Øº</th>
                            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                            <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${items.map(item => `
                            <tr>
                                <td>${Utils.escapeHTML(item.title || '')}</td>
                                <td>${item.date ? Utils.formatDate(item.date) : '-'}</td>
                                <td>${Utils.escapeHTML(item.location || '')}</td>
                                <td>${Utils.escapeHTML(item.reportedBy || '')}</td>
                                <td>
                                    <span class="badge badge-${item.status === 'Ù…ØºÙ„Ù‚' ? 'success' : item.status === 'Ù…Ù‚ÙŠØ¯' ? 'info' : 'warning'}">
                                        ${item.status || '-'}
                                    </span>
                                </td>
                                <td>
                                    <div class="flex items-center gap-2">
                                        <button onclick="NearMiss.editNearMiss('${item.id}')" class="btn-icon btn-icon-primary" title="ØªØ¹Ø¯ÙŠÙ„">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button onclick="NearMiss.deleteNearMiss('${item.id}')" class="btn-icon btn-icon-danger" title="Ø­Ø°Ù">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
    },

    setupEventListeners() {
        setTimeout(() => {
            const addBtn = document.getElementById('add-nearmiss-btn');
            const addEmptyBtn = document.getElementById('add-nearmiss-empty-btn');
            if (addBtn) addBtn.addEventListener('click', () => this.showForm());
            if (addEmptyBtn) addEmptyBtn.addEventListener('click', () => this.showForm());

            const searchInput = document.getElementById('nearmiss-search');
            const filterStatus = document.getElementById('nearmiss-filter-status');
            if (searchInput) searchInput.addEventListener('input', (e) => this.filterItems(e.target.value, filterStatus?.value));
            if (filterStatus) filterStatus.addEventListener('change', (e) => this.filterItems(searchInput?.value, e.target.value));

            const form = document.getElementById('nearmiss-form');
            if (form) form.addEventListener('submit', (e) => this.handleSubmit(e));
            const cancelBtn = document.getElementById('cancel-nearmiss-btn');
            if (cancelBtn) cancelBtn.addEventListener('click', () => this.showList());
        }, 100);
    },

    async showForm(data = null) {
        const content = document.getElementById('nearmiss-content');
        if (content) {
            content.innerHTML = await this.renderForm(data);
            this.setupEventListeners();
        }
    },

    async showList() {
        const content = document.getElementById('nearmiss-content');
        if (content) {
            content.innerHTML = await this.renderList();
            this.setupEventListeners();
            this.loadNearMissList();
        }
    },

    async handleSubmit(e) {
        e.preventDefault();
        const formData = {
            id: Utils.generateId('NEARMISS'),
            title: document.getElementById('nearmiss-title').value.trim(),
            description: document.getElementById('nearmiss-description').value.trim(),
            location: document.getElementById('nearmiss-location').value.trim(),
            date: new Date(document.getElementById('nearmiss-date').value).toISOString(),
            reportedBy: document.getElementById('nearmiss-reportedBy').value.trim(),
            status: document.getElementById('nearmiss-status').value,
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
        };

        if (!formData.title || !formData.description || !formData.location || !formData.status) {
            Notification.error('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©');
            return;
        }

        Loading.show();
        try {
            AppState.appData.nearmiss.push(formData);
            DataManager.save();
            // Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙÙŠ Google Sheets
            await GoogleIntegration.autoSave('NearMiss', AppState.appData.nearmiss);
            Loading.hide();
            Notification.success('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø§Ø¯Ø« Ø§Ù„ÙˆØ´ÙŠÙƒ Ø¨Ù†Ø¬Ø§Ø­');
            this.showList();
        } catch (error) {
            Loading.hide();
            Notification.error('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
        }
    },

    async editNearMiss(id) {
        const item = AppState.appData.nearmiss.find(i => i.id === id);
        if (item) await this.showForm(item);
    },

    async deleteNearMiss(id) {
        if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø­Ø§Ø¯Ø« Ø§Ù„ÙˆØ´ÙŠÙƒØŸ')) return;
        Loading.show();
        try {
            AppState.appData.nearmiss = AppState.appData.nearmiss.filter(i => i.id !== id);
            DataManager.save();
            // Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙÙŠ Google Sheets
            await GoogleIntegration.autoSave('NearMiss', AppState.appData.nearmiss);
            Loading.hide();
            Notification.success('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø­Ø§Ø¯Ø« Ø§Ù„ÙˆØ´ÙŠÙƒ Ø¨Ù†Ø¬Ø§Ø­');
            this.loadNearMissList();
        } catch (error) {
            Loading.hide();
            Notification.error('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
        }
    },

    filterItems(searchTerm = '', statusFilter = '') {
        const items = AppState.appData.nearmiss || [];
        let filtered = items;
        if (searchTerm) {
            const term = searchTerm.toLowerCase();
            filtered = filtered.filter(item => 
                item.title?.toLowerCase().includes(term) ||
                item.description?.toLowerCase().includes(term) ||
                item.location?.toLowerCase().includes(term)
            );
        }
        if (statusFilter) {
            filtered = filtered.filter(item => item.status === statusFilter);
        }
        const tbody = document.querySelector('#nearmiss-table-container tbody');
        if (tbody) {
            tbody.innerHTML = filtered.length === 0 ? 
                '<tr><td colspan="6" class="text-center text-gray-500 py-8">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</td></tr>' :
                filtered.map(item => `
                    <tr>
                        <td>${Utils.escapeHTML(item.title || '')}</td>
                        <td>${item.date ? Utils.formatDate(item.date) : '-'}</td>
                        <td>${Utils.escapeHTML(item.location || '')}</td>
                        <td>${Utils.escapeHTML(item.reportedBy || '')}</td>
                        <td>
                            <span class="badge badge-${item.status === 'Ù…ØºÙ„Ù‚' ? 'success' : item.status === 'Ù…Ù‚ÙŠØ¯' ? 'info' : 'warning'}">
                                ${item.status || '-'}
                            </span>
                        </td>
                        <td>
                            <div class="flex items-center gap-2">
                                <button onclick="NearMiss.editNearMiss('${item.id}')" class="btn-icon btn-icon-primary">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="NearMiss.deleteNearMiss('${item.id}')" class="btn-icon btn-icon-danger">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('');
        }
    }
};

// ===== PTW Module (Permit to Work) =====
const PTW = {
    approvals: [], // Ù…ØµÙÙˆÙØ© Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø§Øª
    
    /**
     * Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ø®ØªØµØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„
     */
    getWorkTypePrefix(workType) {
        const prefixes = {
            'Ø³Ø§Ø®Ù†': 'HTW',      // Hot Work
            'Ø¨Ø§Ø±Ø¯': 'CTW',      // Cold Work
            'ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠ': 'ETW',   // Electrical Work
            'Ø­ÙØ±': 'EXW',       // Excavation Work
            'Ø§Ø±ØªÙØ§Ø¹': 'HTW',    // Height Work
            'Ù†ÙØ·': 'OTW',       // Oil Work
            'ØºØ§Ø²': 'GTW',       // Gas Work
            'Ø¥ØºÙ„Ø§Ù‚': 'ISW',     // Isolation Work
            'ÙƒÙŠÙ…ÙŠØ§Ø¦ÙŠ': 'CHW',   // Chemical Work
            'Ø¢Ø®Ø±': 'OTW'        // Other Work
        };
        return prefixes[workType] || 'PTW';
    },
    
    /**
     * ØªÙˆÙ„ÙŠØ¯ Ø±Ù‚Ù… ØªØ³Ù„Ø³Ù„ÙŠ Ù„ÙƒÙ„ Ù†ÙˆØ¹ Ø¹Ù…Ù„
     */
    generateSequentialPTWId(workType) {
        const workTypePrefix = this.getWorkTypePrefix(workType);
        const existingPTWs = AppState.appData.ptw || [];
        
        // ÙÙ„ØªØ±Ø© Ø§Ù„ØªØµØ§Ø±ÙŠØ­ Ø¨Ù†ÙØ³ Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„
        const sameTypePTWs = existingPTWs.filter(p => {
            if (!p.id || !p.workType) return false;
            const ptwPrefix = this.getWorkTypePrefix(p.workType);
            return ptwPrefix === workTypePrefix;
        });
        
        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¢Ø®Ø± Ø±Ù‚Ù… ØªØ³Ù„Ø³Ù„ÙŠ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù†ÙˆØ¹
        let lastNumber = 0;
        sameTypePTWs.forEach(ptw => {
            if (ptw.id && ptw.id.includes('_')) {
                const parts = ptw.id.split('_');
                if (parts.length > 1) {
                    const num = parseInt(parts[parts.length - 1]);
                    if (!isNaN(num) && num > lastNumber) {
                        lastNumber = num;
                    }
                }
            }
        });
        
        // Ø¥Ø±Ø¬Ø§Ø¹ Ø±Ù‚Ù… ØªØ³Ù„Ø³Ù„ÙŠ Ø¬Ø¯ÙŠØ¯
        return String(lastNumber + 1).padStart(4, '0');
    },
    
    async load() {
        const section = document.getElementById('ptw-section');
        if (!section) {
            console.error('âŒ Ù‚Ø³Ù… ptw-section ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!');
            return;
        }
        console.log('âœ… Ù…Ø¯ÙŠÙˆÙ„ PTW ÙŠÙƒØªØ¨ ÙÙŠ Ù‚Ø³Ù…: ptw-section');

        section.innerHTML = `
            <div class="section-header">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="section-title">
                            <i class="fas fa-file-alt ml-3" aria-hidden="true"></i>
                            Ø¥Ø¯Ø§Ø±Ø© ØªØµØ§Ø±ÙŠØ­ Ø§Ù„Ø¹Ù…Ù„
                        </h1>
                        <p class="section-subtitle">Ø¥ØµØ¯Ø§Ø± ÙˆÙ…ØªØ§Ø¨Ø¹Ø© ØªØµØ§Ø±ÙŠØ­ Ø§Ù„Ø¹Ù…Ù„ Ù…Ø¹ Ø¯Ø§Ø¦Ø±Ø© Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯Ø§Øª</p>
                    </div>
                    <button id="add-ptw-btn" class="btn-primary">
                        <i class="fas fa-plus ml-2"></i>
                        Ø¥ØµØ¯Ø§Ø± ØªØµØ±ÙŠØ­ Ø¬Ø¯ÙŠØ¯
                    </button>
                </div>
            </div>
            <div id="ptw-content" class="mt-6">
                ${await this.renderList()}
            </div>
        `;
        this.setupEventListeners();
        this.loadPTWList();
    },

    async renderList() {
        return `
            <div class="content-card">
                <div class="card-header">
                    <div class="flex items-center justify-between">
                        <h2 class="card-title"><i class="fas fa-list ml-2"></i>Ù‚Ø§Ø¦Ù…Ø© ØªØµØ§Ø±ÙŠØ­ Ø§Ù„Ø¹Ù…Ù„</h2>
                        <div class="flex items-center gap-4">
                            <input type="text" id="ptw-search" class="form-input" style="max-width: 300px;" placeholder="Ø§Ù„Ø¨Ø­Ø«...">
                            <select id="ptw-filter-status" class="form-input" style="max-width: 200px;">
                                <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
                                <option value="Ù…ÙØªÙˆØ­">Ù…ÙØªÙˆØ­</option>
                                <option value="Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</option>
                                <option value="Ù…ÙˆØ§ÙÙ‚ Ø¹Ù„ÙŠÙ‡">Ù…ÙˆØ§ÙÙ‚ Ø¹Ù„ÙŠÙ‡</option>
                                <option value="Ù…Ø±ÙÙˆØ¶">Ù…Ø±ÙÙˆØ¶</option>
                                <option value="Ù…ØºÙ„Ù‚">Ù…ØºÙ„Ù‚</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div id="ptw-table-container">
                        <div class="empty-state">
                            <i class="fas fa-spinner fa-spin text-4xl text-gray-300 mb-4"></i>
                            <p class="text-gray-500">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
                        </div>
                    </div>
                </div>
            </div>
        `;
    },

    async renderForm(ptwData = null) {
        const isEdit = !!ptwData;
        const approvals = ptwData?.approvals || [];
        
        return `
            <div class="content-card">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-${isEdit ? 'edit' : 'plus-circle'} ml-2"></i>
                        ${isEdit ? 'ØªØ¹Ø¯ÙŠÙ„ ØªØµØ±ÙŠØ­ Ø¹Ù…Ù„' : 'Ø¥ØµØ¯Ø§Ø± ØªØµØ±ÙŠØ­ Ø¹Ù…Ù„ Ø¬Ø¯ÙŠØ¯'}
                    </h2>
                </div>
                <div class="card-body">
                    <form id="ptw-form" class="space-y-6">
                        <div class="grid grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <i class="fas fa-briefcase ml-2"></i>
                                    Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ *
                                </label>
                                <select id="ptw-workType" name="workType" required class="form-input">
                                    <option value="">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„</option>
                                    <option value="Ø£Ø¹Ù…Ø§Ù„ Ø³Ø§Ø®Ù†Ø©" ${ptwData?.workType === 'Ø£Ø¹Ù…Ø§Ù„ Ø³Ø§Ø®Ù†Ø©' ? 'selected' : ''}>Ø£Ø¹Ù…Ø§Ù„ Ø³Ø§Ø®Ù†Ø©</option>
                                    <option value="Ø£Ø¹Ù…Ø§Ù„ Ø¨Ø§Ø±Ø¯Ø©" ${ptwData?.workType === 'Ø£Ø¹Ù…Ø§Ù„ Ø¨Ø§Ø±Ø¯Ø©' ? 'selected' : ''}>Ø£Ø¹Ù…Ø§Ù„ Ø¨Ø§Ø±Ø¯Ø©</option>
                                    <option value="Ø£Ø¹Ù…Ø§Ù„ ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©" ${ptwData?.workType === 'Ø£Ø¹Ù…Ø§Ù„ ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©' ? 'selected' : ''}>Ø£Ø¹Ù…Ø§Ù„ ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©</option>
                                    <option value="Ø£Ø¹Ù…Ø§Ù„ Ø­ÙØ±" ${ptwData?.workType === 'Ø£Ø¹Ù…Ø§Ù„ Ø­ÙØ±' ? 'selected' : ''}>Ø£Ø¹Ù…Ø§Ù„ Ø­ÙØ±</option>
                                    <option value="Ø£Ø¹Ù…Ø§Ù„ ÙÙŠ Ø§Ù„Ø£Ù…Ø§ÙƒÙ† Ø§Ù„Ù…ØºÙ„Ù‚Ø©" ${ptwData?.workType === 'Ø£Ø¹Ù…Ø§Ù„ ÙÙŠ Ø§Ù„Ø£Ù…Ø§ÙƒÙ† Ø§Ù„Ù…ØºÙ„Ù‚Ø©' ? 'selected' : ''}>Ø£Ø¹Ù…Ø§Ù„ ÙÙŠ Ø§Ù„Ø£Ù…Ø§ÙƒÙ† Ø§Ù„Ù…ØºÙ„Ù‚Ø©</option>
                                    <option value="Ø£Ø¹Ù…Ø§Ù„ Ø£Ø®Ø±Ù‰" ${ptwData?.workType === 'Ø£Ø¹Ù…Ø§Ù„ Ø£Ø®Ø±Ù‰' ? 'selected' : ''}>Ø£Ø¹Ù…Ø§Ù„ Ø£Ø®Ø±Ù‰</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <i class="fas fa-map-marker-alt ml-2"></i>
                                    Ø§Ù„Ù…ÙˆÙ‚Ø¹ *
                                </label>
                                <input type="text" id="ptw-location" name="location" required class="form-input"
                                    value="${ptwData?.location || ''}" placeholder="Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù…Ù„">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <i class="fas fa-calendar-alt ml-2"></i>
                                    ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡ *
                                </label>
                                <input type="datetime-local" id="ptw-startDate" name="startDate" required class="form-input"
                                    value="${ptwData?.startDate ? new Date(ptwData.startDate).toISOString().slice(0, 16) : ''}">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <i class="fas fa-calendar-check ml-2"></i>
                                    ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ *
                                </label>
                                <input type="datetime-local" id="ptw-endDate" name="endDate" required class="form-input"
                                    value="${ptwData?.endDate ? new Date(ptwData.endDate).toISOString().slice(0, 16) : ''}">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <i class="fas fa-user ml-2"></i>
                                    Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø¹Ù† Ø§Ù„Ø¹Ù…Ù„ *
                                </label>
                                <input type="text" id="ptw-responsible" name="responsible" required class="form-input"
                                    value="${ptwData?.responsible || ''}" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <i class="fas fa-building ml-2"></i>
                                    Ø§Ù„Ù‚Ø³Ù… / Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© *
                                </label>
                                <input type="text" id="ptw-department" name="department" required class="form-input"
                                    value="${ptwData?.department || ''}" placeholder="Ø§Ù„Ù‚Ø³Ù… / Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <i class="fas fa-info-circle ml-2"></i>
                                    Ø§Ù„Ø­Ø§Ù„Ø© *
                                </label>
                                <select id="ptw-status" name="status" required class="form-input">
                                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø­Ø§Ù„Ø©</option>
                                    <option value="Ù…ÙØªÙˆØ­" ${ptwData?.status === 'Ù…ÙØªÙˆØ­' ? 'selected' : ''}>Ù…ÙØªÙˆØ­</option>
                                    <option value="Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©" ${ptwData?.status === 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©' ? 'selected' : ''}>Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</option>
                                    <option value="Ù…ÙˆØ§ÙÙ‚ Ø¹Ù„ÙŠÙ‡" ${ptwData?.status === 'Ù…ÙˆØ§ÙÙ‚ Ø¹Ù„ÙŠÙ‡' ? 'selected' : ''}>Ù…ÙˆØ§ÙÙ‚ Ø¹Ù„ÙŠÙ‡</option>
                                    <option value="Ù…Ø±ÙÙˆØ¶" ${ptwData?.status === 'Ù…Ø±ÙÙˆØ¶' ? 'selected' : ''}>Ù…Ø±ÙÙˆØ¶</option>
                                    <option value="Ù…ØºÙ„Ù‚" ${ptwData?.status === 'Ù…ØºÙ„Ù‚' ? 'selected' : ''}>Ù…ØºÙ„Ù‚</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                <i class="fas fa-align-right ml-2"></i>
                                ÙˆØµÙ Ø§Ù„Ø¹Ù…Ù„ *
                            </label>
                            <textarea id="ptw-workDescription" name="workDescription" required class="form-input" rows="4"
                                placeholder="ÙˆØµÙ ØªÙØµÙŠÙ„ÙŠ Ù„Ù„Ø¹Ù…Ù„">${ptwData?.workDescription || ''}</textarea>
                        </div>
                        
                        <!-- Ù…ØµÙÙˆÙØ© Ù…Ù‡Ù…Ø§Øª Ø§Ù„ÙˆÙ‚Ø§ÙŠØ© Ø§Ù„Ø´Ø®ØµÙŠØ© -->
                        <div class="border-t pt-6 mt-6">
                            <h3 class="text-lg font-bold text-gray-800 mb-4">
                                <i class="fas fa-hard-hat ml-2"></i>
                                Ù…ØµÙÙˆÙØ© Ù…Ù‡Ù…Ø§Øª Ø§Ù„ÙˆÙ‚Ø§ÙŠØ© Ø§Ù„Ø´Ø®ØµÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
                            </h3>
                            <div id="ptw-ppe-matrix">
                                ${typeof PPEMatrix !== 'undefined' ? PPEMatrix.generate('ptw-ppe-matrix') : ''}
                            </div>
                            ${ptwData?.requiredPPE && ptwData.requiredPPE.length > 0 ? `
                                <script>
                                    setTimeout(() => {
                                        if (typeof PPEMatrix !== 'undefined') {
                                            PPEMatrix.setSelected(${JSON.stringify(ptwData.requiredPPE)});
                                        }
                                    }, 100);
                                </script>
                            ` : ''}
                        </div>
                        
                        <!-- Ù…ØµÙÙˆÙØ© ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…Ø®Ø§Ø·Ø± -->
                        <div class="border-t pt-6 mt-6">
                            <h3 class="text-lg font-bold text-gray-800 mb-4">
                                <i class="fas fa-exclamation-triangle ml-2"></i>
                                Ù…ØµÙÙˆÙØ© ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…Ø®Ø§Ø·Ø±
                            </h3>
                            <div id="ptw-risk-matrix">
                                ${typeof RiskMatrix !== 'undefined' ? RiskMatrix.generate('ptw-risk-matrix') : ''}
                            </div>
                            <div class="mt-4">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ù…Ù„Ø§Ø­Ø¸Ø§Øª ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…Ø®Ø§Ø·Ø±</label>
                                <textarea id="ptw-risk-notes" class="form-input" rows="3"
                                    placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ø­ÙˆÙ„ Ø§Ù„Ù…Ø®Ø§Ø·Ø± Ø§Ù„Ù…Ø­ØªÙ…Ù„Ø©">${ptwData?.riskNotes || ''}</textarea>
                            </div>
                        </div>
                        
                        <!-- Ø¯Ø§Ø¦Ø±Ø© Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯Ø§Øª -->
                        <div class="border-t pt-6 mt-6">
                            <h3 class="text-lg font-bold text-gray-800 mb-4">
                                <i class="fas fa-check-circle ml-2"></i>
                                Ø¯Ø§Ø¦Ø±Ø© Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯Ø§Øª
                            </h3>
                            <div id="approval-matrix" class="space-y-4">
                                ${this.renderApprovalMatrix(approvals, isEdit)}
                            </div>
                            ${!isEdit ? '<button type="button" id="add-approval-btn" class="btn-secondary mt-4"><i class="fas fa-plus ml-2"></i>Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ§ÙÙ‚</button>' : ''}
                        </div>
                        
                        <div class="flex items-center justify-end gap-4 pt-4 border-t">
                            <button type="button" id="cancel-ptw-btn" class="btn-secondary">Ø¥Ù„ØºØ§Ø¡</button>
                            <button type="submit" class="btn-primary">
                                <i class="fas fa-save ml-2"></i>
                                ${isEdit ? 'Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª' : 'Ø¥ØµØ¯Ø§Ø± Ø§Ù„ØªØµØ±ÙŠØ­'}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        `;
    },

    renderApprovalMatrix(approvals = [], isEdit = false) {
        if (approvals.length === 0 && !isEdit) {
            // Ø§Ù„Ø±Ø¤ÙˆØ³ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ù„Ø§Ø¹ØªÙ…Ø§Ø¯Ø§Øª
            const defaultApprovals = [
                { role: 'Ù…Ø¯ÙŠØ± Ø§Ù„Ø³Ù„Ø§Ù…Ø©', required: true, approved: false, approver: '', date: '', comments: '' },
                { role: 'Ø§Ù„Ù…Ø´Ø±Ù Ø§Ù„Ù…Ø¨Ø§Ø´Ø±', required: true, approved: false, approver: '', date: '', comments: '' },
                { role: 'Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ù†Ø·Ù‚Ø©', required: false, approved: false, approver: '', date: '', comments: '' }
            ];
            approvals = defaultApprovals;
        }

        return `
            <div class="table-wrapper" style="overflow-x: auto;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Ø§Ù„Ù…ÙˆØ§ÙÙ‚</th>
                            <th>Ø§Ù„Ø§Ø³Ù…</th>
                            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                            <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
                            <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody id="approvals-tbody">
                        ${approvals.map((approval, index) => `
                            <tr data-approval-index="${index}">
                                <td>
                                    <input type="text" class="form-input" style="min-width: 150px;"
                                        value="${approval.role || ''}" placeholder="Ø¯ÙˆØ± Ø§Ù„Ù…ÙˆØ§ÙÙ‚"
                                        id="approval-role-${index}" ${isEdit ? '' : 'required'}>
                                </td>
                                <td>
                                    <input type="text" class="form-input" style="min-width: 150px;"
                                        value="${approval.approver || ''}" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ§ÙÙ‚"
                                        id="approval-approver-${index}">
                                </td>
                                <td>
                                    <select class="form-input" id="approval-status-${index}">
                                        <option value="pending" ${approval.approved === false ? 'selected' : ''}>Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</option>
                                        <option value="approved" ${approval.approved === true ? 'selected' : ''}>Ù…ÙˆØ§ÙÙ‚</option>
                                        <option value="rejected" ${approval.approved === false && approval.status === 'rejected' ? 'selected' : ''}>Ù…Ø±ÙÙˆØ¶</option>
                                    </select>
                                </td>
                                <td>
                                    <input type="datetime-local" class="form-input" style="min-width: 180px;"
                                        value="${approval.date ? new Date(approval.date).toISOString().slice(0, 16) : ''}"
                                        id="approval-date-${index}">
                                </td>
                                <td>
                                    <input type="text" class="form-input" style="min-width: 200px;"
                                        value="${approval.comments || ''}" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª"
                                        id="approval-comments-${index}">
                                </td>
                                <td>
                                    ${!isEdit ? `<button type="button" onclick="PTW.removeApproval(${index})" class="btn-icon btn-icon-danger" title="Ø­Ø°Ù">
                                        <i class="fas fa-trash"></i>
                                    </button>` : ''}
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
    },

    async loadPTWList() {
        const container = document.getElementById('ptw-table-container');
        if (!container) return;
        const items = AppState.appData.ptw || [];
        
        if (items.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-file-alt text-4xl text-gray-300 mb-4"></i>
                    <p class="text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØµØ§Ø±ÙŠØ­ Ø¹Ù…Ù„</p>
                    <button id="add-ptw-empty-btn" class="btn-primary mt-4">
                        <i class="fas fa-plus ml-2"></i>
                        Ø¥ØµØ¯Ø§Ø± ØªØµØ±ÙŠØ­ Ø¬Ø¯ÙŠØ¯
                    </button>
                </div>
            `;
            return;
        }

        container.innerHTML = `
            <div class="table-wrapper" style="overflow-x: auto;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„</th>
                            <th>Ø§Ù„Ù…ÙˆÙ‚Ø¹</th>
                            <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡</th>
                            <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</th>
                            <th>Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</th>
                            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                            <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${items.map(item => {
                            const approvals = item.approvals || [];
                            const approvedCount = approvals.filter(a => a.approved).length;
                            const totalCount = approvals.length || 0;
                            
                            return `
                            <tr>
                                <td>${item.id?.substring(0, 8) || '-'}</td>
                                <td>${Utils.escapeHTML(item.workType || '')}</td>
                                <td>${Utils.escapeHTML(item.location || '')}</td>
                                <td>${item.startDate ? Utils.formatDate(item.startDate) : '-'}</td>
                                <td>${item.endDate ? Utils.formatDate(item.endDate) : '-'}</td>
                                <td>${Utils.escapeHTML(item.responsible || '')}</td>
                                <td>
                                    ${totalCount > 0 ? `
                                        <span class="badge badge-${approvedCount === totalCount ? 'success' : 'warning'}">
                                            ${approvedCount}/${totalCount}
                                        </span>
                                    ` : '<span class="text-gray-400">-</span>'}
                                </td>
                                <td>
                                    <span class="badge badge-${this.getStatusBadgeClass(item.status)}">
                                        ${item.status || '-'}
                                    </span>
                                </td>
                                <td>
                                    <div class="flex items-center gap-2">
                                        <button onclick="PTW.viewPTW('${item.id}')" class="btn-icon btn-icon-info" title="Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button onclick="PTW.exportPDF('${item.id}')" class="btn-icon btn-icon-success" title="ØªØµØ¯ÙŠØ± PDF">
                                            <i class="fas fa-file-pdf"></i>
                                        </button>
                                        <button onclick="PTW.editPTW('${item.id}')" class="btn-icon btn-icon-primary" title="ØªØ¹Ø¯ÙŠÙ„">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button onclick="PTW.deletePTW('${item.id}')" class="btn-icon btn-icon-danger" title="Ø­Ø°Ù">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
        `;
    },

    getStatusBadgeClass(status) {
        const classes = {
            'Ù…ÙØªÙˆØ­': 'warning',
            'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©': 'info',
            'Ù…ÙˆØ§ÙÙ‚ Ø¹Ù„ÙŠÙ‡': 'success',
            'Ù…Ø±ÙÙˆØ¶': 'danger',
            'Ù…ØºÙ„Ù‚': 'secondary'
        };
        return classes[status] || 'secondary';
    },

    setupEventListeners() {
        setTimeout(() => {
            const addBtn = document.getElementById('add-ptw-btn');
            const addEmptyBtn = document.getElementById('add-ptw-empty-btn');
            if (addBtn) addBtn.addEventListener('click', () => this.showForm());
            if (addEmptyBtn) addEmptyBtn.addEventListener('click', () => this.showForm());

            const searchInput = document.getElementById('ptw-search');
            const filterStatus = document.getElementById('ptw-filter-status');
            if (searchInput) searchInput.addEventListener('input', (e) => this.filterItems(e.target.value, filterStatus?.value));
            if (filterStatus) filterStatus.addEventListener('change', (e) => this.filterItems(searchInput?.value, e.target.value));

            const form = document.getElementById('ptw-form');
            if (form) form.addEventListener('submit', (e) => this.handleSubmit(e));
            const cancelBtn = document.getElementById('cancel-ptw-btn');
            if (cancelBtn) cancelBtn.addEventListener('click', () => this.showList());
            
            const addApprovalBtn = document.getElementById('add-approval-btn');
            if (addApprovalBtn) {
                addApprovalBtn.addEventListener('click', () => this.addApproval());
            }
        }, 100);
    },

    currentEditId: null,

    async showForm(data = null) {
        this.currentEditId = data?.id || null;
        const content = document.getElementById('ptw-content');
        if (content) {
            content.innerHTML = await this.renderForm(data);
            this.setupEventListeners();
        }
    },

    async showList() {
        this.currentEditId = null;
        const content = document.getElementById('ptw-content');
        if (content) {
            content.innerHTML = await this.renderList();
            this.setupEventListeners();
            this.loadPTWList();
        }
    },

    async handleSubmit(e) {
        e.preventDefault();
        
        // Ø¬Ù…Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø§Øª
        const approvals = [];
        const approvalRows = document.querySelectorAll('#approvals-tbody tr');
        approvalRows.forEach((row, index) => {
            const role = document.getElementById(`approval-role-${index}`)?.value.trim();
            const approver = document.getElementById(`approval-approver-${index}`)?.value.trim();
            const statusSelect = document.getElementById(`approval-status-${index}`);
            const status = statusSelect?.value || 'pending';
            const date = document.getElementById(`approval-date-${index}`)?.value;
            const comments = document.getElementById(`approval-comments-${index}`)?.value.trim() || '';
            
            if (role) {
                approvals.push({
                    role,
                    approver,
                    approved: status === 'approved',
                    rejected: status === 'rejected',
                    status,
                    date: date ? new Date(date).toISOString() : '',
                    comments,
                    order: index
                });
            }
        });

        // ØªÙˆÙ„ÙŠØ¯ Ø±Ù‚Ù… ØªØ³Ù„Ø³Ù„ÙŠ Ù…Ø®ØªÙ„Ù Ù„ÙƒÙ„ Ù†ÙˆØ¹ Ø¹Ù…Ù„
        const workType = document.getElementById('ptw-workType').value;
        const workTypePrefix = this.getWorkTypePrefix(workType);
        const sequentialId = this.generateSequentialPTWId(workType);

        const formData = {
            id: this.currentEditId || `${workTypePrefix}_${sequentialId}`,
            workType: workType,
            workDescription: document.getElementById('ptw-workDescription').value.trim(),
            location: document.getElementById('ptw-location').value.trim(),
            department: document.getElementById('ptw-department')?.value.trim() || '',
            startDate: new Date(document.getElementById('ptw-startDate').value).toISOString(),
            endDate: new Date(document.getElementById('ptw-endDate').value).toISOString(),
            responsible: document.getElementById('ptw-responsible').value.trim(),
            status: document.getElementById('ptw-status').value,
            approvals: approvals,
            requiredPPE: typeof PPEMatrix !== 'undefined' ? PPEMatrix.getSelected() : [],
            riskAssessment: typeof RiskMatrix !== 'undefined' ? {
                likelihood: document.querySelector('#ptw-risk-matrix td.ring-2')?.getAttribute('data-likelihood') || '',
                consequence: document.querySelector('#ptw-risk-matrix td.ring-2')?.getAttribute('data-consequence') || '',
                riskLevel: document.querySelector('#ptw-risk-matrix td.ring-2')?.textContent.trim() || ''
            } : {},
            riskNotes: document.getElementById('ptw-risk-notes')?.value.trim() || '',
            createdAt: this.currentEditId 
                ? AppState.appData.ptw.find(p => p.id === this.currentEditId)?.createdAt 
                : new Date().toISOString(),
            updatedAt: new Date().toISOString()
        };

        if (!formData.workType || !formData.workDescription || !formData.location || !formData.status) {
            Notification.error('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©');
            return;
        }

        Loading.show();
        try {
            if (this.currentEditId) {
                const index = AppState.appData.ptw.findIndex(p => p.id === this.currentEditId);
                if (index !== -1) {
                    AppState.appData.ptw[index] = formData;
                }
                Notification.success('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØµØ±ÙŠØ­ Ø¨Ù†Ø¬Ø§Ø­');
            } else {
                AppState.appData.ptw.push(formData);
                Notification.success('ØªÙ… Ø¥ØµØ¯Ø§Ø± Ø§Ù„ØªØµØ±ÙŠØ­ Ø¨Ù†Ø¬Ø§Ø­');
            }
            
            DataManager.save();
            // Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙÙŠ Google Sheets
            await GoogleIntegration.autoSave('PTW', AppState.appData.ptw);
            Loading.hide();
            this.showList();
        } catch (error) {
            Loading.hide();
            Notification.error('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
        }
    },

    addApproval() {
        const tbody = document.getElementById('approvals-tbody');
        if (!tbody) return;
        
        const index = tbody.children.length;
        const newRow = document.createElement('tr');
        newRow.setAttribute('data-approval-index', index);
        newRow.innerHTML = `
            <td>
                <input type="text" class="form-input" style="min-width: 150px;"
                    placeholder="Ø¯ÙˆØ± Ø§Ù„Ù…ÙˆØ§ÙÙ‚" id="approval-role-${index}" required>
            </td>
            <td>
                <input type="text" class="form-input" style="min-width: 150px;"
                    placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ§ÙÙ‚" id="approval-approver-${index}">
            </td>
            <td>
                <select class="form-input" id="approval-status-${index}">
                    <option value="pending">Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</option>
                    <option value="approved">Ù…ÙˆØ§ÙÙ‚</option>
                    <option value="rejected">Ù…Ø±ÙÙˆØ¶</option>
                </select>
            </td>
            <td>
                <input type="datetime-local" class="form-input" style="min-width: 180px;"
                    id="approval-date-${index}">
            </td>
            <td>
                <input type="text" class="form-input" style="min-width: 200px;"
                    placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª" id="approval-comments-${index}">
            </td>
            <td>
                <button type="button" onclick="PTW.removeApproval(${index})" class="btn-icon btn-icon-danger" title="Ø­Ø°Ù">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
        tbody.appendChild(newRow);
    },

    removeApproval(index) {
        const tbody = document.getElementById('approvals-tbody');
        if (!tbody) return;
        const row = tbody.querySelector(`tr[data-approval-index="${index}"]`);
        if (row) {
            row.remove();
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ±Ù‚ÙŠÙ… Ø§Ù„ØµÙÙˆÙ
            Array.from(tbody.children).forEach((row, idx) => {
                row.setAttribute('data-approval-index', idx);
            });
        }
    },

    async editPTW(id) {
        const item = AppState.appData.ptw.find(i => i.id === id);
        if (item) await this.showForm(item);
    },

    async viewPTW(id) {
        const item = AppState.appData.ptw.find(i => i.id === id);
        if (!item) return;

        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        const approvals = item.approvals || [];
        
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 900px;">
                <div class="modal-header">
                    <h2 class="modal-title">ØªÙØ§ØµÙŠÙ„ ØªØµØ±ÙŠØ­ Ø§Ù„Ø¹Ù…Ù„</h2>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm font-semibold text-gray-600">Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„:</label>
                                <p class="text-gray-800">${Utils.escapeHTML(item.workType || '')}</p>
                            </div>
                            <div>
                                <label class="text-sm font-semibold text-gray-600">Ø§Ù„Ù…ÙˆÙ‚Ø¹:</label>
                                <p class="text-gray-800">${Utils.escapeHTML(item.location || '')}</p>
                            </div>
                            <div>
                                <label class="text-sm font-semibold text-gray-600">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡:</label>
                                <p class="text-gray-800">${item.startDate ? Utils.formatDate(item.startDate) : '-'}</p>
                            </div>
                            <div>
                                <label class="text-sm font-semibold text-gray-600">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡:</label>
                                <p class="text-gray-800">${item.endDate ? Utils.formatDate(item.endDate) : '-'}</p>
                            </div>
                            <div>
                                <label class="text-sm font-semibold text-gray-600">Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„:</label>
                                <p class="text-gray-800">${Utils.escapeHTML(item.responsible || '')}</p>
                            </div>
                            <div>
                                <label class="text-sm font-semibold text-gray-600">Ø§Ù„Ø­Ø§Ù„Ø©:</label>
                                <span class="badge badge-${this.getStatusBadgeClass(item.status)}">
                                    ${item.status || '-'}
                                </span>
                            </div>
                        </div>
                        <div>
                            <label class="text-sm font-semibold text-gray-600">ÙˆØµÙ Ø§Ù„Ø¹Ù…Ù„:</label>
                            <p class="text-gray-800">${Utils.escapeHTML(item.workDescription || '')}</p>
                        </div>
                        ${approvals.length > 0 ? `
                        <div class="border-t pt-4 mt-4">
                            <h3 class="text-lg font-bold text-gray-800 mb-4">Ø¯Ø§Ø¦Ø±Ø© Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯Ø§Øª</h3>
                            <div class="table-wrapper">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Ø§Ù„Ù…ÙˆØ§ÙÙ‚</th>
                                            <th>Ø§Ù„Ø§Ø³Ù…</th>
                                            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                            <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${approvals.map(approval => `
                                            <tr>
                                                <td>${Utils.escapeHTML(approval.role || '')}</td>
                                                <td>${Utils.escapeHTML(approval.approver || '')}</td>
                                                <td>
                                                    <span class="badge badge-${approval.approved ? 'success' : approval.rejected ? 'danger' : 'warning'}">
                                                        ${approval.approved ? 'Ù…ÙˆØ§ÙÙ‚' : approval.rejected ? 'Ù…Ø±ÙÙˆØ¶' : 'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±'}
                                                    </span>
                                                </td>
                                                <td>${approval.date ? Utils.formatDate(approval.date) : '-'}</td>
                                                <td>${Utils.escapeHTML(approval.comments || '')}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        ` : ''}
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" onclick="this.closest('.modal-overlay').remove()">Ø¥ØºÙ„Ø§Ù‚</button>
                    <button class="btn-primary" onclick="PTW.exportPDF('${item.id}'); this.closest('.modal-overlay').remove();">
                        <i class="fas fa-file-pdf ml-2"></i>
                        ØªØµØ¯ÙŠØ±/Ø·Ø¨Ø§Ø¹Ø© PDF
                    </button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
        });
    },

    async deletePTW(id) {
        if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ØªØµØ±ÙŠØ­ØŸ')) return;
        Loading.show();
        try {
            AppState.appData.ptw = AppState.appData.ptw.filter(i => i.id !== id);
            DataManager.save();
            // Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙÙŠ Google Sheets
            await GoogleIntegration.autoSave('PTW', AppState.appData.ptw);
            Loading.hide();
            Notification.success('ØªÙ… Ø­Ø°Ù Ø§Ù„ØªØµØ±ÙŠØ­ Ø¨Ù†Ø¬Ø§Ø­');
            this.loadPTWList();
        } catch (error) {
            Loading.hide();
            Notification.error('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
        }
    },

    async exportPDF(id) {
        const item = AppState.appData.ptw.find(i => i.id === id);
        if (!item) {
            Notification.error('Ø§Ù„ØªØµØ±ÙŠØ­ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
            return;
        }

        try {
            Loading.show();
            
            // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø´Ø¹Ø§Ø± Ø§Ù„Ø´Ø±ÙƒØ© ÙˆØ§Ù„ÙƒÙˆØ¯
            const companyLogo = (typeof AppState !== 'undefined' && AppState.companyLogo) ? AppState.companyLogo : '';
            const qrCodeData = `${window.location.origin}/ptw/${item.id}`;
            const qrCode = typeof QRCode !== 'undefined' ? QRCode.generate(qrCodeData, 120) : null;
            const formCode = item.isoCode || item.id?.substring(0, 12) || 'PTW-UNKNOWN';

            // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø·Ø±ÙŠÙ‚Ø© HTML to Print Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù†Øµ Ø§Ù„Ø¹Ø±Ø¨ÙŠ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­
            const htmlContent = `
                <!DOCTYPE html>
                <html dir="rtl" lang="ar">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
                    <style>
                        @media print {
                            @page { margin: 1cm; size: A4; }
                            body { margin: 0; padding: 20px; }
                        }
                        body { 
                            font-family: 'Cairo', Arial, sans-serif; 
                            padding: 20px; 
                            direction: rtl; 
                            margin: 0;
                            background: white;
                        }
                        .header { 
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            border-bottom: 3px solid #2563eb; 
                            padding-bottom: 15px; 
                            margin-bottom: 30px;
                        }
                        .header-left {
                            flex: 1;
                            text-align: right;
                        }
                        .header-right {
                            flex: 1;
                            text-align: left;
                        }
                        .header-center {
                            flex: 1;
                            text-align: center;
                        }
                        .logo {
                            max-height: 60px;
                            max-width: 150px;
                        }
                        h1 { 
                            margin: 0; 
                            color: #2563eb; 
                            font-size: 28px;
                        }
                        .subtitle {
                            color: #666;
                            font-size: 16px;
                            margin-top: 5px;
                        }
                        .form-code {
                            font-size: 12px;
                            color: #666;
                            margin-top: 5px;
                        }
                        .qr-code {
                            width: 120px;
                            height: 120px;
                            border: 1px solid #ddd;
                            padding: 5px;
                        }
                        table { 
                            width: 100%; 
                            border-collapse: collapse; 
                            margin: 20px 0; 
                            font-size: 14px;
                        }
                        th, td { 
                            border: 1px solid #ddd; 
                            padding: 12px; 
                            text-align: right; 
                        }
                        th { 
                            background-color: #2563eb; 
                            color: white; 
                            font-weight: 600;
                        }
                        tr:nth-child(even) {
                            background-color: #f9fafb;
                        }
                        .section-title {
                            font-size: 18px;
                            font-weight: 600;
                            margin: 25px 0 15px 0;
                            color: #1f2937;
                            border-right: 4px solid #2563eb;
                            padding-right: 10px;
                        }
                        .description {
                            background: #f3f4f6;
                            padding: 15px;
                            border-radius: 8px;
                            line-height: 1.8;
                            margin: 15px 0;
                        }
                        .footer {
                            margin-top: 40px;
                            padding-top: 20px;
                            border-top: 2px solid #2563eb;
                            font-size: 11px;
                            color: #666;
                            text-align: center;
                            position: relative;
                            display: flex;
                            flex-direction: column;
                            align-items: center;
                            gap: 10px;
                        }
                        .footer-qr {
                            display: inline-block;
                            margin: 10px auto;
                            text-align: center;
                            order: -1;
                            width: 100%;
                        }
                        .footer-qr img {
                            width: 80px;
                            height: 80px;
                            border: 1px solid #ddd;
                            padding: 4px;
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <div class="header-right" style="flex: 0 0 auto; min-width: 250px; text-align: right; display: flex; align-items: flex-start; justify-content: flex-end; flex-direction: column;">
                            <div style="line-height: 1.6;">
                                ${companyLogo ? `<img src="${companyLogo}" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ø´Ø±ÙƒØ©" class="logo" style="max-height: 60px; max-width: 150px; object-fit: contain; margin-bottom: 10px;">` : ''}
                                <div class="subtitle" style="font-weight: 700; color: #1f2937;">Ø§Ù„Ø´Ø±ÙƒØ© Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ© Ù„Ù„Ø§Ù†ØªØ§Ø¬ ÙˆØ§Ù„ØªØµÙ†ÙŠØ¹ Ø§Ù„Ø²Ø±Ø§Ø¹ÙŠ</div>
                                <div class="subtitle" style="font-size: 14px; color: #2563eb; font-weight: 600; margin-top: 8px;">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³Ù„Ø§Ù…Ø© ÙˆØ§Ù„ØµØ­Ø© Ø§Ù„Ù…Ù‡Ù†ÙŠØ© ÙˆØ§Ù„Ø¨ÙŠØ¦Ø©</div>
                                <div class="form-code" style="margin-top: 8px; font-weight: 600;">ÙƒÙˆØ¯ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬: <strong style="color: #2563eb;">${formCode}</strong></div>
                            </div>
                        </div>
                        <div class="header-center" style="flex: 1; text-align: center; padding: 0 20px;">
                            <h1 style="margin: 0; color: #2563eb; font-size: 28px; font-weight: 700;">ØªØµØ±ÙŠØ­ Ø¹Ù…Ù„</h1>
                            <div class="subtitle" style="margin-top: 5px;">Permit to Work</div>
                        </div>
                        <div class="header-left" style="flex: 0 0 auto; min-width: 150px;">
                            <!-- ØªÙ… Ø¥Ø²Ø§Ù„Ø© QR code Ù…Ù† Ø§Ù„Ø±Ø£Ø³ -->
                        </div>
                    </div>
                    
                    <table>
                        <tr><th>Ø±Ù‚Ù… Ø§Ù„ØªØµØ±ÙŠØ­</th><td>${Utils.escapeHTML(item.id?.substring(0, 12) || 'N/A')}</td></tr>
                        <tr><th>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„</th><td>${Utils.escapeHTML(item.workType || 'N/A')}</td></tr>
                        <tr><th>Ø§Ù„Ù…ÙˆÙ‚Ø¹</th><td>${Utils.escapeHTML(item.location || 'N/A')}</td></tr>
                        <tr><th>Ø§Ù„Ù‚Ø³Ù…</th><td>${Utils.escapeHTML(item.department || 'N/A')}</td></tr>
                        <tr><th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡</th><td>${item.startDate ? Utils.formatDate(item.startDate) : 'N/A'}</td></tr>
                        <tr><th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</th><td>${item.endDate ? Utils.formatDate(item.endDate) : 'N/A'}</td></tr>
                        <tr><th>Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</th><td>${Utils.escapeHTML(item.responsible || 'N/A')}</td></tr>
                        <tr><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><td>${Utils.escapeHTML(item.status || 'N/A')}</td></tr>
                    </table>
                    
                    <div class="section-title">ÙˆØµÙ Ø§Ù„Ø¹Ù…Ù„:</div>
                    <div class="description">${Utils.escapeHTML(item.workDescription || 'N/A')}</div>
                    
                    ${item.approvals && item.approvals.length > 0 ? `
                        <div class="section-title">Ø¯Ø§Ø¦Ø±Ø© Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯Ø§Øª:</div>
                        <table>
                            <tr>
                                <th>Ø§Ù„Ù…ÙˆØ§ÙÙ‚</th>
                                <th>Ø§Ù„Ø§Ø³Ù…</th>
                                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                            </tr>
                            ${item.approvals.map(a => `
                                <tr>
                                    <td>${Utils.escapeHTML(a.role || '')}</td>
                                    <td>${Utils.escapeHTML(a.approver || '')}</td>
                                    <td>${a.approved ? 'âœ“ Ù…ÙˆØ§ÙÙ‚' : a.rejected ? 'âœ— Ù…Ø±ÙÙˆØ¶' : 'â³ Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±'}</td>
                                    <td>${a.date ? Utils.formatDate(a.date) : ''}</td>
                                </tr>
                            `).join('')}
                        </table>
                    ` : ''}
                    
                    ${item.requiredPPE && item.requiredPPE.length > 0 ? `
                        <div class="section-title">Ù…Ù‡Ù…Ø§Øª Ø§Ù„ÙˆÙ‚Ø§ÙŠØ© Ø§Ù„Ø´Ø®ØµÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:</div>
                        <table>
                            <tr>
                                <th>Ù†ÙˆØ¹ Ù…Ù‡Ù…Ø§Øª Ø§Ù„ÙˆÙ‚Ø§ÙŠØ©</th>
                                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                            </tr>
                            ${item.requiredPPE.map(ppe => `
                                <tr>
                                    <td>${Utils.escapeHTML(ppe)}</td>
                                    <td>âœ“ Ù…Ø·Ù„ÙˆØ¨</td>
                                </tr>
                            `).join('')}
                        </table>
                    ` : ''}
                    
                    ${item.riskAssessment || item.riskLevel || item.riskNotes ? `
                        <div class="section-title">ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…Ø®Ø§Ø·Ø±:</div>
                        <table>
                            ${item.riskLevel ? `<tr><th>Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…Ø®Ø§Ø·Ø±</th><td>${Utils.escapeHTML(item.riskLevel)}</td></tr>` : ''}
                            ${item.riskAssessment ? `<tr><th>ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…Ø®Ø§Ø·Ø±</th><td>${Utils.escapeHTML(item.riskAssessment)}</td></tr>` : ''}
                            ${item.riskNotes ? `<tr><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th><td>${Utils.escapeHTML(item.riskNotes)}</td></tr>` : ''}
                        </table>
                    ` : ''}
                    
                    <div class="footer">
                        ${qrCode ? `
                            <div class="footer-qr">
                                <img src="${qrCode}" alt="QR Code" style="width: 80px; height: 80px; border: 1px solid #ddd; padding: 4px;">
                                <p style="font-size: 9px; margin-top: 4px;">QR Code</p>
                            </div>
                        ` : ''}
                        <div class="footer-info">
                            <p><strong>Ø§Ù„Ø´Ø±ÙƒØ© Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ© Ù„Ù„Ø§Ù†ØªØ§Ø¬ ÙˆØ§Ù„ØªØµÙ†ÙŠØ¹ Ø§Ù„Ø²Ø±Ø§Ø¹ÙŠ</strong></p>
                            <p style="font-size: 12px; color: #2563eb; font-weight: 600; margin-top: 5px;">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³Ù„Ø§Ù…Ø© ÙˆØ§Ù„ØµØ­Ø© Ø§Ù„Ù…Ù‡Ù†ÙŠØ© ÙˆØ§Ù„Ø¨ÙŠØ¦Ø©</p>
                            <p>ØªÙ… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: ${item.createdAt ? Utils.formatDate(item.createdAt) : ''} | Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: ${item.updatedAt ? Utils.formatDate(item.updatedAt) : ''}</p>
                            <p style="margin-top: 10px; font-size: 10px; color: #999;">ØªÙ… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù† Ø®Ù„Ø§Ù„ Ù†Ø¸Ø§Ù… Ø§Ù„Ø³Ù„Ø§Ù…Ø© Ø§Ù„Ù…Ù‡Ù†ÙŠØ© - HSE Management System</p>
                        </div>
                    </div>
                </body>
                </html>
            `;
            
            // Ø¥Ù†Ø´Ø§Ø¡ blob Ù…Ù† HTML
            const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            
            // ÙØªØ­ ÙÙŠ Ù†Ø§ÙØ°Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©/Ø§Ù„Ø­ÙØ¸ ÙƒÙ€ PDF
            const printWindow = window.open(url, '_blank');
            if (printWindow) {
                printWindow.onload = () => {
                    setTimeout(() => {
                        printWindow.print();
                        setTimeout(() => {
                            URL.revokeObjectURL(url);
                            Loading.hide();
                            Notification.success('ØªÙ… ÙØªØ­ Ø§Ù„ØªØµØ±ÙŠØ­ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©/Ø§Ù„Ø­ÙØ¸ ÙƒÙ€ PDF');
                        }, 1000);
                    }, 500);
                };
            } else {
                Loading.hide();
                Notification.error('ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ù„Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªØµØ±ÙŠØ­');
            }
        } catch (error) {
            Loading.hide();
            console.error('Ø®Ø·Ø£ ÙÙŠ ØªØµØ¯ÙŠØ± PDF:', error);
            Notification.error('ÙØ´Ù„ ØªØµØ¯ÙŠØ± PDF: ' + error.message);
        }
    },

    filterItems(searchTerm = '', statusFilter = '') {
        const items = AppState.appData.ptw || [];
        let filtered = items;
        if (searchTerm) {
            const term = searchTerm.toLowerCase();
            filtered = filtered.filter(item => 
                item.workType?.toLowerCase().includes(term) ||
                item.workDescription?.toLowerCase().includes(term) ||
                item.location?.toLowerCase().includes(term)
            );
        }
        if (statusFilter) {
            filtered = filtered.filter(item => item.status === statusFilter);
        }
        const tbody = document.querySelector('#ptw-table-container tbody');
        if (tbody) {
            tbody.innerHTML = filtered.length === 0 ? 
                '<tr><td colspan="7" class="text-center text-gray-500 py-8">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</td></tr>' :
                filtered.map(item => `
                    <tr>
                        <td>${Utils.escapeHTML(item.workType || '')}</td>
                        <td>${Utils.escapeHTML(item.location || '')}</td>
                        <td>${item.startDate ? Utils.formatDate(item.startDate) : '-'}</td>
                        <td>${item.endDate ? Utils.formatDate(item.endDate) : '-'}</td>
                        <td>${Utils.escapeHTML(item.responsible || '')}</td>
                        <td>
                            <span class="badge badge-${this.getStatusBadgeClass(item.status)}">
                                ${item.status || '-'}
                            </span>
                        </td>
                        <td>
                            <div class="flex items-center gap-2">
                                <button onclick="PTW.editPTW('${item.id}')" class="btn-icon btn-icon-primary">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="PTW.deletePTW('${item.id}')" class="btn-icon btn-icon-danger">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('');
        }
    }
};

// ===== Training Module =====
const Training = {
    currentEditId: null,
    
    async load() {
        const section = document.getElementById('training-section');
        if (!section) {
            console.error('âŒ Ù‚Ø³Ù… training-section ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!');
            return;
        }
        console.log('âœ… Ù…Ø¯ÙŠÙˆÙ„ Training ÙŠÙƒØªØ¨ ÙÙŠ Ù‚Ø³Ù…: training-section');

        section.innerHTML = `
            <div class="section-header">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="section-title">
                            <i class="fas fa-graduation-cap ml-3"></i>
                            Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¯Ø±ÙŠØ¨Ø§Øª
                        </h1>
                        <p class="section-subtitle">ØªØ³Ø¬ÙŠÙ„ ÙˆÙ…ØªØ§Ø¨Ø¹Ø© Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ ÙˆÙ…ØµÙÙˆÙØ© Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ù„Ù„Ù…ÙˆØ¸ÙÙŠÙ†</p>
                    </div>
                    <div class="flex gap-2">
                        <button id="view-training-matrix-btn" class="btn-secondary">
                            <i class="fas fa-table ml-2"></i>
                            Ù…ØµÙÙˆÙØ© Ø§Ù„ØªØ¯Ø±ÙŠØ¨
                        </button>
                        <button id="add-training-btn" class="btn-primary">
                            <i class="fas fa-plus ml-2"></i>
                            Ø¥Ø¶Ø§ÙØ© Ø¨Ø±Ù†Ø§Ù…Ø¬ ØªØ¯Ø±ÙŠØ¨ÙŠ
                        </button>
                    </div>
                </div>
            </div>
            <div id="training-content" class="mt-6">
                ${await this.renderList()}
            </div>
        `;
        this.setupEventListeners();
        this.loadTrainingList();
    },

    async renderList() {
        return `
            <div class="content-card">
                <div class="card-header">
                    <div class="flex items-center justify-between">
                        <h2 class="card-title"><i class="fas fa-list ml-2"></i>Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„ØªØ¯Ø±ÙŠØ¨</h2>
                        <div class="flex items-center gap-4">
                            <button id="export-training-excel-btn" class="btn-success">
                                <i class="fas fa-file-excel ml-2"></i>ØªØµØ¯ÙŠØ± Excel
                            </button>
                            <input type="text" id="training-search" class="form-input" style="max-width: 300px;" placeholder="Ø§Ù„Ø¨Ø­Ø«...">
                            <select id="training-filter-status" class="form-input" style="max-width: 200px;">
                                <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
                                <option value="Ù…Ø®Ø·Ø·">Ù…Ø®Ø·Ø·</option>
                                <option value="Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°">Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</option>
                                <option value="Ù…ÙƒØªÙ…Ù„">Ù…ÙƒØªÙ…Ù„</option>
                                <option value="Ù…Ù„ØºÙŠ">Ù…Ù„ØºÙŠ</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div id="training-table-container">
                        <div class="empty-state">
                            <i class="fas fa-spinner fa-spin text-4xl text-gray-300 mb-4"></i>
                            <p class="text-gray-500">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
                        </div>
                    </div>
                </div>
            </div>
        `;
    },

    async loadTrainingList() {
        const container = document.getElementById('training-table-container');
        if (!container) return;
        const items = AppState.appData.training || [];
        
        if (items.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-graduation-cap text-4xl text-gray-300 mb-4"></i>
                    <p class="text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ø±Ø§Ù…Ø¬ ØªØ¯Ø±ÙŠØ¨ÙŠØ©</p>
                    <button id="add-training-empty-btn" class="btn-primary mt-4">
                        <i class="fas fa-plus ml-2"></i>
                        Ø¥Ø¶Ø§ÙØ© Ø¨Ø±Ù†Ø§Ù…Ø¬ ØªØ¯Ø±ÙŠØ¨ÙŠ
                    </button>
                </div>
            `;
            return;
        }

        container.innerHTML = `
            <div class="table-wrapper" style="overflow-x: auto;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Ø§Ø³Ù… Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬</th>
                            <th>Ø§Ù„Ù…Ø¯Ø±Ø¨</th>
                            <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡</th>
                            <th>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†</th>
                            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                            <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${items.map(item => `
                            <tr>
                                <td>${Utils.escapeHTML(item.name || '')}</td>
                                <td>${Utils.escapeHTML(item.trainer || '')}</td>
                                <td>${item.startDate ? Utils.formatDate(item.startDate) : '-'}</td>
                                <td>${item.participants || 0}</td>
                                <td>
                                    <span class="badge badge-${item.status === 'Ù…ÙƒØªÙ…Ù„' ? 'success' : item.status === 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°' ? 'info' : item.status === 'Ù…Ù„ØºÙŠ' ? 'danger' : 'warning'}">
                                        ${item.status || '-'}
                                    </span>
                                </td>
                                <td>
                                    <div class="flex items-center gap-2">
                                        <button onclick="Training.editTraining('${item.id}')" class="btn-icon btn-icon-primary">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button onclick="Training.deleteTraining('${item.id}')" class="btn-icon btn-icon-danger">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
    },

    setupEventListeners() {
        setTimeout(() => {
            const addBtn = document.getElementById('add-training-btn');
            const addEmptyBtn = document.getElementById('add-training-empty-btn');
            if (addBtn) addBtn.addEventListener('click', () => this.showForm());
            if (addEmptyBtn) addEmptyBtn.addEventListener('click', () => this.showForm());
            const form = document.getElementById('training-form');
            if (form) form.addEventListener('submit', (e) => this.handleSubmit(e));
            
            // Export Excel button
            const exportExcelBtn = document.getElementById('export-training-excel-btn');
            if (exportExcelBtn) {
                exportExcelBtn.addEventListener('click', () => this.exportToExcel());
            }
            
            // Search and filter
            const searchInput = document.getElementById('training-search');
            const statusFilter = document.getElementById('training-filter-status');
            
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    this.filterItems(e.target.value, statusFilter?.value || '');
                });
            }
            
            if (statusFilter) {
                statusFilter.addEventListener('change', (e) => {
                    this.filterItems(searchInput?.value || '', e.target.value);
                });
            }
            
            // View Training Matrix button
            const viewMatrixBtn = document.getElementById('view-training-matrix-btn');
            if (viewMatrixBtn) {
                viewMatrixBtn.addEventListener('click', () => this.showTrainingMatrix());
            }
        }, 100);
    },
    
    /**
     * Ø¹Ø±Ø¶ Ù…ØµÙÙˆÙØ© Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ù„ÙƒÙ„ Ù…ÙˆØ¸Ù Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø¬Ø¯ÙˆÙ„ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†
     */
    async showTrainingMatrix() {
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 1400px; max-height: 90vh; overflow-y: auto;">
                <div class="modal-header">
                    <h2 class="modal-title">
                        <i class="fas fa-table ml-2"></i>
                        Ù…ØµÙÙˆÙØ© Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ù„ÙƒÙ„ Ù…ÙˆØ¸Ù
                    </h2>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="mb-4">
                        <div class="flex gap-2 items-center">
                            <input type="text" id="training-matrix-search" class="form-input" style="max-width: 400px;" 
                                placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ù…ÙˆØ¸Ù (Ø§Ù„ÙƒÙˆØ¯ Ø£Ùˆ Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„ÙˆØ¸ÙŠÙØ©)">
                        </div>
                    </div>
                    <div id="training-matrix-content">
                        ${await this.renderTrainingMatrix()}
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" onclick="this.closest('.modal-overlay').remove()">Ø¥ØºÙ„Ø§Ù‚</button>
                    <button class="btn-primary" onclick="Training.exportTrainingMatrix()">
                        <i class="fas fa-file-excel ml-2"></i>ØªØµØ¯ÙŠØ± Excel
                    </button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        
        // Setup search
        const searchInput = document.getElementById('training-matrix-search');
        if (searchInput) {
            searchInput.addEventListener('input', (e) => {
                this.filterTrainingMatrix(e.target.value.trim());
            });
        }
        
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
        });
    },
    
    /**
     * Ø¹Ø±Ø¶ Ù…ØµÙÙˆÙØ© Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ù„ÙƒÙ„ Ù…ÙˆØ¸Ù Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø¬Ø¯ÙˆÙ„ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†
     */
    async renderTrainingMatrix() {
        const employees = AppState.appData.employees || [];
        const trainingMatrix = AppState.appData.employeeTrainingMatrix || {};
        
        if (employees.length === 0) {
            return `
                <div class="empty-state">
                    <i class="fas fa-table text-4xl text-gray-300 mb-4"></i>
                    <p class="text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ÙˆØ¸ÙÙŠÙ†</p>
                </div>
            `;
        }
        
        return `
            <div class="table-wrapper" style="overflow-x: auto;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</th>
                            <th>Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù</th>
                            <th>Ø§Ù„ÙˆØ¸ÙŠÙØ©</th>
                            <th>Ø§Ù„Ù‚Ø³Ù…/Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</th>
                            <th>Ø¹Ø¯Ø¯ Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„ØªØ¯Ø±ÙŠØ¨</th>
                            <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø³Ø§Ø¹Ø§Øª Ø§Ù„ØªØ¯Ø±ÙŠØ¨</th>
                            <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${employees.map(emp => {
                            const code = emp.employeeNumber || emp.sapId || '';
                            const trainings = trainingMatrix[code] || [];
                            const totalHours = trainings.reduce((sum, t) => sum + (parseFloat(t.hours) || 0), 0);
                            const internalTrainings = trainings.filter(t => t.trainingType === 'Ø¯Ø§Ø®Ù„ÙŠ').length;
                            const externalTrainings = trainings.filter(t => t.trainingType === 'Ø®Ø§Ø±Ø¬ÙŠ').length;
                            
                            return `
                                <tr data-code="${code}" data-name="${emp.name || ''}" data-position="${emp.position || ''}">
                                    <td><strong>${Utils.escapeHTML(code)}</strong></td>
                                    <td>${Utils.escapeHTML(emp.name || '')}</td>
                                    <td>${Utils.escapeHTML(emp.position || '-')}</td>
                                    <td>${Utils.escapeHTML(emp.department || '-')}</td>
                                    <td>
                                        <span class="badge badge-info">${trainings.length}</span>
                                        <span class="text-xs text-gray-500 mr-2">(Ø¯Ø§Ø®Ù„ÙŠ: ${internalTrainings}, Ø®Ø§Ø±Ø¬ÙŠ: ${externalTrainings})</span>
                                    </td>
                                    <td><strong>${totalHours.toFixed(2)}</strong> Ø³Ø§Ø¹Ø©</td>
                                    <td>
                                        <button onclick="Training.viewEmployeeTrainingMatrix('${code}')" class="btn-icon btn-icon-info" title="Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØ¯Ø±ÙŠØ¨">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
        `;
    },
    
    /**
     * ØªØµÙÙŠØ© Ù…ØµÙÙˆÙØ© Ø§Ù„ØªØ¯Ø±ÙŠØ¨
     */
    filterTrainingMatrix(searchTerm) {
        const tbody = document.querySelector('#training-matrix-content tbody');
        if (!tbody) return;
        
        const rows = tbody.querySelectorAll('tr[data-code]');
        rows.forEach(row => {
            const code = row.getAttribute('data-code') || '';
            const name = row.getAttribute('data-name') || '';
            const position = row.getAttribute('data-position') || '';
            const searchLower = searchTerm.toLowerCase();
            
            if (!searchTerm || 
                code.includes(searchTerm) || 
                name.toLowerCase().includes(searchLower) || 
                position.toLowerCase().includes(searchLower)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    },
    
    /**
     * Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ù„Ù…ÙˆØ¸Ù Ù…Ø­Ø¯Ø¯
     */
    async viewEmployeeTrainingMatrix(employeeCode) {
        const employees = AppState.appData.employees || [];
        const emp = employees.find(e => (e.employeeNumber || e.sapId) === employeeCode);
        
        if (!emp) {
            Notification.error('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¸Ù');
            return;
        }
        
        const trainingMatrix = AppState.appData.employeeTrainingMatrix || {};
        const trainings = trainingMatrix[employeeCode] || [];
        
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 1000px;">
                <div class="modal-header">
                    <h2 class="modal-title">
                        <i class="fas fa-graduation-cap ml-2"></i>
                        Ù…ØµÙÙˆÙØ© Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ù„Ù„Ù…ÙˆØ¸Ù: ${Utils.escapeHTML(emp.name || '')}
                    </h2>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="mb-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm font-semibold text-gray-600">Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ:</label>
                                <p class="text-gray-800 font-mono">${Utils.escapeHTML(employeeCode)}</p>
                            </div>
                            <div>
                                <label class="text-sm font-semibold text-gray-600">Ø§Ù„ÙˆØ¸ÙŠÙØ©:</label>
                                <p class="text-gray-800">${Utils.escapeHTML(emp.position || '-')}</p>
                            </div>
                            <div>
                                <label class="text-sm font-semibold text-gray-600">Ø§Ù„Ù‚Ø³Ù…/Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©:</label>
                                <p class="text-gray-800">${Utils.escapeHTML(emp.department || '-')}</p>
                            </div>
                            <div>
                                <label class="text-sm font-semibold text-gray-600">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„ØªØ¯Ø±ÙŠØ¨:</label>
                                <p class="text-gray-800 font-bold">${trainings.length}</p>
                            </div>
                        </div>
                    </div>
                    ${trainings.length > 0 ? `
                        <div class="table-wrapper" style="overflow-x: auto;">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Ø§Ø³Ù… Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬</th>
                                        <th>Ù†ÙˆØ¹ Ø§Ù„ØªØ¯Ø±ÙŠØ¨</th>
                                        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                        <th>Ø§Ù„Ù…ÙƒØ§Ù†</th>
                                        <th>Ø§Ù„Ù…Ø¯Ø±Ø¨</th>
                                        <th>Ø§Ù„Ø³Ø§Ø¹Ø§Øª</th>
                                        <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${trainings.sort((a, b) => {
                                        const dateA = new Date(a.trainingDate || a.trainingDate || 0);
                                        const dateB = new Date(b.trainingDate || b.trainingDate || 0);
                                        return dateB - dateA;
                                    }).map(t => `
                                        <tr>
                                            <td>${Utils.escapeHTML(t.trainingName || '')}</td>
                                            <td>
                                                <span class="badge badge-${t.trainingType === 'Ø¯Ø§Ø®Ù„ÙŠ' ? 'info' : 'warning'}">
                                                    ${Utils.escapeHTML(t.trainingType || 'Ø¯Ø§Ø®Ù„ÙŠ')}
                                                </span>
                                            </td>
                                            <td>${t.trainingDate ? Utils.formatDate(t.trainingDate) : '-'}</td>
                                            <td>${Utils.escapeHTML(t.location || '-')}</td>
                                            <td>${Utils.escapeHTML(t.trainer || '-')}</td>
                                            <td>${(parseFloat(t.hours) || 0).toFixed(2)} Ø³Ø§Ø¹Ø©</td>
                                            <td>
                                                <span class="badge badge-${t.completed ? 'success' : t.status === 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°' ? 'info' : 'warning'}">
                                                    ${Utils.escapeHTML(t.status || 'Ù…Ø®Ø·Ø·')}
                                                </span>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    ` : `
                        <div class="empty-state">
                            <i class="fas fa-graduation-cap text-4xl text-gray-300 mb-4"></i>
                            <p class="text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ø±Ø§Ù…Ø¬ ØªØ¯Ø±ÙŠØ¨ Ù…Ø³Ø¬Ù„Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¸Ù</p>
                        </div>
                    `}
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" onclick="this.closest('.modal-overlay').remove()">Ø¥ØºÙ„Ø§Ù‚</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
        });
    },
    
    /**
     * ØªØµØ¯ÙŠØ± Ù…ØµÙÙˆÙØ© Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø¥Ù„Ù‰ Excel
     */
    async exportTrainingMatrix() {
        try {
            Loading.show();
            
            if (typeof XLSX === 'undefined') {
                Loading.hide();
                Notification.error('Ù…ÙƒØªØ¨Ø© SheetJS ØºÙŠØ± Ù…Ø­Ù…Ù‘Ù„Ø©. ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©');
                return;
            }
            
            const employees = AppState.appData.employees || [];
            const trainingMatrix = AppState.appData.employeeTrainingMatrix || {};
            
            const excelData = employees.map(emp => {
                const code = emp.employeeNumber || emp.sapId || '';
                const trainings = trainingMatrix[code] || [];
                const totalHours = trainings.reduce((sum, t) => sum + (parseFloat(t.hours) || 0), 0);
                const internalCount = trainings.filter(t => t.trainingType === 'Ø¯Ø§Ø®Ù„ÙŠ').length;
                const externalCount = trainings.filter(t => t.trainingType === 'Ø®Ø§Ø±Ø¬ÙŠ').length;
                
                return {
                    'Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ': code,
                    'Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù': emp.name || '',
                    'Ø§Ù„ÙˆØ¸ÙŠÙØ©': emp.position || '',
                    'Ø§Ù„Ù‚Ø³Ù…/Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©': emp.department || '',
                    'Ø¹Ø¯Ø¯ Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„ØªØ¯Ø±ÙŠØ¨': trainings.length,
                    'ØªØ¯Ø±ÙŠØ¨ Ø¯Ø§Ø®Ù„ÙŠ': internalCount,
                    'ØªØ¯Ø±ÙŠØ¨ Ø®Ø§Ø±Ø¬ÙŠ': externalCount,
                    'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø³Ø§Ø¹Ø§Øª Ø§Ù„ØªØ¯Ø±ÙŠØ¨': totalHours.toFixed(2)
                };
            });
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(excelData);
            
            ws['!cols'] = [
                { wch: 15 }, // Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ
                { wch: 25 }, // Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù
                { wch: 20 }, // Ø§Ù„ÙˆØ¸ÙŠÙØ©
                { wch: 20 }, // Ø§Ù„Ù‚Ø³Ù…/Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
                { wch: 18 }, // Ø¹Ø¯Ø¯ Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„ØªØ¯Ø±ÙŠØ¨
                { wch: 15 }, // ØªØ¯Ø±ÙŠØ¨ Ø¯Ø§Ø®Ù„ÙŠ
                { wch: 15 }, // ØªØ¯Ø±ÙŠØ¨ Ø®Ø§Ø±Ø¬ÙŠ
                { wch: 20 }  // Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø³Ø§Ø¹Ø§Øª Ø§Ù„ØªØ¯Ø±ÙŠØ¨
            ];
            
            XLSX.utils.book_append_sheet(wb, ws, 'Ù…ØµÙÙˆÙØ© Ø§Ù„ØªØ¯Ø±ÙŠØ¨');
            
            const date = new Date().toISOString().slice(0, 10);
            const filename = `Ù…ØµÙÙˆÙØ©_Ø§Ù„ØªØ¯Ø±ÙŠØ¨_${date}.xlsx`;
            
            XLSX.writeFile(wb, filename);
            
            Loading.hide();
            Notification.success('ØªÙ… ØªØµØ¯ÙŠØ± Ù…ØµÙÙˆÙØ© Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø¨Ù†Ø¬Ø§Ø­');
        } catch (error) {
            Loading.hide();
            console.error('Ø®Ø·Ø£ ÙÙŠ ØªØµØ¯ÙŠØ± Ù…ØµÙÙˆÙØ© Ø§Ù„ØªØ¯Ø±ÙŠØ¨:', error);
            Notification.error('ÙØ´Ù„ ØªØµØ¯ÙŠØ± Ù…ØµÙÙˆÙØ© Ø§Ù„ØªØ¯Ø±ÙŠØ¨: ' + error.message);
        }
    },
    
    filterItems(searchTerm = '', statusFilter = '') {
        const items = AppState.appData.training || [];
        let filtered = items;
        
        if (searchTerm) {
            const term = searchTerm.toLowerCase();
            filtered = filtered.filter(item => 
                (item.name && item.name.toLowerCase().includes(term)) ||
                (item.trainer && item.trainer.toLowerCase().includes(term)) ||
                (item.participants && item.participants.some(p => 
                    (p.name && p.name.toLowerCase().includes(term)) ||
                    (p.code && p.code.includes(term))
                ))
            );
        }
        
        if (statusFilter) {
            filtered = filtered.filter(item => item.status === statusFilter);
        }
        
        const tbody = document.querySelector('#training-table-container tbody');
        if (tbody && filtered.length > 0) {
            tbody.innerHTML = filtered.map(item => `
                <tr>
                    <td>${Utils.escapeHTML(item.name || '')}</td>
                    <td>${Utils.escapeHTML(item.trainer || '')}</td>
                    <td>${item.startDate ? Utils.formatDate(item.startDate) : '-'}</td>
                    <td>${item.participants?.length || item.participantsCount || 0}</td>
                    <td>
                        <span class="badge badge-${item.status === 'Ù…ÙƒØªÙ…Ù„' ? 'success' : item.status === 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°' ? 'info' : item.status === 'Ù…Ù„ØºÙŠ' ? 'danger' : 'warning'}">
                            ${item.status || '-'}
                        </span>
                    </td>
                    <td>
                        <div class="flex items-center gap-2">
                            <button onclick="Training.viewTraining('${item.id}')" class="btn-icon btn-icon-info">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button onclick="Training.editTraining('${item.id}')" class="btn-icon btn-icon-primary">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="Training.deleteTraining('${item.id}')" class="btn-icon btn-icon-danger">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }
    },
    
    async exportToExcel() {
        try {
            Loading.show();
            
            // Check if SheetJS is available
            if (typeof XLSX === 'undefined') {
                Loading.hide();
                Notification.error('Ù…ÙƒØªØ¨Ø© SheetJS ØºÙŠØ± Ù…Ø­Ù…Ù‘Ù„Ø©. ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©');
                return;
            }
            
            const trainings = AppState.appData.training || [];
            
            // Prepare data for Excel
            const excelData = trainings.map(training => {
                const participants = Array.isArray(training.participants) 
                    ? training.participants.map(p => `${p.name || ''} (${p.code || p.employeeNumber || ''})`).join('; ')
                    : '';
                
                return {
                    'Ø§Ø³Ù… Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬': training.name || '',
                    'Ø§Ù„Ù…Ø¯Ø±Ø¨': training.trainer || '',
                    'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡': training.startDate ? Utils.formatDate(training.startDate) : '',
                    'Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†': training.participants?.length || training.participantsCount || 0,
                    'Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†': participants,
                    'Ø§Ù„Ø­Ø§Ù„Ø©': training.status || '',
                    'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡': training.createdAt ? Utils.formatDate(training.createdAt) : ''
                };
            });
            
            // Create workbook
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(excelData);
            
            // Set column widths
            ws['!cols'] = [
                { wch: 30 }, // Ø§Ø³Ù… Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬
                { wch: 20 }, // Ø§Ù„Ù…Ø¯Ø±Ø¨
                { wch: 15 }, // ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡
                { wch: 15 }, // Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†
                { wch: 50 }, // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†
                { wch: 15 }, // Ø§Ù„Ø­Ø§Ù„Ø©
                { wch: 15 }  // ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡
            ];
            
            XLSX.utils.book_append_sheet(wb, ws, 'Ø§Ù„ØªØ¯Ø±ÙŠØ¨Ø§Øª');
            
            // Generate filename with date
            const date = new Date().toISOString().slice(0, 10);
            const filename = `Ø³Ø¬Ù„_Ø§Ù„ØªØ¯Ø±ÙŠØ¨Ø§Øª_${date}.xlsx`;
            
            // Export
            XLSX.writeFile(wb, filename);
            
            Loading.hide();
            Notification.success('ØªÙ… ØªØµØ¯ÙŠØ± Ø³Ø¬Ù„ Ø§Ù„ØªØ¯Ø±ÙŠØ¨Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
        } catch (error) {
            Loading.hide();
            console.error('Ø®Ø·Ø£ ÙÙŠ ØªØµØ¯ÙŠØ± Excel:', error);
            Notification.error('ÙØ´Ù„ ØªØµØ¯ÙŠØ± Excel: ' + error.message);
        }
    },
    
    async viewTraining(id) {
        const training = AppState.appData.training.find(t => t.id === id);
        if (!training) {
            Notification.error('Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
            return;
        }
        
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 900px;">
                <div class="modal-header">
                    <h2 class="modal-title">
                        <i class="fas fa-graduation-cap ml-2"></i>
                        ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬: ${Utils.escapeHTML(training.name || '')}
                    </h2>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-sm font-semibold text-gray-600">Ø§Ù„Ù…Ø¯Ø±Ø¨:</label>
                            <p class="text-gray-800">${Utils.escapeHTML(training.trainer || '')}</p>
                        </div>
                        <div>
                            <label class="text-sm font-semibold text-gray-600">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡:</label>
                            <p class="text-gray-800">${training.startDate ? Utils.formatDate(training.startDate) : '-'}</p>
                        </div>
                        <div>
                            <label class="text-sm font-semibold text-gray-600">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†:</label>
                            <p class="text-gray-800">${training.participants?.length || training.participantsCount || 0}</p>
                        </div>
                        <div>
                            <label class="text-sm font-semibold text-gray-600">Ø§Ù„Ø­Ø§Ù„Ø©:</label>
                            <span class="badge badge-${training.status === 'Ù…ÙƒØªÙ…Ù„' ? 'success' : training.status === 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°' ? 'info' : training.status === 'Ù…Ù„ØºÙŠ' ? 'danger' : 'warning'}">
                                ${training.status || '-'}
                            </span>
                        </div>
                    </div>
                    ${training.participants && training.participants.length > 0 ? `
                        <div class="mt-4">
                            <label class="text-sm font-semibold text-gray-600">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†:</label>
                            <div class="mt-2 space-y-2">
                                ${training.participants.map(p => `
                                    <div class="p-2 bg-gray-50 rounded">
                                        <strong>${Utils.escapeHTML(p.name || '')}</strong>
                                        <span class="text-sm text-gray-600"> - ÙƒÙˆØ¯: ${Utils.escapeHTML(p.code || p.employeeNumber || '')}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" onclick="this.closest('.modal-overlay').remove()">Ø¥ØºÙ„Ø§Ù‚</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
        });
    },

    async showForm(data = null) {
        this.currentEditId = data?.id || null;
        const content = document.getElementById('training-content');
        if (!content) {
            console.error('âŒ Ø¹Ù†ØµØ± training-content ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
            Notification.error('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬');
            return;
        }
        console.log('âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ training-contentØŒ Ø¹Ø±Ø¶ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬');
        content.innerHTML = await this.renderForm(data);
        this.setupEventListeners();
    },

    async showList() {
        this.currentEditId = null;
        const content = document.getElementById('training-content');
        if (content) {
            content.innerHTML = await this.renderList();
            this.setupEventListeners();
            this.loadTrainingList();
        }
    },

    async renderForm(data = null) {
        return `
            <div class="content-card">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-${data ? 'edit' : 'plus-circle'} ml-2"></i>
                        ${data ? 'ØªØ¹Ø¯ÙŠÙ„ Ø¨Ø±Ù†Ø§Ù…Ø¬ ØªØ¯Ø±ÙŠØ¨ÙŠ' : 'Ø¥Ø¶Ø§ÙØ© Ø¨Ø±Ù†Ø§Ù…Ø¬ ØªØ¯Ø±ÙŠØ¨ÙŠ Ø¬Ø¯ÙŠØ¯'}
                    </h2>
                </div>
                <div class="card-body">
                    <!-- Ø±Ø£Ø³ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ -->
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">
                            <i class="fas fa-heading ml-2"></i>
                            Ø±Ø£Ø³ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
                        </h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <i class="fas fa-calendar ml-2"></i>
                                    Ø§Ù„ØªØ§Ø±ÙŠØ® *
                                </label>
                                <input type="date" id="training-date" required class="form-input"
                                    value="${data?.date ? new Date(data.date).toISOString().slice(0, 10) : (data?.startDate ? new Date(data.startDate).toISOString().slice(0, 10) : '')}">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <i class="fas fa-map-marker-alt ml-2"></i>
                                    Ù…ÙƒØ§Ù† Ø§Ù„ØªØ¯Ø±ÙŠØ¨ *
                                </label>
                                <input type="text" id="training-location" required class="form-input"
                                    value="${data?.location || ''}" placeholder="Ù…ÙƒØ§Ù† Ø§Ù„ØªØ¯Ø±ÙŠØ¨">
                            </div>
                            <div class="col-span-2">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <i class="fas fa-book-open ml-2"></i>
                                    Ù…ÙˆØ¶ÙˆØ¹ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© *
                                </label>
                                <input type="text" id="training-name" required class="form-input"
                                    value="${data?.name || ''}" placeholder="Ù…ÙˆØ¶ÙˆØ¹ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <i class="fas fa-clock ml-2"></i>
                                    Ø§Ù„ÙˆÙ‚Øª Ù…Ù† *
                                </label>
                                <input type="time" id="training-startTime" required class="form-input"
                                    value="${data?.startTime || ''}">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <i class="fas fa-clock ml-2"></i>
                                    Ø§Ù„ÙˆÙ‚Øª Ø¥Ù„Ù‰ *
                                </label>
                                <input type="time" id="training-endTime" required class="form-input"
                                    value="${data?.endTime || ''}">
                            </div>
                        </div>
                    </div>
                    
                    <form id="training-form" class="space-y-6">
                        <div class="grid grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <i class="fas fa-calendar ml-2"></i>
                                    ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡ *
                                </label>
                                <input type="date" id="training-startDate" required class="form-input"
                                    value="${data?.startDate ? new Date(data.startDate).toISOString().slice(0, 10) : ''}">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <i class="fas fa-info-circle ml-2"></i>
                                    Ø§Ù„Ø­Ø§Ù„Ø© *
                                </label>
                                <select id="training-status" required class="form-input">
                                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø­Ø§Ù„Ø©</option>
                                    <option value="Ù…Ø®Ø·Ø·" ${data?.status === 'Ù…Ø®Ø·Ø·' ? 'selected' : ''}>Ù…Ø®Ø·Ø·</option>
                                    <option value="Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°" ${data?.status === 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°' ? 'selected' : ''}>Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</option>
                                    <option value="Ù…ÙƒØªÙ…Ù„" ${data?.status === 'Ù…ÙƒØªÙ…Ù„' ? 'selected' : ''}>Ù…ÙƒØªÙ…Ù„</option>
                                    <option value="Ù…Ù„ØºÙŠ" ${data?.status === 'Ù…Ù„ØºÙŠ' ? 'selected' : ''}>Ù…Ù„ØºÙŠ</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <i class="fas fa-user-tie ml-2"></i>
                                    Ø§Ø³Ù… Ø§Ù„Ù‚Ø§Ø¦Ù… Ø¨Ø§Ù„ØªØ¯Ø±ÙŠØ¨ *
                                </label>
                                <input type="text" id="training-trainer" required class="form-input"
                                    value="${data?.trainer || ''}" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø¨">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <i class="fas fa-building ml-2"></i>
                                    Ù†ÙˆØ¹ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ *
                                </label>
                                <select id="training-type" required class="form-input">
                                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù†ÙˆØ¹</option>
                                    <option value="Ø¯Ø§Ø®Ù„ÙŠ" ${data?.trainingType === 'Ø¯Ø§Ø®Ù„ÙŠ' ? 'selected' : ''}>Ø¯Ø§Ø®Ù„ÙŠ</option>
                                    <option value="Ø®Ø§Ø±Ø¬ÙŠ" ${data?.trainingType === 'Ø®Ø§Ø±Ø¬ÙŠ' ? 'selected' : ''}>Ø®Ø§Ø±Ø¬ÙŠ</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <i class="fas fa-users ml-2"></i>
                                    Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ† *
                                </label>
                                <input type="number" id="training-participants" required class="form-input"
                                    value="${data?.participantsCount || (data?.participants ? data.participants.length : 0)}" min="0" readonly>
                            </div>
                        </div>
                        
                        <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ† -->
                        <div class="col-span-2 mt-4">
                            <label class="block text-sm font-semibold text-gray-700 mb-3">
                                <i class="fas fa-users ml-2"></i>
                                Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†
                            </label>
                            <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                                <div class="mb-4">
                                    <div class="flex gap-2">
                                        <div class="relative flex-1">
                                            <input type="text" id="training-participant-code" class="form-input"
                                                placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ (Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹)" autocomplete="off">
                                            <div id="training-participant-dropdown" class="absolute z-50 hidden w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-auto">
                                            </div>
                                        </div>
                                        <button type="button" id="add-participant-btn" class="btn-secondary">
                                            <i class="fas fa-plus ml-2"></i>Ø¥Ø¶Ø§ÙØ©
                                        </button>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-2">
                                        <i class="fas fa-info-circle ml-1"></i>
                                        Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ ÙˆØ³ÙŠØªÙ… ØªØ¹Ø¨Ø¦Ø© Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù ÙˆØ§Ù„ÙˆØ¸ÙŠÙØ© ÙˆØ§Ù„Ù‚Ø³Ù…/Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
                                    </p>
                                </div>
                                
                                <div class="overflow-x-auto">
                                    <table class="data-table w-full">
                                        <thead>
                                            <tr>
                                                <th>Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</th>
                                                <th>Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù</th>
                                                <th>Ø§Ù„ÙˆØ¸ÙŠÙØ©</th>
                                                <th>Ø§Ù„Ù‚Ø³Ù…/Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</th>
                                                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                            </tr>
                                        </thead>
                                        <tbody id="training-participants-table-body">
                                            ${data?.participants?.map(p => {
                                                const emp = (AppState.appData.employees || []).find(e => 
                                                    (e.employeeNumber || e.sapId) === (p.code || p.employeeNumber)
                                                );
                                                return `
                                                <tr data-code="${p.code || p.employeeNumber || ''}" data-name="${p.name || ''}" data-position="${p.position || emp?.position || ''}" data-department="${p.department || emp?.department || ''}">
                                                    <td>${Utils.escapeHTML(p.code || p.employeeNumber || '')}</td>
                                                    <td>${Utils.escapeHTML(p.name || '')}</td>
                                                    <td>${Utils.escapeHTML(p.position || emp?.position || '-')}</td>
                                                    <td>${Utils.escapeHTML(p.department || emp?.department || '-')}</td>
                                                    <td>
                                                        <button type="button" onclick="
                                                            const row = this.closest('tr');
                                                            row.remove();
                                                            const countInput = document.getElementById('training-participants');
                                                            const tableBody = document.getElementById('training-participants-table-body');
                                                            if(countInput && tableBody) {
                                                                countInput.value = tableBody.querySelectorAll('tr[data-code]').length;
                                                            }
                                                        " class="btn-icon btn-icon-danger" title="Ø­Ø°Ù">
                                                            <i class="fas fa-times"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                            `;
                                            }).join('') || '<tr><td colspan="5" class="text-center text-gray-500 py-4">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙƒÙŠÙ†</td></tr>'}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center justify-end gap-4 pt-4 border-t">
                            <button type="button" onclick="Training.showList()" class="btn-secondary">Ø¥Ù„ØºØ§Ø¡</button>
                            <button type="submit" class="btn-primary">
                                <i class="fas fa-save ml-2"></i>
                                ${data ? 'Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª' : 'Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬'}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        `;
        
        // Setup participant autocomplete by employee code or name
        setTimeout(() => {
            const codeInput = document.getElementById('training-participant-code');
            const dropdown = document.getElementById('training-participant-dropdown');
            
            if (codeInput && dropdown) {
                // Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ Ø£Ùˆ Ø§Ù„Ø§Ø³Ù…
                codeInput.addEventListener('input', (e) => {
                    const searchTerm = e.target.value.trim();
                    dropdown.innerHTML = '';
                    dropdown.classList.add('hidden');
                    
                    if (searchTerm.length < 2) return;
                    
                    const employees = AppState.appData.employees || [];
                    const matches = employees.filter(emp => {
                        const code = emp.employeeNumber || emp.sapId || '';
                        const name = emp.name || '';
                        const position = emp.position || '';
                        const department = emp.department || '';
                        const searchLower = searchTerm.toLowerCase();
                        return code.includes(searchTerm) || 
                               name.toLowerCase().includes(searchLower) ||
                               position.toLowerCase().includes(searchLower) ||
                               department.toLowerCase().includes(searchLower);
                    }).slice(0, 10);
                    
                    if (matches.length > 0) {
                        dropdown.innerHTML = matches.map(emp => `
                            <div class="p-3 hover:bg-blue-50 cursor-pointer border-b border-gray-100" 
                                 onclick="Training.selectEmployee('${emp.employeeNumber || emp.sapId || ''}')">
                                <div class="font-semibold text-gray-800">${Utils.escapeHTML(emp.employeeNumber || emp.sapId || '')}</div>
                                <div class="text-sm text-gray-700">${Utils.escapeHTML(emp.name || '')}</div>
                                ${emp.position ? `<div class="text-xs text-gray-600">Ø§Ù„ÙˆØ¸ÙŠÙØ©: ${Utils.escapeHTML(emp.position)}</div>` : ''}
                                ${emp.department ? `<div class="text-xs text-gray-600">Ø§Ù„Ù‚Ø³Ù…/Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©: ${Utils.escapeHTML(emp.department)}</div>` : ''}
                            </div>
                        `).join('');
                        dropdown.classList.remove('hidden');
                    } else {
                        dropdown.innerHTML = '<div class="p-2 text-sm text-gray-500 text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>';
                        dropdown.classList.remove('hidden');
                    }
                });
                
                // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
                document.addEventListener('click', (e) => {
                    if (!codeInput.contains(e.target) && !dropdown.contains(e.target)) {
                        dropdown.classList.add('hidden');
                    }
                });
                
                // Ø¥Ø¶Ø§ÙØ© Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Enter
                codeInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const firstMatch = dropdown.querySelector('div[onclick]');
                        if (firstMatch) {
                            firstMatch.click();
                        }
                    }
                });
            }
            
            const addBtn = document.getElementById('add-participant-btn');
            if (addBtn) {
                addBtn.addEventListener('click', () => {
                    const code = codeInput?.value.trim();
                    if (code) {
                        const employees = AppState.appData.employees || [];
                        const emp = employees.find(e => 
                            (e.employeeNumber || e.sapId) === code ||
                            (e.name && e.name.toLowerCase().includes(code.toLowerCase()))
                        );
                        if (emp) {
                            Training.selectEmployee(emp.employeeNumber || emp.sapId);
                        } else {
                            Notification.warning('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…ÙˆØ¸Ù Ø¨Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ø£Ùˆ Ø§Ù„Ø§Ø³Ù…');
                        }
                    } else {
                        Notification.warning('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ Ø£Ùˆ Ø§Ù„Ø§Ø³Ù…');
                    }
                });
            }
        }, 100);
    },

    selectEmployee(code) {
        const employees = AppState.appData.employees || [];
        const emp = employees.find(e => (e.employeeNumber || e.sapId) === code);
        
        if (!emp) {
            Notification.warning('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…ÙˆØ¸Ù Ø¨Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯');
            return;
        }
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ØªÙƒØ±Ø§Ø± Ø§Ù„Ù…ÙˆØ¸Ù
        const list = document.getElementById('training-participants-list');
        if (!list) {
            Notification.error('Ø¹Ù†ØµØ± Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ† ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
            return;
        }
        const existing = list.querySelector(`div[data-code="${code}"]`);
        if (existing) {
            Notification.warning('Ø§Ù„Ù…ÙˆØ¸Ù Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©');
            return;
        }
        
        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ¸Ù Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ù…Ø¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const codeInput = document.getElementById('training-participant-code');
        const dropdown = document.getElementById('training-participant-dropdown');
        
        const participantDiv = document.createElement('div');
        participantDiv.className = 'flex items-center gap-2 p-2 border rounded bg-gray-50';
        participantDiv.setAttribute('data-code', code);
        participantDiv.setAttribute('data-name', emp.name || '');
        participantDiv.setAttribute('data-position', emp.position || '');
        participantDiv.setAttribute('data-department', emp.department || '');
        participantDiv.innerHTML = `
            <div class="flex-1">
                <div class="font-semibold text-gray-800">${Utils.escapeHTML(code)}</div>
                <div class="text-sm text-gray-700">${Utils.escapeHTML(emp.name || '')}</div>
                ${emp.position ? `<div class="text-xs text-gray-600">Ø§Ù„ÙˆØ¸ÙŠÙØ©: ${Utils.escapeHTML(emp.position)}</div>` : ''}
                ${emp.department ? `<div class="text-xs text-gray-600">Ø§Ù„Ù‚Ø³Ù…/Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©: ${Utils.escapeHTML(emp.department)}</div>` : ''}
            </div>
            <button type="button" onclick="this.parentElement.remove()" class="text-red-600 hover:text-red-800">
                <i class="fas fa-times"></i>
            </button>
        `;
        list.appendChild(participantDiv);
        
        // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø­Ù‚ÙˆÙ„
        if (codeInput) codeInput.value = '';
        if (dropdown) dropdown.classList.add('hidden');
        
        // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†
        const participantsCount = list.querySelectorAll('div[data-code]').length;
        const countInput = document.getElementById('training-participants');
        if (countInput) countInput.value = participantsCount;
        
        // ØªØ­Ø¯ÙŠØ« Ù…ØµÙÙˆÙØ© Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ù„Ù„Ù…ÙˆØ¸Ù
        this.updateEmployeeTrainingMatrix(code);
    },
    
    /**
     * ØªØ­Ø¯ÙŠØ« Ù…ØµÙÙˆÙØ© Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ù„Ù„Ù…ÙˆØ¸Ù
     * ÙŠØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¤Ù‡Ø§ Ø¹Ù†Ø¯ Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù Ø¥Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†
     */
    updateEmployeeTrainingMatrix(employeeCode) {
        if (!AppState.appData.employeeTrainingMatrix) {
            AppState.appData.employeeTrainingMatrix = {};
        }
        
        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…ØµÙÙˆÙØ© Ù„Ù„Ù…ÙˆØ¸Ù
        if (!AppState.appData.employeeTrainingMatrix[employeeCode]) {
            AppState.appData.employeeTrainingMatrix[employeeCode] = [];
        }
        
        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù…Ù† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
        const trainingName = document.getElementById('training-name')?.value.trim() || '';
        const trainingDate = document.getElementById('training-date')?.value || document.getElementById('training-startDate')?.value || '';
        const trainingLocation = document.getElementById('training-location')?.value.trim() || '';
        const trainingTrainer = document.getElementById('training-trainer')?.value.trim() || '';
        const trainingStatus = document.getElementById('training-status')?.value || 'Ù…Ø®Ø·Ø·';
        const startTime = document.getElementById('training-startTime')?.value || '';
        const endTime = document.getElementById('training-endTime')?.value || '';
        
        // Ø­Ø³Ø§Ø¨ Ø³Ø§Ø¹Ø§Øª Ø§Ù„ØªØ¯Ø±ÙŠØ¨
        let trainingHours = 0;
        if (startTime && endTime) {
            try {
                const start = new Date(`2000-01-01 ${startTime}`);
                const end = new Date(`2000-01-01 ${endTime}`);
                trainingHours = (end - start) / (1000 * 60 * 60);
            } catch (e) {
                // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
            }
        }
        
        // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¹Ø±Ù Ù…Ø¤Ù‚Øª Ù„Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ø­Ø§Ù„ÙŠ
        const tempTrainingId = this.currentEditId || `temp-${Date.now()}`;
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ØªÙƒØ±Ø§Ø± Ø§Ù„ØªØ¯Ø±ÙŠØ¨
        const existingTraining = AppState.appData.employeeTrainingMatrix[employeeCode].find(t => 
            t.trainingId === tempTrainingId || 
            (t.trainingName === trainingName && t.trainingDate === trainingDate)
        );
        
        if (!existingTraining && trainingName) {
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø¥Ù„Ù‰ Ù…ØµÙÙˆÙØ© Ø§Ù„Ù…ÙˆØ¸Ù
            AppState.appData.employeeTrainingMatrix[employeeCode].push({
                trainingId: tempTrainingId,
                trainingName: trainingName,
                trainingDate: trainingDate,
                status: trainingStatus,
                hours: trainingHours,
                completed: trainingStatus === 'Ù…ÙƒØªÙ…Ù„',
                location: trainingLocation,
                trainer: trainingTrainer
            });
        }
    },

    async handleSubmit(e) {
        e.preventDefault();
        
        // Ø¬Ù…Ø¹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ† Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù…Ø¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const participants = [];
        const tableBody = document.getElementById('training-participants-table-body');
        if (tableBody) {
            tableBody.querySelectorAll('tr[data-code]').forEach(row => {
                const code = row.getAttribute('data-code');
                const name = row.getAttribute('data-name');
                const position = row.getAttribute('data-position') || '';
                const department = row.getAttribute('data-department') || '';
                const emp = (AppState.appData.employees || []).find(e => (e.employeeNumber || e.sapId) === code);
                
                participants.push({
                    name: name,
                    code: code,
                    employeeNumber: code,
                    position: position || emp?.position || '',
                    department: department || emp?.department || '',
                    workLocation: emp?.workLocation || emp?.location || ''
                });
            });
        }
        
        // Ø­Ø³Ø§Ø¨ Ø³Ø§Ø¹Ø§Øª Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ù…Ù† Ø§Ù„ÙˆÙ‚Øª
        let trainingHours = 0;
        const startTime = document.getElementById('training-startTime')?.value;
        const endTime = document.getElementById('training-endTime')?.value;
        if (startTime && endTime) {
            try {
                const start = new Date(`2000-01-01 ${startTime}`);
                const end = new Date(`2000-01-01 ${endTime}`);
                trainingHours = (end - start) / (1000 * 60 * 60); // ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ Ø³Ø§Ø¹Ø§Øª
            } catch (e) {
                // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
            }
        }
        
        const trainingId = this.currentEditId || Utils.generateId('TRAINING');
        const formData = {
            id: trainingId,
            name: document.getElementById('training-name').value.trim(),
            trainer: document.getElementById('training-trainer').value.trim(),
            trainingType: document.getElementById('training-type').value || 'Ø¯Ø§Ø®Ù„ÙŠ', // Ù†ÙˆØ¹ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ (Ø¯Ø§Ø®Ù„ÙŠ/Ø®Ø§Ø±Ø¬ÙŠ)
            date: document.getElementById('training-date')?.value || document.getElementById('training-startDate').value,
            location: document.getElementById('training-location')?.value.trim() || '',
            startTime: startTime || '',
            endTime: endTime || '',
            hours: trainingHours > 0 ? trainingHours.toFixed(2) : '',
            startDate: new Date(document.getElementById('training-startDate').value).toISOString(),
            participants: participants,
            participantsCount: participants.length || parseInt(document.getElementById('training-participants').value) || 0,
            status: document.getElementById('training-status').value,
            createdAt: this.currentEditId ? AppState.appData.training.find(t => t.id === this.currentEditId)?.createdAt : new Date().toISOString(),
            updatedAt: new Date().toISOString()
        };

        Loading.show();
        try {
            if (this.currentEditId) {
                const index = AppState.appData.training.findIndex(t => t.id === this.currentEditId);
                if (index !== -1) {
                    AppState.appData.training[index] = formData;
                    Notification.success('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠ Ø¨Ù†Ø¬Ø§Ø­');
                }
            } else {
                AppState.appData.training.push(formData);
                Notification.success('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠ Ø¨Ù†Ø¬Ø§Ø­');
            }
            
            // ØªØ­Ø¯ÙŠØ« Ù…ØµÙÙˆÙØ© Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ù„ÙƒÙ„ Ù…ÙˆØ¸Ù Ù…Ø´Ø§Ø±Ùƒ
            if (!AppState.appData.employeeTrainingMatrix) {
                AppState.appData.employeeTrainingMatrix = {};
            }
            
            participants.forEach(participant => {
                const code = participant.code || participant.employeeNumber;
                if (code) {
                    if (!AppState.appData.employeeTrainingMatrix[code]) {
                        AppState.appData.employeeTrainingMatrix[code] = [];
                    }
                    
                    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ØªÙƒØ±Ø§Ø± Ø§Ù„ØªØ¯Ø±ÙŠØ¨
                    const existingTraining = AppState.appData.employeeTrainingMatrix[code].find(t => t.trainingId === trainingId);
                    if (!existingTraining) {
                        AppState.appData.employeeTrainingMatrix[code].push({
                            trainingId: trainingId,
                            trainingName: formData.name,
                            trainingType: formData.trainingType || 'Ø¯Ø§Ø®Ù„ÙŠ', // Ù†ÙˆØ¹ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ (Ø¯Ø§Ø®Ù„ÙŠ/Ø®Ø§Ø±Ø¬ÙŠ)
                            trainingDate: formData.date || formData.startDate,
                            status: formData.status,
                            hours: parseFloat(formData.hours || 0),
                            completed: formData.status === 'Ù…ÙƒØªÙ…Ù„',
                            location: formData.location,
                            trainer: formData.trainer
                        });
                    } else {
                        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯
                        existingTraining.trainingName = formData.name;
                        existingTraining.trainingType = formData.trainingType || 'Ø¯Ø§Ø®Ù„ÙŠ';
                        existingTraining.trainingDate = formData.date || formData.startDate;
                        existingTraining.status = formData.status;
                        existingTraining.hours = parseFloat(formData.hours || 0);
                        existingTraining.completed = formData.status === 'Ù…ÙƒØªÙ…Ù„';
                        existingTraining.location = formData.location;
                        existingTraining.trainer = formData.trainer;
                    }
                }
            });
            
            DataManager.save();
            // Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙÙŠ Google Sheets
            await GoogleIntegration.autoSave('Training', AppState.appData.training);
            Loading.hide();
            this.showList();
        } catch (error) {
            Loading.hide();
            Notification.error('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
        }
    },

    async editTraining(id) {
        this.currentEditId = id;
        const item = AppState.appData.training.find(i => i.id === id);
        if (item) await this.showForm(item);
    },

    async deleteTraining(id) {
        if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ØŸ')) return;
        Loading.show();
        try {
            AppState.appData.training = AppState.appData.training.filter(i => i.id !== id);
            DataManager.save();
            Loading.hide();
            Notification.success('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø¨Ù†Ø¬Ø§Ø­');
            this.loadTrainingList();
        } catch (error) {
            Loading.hide();
            Notification.error('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
        }
    }
};

// ===== Reports Module (Ù„Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªØµØ¯ÙŠØ± ÙÙ‚Ø·) =====
const Reports = {
    async generateAndExport(type) {
        // Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± PDF Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹
        const data = AppState.appData;
        let title = '';
        let content = '';

        switch(type) {
            case 'incidents':
                title = 'ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø­ÙˆØ§Ø¯Ø«';
                content = this.generateIncidentsReport(data.incidents || []);
                break;
            case 'training':
                title = 'ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªØ¯Ø±ÙŠØ¨';
                content = this.generateTrainingReport(data.training || []);
                break;
            case 'full':
                title = 'Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ø§Ù…Ù„';
                content = this.generateFullReport(data);
                break;
            default:
                throw new Error('Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ');
        }

        // Ø§Ø³ØªØ®Ø¯Ø§Ù… FormHeader.generatePDFHTML Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø´Ø¹Ø§Ø± ÙˆØ§Ù„ÙÙˆØªØ±
        const formCode = `REPORT-${type.toUpperCase()}-${new Date().toISOString().slice(0, 10)}`;
        const htmlContent = typeof FormHeader !== 'undefined' && FormHeader.generatePDFHTML
            ? FormHeader.generatePDFHTML(formCode, title, content, false, true, { version: '1.0' }, new Date().toISOString(), new Date().toISOString())
            : `<html><body>${content}</body></html>`;
        
        const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const printWindow = window.open(url, '_blank');
        
        if (printWindow) {
            printWindow.onload = () => {
                setTimeout(() => {
                    printWindow.print();
                    setTimeout(() => {
                        URL.revokeObjectURL(url);
                    }, 1000);
                }, 500);
            };
        } else {
            Notification.error('ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ù„Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±');
        }
    },

    generateIncidentsReport(incidents) {
        return `
            <div class="section-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­ÙˆØ§Ø¯Ø«: ${incidents.length}</div>
            <p style="margin-bottom: 20px; color: #666;">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: ${new Date().toLocaleDateString('ar-SA')}</p>
            <table>
                <thead>
                    <tr>
                        <th>ÙƒÙˆØ¯ ISO</th>
                        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                        <th>Ø§Ù„Ù…ÙˆÙ‚Ø¹</th>
                        <th>Ø§Ù„Ø®Ø·ÙˆØ±Ø©</th>
                        <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                        <th>Ø§Ù„ÙˆØµÙ</th>
                    </tr>
                </thead>
                <tbody>
                    ${incidents.map(incident => `
                        <tr>
                            <td>${Utils.escapeHTML(incident.isoCode || '')}</td>
                            <td>${incident.date ? Utils.formatDate(incident.date) : ''}</td>
                            <td>${Utils.escapeHTML(incident.location || '')}</td>
                            <td>${Utils.escapeHTML(incident.severity || '')}</td>
                            <td>${Utils.escapeHTML(incident.status || '')}</td>
                            <td>${Utils.escapeHTML((incident.description || '').substring(0, 100))}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
    },

    generateTrainingReport(training) {
        return `
            <div class="section-title">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„ØªØ¯Ø±ÙŠØ¨: ${training.length}</div>
            <p style="margin-bottom: 20px; color: #666;">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: ${new Date().toLocaleDateString('ar-SA')}</p>
            <table>
                <thead>
                    <tr>
                        <th>Ø§Ø³Ù… Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬</th>
                        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                        <th>Ø§Ù„Ù…Ø¯Ø±Ø¨</th>
                        <th>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†</th>
                        <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                    </tr>
                </thead>
                <tbody>
                    ${training.map(t => `
                        <tr>
                            <td>${Utils.escapeHTML(t.name || '')}</td>
                            <td>${t.startDate ? Utils.formatDate(t.startDate) : ''}</td>
                            <td>${Utils.escapeHTML(t.trainer || '')}</td>
                            <td>${t.participants?.length || t.participantsCount || 0}</td>
                            <td>${Utils.escapeHTML(t.status || '')}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
    },

    generateFullReport(data) {
        // Ø­Ø³Ø§Ø¨ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ØªØ¯Ø±ÙŠØ¨
        const training = data.training || [];
        const allParticipants = [];
        let totalTrainingHours = 0;
        
        training.forEach(t => {
            if (t.participants && Array.isArray(t.participants)) {
                t.participants.forEach(p => {
                    if (!allParticipants.find(ap => (ap.code || ap.employeeNumber) === (p.code || p.employeeNumber))) {
                        allParticipants.push(p);
                    }
                });
            }
            // Ø­Ø³Ø§Ø¨ Ø³Ø§Ø¹Ø§Øª Ø§Ù„ØªØ¯Ø±ÙŠØ¨ (Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹)
            if (t.hours) {
                totalTrainingHours += parseFloat(t.hours) || 0;
            } else if (t.duration) {
                totalTrainingHours += parseFloat(t.duration) || 0;
            } else if (t.startTime && t.endTime) {
                // Ø­Ø³Ø§Ø¨ Ø§Ù„ÙØ±Ù‚ Ø¨ÙŠÙ† Ø§Ù„ÙˆÙ‚ØªÙŠÙ†
                try {
                    const start = new Date(`2000-01-01 ${t.startTime}`);
                    const end = new Date(`2000-01-01 ${t.endTime}`);
                    const diff = (end - start) / (1000 * 60 * 60); // ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ Ø³Ø§Ø¹Ø§Øª
                    totalTrainingHours += diff || 0;
                } catch (e) {
                    // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
                }
            }
        });
        
        const uniqueTrainees = allParticipants.length || training.reduce((acc, t) => acc + (t.participantsCount || 0), 0);
        const avgTrainingHours = uniqueTrainees > 0 ? (totalTrainingHours / uniqueTrainees).toFixed(2) : 0;
        
        // Ø­Ø³Ø§Ø¨ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª
        const violations = data.violations || [];
        const employeeViolations = violations.filter(v => v.violationType === 'Ù…ÙˆØ¸Ù' || v.category === 'Ù…ÙˆØ¸Ù' || (!v.contractorName && v.employeeName));
        const contractorViolations = violations.filter(v => v.violationType === 'Ù…Ù‚Ø§ÙˆÙ„' || v.category === 'Ù…Ù‚Ø§ÙˆÙ„' || v.contractorName);
        const violationsByDepartment = {};
        
        violations.forEach(v => {
            const dept = v.department || v.employeeDepartment || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
            violationsByDepartment[dept] = (violationsByDepartment[dept] || 0) + 1;
        });
        
        const violationsByDeptHTML = Object.keys(violationsByDepartment).map(dept => 
            `<tr><td>${Utils.escapeHTML(dept)}</td><td>${violationsByDepartment[dept]}</td></tr>`
        ).join('');
        
        return `
            <div class="section-title">Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ø§Ù…Ø©</div>
            <p style="margin-bottom: 20px; color: #666;">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: ${new Date().toLocaleDateString('ar-SA')}</p>
            
            <h3 style="margin-top: 30px; margin-bottom: 15px; font-weight: bold; color: #333;">Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</h3>
            <table style="margin-bottom: 30px;">
                <thead>
                    <tr>
                        <th>Ø§Ù„Ù†ÙˆØ¹</th>
                        <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Ø§Ù„Ø­ÙˆØ§Ø¯Ø«</td>
                        <td>${(data.incidents || []).length}</td>
                    </tr>
                    <tr>
                        <td>Ø§Ù„Ø­ÙˆØ§Ø¯Ø« Ø§Ù„ÙˆØ´ÙŠÙƒØ©</td>
                        <td>${(data.nearmiss || []).length}</td>
                    </tr>
                    <tr>
                        <td>ØªØµØ§Ø±ÙŠØ­ Ø§Ù„Ø¹Ù…Ù„</td>
                        <td>${(data.ptw || []).length}</td>
                    </tr>
                    <tr>
                        <td>Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„ØªØ¯Ø±ÙŠØ¨</td>
                        <td>${training.length}</td>
                    </tr>
                    <tr>
                        <td>Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª</td>
                        <td>${violations.length}</td>
                    </tr>
                    <tr>
                        <td>Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¹ÙŠØ§Ø¯ÙŠØ©</td>
                        <td>${(data.clinicVisits || []).length}</td>
                    </tr>
                </tbody>
            </table>
            
            <h3 style="margin-top: 30px; margin-bottom: 15px; font-weight: bold; color: #333;">Ø¨Ù†Ø¯ Ø§Ù„ØªØ¯Ø±ÙŠØ¨</h3>
            <table style="margin-bottom: 30px;">
                <thead>
                    <tr>
                        <th>Ø§Ù„Ù…Ø¤Ø´Ø±</th>
                        <th>Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Ø¹Ø¯Ø¯ Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ†</td>
                        <td>${uniqueTrainees}</td>
                    </tr>
                    <tr>
                        <td>Ù…ØªÙˆØ³Ø· Ø³Ø§Ø¹Ø§Øª Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ù„Ù„Ù…ÙˆØ¸Ù</td>
                        <td>${avgTrainingHours} Ø³Ø§Ø¹Ø©</td>
                    </tr>
                    <tr>
                        <td>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø³Ø§Ø¹Ø§Øª Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</td>
                        <td>${totalTrainingHours.toFixed(2)} Ø³Ø§Ø¹Ø©</td>
                    </tr>
                </tbody>
            </table>
            
            <h3 style="margin-top: 30px; margin-bottom: 15px; font-weight: bold; color: #333;">Ø¨Ù†Ø¯ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª</h3>
            <table style="margin-bottom: 30px;">
                <thead>
                    <tr>
                        <th>Ø§Ù„Ù…Ø¤Ø´Ø±</th>
                        <th>Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª Ù„Ù„Ù…ÙˆØ¸ÙÙŠÙ†</td>
                        <td>${employeeViolations.length}</td>
                    </tr>
                    <tr>
                        <td>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª Ù„Ù„Ù…Ù‚Ø§ÙˆÙ„ÙŠÙ†</td>
                        <td>${contractorViolations.length}</td>
                    </tr>
                </tbody>
            </table>
            
            ${violationsByDeptHTML ? `
            <h3 style="margin-top: 30px; margin-bottom: 15px; font-weight: bold; color: #333;">Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª Ø­Ø³Ø¨ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h3>
            <table style="margin-bottom: 30px;">
                <thead>
                    <tr>
                        <th>Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</th>
                        <th>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª</th>
                    </tr>
                </thead>
                <tbody>
                    ${violationsByDeptHTML}
                </tbody>
            </table>
            ` : ''}
        `;
    }
};

// ===== Settings Module =====
const Settings = {
    async load() {
        const section = document.getElementById('settings-section');
        if (!section) return;

        section.innerHTML = `
            <div class="section-header">
                <h1 class="section-title">
                    <i class="fas fa-cog ml-3"></i>
                    Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
                </h1>
                <p class="section-subtitle">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… ÙˆØ§Ù„ØªÙƒØ§Ù…Ù„</p>
            </div>
            <div class="mt-6">
                <div class="content-card">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-cloud ml-2"></i>ØªÙƒØ§Ù…Ù„ Google</h2>
                    </div>
                    <div class="card-body">
                        <form id="google-settings-form" class="space-y-6">
                            <div>
                                <label class="flex items-center mb-4">
                                    <input type="checkbox" id="google-apps-script-enabled" class="rounded border-gray-300 text-blue-600"
                                        ${AppState.googleConfig.appsScript.enabled ? 'checked' : ''}>
                                    <span class="mr-2 text-sm text-gray-700">ØªÙØ¹ÙŠÙ„ Google Apps Script</span>
                                </label>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <i class="fas fa-link ml-2"></i>
                                    Ø±Ø§Ø¨Ø· Google Apps Script *
                                </label>
                                <input type="url" id="google-apps-script-url" class="form-input"
                                    value="${AppState.googleConfig.appsScript.scriptUrl || ''}"
                                    placeholder="https://script.google.com/macros/s/.../exec">
                            </div>
                            <div>
                                <label class="flex items-center mb-4">
                                    <input type="checkbox" id="google-sheets-enabled" class="rounded border-gray-300 text-blue-600"
                                        ${AppState.googleConfig.sheets.enabled ? 'checked' : ''}>
                                    <span class="mr-2 text-sm text-gray-700">ØªÙØ¹ÙŠÙ„ Google Sheets</span>
                                </label>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <i class="fas fa-table ml-2"></i>
                                    Ù…Ø¹Ø±Ù Google Sheets
                                </label>
                                <input type="text" id="google-sheets-id" class="form-input"
                                    value="${AppState.googleConfig.sheets.spreadsheetId || ''}"
                                    placeholder="Ù…Ø¹Ø±Ù Ø§Ù„Ø¬Ø¯ÙˆÙ„">
                            </div>
                            <div class="flex items-center justify-end gap-4 pt-4 border-t">
                                <button type="button" id="test-connection-btn" class="btn-secondary">
                                    <i class="fas fa-plug ml-2"></i>
                                    Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„
                                </button>
                                <button type="submit" class="btn-primary">
                                    <i class="fas fa-save ml-2"></i>
                                    Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                <div class="content-card mt-6">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-sync ml-2"></i>Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© ÙˆØ§Ù„Ø¥Ø¹Ø¯Ø§Ø¯</h2>
                    </div>
                    <div class="card-body space-y-4">
                        <div>
                            <p class="text-sm text-gray-600 mb-4">
                                <i class="fas fa-info-circle ml-2"></i>
                                Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (Users, Incidents, NearMiss, PTW, Training, Clinic, Fire Equipment, PPE, Violations, Contractors) ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù…Ø¹ Ø§Ù„Ø±Ø¤ÙˆØ³ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
                            </p>
                            <button id="initialize-sheets-btn" class="btn-primary w-full">
                                <i class="fas fa-magic ml-2"></i>
                                Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
                            </button>
                        </div>
                        <div class="border-t pt-4">
                            <button id="sync-data-btn" class="btn-primary w-full">
                                <i class="fas fa-sync ml-2"></i>
                                Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹ Google Sheets (Ù‚Ø±Ø§Ø¡Ø©)
                            </button>
                        </div>
                        <div class="border-t pt-4">
                            <button id="save-all-data-btn" class="btn-success w-full">
                                <i class="fas fa-cloud-upload-alt ml-2"></i>
                                Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Google Sheets (ÙƒØªØ§Ø¨Ø©)
                            </button>
                        </div>
                    </div>
                </div>
                <div class="content-card mt-6">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-file-pdf ml-2"></i>Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</h2>
                    </div>
                    <div class="card-body space-y-4">
                        <p class="text-sm text-gray-600 mb-4">
                            <i class="fas fa-info-circle ml-2"></i>
                            Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø§Ø±ÙŠØ± PDF Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                        </p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <button id="generate-incidents-report-btn" class="btn-secondary w-full">
                                <i class="fas fa-file-pdf ml-2"></i>
                                ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø­ÙˆØ§Ø¯Ø«
                            </button>
                            <button id="generate-training-report-btn" class="btn-secondary w-full">
                                <i class="fas fa-file-pdf ml-2"></i>
                                ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªØ¯Ø±ÙŠØ¨
                            </button>
                            <button id="generate-ptw-report-btn" class="btn-secondary w-full">
                                <i class="fas fa-file-pdf ml-2"></i>
                                ØªÙ‚Ø±ÙŠØ± ØªØµØ§Ø±ÙŠØ­ Ø§Ù„Ø¹Ù…Ù„
                            </button>
                            <button id="generate-full-report-btn" class="btn-primary w-full">
                                <i class="fas fa-file-pdf ml-2"></i>
                                ØªÙ‚Ø±ÙŠØ± Ø´Ø§Ù…Ù„ (Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª)
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="content-card mt-6">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-calendar-alt ml-2"></i>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ§Ø±ÙŠØ®</h2>
                    </div>
                    <div class="card-body space-y-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                <i class="fas fa-calendar-check ml-2"></i>
                                Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚ÙˆÙŠÙ…
                            </label>
                            <select id="date-format-select" class="form-input">
                                <option value="gregorian" ${AppState.dateFormat === 'gregorian' ? 'selected' : ''}>Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ÙŠ (Gregorian)</option>
                                <option value="hijri" ${AppState.dateFormat === 'hijri' ? 'selected' : ''}>Ø§Ù„Ù‡Ø¬Ø±ÙŠ (Hijri)</option>
                            </select>
                            <p class="text-xs text-gray-500 mt-1">
                                <i class="fas fa-info-circle ml-1"></i>
                                Ø³ÙŠØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚ÙˆÙŠÙ… Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…
                            </p>
                            <button type="button" id="save-date-format-btn" class="btn-primary mt-2">
                                <i class="fas fa-save ml-2"></i>Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ§Ø±ÙŠØ®
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="content-card mt-6">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-image ml-2"></i>Ø´Ø¹Ø§Ø± Ø§Ù„Ø´Ø±ÙƒØ©</h2>
                    </div>
                    <div class="card-body space-y-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                <i class="fas fa-upload ml-2"></i>
                                Ø±ÙØ¹ Ø´Ø¹Ø§Ø± Ø§Ù„Ø´Ø±ÙƒØ©
                            </label>
                            <div class="flex items-center gap-4">
                                ${AppState.companyLogo ? `
                                    <div class="flex-shrink-0">
                                        <img src="${AppState.companyLogo}" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ø´Ø±ÙƒØ©" id="company-logo-preview" 
                                            class="w-32 h-32 object-contain border border-gray-300 rounded p-2 bg-white">
                                    </div>
                                ` : ''}
                                <div class="flex-1">
                                    <input type="file" id="company-logo-input" accept="image/*" class="form-input text-sm">
                                    <p class="text-xs text-gray-500 mt-1">
                                        <i class="fas fa-info-circle ml-1"></i>
                                        Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø¹Ø§Ø± ÙÙŠ ÙŠØ³Ø§Ø± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ ÙˆØ§Ù„ØµÙØ­Ø§Øª. Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø©: 2MB
                                    </p>
                                    <button type="button" id="upload-logo-btn" class="btn-primary mt-2">
                                        <i class="fas fa-upload ml-2"></i>Ø±ÙØ¹ Ø§Ù„Ø´Ø¹Ø§Ø±
                                    </button>
                                    ${AppState.companyLogo ? `
                                        <button type="button" id="remove-logo-btn" class="btn-secondary mt-2 mr-2">
                                            <i class="fas fa-trash ml-2"></i>Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø´Ø¹Ø§Ø±
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="content-card mt-6">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-envelope ml-2"></i>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©</h2>
                    </div>
                    <div class="card-body space-y-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                <i class="fas fa-envelope-open-text ml-2"></i>
                                Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„Ø§Øª Ù„Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
                            </label>
                            <p class="text-xs text-gray-500 mb-2">
                                <i class="fas fa-info-circle ml-1"></i>
                                Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¥Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ø³Ø¬Ù„Ø© Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ù…Ù„Ø§Ø­Ø¸Ø© Ø£Ùˆ ØªÙ†Ø¨ÙŠÙ‡
                            </p>
                            <div id="notification-emails-list" class="space-y-2 mb-3">
                                ${(AppState.notificationEmails || []).map((email, index) => `
                                    <div class="flex items-center gap-2 p-2 border rounded bg-gray-50">
                                        <span class="flex-1">${Utils.escapeHTML(email)}</span>
                                        <button type="button" onclick="Settings.removeNotificationEmail(${index})" class="text-red-600 hover:text-red-800">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                `).join('')}
                            </div>
                            <div class="flex gap-2">
                                <input type="email" id="notification-email-input" class="form-input flex-1" 
                                    placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ù„Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª">
                                <button type="button" id="add-notification-email-btn" class="btn-primary">
                                    <i class="fas fa-plus ml-2"></i>Ø¥Ø¶Ø§ÙØ© Ø¥ÙŠÙ…ÙŠÙ„
                                </button>
                            </div>
                            <button type="button" id="save-notification-emails-btn" class="btn-primary mt-2">
                                <i class="fas fa-save ml-2"></i>Ø­ÙØ¸ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„Ø§Øª
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="content-card mt-6">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-shield-alt ml-2"></i>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª</h2>
                    </div>
                    <div class="card-body space-y-4">
                        <div class="bg-blue-50 border border-blue-200 rounded p-4 mb-4">
                            <p class="text-sm text-blue-800 mb-2">
                                <i class="fas fa-info-circle ml-2"></i>
                                <strong>Ù…Ù„Ø§Ø­Ø¸Ø© Ù…Ù‡Ù…Ø©:</strong>
                            </p>
                            <ul class="text-sm text-blue-700 list-disc mr-6 space-y-1">
                                <li>Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù‚Ø³Ù… Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø­Ø¸ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø¹Ø§Ø¯ÙŠÙŠÙ†</li>
                                <li>ÙÙ‚Ø· Ø§Ù„Ù…Ø¯ÙŠØ±ÙˆÙ† ÙˆØ§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙˆÙ† Ø§Ù„Ù…ØµØ±Ø­ Ù„Ù‡Ù… ÙŠÙ…ÙƒÙ†Ù‡Ù… Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</li>
                                <li>ÙŠÙ…ÙƒÙ† Ø¥Ø¯Ø§Ø±Ø© ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„ÙˆØµÙˆÙ„ Ù…Ù† Ù‚Ø³Ù… "Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†" Ø¹Ù†Ø¯ Ø¥Ø¶Ø§ÙØ© Ø£Ùˆ ØªØ¹Ø¯ÙŠÙ„ Ù…Ø³ØªØ®Ø¯Ù…</li>
                                <li>Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©: Ø§Ù„Ù…Ø¯ÙŠØ±ÙˆÙ† ÙÙ‚Ø· ÙŠÙ…ÙƒÙ†Ù‡Ù… Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</li>
                            </ul>
                        </div>
                        
                        <div class="border rounded p-4">
                            <h3 class="text-lg font-semibold mb-4">
                                <i class="fas fa-users-cog ml-2"></i>
                                Ù…Ù† ÙŠÙ…ÙƒÙ†Ù‡ Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
                            </h3>
                            <div class="space-y-3">
                                <div class="flex items-center justify-between p-3 bg-gray-50 rounded">
                                    <div class="flex items-center">
                                        <i class="fas fa-user-shield text-blue-600 ml-3"></i>
                                        <span class="font-semibold">Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù… (Admin)</span>
                                    </div>
                                    <span class="badge badge-success">ØµÙ„Ø§Ø­ÙŠØ© ÙƒØ§Ù…Ù„Ø©</span>
                                </div>
                                <div class="flex items-center justify-between p-3 bg-gray-50 rounded">
                                    <div class="flex items-center">
                                        <i class="fas fa-user-check text-green-600 ml-3"></i>
                                        <span class="font-semibold">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ø§Ù„Ù…ØµØ±Ø­ Ù„Ù‡Ù…</span>
                                    </div>
                                    <span class="badge badge-info">Ø­Ø³Ø¨ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª</span>
                                </div>
                                <div class="flex items-center justify-between p-3 bg-gray-50 rounded">
                                    <div class="flex items-center">
                                        <i class="fas fa-user-times text-red-600 ml-3"></i>
                                        <span class="font-semibold">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ø§Ù„Ø¹Ø§Ø¯ÙŠÙˆÙ†</span>
                                    </div>
                                    <span class="badge badge-warning">ØºÙŠØ± Ù…ØµØ±Ø­</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="border-t pt-4 mt-4">
                            <h3 class="text-lg font-semibold mb-4">
                                <i class="fas fa-key ml-2"></i>
                                ÙƒÙŠÙÙŠØ© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
                            </h3>
                            <div class="space-y-2 text-sm text-gray-700">
                                <p class="flex items-start">
                                    <i class="fas fa-check-circle text-green-600 ml-2 mt-1"></i>
                                    <span>Ø§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰ Ù‚Ø³Ù… "Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†" Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©</span>
                                </p>
                                <p class="flex items-start">
                                    <i class="fas fa-check-circle text-green-600 ml-2 mt-1"></i>
                                    <span>Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯" Ø£Ùˆ Ø§Ø®ØªØ± Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ Ù„Ù„ØªØ­Ø±ÙŠØ±</span>
                                </p>
                                <p class="flex items-start">
                                    <i class="fas fa-check-circle text-green-600 ml-2 mt-1"></i>
                                    <span>ÙÙŠ Ù‚Ø³Ù… "ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙˆØ­Ø¯Ø§Øª"ØŒ Ø­Ø¯Ø¯ "Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª" Ù„Ø¥Ø¹Ø·Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙˆØµÙˆÙ„</span>
                                </p>
                                <p class="flex items-start">
                                    <i class="fas fa-check-circle text-green-600 ml-2 mt-1"></i>
                                    <span>Ø§Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</span>
                                </p>
                            </div>
                        </div>
                        
                        <div class="border-t pt-4 mt-4">
                            <h3 class="text-lg font-semibold mb-4">
                                <i class="fas fa-list-check ml-2"></i>
                                Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
                            </h3>
                            <div id="users-permissions-list" class="space-y-2">
                                ${this.renderUsersPermissionsList()}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        this.setupEventListeners();
    },

    setupEventListeners() {
        setTimeout(() => {
            const form = document.getElementById('google-settings-form');
            if (form) {
                form.addEventListener('submit', (e) => this.handleSubmit(e));
            }
            const testBtn = document.getElementById('test-connection-btn');
            if (testBtn) {
                testBtn.addEventListener('click', () => this.testConnection());
            }
            const syncBtn = document.getElementById('sync-data-btn');
            if (syncBtn) {
                syncBtn.addEventListener('click', () => GoogleIntegration.syncData());
            }
            const initializeBtn = document.getElementById('initialize-sheets-btn');
            if (initializeBtn) {
                initializeBtn.addEventListener('click', () => Settings.initializeSheets());
            }
            const saveAllBtn = document.getElementById('save-all-data-btn');
            if (saveAllBtn) {
                saveAllBtn.addEventListener('click', async () => {
                    if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Google SheetsØŸ\nØ³ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©.')) {
                        await GoogleIntegration.saveAllToSheets();
                    }
                });
            }
            // Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
            const generateIncidentsBtn = document.getElementById('generate-incidents-report-btn');
            if (generateIncidentsBtn) {
                generateIncidentsBtn.addEventListener('click', () => Settings.generateReport('incidents'));
            }
            const generateTrainingBtn = document.getElementById('generate-training-report-btn');
            if (generateTrainingBtn) {
                generateTrainingBtn.addEventListener('click', () => Settings.generateReport('training'));
            }
            const generatePTWBtn = document.getElementById('generate-ptw-report-btn');
            if (generatePTWBtn) {
                generatePTWBtn.addEventListener('click', () => Settings.generateReport('ptw'));
            }
            const generateFullBtn = document.getElementById('generate-full-report-btn');
            if (generateFullBtn) {
                generateFullBtn.addEventListener('click', () => Settings.generateReport('full'));
            }
            
            // Logo upload
            const uploadLogoBtn = document.getElementById('upload-logo-btn');
            const logoInput = document.getElementById('company-logo-input');
            const removeLogoBtn = document.getElementById('remove-logo-btn');
            
            if (uploadLogoBtn && logoInput) {
                uploadLogoBtn.addEventListener('click', () => {
                    logoInput.click();
                });
                
                logoInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    if (file.size > 2 * 1024 * 1024) {
                        Notification.error('Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹. Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 2MB');
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        AppState.companyLogo = event.target.result;
                        DataManager.save();
                        Notification.success('ØªÙ… Ø±ÙØ¹ Ø§Ù„Ø´Ø¹Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­');
                        Settings.load();
                    };
                    reader.onerror = () => {
                        Notification.error('ÙØ´Ù„ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ØµÙˆØ±Ø©');
                    };
                    reader.readAsDataURL(file);
                });
            }
            
            if (removeLogoBtn) {
                removeLogoBtn.addEventListener('click', () => {
                    if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø²Ø§Ù„Ø© Ø´Ø¹Ø§Ø± Ø§Ù„Ø´Ø±ÙƒØ©ØŸ')) {
                        AppState.companyLogo = '';
                        DataManager.save();
                        Notification.success('ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø´Ø¹Ø§Ø±');
                        Settings.load();
                    }
                });
            }
            
            // Date format
            const dateFormatSelect = document.getElementById('date-format-select');
            const saveDateFormatBtn = document.getElementById('save-date-format-btn');
            
            if (saveDateFormatBtn && dateFormatSelect) {
                saveDateFormatBtn.addEventListener('click', () => {
                    AppState.dateFormat = dateFormatSelect.value;
                    DataManager.save();
                    Notification.success('ØªÙ… Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¨Ù†Ø¬Ø§Ø­');
                });
            }
            
            // Ø¥Ø¶Ø§ÙØ© Ø¥ÙŠÙ…ÙŠÙ„ Ù„Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
            const addEmailBtn = document.getElementById('add-notification-email-btn');
            const emailInput = document.getElementById('notification-email-input');
            if (addEmailBtn && emailInput) {
                addEmailBtn.addEventListener('click', () => {
                    const email = emailInput.value.trim().toLowerCase();
                    if (!email || !Utils.isValidEmail(email)) {
                        Notification.error('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¥ÙŠÙ…ÙŠÙ„ ØµØ­ÙŠØ­');
                        return;
                    }
                    
                    if (!AppState.notificationEmails) {
                        AppState.notificationEmails = [];
                    }
                    
                    if (AppState.notificationEmails.includes(email)) {
                        Notification.warning('Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹');
                        return;
                    }
                    
                    AppState.notificationEmails.push(email);
                    emailInput.value = '';
                    DataManager.save();
                    
                    const list = document.getElementById('notification-emails-list');
                    if (list) {
                        const emailDiv = document.createElement('div');
                        emailDiv.className = 'flex items-center gap-2 p-2 border rounded bg-gray-50';
                        emailDiv.innerHTML = `
                            <span class="flex-1">${Utils.escapeHTML(email)}</span>
                            <button type="button" onclick="Settings.removeNotificationEmail(${AppState.notificationEmails.length - 1})" class="text-red-600 hover:text-red-800">
                                <i class="fas fa-times"></i>
                            </button>
                        `;
                        list.appendChild(emailDiv);
                    }
                    
                    Notification.success('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­');
                });
            }
            
            // Ø­ÙØ¸ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„Ø§Øª
            const saveEmailsBtn = document.getElementById('save-notification-emails-btn');
            if (saveEmailsBtn) {
                saveEmailsBtn.addEventListener('click', () => {
                    DataManager.save();
                    Notification.success('ØªÙ… Ø­ÙØ¸ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
                });
            }
        }, 100);
    },

    renderUsersPermissionsList() {
        const users = AppState.appData.users || [];
        if (users.length === 0) {
            return `
                <div class="text-center text-gray-500 py-4">
                    <i class="fas fa-users text-3xl mb-2"></i>
                    <p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø­Ø§Ù„ÙŠØ§Ù‹</p>
                </div>
            `;
        }
        
        return users.map(user => {
            const hasSettingsAccess = this.hasAccessForUser(user, 'settings');
            const roleBadge = user.role === 'admin' ? 'badge-danger' : 
                             user.role === 'safety_officer' ? 'badge-warning' : 'badge-info';
            const roleText = user.role === 'admin' ? 'Ù…Ø¯ÙŠØ±' : 
                           user.role === 'safety_officer' ? 'Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ø³Ù„Ø§Ù…Ø©' : 'Ù…Ø³ØªØ®Ø¯Ù…';
            
            return `
                <div class="flex items-center justify-between p-3 border rounded hover:bg-gray-50">
                    <div class="flex items-center flex-1">
                        <div class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center ml-3">
                            ${user.photo ? 
                                `<img src="${user.photo}" alt="${Utils.escapeHTML(user.name)}" class="w-full h-full rounded-full object-cover">` :
                                `<i class="fas fa-user text-gray-600"></i>`
                            }
                        </div>
                        <div class="flex-1">
                            <div class="font-semibold">${Utils.escapeHTML(user.name || '')}</div>
                            <div class="text-sm text-gray-600">${Utils.escapeHTML(user.email || '')}</div>
                        </div>
                        <div class="mr-4">
                            <span class="badge ${roleBadge}">${roleText}</span>
                        </div>
                    </div>
                    <div class="flex items-center">
                        <span class="badge ${hasSettingsAccess ? 'badge-success' : 'badge-warning'} mr-3">
                            ${hasSettingsAccess ? 
                                '<i class="fas fa-check-circle ml-1"></i> Ù„Ø¯ÙŠÙ‡ ØµÙ„Ø§Ø­ÙŠØ©' : 
                                '<i class="fas fa-times-circle ml-1"></i> Ù„Ø§ ÙŠÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ©'
                            }
                        </span>
                        <button onclick="Settings.viewUserPermissions('${user.id}')" 
                                class="btn-icon btn-icon-primary" 
                                title="Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
            `;
        }).join('');
    },

    viewUserPermissions(userId) {
        const user = AppState.appData.users.find(u => u.id === userId);
        if (!user) {
            Notification.error('Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
            return;
        }
        
        const hasSettingsAccess = this.hasAccessForUser(user, 'settings');
        const permissions = user.permissions || {};
        const allModules = [
            { key: 'dashboard', label: 'Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…' },
            { key: 'incidents', label: 'Ø§Ù„Ø­ÙˆØ§Ø¯Ø«' },
            { key: 'nearmiss', label: 'Ø§Ù„Ø­ÙˆØ§Ø¯Ø« Ø§Ù„ÙˆØ´ÙŠÙƒØ©' },
            { key: 'ptw', label: 'ØªØµØ§Ø±ÙŠØ­ Ø§Ù„Ø¹Ù…Ù„' },
            { key: 'training', label: 'Ø§Ù„ØªØ¯Ø±ÙŠØ¨' },
            { key: 'clinic', label: 'Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©' },
            { key: 'fire-equipment', label: 'Ù…Ø¹Ø¯Ø§Øª Ø§Ù„Ø¥Ø·ÙØ§Ø¡' },
            { key: 'ppe', label: 'Ù…Ù‡Ù…Ø§Øª Ø§Ù„ÙˆÙ‚Ø§ÙŠØ©' },
            { key: 'violations', label: 'Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª' },
            { key: 'contractors', label: 'Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ÙŠÙ†' },
            { key: 'employees', label: 'Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†' },
            { key: 'behavior-monitoring', label: 'Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ØªØµØ±ÙØ§Øª' },
            { key: 'chemical-safety', label: 'Ø§Ù„Ø³Ù„Ø§Ù…Ø© Ø§Ù„ÙƒÙŠÙ…ÙŠØ§Ø¦ÙŠØ©' },
            { key: 'daily-observations', label: 'Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©' },
            { key: 'iso', label: 'Ù†Ø¸Ø§Ù… ISO' },
            { key: 'emergency', label: 'ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø·ÙˆØ§Ø±Ø¦' },
            { key: 'users', label: 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†' },
            { key: 'settings', label: 'Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª' }
        ];
        
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 700px;">
                <div class="modal-header">
                    <h2 class="modal-title">
                        <i class="fas fa-shield-alt ml-2"></i>
                        ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${Utils.escapeHTML(user.name)}
                    </h2>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="space-y-4">
                        <div class="bg-blue-50 border border-blue-200 rounded p-4">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="font-semibold text-blue-800">${Utils.escapeHTML(user.name)}</p>
                                    <p class="text-sm text-blue-600">${Utils.escapeHTML(user.email)}</p>
                                </div>
                                <div class="text-left">
                                    <span class="badge ${user.role === 'admin' ? 'badge-danger' : user.role === 'safety_officer' ? 'badge-warning' : 'badge-info'}">
                                        ${user.role === 'admin' ? 'Ù…Ø¯ÙŠØ±' : user.role === 'safety_officer' ? 'Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ø³Ù„Ø§Ù…Ø©' : 'Ù…Ø³ØªØ®Ø¯Ù…'}
                                    </span>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <h3 class="font-semibold mb-3">ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙˆØ­Ø¯Ø§Øª:</h3>
                            <div class="grid grid-cols-2 gap-2">
                                ${allModules.map(module => {
                                    const hasPermission = this.hasAccessForUser(user, module.key);
                                    return `
                                        <div class="flex items-center justify-between p-2 border rounded ${hasPermission ? 'bg-green-50' : 'bg-gray-50'}">
                                            <span class="text-sm">${module.label}</span>
                                            ${hasPermission ? 
                                                '<i class="fas fa-check-circle text-green-600"></i>' : 
                                                '<i class="fas fa-times-circle text-gray-400"></i>'
                                            }
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="this.closest('.modal-overlay').remove()">Ø¥ØºÙ„Ø§Ù‚</button>
                    <button type="button" class="btn-primary" onclick="UI.showSection('users'); this.closest('.modal-overlay').remove(); setTimeout(() => Users.editUser('${user.id}'), 500);">
                        <i class="fas fa-edit ml-2"></i>
                        ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
                    </button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
        });
    },

    hasAccessForUser(user, moduleName) {
        // Ù…Ø­Ø§ÙƒØ§Ø© Ù†ÙØ³ Ù…Ù†Ø·Ù‚ Permissions.hasAccess Ù„ÙƒÙ† Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­Ø¯Ø¯
        if (user.role === 'admin') return true;
        
        if (user.permissions && user.permissions.hasOwnProperty(moduleName)) {
            return user.permissions[moduleName] === true;
        }
        
        // Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø¯ÙˆØ± - Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¹Ø§Ø¯ÙŠ Ù„Ø§ ÙŠÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
        const defaultPermissions = {
            'safety_officer': {
                'dashboard': true, 'incidents': true, 'nearmiss': true, 'ptw': true, 'training': true,
                'clinic': false, 'fire-equipment': true, 'ppe': true, 'violations': true, 'contractors': true,
                'employees': true, 'behavior-monitoring': true, 'chemical-safety': true, 'daily-observations': true,
                'iso': false, 'emergency': true, 'users': false, 'settings': false
            },
            'user': {
                // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¹Ø§Ø¯ÙŠ Ù„Ø§ ÙŠÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ© - ÙŠØ¬Ø¨ Ù…Ù†Ø­Ù‡Ø§ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø¯ÙŠØ±
                'dashboard': true, // ÙÙ‚Ø· Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
                'incidents': false, 'nearmiss': false, 'ptw': false, 'training': false,
                'clinic': false, 'fire-equipment': false, 'ppe': false, 'violations': false, 'contractors': false,
                'employees': false, 'behavior-monitoring': false, 'chemical-safety': false, 'daily-observations': false,
                'iso': false, 'emergency': false, 'users': false, 'settings': false
            }
        };
        
        const rolePermissions = defaultPermissions[user.role] || {};
        return rolePermissions[moduleName] === true;
    },

    async handleSubmit(e) {
        e.preventDefault();
        AppState.googleConfig.appsScript.enabled = document.getElementById('google-apps-script-enabled').checked;
        AppState.googleConfig.appsScript.scriptUrl = document.getElementById('google-apps-script-url').value.trim();
        AppState.googleConfig.sheets.enabled = document.getElementById('google-sheets-enabled').checked;
        AppState.googleConfig.sheets.spreadsheetId = document.getElementById('google-sheets-id').value.trim();

        DataManager.saveGoogleConfig();
        Notification.success('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
    },

    async testConnection() {
        Loading.show();
        try {
            if (AppState.googleConfig.appsScript.enabled && AppState.googleConfig.appsScript.scriptUrl) {
                const result = await GoogleIntegration.readFromSheets('Users');
                Loading.hide();
                Notification.success('Ø§Ù„Ø§ØªØµØ§Ù„ Ù†Ø¬Ø­! ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ' + result.length + ' Ø³Ø¬Ù„');
            } else {
                Loading.hide();
                Notification.error('ÙŠØ±Ø¬Ù‰ ØªÙØ¹ÙŠÙ„ Google Apps Script ÙˆØ¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ø§Ø¨Ø·');
            }
        } catch (error) {
            Loading.hide();
            Notification.error('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„: ' + error.message);
        }
    },

    async initializeSheets() {
        if (!AppState.googleConfig.appsScript.enabled) {
            Notification.error('ÙŠØ±Ø¬Ù‰ ØªÙØ¹ÙŠÙ„ Google Apps Script Ø£ÙˆÙ„Ø§Ù‹');
            return;
        }

        if (!AppState.googleConfig.sheets.spreadsheetId) {
            Notification.error('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¹Ø±Ù Google Sheets Ø£ÙˆÙ„Ø§Ù‹');
            return;
        }

        const sheetsList = 'Users, Incidents, NearMiss, PTW, Training, ClinicVisits, Medications, SickLeave, ClinicInventory, FireEquipment, PPE, Violations, Contractors, Employees, BehaviorMonitoring, ChemicalSafety, DailyObservations, ISODocuments, ISOProcedures, ISOForms, EmergencyAlerts, EmergencyPlans';
        
        if (!confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ØŸ\n\nØ³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡:\n${sheetsList.split(', ').map(s => `- ${s}`).join('\n')}`)) {
            return;
        }

        try {
            Loading.show();
            await GoogleIntegration.initializeSheets();
            Loading.hide();
            Notification.success('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ Ø¨Ù†Ø¬Ø§Ø­');
        } catch (error) {
            Loading.hide();
            console.error('ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø£ÙˆØ±Ø§Ù‚:', error);
            Notification.error('ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø£ÙˆØ±Ø§Ù‚: ' + error.message);
        }
    },

    async generateReport(type) {
        Loading.show();
        try {
            await Reports.generateAndExport(type);
            Loading.hide();
            Notification.success('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­');
        } catch (error) {
            Loading.hide();
            Notification.error('ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ±: ' + error.message);
        }
    },
    
    removeNotificationEmail(index) {
        if (AppState.notificationEmails && AppState.notificationEmails[index]) {
            AppState.notificationEmails.splice(index, 1);
            DataManager.save();
            this.load(); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ø¯Ø«Ø©
        }
    },
    
    setupSettingsListeners() {
        setTimeout(() => {
            // Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ§Ø±ÙŠØ®
            const saveDateBtn = document.getElementById('save-date-format-btn');
            if (saveDateBtn) {
                saveDateBtn.addEventListener('click', () => {
                    const dateFormat = document.getElementById('date-format-select').value;
                    AppState.dateFormat = dateFormat;
                    DataManager.save();
                    Notification.success('ØªÙ… Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¨Ù†Ø¬Ø§Ø­');
                });
            }
            
            // Ø¥Ø¶Ø§ÙØ© Ø¥ÙŠÙ…ÙŠÙ„ Ù„Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
            const addEmailBtn = document.getElementById('add-notification-email-btn');
            const emailInput = document.getElementById('notification-email-input');
            if (addEmailBtn && emailInput) {
                addEmailBtn.addEventListener('click', () => {
                    const email = emailInput.value.trim().toLowerCase();
                    if (!email || !Utils.isValidEmail(email)) {
                        Notification.error('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¥ÙŠÙ…ÙŠÙ„ ØµØ­ÙŠØ­');
                        return;
                    }
                    
                    if (!AppState.notificationEmails) {
                        AppState.notificationEmails = [];
                    }
                    
                    if (AppState.notificationEmails.includes(email)) {
                        Notification.warning('Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹');
                        return;
                    }
                    
                    AppState.notificationEmails.push(email);
                    emailInput.value = '';
                    
                    const list = document.getElementById('notification-emails-list');
                    if (list) {
                        const emailDiv = document.createElement('div');
                        emailDiv.className = 'flex items-center gap-2 p-2 border rounded bg-gray-50';
                        emailDiv.innerHTML = `
                            <span class="flex-1">${Utils.escapeHTML(email)}</span>
                            <button type="button" onclick="Settings.removeNotificationEmail(${AppState.notificationEmails.length - 1})" class="text-red-600 hover:text-red-800">
                                <i class="fas fa-times"></i>
                            </button>
                        `;
                        list.appendChild(emailDiv);
                    }
                });
            }
            
            // Ø­ÙØ¸ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„Ø§Øª
            const saveEmailsBtn = document.getElementById('save-notification-emails-btn');
            if (saveEmailsBtn) {
                saveEmailsBtn.addEventListener('click', () => {
                    DataManager.save();
                    Notification.success('ØªÙ… Ø­ÙØ¸ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
                });
            }
            
            // Ø±ÙØ¹ Ø´Ø¹Ø§Ø± Ø§Ù„Ø´Ø±ÙƒØ©
            const uploadLogoBtn = document.getElementById('upload-logo-btn');
            const logoInput = document.getElementById('company-logo-input');
            if (uploadLogoBtn && logoInput) {
                uploadLogoBtn.addEventListener('click', () => {
                    const file = logoInput.files[0];
                    if (!file) {
                        Notification.error('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø©');
                        return;
                    }
                    
                    if (file.size > 2 * 1024 * 1024) {
                        Notification.error('Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© ÙŠØ¬Ø¨ Ø£Ù„Ø§ ÙŠØªØ¬Ø§ÙˆØ² 2MB');
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        AppState.companyLogo = e.target.result;
                        DataManager.save();
                        
                        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
                        const preview = document.getElementById('company-logo-preview');
                        if (preview) {
                            preview.src = AppState.companyLogo;
                            preview.style.display = 'block';
                        }
                        
                        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‡ÙŠØ¯Ø±
                        if (typeof UI !== 'undefined' && UI.updateCompanyLogoHeader) {
                            UI.updateCompanyLogoHeader();
                        }
                        if (typeof UI !== 'undefined' && UI.updateDashboardLogo) {
                            UI.updateDashboardLogo();
                        }
                        
                        Notification.success('ØªÙ… Ø±ÙØ¹ Ø§Ù„Ø´Ø¹Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­');
                    };
                    reader.readAsDataURL(file);
                });
            }
            
            // Ø¥Ø²Ø§Ù„Ø© Ø´Ø¹Ø§Ø± Ø§Ù„Ø´Ø±ÙƒØ©
            const removeLogoBtn = document.getElementById('remove-logo-btn');
            if (removeLogoBtn) {
                removeLogoBtn.addEventListener('click', () => {
                    AppState.companyLogo = '';
                    DataManager.save();
                    
                    const preview = document.getElementById('company-logo-preview');
                    if (preview) {
                        preview.style.display = 'none';
                    }
                    
                    if (typeof UI !== 'undefined' && UI.updateCompanyLogoHeader) {
                        UI.updateCompanyLogoHeader();
                    }
                    
                    Notification.success('ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø´Ø¹Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­');
                    this.load();
                });
            }
        }, 100);
    }
};

// ===== Clinic Module (Ù†Ø¸Ø§Ù… Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© Ø§Ù„Ø·Ø¨ÙŠØ©) =====
const Clinic = {
    async load() {
        const section = document.getElementById('clinic-section');
        if (!section) {
            console.error('âŒ Ù‚Ø³Ù… clinic-section ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!');
            return;
        }
        console.log('âœ… Ù…Ø¯ÙŠÙˆÙ„ Clinic ÙŠÙƒØªØ¨ ÙÙŠ Ù‚Ø³Ù…: clinic-section');

        section.innerHTML = `
            <div class="section-header">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="section-title">
                            <i class="fas fa-hospital ml-3"></i>
                            Ù†Ø¸Ø§Ù… Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© Ø§Ù„Ø·Ø¨ÙŠØ©
                        </h1>
                        <p class="section-subtitle">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© Ø§Ù„Ø·Ø¨ÙŠØ© ÙˆØ§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„ØµØ­ÙŠØ©</p>
                    </div>
                    <div class="flex gap-2">
                        <button id="add-visit-btn" class="btn-primary">
                            <i class="fas fa-plus ml-2"></i>
                            ØªØ³Ø¬ÙŠÙ„ Ø²ÙŠØ§Ø±Ø©
                        </button>
                        <button id="add-medication-btn" class="btn-secondary">
                            <i class="fas fa-pills ml-2"></i>
                            Ø¥Ø¶Ø§ÙØ© Ø¯ÙˆØ§Ø¡
                        </button>
                        <button id="add-sick-leave-btn" class="btn-warning">
                            <i class="fas fa-notes-medical ml-2"></i>
                            Ø¥Ø¶Ø§ÙØ© Ø¥Ø¬Ø§Ø²Ø© Ù…Ø±Ø¶ÙŠØ©
                        </button>
                        <button id="add-injury-btn" class="btn-danger">
                            <i class="fas fa-user-injured ml-2"></i>
                            ØªØ³Ø¬ÙŠÙ„ Ø¥ØµØ§Ø¨Ø©
                        </button>
                    </div>
                </div>
            </div>
            <div class="mt-6">
                <div class="grid grid-cols-4 gap-4 mb-6">
                    <div class="content-card">
                        <div class="text-center">
                            <i class="fas fa-user-injured text-4xl text-blue-600 mb-2"></i>
                            <p class="text-sm text-gray-600">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª</p>
                            <p class="text-2xl font-bold" id="total-visits">${AppState.appData.clinicVisits.length}</p>
                        </div>
                    </div>
                    <div class="content-card">
                        <div class="text-center">
                            <i class="fas fa-pills text-4xl text-green-600 mb-2"></i>
                            <p class="text-sm text-gray-600">Ø§Ù„Ø£Ø¯ÙˆÙŠØ© Ø§Ù„Ù…ØªØ§Ø­Ø©</p>
                            <p class="text-2xl font-bold" id="total-medications">${AppState.appData.clinicInventory.length}</p>
                        </div>
                    </div>
                    <div class="content-card">
                        <div class="text-center">
                            <i class="fas fa-notes-medical text-4xl text-yellow-600 mb-2"></i>
                            <p class="text-sm text-gray-600">Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª Ø§Ù„Ù…Ø±Ø¶ÙŠØ©</p>
                            <p class="text-2xl font-bold" id="total-sick-leave">${AppState.appData.sickLeave.length}</p>
                        </div>
                    </div>
                    <div class="content-card">
                        <div class="text-center">
                            <i class="fas fa-calendar-week text-4xl text-red-600 mb-2"></i>
                            <p class="text-sm text-gray-600">Ø²ÙŠØ§Ø±Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</p>
                            <p class="text-2xl font-bold" id="monthly-visits">${this.getMonthlyVisits()}</p>
                        </div>
                    </div>
                </div>
                <div class="content-card">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-list ml-2"></i>Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø£Ø®ÙŠØ±Ø©</h2>
                    </div>
                    <div class="card-body">
                        <div id="clinic-visits-list">
                            ${await this.renderVisitsList()}
                        </div>
                    </div>
                </div>
            </div>
        `;
        this.setupEventListeners();
    },

    getMonthlyVisits() {
        const now = new Date();
        const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
        return AppState.appData.clinicVisits.filter(v => {
            const visitDate = new Date(v.visitDate || v.createdAt);
            return visitDate >= startOfMonth;
        }).length;
    },

    async renderVisitsList() {
        const visits = AppState.appData.clinicVisits.slice(-10).reverse();
        if (visits.length === 0) {
            return '<div class="empty-state"><p class="text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø²ÙŠØ§Ø±Ø§Øª Ù…Ø³Ø¬Ù„Ø©</p></div>';
        }
        return `
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù</th>
                        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                        <th>Ø§Ù„Ø³Ø¨Ø¨</th>
                        <th>Ø§Ù„ØªØ´Ø®ÙŠØµ</th>
                        <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                    </tr>
                </thead>
                <tbody>
                    ${visits.map(visit => `
                        <tr>
                            <td>${Utils.escapeHTML(visit.employeeName || '')}</td>
                            <td>${visit.visitDate ? Utils.formatDate(visit.visitDate) : '-'}</td>
                            <td>${Utils.escapeHTML(visit.reason || '')}</td>
                            <td>${Utils.escapeHTML(visit.diagnosis || '')}</td>
                            <td>
                                <button onclick="Clinic.viewVisit('${visit.id}')" class="btn-icon btn-icon-primary">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
    },

    setupEventListeners() {
        setTimeout(() => {
            const addVisitBtn = document.getElementById('add-visit-btn');
            const addMedicationBtn = document.getElementById('add-medication-btn');
            const addSickLeaveBtn = document.getElementById('add-sick-leave-btn');
            const addInjuryBtn = document.getElementById('add-injury-btn');
            
            if (addVisitBtn) addVisitBtn.addEventListener('click', () => this.showVisitForm());
            if (addMedicationBtn) addMedicationBtn.addEventListener('click', () => this.showMedicationForm());
            if (addSickLeaveBtn) addSickLeaveBtn.addEventListener('click', () => this.showSickLeaveForm());
            if (addInjuryBtn) addInjuryBtn.addEventListener('click', () => this.showInjuryForm());
        }, 100);
    },

    handlePersonTypeChange() {
        const personType = document.getElementById('visit-person-type').value;
        const codeContainer = document.getElementById('visit-employee-code-container');
        const nameInput = document.getElementById('visit-employee-name');
        const nameLabel = nameInput?.previousElementSibling;
        const positionContainer = document.getElementById('visit-employee-position-container');
        const departmentContainer = document.getElementById('visit-employee-department-container');
        const locationContainer = document.getElementById('visit-employee-location-container');
        
        // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø­Ù‚Ù„ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ù…ÙˆØ¸Ù
        if (codeContainer) {
            codeContainer.style.display = personType === 'employee' ? 'block' : 'none';
        }
        
        // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø­Ù‚ÙˆÙ„ Ø§Ù„ÙˆØ¸ÙŠÙØ© ÙˆØ§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ù…ÙˆØ¸Ù
        if (positionContainer) {
            positionContainer.style.display = personType === 'employee' ? 'block' : 'none';
        }
        if (departmentContainer) {
            departmentContainer.style.display = personType === 'employee' ? 'block' : 'none';
        }
        if (locationContainer) {
            locationContainer.style.display = personType === 'employee' ? 'block' : 'none';
        }
        
        if (nameLabel) {
            nameLabel.textContent = `Ø§Ø³Ù… ${personType === 'employee' ? 'Ø§Ù„Ù…ÙˆØ¸Ù' : personType === 'contractor' ? 'Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„' : 'Ø§Ù„Ø¹Ø§Ù…Ù„'} *`;
        }
        
        // ØªÙØ¹ÙŠÙ„/ØªØ¹Ø·ÙŠÙ„ Ø­Ù‚Ù„ Ø§Ù„Ø§Ø³Ù… - Ø¹Ù†Ø¯ Ù…ÙˆØ¸Ù: readonly (ÙŠØªÙ… Ø§Ù„ØªØ¹Ø¨Ø¦Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹)ØŒ Ø¹Ù†Ø¯ Ù…Ù‚Ø§ÙˆÙ„/Ø¹Ù…Ø§Ù„Ø© Ø®Ø§Ø±Ø¬ÙŠØ©: ÙŠØ¯ÙˆÙŠ
        if (nameInput) {
            if (personType === 'employee') {
                nameInput.readOnly = true;
                nameInput.placeholder = 'Ø³ÙŠØªÙ… Ø§Ù„ØªØ¹Ø¨Ø¦Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹';
            } else {
                nameInput.readOnly = false;
                nameInput.placeholder = `Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… ${personType === 'contractor' ? 'Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„' : 'Ø§Ù„Ø¹Ø§Ù…Ù„'}`;
                nameInput.value = '';
            }
        }
        
        // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ù…ÙˆØ¸Ù
        if (personType === 'employee' && typeof EmployeeHelper !== 'undefined') {
            const codeInput = document.getElementById('visit-employee-code');
            if (codeInput) {
                // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
                const newCodeInput = codeInput.cloneNode(true);
                codeInput.parentNode.replaceChild(newCodeInput, codeInput);
                
                // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ
                EmployeeHelper.setupEmployeeCodeSearch('visit-employee-code', 'visit-employee-name', (employee) => {
                    if (employee) {
                        document.getElementById('visit-employee-name').value = employee.name || '';
                        document.getElementById('visit-employee-position').value = employee.position || '';
                        document.getElementById('visit-employee-department').value = employee.department || '';
                    }
                });
            }
        } else {
            // Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù‚Ø§ÙˆÙ„ Ø£Ùˆ Ø¹Ù…Ø§Ù„Ø© Ø®Ø§Ø±Ø¬ÙŠØ© - Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„
            if (nameInput) nameInput.value = '';
            const codeInput = document.getElementById('visit-employee-code');
            if (codeInput) codeInput.value = '';
            const positionInput = document.getElementById('visit-employee-position');
            if (positionInput) positionInput.value = '';
            const departmentInput = document.getElementById('visit-employee-department');
            if (departmentInput) departmentInput.value = '';
        }
    },
    
    async showSickLeaveForm(data = null) {
        const isEdit = !!data;
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 800px;">
                <div class="modal-header">
                    <h2 class="modal-title">${isEdit ? 'ØªØ¹Ø¯ÙŠÙ„ Ø¥Ø¬Ø§Ø²Ø© Ù…Ø±Ø¶ÙŠØ©' : 'Ø¥Ø¶Ø§ÙØ© Ø¥Ø¬Ø§Ø²Ø© Ù…Ø±Ø¶ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©'}</h2>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="sick-leave-form" class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ù†ÙˆØ¹ Ø§Ù„Ø´Ø®Øµ *</label>
                                <select id="sick-leave-person-type" required class="form-input">
                                    <option value="employee" ${data?.personType === 'employee' || !data ? 'selected' : ''}>Ù…ÙˆØ¸Ù</option>
                                    <option value="contractor" ${data?.personType === 'contractor' ? 'selected' : ''}>Ù…Ù‚Ø§ÙˆÙ„</option>
                                    <option value="external" ${data?.personType === 'external' ? 'selected' : ''}>Ø¹Ù…Ø§Ù„Ø© Ø®Ø§Ø±Ø¬ÙŠØ©</option>
                                </select>
                            </div>
                            <div id="sick-leave-code-container">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ *</label>
                                <input type="text" id="sick-leave-employee-code" class="form-input"
                                    value="${data?.employeeCode || data?.employeeNumber || ''}" 
                                    placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ (Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹)" required>
                            </div>
                            <div id="sick-leave-name-container">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù *</label>
                                <div class="relative">
                                    <input type="text" id="sick-leave-name" required class="form-input" readonly
                                        value="${data?.employeeName || data?.personName || ''}" placeholder="Ø³ÙŠØªÙ… Ø§Ù„ØªØ¹Ø¨Ø¦Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹">
                                    <div id="sick-leave-dropdown" class="absolute z-50 hidden w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-auto"></div>
                                </div>
                            </div>
                            <div id="sick-leave-position-container" style="display: none;">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„ÙˆØ¸ÙŠÙØ©</label>
                                <input type="text" id="sick-leave-position" class="form-input" readonly placeholder="Ø³ÙŠØªÙ… Ø§Ù„ØªØ¹Ø¨Ø¦Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹">
                            </div>
                            <div id="sick-leave-department-container" style="display: none;">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„Ù‚Ø³Ù…/Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</label>
                                <input type="text" id="sick-leave-department" class="form-input" readonly placeholder="Ø³ÙŠØªÙ… Ø§Ù„ØªØ¹Ø¨Ø¦Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¥Ø¬Ø§Ø²Ø© *</label>
                                <input type="date" id="sick-leave-start-date" required class="form-input"
                                    value="${data?.startDate ? new Date(data.startDate).toISOString().slice(0, 10) : ''}">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¥Ø¬Ø§Ø²Ø© *</label>
                                <input type="date" id="sick-leave-end-date" required class="form-input"
                                    value="${data?.endDate ? new Date(data.endDate).toISOString().slice(0, 10) : ''}">
                            </div>
                            <div class="col-span-2">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø³Ø¨Ø¨ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø© *</label>
                                <textarea id="sick-leave-reason" required class="form-input" rows="3"
                                    placeholder="Ø³Ø¨Ø¨ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø© Ø§Ù„Ù…Ø±Ø¶ÙŠØ©">${data?.reason || ''}</textarea>
                            </div>
                            <div class="col-span-2">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø·Ø¨ÙŠØ©</label>
                                <textarea id="sick-leave-notes" class="form-input" rows="3"
                                    placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø·Ø¨ÙŠØ© Ø¥Ø¶Ø§ÙÙŠØ©">${data?.medicalNotes || ''}</textarea>
                            </div>
                        </div>
                        <div class="flex items-center justify-end gap-4 pt-4 border-t">
                            <button type="button" class="btn-secondary" onclick="this.closest('.modal-overlay').remove()">Ø¥Ù„ØºØ§Ø¡</button>
                            <button type="submit" class="btn-primary">
                                <i class="fas fa-save ml-2"></i>${isEdit ? 'Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª' : 'Ø¥Ø¶Ø§ÙØ© Ø¥Ø¬Ø§Ø²Ø© Ù…Ø±Ø¶ÙŠØ©'}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        
        // Setup employee code search and autocomplete for sick leave form
        setTimeout(() => {
            const personTypeSelect = document.getElementById('sick-leave-person-type');
            const codeInput = document.getElementById('sick-leave-employee-code');
            const nameInput = document.getElementById('sick-leave-name');
            const positionInput = document.getElementById('sick-leave-position');
            const departmentInput = document.getElementById('sick-leave-department');
            const positionContainer = document.getElementById('sick-leave-position-container');
            const departmentContainer = document.getElementById('sick-leave-department-container');
            const codeContainer = document.getElementById('sick-leave-code-container');
            const nameContainer = document.getElementById('sick-leave-name-container');
            const dropdown = document.getElementById('sick-leave-dropdown');
            
            // Setup initial display
            if (personTypeSelect) {
                const personType = personTypeSelect.value;
                if (codeContainer) {
                    codeContainer.style.display = personType === 'employee' ? 'block' : 'none';
                }
                if (nameContainer) {
                    nameContainer.style.display = personType === 'employee' ? 'block' : 'block';
                }
                if (positionContainer) {
                    positionContainer.style.display = personType === 'employee' ? 'block' : 'none';
                }
                if (departmentContainer) {
                    departmentContainer.style.display = personType === 'employee' ? 'block' : 'none';
                }
                
                // Setup employee code search when person type is employee
                if (personType === 'employee' && codeInput && nameInput) {
                    const fillEmployeeData = () => {
                        const code = codeInput.value.trim();
                        if (!code) return;
                        
                        const employees = AppState.appData.employees || [];
                        const emp = employees.find(e => 
                            (e.employeeNumber && e.employeeNumber === code) ||
                            (e.sapId && e.sapId === code)
                        );
                        
                        if (emp) {
                            nameInput.value = emp.name || '';
                            if (positionInput) positionInput.value = emp.position || '';
                            if (departmentInput) departmentInput.value = emp.department || '';
                        } else {
                            Notification.warning('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…ÙˆØ¸Ù Ø¨Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯');
                        }
                    };
                    
                    codeInput.addEventListener('blur', fillEmployeeData);
                    
                    // Setup autocomplete dropdown
                    if (dropdown) {
                        codeInput.addEventListener('input', (e) => {
                            const searchTerm = e.target.value.trim();
                            dropdown.innerHTML = '';
                            dropdown.classList.add('hidden');
                            
                            if (searchTerm.length < 2) return;
                            
                            const employees = AppState.appData.employees || [];
                            const matches = employees.filter(emp => {
                                const code = emp.employeeNumber || emp.sapId || '';
                                const name = emp.name || '';
                                const searchLower = searchTerm.toLowerCase();
                                return code.includes(searchTerm) || name.toLowerCase().includes(searchLower);
                            }).slice(0, 10);
                            
                            if (matches.length > 0) {
                                dropdown.innerHTML = matches.map(emp => `
                                    <div class="p-3 hover:bg-blue-50 cursor-pointer border-b border-gray-100" 
                                         onclick="
                                            const codeInput = document.getElementById('sick-leave-employee-code');
                                            const nameInput = document.getElementById('sick-leave-name');
                                            const positionInput = document.getElementById('sick-leave-position');
                                            const departmentInput = document.getElementById('sick-leave-department');
                                            if(codeInput) codeInput.value = '${emp.employeeNumber || emp.sapId || ''}';
                                            if(nameInput) nameInput.value = '${Utils.escapeHTML(emp.name || '')}';
                                            if(positionInput) positionInput.value = '${Utils.escapeHTML(emp.position || '')}';
                                            if(departmentInput) departmentInput.value = '${Utils.escapeHTML(emp.department || '')}';
                                            const dropdown = document.getElementById('sick-leave-dropdown');
                                            if(dropdown) dropdown.classList.add('hidden');
                                         ">
                                        <div class="font-semibold text-gray-800">${Utils.escapeHTML(emp.employeeNumber || emp.sapId || '')}</div>
                                        <div class="text-sm text-gray-700">${Utils.escapeHTML(emp.name || '')}</div>
                                        ${emp.position ? `<div class="text-xs text-gray-600">Ø§Ù„ÙˆØ¸ÙŠÙØ©: ${Utils.escapeHTML(emp.position)}</div>` : ''}
                                        ${emp.department ? `<div class="text-xs text-gray-600">Ø§Ù„Ù‚Ø³Ù…: ${Utils.escapeHTML(emp.department)}</div>` : ''}
                                    </div>
                                `).join('');
                                dropdown.classList.remove('hidden');
                            } else {
                                dropdown.innerHTML = '<div class="p-2 text-sm text-gray-500 text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>';
                                dropdown.classList.remove('hidden');
                            }
                        });
                        
                        document.addEventListener('click', (e) => {
                            if (!codeInput.contains(e.target) && !dropdown.contains(e.target)) {
                                dropdown.classList.add('hidden');
                            }
                        });
                    }
                }
                
                // Handle person type change
                personTypeSelect.addEventListener('change', () => {
                    const personType = personTypeSelect.value;
                    if (codeContainer) {
                        codeContainer.style.display = personType === 'employee' ? 'block' : 'none';
                    }
                    if (positionContainer) {
                        positionContainer.style.display = personType === 'employee' ? 'block' : 'none';
                    }
                    if (departmentContainer) {
                        departmentContainer.style.display = personType === 'employee' ? 'block' : 'none';
                    }
                    
                    if (personType === 'employee' && codeInput && nameInput) {
                        codeInput.value = '';
                        nameInput.value = '';
                        if (positionInput) positionInput.value = '';
                        if (departmentInput) departmentInput.value = '';
                    }
                });
            }
            
            // Fill employee data if data exists
            if (data && data.employeeCode) {
                const employees = AppState.appData.employees || [];
                const emp = employees.find(e => 
                    (e.employeeNumber && e.employeeNumber === data.employeeCode) ||
                    (e.sapId && e.sapId === data.employeeCode)
                );
                if (emp && positionInput && departmentInput) {
                    positionInput.value = emp.position || '';
                    departmentInput.value = emp.department || '';
                }
            }
        }, 200);
        
        const form = modal.querySelector('#sick-leave-form');
        
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const personType = document.getElementById('sick-leave-person-type').value;
            const formData = {
                id: data?.id || Utils.generateId('SICK_LEAVE'),
                personType: personType,
                employeeName: personType === 'employee' ? document.getElementById('sick-leave-name').value.trim() : null,
                employeeCode: personType === 'employee' ? document.getElementById('sick-leave-employee-code').value.trim() : null,
                employeeNumber: personType === 'employee' ? document.getElementById('sick-leave-employee-code').value.trim() : null,
                employeePosition: personType === 'employee' ? document.getElementById('sick-leave-position')?.value.trim() || '' : null,
                employeeDepartment: personType === 'employee' ? document.getElementById('sick-leave-department')?.value.trim() || '' : null,
                personName: personType !== 'employee' ? document.getElementById('sick-leave-name').value.trim() : null,
                startDate: new Date(document.getElementById('sick-leave-start-date').value).toISOString(),
                endDate: new Date(document.getElementById('sick-leave-end-date').value).toISOString(),
                reason: document.getElementById('sick-leave-reason').value.trim(),
                medicalNotes: document.getElementById('sick-leave-notes').value.trim(),
                createdAt: data?.createdAt || new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            Loading.show();
            try {
                if (!AppState.appData.sickLeave) {
                    AppState.appData.sickLeave = [];
                }
                
                if (isEdit) {
                    const index = AppState.appData.sickLeave.findIndex(s => s.id === data.id);
                    if (index !== -1) AppState.appData.sickLeave[index] = formData;
                    Notification.success('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¬Ø§Ø²Ø© Ø§Ù„Ù…Ø±Ø¶ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­');
                } else {
                    AppState.appData.sickLeave.push(formData);
                    Notification.success('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¥Ø¬Ø§Ø²Ø© Ø§Ù„Ù…Ø±Ø¶ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­');
                }
                
                DataManager.save();
                await GoogleIntegration.autoSave('SickLeave', AppState.appData.sickLeave);
                Loading.hide();
                modal.remove();
                this.load();
            } catch (error) {
                Loading.hide();
                Notification.error('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
            }
        });
        
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
        });
    },
    
    async showInjuryForm(data = null) {
        const isEdit = !!data;
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 800px;">
                <div class="modal-header">
                    <h2 class="modal-title">${isEdit ? 'ØªØ¹Ø¯ÙŠÙ„ Ø¥ØµØ§Ø¨Ø©' : 'ØªØ³Ø¬ÙŠÙ„ Ø¥ØµØ§Ø¨Ø© Ø¬Ø¯ÙŠØ¯Ø©'}</h2>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="injury-form" class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ù†ÙˆØ¹ Ø§Ù„Ø´Ø®Øµ *</label>
                                <select id="injury-person-type" required class="form-input">
                                    <option value="employee" ${data?.personType === 'employee' || !data ? 'selected' : ''}>Ù…ÙˆØ¸Ù</option>
                                    <option value="contractor" ${data?.personType === 'contractor' ? 'selected' : ''}>Ù…Ù‚Ø§ÙˆÙ„</option>
                                    <option value="external" ${data?.personType === 'external' ? 'selected' : ''}>Ø¹Ù…Ø§Ù„Ø© Ø®Ø§Ø±Ø¬ÙŠØ©</option>
                                </select>
                            </div>
                            <div id="injury-code-container">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</label>
                                <input type="text" id="injury-employee-code" class="form-input"
                                    value="${data?.employeeCode || data?.employeeNumber || ''}" placeholder="Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„Ø§Ø³Ù… *</label>
                                <div class="relative">
                                    <input type="text" id="injury-name" required class="form-input"
                                        value="${data?.employeeName || data?.personName || ''}" placeholder="Ø§Ù„Ø§Ø³Ù…">
                                    <div id="injury-dropdown" class="absolute z-50 hidden w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-auto"></div>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØµØ§Ø¨Ø© *</label>
                                <input type="datetime-local" id="injury-date" required class="form-input"
                                    value="${data?.injuryDate ? new Date(data.injuryDate).toISOString().slice(0, 16) : ''}">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ù†ÙˆØ¹ Ø§Ù„Ø¥ØµØ§Ø¨Ø© *</label>
                                <select id="injury-type" required class="form-input">
                                    <option value="">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¥ØµØ§Ø¨Ø©</option>
                                    <option value="Ø¬Ø±Ø­" ${data?.injuryType === 'Ø¬Ø±Ø­' ? 'selected' : ''}>Ø¬Ø±Ø­</option>
                                    <option value="ÙƒØ³Ø±" ${data?.injuryType === 'ÙƒØ³Ø±' ? 'selected' : ''}>ÙƒØ³Ø±</option>
                                    <option value="Ø­Ø±ÙˆÙ‚" ${data?.injuryType === 'Ø­Ø±ÙˆÙ‚' ? 'selected' : ''}>Ø­Ø±ÙˆÙ‚</option>
                                    <option value="Ø¥ØµØ§Ø¨Ø© Ø¨Ø§Ù„ØºØ©" ${data?.injuryType === 'Ø¥ØµØ§Ø¨Ø© Ø¨Ø§Ù„ØºØ©' ? 'selected' : ''}>Ø¥ØµØ§Ø¨Ø© Ø¨Ø§Ù„ØºØ©</option>
                                    <option value="Ø£Ø®Ø±Ù‰" ${data?.injuryType === 'Ø£Ø®Ø±Ù‰' ? 'selected' : ''}>Ø£Ø®Ø±Ù‰</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ù…ÙƒØ§Ù† Ø§Ù„Ø¥ØµØ§Ø¨Ø© *</label>
                                <input type="text" id="injury-location" required class="form-input"
                                    value="${data?.injuryLocation || ''}" placeholder="Ù…ÙƒØ§Ù† Ø§Ù„Ø¥ØµØ§Ø¨Ø©">
                            </div>
                            <div class="col-span-2">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">ÙˆØµÙ Ø§Ù„Ø¥ØµØ§Ø¨Ø© *</label>
                                <textarea id="injury-description" required class="form-input" rows="3"
                                    placeholder="ÙˆØµÙ ØªÙØµÙŠÙ„ÙŠ Ù„Ù„Ø¥ØµØ§Ø¨Ø©">${data?.injuryDescription || ''}</textarea>
                            </div>
                            <div class="col-span-2">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…ØªØ®Ø°Ø©</label>
                                <textarea id="injury-actions" class="form-input" rows="3"
                                    placeholder="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…ØªØ®Ø°Ø©">${data?.actionsTaken || ''}</textarea>
                            </div>
                            <div class="col-span-2">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„Ø¹Ù„Ø§Ø¬</label>
                                <textarea id="injury-treatment" class="form-input" rows="3"
                                    placeholder="Ø§Ù„Ø¹Ù„Ø§Ø¬ Ø§Ù„Ù…ÙˆØµÙˆÙ">${data?.treatment || ''}</textarea>
                            </div>
                        </div>
                        <div class="flex items-center justify-end gap-4 pt-4 border-t">
                            <button type="button" class="btn-secondary" onclick="this.closest('.modal-overlay').remove()">Ø¥Ù„ØºØ§Ø¡</button>
                            <button type="submit" class="btn-primary">
                                <i class="fas fa-save ml-2"></i>${isEdit ? 'Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª' : 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¥ØµØ§Ø¨Ø©'}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        
        const form = modal.querySelector('#injury-form');
        const personTypeSelect = document.getElementById('injury-person-type');
        
        if (personTypeSelect) {
            personTypeSelect.addEventListener('change', () => {
                const codeContainer = document.getElementById('injury-code-container');
                if (codeContainer) {
                    codeContainer.style.display = personTypeSelect.value === 'employee' ? 'block' : 'none';
                }
                if (personTypeSelect.value === 'employee' && typeof EmployeeHelper !== 'undefined') {
                    EmployeeHelper.setupAutocomplete('injury-name', (employee) => {
                        if (employee) {
                            document.getElementById('injury-name').value = employee.name;
                            document.getElementById('injury-employee-code').value = employee.employeeNumber || employee.sapId || '';
                        }
                    });
                    // Setup employee code search
                    EmployeeHelper.setupEmployeeCodeSearch('injury-employee-code', 'injury-name');
                }
            });
            
            if (personTypeSelect.value === 'employee' && typeof EmployeeHelper !== 'undefined') {
                EmployeeHelper.setupAutocomplete('injury-name', (employee) => {
                    if (employee) {
                        document.getElementById('injury-name').value = employee.name;
                        document.getElementById('injury-employee-code').value = employee.employeeNumber || employee.sapId || '';
                    }
                });
            }
        }
        
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const personType = document.getElementById('injury-person-type').value;
            const formData = {
                id: data?.id || Utils.generateId('INJURY'),
                personType: personType,
                employeeName: personType === 'employee' ? document.getElementById('injury-name').value.trim() : null,
                employeeCode: personType === 'employee' ? document.getElementById('injury-employee-code').value.trim() : null,
                employeeNumber: personType === 'employee' ? document.getElementById('injury-employee-code').value.trim() : null,
                personName: personType !== 'employee' ? document.getElementById('injury-name').value.trim() : null,
                injuryDate: new Date(document.getElementById('injury-date').value).toISOString(),
                injuryType: document.getElementById('injury-type').value,
                injuryLocation: document.getElementById('injury-location').value.trim(),
                injuryDescription: document.getElementById('injury-description').value.trim(),
                actionsTaken: document.getElementById('injury-actions').value.trim(),
                treatment: document.getElementById('injury-treatment').value.trim(),
                createdAt: data?.createdAt || new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            Loading.show();
            try {
                if (!AppState.appData.injuries) {
                    AppState.appData.injuries = [];
                }
                
                if (isEdit) {
                    const index = AppState.appData.injuries.findIndex(i => i.id === data.id);
                    if (index !== -1) AppState.appData.injuries[index] = formData;
                    Notification.success('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥ØµØ§Ø¨Ø© Ø¨Ù†Ø¬Ø§Ø­');
                } else {
                    AppState.appData.injuries.push(formData);
                    Notification.success('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¥ØµØ§Ø¨Ø© Ø¨Ù†Ø¬Ø§Ø­');
                }
                
                DataManager.save();
                await GoogleIntegration.autoSave('Injuries', AppState.appData.injuries);
                Loading.hide();
                modal.remove();
                this.load();
            } catch (error) {
                Loading.hide();
                Notification.error('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
            }
        });
        
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
        });
    },

    async showVisitForm(visitData = null) {
        const isEdit = !!visitData;
        const content = document.getElementById('clinic-section');
        if (!content) return;
        
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 800px;">
                <div class="modal-header">
                    <h2 class="modal-title">${isEdit ? 'ØªØ¹Ø¯ÙŠÙ„ Ø²ÙŠØ§Ø±Ø©' : 'ØªØ³Ø¬ÙŠÙ„ Ø²ÙŠØ§Ø±Ø© Ø¬Ø¯ÙŠØ¯Ø©'}</h2>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="visit-form" class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ù†ÙˆØ¹ Ø§Ù„Ø´Ø®Øµ *</label>
                                <select id="visit-person-type" required class="form-input" onchange="Clinic.handlePersonTypeChange()">
                                    <option value="employee" ${visitData?.personType === 'employee' || !visitData ? 'selected' : ''}>Ù…ÙˆØ¸Ù</option>
                                    <option value="contractor" ${visitData?.personType === 'contractor' ? 'selected' : ''}>Ù…Ù‚Ø§ÙˆÙ„</option>
                                    <option value="external" ${visitData?.personType === 'external' ? 'selected' : ''}>Ø¹Ù…Ø§Ù„Ø© Ø®Ø§Ø±Ø¬ÙŠØ©</option>
                                </select>
                            </div>
                            <div id="visit-employee-code-container">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ *</label>
                                <input type="text" id="visit-employee-code" class="form-input"
                                    value="${visitData?.employeeCode || visitData?.employeeNumber || ''}" 
                                    placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ (Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹)">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ø³Ù… ${visitData?.personType === 'employee' || !visitData ? 'Ø§Ù„Ù…ÙˆØ¸Ù' : visitData?.personType === 'contractor' ? 'Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„' : 'Ø§Ù„Ø¹Ø§Ù…Ù„'} *</label>
                                <div class="relative">
                                    <input type="text" id="visit-employee-name" required class="form-input"
                                        value="${visitData?.employeeName || ''}" placeholder="Ø³ÙŠØªÙ… Ø§Ù„ØªØ¹Ø¨Ø¦Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹" readonly>
                                    <div id="visit-employee-dropdown" class="absolute z-50 hidden w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-auto"></div>
                                </div>
                            </div>
                            <div id="visit-employee-position-container" style="display: none;">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„ÙˆØ¸ÙŠÙØ©</label>
                                <input type="text" id="visit-employee-position" class="form-input" readonly placeholder="Ø³ÙŠØªÙ… Ø§Ù„ØªØ¹Ø¨Ø¦Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹">
                            </div>
                            <div id="visit-employee-department-container" style="display: none;">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„Ù‚Ø³Ù…/Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</label>
                                <input type="text" id="visit-employee-department" class="form-input" readonly placeholder="Ø³ÙŠØªÙ… Ø§Ù„ØªØ¹Ø¨Ø¦Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹">
                            </div>
                            <div id="visit-employee-location-container" style="display: none;">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ù…ÙƒØ§Ù† Ø§Ù„Ø¹Ù…Ù„ *</label>
                                <input type="text" id="visit-employee-location" class="form-input" 
                                    value="${visitData?.employeeLocation || ''}" 
                                    placeholder="Ø£Ø¯Ø®Ù„ Ù…ÙƒØ§Ù† Ø§Ù„Ø¹Ù…Ù„ ÙŠØ¯ÙˆÙŠØ§Ù‹" required>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø²ÙŠØ§Ø±Ø© *</label>
                                <input type="datetime-local" id="visit-date" required class="form-input"
                                    value="${visitData?.visitDate ? new Date(visitData.visitDate).toISOString().slice(0, 16) : ''}">
                            </div>
                            <div class="col-span-2">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø³Ø¨Ø¨ Ø§Ù„Ø²ÙŠØ§Ø±Ø© *</label>
                                <input type="text" id="visit-reason" required class="form-input"
                                    value="${visitData?.reason || ''}" placeholder="Ø³Ø¨Ø¨ Ø§Ù„Ø²ÙŠØ§Ø±Ø©">
                            </div>
                            <div class="col-span-2">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„ØªØ´Ø®ÙŠØµ</label>
                                <textarea id="visit-diagnosis" class="form-input" rows="3"
                                    placeholder="Ø§Ù„ØªØ´Ø®ÙŠØµ">${visitData?.diagnosis || ''}</textarea>
                            </div>
                            <div class="col-span-2">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„Ø¹Ù„Ø§Ø¬</label>
                                <textarea id="visit-treatment" class="form-input" rows="3"
                                    placeholder="Ø§Ù„Ø¹Ù„Ø§Ø¬ Ø§Ù„Ù…ÙˆØµÙˆÙ">${visitData?.treatment || ''}</textarea>
                            </div>
                        </div>
                        
                        <!-- Ø¬Ø¯ÙˆÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© (Ø¨Ù†ÙØ³ Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ù…Ø¹Ù…Ø§Ø±ÙŠ) -->
                        ${visitData?.personType === 'employee' || !visitData ? `
                        <div class="mt-6 pt-6 border-t">
                            <h3 class="text-lg font-bold text-gray-800 mb-4">
                                <i class="fas fa-history ml-2"></i>
                                Ø³Ø¬Ù„ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
                            </h3>
                            <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                                <div class="overflow-x-auto">
                                    <table class="data-table w-full" id="visit-history-table">
                                        <thead>
                                            <tr>
                                                <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                                <th>Ø§Ù„Ø³Ø¨Ø¨</th>
                                                <th>Ø§Ù„ØªØ´Ø®ÙŠØµ</th>
                                                <th>Ø§Ù„Ø¹Ù„Ø§Ø¬</th>
                                                <th>Ù…ÙƒØ§Ù† Ø§Ù„Ø¹Ù…Ù„</th>
                                            </tr>
                                        </thead>
                                        <tbody id="visit-history-tbody">
                                            <tr>
                                                <td colspan="5" class="text-center text-gray-500 py-4">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        ` : ''}
                        
                        <div class="flex items-center justify-end gap-4 pt-4 border-t">
                            <button type="button" class="btn-secondary" onclick="this.closest('.modal-overlay').remove()">Ø¥Ù„ØºØ§Ø¡</button>
                            <button type="submit" class="btn-primary">
                                <i class="fas fa-save ml-2"></i>${isEdit ? 'Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª' : 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø²ÙŠØ§Ø±Ø©'}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        
        // ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¸Ù
        setTimeout(() => {
            const personTypeSelect = document.getElementById('visit-person-type');
            const codeInput = document.getElementById('visit-employee-code');
            const historyTableBody = document.getElementById('visit-history-tbody');
            
            const loadVisitHistory = () => {
                if (!historyTableBody) return;
                const personType = personTypeSelect?.value || 'employee';
                const code = codeInput?.value.trim();
                
                if (personType !== 'employee' || !code) {
                    historyTableBody.innerHTML = '<tr><td colspan="5" class="text-center text-gray-500 py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>';
                    return;
                }
                
                const visits = (AppState.appData.clinicVisits || []).filter(v => 
                    v.personType === 'employee' && 
                    (v.employeeCode === code || v.employeeNumber === code)
                ).sort((a, b) => new Date(b.visitDate || b.createdAt) - new Date(a.visitDate || a.createdAt)).slice(0, 10);
                
                if (visits.length === 0) {
                    historyTableBody.innerHTML = '<tr><td colspan="5" class="text-center text-gray-500 py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø²ÙŠØ§Ø±Ø§Øª Ø³Ø§Ø¨Ù‚Ø©</td></tr>';
                } else {
                    historyTableBody.innerHTML = visits.map(v => `
                        <tr>
                            <td>${v.visitDate ? Utils.formatDate(v.visitDate) : '-'}</td>
                            <td>${Utils.escapeHTML(v.reason || '-')}</td>
                            <td>${Utils.escapeHTML(v.diagnosis || '-')}</td>
                            <td>${Utils.escapeHTML(v.treatment || '-')}</td>
                            <td>${Utils.escapeHTML(v.employeeLocation || '-')}</td>
                        </tr>
                    `).join('');
                }
            };
            
            if (codeInput && historyTableBody) {
                codeInput.addEventListener('blur', loadVisitHistory);
                codeInput.addEventListener('input', () => {
                    if (codeInput.value.trim().length >= 3) {
                        loadVisitHistory();
                    }
                });
            }
            
            if (personTypeSelect) {
                personTypeSelect.addEventListener('change', () => {
                    const historySection = document.querySelector('#visit-history-table')?.closest('.mt-6');
                    if (historySection) {
                        historySection.style.display = personTypeSelect.value === 'employee' ? 'block' : 'none';
                    }
                    if (personTypeSelect.value === 'employee') {
                        loadVisitHistory();
                    }
                });
            }
            
            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„
            if (visitData && visitData.employeeCode) {
                loadVisitHistory();
            }
        }, 300);
        
        const form = modal.querySelector('#visit-form');
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const personType = document.getElementById('visit-person-type').value;
            const formData = {
                id: visitData?.id || Utils.generateId('CLINIC_VISIT'),
                personType: personType,
                employeeName: document.getElementById('visit-employee-name').value.trim(),
                employeeCode: personType === 'employee' ? document.getElementById('visit-employee-code').value.trim() : null,
                employeeNumber: personType === 'employee' ? document.getElementById('visit-employee-code').value.trim() : null,
                employeePosition: personType === 'employee' ? document.getElementById('visit-employee-position')?.value.trim() || '' : null,
                employeeDepartment: personType === 'employee' ? document.getElementById('visit-employee-department')?.value.trim() || '' : null,
                employeeLocation: personType === 'employee' ? document.getElementById('visit-employee-location')?.value.trim() || '' : null,
                contractorName: personType === 'contractor' ? document.getElementById('visit-employee-name').value.trim() : null,
                externalName: personType === 'external' ? document.getElementById('visit-employee-name').value.trim() : null,
                visitDate: new Date(document.getElementById('visit-date').value).toISOString(),
                reason: document.getElementById('visit-reason').value.trim(),
                diagnosis: document.getElementById('visit-diagnosis').value.trim(),
                treatment: document.getElementById('visit-treatment').value.trim(),
                createdAt: visitData?.createdAt || new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            Loading.show();
            try {
                if (isEdit) {
                    const index = AppState.appData.clinicVisits.findIndex(v => v.id === visitData.id);
                    if (index !== -1) AppState.appData.clinicVisits[index] = formData;
                } else {
                    AppState.appData.clinicVisits.push(formData);
                }
                DataManager.save();
                // Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙÙŠ Google Sheets
                await GoogleIntegration.autoSave('ClinicVisits', AppState.appData.clinicVisits);
                Loading.hide();
                Notification.success(`ØªÙ… ${isEdit ? 'ØªØ­Ø¯ÙŠØ«' : 'ØªØ³Ø¬ÙŠÙ„'} Ø§Ù„Ø²ÙŠØ§Ø±Ø© Ø¨Ù†Ø¬Ø§Ø­`);
                modal.remove();
                this.load();
            } catch (error) {
                Loading.hide();
                Notification.error('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
            }
        });
        
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
        });
    },

    async showMedicationForm() {
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 700px;">
                <div class="modal-header">
                    <h2 class="modal-title">Ø¥Ø¶Ø§ÙØ© Ø¯ÙˆØ§Ø¡ Ù„Ù„Ù…Ø®Ø²ÙˆÙ†</h2>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="medication-form" class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ§Ø¡ *</label>
                                <input type="text" id="med-name" required class="form-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ§Ø¡">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„ÙƒÙ…ÙŠØ© *</label>
                                <input type="number" id="med-quantity" required class="form-input" min="0" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</label>
                                <input type="date" id="med-expiry" class="form-input">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„Ù…ÙˆÙ‚Ø¹</label>
                                <input type="text" id="med-location" class="form-input" placeholder="Ù…ÙˆÙ‚Ø¹ Ø§Ù„ØªØ®Ø²ÙŠÙ†">
                            </div>
                        </div>
                        <div class="flex items-center justify-end gap-4 pt-4 border-t">
                            <button type="button" class="btn-secondary" onclick="this.closest('.modal-overlay').remove()">Ø¥Ù„ØºØ§Ø¡</button>
                            <button type="submit" class="btn-primary">
                                <i class="fas fa-save ml-2"></i>Ø¥Ø¶Ø§ÙØ©
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        
        const form = modal.querySelector('#medication-form');
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = {
                id: Utils.generateId('MED'),
                medicationName: document.getElementById('med-name').value.trim(),
                quantity: parseInt(document.getElementById('med-quantity').value) || 0,
                expiryDate: document.getElementById('med-expiry').value ? new Date(document.getElementById('med-expiry').value).toISOString() : '',
                location: document.getElementById('med-location').value.trim(),
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            Loading.show();
            try {
                AppState.appData.clinicInventory.push(formData);
                DataManager.save();
                // Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙÙŠ Google Sheets
                await GoogleIntegration.autoSave('ClinicInventory', AppState.appData.clinicInventory);
                Loading.hide();
                Notification.success('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯ÙˆØ§Ø¡ Ø¨Ù†Ø¬Ø§Ø­');
                modal.remove();
                this.load();
            } catch (error) {
                Loading.hide();
                Notification.error('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
            }
        });
        
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
        });
    },

    async viewVisit(id) {
        const visit = AppState.appData.clinicVisits.find(v => v.id === id);
        if (!visit) return;
        
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 700px;">
                <div class="modal-header">
                    <h2 class="modal-title">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø²ÙŠØ§Ø±Ø©</h2>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm font-semibold text-gray-600">Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù:</label>
                                <p class="text-gray-800">${Utils.escapeHTML(visit.employeeName || '')}</p>
                            </div>
                            <div>
                                <label class="text-sm font-semibold text-gray-600">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø²ÙŠØ§Ø±Ø©:</label>
                                <p class="text-gray-800">${visit.visitDate ? Utils.formatDate(visit.visitDate) : '-'}</p>
                            </div>
                            <div class="col-span-2">
                                <label class="text-sm font-semibold text-gray-600">Ø³Ø¨Ø¨ Ø§Ù„Ø²ÙŠØ§Ø±Ø©:</label>
                                <p class="text-gray-800">${Utils.escapeHTML(visit.reason || '')}</p>
                            </div>
                            <div class="col-span-2">
                                <label class="text-sm font-semibold text-gray-600">Ø§Ù„ØªØ´Ø®ÙŠØµ:</label>
                                <p class="text-gray-800">${Utils.escapeHTML(visit.diagnosis || '')}</p>
                            </div>
                            <div class="col-span-2">
                                <label class="text-sm font-semibold text-gray-600">Ø§Ù„Ø¹Ù„Ø§Ø¬:</label>
                                <p class="text-gray-800">${Utils.escapeHTML(visit.treatment || '')}</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" onclick="this.closest('.modal-overlay').remove()">Ø¥ØºÙ„Ø§Ù‚</button>
                    <button class="btn-primary" onclick="Clinic.showVisitForm(${JSON.stringify(visit).replace(/"/g, '&quot;')}); this.closest('.modal-overlay').remove();">
                        <i class="fas fa-edit ml-2"></i>ØªØ¹Ø¯ÙŠÙ„
                    </button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
        });
    }
};

// ===== Fire Equipment Module (ÙØ­Øµ Ù…Ø¹Ø¯Ø§Øª Ø§Ù„Ø­Ø±ÙŠÙ‚) =====
const FireEquipment = {
    async load() {
        const section = document.getElementById('fire-equipment-section');
        if (!section) return;

        const currentMonth = new Date().toLocaleDateString('ar-SA', { year: 'numeric', month: 'long' });
        const monthlyChecks = this.getMonthlyChecks();

        section.innerHTML = `
            <div class="section-header">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="section-title">
                            <i class="fas fa-fire-extinguisher ml-3"></i>
                            ÙØ­Øµ Ù…Ø¹Ø¯Ø§Øª Ø§Ù„Ø­Ø±ÙŠÙ‚
                        </h1>
                        <p class="section-subtitle">ÙØ­Øµ Ù…Ø¹Ø¯Ø§Øª Ø§Ù„Ø­Ø±ÙŠÙ‚ Ø´Ù‡Ø±ÙŠØ§Ù‹ ${currentMonth}</p>
                    </div>
                    <button id="add-fire-check-btn" class="btn-primary">
                        <i class="fas fa-plus ml-2"></i>
                        ØªØ³Ø¬ÙŠÙ„ ÙØ­Øµ Ø¬Ø¯ÙŠØ¯
                    </button>
                </div>
            </div>
            <div class="mt-6">
                <div class="grid grid-cols-3 gap-4 mb-6">
                    <div class="content-card">
                        <div class="text-center">
                            <i class="fas fa-check-circle text-4xl text-green-600 mb-2"></i>
                            <p class="text-sm text-gray-600">ÙØ­ÙˆØµØ§Øª Ù…ÙƒØªÙ…Ù„Ø©</p>
                            <p class="text-2xl font-bold">${monthlyChecks.completed}</p>
                        </div>
                    </div>
                    <div class="content-card">
                        <div class="text-center">
                            <i class="fas fa-exclamation-triangle text-4xl text-yellow-600 mb-2"></i>
                            <p class="text-sm text-gray-600">Ø¨Ø­Ø§Ø¬Ø© Ù„Ø¥ØµÙ„Ø§Ø­</p>
                            <p class="text-2xl font-bold">${monthlyChecks.needsRepair}</p>
                        </div>
                    </div>
                    <div class="content-card">
                        <div class="text-center">
                            <i class="fas fa-clock text-4xl text-blue-600 mb-2"></i>
                            <p class="text-sm text-gray-600">Ù…Ø¹Ù„Ù‚Ø©</p>
                            <p class="text-2xl font-bold">${monthlyChecks.pending}</p>
                        </div>
                    </div>
                </div>
                <div class="content-card">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-list ml-2"></i>Ø³Ø¬Ù„ ÙØ­ÙˆØµØ§Øª Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ</h2>
                    </div>
                    <div class="card-body">
                        <div id="fire-checks-list">
                            ${await this.renderChecksList()}
                        </div>
                    </div>
                </div>
            </div>
        `;
        this.setupEventListeners();
    },

    getMonthlyChecks() {
        const now = new Date();
        const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
        const monthly = AppState.appData.fireEquipment.filter(c => {
            const checkDate = new Date(c.checkDate || c.createdAt);
            return checkDate >= startOfMonth;
        });
        return {
            completed: monthly.filter(c => c.status === 'ØµØ§Ù„Ø­').length,
            needsRepair: monthly.filter(c => c.status === 'ÙŠØ­ØªØ§Ø¬ Ø¥ØµÙ„Ø§Ø­').length,
            pending: monthly.filter(c => c.status === 'Ù…Ø¹Ø·Ù„').length
        };
    },

    async renderChecksList() {
        const now = new Date();
        const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
        const checks = AppState.appData.fireEquipment.filter(c => {
            const checkDate = new Date(c.checkDate || c.createdAt);
            return checkDate >= startOfMonth;
        }).reverse();

        if (checks.length === 0) {
            return '<div class="empty-state"><p class="text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØ­ÙˆØµØ§Øª Ù…Ø³Ø¬Ù„Ø© Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</p></div>';
        }
        return `
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ø¯Ø©</th>
                        <th>Ù†ÙˆØ¹ Ø§Ù„Ù…Ø¹Ø¯Ø©</th>
                        <th>Ø§Ù„Ù…ÙˆÙ‚Ø¹</th>
                        <th>ØªØ§Ø±ÙŠØ® Ø§Ù„ÙØ­Øµ</th>
                        <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                        <th>Ø§Ù„Ù…ÙØªØ´</th>
                        <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                    </tr>
                </thead>
                <tbody>
                    ${checks.map(check => `
                        <tr>
                            <td>${Utils.escapeHTML(check.equipmentNumber || '')}</td>
                            <td>${Utils.escapeHTML(check.equipmentType || '')}</td>
                            <td>${Utils.escapeHTML(check.location || '')}</td>
                            <td>${check.checkDate ? Utils.formatDate(check.checkDate) : '-'}</td>
                            <td>
                                <span class="badge badge-${check.status === 'ØµØ§Ù„Ø­' ? 'success' : check.status === 'ÙŠØ­ØªØ§Ø¬ Ø¥ØµÙ„Ø§Ø­' ? 'warning' : 'danger'}">
                                    ${check.status || '-'}
                                </span>
                            </td>
                            <td>${Utils.escapeHTML(check.inspector || '')}</td>
                            <td>
                                <button onclick="FireEquipment.viewCheck('${check.id}')" class="btn-icon btn-icon-primary">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
    },

    setupEventListeners() {
        setTimeout(() => {
            const addBtn = document.getElementById('add-fire-check-btn');
            if (addBtn) addBtn.addEventListener('click', () => this.showCheckForm());
        }, 100);
    },

    async showCheckForm(checkData = null) {
        const isEdit = !!checkData;
        const equipmentId = checkData?.id || Utils.generateId('FIRE_EQUIP');
        const qrCodeData = `${window.location.origin}/fire-equipment/${equipmentId}`;
        const qrCode = typeof QRCode !== 'undefined' ? QRCode.generate(qrCodeData, 150) : null;
        
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 700px;">
                <div class="modal-header">
                    <h2 class="modal-title">${isEdit ? 'ØªØ¹Ø¯ÙŠÙ„ ÙØ­Øµ' : 'ØªØ³Ø¬ÙŠÙ„ ÙØ­Øµ Ø¬Ø¯ÙŠØ¯'}</h2>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="fire-check-form" class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ø¯Ø© *</label>
                                <input type="text" id="equipment-number" required class="form-input"
                                    value="${checkData?.equipmentNumber || ''}" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ø¯Ø©">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ù†ÙˆØ¹ Ø§Ù„Ù…Ø¹Ø¯Ø© *</label>
                                <select id="equipment-type" required class="form-input">
                                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù†ÙˆØ¹</option>
                                    <option value="Ø·ÙØ§ÙŠØ© Ø­Ø±ÙŠÙ‚" ${checkData?.equipmentType === 'Ø·ÙØ§ÙŠØ© Ø­Ø±ÙŠÙ‚' ? 'selected' : ''}>Ø·ÙØ§ÙŠØ© Ø­Ø±ÙŠÙ‚</option>
                                    <option value="Ø®Ø±Ø·ÙˆÙ… Ø­Ø±ÙŠÙ‚" ${checkData?.equipmentType === 'Ø®Ø±Ø·ÙˆÙ… Ø­Ø±ÙŠÙ‚' ? 'selected' : ''}>Ø®Ø±Ø·ÙˆÙ… Ø­Ø±ÙŠÙ‚</option>
                                    <option value="ØµÙ†Ø¯ÙˆÙ‚ Ø­Ø±ÙŠÙ‚" ${checkData?.equipmentType === 'ØµÙ†Ø¯ÙˆÙ‚ Ø­Ø±ÙŠÙ‚' ? 'selected' : ''}>ØµÙ†Ø¯ÙˆÙ‚ Ø­Ø±ÙŠÙ‚</option>
                                    <option value="Ø¬Ù‡Ø§Ø² Ø¥Ù†Ø°Ø§Ø±" ${checkData?.equipmentType === 'Ø¬Ù‡Ø§Ø² Ø¥Ù†Ø°Ø§Ø±' ? 'selected' : ''}>Ø¬Ù‡Ø§Ø² Ø¥Ù†Ø°Ø§Ø±</option>
                                    <option value="Ù†Ø¸Ø§Ù… Ø±Ø´ Ù…Ø§Ø¦ÙŠ" ${checkData?.equipmentType === 'Ù†Ø¸Ø§Ù… Ø±Ø´ Ù…Ø§Ø¦ÙŠ' ? 'selected' : ''}>Ù†Ø¸Ø§Ù… Ø±Ø´ Ù…Ø§Ø¦ÙŠ</option>
                                    <option value="Ù…Ø¶Ø®Ø© Ø­Ø±ÙŠÙ‚" ${checkData?.equipmentType === 'Ù…Ø¶Ø®Ø© Ø­Ø±ÙŠÙ‚' ? 'selected' : ''}>Ù…Ø¶Ø®Ø© Ø­Ø±ÙŠÙ‚</option>
                                    <option value="ØµÙ…Ø§Ù… Ø­Ø±ÙŠÙ‚" ${checkData?.equipmentType === 'ØµÙ…Ø§Ù… Ø­Ø±ÙŠÙ‚' ? 'selected' : ''}>ØµÙ…Ø§Ù… Ø­Ø±ÙŠÙ‚</option>
                                    <option value="Ø£Ø®Ø±Ù‰" ${checkData?.equipmentType === 'Ø£Ø®Ø±Ù‰' ? 'selected' : ''}>Ø£Ø®Ø±Ù‰</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„Ù…ÙˆÙ‚Ø¹ *</label>
                                <input type="text" id="equipment-location" required class="form-input"
                                    value="${checkData?.location || ''}" placeholder="Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø¹Ø¯Ø©">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">ØªØ§Ø±ÙŠØ® Ø§Ù„ÙØ­Øµ *</label>
                                <input type="date" id="check-date" required class="form-input"
                                    value="${checkData?.checkDate ? new Date(checkData.checkDate).toISOString().slice(0, 10) : ''}">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„Ù…ÙØªØ´ *</label>
                                <input type="text" id="inspector" required class="form-input"
                                    value="${checkData?.inspector || ''}" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙØªØ´">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„Ø­Ø§Ù„Ø© *</label>
                                <select id="check-status" required class="form-input">
                                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø­Ø§Ù„Ø©</option>
                                    <option value="ØµØ§Ù„Ø­" ${checkData?.status === 'ØµØ§Ù„Ø­' ? 'selected' : ''}>ØµØ§Ù„Ø­</option>
                                    <option value="ÙŠØ­ØªØ§Ø¬ Ø¥ØµÙ„Ø§Ø­" ${checkData?.status === 'ÙŠØ­ØªØ§Ø¬ Ø¥ØµÙ„Ø§Ø­' ? 'selected' : ''}>ÙŠØ­ØªØ§Ø¬ Ø¥ØµÙ„Ø§Ø­</option>
                                    <option value="Ù…Ø¹Ø·Ù„" ${checkData?.status === 'Ù…Ø¹Ø·Ù„' ? 'selected' : ''}>Ù…Ø¹Ø·Ù„</option>
                                </select>
                            </div>
                            <div class="col-span-2">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                                <textarea id="check-notes" class="form-input" rows="3"
                                    placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ÙØ­Øµ">${checkData?.notes || ''}</textarea>
                            </div>
                            ${qrCode ? `
                            <div class="col-span-2">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <i class="fas fa-qrcode ml-2"></i>
                                    QR Code Ù„Ù„Ø¬Ù‡Ø§Ø²
                                </label>
                                <div class="flex items-center gap-4 p-4 border rounded bg-gray-50">
                                    <div>
                                        <img src="${qrCode}" alt="QR Code" class="w-32 h-32 border border-gray-300 p-2 bg-white">
                                    </div>
                                    <div class="flex-1">
                                        <p class="text-sm text-gray-600 mb-2">
                                            ÙŠÙ…ÙƒÙ† Ø·Ø¨Ø§Ø¹Ø© Ù‡Ø°Ø§ QR Code ÙˆÙˆØ¶Ø¹Ù‡ Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ù‡Ø§Ø² Ù„Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹ Ø¥Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙØ­Øµ
                                        </p>
                                        <button type="button" id="print-qr-btn" class="btn-secondary">
                                            <i class="fas fa-print ml-2"></i>Ø·Ø¨Ø§Ø¹Ø© QR Code
                                        </button>
                                    </div>
                                </div>
                            </div>
                            ` : ''}
                        </div>
                        <div class="flex items-center justify-end gap-4 pt-4 border-t">
                            <button type="button" class="btn-secondary" onclick="this.closest('.modal-overlay').remove()">Ø¥Ù„ØºØ§Ø¡</button>
                            <button type="submit" class="btn-primary">
                                <i class="fas fa-save ml-2"></i>${isEdit ? 'Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª' : 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙØ­Øµ'}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        
        // Setup QR Code print button
        const printQrBtn = document.getElementById('print-qr-btn');
        if (printQrBtn && qrCode) {
            printQrBtn.addEventListener('click', () => {
                const printWindow = window.open('', '_blank');
                if (printWindow) {
                    printWindow.document.write(`
                        <!DOCTYPE html>
                        <html dir="rtl" lang="ar">
                        <head>
                            <meta charset="UTF-8">
                            <title>QR Code - ${checkData?.equipmentNumber || equipmentId}</title>
                            <style>
                                body { 
                                    font-family: Arial, sans-serif; 
                                    text-align: center; 
                                    padding: 40px; 
                                    direction: rtl;
                                }
                                img { max-width: 300px; margin: 20px; }
                                h2 { margin: 20px 0; }
                                p { margin: 10px 0; }
                            </style>
                        </head>
                        <body>
                            <h2>QR Code Ù„Ø¬Ù‡Ø§Ø² Ø§Ù„Ø­Ø±ÙŠÙ‚</h2>
                            <p><strong>Ø±Ù‚Ù… Ø§Ù„Ø¬Ù‡Ø§Ø²:</strong> ${checkData?.equipmentNumber || equipmentId}</p>
                            <p><strong>Ù†ÙˆØ¹ Ø§Ù„Ø¬Ù‡Ø§Ø²:</strong> ${checkData?.equipmentType || ''}</p>
                            <img src="${qrCode}" alt="QR Code">
                            <p>${qrCodeData}</p>
                            <script>window.onload = () => window.print();</script>
                        </body>
                        </html>
                    `);
                    printWindow.document.close();
                }
            });
        }
        
        const form = modal.querySelector('#fire-check-form');
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = {
                id: isEdit ? checkData.id : equipmentId,
                equipmentNumber: document.getElementById('equipment-number').value.trim(),
                equipmentType: document.getElementById('equipment-type').value,
                location: document.getElementById('equipment-location').value.trim(),
                checkDate: new Date(document.getElementById('check-date').value).toISOString(),
                inspector: document.getElementById('inspector').value.trim(),
                status: document.getElementById('check-status').value,
                notes: document.getElementById('check-notes').value.trim(),
                qrCode: qrCode || checkData?.qrCode,
                qrCodeData: qrCodeData,
                createdAt: checkData?.createdAt || new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            Loading.show();
            try {
                if (isEdit) {
                    const index = AppState.appData.fireEquipment.findIndex(c => c.id === checkData.id);
                    if (index !== -1) AppState.appData.fireEquipment[index] = formData;
                } else {
                    AppState.appData.fireEquipment.push(formData);
                }
                DataManager.save();
                // Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙÙŠ Google Sheets
                await GoogleIntegration.autoSave('FireEquipment', AppState.appData.fireEquipment);
                Loading.hide();
                Notification.success(`ØªÙ… ${isEdit ? 'ØªØ­Ø¯ÙŠØ«' : 'ØªØ³Ø¬ÙŠÙ„'} Ø§Ù„ÙØ­Øµ Ø¨Ù†Ø¬Ø§Ø­`);
                modal.remove();
                this.load();
            } catch (error) {
                Loading.hide();
                Notification.error('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
            }
        });
        
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
        });
    },

    async viewCheck(id) {
        const check = AppState.appData.fireEquipment.find(c => c.id === id);
        if (!check) return;
        
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 700px;">
                <div class="modal-header">
                    <h2 class="modal-title">ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙØ­Øµ</h2>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm font-semibold text-gray-600">Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ø¯Ø©:</label>
                                <p class="text-gray-800">${Utils.escapeHTML(check.equipmentNumber || '')}</p>
                            </div>
                            <div>
                                <label class="text-sm font-semibold text-gray-600">Ù†ÙˆØ¹ Ø§Ù„Ù…Ø¹Ø¯Ø©:</label>
                                <p class="text-gray-800">${Utils.escapeHTML(check.equipmentType || '')}</p>
                            </div>
                            <div>
                                <label class="text-sm font-semibold text-gray-600">Ø§Ù„Ù…ÙˆÙ‚Ø¹:</label>
                                <p class="text-gray-800">${Utils.escapeHTML(check.location || '')}</p>
                            </div>
                            <div>
                                <label class="text-sm font-semibold text-gray-600">ØªØ§Ø±ÙŠØ® Ø§Ù„ÙØ­Øµ:</label>
                                <p class="text-gray-800">${check.checkDate ? Utils.formatDate(check.checkDate) : '-'}</p>
                            </div>
                            <div>
                                <label class="text-sm font-semibold text-gray-600">Ø§Ù„Ù…ÙØªØ´:</label>
                                <p class="text-gray-800">${Utils.escapeHTML(check.inspector || '')}</p>
                            </div>
                            <div>
                                <label class="text-sm font-semibold text-gray-600">Ø§Ù„Ø­Ø§Ù„Ø©:</label>
                                <span class="badge badge-${check.status === 'Ù…ÙƒØªÙ…Ù„' ? 'success' : check.status === 'Ø¨Ø­Ø§Ø¬Ø© Ù„Ø¥ØµÙ„Ø§Ø­' ? 'warning' : 'info'}">
                                    ${check.status || '-'}
                                </span>
                            </div>
                            <div class="col-span-2">
                                <label class="text-sm font-semibold text-gray-600">Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</label>
                                <p class="text-gray-800">${Utils.escapeHTML(check.notes || '')}</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" onclick="this.closest('.modal-overlay').remove()">Ø¥ØºÙ„Ø§Ù‚</button>
                    <button class="btn-primary" onclick="FireEquipment.showCheckForm(${JSON.stringify(check).replace(/"/g, '&quot;')}); this.closest('.modal-overlay').remove();">
                        <i class="fas fa-edit ml-2"></i>ØªØ¹Ø¯ÙŠÙ„
                    </button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
        });
    }
};

// ===== PPE Module (Ù…Ù‡Ù…Ø§Øª Ø§Ù„ÙˆÙ‚Ø§ÙŠØ© Ø§Ù„Ø´Ø®ØµÙŠØ©) =====
const PPE = {
    async load() {
        const section = document.getElementById('ppe-section');
        if (!section) return;

        section.innerHTML = `
            <div class="section-header">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="section-title">
                            <i class="fas fa-hard-hat ml-3"></i>
                            Ø¥Ø¯Ø§Ø±Ø© Ù…Ù‡Ù…Ø§Øª Ø§Ù„ÙˆÙ‚Ø§ÙŠØ© Ø§Ù„Ø´Ø®ØµÙŠØ©
                        </h1>
                        <p class="section-subtitle">ØªØ³Ø¬ÙŠÙ„ ÙˆÙ…ØªØ§Ø¨Ø¹Ø© Ø§Ø³ØªÙ„Ø§Ù… Ù…Ù‡Ù…Ø§Øª Ø§Ù„ÙˆÙ‚Ø§ÙŠØ© Ø§Ù„Ø´Ø®ØµÙŠØ©</p>
                    </div>
                    <button id="add-ppe-btn" class="btn-primary">
                        <i class="fas fa-plus ml-2"></i>
                        ØªØ³Ø¬ÙŠÙ„ Ø§Ø³ØªÙ„Ø§Ù… Ø¬Ø¯ÙŠØ¯
                    </button>
                </div>
            </div>
            <div class="mt-6">
                <div class="content-card">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-list ml-2"></i>Ø³Ø¬Ù„ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…Ø§Øª</h2>
                    </div>
                    <div class="card-body">
                        <div id="ppe-list">
                            ${await this.renderPPEList()}
                        </div>
                    </div>
                </div>
            </div>
        `;
        this.setupEventListeners();
    },

    async renderPPEList() {
        const ppeList = AppState.appData.ppe || [];
        if (ppeList.length === 0) {
            return '<div class="empty-state"><p class="text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ø³ØªÙ„Ø§Ù…Ø§Øª Ù…Ø³Ø¬Ù„Ø©</p></div>';
        }
        return `
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Ø±Ù‚Ù… Ø§Ù„Ø¥ÙŠØµØ§Ù„</th>
                        <th>Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù</th>
                        <th>Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</th>
                        <th>Ù†ÙˆØ¹ Ø§Ù„Ù…Ø¹Ø¯Ø©</th>
                        <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                        <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</th>
                        <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                        <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                    </tr>
                </thead>
                <tbody>
                    ${ppeList.map(item => `
                        <tr>
                            <td class="font-mono font-semibold">${Utils.escapeHTML(item.receiptNumber || item.id || '')}</td>
                            <td>${Utils.escapeHTML(item.employeeName || '')}</td>
                            <td>${Utils.escapeHTML(item.employeeCode || item.employeeNumber || '')}</td>
                            <td>${Utils.escapeHTML(item.equipmentType || '')}</td>
                            <td>${item.quantity || 0}</td>
                            <td>${item.receiptDate ? Utils.formatDate(item.receiptDate) : '-'}</td>
                            <td>
                                <span class="badge badge-${item.status === 'Ù…Ø³ØªÙ„Ù…' ? 'success' : 'warning'}">
                                    ${item.status || '-'}
                                </span>
                            </td>
                            <td>
                                <div class="flex items-center gap-2">
                                    <button onclick="PPE.viewPPE('${item.id}')" class="btn-icon btn-icon-info" title="Ø¹Ø±Ø¶">
                                    <i class="fas fa-eye"></i>
                                </button>
                                    <button onclick="PPE.exportPDF('${item.id}')" class="btn-icon btn-icon-success" title="ØªØµØ¯ÙŠØ± PDF">
                                        <i class="fas fa-file-pdf"></i>
                                    </button>
                                    <button onclick="PPE.showPPEForm(${JSON.stringify(item).replace(/"/g, '&quot;')});" class="btn-icon btn-icon-primary" title="ØªØ¹Ø¯ÙŠÙ„">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
    },

    setupEventListeners() {
        setTimeout(() => {
            const addBtn = document.getElementById('add-ppe-btn');
            const viewMatrixBtn = document.getElementById('view-ppe-matrix-btn');
            if (addBtn) addBtn.addEventListener('click', () => this.showPPEForm());
            if (viewMatrixBtn) viewMatrixBtn.addEventListener('click', () => this.showPPEMatrix());
        }, 100);
    },

    async showPPEForm(ppeData = null) {
        const isEdit = !!ppeData;
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 700px;">
                <div class="modal-header">
                    <h2 class="modal-title">${isEdit ? 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ø³ØªÙ„Ø§Ù…' : 'ØªØ³Ø¬ÙŠÙ„ Ø§Ø³ØªÙ„Ø§Ù… Ø¬Ø¯ÙŠØ¯'}</h2>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="ppe-form" class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù *</label>
                                <div class="relative">
                                    <input type="text" id="ppe-employee-name" required class="form-input"
                                        value="${ppeData?.employeeName || ''}" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ"
                                        autocomplete="off">
                                    <div id="ppe-employee-dropdown" class="absolute z-50 hidden w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-auto">
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ *</label>
                                <input type="text" id="ppe-employee-code" required class="form-input"
                                    value="${ppeData?.employeeCode || ppeData?.employeeNumber || ''}" placeholder="Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ù†ÙˆØ¹ Ø§Ù„Ù…Ø¹Ø¯Ø© *</label>
                                <select id="ppe-equipment-type" required class="form-input">
                                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù†ÙˆØ¹</option>
                                    <option value="Ø®ÙˆØ°Ø©" ${ppeData?.equipmentType === 'Ø®ÙˆØ°Ø©' ? 'selected' : ''}>Ø®ÙˆØ°Ø©</option>
                                    <option value="Ù†Ø¸Ø§Ø±Ø§Øª ÙˆÙ‚Ø§ÙŠØ©" ${ppeData?.equipmentType === 'Ù†Ø¸Ø§Ø±Ø§Øª ÙˆÙ‚Ø§ÙŠØ©' ? 'selected' : ''}>Ù†Ø¸Ø§Ø±Ø§Øª ÙˆÙ‚Ø§ÙŠØ©</option>
                                    <option value="Ù‚ÙØ§Ø²Ø§Øª" ${ppeData?.equipmentType === 'Ù‚ÙØ§Ø²Ø§Øª' ? 'selected' : ''}>Ù‚ÙØ§Ø²Ø§Øª</option>
                                    <option value="Ø£Ø­Ø°ÙŠØ© Ø£Ù…Ø§Ù†" ${ppeData?.equipmentType === 'Ø£Ø­Ø°ÙŠØ© Ø£Ù…Ø§Ù†' ? 'selected' : ''}>Ø£Ø­Ø°ÙŠØ© Ø£Ù…Ø§Ù†</option>
                                    <option value="Ø¨Ø¯Ù„Ø© ÙˆØ§Ù‚ÙŠØ©" ${ppeData?.equipmentType === 'Ø¨Ø¯Ù„Ø© ÙˆØ§Ù‚ÙŠØ©' ? 'selected' : ''}>Ø¨Ø¯Ù„Ø© ÙˆØ§Ù‚ÙŠØ©</option>
                                    <option value="Ø£Ø®Ø±Ù‰" ${ppeData?.equipmentType === 'Ø£Ø®Ø±Ù‰' ? 'selected' : ''}>Ø£Ø®Ø±Ù‰</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„ÙƒÙ…ÙŠØ© *</label>
                                <input type="number" id="ppe-quantity" required class="form-input" min="1"
                                    value="${ppeData?.quantity || 1}" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… *</label>
                                <input type="date" id="ppe-receipt-date" required class="form-input"
                                    value="${ppeData?.receiptDate ? new Date(ppeData.receiptDate).toISOString().slice(0, 10) : ''}">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„Ø­Ø§Ù„Ø© *</label>
                                <select id="ppe-status" required class="form-input">
                                    <option value="Ù…Ø³ØªÙ„Ù…" ${ppeData?.status === 'Ù…Ø³ØªÙ„Ù…' ? 'selected' : ''}>Ù…Ø³ØªÙ„Ù…</option>
                                    <option value="Ù‚ÙŠØ¯ Ø§Ù„ØªØ³Ù„ÙŠÙ…" ${ppeData?.status === 'Ù‚ÙŠØ¯ Ø§Ù„ØªØ³Ù„ÙŠÙ…' ? 'selected' : ''}>Ù‚ÙŠØ¯ Ø§Ù„ØªØ³Ù„ÙŠÙ…</option>
                                </select>
                            </div>
                        </div>
                        <div class="flex items-center justify-end gap-4 pt-4 border-t">
                            <button type="button" class="btn-secondary" onclick="this.closest('.modal-overlay').remove()">Ø¥Ù„ØºØ§Ø¡</button>
                            <button type="submit" class="btn-primary">
                                <i class="fas fa-save ml-2"></i>${isEdit ? 'Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª' : 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…'}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        
        // Setup employee code search and autocomplete for PPE form
        setTimeout(() => {
            const codeInput = document.getElementById('ppe-employee-code');
            const nameInput = document.getElementById('ppe-employee-name');
            const dropdown = document.getElementById('ppe-employee-dropdown');
            
            if (codeInput && nameInput) {
                // Setup code search - fill data when code is entered (on blur)
                const fillEmployeeData = () => {
                    const code = codeInput.value.trim();
                    if (!code) return;
                    
                    const employees = AppState.appData.employees || [];
                    const emp = employees.find(e => 
                        (e.employeeNumber && e.employeeNumber === code) ||
                        (e.sapId && e.sapId === code)
                    );
                    
                    if (emp) {
                        nameInput.value = emp.name || '';
                    } else {
                        Notification.warning('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…ÙˆØ¸Ù Ø¨Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯');
                    }
                };
                
                codeInput.addEventListener('blur', fillEmployeeData);
                
                // Setup autocomplete dropdown for name input
                if (dropdown) {
                    nameInput.addEventListener('input', (e) => {
                        const searchTerm = e.target.value.trim();
                        dropdown.innerHTML = '';
                        dropdown.classList.add('hidden');
                        
                        if (searchTerm.length < 2) return;
                        
                        const employees = AppState.appData.employees || [];
                        const matches = employees.filter(emp => {
                            const code = emp.employeeNumber || emp.sapId || '';
                            const name = emp.name || '';
                            const searchLower = searchTerm.toLowerCase();
                            return code.includes(searchTerm) || name.toLowerCase().includes(searchLower);
                        }).slice(0, 10);
                        
                        if (matches.length > 0) {
                            dropdown.innerHTML = matches.map(emp => `
                                <div class="p-3 hover:bg-blue-50 cursor-pointer border-b border-gray-100" 
                                     onclick="
                                        const codeInput = document.getElementById('ppe-employee-code');
                                        const nameInput = document.getElementById('ppe-employee-name');
                                        if(codeInput) codeInput.value = '${emp.employeeNumber || emp.sapId || ''}';
                                        if(nameInput) nameInput.value = '${Utils.escapeHTML(emp.name || '')}';
                                        const dropdown = document.getElementById('ppe-employee-dropdown');
                                        if(dropdown) dropdown.classList.add('hidden');
                                     ">
                                    <div class="font-semibold text-gray-800">${Utils.escapeHTML(emp.employeeNumber || emp.sapId || '')}</div>
                                    <div class="text-sm text-gray-700">${Utils.escapeHTML(emp.name || '')}</div>
                                </div>
                            `).join('');
                            dropdown.classList.remove('hidden');
                        }
                    });
                    
                    document.addEventListener('click', (e) => {
                        if (!nameInput.contains(e.target) && !dropdown.contains(e.target)) {
                            dropdown.classList.add('hidden');
                        }
                    });
                }
            }
        }, 200);
        
        const form = modal.querySelector('#ppe-form');
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // ØªÙˆÙ„ÙŠØ¯ Ø±Ù‚Ù… Ø¥ÙŠØµØ§Ù„ Ù…Ø³Ù„Ø³Ù„
            const existingPPE = AppState.appData.ppe || [];
            const currentYear = new Date().getFullYear();
            const existingNumbers = existingPPE
                .filter(p => p.receiptNumber && p.receiptNumber.startsWith(`PPE-${currentYear}-`))
                .map(p => {
                    const match = p.receiptNumber.match(/\d+$/);
                    return match ? parseInt(match[0]) : 0;
                });
            const nextNumber = existingNumbers.length > 0 ? Math.max(...existingNumbers) + 1 : 1;
            const receiptNumber = isEdit && ppeData?.receiptNumber 
                ? ppeData.receiptNumber 
                : `PPE-${currentYear}-${String(nextNumber).padStart(4, '0')}`;
            
            const formData = {
                id: ppeData?.id || Utils.generateId('PPE'),
                receiptNumber: receiptNumber,
                employeeName: document.getElementById('ppe-employee-name').value.trim(),
                employeeCode: document.getElementById('ppe-employee-code').value.trim(),
                employeeNumber: document.getElementById('ppe-employee-code').value.trim(),
                equipmentType: document.getElementById('ppe-equipment-type').value,
                quantity: parseInt(document.getElementById('ppe-quantity').value) || 1,
                receiptDate: new Date(document.getElementById('ppe-receipt-date').value).toISOString(),
                status: document.getElementById('ppe-status').value,
                createdAt: ppeData?.createdAt || new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            Loading.show();
            try {
                if (isEdit) {
                    const index = AppState.appData.ppe.findIndex(p => p.id === ppeData.id);
                    if (index !== -1) AppState.appData.ppe[index] = formData;
                } else {
                    AppState.appData.ppe.push(formData);
                }
                DataManager.save();
                // Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙÙŠ Google Sheets
                await GoogleIntegration.autoSave('PPE', AppState.appData.ppe);
                Loading.hide();
                Notification.success(`ØªÙ… ${isEdit ? 'ØªØ­Ø¯ÙŠØ«' : 'ØªØ³Ø¬ÙŠÙ„'} Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… Ø¨Ù†Ø¬Ø§Ø­`);
                modal.remove();
                this.load();
            } catch (error) {
                Loading.hide();
                Notification.error('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
            }
        });
        
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
        });
    },

    async viewPPE(id) {
        const item = AppState.appData.ppe.find(p => p.id === id);
        if (!item) return;
        
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 700px;">
                <div class="modal-header">
                    <h2 class="modal-title">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</h2>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm font-semibold text-gray-600">Ø±Ù‚Ù… Ø§Ù„Ø¥ÙŠØµØ§Ù„:</label>
                                <p class="text-gray-800 font-mono font-semibold text-lg">${Utils.escapeHTML(item.receiptNumber || item.id || '')}</p>
                            </div>
                            <div>
                                <label class="text-sm font-semibold text-gray-600">Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù:</label>
                                <p class="text-gray-800">${Utils.escapeHTML(item.employeeName || '')}</p>
                            </div>
                            <div>
                                <label class="text-sm font-semibold text-gray-600">Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ:</label>
                                <p class="text-gray-800">${Utils.escapeHTML(item.employeeCode || item.employeeNumber || '')}</p>
                            </div>
                            <div>
                                <label class="text-sm font-semibold text-gray-600">Ù†ÙˆØ¹ Ø§Ù„Ù…Ø¹Ø¯Ø©:</label>
                                <p class="text-gray-800">${Utils.escapeHTML(item.equipmentType || '')}</p>
                            </div>
                            <div>
                                <label class="text-sm font-semibold text-gray-600">Ø§Ù„ÙƒÙ…ÙŠØ©:</label>
                                <p class="text-gray-800">${item.quantity || 0}</p>
                            </div>
                            <div>
                                <label class="text-sm font-semibold text-gray-600">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…:</label>
                                <p class="text-gray-800">${item.receiptDate ? Utils.formatDate(item.receiptDate) : '-'}</p>
                            </div>
                            <div>
                                <label class="text-sm font-semibold text-gray-600">Ø§Ù„Ø­Ø§Ù„Ø©:</label>
                                <span class="badge badge-${item.status === 'Ù…Ø³ØªÙ„Ù…' ? 'success' : 'warning'}">
                                    ${item.status || '-'}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" onclick="this.closest('.modal-overlay').remove()">Ø¥ØºÙ„Ø§Ù‚</button>
                    <button class="btn-success" onclick="PPE.exportPDF('${item.id}');">
                        <i class="fas fa-file-pdf ml-2"></i>ØªØµØ¯ÙŠØ± PDF
                    </button>
                    <button class="btn-primary" onclick="PPE.showPPEForm(${JSON.stringify(item).replace(/"/g, '&quot;')}); this.closest('.modal-overlay').remove();">
                        <i class="fas fa-edit ml-2"></i>ØªØ¹Ø¯ÙŠÙ„
                    </button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
        });
    },
    
    /**
     * Ø¹Ø±Ø¶ Ù…ØµÙÙˆÙØ© Ù…Ù‡Ù…Ø§Øª Ø§Ù„ÙˆÙ‚Ø§ÙŠØ© Ù„ÙƒÙ„ Ù…ÙˆØ¸Ù Ø­Ø³Ø¨ Ø§Ù„ÙˆØ¸ÙŠÙØ©
     */
    async showPPEMatrix() {
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 1400px; max-height: 90vh; overflow-y: auto;">
                <div class="modal-header">
                    <h2 class="modal-title">
                        <i class="fas fa-table ml-2"></i>
                        Ù…ØµÙÙˆÙØ© Ù…Ù‡Ù…Ø§Øª Ø§Ù„ÙˆÙ‚Ø§ÙŠØ© Ø§Ù„Ø´Ø®ØµÙŠØ© Ù„ÙƒÙ„ Ù…ÙˆØ¸Ù
                    </h2>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="mb-4">
                        <div class="flex gap-2 items-center">
                            <input type="text" id="ppe-matrix-search" class="form-input" style="max-width: 400px;" 
                                placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ù…ÙˆØ¸Ù (Ø§Ù„ÙƒÙˆØ¯ Ø£Ùˆ Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„ÙˆØ¸ÙŠÙØ©)">
                            <button id="add-ppe-matrix-btn" class="btn-primary">
                                <i class="fas fa-plus ml-2"></i>
                                Ø¥Ø¶Ø§ÙØ© Ù…ØµÙÙˆÙØ© Ù„ÙˆØ¸ÙŠÙØ© Ø¬Ø¯ÙŠØ¯Ø©
                            </button>
                        </div>
                    </div>
                    <div id="ppe-matrix-content">
                        ${await this.renderPPEMatrix()}
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" onclick="this.closest('.modal-overlay').remove()">Ø¥ØºÙ„Ø§Ù‚</button>
                    <button class="btn-primary" onclick="PPE.exportPPEMatrix()">
                        <i class="fas fa-file-excel ml-2"></i>ØªØµØ¯ÙŠØ± Excel
                    </button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        
        // Setup search
        const searchInput = document.getElementById('ppe-matrix-search');
        if (searchInput) {
            searchInput.addEventListener('input', (e) => {
                this.filterPPEMatrix(e.target.value.trim());
            });
        }
        
        // Setup add matrix button
        const addMatrixBtn = document.getElementById('add-ppe-matrix-btn');
        if (addMatrixBtn) {
            addMatrixBtn.addEventListener('click', () => {
                this.showAddPPEMatrixForm();
            });
        }
        
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
        });
    },
    
    async renderPPEMatrix() {
        const matrix = AppState.appData.employeePPEMatrix || {};
        const employees = AppState.appData.employees || [];
        const ppeList = AppState.appData.ppe || [];
        
        // Ø¥Ù†Ø´Ø§Ø¡ Ù…ØµÙÙˆÙØ© Ù…Ù‡Ù…Ø§Øª Ø§Ù„ÙˆÙ‚Ø§ÙŠØ© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ÙˆØ§Ù„ÙˆØ¸Ø§Ø¦Ù
        if (Object.keys(matrix).length === 0) {
            // Ø¥Ù†Ø´Ø§Ø¡ Ù…ØµÙÙˆÙØ© Ù„ÙƒÙ„ Ù…ÙˆØ¸Ù Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙØ©
            const positions = {};
            employees.forEach(emp => {
                const position = emp.position || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                if (!positions[position]) {
                    positions[position] = [];
                }
                positions[position].push(emp);
            });
            
            // Ø¥Ù†Ø´Ø§Ø¡ Ù…ØµÙÙˆÙØ© Ù„ÙƒÙ„ ÙˆØ¸ÙŠÙØ©
            Object.keys(positions).forEach(position => {
                if (!matrix[position]) {
                    matrix[position] = {
                        requiredPPE: [], // Ù…Ù‡Ù…Ø§Øª Ø§Ù„ÙˆÙ‚Ø§ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù„Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ¸ÙŠÙØ©
                        employees: positions[position].map(e => e.employeeNumber || e.sapId)
                    };
                }
            });
            
            AppState.appData.employeePPEMatrix = matrix;
            DataManager.save();
        }
        
        if (Object.keys(matrix).length === 0) {
            return `
                <div class="empty-state">
                    <i class="fas fa-table text-4xl text-gray-300 mb-4"></i>
                    <p class="text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØµÙÙˆÙØ© Ù…Ù‡Ù…Ø§Øª Ø§Ù„ÙˆÙ‚Ø§ÙŠØ©</p>
                    <button onclick="PPE.showAddPPEMatrixForm()" class="btn-primary mt-4">
                        <i class="fas fa-plus ml-2"></i>Ø¥Ø¶Ø§ÙØ© Ù…ØµÙÙˆÙØ© Ù„ÙˆØ¸ÙŠÙØ© Ø¬Ø¯ÙŠØ¯Ø©
                    </button>
                </div>
            `;
        }
        
        return `
            <div class="table-wrapper" style="overflow-x: auto;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Ø§Ù„ÙˆØ¸ÙŠÙØ©</th>
                            <th>Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</th>
                            <th>Ù…Ù‡Ù…Ø§Øª Ø§Ù„ÙˆÙ‚Ø§ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©</th>
                            <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${Object.keys(matrix).map(position => {
                            const matrixData = matrix[position];
                            const employeeCount = matrixData.employees?.length || 0;
                            const requiredPPE = matrixData.requiredPPE || [];
                            
                            return `
                                <tr data-position="${Utils.escapeHTML(position)}">
                                    <td><strong>${Utils.escapeHTML(position)}</strong></td>
                                    <td>
                                        <span class="badge badge-info">${employeeCount}</span>
                                    </td>
                                    <td>
                                        <div class="flex flex-wrap gap-2">
                                            ${requiredPPE.length > 0 ? requiredPPE.map(ppe => `
                                                <span class="badge badge-success">${Utils.escapeHTML(ppe)}</span>
                                            `).join('') : '<span class="text-gray-500 text-sm">Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…Ù‡Ù…Ø§Øª Ø§Ù„ÙˆÙ‚Ø§ÙŠØ©</span>'}
                                        </div>
                                    </td>
                                    <td>
                                        <button onclick="PPE.editPPEMatrix('${Utils.escapeHTML(position)}')" class="btn-icon btn-icon-primary" title="ØªØ¹Ø¯ÙŠÙ„">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button onclick="PPE.viewPositionEmployees('${Utils.escapeHTML(position)}')" class="btn-icon btn-icon-info" title="Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†">
                                            <i class="fas fa-users"></i>
                                        </button>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
        `;
    },
    
    filterPPEMatrix(searchTerm) {
        const tbody = document.querySelector('#ppe-matrix-content tbody');
        if (!tbody) return;
        
        const rows = tbody.querySelectorAll('tr[data-position]');
        rows.forEach(row => {
            const position = row.getAttribute('data-position') || '';
            const searchLower = searchTerm.toLowerCase();
            
            if (!searchTerm || position.toLowerCase().includes(searchLower)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    },
    
    async showAddPPEMatrixForm(position = null) {
        const isEdit = !!position;
        const matrix = AppState.appData.employeePPEMatrix || {};
        const ppeList = AppState.appData.ppe || [];
        const ppeTypes = [...new Set(ppeList.map(p => p.equipmentType).filter(Boolean))];
        const employees = AppState.appData.employees || [];
        const positions = [...new Set(employees.map(e => e.position).filter(Boolean))];
        const matrixData = position ? matrix[position] : null;
        
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 900px;">
                <div class="modal-header">
                    <h2 class="modal-title">
                        <i class="fas fa-plus-circle ml-2"></i>
                        ${isEdit ? 'ØªØ¹Ø¯ÙŠÙ„ Ù…ØµÙÙˆÙØ© Ù…Ù‡Ù…Ø§Øª Ø§Ù„ÙˆÙ‚Ø§ÙŠØ©' : 'Ø¥Ø¶Ø§ÙØ© Ù…ØµÙÙˆÙØ© Ù…Ù‡Ù…Ø§Øª Ø§Ù„ÙˆÙ‚Ø§ÙŠØ© Ù„ÙˆØ¸ÙŠÙØ©'}
                    </h2>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="ppe-matrix-form" class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„ÙˆØ¸ÙŠÙØ© *</label>
                                ${isEdit ? `
                                    <input type="text" id="ppe-matrix-position" value="${Utils.escapeHTML(position)}" class="form-input" readonly>
                                ` : `
                                    <select id="ppe-matrix-position" required class="form-input">
                                        <option value="">Ø§Ø®ØªØ± Ø§Ù„ÙˆØ¸ÙŠÙØ©</option>
                                        ${positions.map(p => `
                                            <option value="${Utils.escapeHTML(p)}" ${matrix[p] ? 'disabled' : ''}>${Utils.escapeHTML(p)}${matrix[p] ? ' (Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„)' : ''}</option>
                                        `).join('')}
                                        <option value="__custom__">Ø¥Ø¶Ø§ÙØ© ÙˆØ¸ÙŠÙØ© Ø¬Ø¯ÙŠØ¯Ø©</option>
                                    </select>
                                    <input type="text" id="ppe-matrix-position-custom" class="form-input mt-2" style="display: none;" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„ÙˆØ¸ÙŠÙØ©">
                                `}
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ù…Ù‡Ù…Ø§Øª Ø§Ù„ÙˆÙ‚Ø§ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù„Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ¸ÙŠÙØ© *</label>
                            <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                                <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                                    ${ppeTypes.map((type, index) => `
                                        <label class="flex items-center p-2 border rounded cursor-pointer hover:bg-blue-50 transition-colors">
                                            <input type="checkbox" name="ppe-type" value="${Utils.escapeHTML(type)}" 
                                                ${matrixData && matrixData.requiredPPE && matrixData.requiredPPE.includes(type) ? 'checked' : ''}
                                                class="ml-2 rounded border-gray-300 text-blue-600">
                                            <span class="text-sm font-medium">${Utils.escapeHTML(type)}</span>
                                        </label>
                                    `).join('')}
                                    ${ppeTypes.length === 0 ? `
                                        <div class="col-span-3 text-center text-gray-500 py-4">
                                            Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù†ÙˆØ§Ø¹ Ù…Ù‡Ù…Ø§Øª ÙˆÙ‚Ø§ÙŠØ© Ù…Ø³Ø¬Ù„Ø©. ÙŠØ±Ø¬Ù‰ Ø¥Ø¶Ø§ÙØ© Ø§Ø³ØªÙ„Ø§Ù…Ø§Øª Ù…Ù‡Ù…Ø§Øª ÙˆÙ‚Ø§ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹.
                                        </div>
                                    ` : ''}
                                </div>
                                <div class="mt-4">
                                    <input type="text" id="ppe-matrix-custom-type" class="form-input" placeholder="Ø£Ùˆ Ø£Ø¯Ø®Ù„ Ù†ÙˆØ¹ Ù…Ù‡Ù…Ø© ÙˆÙ‚Ø§ÙŠØ© Ù…Ø®ØµØµØ©">
                                    <button type="button" onclick="
                                        const customType = document.getElementById('ppe-matrix-custom-type');
                                        if(customType && customType.value.trim()) {
                                            const container = document.querySelector('#ppe-matrix-form .grid');
                                            const newLabel = document.createElement('label');
                                            newLabel.className = 'flex items-center p-2 border rounded cursor-pointer hover:bg-blue-50 transition-colors';
                                            const typeValue = customType.value.trim();
                                            newLabel.innerHTML = '<input type=\\'checkbox\\' name=\\'ppe-type\\' value=\\'' + typeValue + '\\' checked class=\\'ml-2 rounded border-gray-300 text-blue-600\\'><span class=\\'text-sm font-medium\\'>' + typeValue + '</span>';
                                            container.appendChild(newLabel);
                                            customType.value = '';
                                        }
                                    " class="btn-secondary mt-2">
                                        <i class="fas fa-plus ml-2"></i>Ø¥Ø¶Ø§ÙØ©
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                            <p class="text-sm text-blue-800">
                                <i class="fas fa-info-circle ml-1"></i>
                                <strong>Ù…Ù„Ø§Ø­Ø¸Ø©:</strong> Ø³ÙŠØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ù‡Ø°Ù‡ Ø§Ù„Ù…ØµÙÙˆÙØ© Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ø°ÙŠÙ† Ù„Ø¯ÙŠÙ‡Ù… Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ¸ÙŠÙØ©.
                            </p>
                        </div>
                        
                        <div class="flex items-center justify-end gap-4 pt-4 border-t">
                            <button type="button" class="btn-secondary" onclick="this.closest('.modal-overlay').remove()">Ø¥Ù„ØºØ§Ø¡</button>
                            <button type="submit" class="btn-primary">
                                <i class="fas fa-save ml-2"></i>${isEdit ? 'Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª' : 'Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ØµÙÙˆÙØ©'}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        
        // Handle custom position input
        const positionSelect = document.getElementById('ppe-matrix-position');
        const customPositionInput = document.getElementById('ppe-matrix-position-custom');
        if (positionSelect && customPositionInput) {
            positionSelect.addEventListener('change', () => {
                if (positionSelect.value === '__custom__') {
                    customPositionInput.style.display = 'block';
                    customPositionInput.required = true;
                } else {
                    customPositionInput.style.display = 'none';
                    customPositionInput.required = false;
                }
            });
        }
        
        const form = modal.querySelector('#ppe-matrix-form');
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const selectedPosition = isEdit ? position : (positionSelect?.value === '__custom__' ? customPositionInput?.value.trim() : positionSelect?.value);
            if (!selectedPosition) {
                Notification.error('ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙˆØ¸ÙŠÙØ©');
                return;
            }
            
            const checkedPPE = Array.from(form.querySelectorAll('input[name="ppe-type"]:checked')).map(cb => cb.value);
            if (checkedPPE.length === 0) {
                Notification.error('ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ù…Ù‡Ù…Ø§Øª ÙˆÙ‚Ø§ÙŠØ© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
                return;
            }
            
            // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø¨Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ¸ÙŠÙØ© (Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ Ù…Ù† Ø¬Ø¯ÙˆÙ„ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†)
            const employeesWithPosition = employees.filter(e => e.position === selectedPosition).map(e => e.employeeNumber || e.sapId || '');
            
            if (!AppState.appData.employeePPEMatrix) {
                AppState.appData.employeePPEMatrix = {};
            }
            
            const matrixData = AppState.appData.employeePPEMatrix[selectedPosition] || {};
            
            // ØªØ­Ø¯ÙŠØ« Ù…ØµÙÙˆÙØ© Ù…Ù‡Ù…Ø§Øª Ø§Ù„ÙˆÙ‚Ø§ÙŠØ© Ù„Ù„ÙˆØ¸ÙŠÙØ© (Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø¹Ø¨Ø± Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ)
            AppState.appData.employeePPEMatrix[selectedPosition] = {
                requiredPPE: checkedPPE,
                employees: employeesWithPosition, // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ Ù„Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø¨Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ¸ÙŠÙØ©
                updatedAt: new Date().toISOString(),
                createdAt: matrixData?.createdAt || new Date().toISOString()
            };
            
            // ØªØ­Ø¯ÙŠØ« Ù…ØµÙÙˆÙØ© Ù…Ù‡Ù…Ø§Øª Ø§Ù„ÙˆÙ‚Ø§ÙŠØ© Ù„ÙƒÙ„ Ù…ÙˆØ¸Ù Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ
            if (!AppState.appData.employeePPEMatrixByCode) {
                AppState.appData.employeePPEMatrixByCode = {};
            }
            
            employeesWithPosition.forEach(code => {
                if (code) {
                    if (!AppState.appData.employeePPEMatrixByCode[code]) {
                        AppState.appData.employeePPEMatrixByCode[code] = [];
                    }
                    // Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø§Øª Ø§Ù„ÙˆÙ‚Ø§ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¸Ù (Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©)
                    checkedPPE.forEach(ppe => {
                        if (!AppState.appData.employeePPEMatrixByCode[code].includes(ppe)) {
                            AppState.appData.employeePPEMatrixByCode[code].push(ppe);
                        }
                    });
                }
            });
            
            DataManager.save();
            GoogleIntegration.autoSave('PPEMatrix', AppState.appData.employeePPEMatrix);
            
            Notification.success('ØªÙ… ' + (isEdit ? 'ØªØ­Ø¯ÙŠØ«' : 'Ø¥Ø¶Ø§ÙØ©') + ' Ù…ØµÙÙˆÙØ© Ù…Ù‡Ù…Ø§Øª Ø§Ù„ÙˆÙ‚Ø§ÙŠØ© Ù„Ù„ÙˆØ¸ÙŠÙØ© "' + selectedPosition + '" Ø¨Ù†Ø¬Ø§Ø­');
            modal.remove();
            this.showPPEMatrix();
        });
        
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
        });
    },
    
    async editPPEMatrix(position) {
        this.showAddPPEMatrixForm(position);
    },
    
    async viewPositionEmployees(position) {
        const matrix = AppState.appData.employeePPEMatrix || {};
        const matrixData = matrix[position];
        const employees = AppState.appData.employees || [];
        const positionEmployees = employees.filter(e => e.position === position);
        
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        
        // Ø¨Ù†Ø§Ø¡ HTML Ù„Ù„Ø¬Ø¯ÙˆÙ„
        const requiredPPEHtml = matrixData && matrixData.requiredPPE ? 
            matrixData.requiredPPE.map(ppe => `<span class="badge badge-success mr-2">${Utils.escapeHTML(ppe)}</span>`).join('') : 
            'Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯';
        
        let employeesTableHtml = '';
        if (positionEmployees.length > 0) {
            employeesTableHtml = `
                <div class="table-wrapper" style="overflow-x: auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</th>
                                <th>Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù</th>
                                <th>Ø§Ù„Ù‚Ø³Ù…/Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</th>
                                <th>Ù…Ù‡Ù…Ø§Øª Ø§Ù„ÙˆÙ‚Ø§ÙŠØ© Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø©</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${positionEmployees.map(emp => {
                                const code = emp.employeeNumber || emp.sapId || '';
                                // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ù‡Ù…Ø§Øª Ø§Ù„ÙˆÙ‚Ø§ÙŠØ© Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø© Ù…Ù† Ø¬Ø¯ÙˆÙ„ PPE
                                const employeePPE = (AppState.appData.ppe || []).filter(p => 
                                    (p.employeeCode === code || p.employeeNumber === code)
                                );
                                // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ù‡Ù…Ø§Øª Ø§Ù„ÙˆÙ‚Ø§ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù…Ù† Ø§Ù„Ù…ØµÙÙˆÙØ© (Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ)
                                const matrixByCode = AppState.appData.employeePPEMatrixByCode || {};
                                const requiredPPE = matrixByCode[code] || [];
                                
                                const receivedPPEHtml = employeePPE.length > 0 ? 
                                    employeePPE.map(p => `<span class="badge badge-info">${Utils.escapeHTML(p.equipmentType || '')}</span>`).join('') : 
                                    '<span class="text-gray-500 text-sm">Ù„Ø§ ØªÙˆØ¬Ø¯</span>';
                                
                                const requiredPPEHtml = requiredPPE.length > 0 ? 
                                    requiredPPE.map(ppe => `<span class="badge badge-success">${Utils.escapeHTML(ppe)}</span>`).join('') : 
                                    '<span class="text-gray-500 text-sm">Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯</span>';
                                
                                return `
                                    <tr>
                                        <td><strong>${Utils.escapeHTML(code || '-')}</strong></td>
                                        <td>${Utils.escapeHTML(emp.name || '-')}</td>
                                        <td>${Utils.escapeHTML(emp.department || '-')}</td>
                                        <td>
                                            <div class="mb-2">
                                                <strong class="text-sm text-gray-600">Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:</strong>
                                                <div class="flex flex-wrap gap-2 mt-1">
                                                    ${requiredPPEHtml}
                                                </div>
                                            </div>
                                            <div>
                                                <strong class="text-sm text-gray-600">Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø©:</strong>
                                                <div class="flex flex-wrap gap-2 mt-1">
                                                    ${receivedPPEHtml}
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        } else {
            employeesTableHtml = `
                <div class="empty-state">
                    <i class="fas fa-users text-4xl text-gray-300 mb-4"></i>
                    <p class="text-gray-500">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ¸ÙÙˆÙ† Ø¨Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ¸ÙŠÙØ©</p>
                </div>
            `;
        }
        
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 900px;">
                <div class="modal-header">
                    <h2 class="modal-title">
                        <i class="fas fa-users ml-2"></i>
                        Ø§Ù„Ù…ÙˆØ¸ÙÙˆÙ† ÙÙŠ ÙˆØ¸ÙŠÙØ©: ${Utils.escapeHTML(position)}
                    </h2>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="mb-4">
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                            <p class="text-sm text-blue-800">
                                <strong>Ù…Ù‡Ù…Ø§Øª Ø§Ù„ÙˆÙ‚Ø§ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:</strong>
                                ${requiredPPEHtml}
                            </p>
                        </div>
                    </div>
                    ${employeesTableHtml}
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" onclick="this.closest('.modal-overlay').remove()">Ø¥ØºÙ„Ø§Ù‚</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
        });
    },
    
    async exportPPEMatrix() {
        try {
            Loading.show();
            
            if (typeof XLSX === 'undefined') {
                Loading.hide();
                Notification.error('Ù…ÙƒØªØ¨Ø© SheetJS ØºÙŠØ± Ù…Ø­Ù…Ù‘Ù„Ø©. ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©');
                return;
            }
            
            const matrix = AppState.appData.employeePPEMatrix || {};
            const employees = AppState.appData.employees || [];
            
            const excelData = Object.keys(matrix).map(position => {
                const matrixData = matrix[position];
                const positionEmployees = employees.filter(e => e.position === position);
                
                return {
                    'Ø§Ù„ÙˆØ¸ÙŠÙØ©': position,
                    'Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†': positionEmployees.length,
                    'Ù…Ù‡Ù…Ø§Øª Ø§Ù„ÙˆÙ‚Ø§ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©': matrixData.requiredPPE ? matrixData.requiredPPE.join(', ') : ''
                };
            });
            
            const ws = XLSX.utils.json_to_sheet(excelData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Ù…ØµÙÙˆÙØ© Ù…Ù‡Ù…Ø§Øª Ø§Ù„ÙˆÙ‚Ø§ÙŠØ©');
            
            XLSX.writeFile(wb, 'Ù…ØµÙÙˆÙØ©_Ù…Ù‡Ù…Ø§Øª_Ø§Ù„ÙˆÙ‚Ø§ÙŠØ©_' + new Date().toISOString().slice(0, 10) + '.xlsx');
            
            Loading.hide();
            Notification.success('ØªÙ… ØªØµØ¯ÙŠØ± Ù…ØµÙÙˆÙØ© Ù…Ù‡Ù…Ø§Øª Ø§Ù„ÙˆÙ‚Ø§ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­');
        } catch (error) {
            Loading.hide();
            Notification.error('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
        }
    }
};

// ===== Violations Module (Ù…Ø®Ø§Ù„ÙØ§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ÙˆØ§Ù„Ù…Ù‚Ø§ÙˆÙ„ÙŠÙ†) =====
const Violations = {
    async load() {
        const section = document.getElementById('violations-section');
        if (!section) return;

        section.innerHTML = `
            <div class="section-header">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="section-title">
                            <i class="fas fa-exclamation-circle ml-3"></i>
                            Ø³Ø¬Ù„ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª
                        </h1>
                        <p class="section-subtitle">ØªØ³Ø¬ÙŠÙ„ ÙˆÙ…ØªØ§Ø¨Ø¹Ø© Ù…Ø®Ø§Ù„ÙØ§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ÙˆØ§Ù„Ù…Ù‚Ø§ÙˆÙ„ÙŠÙ†</p>
                    </div>
                    <button id="add-violation-btn" class="btn-primary">
                        <i class="fas fa-plus ml-2"></i>
                        ØªØ³Ø¬ÙŠÙ„ Ù…Ø®Ø§Ù„ÙØ© Ø¬Ø¯ÙŠØ¯Ø©
                    </button>
                </div>
            </div>
            <div class="mt-6">
                <div class="content-card">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-list ml-2"></i>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª</h2>
                    </div>
                    <div class="card-body">
                        <div id="violations-list">
                            ${await this.renderViolationsList()}
                        </div>
                    </div>
                </div>
            </div>
        `;
        this.setupEventListeners();
    },

    async renderViolationsList() {
        const violations = AppState.appData.violations || [];
        if (violations.length === 0) {
            return '<div class="empty-state"><p class="text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø®Ø§Ù„ÙØ§Øª Ù…Ø³Ø¬Ù„Ø©</p></div>';
        }
        return `
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù/Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„</th>
                        <th>Ù†ÙˆØ¹ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©</th>
                        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                        <th>Ø§Ù„Ø´Ø¯Ø©</th>
                        <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù…ØªØ®Ø°</th>
                        <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                        <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                    </tr>
                </thead>
                <tbody>
                    ${violations.map(violation => `
                        <tr>
                            <td>${Utils.escapeHTML(violation.employeeName || violation.contractorName || '')}</td>
                            <td>${Utils.escapeHTML(violation.violationType || '')}</td>
                            <td>${violation.violationDate ? Utils.formatDate(violation.violationDate) : '-'}</td>
                            <td>
                                <span class="badge badge-${violation.severity === 'Ø¹Ø§Ù„ÙŠØ©' ? 'danger' : violation.severity === 'Ù…ØªÙˆØ³Ø·Ø©' ? 'warning' : 'info'}">
                                    ${violation.severity || '-'}
                                </span>
                            </td>
                            <td>${Utils.escapeHTML(violation.actionTaken || '')}</td>
                            <td>
                                <span class="badge badge-${violation.status === 'Ù…Ø­Ù„ÙˆÙ„' ? 'success' : 'warning'}">
                                    ${violation.status || '-'}
                                </span>
                            </td>
                            <td>
                                <div class="flex items-center gap-2">
                                    <button onclick="Violations.viewViolation('${violation.id}')" class="btn-icon btn-icon-primary" title="Ø¹Ø±Ø¶">
                                    <i class="fas fa-eye"></i>
                                </button>
                                    <button onclick="Violations.exportPDF('${violation.id}')" class="btn-icon btn-icon-success" title="ØªØµØ¯ÙŠØ± PDF">
                                        <i class="fas fa-file-pdf"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
    },

    setupEventListeners() {
        setTimeout(() => {
            const addBtn = document.getElementById('add-violation-btn');
            if (addBtn) addBtn.addEventListener('click', () => this.showViolationForm());
        }, 100);
    },

    async showViolationForm(violationData = null) {
        const isEdit = !!violationData;
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 800px;">
                <div class="modal-header">
                    <h2 class="modal-title">${isEdit ? 'ØªØ¹Ø¯ÙŠÙ„ Ù…Ø®Ø§Ù„ÙØ©' : 'ØªØ³Ø¬ÙŠÙ„ Ù…Ø®Ø§Ù„ÙØ© Ø¬Ø¯ÙŠØ¯Ø©'}</h2>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="violation-form" class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ù†ÙˆØ¹ Ø§Ù„Ù…Ø®Ø§Ù„Ù *</label>
                                <select id="violation-person-type" required class="form-input">
                                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù†ÙˆØ¹</option>
                                    <option value="employee" ${violationData?.employeeName ? 'selected' : ''}>Ù…ÙˆØ¸Ù</option>
                                    <option value="contractor" ${violationData?.contractorName ? 'selected' : ''}>Ù…Ù‚Ø§ÙˆÙ„</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ø³Ù… Ø§Ù„Ù…Ø®Ø§Ù„Ù *</label>
                                <input type="text" id="violation-person-name" required class="form-input"
                                    value="${violationData?.employeeName || violationData?.contractorName || ''}" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù/Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„">
                            </div>
                            <div id="violation-employee-code-container" class="${violationData?.employeeName ? '' : 'hidden'}">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <i class="fas fa-id-card ml-2"></i>
                                    Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ
                                </label>
                                <input type="text" id="violation-employee-code" class="form-input"
                                    value="${violationData?.employeeCode || violationData?.employeeNumber || ''}" 
                                    placeholder="Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ù†ÙˆØ¹ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ© *</label>
                                <select id="violation-type" required class="form-input">
                                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù†ÙˆØ¹</option>
                                    <option value="Ø¹Ø¯Ù… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ø¹Ø¯Ø§Øª Ø§Ù„ÙˆÙ‚Ø§ÙŠØ©" ${violationData?.violationType === 'Ø¹Ø¯Ù… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ø¹Ø¯Ø§Øª Ø§Ù„ÙˆÙ‚Ø§ÙŠØ©' ? 'selected' : ''}>Ø¹Ø¯Ù… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ø¹Ø¯Ø§Øª Ø§Ù„ÙˆÙ‚Ø§ÙŠØ©</option>
                                    <option value="Ø¹Ø¯Ù… Ø§ØªØ¨Ø§Ø¹ Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø³Ù„Ø§Ù…Ø©" ${violationData?.violationType === 'Ø¹Ø¯Ù… Ø§ØªØ¨Ø§Ø¹ Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø³Ù„Ø§Ù…Ø©' ? 'selected' : ''}>Ø¹Ø¯Ù… Ø§ØªØ¨Ø§Ø¹ Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø³Ù„Ø§Ù…Ø©</option>
                                    <option value="Ø§Ù„ØªØ¯Ø®ÙŠÙ† ÙÙŠ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ù…Ù…Ù†ÙˆØ¹Ø©" ${violationData?.violationType === 'Ø§Ù„ØªØ¯Ø®ÙŠÙ† ÙÙŠ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ù…Ù…Ù†ÙˆØ¹Ø©' ? 'selected' : ''}>Ø§Ù„ØªØ¯Ø®ÙŠÙ† ÙÙŠ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ù…Ù…Ù†ÙˆØ¹Ø©</option>
                                    <option value="Ø¹Ø¯Ù… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªØµØ±ÙŠØ­ Ø¹Ù…Ù„" ${violationData?.violationType === 'Ø¹Ø¯Ù… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªØµØ±ÙŠØ­ Ø¹Ù…Ù„' ? 'selected' : ''}>Ø¹Ø¯Ù… Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªØµØ±ÙŠØ­ Ø¹Ù…Ù„</option>
                                    <option value="Ø£Ø®Ø±Ù‰" ${violationData?.violationType === 'Ø£Ø®Ø±Ù‰' ? 'selected' : ''}>Ø£Ø®Ø±Ù‰</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø®Ø§Ù„ÙØ© *</label>
                                <input type="date" id="violation-date" required class="form-input"
                                    value="${violationData?.violationDate ? new Date(violationData.violationDate).toISOString().slice(0, 10) : ''}">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„Ø´Ø¯Ø© *</label>
                                <select id="violation-severity" required class="form-input">
                                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø´Ø¯Ø©</option>
                                    <option value="Ø¹Ø§Ù„ÙŠØ©" ${violationData?.severity === 'Ø¹Ø§Ù„ÙŠØ©' ? 'selected' : ''}>Ø¹Ø§Ù„ÙŠØ©</option>
                                    <option value="Ù…ØªÙˆØ³Ø·Ø©" ${violationData?.severity === 'Ù…ØªÙˆØ³Ø·Ø©' ? 'selected' : ''}>Ù…ØªÙˆØ³Ø·Ø©</option>
                                    <option value="Ù…Ù†Ø®ÙØ¶Ø©" ${violationData?.severity === 'Ù…Ù†Ø®ÙØ¶Ø©' ? 'selected' : ''}>Ù…Ù†Ø®ÙØ¶Ø©</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„Ø­Ø§Ù„Ø© *</label>
                                <select id="violation-status" required class="form-input">
                                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø­Ø§Ù„Ø©</option>
                                    <option value="Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©" ${violationData?.status === 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©' ? 'selected' : ''}>Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</option>
                                    <option value="Ù…Ø­Ù„ÙˆÙ„" ${violationData?.status === 'Ù…Ø­Ù„ÙˆÙ„' ? 'selected' : ''}>Ù…Ø­Ù„ÙˆÙ„</option>
                                    <option value="ØºÙŠØ± Ù…Ø­Ù„ÙˆÙ„" ${violationData?.status === 'ØºÙŠØ± Ù…Ø­Ù„ÙˆÙ„' ? 'selected' : ''}>ØºÙŠØ± Ù…Ø­Ù„ÙˆÙ„</option>
                                </select>
                            </div>
                            <div class="col-span-2">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <i class="fas fa-image ml-2"></i>
                                    ØµÙˆØ±Ø© Ø§Ù„Ù…Ø®Ø§Ù„ÙØ© (ØºÙŠØ± Ø¥Ù„Ø²Ø§Ù…ÙŠ)
                                </label>
                                <input type="file" id="violation-photo-input" accept="image/*" class="form-input">
                                <div id="violation-photo-preview" class="mt-2 ${violationData?.photo ? '' : 'hidden'}">
                                    <img src="${violationData?.photo || ''}" alt="ØµÙˆØ±Ø© Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©" class="w-48 h-48 object-cover rounded border" id="violation-photo-img">
                                    <button type="button" onclick="document.getElementById('violation-photo-input').value=''; document.getElementById('violation-photo-preview').classList.add('hidden');" class="mt-1 text-xs text-red-600">Ø­Ø°Ù Ø§Ù„ØµÙˆØ±Ø©</button>
                                </div>
                            </div>
                            <div class="col-span-2">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù…ØªØ®Ø°</label>
                                <textarea id="violation-action" class="form-input" rows="3"
                                    placeholder="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù…ØªØ®Ø°">${violationData?.actionTaken || ''}</textarea>
                            </div>
                        </div>
                        <div class="flex items-center justify-end gap-4 pt-4 border-t">
                            <button type="button" class="btn-secondary" onclick="this.closest('.modal-overlay').remove()">Ø¥Ù„ØºØ§Ø¡</button>
                            <button type="submit" class="btn-primary">
                                <i class="fas fa-save ml-2"></i>${isEdit ? 'Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª' : 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©'}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        
        // Setup employee autocomplete for employee type
        const personTypeSelect = document.getElementById('violation-person-type');
        const employeeCodeContainer = document.getElementById('violation-employee-code-container');
        
        personTypeSelect.addEventListener('change', (e) => {
            if (e.target.value === 'employee') {
                employeeCodeContainer.classList.remove('hidden');
                if (typeof EmployeeHelper !== 'undefined') {
                    EmployeeHelper.setupAutocomplete('violation-person-name', (employee) => {
                        if (employee) {
                            document.getElementById('violation-employee-code').value = employee.code || '';
                            document.getElementById('violation-person-name').value = employee.name || '';
                        }
                    });
                }
            } else {
                employeeCodeContainer.classList.add('hidden');
            }
        });
        
        if (typeof EmployeeHelper !== 'undefined' && violationData?.employeeName) {
            EmployeeHelper.setupAutocomplete('violation-person-name', (employee) => {
                if (employee) {
                    document.getElementById('violation-employee-code').value = employee.code || '';
                    document.getElementById('violation-person-name').value = employee.name || '';
                }
            });
            // Setup employee code search
            EmployeeHelper.setupEmployeeCodeSearch('violation-employee-code', 'violation-person-name');
        }
        
        // Setup photo preview
        const photoInput = document.getElementById('violation-photo-input');
        const photoPreview = document.getElementById('violation-photo-preview');
        const photoImg = document.getElementById('violation-photo-img');
        if (photoInput && photoPreview && photoImg) {
            photoInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    if (file.size > 2 * 1024 * 1024) {
                        Notification.error('Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹. Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 2MB');
                        photoInput.value = '';
                        return;
                    }
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        photoImg.src = e.target.result;
                        photoPreview.classList.remove('hidden');
                    };
                    reader.readAsDataURL(file);
                }
            });
        }
        
        const form = modal.querySelector('#violation-form');
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const personType = document.getElementById('violation-person-type').value;
            const personName = document.getElementById('violation-person-name').value.trim();
            
            // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø©
            let photoBase64 = violationData?.photo || '';
            const photoInput = document.getElementById('violation-photo-input');
            if (photoInput && photoInput.files.length > 0) {
                const file = photoInput.files[0];
                if (file.size > 2 * 1024 * 1024) {
                    Notification.error('Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹. Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 2MB');
                    return;
                }
                photoBase64 = await Violations.convertImageToBase64(file);
            }
            
            const formData = {
                id: violationData?.id || Utils.generateId('VIOLATION'),
                isoCode: generateISOCode('VIOL', AppState.appData.violations),
                employeeId: personType === 'employee' ? Utils.generateId('EMP') : '',
                employeeName: personType === 'employee' ? personName : '',
                employeeCode: personType === 'employee' ? document.getElementById('violation-employee-code')?.value.trim() || '' : '',
                employeeNumber: personType === 'employee' ? document.getElementById('violation-employee-code')?.value.trim() || '' : '',
                contractorId: personType === 'contractor' ? Utils.generateId('CONTRACTOR') : '',
                contractorName: personType === 'contractor' ? personName : '',
                violationType: document.getElementById('violation-type').value,
                violationDate: new Date(document.getElementById('violation-date').value).toISOString(),
                severity: document.getElementById('violation-severity').value,
                actionTaken: document.getElementById('violation-action').value.trim(),
                status: document.getElementById('violation-status').value,
                photo: photoBase64,
                createdAt: violationData?.createdAt || new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            Loading.show();
            try {
                if (isEdit) {
                    const index = AppState.appData.violations.findIndex(v => v.id === violationData.id);
                    if (index !== -1) AppState.appData.violations[index] = formData;
                } else {
                    AppState.appData.violations.push(formData);
                }
                DataManager.save();
                // Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙÙŠ Google Sheets
                await GoogleIntegration.autoSave('Violations', AppState.appData.violations);
                Loading.hide();
                Notification.success(`ØªÙ… ${isEdit ? 'ØªØ­Ø¯ÙŠØ«' : 'ØªØ³Ø¬ÙŠÙ„'} Ø§Ù„Ù…Ø®Ø§Ù„ÙØ© Ø¨Ù†Ø¬Ø§Ø­`);
                modal.remove();
                this.load();
            } catch (error) {
                Loading.hide();
                Notification.error('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
            }
        });
        
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
        });
    },

    async convertImageToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    },

    async viewViolation(id) {
        const violation = AppState.appData.violations.find(v => v.id === id);
        if (!violation) return;
        
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 700px;">
                <div class="modal-header">
                    <h2 class="modal-title">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©</h2>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm font-semibold text-gray-600">Ø§Ø³Ù… Ø§Ù„Ù…Ø®Ø§Ù„Ù:</label>
                                <p class="text-gray-800">${Utils.escapeHTML(violation.employeeName || violation.contractorName || '')}</p>
                            </div>
                            ${violation.employeeCode ? `
                            <div>
                                <label class="text-sm font-semibold text-gray-600">Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ:</label>
                                <p class="text-gray-800">${Utils.escapeHTML(violation.employeeCode || violation.employeeNumber || '')}</p>
                            </div>
                            ` : ''}
                            <div>
                                <label class="text-sm font-semibold text-gray-600">Ù†ÙˆØ¹ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©:</label>
                                <p class="text-gray-800">${Utils.escapeHTML(violation.violationType || '')}</p>
                            </div>
                            <div>
                                <label class="text-sm font-semibold text-gray-600">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©:</label>
                                <p class="text-gray-800">${violation.violationDate ? Utils.formatDate(violation.violationDate) : '-'}</p>
                            </div>
                            <div>
                                <label class="text-sm font-semibold text-gray-600">Ø§Ù„Ø´Ø¯Ø©:</label>
                                <span class="badge badge-${violation.severity === 'Ø¹Ø§Ù„ÙŠØ©' ? 'danger' : violation.severity === 'Ù…ØªÙˆØ³Ø·Ø©' ? 'warning' : 'info'}">
                                    ${violation.severity || '-'}
                                </span>
                            </div>
                            <div>
                                <label class="text-sm font-semibold text-gray-600">Ø§Ù„Ø­Ø§Ù„Ø©:</label>
                                <span class="badge badge-${violation.status === 'Ù…Ø­Ù„ÙˆÙ„' ? 'success' : 'warning'}">
                                    ${violation.status || '-'}
                                </span>
                            </div>
                            <div class="col-span-2">
                                <label class="text-sm font-semibold text-gray-600">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù…ØªØ®Ø°:</label>
                                <p class="text-gray-800">${Utils.escapeHTML(violation.actionTaken || '')}</p>
                            </div>
                            ${violation.photo ? `
                            <div class="col-span-2">
                                <label class="text-sm font-semibold text-gray-600">ØµÙˆØ±Ø© Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©:</label>
                                <img src="${violation.photo}" alt="ØµÙˆØ±Ø© Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©" class="w-full max-w-md h-64 object-cover rounded border mt-2">
                            </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" onclick="this.closest('.modal-overlay').remove()">Ø¥ØºÙ„Ø§Ù‚</button>
                    <button class="btn-primary" onclick="Violations.exportPDF('${violation.id}'); this.closest('.modal-overlay').remove();">
                        <i class="fas fa-file-pdf ml-2"></i>ØªØµØ¯ÙŠØ± PDF
                    </button>
                    <button class="btn-primary" onclick="Violations.showViolationForm(${JSON.stringify(violation).replace(/"/g, '&quot;')}); this.closest('.modal-overlay').remove();">
                        <i class="fas fa-edit ml-2"></i>ØªØ¹Ø¯ÙŠÙ„
                    </button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
        });
    },

    async exportPDF(id) {
        const violation = AppState.appData.violations.find(v => v.id === id);
        if (!violation) {
            Notification.error('Ø§Ù„Ù…Ø®Ø§Ù„ÙØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
            return;
        }

        try {
            Loading.show();
            
            const companyLogo = (typeof AppState !== 'undefined' && AppState.companyLogo) ? AppState.companyLogo : '';
            const companySettings = (typeof AppState !== 'undefined' && AppState.companySettings) ? AppState.companySettings : { name: 'Ø§Ù„Ø´Ø±ÙƒØ© Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ© Ù„Ù„Ø§Ù†ØªØ§Ø¬ ÙˆØ§Ù„ØªØµÙ†ÙŠØ¹ Ø§Ù„Ø²Ø±Ø§Ø¹ÙŠ', address: '', phone: '', email: '' };
            const qrCodeData = `${window.location.origin}/violation/${violation.id}`;
            const qrCode = typeof QRCode !== 'undefined' ? QRCode.generate(qrCodeData, 100) : null;
            const formCode = violation.isoCode || `VIOL-${violation.id?.substring(0, 8) || 'UNKNOWN'}`;

            const htmlContent = FormHeader.generatePDFHTML(
                formCode,
                'ØªÙ‚Ø±ÙŠØ± Ù…Ø®Ø§Ù„ÙØ©',
                `
                <table>
                    <tr><th>ÙƒÙˆØ¯ ISO</th><td>${Utils.escapeHTML(violation.isoCode || '')}</td></tr>
                    <tr><th>Ø§Ø³Ù… Ø§Ù„Ù…Ø®Ø§Ù„Ù</th><td>${Utils.escapeHTML(violation.employeeName || violation.contractorName || '')}</td></tr>
                    ${violation.employeeCode ? `<tr><th>Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</th><td>${Utils.escapeHTML(violation.employeeCode || violation.employeeNumber || '')}</td></tr>` : ''}
                    <tr><th>Ù†ÙˆØ¹ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©</th><td>${Utils.escapeHTML(violation.violationType || '')}</td></tr>
                    <tr><th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©</th><td>${violation.violationDate ? Utils.formatDate(violation.violationDate) : '-'}</td></tr>
                    <tr><th>Ø§Ù„Ø´Ø¯Ø©</th><td>${Utils.escapeHTML(violation.severity || '')}</td></tr>
                    <tr><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><td>${Utils.escapeHTML(violation.status || '')}</td></tr>
                    <tr><th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ù…ØªØ®Ø°</th><td>${Utils.escapeHTML(violation.actionTaken || '')}</td></tr>
                </table>
                ${violation.photo ? `
                    <div class="section-title">ØµÙˆØ±Ø© Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©:</div>
                    <div style="text-align: center; margin: 20px 0;">
                        <img src="${violation.photo}" alt="ØµÙˆØ±Ø© Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©" style="max-width: 100%; max-height: 400px; border: 1px solid #ddd; border-radius: 8px;">
                    </div>
                ` : ''}
                `,
                false, // Ù„Ø§ QR ÙÙŠ Ø§Ù„Ø±Ø£Ø³
                true,  // QR ÙÙŠ Ø§Ù„ÙÙˆØªØ±
                { version: '1.0' },
                violation.createdAt,
                violation.updatedAt
            );

            const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const printWindow = window.open(url, '_blank');
            if (printWindow) {
                printWindow.onload = () => {
                    setTimeout(() => {
                        printWindow.print();
                        Loading.hide();
                    }, 500);
                };
            } else {
                Loading.hide();
                Notification.error('ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ù†ÙˆØ§ÙØ° Ù…Ù†Ø¨Ø«Ù‚Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©');
            }
        } catch (error) {
            Loading.hide();
            console.error('Ø®Ø·Ø£ ÙÙŠ ØªØµØ¯ÙŠØ± PDF:', error);
            Notification.error('ÙØ´Ù„ ØªØµØ¯ÙŠØ± PDF: ' + error.message);
        }
    }
};

// ===== Contractors Module (Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ÙŠÙ†) =====
const Contractors = {
    async load() {
        const section = document.getElementById('contractors-section');
        if (!section) return;

        section.innerHTML = `
            <div class="section-header">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="section-title">
                            <i class="fas fa-users-cog ml-3"></i>
                            Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ÙŠÙ†
                        </h1>
                        <p class="section-subtitle">Ø¥Ø¯Ø§Ø±Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ÙŠÙ† ÙˆØ§Ù„Ù…ØªØ¹Ø§Ù‚Ø¯ÙŠÙ†</p>
                    </div>
                    <button id="add-contractor-btn" class="btn-primary">
                        <i class="fas fa-plus ml-2"></i>
                        Ø¥Ø¶Ø§ÙØ© Ù…Ù‚Ø§ÙˆÙ„ Ø¬Ø¯ÙŠØ¯
                    </button>
                </div>
            </div>
            <div class="mt-6">
                <div class="content-card">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-list ml-2"></i>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ÙŠÙ†</h2>
                    </div>
                    <div class="card-body">
                        <div id="contractors-list">
                            ${await this.renderContractorsList()}
                        </div>
                    </div>
                </div>
            </div>
        `;
        this.setupEventListeners();
    },

    async renderContractorsList() {
        const contractors = AppState.appData.contractors || [];
        if (contractors.length === 0) {
            return '<div class="empty-state"><p class="text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‚Ø§ÙˆÙ„ÙŠÙ† Ù…Ø³Ø¬Ù„ÙŠÙ†</p></div>';
        }
        return `
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Ø§Ø³Ù… Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„</th>
                        <th>Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø©</th>
                        <th>Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯</th>
                        <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡</th>
                        <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</th>
                        <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                        <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                    </tr>
                </thead>
                <tbody>
                    ${contractors.map(contractor => `
                        <tr>
                            <td>${Utils.escapeHTML(contractor.name || '')}</td>
                            <td>${Utils.escapeHTML(contractor.serviceType || '')}</td>
                            <td>${Utils.escapeHTML(contractor.contractNumber || '')}</td>
                            <td>${contractor.startDate ? Utils.formatDate(contractor.startDate) : '-'}</td>
                            <td>${contractor.endDate ? Utils.formatDate(contractor.endDate) : '-'}</td>
                            <td>
                                <span class="badge badge-${contractor.status === 'Ù†Ø´Ø·' ? 'success' : contractor.status === 'Ù…Ù†ØªÙ‡ÙŠ' ? 'danger' : 'warning'}">
                                    ${contractor.status || '-'}
                                </span>
                            </td>
                            <td>
                                <button onclick="Contractors.viewContractor('${contractor.id}')" class="btn-icon btn-icon-primary">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button onclick="Contractors.editContractor('${contractor.id}')" class="btn-icon btn-icon-info">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
    },

    setupEventListeners() {
        setTimeout(() => {
            const addBtn = document.getElementById('add-contractor-btn');
            if (addBtn) addBtn.addEventListener('click', () => this.showContractorForm());
        }, 100);
    },

    async showContractorForm(contractorData = null) {
        const isEdit = !!contractorData;
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 800px;">
                <div class="modal-header">
                    <h2 class="modal-title">${isEdit ? 'ØªØ¹Ø¯ÙŠÙ„ Ù…Ù‚Ø§ÙˆÙ„' : 'Ø¥Ø¶Ø§ÙØ© Ù…Ù‚Ø§ÙˆÙ„ Ø¬Ø¯ÙŠØ¯'}</h2>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="contractor-form" class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ø³Ù… Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ *</label>
                                <input type="text" id="contractor-name" required class="form-input"
                                    value="${contractorData?.name || ''}" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø© *</label>
                                <input type="text" id="contractor-service-type" required class="form-input"
                                    value="${contractorData?.serviceType || ''}" placeholder="Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø©">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯ *</label>
                                <input type="text" id="contractor-contract-number" required class="form-input"
                                    value="${contractorData?.contractNumber || ''}" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡ *</label>
                                <input type="date" id="contractor-start-date" required class="form-input"
                                    value="${contractorData?.startDate ? new Date(contractorData.startDate).toISOString().slice(0, 10) : ''}">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ *</label>
                                <input type="date" id="contractor-end-date" required class="form-input"
                                    value="${contractorData?.endDate ? new Date(contractorData.endDate).toISOString().slice(0, 10) : ''}">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„Ø­Ø§Ù„Ø© *</label>
                                <select id="contractor-status" required class="form-input">
                                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø­Ø§Ù„Ø©</option>
                                    <option value="Ù†Ø´Ø·" ${contractorData?.status === 'Ù†Ø´Ø·' ? 'selected' : ''}>Ù†Ø´Ø·</option>
                                    <option value="Ù…Ù†ØªÙ‡ÙŠ" ${contractorData?.status === 'Ù…Ù†ØªÙ‡ÙŠ' ? 'selected' : ''}>Ù…Ù†ØªÙ‡ÙŠ</option>
                                    <option value="Ù…Ø¹Ù„Ù‚" ${contractorData?.status === 'Ù…Ø¹Ù„Ù‚' ? 'selected' : ''}>Ù…Ø¹Ù„Ù‚</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„Ø´Ø®Øµ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</label>
                                <input type="text" id="contractor-contact-person" class="form-input"
                                    value="${contractorData?.contactPerson || ''}" placeholder="Ø§Ø³Ù… Ø§Ù„Ø´Ø®Øµ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„Ù‡Ø§ØªÙ</label>
                                <input type="tel" id="contractor-phone" class="form-input"
                                    value="${contractorData?.phone || ''}" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
                            </div>
                            <div class="col-span-2">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                                <input type="email" id="contractor-email" class="form-input"
                                    value="${contractorData?.email || ''}" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
                            </div>
                        </div>
                        <div class="flex items-center justify-end gap-4 pt-4 border-t">
                            <button type="button" class="btn-secondary" onclick="this.closest('.modal-overlay').remove()">Ø¥Ù„ØºØ§Ø¡</button>
                            <button type="submit" class="btn-primary">
                                <i class="fas fa-save ml-2"></i>${isEdit ? 'Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª' : 'Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„'}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        
        const form = modal.querySelector('#contractor-form');
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = {
                id: contractorData?.id || Utils.generateId('CONTRACTOR'),
                name: document.getElementById('contractor-name').value.trim(),
                serviceType: document.getElementById('contractor-service-type').value.trim(),
                contractNumber: document.getElementById('contractor-contract-number').value.trim(),
                startDate: new Date(document.getElementById('contractor-start-date').value).toISOString(),
                endDate: new Date(document.getElementById('contractor-end-date').value).toISOString(),
                status: document.getElementById('contractor-status').value,
                contactPerson: document.getElementById('contractor-contact-person').value.trim(),
                phone: document.getElementById('contractor-phone').value.trim(),
                email: document.getElementById('contractor-email').value.trim(),
                createdAt: contractorData?.createdAt || new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            Loading.show();
            try {
                if (isEdit) {
                    const index = AppState.appData.contractors.findIndex(c => c.id === contractorData.id);
                    if (index !== -1) AppState.appData.contractors[index] = formData;
                } else {
                    AppState.appData.contractors.push(formData);
                }
                DataManager.save();
                // Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙÙŠ Google Sheets
                await GoogleIntegration.autoSave('Contractors', AppState.appData.contractors);
                Loading.hide();
                Notification.success(`ØªÙ… ${isEdit ? 'ØªØ­Ø¯ÙŠØ«' : 'Ø¥Ø¶Ø§ÙØ©'} Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­`);
                modal.remove();
                this.load();
            } catch (error) {
                Loading.hide();
                Notification.error('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
            }
        });
        
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
        });
    },

    async viewContractor(id) {
        const contractor = AppState.appData.contractors.find(c => c.id === id);
        if (!contractor) return;
        
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 700px;">
                <div class="modal-header">
                    <h2 class="modal-title">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„</h2>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm font-semibold text-gray-600">Ø§Ø³Ù… Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„:</label>
                                <p class="text-gray-800">${Utils.escapeHTML(contractor.name || '')}</p>
                            </div>
                            <div>
                                <label class="text-sm font-semibold text-gray-600">Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø©:</label>
                                <p class="text-gray-800">${Utils.escapeHTML(contractor.serviceType || '')}</p>
                            </div>
                            <div>
                                <label class="text-sm font-semibold text-gray-600">Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯:</label>
                                <p class="text-gray-800">${Utils.escapeHTML(contractor.contractNumber || '')}</p>
                            </div>
                            <div>
                                <label class="text-sm font-semibold text-gray-600">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡:</label>
                                <p class="text-gray-800">${contractor.startDate ? Utils.formatDate(contractor.startDate) : '-'}</p>
                            </div>
                            <div>
                                <label class="text-sm font-semibold text-gray-600">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡:</label>
                                <p class="text-gray-800">${contractor.endDate ? Utils.formatDate(contractor.endDate) : '-'}</p>
                            </div>
                            <div>
                                <label class="text-sm font-semibold text-gray-600">Ø§Ù„Ø­Ø§Ù„Ø©:</label>
                                <span class="badge badge-${contractor.status === 'Ù†Ø´Ø·' ? 'success' : contractor.status === 'Ù…Ù†ØªÙ‡ÙŠ' ? 'danger' : 'warning'}">
                                    ${contractor.status || '-'}
                                </span>
                            </div>
                            <div>
                                <label class="text-sm font-semibold text-gray-600">Ø§Ù„Ø´Ø®Øµ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„:</label>
                                <p class="text-gray-800">${Utils.escapeHTML(contractor.contactPerson || '')}</p>
                            </div>
                            <div>
                                <label class="text-sm font-semibold text-gray-600">Ø§Ù„Ù‡Ø§ØªÙ:</label>
                                <p class="text-gray-800">${Utils.escapeHTML(contractor.phone || '')}</p>
                            </div>
                            <div class="col-span-2">
                                <label class="text-sm font-semibold text-gray-600">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</label>
                                <p class="text-gray-800">${Utils.escapeHTML(contractor.email || '')}</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" onclick="this.closest('.modal-overlay').remove()">Ø¥ØºÙ„Ø§Ù‚</button>
                    <button class="btn-primary" onclick="Contractors.showContractorForm(${JSON.stringify(contractor).replace(/"/g, '&quot;')}); this.closest('.modal-overlay').remove();">
                        <i class="fas fa-edit ml-2"></i>ØªØ¹Ø¯ÙŠÙ„
                    </button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
        });
    },

    async editContractor(id) {
        const contractor = AppState.appData.contractors.find(c => c.id === id);
        if (contractor) await this.showContractorForm(contractor);
    }
};

// ===== Employees Module (Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†) =====
const Employees = {
    async load() {
        const section = document.getElementById('employees-section');
        if (!section) {
            console.error('âŒ Ù‚Ø³Ù… employees-section ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!');
            return;
        }
        console.log('âœ… Ù…Ø¯ÙŠÙˆÙ„ Employees ÙŠÙƒØªØ¨ ÙÙŠ Ù‚Ø³Ù…: employees-section');

        section.innerHTML = `
            <div class="section-header">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="section-title">
                            <i class="fas fa-user-tie ml-3"></i>
                            Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†
                        </h1>
                        <p class="section-subtitle">Ø¥Ø¯Ø§Ø±Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ù…Ø¹ Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù† Excel</p>
                    </div>
                    <div class="flex gap-2">
                        <button id="import-employees-excel-btn" class="btn-secondary">
                            <i class="fas fa-file-excel ml-2"></i>
                            Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù† Excel
                        </button>
                        <button id="add-employee-btn" class="btn-primary">
                            <i class="fas fa-plus ml-2"></i>
                            Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù Ø¬Ø¯ÙŠØ¯
                        </button>
                    </div>
                </div>
            </div>
            <div id="employees-content" class="mt-6">
                ${await this.renderList()}
            </div>
        `;
        this.setupEventListeners();
        this.loadEmployeesList();
    },

    async renderList() {
        return `
            <div class="content-card">
                <div class="card-header">
                    <div class="flex items-center justify-between">
                        <h2 class="card-title">
                            <i class="fas fa-list ml-2"></i>
                            Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†
                        </h2>
                        <div class="flex items-center gap-4">
                            <input 
                                type="text" 
                                id="employees-search" 
                                class="form-input" 
                                style="max-width: 300px;"
                                placeholder="Ø§Ù„Ø¨Ø­Ø«..."
                            >
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div id="employees-table-container">
                        <div class="empty-state">
                            <i class="fas fa-spinner fa-spin text-4xl text-gray-300 mb-4"></i>
                            <p class="text-gray-500">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
                        </div>
                    </div>
                </div>
            </div>
        `;
    },

    async loadEmployeesList() {
        const container = document.getElementById('employees-table-container');
        if (!container) return;

        const employees = AppState.appData.employees || [];
        
        if (employees.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-user-tie text-4xl text-gray-300 mb-4"></i>
                    <p class="text-gray-500">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ¸ÙÙŠÙ† Ù…Ø³Ø¬Ù„ÙŠÙ†</p>
                    <button id="add-employee-empty-btn" class="btn-primary mt-4">
                        <i class="fas fa-plus ml-2"></i>
                        Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù Ø¬Ø¯ÙŠØ¯
                    </button>
                </div>
            `;
            return;
        }

        const tableHTML = `
            <div class="table-wrapper" style="overflow-x: auto;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Ø§Ù„ØµÙˆØ±Ø©</th>
                            <th>Ø§Ù„Ø§Ø³Ù…</th>
                            <th>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</th>
                            <th>Ø§Ù„Ù‚Ø³Ù…</th>
                            <th>Ø§Ù„Ù…Ù†ØµØ¨</th>
                            <th>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</th>
                            <th>Ø§Ù„Ù‡Ø§ØªÙ</th>
                            <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${employees.map(employee => `
                            <tr>
                                <td>
                                    ${employee.photo ? `<img src="${employee.photo}" alt="${Utils.escapeHTML(employee.name || '')}" class="w-12 h-12 rounded-full object-cover">` : `<div class="w-12 h-12 rounded-full bg-gray-200 flex items-center justify-center"><i class="fas fa-user text-gray-400"></i></div>`}
                                </td>
                                <td>${Utils.escapeHTML(employee.name || '')}</td>
                                <td>${Utils.escapeHTML(employee.employeeNumber || '')}</td>
                                <td>${Utils.escapeHTML(employee.department || '')}</td>
                                <td>${Utils.escapeHTML(employee.position || '')}</td>
                                <td>${Utils.escapeHTML(employee.email || '')}</td>
                                <td>${Utils.escapeHTML(employee.phone || '')}</td>
                                <td>
                                    <div class="flex items-center gap-2">
                                        <button onclick="Employees.viewEmployee('${employee.id}')" class="btn-icon btn-icon-info" title="Ø¹Ø±Ø¶">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button onclick="Employees.editEmployee('${employee.id}')" class="btn-icon btn-icon-primary" title="ØªØ¹Ø¯ÙŠÙ„">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button onclick="Employees.deleteEmployee('${employee.id}')" class="btn-icon btn-icon-danger" title="Ø­Ø°Ù">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
        container.innerHTML = tableHTML;
    },

    setupEventListeners() {
        setTimeout(() => {
            const addBtn = document.getElementById('add-employee-btn');
            const addEmptyBtn = document.getElementById('add-employee-empty-btn');
            const importBtn = document.getElementById('import-employees-excel-btn');
            
            if (addBtn) addBtn.addEventListener('click', () => this.showForm());
            if (addEmptyBtn) addEmptyBtn.addEventListener('click', () => this.showForm());
            if (importBtn) importBtn.addEventListener('click', () => this.showImportExcel());

            const searchInput = document.getElementById('employees-search');
            if (searchInput) {
                searchInput.addEventListener('input', (e) => this.filterEmployees(e.target.value));
            }

            const form = document.getElementById('employee-form');
            if (form) form.addEventListener('submit', (e) => this.handleSubmit(e));
            const cancelBtn = document.getElementById('cancel-employee-btn');
            if (cancelBtn) cancelBtn.addEventListener('click', () => this.showList());
            
            this.setupPhotoPreview();
        }, 100);
    },

    setupPhotoPreview() {
        const photoInput = document.getElementById('employee-photo-input');
        const preview = document.getElementById('employee-photo-preview');
        const icon = document.getElementById('employee-photo-icon');
        
        if (photoInput && preview && icon) {
            photoInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        preview.src = e.target.result;
                        preview.style.display = 'block';
                        icon.style.display = 'none';
                    };
                    reader.readAsDataURL(file);
                }
            });
        }
    },

    currentEditId: null,

    async showForm(employeeData = null) {
        this.currentEditId = employeeData?.id || null;
        const content = document.getElementById('employees-content');
        if (!content) return;
        
        content.innerHTML = await this.renderForm(employeeData);
        this.setupEventListeners();
    },

    async renderForm(employeeData = null) {
        const isEdit = !!employeeData;
        return `
            <div class="content-card">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-${isEdit ? 'edit' : 'user-plus'} ml-2"></i>
                        ${isEdit ? 'ØªØ¹Ø¯ÙŠÙ„ Ù…ÙˆØ¸Ù' : 'Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù Ø¬Ø¯ÙŠØ¯'}
                    </h2>
                </div>
                <div class="card-body">
                    <form id="employee-form" class="space-y-6">
                        <div class="grid grid-cols-2 gap-6">
                            <div class="col-span-2">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <i class="fas fa-image ml-2"></i>
                                    ØµÙˆØ±Ø© Ø§Ù„Ù…ÙˆØ¸Ù
                                </label>
                                <div class="flex items-center gap-4">
                                    <div class="w-32 h-32 rounded-full border-2 border-gray-300 overflow-hidden bg-gray-100 flex items-center justify-center">
                                        <img id="employee-photo-preview" src="${employeeData?.photo || ''}" alt="ØµÙˆØ±Ø© Ø§Ù„Ù…ÙˆØ¸Ù" style="width: 100%; height: 100%; object-fit: cover; display: ${employeeData?.photo ? 'block' : 'none'};">
                                        <i id="employee-photo-icon" class="fas fa-user text-4xl text-gray-400" style="display: ${employeeData?.photo ? 'none' : 'block'}"></i>
                                    </div>
                                    <div class="flex-1">
                                        <input 
                                            type="file" 
                                            id="employee-photo-input" 
                                            accept="image/*"
                                            class="form-input"
                                        >
                                        <p class="text-xs text-gray-500 mt-1">ÙŠÙÙØ¶Ù„ ØµÙˆØ±Ø© Ù…Ø±Ø¨Ø¹Ø© Ø¨Ø­Ø¬Ù… Ù„Ø§ ÙŠØªØ¬Ø§ÙˆØ² 2MB</p>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ *</label>
                                <input type="text" id="employee-name" required class="form-input" value="${employeeData?.name || ''}" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ (ID SAP) *</label>
                                <input type="text" id="employee-sap-id" required class="form-input" value="${employeeData?.sapId || employeeData?.employeeNumber || ''}" placeholder="ID SAP">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ *</label>
                                <input type="text" id="employee-number" required class="form-input" value="${employeeData?.employeeNumber || ''}" placeholder="Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ¹ÙŠÙŠÙ† *</label>
                                <input type="date" id="employee-hire-date" required class="form-input" value="${employeeData?.hireDate ? new Date(employeeData.hireDate).toISOString().split('T')[0] : ''}">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯</label>
                                <input type="date" id="employee-birth-date" class="form-input" value="${employeeData?.birthDate ? new Date(employeeData.birthDate).toISOString().split('T')[0] : ''}">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„Ù‚Ø³Ù… *</label>
                                <input type="text" id="employee-department" required class="form-input" value="${employeeData?.department || ''}" placeholder="Ø§Ù„Ù‚Ø³Ù…">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„Ù…Ù†ØµØ¨ (Job) *</label>
                                <input type="text" id="employee-position" required class="form-input" value="${employeeData?.position || ''}" placeholder="Ø§Ù„Ù…Ù†ØµØ¨">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„ÙØ±Ø¹ (Branch)</label>
                                <input type="text" id="employee-branch" class="form-input" value="${employeeData?.branch || ''}" placeholder="Ø§Ù„ÙØ±Ø¹">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„Ù…ÙˆÙ‚Ø¹ (Location)</label>
                                <input type="text" id="employee-location" class="form-input" value="${employeeData?.location || ''}" placeholder="Ø§Ù„Ù…ÙˆÙ‚Ø¹">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„Ø¬Ù†Ø³ (Gender)</label>
                                <select id="employee-gender" class="form-input">
                                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¬Ù†Ø³</option>
                                    <option value="Ø°ÙƒØ±" ${employeeData?.gender === 'Ø°ÙƒØ±' ? 'selected' : ''}>Ø°ÙƒØ±</option>
                                    <option value="Ø£Ù†Ø«Ù‰" ${employeeData?.gender === 'Ø£Ù†Ø«Ù‰' ? 'selected' : ''}>Ø£Ù†Ø«Ù‰</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù‚ÙˆÙ…ÙŠØ©</label>
                                <input type="text" id="employee-national-id" class="form-input" value="${employeeData?.nationalId || ''}" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù‚ÙˆÙ…ÙŠØ©">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                                <input type="email" id="employee-email" class="form-input" value="${employeeData?.email || ''}" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„Ù‡Ø§ØªÙ</label>
                                <input type="tel" id="employee-phone" class="form-input" value="${employeeData?.phone || ''}" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
                            </div>
                        </div>
                        <div class="flex items-center justify-end gap-4 pt-4 border-t">
                            <button type="button" id="cancel-employee-btn" class="btn-secondary">Ø¥Ù„ØºØ§Ø¡</button>
                            <button type="submit" class="btn-primary">
                                <i class="fas fa-save ml-2"></i>${isEdit ? 'Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª' : 'Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ¸Ù'}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        `;
    },

    async showImportExcel() {
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 800px;">
                <div class="modal-header">
                    <h2 class="modal-title"><i class="fas fa-file-excel ml-2"></i>Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ù…Ù† Ù…Ù„Ù Excel</h2>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="space-y-4">
                        <div class="bg-blue-50 border border-blue-200 rounded p-4">
                            <p class="text-sm text-blue-800 mb-2"><strong>Ù…Ù„Ø§Ø­Ø¸Ø© Ù…Ù‡Ù…Ø©:</strong></p>
                            <p class="text-sm text-blue-700 mb-2">ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ù…Ù„Ù Excel Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©:</p>
                            <ul class="text-sm text-blue-700 list-disc mr-6 mt-2 space-y-1">
                                <li><strong>ID SAP</strong> Ø£Ùˆ <strong>Ø±Ù‚Ù… SAP</strong> - Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</li>
                                <li><strong>Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù</strong> Ø£Ùˆ <strong>Employee Name</strong> - Ø¥Ù„Ø²Ø§Ù…ÙŠ</li>
                                <li><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ¹ÙŠÙŠÙ†</strong> Ø£Ùˆ <strong>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ¹ÙŠÙŠÙ†</strong></li>
                                <li><strong>Job</strong> Ø£Ùˆ <strong>Ø§Ù„Ù…Ù†ØµØ¨</strong></li>
                                <li><strong>Department</strong> Ø£Ùˆ <strong>Ø§Ù„Ù‚Ø³Ù…</strong></li>
                                <li><strong>Branch</strong> Ø£Ùˆ <strong>Ø§Ù„ÙØ±Ø¹</strong></li>
                                <li><strong>Location</strong> Ø£Ùˆ <strong>Ø§Ù„Ù…ÙˆÙ‚Ø¹</strong></li>
                                <li><strong>Gender</strong> Ø£Ùˆ <strong>Ø§Ù„Ø¬Ù†Ø³</strong></li>
                                <li><strong>Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù‚ÙˆÙ…Ù‰</strong> Ø£Ùˆ <strong>National ID</strong></li>
                                <li><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯</strong> Ø£Ùˆ <strong>Date of Birth</strong></li>
                            </ul>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                <i class="fas fa-file-excel ml-2"></i>
                                Ø§Ø®ØªØ± Ù…Ù„Ù Excel (.xlsx, .xls)
                            </label>
                            <input type="file" id="employee-excel-file-input" accept=".xlsx,.xls" class="form-input">
                        </div>
                        <div id="employee-import-preview" class="hidden">
                            <h3 class="text-sm font-semibold mb-2">Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø£ÙˆÙ„ 5 ØµÙÙˆÙ):</h3>
                            <div class="max-h-60 overflow-auto border rounded">
                                <table class="data-table text-xs">
                                    <thead id="employee-preview-head"></thead>
                                    <tbody id="employee-preview-body"></tbody>
                                </table>
                            </div>
                            <p id="employee-preview-count" class="text-sm text-gray-600 mt-2"></p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="this.closest('.modal-overlay').remove()">Ø¥Ù„ØºØ§Ø¡</button>
                    <button type="button" id="employee-import-confirm-btn" class="btn-primary" disabled>
                        <i class="fas fa-check ml-2"></i>
                        ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯
                    </button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);

        const fileInput = document.getElementById('employee-excel-file-input');
        const preview = document.getElementById('employee-import-preview');
        const confirmBtn = document.getElementById('employee-import-confirm-btn');
        let importedData = [];

        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            Loading.show();
            try {
                // Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù Excel Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… SheetJS
                const buffer = await file.arrayBuffer();
                const workbook = XLSX.read(buffer, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const data = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                if (data.length < 2) {
                    Notification.error('Ø§Ù„Ù…Ù„Ù ÙØ§Ø±Øº Ø£Ùˆ ØºÙŠØ± ØµØ­ÙŠØ­');
                    Loading.hide();
                    return;
                }

                const headers = data[0].map(h => String(h || '').trim());
                importedData = data.slice(1).map(row => {
                    const obj = {};
                    headers.forEach((header, index) => {
                        obj[header] = row[index] || '';
                    });
                    return obj;
                }).filter(row => row[headers[0]]); // ØªØµÙÙŠØ© Ø§Ù„ØµÙÙˆÙ Ø§Ù„ÙØ§Ø±ØºØ©

                // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
                const previewHead = document.getElementById('employee-preview-head');
                const previewBody = document.getElementById('employee-preview-body');
                const previewCount = document.getElementById('employee-preview-count');

                previewHead.innerHTML = `<tr>${headers.map(h => `<th>${Utils.escapeHTML(h)}</th>`).join('')}</tr>`;
                previewBody.innerHTML = importedData.slice(0, 5).map(row => 
                    `<tr>${headers.map(h => `<td>${Utils.escapeHTML(String(row[h] || ''))}</td>`).join('')}</tr>`
                ).join('');

                previewCount.textContent = `Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØµÙÙˆÙ: ${importedData.length}`;
                preview.classList.remove('hidden');
                confirmBtn.disabled = false;

                Loading.hide();
            } catch (error) {
                Loading.hide();
                Notification.error('ÙØ´Ù„ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù: ' + error.message);
            }
        });

        confirmBtn.addEventListener('click', async () => {
            if (importedData.length === 0) return;

            Loading.show();
            try {
                let successCount = 0;
                let errorCount = 0;

                importedData.forEach(row => {
                    try {
                        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø£ÙŠ Ø¹Ù…ÙˆØ¯ Ù…Ù…ÙƒÙ†
                        const name = row['Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù'] || row['Employee Name'] || row['Name'] || row['name'] || '';
                        const sapId = row['ID SAP'] || row['SAP ID'] || row['sap_id'] || '';
                        const hireDate = row['ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ¹ÙŠÙŠÙ†'] || row['Hire Date'] || row['hire_date'] || '';
                        const job = row['Job'] || row['job'] || row['Ø§Ù„Ù…Ù†ØµØ¨'] || '';
                        const dept = row['Department'] || row['department'] || row['Ø§Ù„Ù‚Ø³Ù…'] || '';
                        const branch = row['Branch'] || row['branch'] || row['Ø§Ù„ÙØ±Ø¹'] || '';
                        const location = row['Location'] || row['location'] || row['Ø§Ù„Ù…ÙˆÙ‚Ø¹'] || '';
                        const gender = row['Gender'] || row['gender'] || row['Ø§Ù„Ø¬Ù†Ø³'] || '';
                        const nationalId = row['Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù‚ÙˆÙ…Ù‰'] || row['National ID'] || row['national_id'] || '';
                        const birthDate = row['ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯'] || row['Date of Birth'] || row['birth_date'] || '';
                        const email = row['Email'] || row['email'] || row['Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ'] || '';
                        const phone = row['Phone'] || row['phone'] || row['Ø§Ù„Ù‡Ø§ØªÙ'] || '';

                        if (!name && !sapId) {
                            errorCount++;
                            return;
                        }

                        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…ÙˆØ¸Ù Ù…Ø³Ø¨Ù‚Ø§Ù‹
                        const existing = AppState.appData.employees.find(e => 
                            (e.employeeNumber && e.employeeNumber === String(sapId)) ||
                            (e.name && e.name.toLowerCase() === String(name).toLowerCase())
                        );

                        if (!existing) {
                            const employee = {
                                id: Utils.generateId('EMPLOYEE'),
                                name: String(name).trim(),
                                employeeNumber: String(sapId).trim() || Utils.generateId('EMP'),
                                sapId: String(sapId).trim(),
                                hireDate: hireDate ? new Date(hireDate).toISOString() : new Date().toISOString(),
                                position: String(job).trim(),
                                department: String(dept).trim(),
                                branch: String(branch).trim(),
                                location: String(location).trim(),
                                gender: String(gender).trim(),
                                nationalId: String(nationalId).trim(),
                                birthDate: birthDate ? new Date(birthDate).toISOString() : '',
                                email: String(email).trim(),
                                phone: String(phone).trim(),
                                photo: '',
                                createdAt: new Date().toISOString(),
                                updatedAt: new Date().toISOString()
                            };

                            AppState.appData.employees.push(employee);
                            successCount++;
                        } else {
                            errorCount++;
                        }
                    } catch (err) {
                        errorCount++;
                    }
                });

                DataManager.save();
                await GoogleIntegration.autoSave('Employees', AppState.appData.employees);

                Loading.hide();
                Notification.success(`ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ${successCount} Ù…ÙˆØ¸Ù${errorCount > 0 ? ` (ÙØ´Ù„ ${errorCount})` : ''}`);
                modal.remove();
                this.loadEmployeesList();
            } catch (error) {
                Loading.hide();
                Notification.error('ÙØ´Ù„ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯: ' + error.message);
            }
        });

        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
        });
    },

    async handleSubmit(e) {
        e.preventDefault();
        
        const employeeData = this.currentEditId ? AppState.appData.employees.find(e => e.id === this.currentEditId) : null;
        
        let photoBase64 = employeeData?.photo || '';
        const photoInput = document.getElementById('employee-photo-input');
        if (photoInput && photoInput.files.length > 0) {
            const file = photoInput.files[0];
            if (file.size > 2 * 1024 * 1024) {
                Notification.error('Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹. Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 2MB');
                return;
            }
            photoBase64 = await this.convertImageToBase64(file);
        }

        const formData = {
            id: this.currentEditId || Utils.generateId('EMPLOYEE'),
            name: document.getElementById('employee-name').value.trim(),
            employeeNumber: document.getElementById('employee-number').value.trim(),
            sapId: document.getElementById('employee-sap-id').value.trim(),
            hireDate: document.getElementById('employee-hire-date').value ? new Date(document.getElementById('employee-hire-date').value).toISOString() : new Date().toISOString(),
            birthDate: document.getElementById('employee-birth-date').value ? new Date(document.getElementById('employee-birth-date').value).toISOString() : '',
            department: document.getElementById('employee-department').value.trim(),
            position: document.getElementById('employee-position').value.trim(),
            branch: document.getElementById('employee-branch').value.trim(),
            location: document.getElementById('employee-location').value.trim(),
            gender: document.getElementById('employee-gender').value,
            nationalId: document.getElementById('employee-national-id').value.trim(),
            email: document.getElementById('employee-email').value.trim(),
            phone: document.getElementById('employee-phone').value.trim(),
            photo: photoBase64,
            createdAt: this.currentEditId ? employeeData?.createdAt : new Date().toISOString(),
            updatedAt: new Date().toISOString()
        };

        if (!formData.name || !formData.sapId || !formData.employeeNumber || !formData.department || !formData.position) {
            Notification.error('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ÙˆØ¸ÙŠÙÙŠØŒ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠØŒ Ø§Ù„Ù‚Ø³Ù…ØŒ Ø§Ù„Ù…Ù†ØµØ¨)');
            return;
        }

        Loading.show();
        try {
            if (this.currentEditId) {
                const index = AppState.appData.employees.findIndex(e => e.id === this.currentEditId);
                if (index !== -1) AppState.appData.employees[index] = formData;
                Notification.success('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆØ¸Ù Ø¨Ù†Ø¬Ø§Ø­');
            } else {
                AppState.appData.employees.push(formData);
                Notification.success('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ¸Ù Ø¨Ù†Ø¬Ø§Ø­');
            }

            DataManager.save();
            // Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙÙŠ Google Sheets
            await GoogleIntegration.autoSave('Employees', AppState.appData.employees);

            Loading.hide();
            this.showList();
        } catch (error) {
            Loading.hide();
            Notification.error('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
        }
    },

    async convertImageToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    },

    async showList() {
        this.currentEditId = null;
        const content = document.getElementById('employees-content');
        if (content) {
            content.innerHTML = await this.renderList();
            this.setupEventListeners();
            this.loadEmployeesList();
        }
    },

    async editEmployee(id) {
        const employee = AppState.appData.employees.find(e => e.id === id);
        if (employee) await this.showForm(employee);
    },

    async viewEmployee(id) {
        const employee = AppState.appData.employees.find(e => e.id === id);
        if (!employee) return;

        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 700px;">
                <div class="modal-header">
                    <h2 class="modal-title">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ÙˆØ¸Ù</h2>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="space-y-4">
                        <div class="text-center mb-4">
                            ${employee.photo ? `<img src="${employee.photo}" alt="${Utils.escapeHTML(employee.name || '')}" class="w-32 h-32 rounded-full object-cover mx-auto border-4 border-gray-200">` : `<div class="w-32 h-32 rounded-full bg-gray-200 flex items-center justify-center mx-auto"><i class="fas fa-user text-5xl text-gray-400"></i></div>`}
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm font-semibold text-gray-600">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„:</label>
                                <p class="text-gray-800">${Utils.escapeHTML(employee.name || '')}</p>
                            </div>
                            <div>
                                <label class="text-sm font-semibold text-gray-600">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ:</label>
                                <p class="text-gray-800 font-mono">${Utils.escapeHTML(employee.employeeNumber || '')}</p>
                            </div>
                            <div>
                                <label class="text-sm font-semibold text-gray-600">Ø§Ù„Ù‚Ø³Ù…:</label>
                                <p class="text-gray-800">${Utils.escapeHTML(employee.department || '')}</p>
                            </div>
                            <div>
                                <label class="text-sm font-semibold text-gray-600">Ø§Ù„Ù…Ù†ØµØ¨:</label>
                                <p class="text-gray-800">${Utils.escapeHTML(employee.position || '')}</p>
                            </div>
                            <div>
                                <label class="text-sm font-semibold text-gray-600">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</label>
                                <p class="text-gray-800">${Utils.escapeHTML(employee.email || '')}</p>
                            </div>
                            <div>
                                <label class="text-sm font-semibold text-gray-600">Ø§Ù„Ù‡Ø§ØªÙ:</label>
                                <p class="text-gray-800">${Utils.escapeHTML(employee.phone || '')}</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" onclick="this.closest('.modal-overlay').remove()">Ø¥ØºÙ„Ø§Ù‚</button>
                    <button class="btn-primary" onclick="Employees.editEmployee('${employee.id}'); this.closest('.modal-overlay').remove();">
                        <i class="fas fa-edit ml-2"></i>ØªØ¹Ø¯ÙŠÙ„
                    </button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
        });
    },

    async deleteEmployee(id) {
        if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¸ÙØŸ')) return;
        Loading.show();
        try {
            AppState.appData.employees = (AppState.appData.employees || []).filter(e => e.id !== id);
            DataManager.save();
            // Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙÙŠ Google Sheets
            await GoogleIntegration.autoSave('Employees', AppState.appData.employees);
            Loading.hide();
            Notification.success('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ¸Ù Ø¨Ù†Ø¬Ø§Ø­');
            this.loadEmployeesList();
        } catch (error) {
            Loading.hide();
            Notification.error('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
        }
    },

    filterEmployees(searchTerm = '') {
        const employees = AppState.appData.employees || [];
        let filtered = employees;
        
        if (searchTerm) {
            const term = searchTerm.toLowerCase();
            filtered = filtered.filter(employee => 
                employee.name?.toLowerCase().includes(term) ||
                employee.employeeNumber?.toLowerCase().includes(term) ||
                employee.department?.toLowerCase().includes(term) ||
                employee.position?.toLowerCase().includes(term) ||
                employee.email?.toLowerCase().includes(term)
            );
        }
        
        const tbody = document.querySelector('#employees-table-container tbody');
        if (tbody) {
            tbody.innerHTML = filtered.length === 0 ? 
                '<tr><td colspan="8" class="text-center text-gray-500 py-8">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</td></tr>' :
                filtered.map(employee => `
                    <tr>
                        <td>
                            ${employee.photo ? `<img src="${employee.photo}" alt="${Utils.escapeHTML(employee.name || '')}" class="w-12 h-12 rounded-full object-cover">` : `<div class="w-12 h-12 rounded-full bg-gray-200 flex items-center justify-center"><i class="fas fa-user text-gray-400"></i></div>`}
                        </td>
                        <td>${Utils.escapeHTML(employee.name || '')}</td>
                        <td>${Utils.escapeHTML(employee.employeeNumber || '')}</td>
                        <td>${Utils.escapeHTML(employee.department || '')}</td>
                        <td>${Utils.escapeHTML(employee.position || '')}</td>
                        <td>${Utils.escapeHTML(employee.email || '')}</td>
                        <td>${Utils.escapeHTML(employee.phone || '')}</td>
                        <td>
                            <div class="flex items-center gap-2">
                                <button onclick="Employees.viewEmployee('${employee.id}')" class="btn-icon btn-icon-info">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button onclick="Employees.editEmployee('${employee.id}')" class="btn-icon btn-icon-primary">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="Employees.deleteEmployee('${employee.id}')" class="btn-icon btn-icon-danger">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('');
        }
    }
};

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªÙˆÙ„ÙŠØ¯ ÙƒÙˆØ¯ ISO Ù„Ù„Ù†Ù…Ø§Ø°Ø¬
function generateISOCode(prefix, dataArray) {
    const year = new Date().getFullYear();
    const month = String(new Date().getMonth() + 1).padStart(2, '0');
    const count = (dataArray || []).length + 1;
    return `${prefix}-${year}${month}-${String(count).padStart(4, '0')}`;
}

// ===== Behavior Monitoring Module (Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ØªØµØ±ÙØ§Øª) =====
const BehaviorMonitoring = {
    async load() {
        const section = document.getElementById('behavior-monitoring-section');
        if (!section) return;

        section.innerHTML = `
            <div class="section-header">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="section-title">
                            <i class="fas fa-eye ml-3"></i>
                            Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ØªØµØ±ÙØ§Øª
                        </h1>
                        <p class="section-subtitle">ØªØ³Ø¬ÙŠÙ„ ÙˆÙ…ØªØ§Ø¨Ø¹Ø© ØªØµØ±ÙØ§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</p>
                    </div>
                    <button id="add-behavior-btn" class="btn-primary">
                        <i class="fas fa-plus ml-2"></i>
                        ØªØ³Ø¬ÙŠÙ„ ØªØµØ±Ù Ø¬Ø¯ÙŠØ¯
                    </button>
                </div>
            </div>
            <div id="behavior-content" class="mt-6">
                ${await this.renderList()}
            </div>
        `;
        this.setupEventListeners();
        this.loadBehaviorList();
    },

    async renderList() {
        return `
            <div class="content-card">
                <div class="card-header">
                    <h2 class="card-title"><i class="fas fa-list ml-2"></i>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØµØ±ÙØ§Øª</h2>
                </div>
                <div class="card-body">
                    <div id="behavior-table-container">
                        <div class="empty-state">
                            <p class="text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØµØ±ÙØ§Øª Ù…Ø³Ø¬Ù„Ø©</p>
                        </div>
                    </div>
                </div>
            </div>
        `;
    },

    async loadBehaviorList() {
        const container = document.getElementById('behavior-table-container');
        if (!container) return;

        const behaviors = AppState.appData.behaviorMonitoring || [];
        
        if (behaviors.length === 0) {
            container.innerHTML = '<div class="empty-state"><p class="text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØµØ±ÙØ§Øª Ù…Ø³Ø¬Ù„Ø©</p></div>';
            return;
        }

        container.innerHTML = `
            <table class="data-table">
                <thead>
                    <tr>
                        <th>ÙƒÙˆØ¯ ISO</th>
                        <th>Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù</th>
                        <th>Ù†ÙˆØ¹ Ø§Ù„ØªØµØ±Ù</th>
                        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                        <th>Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</th>
                        <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                    </tr>
                </thead>
                <tbody>
                    ${behaviors.map(b => `
                        <tr>
                            <td>${Utils.escapeHTML(b.isoCode || '')}</td>
                            <td>${Utils.escapeHTML(b.employeeName || '')}</td>
                            <td>${Utils.escapeHTML(b.behaviorType || '')}</td>
                            <td>${b.date ? Utils.formatDate(b.date) : '-'}</td>
                            <td><span class="badge badge-${b.rating === 'Ø¥ÙŠØ¬Ø§Ø¨ÙŠ' ? 'success' : 'warning'}">${b.rating || '-'}</span></td>
                            <td>
                                <div class="flex items-center gap-2">
                                    <button onclick="BehaviorMonitoring.viewBehavior('${b.id}')" class="btn-icon btn-icon-primary" title="Ø¹Ø±Ø¶">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button onclick="BehaviorMonitoring.exportPDF('${b.id}')" class="btn-icon btn-icon-success" title="ØªØµØ¯ÙŠØ± PDF">
                                        <i class="fas fa-file-pdf"></i>
                                    </button>
                                    <button onclick="BehaviorMonitoring.printReport('${b.id}')" class="btn-icon btn-icon-info" title="Ø·Ø¨Ø§Ø¹Ø©">
                                        <i class="fas fa-print"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
    },

    setupEventListeners() {
        setTimeout(() => {
            const addBtn = document.getElementById('add-behavior-btn');
            if (addBtn) addBtn.addEventListener('click', () => this.showForm());
        }, 100);
    },

    async showForm(data = null) {
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h2 class="modal-title">${data ? 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªØµØ±Ù' : 'ØªØ³Ø¬ÙŠÙ„ ØªØµØ±Ù Ø¬Ø¯ÙŠØ¯'}</h2>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="behavior-form" class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ *</label>
                            <input type="text" id="behavior-employee-code" required class="form-input"
                                value="${data?.employeeCode || data?.employeeNumber || ''}" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù *</label>
                            <div class="relative">
                                <input type="text" id="behavior-employee-name" required class="form-input"
                                    value="${data?.employeeName || ''}" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ" autocomplete="off">
                                <div id="behavior-employee-dropdown" class="absolute z-50 hidden w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-auto"></div>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                <i class="fas fa-image ml-2"></i>
                                ØµÙˆØ±Ø© (ØºÙŠØ± Ø¥Ù„Ø²Ø§Ù…ÙŠ)
                            </label>
                            <input type="file" id="behavior-photo-input" accept="image/*" class="form-input">
                            <div id="behavior-photo-preview" class="mt-2 ${data?.photo ? '' : 'hidden'}">
                                <img src="${data?.photo || ''}" alt="ØµÙˆØ±Ø©" class="w-32 h-32 object-cover rounded border" id="behavior-photo-img">
                                <button type="button" onclick="document.getElementById('behavior-photo-input').value=''; document.getElementById('behavior-photo-preview').classList.add('hidden');" class="mt-1 text-xs text-red-600">Ø­Ø°Ù Ø§Ù„ØµÙˆØ±Ø©</button>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ù†ÙˆØ¹ Ø§Ù„ØªØµØ±Ù *</label>
                            <select id="behavior-type" required class="form-input">
                                <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù†ÙˆØ¹</option>
                                <option value="Ø¥ÙŠØ¬Ø§Ø¨ÙŠ" ${data?.behaviorType === 'Ø¥ÙŠØ¬Ø§Ø¨ÙŠ' ? 'selected' : ''}>Ø¥ÙŠØ¬Ø§Ø¨ÙŠ</option>
                                <option value="Ø³Ù„Ø¨ÙŠ" ${data?.behaviorType === 'Ø³Ù„Ø¨ÙŠ' ? 'selected' : ''}>Ø³Ù„Ø¨ÙŠ</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„ØªØ§Ø±ÙŠØ® *</label>
                            <input type="date" id="behavior-date" required class="form-input" 
                                value="${data?.date ? new Date(data.date).toISOString().split('T')[0] : new Date().toISOString().split('T')[0]}">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„ØªÙ‚ÙŠÙŠÙ… *</label>
                            <select id="behavior-rating" required class="form-input">
                                <option value="">Ø§Ø®ØªØ± Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</option>
                                <option value="Ù…Ù…ØªØ§Ø²" ${data?.rating === 'Ù…Ù…ØªØ§Ø²' ? 'selected' : ''}>Ù…Ù…ØªØ§Ø²</option>
                                <option value="Ø¬ÙŠØ¯" ${data?.rating === 'Ø¬ÙŠØ¯' ? 'selected' : ''}>Ø¬ÙŠØ¯</option>
                                <option value="Ù…Ù‚Ø¨ÙˆÙ„" ${data?.rating === 'Ù…Ù‚Ø¨ÙˆÙ„' ? 'selected' : ''}>Ù…Ù‚Ø¨ÙˆÙ„</option>
                                <option value="Ø¶Ø¹ÙŠÙ" ${data?.rating === 'Ø¶Ø¹ÙŠÙ' ? 'selected' : ''}>Ø¶Ø¹ÙŠÙ</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„ÙˆØµÙ *</label>
                            <textarea id="behavior-description" required class="form-input" rows="4" 
                                placeholder="ÙˆØµÙ Ø§Ù„ØªØµØ±Ù">${Utils.escapeHTML(data?.description || '')}</textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="this.closest('.modal-overlay').remove()">Ø¥Ù„ØºØ§Ø¡</button>
                    <button type="button" id="save-behavior-btn" class="btn-primary">Ø­ÙØ¸</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        
        // Setup employee autocomplete
        if (typeof EmployeeHelper !== 'undefined') {
            EmployeeHelper.setupAutocomplete('behavior-employee-name', (employee) => {
                if (employee) {
                    document.getElementById('behavior-employee-code').value = employee.code || '';
                    document.getElementById('behavior-employee-name').value = employee.name || '';
                }
            });
            
            // Setup employee code search
            EmployeeHelper.setupEmployeeCodeSearch('behavior-employee-code', 'behavior-employee-name');
        }
        
        // Setup photo preview
        const photoInput = document.getElementById('behavior-photo-input');
        const photoPreview = document.getElementById('behavior-photo-preview');
        const photoImg = document.getElementById('behavior-photo-img');
        if (photoInput && photoPreview && photoImg) {
            photoInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    if (file.size > 2 * 1024 * 1024) {
                        Notification.error('Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹. Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 2MB');
                        photoInput.value = '';
                        return;
                    }
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        photoImg.src = e.target.result;
                        photoPreview.classList.remove('hidden');
                    };
                    reader.readAsDataURL(file);
                }
            });
        }
        
        const saveBtn = modal.querySelector('#save-behavior-btn');
        const form = modal.querySelector('#behavior-form');
        saveBtn.addEventListener('click', () => this.handleSubmit(form, data?.id, modal));
        
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
        });
    },

    async convertImageToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    },

    async handleSubmit(form, editId = null, modal) {
        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø©
        let photoBase64 = editId ? (AppState.appData.behaviorMonitoring.find(b => b.id === editId)?.photo || '') : '';
        const photoInput = document.getElementById('behavior-photo-input');
        if (photoInput && photoInput.files.length > 0) {
            const file = photoInput.files[0];
            if (file.size > 2 * 1024 * 1024) {
                Notification.error('Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹. Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 2MB');
                return;
            }
            photoBase64 = await this.convertImageToBase64(file);
        }
        
        const employeeCode = document.getElementById('behavior-employee-code').value.trim();
        const employeeName = document.getElementById('behavior-employee-name').value.trim();
        const employee = AppState.appData.employees.find(e => 
            (e.employeeNumber && e.employeeNumber === employeeCode) ||
            (e.sapId && e.sapId === employeeCode) ||
            e.name === employeeName
        );
        
        const formData = {
            id: editId || Utils.generateId('BEHAV'),
            isoCode: generateISOCode('BEH', AppState.appData.behaviorMonitoring),
            employeeId: employee?.id || '',
            employeeCode: employeeCode,
            employeeNumber: employeeCode,
            employeeName: employeeName,
            photo: photoBase64,
            behaviorType: document.getElementById('behavior-type').value,
            date: new Date(document.getElementById('behavior-date').value).toISOString(),
            rating: document.getElementById('behavior-rating').value,
            description: document.getElementById('behavior-description').value.trim(),
            createdAt: editId ? AppState.appData.behaviorMonitoring.find(b => b.id === editId)?.createdAt : new Date().toISOString(),
            updatedAt: new Date().toISOString()
        };
        
        Loading.show();
        try {
            if (editId) {
                const index = AppState.appData.behaviorMonitoring.findIndex(b => b.id === editId);
                if (index !== -1) AppState.appData.behaviorMonitoring[index] = formData;
                Notification.success('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØµØ±Ù Ø¨Ù†Ø¬Ø§Ø­');
            } else {
                AppState.appData.behaviorMonitoring.push(formData);
                Notification.success('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØµØ±Ù Ø¨Ù†Ø¬Ø§Ø­');
            }
            
            DataManager.save();
            
            // Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙÙŠ Google Sheets
            await GoogleIntegration.autoSave('BehaviorMonitoring', AppState.appData.behaviorMonitoring);
            
            Loading.hide();
            modal.remove();
            this.loadBehaviorList();
        } catch (error) {
            Loading.hide();
            Notification.error('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
        }
    },

    async viewBehavior(id) {
        const behavior = AppState.appData.behaviorMonitoring.find(b => b.id === id);
        if (!behavior) {
            Notification.error('Ø§Ù„ØªØµØ±Ù ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
            return;
        }
        
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h2 class="modal-title">ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØµØ±Ù</h2>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="space-y-3">
                        <div><strong>ÙƒÙˆØ¯ ISO:</strong> ${Utils.escapeHTML(behavior.isoCode || '')}</div>
                        <div><strong>Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ:</strong> ${Utils.escapeHTML(behavior.employeeCode || behavior.employeeNumber || '')}</div>
                        <div><strong>Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù:</strong> ${Utils.escapeHTML(behavior.employeeName || '')}</div>
                        <div><strong>Ù†ÙˆØ¹ Ø§Ù„ØªØµØ±Ù:</strong> ${Utils.escapeHTML(behavior.behaviorType || '')}</div>
                        <div><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${Utils.formatDate(behavior.date)}</div>
                        <div><strong>Ø§Ù„ØªÙ‚ÙŠÙŠÙ…:</strong> ${Utils.escapeHTML(behavior.rating || '')}</div>
                        <div><strong>Ø§Ù„ÙˆØµÙ:</strong><br>${Utils.escapeHTML(behavior.description || '')}</div>
                        ${behavior.photo ? `<div><strong>Ø§Ù„ØµÙˆØ±Ø©:</strong><br><img src="${behavior.photo}" alt="ØµÙˆØ±Ø©" class="w-48 h-48 object-cover rounded border mt-2"></div>` : ''}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="this.closest('.modal-overlay').remove()">Ø¥ØºÙ„Ø§Ù‚</button>
                    <button type="button" onclick="BehaviorMonitoring.exportPDF('${behavior.id}');" class="btn-secondary">
                        <i class="fas fa-file-pdf ml-2"></i>ØªØµØ¯ÙŠØ± PDF
                    </button>
                    <button type="button" onclick="BehaviorMonitoring.printReport('${behavior.id}');" class="btn-secondary">
                        <i class="fas fa-print ml-2"></i>Ø·Ø¨Ø§Ø¹Ø©
                    </button>
                    <button type="button" onclick="BehaviorMonitoring.showForm(${JSON.stringify(behavior).replace(/"/g, '&quot;')}); this.closest('.modal-overlay').remove();" class="btn-primary">ØªØ¹Ø¯ÙŠÙ„</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
        });
    },

    async exportPDF(id) {
        const behavior = AppState.appData.behaviorMonitoring.find(b => b.id === id);
        if (!behavior) {
            Notification.error('Ø§Ù„ØªØµØ±Ù ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
            return;
        }

        try {
            Loading.show();
            const formCode = behavior.isoCode || `BEH-${behavior.id?.substring(0, 8) || 'UNKNOWN'}`;
            const formTitle = 'ØªÙ‚Ø±ÙŠØ± Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ØªØµØ±ÙØ§Øª';
            
            const content = `
                <table>
                    <tr><th>ÙƒÙˆØ¯ ISO</th><td>${Utils.escapeHTML(behavior.isoCode || '')}</td></tr>
                    <tr><th>Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</th><td>${Utils.escapeHTML(behavior.employeeCode || behavior.employeeNumber || '')}</td></tr>
                    <tr><th>Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù</th><td>${Utils.escapeHTML(behavior.employeeName || '')}</td></tr>
                    <tr><th>Ù†ÙˆØ¹ Ø§Ù„ØªØµØ±Ù</th><td>${Utils.escapeHTML(behavior.behaviorType || '')}</td></tr>
                    <tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><td>${Utils.formatDate(behavior.date)}</td></tr>
                    <tr><th>Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</th><td>${Utils.escapeHTML(behavior.rating || '')}</td></tr>
                    <tr><th colspan="2">Ø§Ù„ÙˆØµÙ</th></tr>
                    <tr><td colspan="2">${Utils.escapeHTML(behavior.description || '')}</td></tr>
                </table>
                ${behavior.photo ? `
                <div class="section-title">ØµÙˆØ±Ø© Ø§Ù„ØªØµØ±Ù:</div>
                <div style="text-align: center; margin: 20px 0;">
                    <img src="${behavior.photo}" alt="ØµÙˆØ±Ø© Ø§Ù„ØªØµØ±Ù" style="max-width: 100%; max-height: 400px; border: 1px solid #ddd; border-radius: 8px;">
                </div>
                ` : ''}
            `;
            
            const htmlContent = typeof FormHeader !== 'undefined' && FormHeader.generatePDFHTML
                ? FormHeader.generatePDFHTML(formCode, formTitle, content, false, true, { version: '1.0' }, behavior.createdAt, behavior.updatedAt)
                : `<html><body>${content}</body></html>`;

            const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const printWindow = window.open(url, '_blank');
            if (printWindow) {
                printWindow.onload = () => {
                    setTimeout(() => {
                        printWindow.print();
                        Loading.hide();
                    }, 500);
                };
            } else {
                Loading.hide();
                Notification.error('ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©');
            }
        } catch (error) {
            Loading.hide();
            Notification.error('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØµØ¯ÙŠØ± PDF: ' + error.message);
        }
    },

    async printReport(id) {
        await this.exportPDF(id);
    }
};

// ===== Chemical Safety Module (Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„ÙƒÙŠÙ…ÙŠØ§Ø¦ÙŠØ©) =====
const ChemicalSafety = {
    async load() {
        const section = document.getElementById('chemical-safety-section');
        if (!section) return;

        section.innerHTML = `
            <div class="section-header">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="section-title">
                            <i class="fas fa-flask ml-3"></i>
                            ØªØ¯Ø±ÙŠØ¨Ø§Øª Ø§Ù„Ø³Ù„Ø§Ù…Ø© Ù„Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„ÙƒÙŠÙ…ÙŠØ§Ø¦ÙŠØ©
                        </h1>
                        <p class="section-subtitle">Ø¥Ø¯Ø§Ø±Ø© ØªØ¯Ø±ÙŠØ¨Ø§Øª Ø§Ù„Ø³Ù„Ø§Ù…Ø© Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„ÙƒÙŠÙ…ÙŠØ§Ø¦ÙŠØ©</p>
                    </div>
                    <button id="add-chemical-btn" class="btn-primary">
                        <i class="fas fa-plus ml-2"></i>
                        Ø¥Ø¶Ø§ÙØ© ØªØ¯Ø±ÙŠØ¨ Ø¬Ø¯ÙŠØ¯
                    </button>
                </div>
            </div>
            <div id="chemical-content" class="mt-6">
                ${await this.renderList()}
            </div>
        `;
        this.setupEventListeners();
        this.loadChemicalList();
    },

    async renderList() {
        return `
            <div class="content-card">
                <div class="card-header">
                    <h2 class="card-title"><i class="fas fa-list ml-2"></i>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ¯Ø±ÙŠØ¨Ø§Øª</h2>
                </div>
                <div class="card-body">
                    <div id="chemical-table-container">
                        <div class="empty-state">
                            <p class="text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ¯Ø±ÙŠØ¨Ø§Øª Ù…Ø³Ø¬Ù„Ø©</p>
                        </div>
                    </div>
                </div>
            </div>
        `;
    },

    async loadChemicalList() {
        const container = document.getElementById('chemical-table-container');
        if (!container) return;

        const chemicals = AppState.appData.chemicalSafety || [];
        
        if (chemicals.length === 0) {
            container.innerHTML = '<div class="empty-state"><p class="text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ¯Ø±ÙŠØ¨Ø§Øª Ù…Ø³Ø¬Ù„Ø©</p></div>';
            return;
        }

        container.innerHTML = `
            <table class="data-table">
                <thead>
                    <tr>
                        <th>ÙƒÙˆØ¯ ISO</th>
                        <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©</th>
                        <th>Ø§Ù„Ù…Ø¯Ø±Ø¨</th>
                        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                        <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                        <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                    </tr>
                </thead>
                <tbody>
                    ${chemicals.map(c => `
                        <tr>
                            <td>${Utils.escapeHTML(c.isoCode || '')}</td>
                            <td>${Utils.escapeHTML(c.chemicalName || '')}</td>
                            <td>${Utils.escapeHTML(c.trainer || '')}</td>
                            <td>${c.date ? Utils.formatDate(c.date) : '-'}</td>
                            <td><span class="badge badge-${c.status === 'Ù…ÙƒØªÙ…Ù„' ? 'success' : 'warning'}">${c.status || '-'}</span></td>
                            <td>
                                <button onclick="ChemicalSafety.viewChemical('${c.id}')" class="btn-icon btn-icon-primary">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
    },

    setupEventListeners() {
        setTimeout(() => {
            const addBtn = document.getElementById('add-chemical-btn');
            if (addBtn) addBtn.addEventListener('click', () => this.showForm());
        }, 100);
    },

    async showForm(data = null) {
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h2 class="modal-title">${data ? 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªØ¯Ø±ÙŠØ¨' : 'Ø¥Ø¶Ø§ÙØ© ØªØ¯Ø±ÙŠØ¨ Ø¬Ø¯ÙŠØ¯'}</h2>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="chemical-form" class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„ÙƒÙŠÙ…ÙŠØ§Ø¦ÙŠØ© *</label>
                            <input type="text" id="chemical-name" required class="form-input" 
                                value="${Utils.escapeHTML(data?.chemicalName || '')}" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„Ù…Ø¯Ø±Ø¨ *</label>
                            <input type="text" id="chemical-trainer" required class="form-input" 
                                value="${Utils.escapeHTML(data?.trainer || '')}" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø¨">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„ØªØ§Ø±ÙŠØ® *</label>
                            <input type="date" id="chemical-date" required class="form-input" 
                                value="${data?.date ? new Date(data.date).toISOString().split('T')[0] : new Date().toISOString().split('T')[0]}">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„Ø­Ø§Ù„Ø© *</label>
                            <select id="chemical-status" required class="form-input">
                                <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø­Ø§Ù„Ø©</option>
                                <option value="Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°" ${data?.status === 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°' ? 'selected' : ''}>Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</option>
                                <option value="Ù…ÙƒØªÙ…Ù„" ${data?.status === 'Ù…ÙƒØªÙ…Ù„' ? 'selected' : ''}>Ù…ÙƒØªÙ…Ù„</option>
                                <option value="Ù…Ù„ØºÙŠ" ${data?.status === 'Ù…Ù„ØºÙŠ' ? 'selected' : ''}>Ù…Ù„ØºÙŠ</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„ÙˆØµÙ</label>
                            <textarea id="chemical-description" class="form-input" rows="4" 
                                placeholder="ÙˆØµÙ Ø§Ù„ØªØ¯Ø±ÙŠØ¨">${Utils.escapeHTML(data?.description || '')}</textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                <i class="fas fa-link ml-2"></i>
                                Ø±Ø§Ø¨Ø· Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†
                            </label>
                            <div class="flex gap-2">
                                <input type="url" id="chemical-supplier-link" class="form-input flex-1"
                                    value="${Utils.escapeHTML(data?.supplierLink || '')}" 
                                    placeholder="https://example.com/supplier-form">
                                <button type="button" id="generate-supplier-link-btn" class="btn-secondary">
                                    <i class="fas fa-magic ml-2"></i>Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø§Ø¨Ø·
                                </button>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">
                                <i class="fas fa-info-circle ml-1"></i>
                                ÙŠÙ…ÙƒÙ† Ø¥Ø±Ø³Ø§Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø· Ù„Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† Ù‚Ø¨Ù„ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø´Ø±Ø§Ø¡ Ù„Ø±ÙØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„ÙƒÙŠÙ…ÙŠØ§Ø¦ÙŠØ©
                            </p>
                            ${data?.supplierLink ? `
                                <div class="mt-2 p-2 bg-blue-50 border border-blue-200 rounded">
                                    <a href="${Utils.escapeHTML(data.supplierLink)}" target="_blank" 
                                       class="text-blue-600 hover:text-blue-800 flex items-center gap-2">
                                        <i class="fas fa-external-link-alt"></i>
                                        ÙØªØ­ Ø±Ø§Ø¨Ø· Ø§Ù„Ù…ÙˆØ±Ø¯
                                    </a>
                                </div>
                            ` : ''}
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="this.closest('.modal-overlay').remove()">Ø¥Ù„ØºØ§Ø¡</button>
                    <button type="button" id="save-chemical-btn" class="btn-primary">Ø­ÙØ¸</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        
        // Generate supplier link
        const generateBtn = document.getElementById('generate-supplier-link-btn');
        if (generateBtn) {
            generateBtn.addEventListener('click', () => {
                const chemicalName = document.getElementById('chemical-name').value.trim();
                if (!chemicalName) {
                    Notification.error('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„ÙƒÙŠÙ…ÙŠØ§Ø¦ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹');
                    return;
                }
                const baseUrl = window.location.origin;
                const link = `${baseUrl}/supplier-form?chemical=${encodeURIComponent(chemicalName)}&id=${data?.id || Utils.generateId('CHEM')}`;
                document.getElementById('chemical-supplier-link').value = link;
                Notification.success('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø§Ø¨Ø· Ø§Ù„Ù…ÙˆØ±Ø¯ Ø¨Ù†Ø¬Ø§Ø­');
            });
        }
        
        const saveBtn = modal.querySelector('#save-chemical-btn');
        const form = modal.querySelector('#chemical-form');
        saveBtn.addEventListener('click', () => this.handleSubmit(form, data?.id, modal));
        
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
        });
    },

    async handleSubmit(form, editId = null, modal) {
        const formData = {
            id: editId || Utils.generateId('CHEM'),
            isoCode: generateISOCode('CHEM', AppState.appData.chemicalSafety),
            chemicalName: document.getElementById('chemical-name').value.trim(),
            trainer: document.getElementById('chemical-trainer').value.trim(),
            date: new Date(document.getElementById('chemical-date').value).toISOString(),
            status: document.getElementById('chemical-status').value,
            description: document.getElementById('chemical-description').value.trim(),
            supplierLink: document.getElementById('chemical-supplier-link').value.trim(),
            createdAt: editId ? AppState.appData.chemicalSafety.find(c => c.id === editId)?.createdAt : new Date().toISOString(),
            updatedAt: new Date().toISOString()
        };
        
        Loading.show();
        try {
            if (editId) {
                const index = AppState.appData.chemicalSafety.findIndex(c => c.id === editId);
                if (index !== -1) AppState.appData.chemicalSafety[index] = formData;
                Notification.success('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø¨Ù†Ø¬Ø§Ø­');
            } else {
                AppState.appData.chemicalSafety.push(formData);
                Notification.success('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø¨Ù†Ø¬Ø§Ø­');
            }
            
            DataManager.save();
            
            // Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙÙŠ Google Sheets
            await GoogleIntegration.autoSave('ChemicalSafety', AppState.appData.chemicalSafety);
            
            Loading.hide();
            modal.remove();
            this.loadChemicalList();
        } catch (error) {
            Loading.hide();
            Notification.error('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
        }
    },

    async viewChemical(id) {
        const chemical = AppState.appData.chemicalSafety.find(c => c.id === id);
        if (!chemical) {
            Notification.error('Ø§Ù„ØªØ¯Ø±ÙŠØ¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
            return;
        }
        
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h2 class="modal-title">ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØ¯Ø±ÙŠØ¨</h2>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="space-y-3">
                        <div><strong>ÙƒÙˆØ¯ ISO:</strong> ${Utils.escapeHTML(chemical.isoCode || '')}</div>
                        <div><strong>Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©:</strong> ${Utils.escapeHTML(chemical.chemicalName || '')}</div>
                        <div><strong>Ø§Ù„Ù…Ø¯Ø±Ø¨:</strong> ${Utils.escapeHTML(chemical.trainer || '')}</div>
                        <div><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${Utils.formatDate(chemical.date)}</div>
                        <div><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> ${Utils.escapeHTML(chemical.status || '')}</div>
                        <div><strong>Ø§Ù„ÙˆØµÙ:</strong><br>${Utils.escapeHTML(chemical.description || '')}</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="this.closest('.modal-overlay').remove()">Ø¥ØºÙ„Ø§Ù‚</button>
                    <button type="button" onclick="ChemicalSafety.showForm(${JSON.stringify(chemical).replace(/"/g, '&quot;')}); this.closest('.modal-overlay').remove();" class="btn-primary">ØªØ¹Ø¯ÙŠÙ„</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
        });
    }
};

// ===== Daily Observations Module (Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©) =====
const DailyObservations = {
    async load() {
        const section = document.getElementById('daily-observations-section');
        if (!section) return;

        section.innerHTML = `
            <div class="section-header">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="section-title">
                            <i class="fas fa-clipboard-check ml-3"></i>
                            Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©
                        </h1>
                        <p class="section-subtitle">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ù…Ù† Ù…Ø´Ø±ÙÙŠ Ø§Ù„Ø³Ù„Ø§Ù…Ø©</p>
                    </div>
                    <button id="add-observation-btn" class="btn-primary">
                        <i class="fas fa-plus ml-2"></i>
                        Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø§Ø­Ø¸Ø© Ø¬Ø¯ÙŠØ¯Ø©
                    </button>
                </div>
            </div>
            <div id="observations-content" class="mt-6">
                ${await this.renderList()}
            </div>
        `;
        this.setupEventListeners();
        this.loadObservationsList();
    },

    async renderList() {
        return `
            <div class="content-card">
                <div class="card-header">
                    <h2 class="card-title"><i class="fas fa-list ml-2"></i>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</h2>
                </div>
                <div class="card-body">
                    <div id="observations-table-container">
                        <div class="empty-state">
                            <p class="text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…Ø³Ø¬Ù„Ø©</p>
                        </div>
                    </div>
                </div>
            </div>
        `;
    },

    async loadObservationsList() {
        const container = document.getElementById('observations-table-container');
        if (!container) return;

        const observations = AppState.appData.dailyObservations || [];
        
        if (observations.length === 0) {
            container.innerHTML = '<div class="empty-state"><p class="text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…Ø³Ø¬Ù„Ø©</p></div>';
            return;
        }

        container.innerHTML = `
            <table class="data-table">
                <thead>
                    <tr>
                        <th>ÙƒÙˆØ¯ ISO</th>
                        <th>Ø§Ù„Ù…Ø´Ø±Ù</th>
                        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                        <th>Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©</th>
                        <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                        <th>Ø§Ù„ØµÙˆØ±</th>
                        <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                    </tr>
                </thead>
                <tbody>
                    ${observations.map(o => `
                        <tr>
                            <td>${Utils.escapeHTML(o.isoCode || '')}</td>
                            <td>${Utils.escapeHTML(o.supervisor || '')}</td>
                            <td>${o.date ? Utils.formatDate(o.date) : '-'}</td>
                            <td>${Utils.escapeHTML(o.observationType || '')}</td>
                            <td><span class="badge badge-${o.status === 'Ù…Ø­Ù„ÙˆÙ„' ? 'success' : 'warning'}">${o.status || '-'}</span></td>
                            <td>${o.images && o.images.length > 0 ? `<i class="fas fa-images text-blue-500" title="${o.images.length} ØµÙˆØ±Ø©"></i>` : '-'}</td>
                            <td>
                                <button onclick="DailyObservations.viewObservation('${o.id}')" class="btn-icon btn-icon-primary">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
    },

    setupEventListeners() {
        setTimeout(() => {
            const addBtn = document.getElementById('add-observation-btn');
            if (addBtn) addBtn.addEventListener('click', () => this.showForm());
        }, 100);
    },

    async showForm(data = null) {
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h2 class="modal-title">${data ? 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©' : 'Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø§Ø­Ø¸Ø© Ø¬Ø¯ÙŠØ¯Ø©'}</h2>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="observation-form" class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„Ù…Ø´Ø±Ù *</label>
                            <input type="text" id="observation-supervisor" required class="form-input" 
                                value="${Utils.escapeHTML(data?.supervisor || '')}" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±Ù">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„ØªØ§Ø±ÙŠØ® *</label>
                            <input type="date" id="observation-date" required class="form-input" 
                                value="${data?.date ? new Date(data.date).toISOString().split('T')[0] : new Date().toISOString().split('T')[0]}">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© *</label>
                            <select id="observation-type" required class="form-input">
                                <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù†ÙˆØ¹</option>
                                <option value="Ø³Ù„Ø§Ù…Ø©" ${data?.observationType === 'Ø³Ù„Ø§Ù…Ø©' ? 'selected' : ''}>Ø³Ù„Ø§Ù…Ø©</option>
                                <option value="Ø¨ÙŠØ¦Ø©" ${data?.observationType === 'Ø¨ÙŠØ¦Ø©' ? 'selected' : ''}>Ø¨ÙŠØ¦Ø©</option>
                                <option value="ØµØ­Ø©" ${data?.observationType === 'ØµØ­Ø©' ? 'selected' : ''}>ØµØ­Ø©</option>
                                <option value="Ø£Ø®Ø±Ù‰" ${data?.observationType === 'Ø£Ø®Ø±Ù‰' ? 'selected' : ''}>Ø£Ø®Ø±Ù‰</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„Ø­Ø§Ù„Ø© *</label>
                            <select id="observation-status" required class="form-input">
                                <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø­Ø§Ù„Ø©</option>
                                <option value="Ù…ÙØªÙˆØ­Ø©" ${data?.status === 'Ù…ÙØªÙˆØ­Ø©' ? 'selected' : ''}>Ù…ÙØªÙˆØ­Ø©</option>
                                <option value="Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©" ${data?.status === 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©' ? 'selected' : ''}>Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</option>
                                <option value="Ù…Ø­Ù„ÙˆÙ„Ø©" ${data?.status === 'Ù…Ø­Ù„ÙˆÙ„Ø©' ? 'selected' : ''}>Ù…Ø­Ù„ÙˆÙ„Ø©</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„ÙˆØµÙ *</label>
                            <textarea id="observation-description" required class="form-input" rows="4" 
                                placeholder="ÙˆØµÙ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©">${Utils.escapeHTML(data?.description || '')}</textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„ØªØµØ­ÙŠØ­ÙŠ</label>
                            <textarea id="observation-corrective" class="form-input" rows="4" 
                                placeholder="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„ØªØµØ­ÙŠØ­ÙŠ Ø§Ù„Ù…ØªØ®Ø°">${Utils.escapeHTML(data?.correctiveAction || '')}</textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                <i class="fas fa-images ml-2"></i>
                                Ø¥Ø±ÙØ§Ù‚ ØµÙˆØ± (Ø­Ø¯ Ø£Ù‚ØµÙ‰ ØµÙˆØ±ØªØ§Ù†)
                            </label>
                            <div class="grid grid-cols-2 gap-4 mb-2">
                                <div class="border-2 border-dashed border-gray-300 rounded-lg p-4">
                                    <label class="block text-sm font-semibold text-gray-700 mb-2 text-center">ØµÙˆØ±Ø© 1</label>
                                    <input type="file" id="observation-image-1" accept="image/*" class="form-input text-sm">
                                    <div id="observation-image-preview-1" class="mt-2 hidden">
                                        <img src="" alt="Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø© 1" class="w-full h-32 object-cover rounded border">
                                        <button type="button" onclick="this.closest('div').classList.add('hidden'); document.getElementById('observation-image-1').value='';" class="mt-1 text-xs text-red-600">Ø­Ø°Ù</button>
                                    </div>
                                </div>
                                <div class="border-2 border-dashed border-gray-300 rounded-lg p-4">
                                    <label class="block text-sm font-semibold text-gray-700 mb-2 text-center">ØµÙˆØ±Ø© 2</label>
                                    <input type="file" id="observation-image-2" accept="image/*" class="form-input text-sm">
                                    <div id="observation-image-preview-2" class="mt-2 hidden">
                                        <img src="" alt="Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø© 2" class="w-full h-32 object-cover rounded border">
                                        <button type="button" onclick="this.closest('div').classList.add('hidden'); document.getElementById('observation-image-2').value='';" class="mt-1 text-xs text-red-600">Ø­Ø°Ù</button>
                                    </div>
                                </div>
                            </div>
                            ${data?.images ? `
                                <div class="mt-2 grid grid-cols-2 gap-2">
                                    ${data.images.map((img, idx) => `
                                        <div class="relative">
                                            <img src="${img}" alt="ØµÙˆØ±Ø© ${idx + 1}" class="w-full h-24 object-cover rounded border">
                                            <button type="button" onclick="this.parentElement.remove();" class="absolute top-1 left-1 bg-red-500 text-white rounded-full w-6 h-6 text-xs">Ã—</button>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="this.closest('.modal-overlay').remove()">Ø¥Ù„ØºØ§Ø¡</button>
                    <button type="button" id="save-observation-btn" class="btn-primary">Ø­ÙØ¸</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±
        setTimeout(() => {
            ['1', '2'].forEach(num => {
                const input = document.getElementById(`observation-image-${num}`);
                const preview = document.getElementById(`observation-image-preview-${num}`);
                if (input && preview) {
                    input.addEventListener('change', async (e) => {
                        const file = e.target.files[0];
                        if (file) {
                            if (file.size > 5 * 1024 * 1024) {
                                Notification.error('Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹. Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 5MB');
                                input.value = '';
                                return;
                            }
                            const reader = new FileReader();
                            reader.onload = (e) => {
                                preview.querySelector('img').src = e.target.result;
                                preview.classList.remove('hidden');
                            };
                            reader.readAsDataURL(file);
                        }
                    });
                }
            });
        }, 100);
        
        const saveBtn = modal.querySelector('#save-observation-btn');
        const form = modal.querySelector('#observation-form');
        saveBtn.addEventListener('click', () => this.handleSubmit(form, data?.id, modal));
        
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
        });
    },

    async handleSubmit(form, editId = null, modal) {
        // ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØµÙˆØ± Ø¥Ù„Ù‰ Base64
        const images = [];
        for (let i = 1; i <= 2; i++) {
            const input = document.getElementById(`observation-image-${i}`);
            if (input && input.files.length > 0) {
                const file = input.files[0];
                if (file.size > 5 * 1024 * 1024) {
                    Notification.error(`Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© ${i} ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹. Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 5MB`);
                    continue;
                }
                try {
                    const base64 = await this.convertImageToBase64(file);
                    images.push(base64);
                } catch (error) {
                    console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©:', error);
                }
            }
        }

        // Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¥Ø°Ø§ ÙƒØ§Ù† ØªØ¹Ø¯ÙŠÙ„
        if (editId) {
            const existing = AppState.appData.dailyObservations.find(o => o.id === editId);
            if (existing && existing.images) {
                existing.images.forEach(img => {
                    if (!images.includes(img) && img && !img.startsWith('data:')) {
                        images.push(img);
                    }
                });
            }
        }

        const formData = {
            id: editId || Utils.generateId('OBS'),
            isoCode: generateISOCode('OBS', AppState.appData.dailyObservations),
            supervisor: document.getElementById('observation-supervisor').value.trim(),
            date: new Date(document.getElementById('observation-date').value).toISOString(),
            observationType: document.getElementById('observation-type').value,
            status: document.getElementById('observation-status').value,
            description: document.getElementById('observation-description').value.trim(),
            correctiveAction: document.getElementById('observation-corrective').value.trim(),
            images: images.slice(0, 2), // Ø­Ø¯ Ø£Ù‚ØµÙ‰ ØµÙˆØ±ØªØ§Ù†
            createdAt: editId ? AppState.appData.dailyObservations.find(o => o.id === editId)?.createdAt : new Date().toISOString(),
            updatedAt: new Date().toISOString()
        };
        
        Loading.show();
        try {
            if (editId) {
                const index = AppState.appData.dailyObservations.findIndex(o => o.id === editId);
                if (index !== -1) AppState.appData.dailyObservations[index] = formData;
                Notification.success('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© Ø¨Ù†Ø¬Ø§Ø­');
            } else {
                AppState.appData.dailyObservations.push(formData);
                Notification.success('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© Ø¨Ù†Ø¬Ø§Ø­');
            }
            
            DataManager.save();
            
            // Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙÙŠ Google Sheets
            await GoogleIntegration.autoSave('DailyObservations', AppState.appData.dailyObservations);
            
            // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù„Ù„Ø¥ÙŠÙ…ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ø³Ø¬Ù„Ø©
            if (!editId && AppState.notificationEmails && AppState.notificationEmails.length > 0) {
                this.sendEmailNotifications({
                    type: 'Ù…Ù„Ø§Ø­Ø¸Ø© ÙŠÙˆÙ…ÙŠØ©',
                    title: `ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ù…Ù„Ø§Ø­Ø¸Ø© Ø¬Ø¯ÙŠØ¯Ø©: ${formData.observationType}`,
                    message: `Ø§Ù„Ù…Ø´Ø±Ù: ${formData.supervisor}\nØ§Ù„Ù†ÙˆØ¹: ${formData.observationType}\nØ§Ù„ÙˆØµÙ: ${formData.description?.substring(0, 100)}...`,
                    date: Utils.formatDate(formData.date)
                });
            }
            
            Loading.hide();
            modal.remove();
            this.loadObservationsList();
        } catch (error) {
            Loading.hide();
            Notification.error('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
        }
    },

    async viewObservation(id) {
        const observation = AppState.appData.dailyObservations.find(o => o.id === id);
        if (!observation) {
            Notification.error('Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
            return;
        }
        
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 700px;">
                <div class="modal-header">
                    <h2 class="modal-title">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©</h2>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="space-y-3">
                        <div><strong>ÙƒÙˆØ¯ ISO:</strong> ${Utils.escapeHTML(observation.isoCode || '')}</div>
                        <div><strong>Ø§Ù„Ù…Ø´Ø±Ù:</strong> ${Utils.escapeHTML(observation.supervisor || '')}</div>
                        <div><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${Utils.formatDate(observation.date)}</div>
                        <div><strong>Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©:</strong> ${Utils.escapeHTML(observation.observationType || '')}</div>
                        <div><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> <span class="badge badge-${observation.status === 'Ù…Ø­Ù„ÙˆÙ„Ø©' ? 'success' : 'warning'}">${observation.status || ''}</span></div>
                        <div><strong>Ø§Ù„ÙˆØµÙ:</strong><br>${Utils.escapeHTML(observation.description || '')}</div>
                        ${observation.correctiveAction ? `<div><strong>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„ØªØµØ­ÙŠØ­ÙŠ:</strong><br>${Utils.escapeHTML(observation.correctiveAction)}</div>` : ''}
                        ${observation.images && observation.images.length > 0 ? `
                            <div>
                                <strong>Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…Ø±ÙÙ‚Ø©:</strong>
                                <div class="grid grid-cols-2 gap-2 mt-2">
                                    ${observation.images.map((img, idx) => `
                                        <div class="relative">
                                            <img src="${img}" alt="ØµÙˆØ±Ø© ${idx + 1}" class="w-full h-48 object-cover rounded border cursor-pointer hover:opacity-80 transition-opacity" onclick="window.open('${img}', '_blank')">
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="this.closest('.modal-overlay').remove()">Ø¥ØºÙ„Ø§Ù‚</button>
                    <button type="button" onclick="DailyObservations.exportPDF('${observation.id}');" class="btn-secondary">
                        <i class="fas fa-file-pdf ml-2"></i>ØªØµØ¯ÙŠØ± PDF
                    </button>
                    <button type="button" onclick="DailyObservations.showForm(${JSON.stringify(observation).replace(/"/g, '&quot;')}); this.closest('.modal-overlay').remove();" class="btn-primary">ØªØ¹Ø¯ÙŠÙ„</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
        });
    },

    async sendEmailNotifications(notificationData) {
        // ÙÙŠ Ø§Ù„Ø¥Ù†ØªØ§Ø¬ØŒ ÙŠØ¬Ø¨ Ø¥Ø±Ø³Ø§Ù„ Ø¥ÙŠÙ…ÙŠÙ„Ø§Øª ÙØ¹Ù„ÙŠØ©
        // Ù‡Ù†Ø§ Ø³Ù†Ø¹Ø±Ø¶ ÙÙ‚Ø· ÙÙŠ Console ÙˆØ¥Ø´Ø¹Ø§Ø± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
        console.log('Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù„Ø¥ÙŠÙ…ÙŠÙ„Ø§Øª:', AppState.notificationEmails);
        console.log('Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±:', notificationData);
        
        // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© ØªÙƒØ§Ù…Ù„ Ù…Ø¹ Ø®Ø¯Ù…Ø© Ø¥Ø±Ø³Ø§Ù„ Ø¥ÙŠÙ…ÙŠÙ„Ø§Øª Ù‡Ù†Ø§
        // Ù…Ø«Ù„Ø§Ù‹: SendGrid, Mailgun, AWS SES, etc.
        
        if (AppState.notificationEmails && AppState.notificationEmails.length > 0) {
            Notification.success(`ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø¥Ù„Ù‰ ${AppState.notificationEmails.length} Ø¥ÙŠÙ…ÙŠÙ„`);
        }
    },

    async exportPDF(id) {
        const observation = AppState.appData.dailyObservations.find(o => o.id === id);
        if (!observation) {
            Notification.error('Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
            return;
        }

        try {
            Loading.show();
            
            const companyLogo = (typeof AppState !== 'undefined' && AppState.companyLogo) ? AppState.companyLogo : '';
            const qrCodeData = `${window.location.origin}/observation/${observation.id}`;
            const qrCode = typeof QRCode !== 'undefined' ? QRCode.generate(qrCodeData, 120) : null;
            const formCode = observation.isoCode || observation.id?.substring(0, 12) || 'OBS-UNKNOWN';
            
            const htmlContent = `
                <!DOCTYPE html>
                <html dir="rtl" lang="ar">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
                    <style>
                        @media print {
                            @page { margin: 1cm; size: A4; }
                            body { margin: 0; padding: 20px; }
                        }
                        body { 
                            font-family: 'Cairo', Arial, sans-serif; 
                            padding: 20px; 
                            direction: rtl; 
                            margin: 0;
                            background: white;
                        }
                        .header { 
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            border-bottom: 3px solid #2563eb; 
                            padding-bottom: 15px; 
                            margin-bottom: 30px;
                        }
                        .header-left {
                            flex: 1;
                            text-align: right;
                        }
                        .header-right {
                            flex: 1;
                            text-align: left;
                        }
                        .header-center {
                            flex: 1;
                            text-align: center;
                        }
                        .logo {
                            max-height: 60px;
                            max-width: 150px;
                        }
                        h1 { 
                            margin: 0; 
                            color: #2563eb; 
                            font-size: 28px;
                        }
                        .form-code {
                            font-size: 12px;
                            color: #666;
                            margin-top: 5px;
                        }
                        .qr-code {
                            width: 120px;
                            height: 120px;
                            border: 1px solid #ddd;
                            padding: 5px;
                        }
                        table { 
                            width: 100%; 
                            border-collapse: collapse; 
                            margin: 20px 0; 
                            font-size: 14px;
                        }
                        th, td { 
                            border: 1px solid #ddd; 
                            padding: 12px; 
                            text-align: right; 
                        }
                        th { 
                            background-color: #2563eb; 
                            color: white; 
                            font-weight: 600;
                        }
                        .description {
                            background: #f3f4f6;
                            padding: 15px;
                            border-radius: 8px;
                            line-height: 1.8;
                            margin: 15px 0;
                        }
                        .images {
                            display: grid;
                            grid-template-columns: repeat(2, 1fr);
                            gap: 10px;
                            margin: 15px 0;
                        }
                        .images img {
                            max-width: 100%;
                            height: auto;
                            border: 1px solid #ddd;
                            border-radius: 8px;
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <div class="header-left">
                            ${companyLogo ? `<img src="${companyLogo}" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ø´Ø±ÙƒØ©" class="logo">` : ''}
                        </div>
                        <div class="header-center">
                            <h1>ØªÙ‚Ø±ÙŠØ± Ù…Ù„Ø§Ø­Ø¸Ø© ÙŠÙˆÙ…ÙŠØ©</h1>
                            <div class="form-code">ÙƒÙˆØ¯ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬: <strong>${formCode}</strong></div>
                        </div>
                        <div class="header-right">
                            ${qrCode ? `<img src="${qrCode}" alt="QR Code" class="qr-code">` : ''}
                        </div>
                    </div>
                    
                    <table>
                        <tr><th>ÙƒÙˆØ¯ ISO</th><td>${Utils.escapeHTML(observation.isoCode || '')}</td></tr>
                        <tr><th>Ø§Ù„Ù…Ø´Ø±Ù</th><td>${Utils.escapeHTML(observation.supervisor || '')}</td></tr>
                        <tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><td>${observation.date ? Utils.formatDate(observation.date) : '-'}</td></tr>
                        <tr><th>Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©</th><td>${Utils.escapeHTML(observation.observationType || '')}</td></tr>
                        <tr><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><td>${Utils.escapeHTML(observation.status || '')}</td></tr>
                    </table>
                    
                    <div class="section-title">Ø§Ù„ÙˆØµÙ:</div>
                    <div class="description">${Utils.escapeHTML(observation.description || '')}</div>
                    
                    ${observation.correctiveAction ? `
                        <div class="section-title">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„ØªØµØ­ÙŠØ­ÙŠ:</div>
                        <div class="description">${Utils.escapeHTML(observation.correctiveAction)}</div>
                    ` : ''}
                    
                    ${observation.images && observation.images.length > 0 ? `
                        <div class="section-title">Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…Ø±ÙÙ‚Ø©:</div>
                        <div class="images">
                            ${observation.images.map(img => `<img src="${img}" alt="ØµÙˆØ±Ø©">`).join('')}
                        </div>
                    ` : ''}
                </body>
                </html>
            `;

            const printWindow = window.open('', '_blank');
            if (printWindow) {
                printWindow.document.write(htmlContent);
                printWindow.document.close();
                printWindow.onload = () => {
                    setTimeout(() => printWindow.print(), 500);
                };
            }
            
            Loading.hide();
        } catch (error) {
            Loading.hide();
            Notification.error('ÙØ´Ù„ ØªØµØ¯ÙŠØ± PDF: ' + error.message);
        }
    },

    async convertImageToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }
};

// ===== HSE Management System Module (Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³Ù„Ø§Ù…Ø© ÙˆØ§Ù„ØµØ­Ø© Ø§Ù„Ù…Ù‡Ù†ÙŠØ© ÙˆØ§Ù„Ø¨ÙŠØ¦Ø©) =====
const ISO = {
    currentTab: 'overview',
    
    async load() {
        const section = document.getElementById('iso-section');
        if (!section) return;

        section.innerHTML = `
            <div class="section-header">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="section-title">
                            <i class="fas fa-shield-alt ml-3"></i>
                            Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³Ù„Ø§Ù…Ø© ÙˆØ§Ù„ØµØ­Ø© Ø§Ù„Ù…Ù‡Ù†ÙŠØ© ÙˆØ§Ù„Ø¨ÙŠØ¦Ø©
                        </h1>
                        <p class="section-subtitle">HSE Management System - Ù…ØªÙˆØ§ÙÙ‚ Ù…Ø¹ ISO 45001 & ISO 14001</p>
                    </div>
                    <button id="export-compliance-report-btn" class="btn-success">
                        <i class="fas fa-file-pdf ml-2"></i>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø§Ù…ØªØ«Ø§Ù„ PDF
                    </button>
                </div>
            </div>
            
            <div class="mt-6 grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-center">
                    <div class="text-3xl font-bold text-blue-600 mb-2">${(AppState.appData.isoDocuments || []).length}</div>
                    <div class="text-sm text-gray-700 font-semibold">Ø§Ù„ÙˆØ«Ø§Ø¦Ù‚</div>
                </div>
                <div class="bg-green-50 border border-green-200 rounded-lg p-4 text-center">
                    <div class="text-3xl font-bold text-green-600 mb-2">${(AppState.appData.isoProcedures || []).length}</div>
                    <div class="text-sm text-gray-700 font-semibold">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</div>
                </div>
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 text-center">
                    <div class="text-3xl font-bold text-yellow-600 mb-2">${(AppState.appData.isoForms || []).length}</div>
                    <div class="text-sm text-gray-700 font-semibold">Ø§Ù„Ù†Ù…Ø§Ø°Ø¬</div>
                </div>
                <div class="bg-purple-50 border border-purple-200 rounded-lg p-4 text-center">
                    <div class="text-3xl font-bold text-purple-600 mb-2">${this.calculateComplianceRate()}%</div>
                    <div class="text-sm text-gray-700 font-semibold">Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø§Ù…ØªØ«Ø§Ù„</div>
                </div>
            </div>
            
            <div class="mt-6">
                <div class="flex gap-2 mb-6 border-b">
                    <button class="tab-btn ${this.currentTab === 'overview' ? 'active' : ''}" data-tab="overview">
                        <i class="fas fa-chart-pie ml-2"></i>Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©
                    </button>
                    <button class="tab-btn ${this.currentTab === 'documents' ? 'active' : ''}" data-tab="documents">
                        <i class="fas fa-file-alt ml-2"></i>Ø§Ù„ÙˆØ«Ø§Ø¦Ù‚
                    </button>
                    <button class="tab-btn ${this.currentTab === 'procedures' ? 'active' : ''}" data-tab="procedures">
                        <i class="fas fa-tasks ml-2"></i>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª
                    </button>
                    <button class="tab-btn ${this.currentTab === 'forms' ? 'active' : ''}" data-tab="forms">
                        <i class="fas fa-file-signature ml-2"></i>Ø§Ù„Ù†Ù…Ø§Ø°Ø¬
                    </button>
                    <button class="tab-btn ${this.currentTab === 'iso45001' ? 'active' : ''}" data-tab="iso45001">
                        <i class="fas fa-hard-hat ml-2"></i>ISO 45001
                    </button>
                    <button class="tab-btn ${this.currentTab === 'iso14001' ? 'active' : ''}" data-tab="iso14001">
                        <i class="fas fa-leaf ml-2"></i>ISO 14001
                    </button>
                    <button class="tab-btn ${this.currentTab === 'audit' ? 'active' : ''}" data-tab="audit">
                        <i class="fas fa-clipboard-check ml-2"></i>Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚ ÙˆØ§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©
                    </button>
                </div>
                <div id="iso-content">
                    ${await this.renderContent()}
                </div>
            </div>
        `;
        this.setupEventListeners();
    },
    
    calculateComplianceRate() {
        const documents = AppState.appData.isoDocuments || [];
        const procedures = AppState.appData.isoProcedures || [];
        const forms = AppState.appData.isoForms || [];
        const total = documents.length + procedures.length + forms.length;
        // Ø­Ø³Ø§Ø¨ Ù†Ø³Ø¨Ø© Ø§Ù„Ø§Ù…ØªØ«Ø§Ù„ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ ÙˆØ¬ÙˆØ¯ ÙˆØ«Ø§Ø¦Ù‚ ÙˆØ¥Ø¬Ø±Ø§Ø¡Ø§Øª ÙˆÙ†Ù…Ø§Ø°Ø¬
        const complianceScore = documents.length > 0 ? 30 : 0;
        const proceduresScore = procedures.length > 0 ? 30 : 0;
        const formsScore = forms.length > 0 ? 40 : 0;
        return Math.min(100, complianceScore + proceduresScore + formsScore);
    },

    async renderContent() {
        switch(this.currentTab) {
            case 'overview':
                return await this.renderOverview();
            case 'documents':
                return await this.renderDocuments();
            case 'procedures':
                return await this.renderProcedures();
            case 'forms':
                return await this.renderForms();
            case 'iso45001':
                return await this.renderISO45001();
            case 'iso14001':
                return await this.renderISO14001();
            case 'audit':
                return await this.renderAudit();
            default:
                return await this.renderOverview();
        }
    },
    
    async renderOverview() {
        const documents = AppState.appData.isoDocuments || [];
        const procedures = AppState.appData.isoProcedures || [];
        const forms = AppState.appData.isoForms || [];
        const audits = AppState.appData.hseAudits || [];
        const nonConformities = AppState.appData.hseNonConformities || [];
        const actions = AppState.appData.hseCorrectiveActions || [];
        
        return `
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="content-card">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-info-circle ml-2"></i>Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø¸Ø§Ù…</h2>
                    </div>
                    <div class="card-body">
                        <div class="space-y-4">
                            <div class="bg-blue-50 border border-blue-200 rounded p-4">
                                <h3 class="font-semibold text-blue-800 mb-3">
                                    <i class="fas fa-hard-hat ml-2"></i>
                                    ISO 45001 - Ø§Ù„Ø³Ù„Ø§Ù…Ø© ÙˆØ§Ù„ØµØ­Ø© Ø§Ù„Ù…Ù‡Ù†ÙŠØ©
                                </h3>
                                <ul class="list-disc list-inside text-sm text-gray-700 space-y-2">
                                    <li>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø§Ø·Ø± ÙˆØ§Ù„ÙØ±Øµ</li>
                                    <li>Ø§Ù„ØªØ®Ø·ÙŠØ· ÙˆØ§Ù„ØªØ­ÙƒÙ… Ø§Ù„ØªØ´ØºÙŠÙ„ÙŠ</li>
                                    <li>Ø§Ù„Ù‚ÙŠØ§Ø³ ÙˆØ§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©</li>
                                    <li>Ø§Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù…Ø³ØªÙ…Ø±</li>
                                </ul>
                            </div>
                            <div class="bg-green-50 border border-green-200 rounded p-4">
                                <h3 class="font-semibold text-green-800 mb-3">
                                    <i class="fas fa-leaf ml-2"></i>
                                    ISO 14001 - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ¦Ø©
                                </h3>
                                <ul class="list-disc list-inside text-sm text-gray-700 space-y-2">
                                    <li>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬ÙˆØ§Ù†Ø¨ Ø§Ù„Ø¨ÙŠØ¦ÙŠØ©</li>
                                    <li>Ø§Ù„Ø§Ù…ØªØ«Ø§Ù„ Ù„Ù„Ù‚ÙˆØ§Ù†ÙŠÙ† Ø§Ù„Ø¨ÙŠØ¦ÙŠØ©</li>
                                    <li>Ø§Ù„ØªØ®Ø·ÙŠØ· Ø§Ù„Ø¨ÙŠØ¦ÙŠ</li>
                                    <li>ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø¨ÙŠØ¦ÙŠ</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="content-card">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-chart-bar ml-2"></i>Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</h2>
                    </div>
                    <div class="card-body">
                        <div class="space-y-4">
                            <div class="flex items-center justify-between p-3 border rounded">
                                <span class="font-semibold">Ø§Ù„ÙˆØ«Ø§Ø¦Ù‚</span>
                                <span class="badge badge-info">${documents.length}</span>
                            </div>
                            <div class="flex items-center justify-between p-3 border rounded">
                                <span class="font-semibold">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</span>
                                <span class="badge badge-success">${procedures.length}</span>
                            </div>
                            <div class="flex items-center justify-between p-3 border rounded">
                                <span class="font-semibold">Ø§Ù„Ù†Ù…Ø§Ø°Ø¬</span>
                                <span class="badge badge-warning">${forms.length}</span>
                            </div>
                            <div class="flex items-center justify-between p-3 border rounded">
                                <span class="font-semibold">Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚</span>
                                <span class="badge badge-primary">${audits.length}</span>
                            </div>
                            <div class="flex items-center justify-between p-3 border rounded">
                                <span class="font-semibold">Ø¹Ø¯Ù… Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©</span>
                                <span class="badge badge-danger">${nonConformities.length}</span>
                            </div>
                            <div class="flex items-center justify-between p-3 border rounded">
                                <span class="font-semibold">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„ØªØµØ­ÙŠØ­ÙŠØ©</span>
                                <span class="badge badge-info">${actions.length}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    },

    async renderDocuments() {
        const documents = AppState.appData.isoDocuments || [];
        return `
            <div class="content-card">
                <div class="card-header">
                    <div class="flex items-center justify-between">
                        <h2 class="card-title"><i class="fas fa-file-alt ml-2"></i>Ø§Ù„ÙˆØ«Ø§Ø¦Ù‚</h2>
                        <button id="add-document-btn" class="btn-primary">
                            <i class="fas fa-plus ml-2"></i>Ø¥Ø¶Ø§ÙØ© ÙˆØ«ÙŠÙ‚Ø©
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    ${documents.length === 0 ? '<div class="empty-state"><p class="text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ«Ø§Ø¦Ù‚</p></div>' : `
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>ÙƒÙˆØ¯ ISO</th>
                                    <th>Ø§Ø³Ù… Ø§Ù„ÙˆØ«ÙŠÙ‚Ø©</th>
                                    <th>Ø§Ù„Ù†ÙˆØ¹</th>
                                    <th>Ø§Ù„Ø¥ØµØ¯Ø§Ø±</th>
                                    <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${documents.map(d => `
                                    <tr>
                                        <td>${Utils.escapeHTML(d.isoCode || '')}</td>
                                        <td>${Utils.escapeHTML(d.name || '')}</td>
                                        <td>${Utils.escapeHTML(d.type || '')}</td>
                                        <td>${d.version || '-'}</td>
                                        <td>
                                            <button onclick="ISO.viewDocument('${d.id}')" class="btn-icon btn-icon-primary">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `}
                </div>
            </div>
        `;
    },

    async renderProcedures() {
        const procedures = AppState.appData.isoProcedures || [];
        return `
            <div class="content-card">
                <div class="card-header">
                    <div class="flex items-center justify-between">
                        <h2 class="card-title"><i class="fas fa-tasks ml-2"></i>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</h2>
                        <button id="add-procedure-btn" class="btn-primary">
                            <i class="fas fa-plus ml-2"></i>Ø¥Ø¶Ø§ÙØ© Ø¥Ø¬Ø±Ø§Ø¡
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    ${procedures.length === 0 ? '<div class="empty-state"><p class="text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</p></div>' : `
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>ÙƒÙˆØ¯ ISO</th>
                                    <th>Ø§Ø³Ù… Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th>
                                    <th>Ø§Ù„Ù‚Ø³Ù…</th>
                                    <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${procedures.map(p => `
                                    <tr>
                                        <td>${Utils.escapeHTML(p.isoCode || '')}</td>
                                        <td>${Utils.escapeHTML(p.name || '')}</td>
                                        <td>${Utils.escapeHTML(p.department || '')}</td>
                                        <td>
                                            <button onclick="ISO.viewProcedure('${p.id}')" class="btn-icon btn-icon-primary">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `}
                </div>
            </div>
        `;
    },

    async renderForms() {
        const forms = AppState.appData.isoForms || [];
        return `
            <div class="content-card">
                <div class="card-header">
                    <div class="flex items-center justify-between">
                        <h2 class="card-title"><i class="fas fa-file-signature ml-2"></i>Ø§Ù„Ù†Ù…Ø§Ø°Ø¬</h2>
                        <button id="add-form-btn" class="btn-primary">
                            <i class="fas fa-plus ml-2"></i>Ø¥Ø¶Ø§ÙØ© Ù†Ù…ÙˆØ°Ø¬
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    ${forms.length === 0 ? '<div class="empty-state"><p class="text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ù…Ø§Ø°Ø¬</p></div>' : `
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>ÙƒÙˆØ¯ ISO</th>
                                    <th>Ø§Ø³Ù… Ø§Ù„Ù†Ù…ÙˆØ°Ø¬</th>
                                    <th>Ø§Ù„Ù†ÙˆØ¹</th>
                                    <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${forms.map(f => `
                                    <tr>
                                        <td>${Utils.escapeHTML(f.isoCode || '')}</td>
                                        <td>${Utils.escapeHTML(f.name || '')}</td>
                                        <td>${Utils.escapeHTML(f.type || '')}</td>
                                        <td>
                                            <button onclick="ISO.viewForm('${f.id}')" class="btn-icon btn-icon-primary">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `}
                </div>
            </div>
        `;
    },

    setupEventListeners() {
        setTimeout(() => {
            const tabs = document.querySelectorAll('.tab-btn');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    this.currentTab = tab.getAttribute('data-tab');
                    this.load();
                });
            });

            const addDocumentBtn = document.getElementById('add-document-btn');
            const addProcedureBtn = document.getElementById('add-procedure-btn');
            const addFormBtn = document.getElementById('add-form-btn');
            
            if (addDocumentBtn) addDocumentBtn.addEventListener('click', () => this.showDocumentForm());
            if (addProcedureBtn) addProcedureBtn.addEventListener('click', () => this.showProcedureForm());
            if (addFormBtn) addFormBtn.addEventListener('click', () => this.showFormForm());
        }, 100);
    },

    async showDocumentForm(data = null) {
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h2 class="modal-title">${data ? 'ØªØ¹Ø¯ÙŠÙ„ ÙˆØ«ÙŠÙ‚Ø©' : 'Ø¥Ø¶Ø§ÙØ© ÙˆØ«ÙŠÙ‚Ø© Ø¬Ø¯ÙŠØ¯Ø©'}</h2>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="iso-document-form" class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ø³Ù… Ø§Ù„ÙˆØ«ÙŠÙ‚Ø© *</label>
                            <input type="text" id="document-name" required class="form-input" 
                                value="${Utils.escapeHTML(data?.name || '')}" placeholder="Ø§Ø³Ù… Ø§Ù„ÙˆØ«ÙŠÙ‚Ø©">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„Ù†ÙˆØ¹ *</label>
                            <select id="document-type" required class="form-input">
                                <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù†ÙˆØ¹</option>
                                <option value="Ø³ÙŠØ§Ø³Ø©" ${data?.type === 'Ø³ÙŠØ§Ø³Ø©' ? 'selected' : ''}>Ø³ÙŠØ§Ø³Ø©</option>
                                <option value="Ø¥Ø¬Ø±Ø§Ø¡" ${data?.type === 'Ø¥Ø¬Ø±Ø§Ø¡' ? 'selected' : ''}>Ø¥Ø¬Ø±Ø§Ø¡</option>
                                <option value="ØªØ¹Ù„ÙŠÙ…Ø§Øª" ${data?.type === 'ØªØ¹Ù„ÙŠÙ…Ø§Øª' ? 'selected' : ''}>ØªØ¹Ù„ÙŠÙ…Ø§Øª</option>
                                <option value="Ø¯Ù„ÙŠÙ„" ${data?.type === 'Ø¯Ù„ÙŠÙ„' ? 'selected' : ''}>Ø¯Ù„ÙŠÙ„</option>
                                <option value="Ø£Ø®Ø±Ù‰" ${data?.type === 'Ø£Ø®Ø±Ù‰' ? 'selected' : ''}>Ø£Ø®Ø±Ù‰</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„Ø¥ØµØ¯Ø§Ø± *</label>
                            <input type="text" id="document-version" required class="form-input" 
                                value="${Utils.escapeHTML(data?.version || '1.0')}" placeholder="Ù…Ø«Ø§Ù„: 1.0">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„Ù‚Ø³Ù… *</label>
                            <input type="text" id="document-department" required class="form-input" 
                                value="${Utils.escapeHTML(data?.department || '')}" placeholder="Ø§Ù„Ù‚Ø³Ù…">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="this.closest('.modal-overlay').remove()">Ø¥Ù„ØºØ§Ø¡</button>
                    <button type="button" id="save-document-btn" class="btn-primary">Ø­ÙØ¸</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        
        const saveBtn = modal.querySelector('#save-document-btn');
        saveBtn.addEventListener('click', () => this.handleDocumentSubmit(data?.id, modal));
        
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
        });
    },

    async handleDocumentSubmit(editId = null, modal) {
        const formData = {
            id: editId || Utils.generateId('ISO_DOC'),
            isoCode: generateISOCode('DOC', AppState.appData.isoDocuments),
            name: document.getElementById('document-name').value.trim(),
            type: document.getElementById('document-type').value,
            version: document.getElementById('document-version').value.trim(),
            department: document.getElementById('document-department').value.trim(),
            createdAt: editId ? AppState.appData.isoDocuments.find(d => d.id === editId)?.createdAt : new Date().toISOString(),
            updatedAt: new Date().toISOString()
        };
        
        Loading.show();
        try {
            if (editId) {
                const index = AppState.appData.isoDocuments.findIndex(d => d.id === editId);
                if (index !== -1) AppState.appData.isoDocuments[index] = formData;
                Notification.success('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ«ÙŠÙ‚Ø© Ø¨Ù†Ø¬Ø§Ø­');
            } else {
                AppState.appData.isoDocuments.push(formData);
                Notification.success('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙˆØ«ÙŠÙ‚Ø© Ø¨Ù†Ø¬Ø§Ø­');
            }
            
            DataManager.save();
            
            // Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙÙŠ Google Sheets
            await GoogleIntegration.autoSave('ISODocuments', AppState.appData.isoDocuments);
            
            Loading.hide();
            modal.remove();
            this.load();
        } catch (error) {
            Loading.hide();
            Notification.error('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
        }
    },

    async showProcedureForm(data = null) {
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h2 class="modal-title">${data ? 'ØªØ¹Ø¯ÙŠÙ„ Ø¥Ø¬Ø±Ø§Ø¡' : 'Ø¥Ø¶Ø§ÙØ© Ø¥Ø¬Ø±Ø§Ø¡ Ø¬Ø¯ÙŠØ¯'}</h2>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="iso-procedure-form" class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ø³Ù… Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ *</label>
                            <input type="text" id="procedure-name" required class="form-input" 
                                value="${Utils.escapeHTML(data?.name || '')}" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„Ù‚Ø³Ù… *</label>
                            <input type="text" id="procedure-department" required class="form-input" 
                                value="${Utils.escapeHTML(data?.department || '')}" placeholder="Ø§Ù„Ù‚Ø³Ù…">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„Ø¥ØµØ¯Ø§Ø± *</label>
                            <input type="text" id="procedure-version" required class="form-input" 
                                value="${Utils.escapeHTML(data?.version || '1.0')}" placeholder="Ù…Ø«Ø§Ù„: 1.0">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="this.closest('.modal-overlay').remove()">Ø¥Ù„ØºØ§Ø¡</button>
                    <button type="button" id="save-procedure-btn" class="btn-primary">Ø­ÙØ¸</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        
        const saveBtn = modal.querySelector('#save-procedure-btn');
        saveBtn.addEventListener('click', () => this.handleProcedureSubmit(data?.id, modal));
        
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
        });
    },

    async handleProcedureSubmit(editId = null, modal) {
        const formData = {
            id: editId || Utils.generateId('ISO_PROC'),
            isoCode: generateISOCode('PROC', AppState.appData.isoProcedures),
            name: document.getElementById('procedure-name').value.trim(),
            department: document.getElementById('procedure-department').value.trim(),
            version: document.getElementById('procedure-version').value.trim(),
            createdAt: editId ? AppState.appData.isoProcedures.find(p => p.id === editId)?.createdAt : new Date().toISOString(),
            updatedAt: new Date().toISOString()
        };
        
        Loading.show();
        try {
            if (editId) {
                const index = AppState.appData.isoProcedures.findIndex(p => p.id === editId);
                if (index !== -1) AppState.appData.isoProcedures[index] = formData;
                Notification.success('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø¨Ù†Ø¬Ø§Ø­');
            } else {
                AppState.appData.isoProcedures.push(formData);
                Notification.success('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø¨Ù†Ø¬Ø§Ø­');
            }
            
            DataManager.save();
            
            // Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙÙŠ Google Sheets
            await GoogleIntegration.autoSave('ISOProcedures', AppState.appData.isoProcedures);
            
            Loading.hide();
            modal.remove();
            this.load();
        } catch (error) {
            Loading.hide();
            Notification.error('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
        }
    },

    async showFormForm(data = null) {
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h2 class="modal-title">${data ? 'ØªØ¹Ø¯ÙŠÙ„ Ù†Ù…ÙˆØ°Ø¬' : 'Ø¥Ø¶Ø§ÙØ© Ù†Ù…ÙˆØ°Ø¬ Ø¬Ø¯ÙŠØ¯'}</h2>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="iso-form-form" class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ø³Ù… Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ *</label>
                            <input type="text" id="form-name" required class="form-input" 
                                value="${Utils.escapeHTML(data?.name || '')}" placeholder="Ø§Ø³Ù… Ø§Ù„Ù†Ù…ÙˆØ°Ø¬">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„Ù†ÙˆØ¹ *</label>
                            <select id="form-type" required class="form-input">
                                <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù†ÙˆØ¹</option>
                                <option value="ØªØ³Ø¬ÙŠÙ„" ${data?.type === 'ØªØ³Ø¬ÙŠÙ„' ? 'selected' : ''}>ØªØ³Ø¬ÙŠÙ„</option>
                                <option value="ØªÙ‚Ø±ÙŠØ±" ${data?.type === 'ØªÙ‚Ø±ÙŠØ±' ? 'selected' : ''}>ØªÙ‚Ø±ÙŠØ±</option>
                                <option value="ÙØ­Øµ" ${data?.type === 'ÙØ­Øµ' ? 'selected' : ''}>ÙØ­Øµ</option>
                                <option value="ØªØ¯Ø±ÙŠØ¨" ${data?.type === 'ØªØ¯Ø±ÙŠØ¨' ? 'selected' : ''}>ØªØ¯Ø±ÙŠØ¨</option>
                                <option value="Ø£Ø®Ø±Ù‰" ${data?.type === 'Ø£Ø®Ø±Ù‰' ? 'selected' : ''}>Ø£Ø®Ø±Ù‰</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="this.closest('.modal-overlay').remove()">Ø¥Ù„ØºØ§Ø¡</button>
                    <button type="button" id="save-form-btn" class="btn-primary">Ø­ÙØ¸</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        
        const saveBtn = modal.querySelector('#save-form-btn');
        saveBtn.addEventListener('click', () => this.handleFormSubmit(data?.id, modal));
        
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
        });
    },

    async handleFormSubmit(editId = null, modal) {
        const formData = {
            id: editId || Utils.generateId('ISO_FORM'),
            isoCode: generateISOCode('FORM', AppState.appData.isoForms),
            name: document.getElementById('form-name').value.trim(),
            type: document.getElementById('form-type').value,
            createdAt: editId ? AppState.appData.isoForms.find(f => f.id === editId)?.createdAt : new Date().toISOString(),
            updatedAt: new Date().toISOString()
        };
        
        Loading.show();
        try {
            if (editId) {
                const index = AppState.appData.isoForms.findIndex(f => f.id === editId);
                if (index !== -1) AppState.appData.isoForms[index] = formData;
                Notification.success('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø¨Ù†Ø¬Ø§Ø­');
            } else {
                AppState.appData.isoForms.push(formData);
                Notification.success('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø¨Ù†Ø¬Ø§Ø­');
            }
            
            DataManager.save();
            
            // Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙÙŠ Google Sheets
            await GoogleIntegration.autoSave('ISOForms', AppState.appData.isoForms);
            
            Loading.hide();
            modal.remove();
            this.load();
        } catch (error) {
            Loading.hide();
            Notification.error('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
        }
    },

    async viewDocument(id) {
        const document = AppState.appData.isoDocuments.find(d => d.id === id);
        if (!document) {
            Notification.error('Ø§Ù„ÙˆØ«ÙŠÙ‚Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
            return;
        }
        
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h2 class="modal-title">ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙˆØ«ÙŠÙ‚Ø©</h2>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="space-y-3">
                        <div><strong>ÙƒÙˆØ¯ ISO:</strong> ${Utils.escapeHTML(document.isoCode || '')}</div>
                        <div><strong>Ø§Ø³Ù… Ø§Ù„ÙˆØ«ÙŠÙ‚Ø©:</strong> ${Utils.escapeHTML(document.name || '')}</div>
                        <div><strong>Ø§Ù„Ù†ÙˆØ¹:</strong> ${Utils.escapeHTML(document.type || '')}</div>
                        <div><strong>Ø§Ù„Ø¥ØµØ¯Ø§Ø±:</strong> ${Utils.escapeHTML(document.version || '')}</div>
                        <div><strong>Ø§Ù„Ù‚Ø³Ù…:</strong> ${Utils.escapeHTML(document.department || '')}</div>
                        <div><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡:</strong> ${Utils.formatDate(document.createdAt)}</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="this.closest('.modal-overlay').remove()">Ø¥ØºÙ„Ø§Ù‚</button>
                    <button type="button" onclick="ISO.showDocumentForm(${JSON.stringify(document).replace(/"/g, '&quot;')}); this.closest('.modal-overlay').remove();" class="btn-primary">ØªØ¹Ø¯ÙŠÙ„</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
        });
    },

    async viewProcedure(id) {
        const procedure = AppState.appData.isoProcedures.find(p => p.id === id);
        if (!procedure) {
            Notification.error('Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
            return;
        }
        
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h2 class="modal-title">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</h2>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="space-y-3">
                        <div><strong>ÙƒÙˆØ¯ ISO:</strong> ${Utils.escapeHTML(procedure.isoCode || '')}</div>
                        <div><strong>Ø§Ø³Ù… Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡:</strong> ${Utils.escapeHTML(procedure.name || '')}</div>
                        <div><strong>Ø§Ù„Ù‚Ø³Ù…:</strong> ${Utils.escapeHTML(procedure.department || '')}</div>
                        <div><strong>Ø§Ù„Ø¥ØµØ¯Ø§Ø±:</strong> ${Utils.escapeHTML(procedure.version || '')}</div>
                        <div><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡:</strong> ${Utils.formatDate(procedure.createdAt)}</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="this.closest('.modal-overlay').remove()">Ø¥ØºÙ„Ø§Ù‚</button>
                    <button type="button" onclick="ISO.showProcedureForm(${JSON.stringify(procedure).replace(/"/g, '&quot;')}); this.closest('.modal-overlay').remove();" class="btn-primary">ØªØ¹Ø¯ÙŠÙ„</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
        });
    },

    async viewForm(id) {
        const form = AppState.appData.isoForms.find(f => f.id === id);
        if (!form) {
            Notification.error('Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
            return;
        }
        
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h2 class="modal-title">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬</h2>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="space-y-3">
                        <div><strong>ÙƒÙˆØ¯ ISO:</strong> ${Utils.escapeHTML(form.isoCode || '')}</div>
                        <div><strong>Ø§Ø³Ù… Ø§Ù„Ù†Ù…ÙˆØ°Ø¬:</strong> ${Utils.escapeHTML(form.name || '')}</div>
                        <div><strong>Ø§Ù„Ù†ÙˆØ¹:</strong> ${Utils.escapeHTML(form.type || '')}</div>
                        <div><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡:</strong> ${Utils.formatDate(form.createdAt)}</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="this.closest('.modal-overlay').remove()">Ø¥ØºÙ„Ø§Ù‚</button>
                    <button type="button" onclick="ISO.showFormForm(${JSON.stringify(form).replace(/"/g, '&quot;')}); this.closest('.modal-overlay').remove();" class="btn-primary">ØªØ¹Ø¯ÙŠÙ„</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
        });
    },

    async renderISO45001() {
        const objectives = AppState.appData.hseObjectives || [];
        const riskAssessments = AppState.appData.hseRiskAssessments || [];
        
        return `
            <div class="content-card">
                <div class="card-header">
                    <h2 class="card-title"><i class="fas fa-hard-hat ml-2"></i>ISO 45001 - Ø§Ù„Ø³Ù„Ø§Ù…Ø© ÙˆØ§Ù„ØµØ­Ø© Ø§Ù„Ù…Ù‡Ù†ÙŠØ©</h2>
                </div>
                <div class="card-body">
                    <div class="space-y-4">
                        <p class="text-gray-700">
                            ÙŠØ±ÙƒØ² Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… Ø¹Ù„Ù‰ Ù…ØªØ·Ù„Ø¨Ø§Øª Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³Ù„Ø§Ù…Ø© ÙˆØ§Ù„ØµØ­Ø© Ø§Ù„Ù…Ù‡Ù†ÙŠØ© (OH&S) ÙˆÙÙ‚Ù‹Ø§ Ù„Ù…Ø¹ÙŠØ§Ø± ISO 45001.
                            ÙŠÙ‡Ø¯Ù Ø¥Ù„Ù‰ ØªÙ…ÙƒÙŠÙ† Ø§Ù„Ù…Ù†Ø¸Ù…Ø© Ù…Ù† ØªÙˆÙÙŠØ± Ø£Ù…Ø§ÙƒÙ† Ø¹Ù…Ù„ Ø¢Ù…Ù†Ø© ÙˆØµØ­ÙŠØ©ØŒ ÙˆÙ…Ù†Ø¹ Ø§Ù„Ø¥ØµØ§Ø¨Ø§Øª ÙˆØ§Ù„Ø£Ù…Ø±Ø§Ø¶ Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„Ø¹Ù…Ù„ØŒ
                            Ø¨Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù…Ø³ØªÙ…Ø± Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø³Ù„Ø§Ù…Ø© ÙˆØ§Ù„ØµØ­Ø© Ø§Ù„Ù…Ù‡Ù†ÙŠØ©.
                        </p>
                        <h3 class="font-semibold text-lg mt-4 mb-2">Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©:</h3>
                        <ul class="list-disc list-inside text-gray-700 space-y-2">
                            <li>Ø§Ù„Ø³ÙŠØ§Ù‚ Ø§Ù„ØªÙ†Ø¸ÙŠÙ…ÙŠ</li>
                            <li>Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© ÙˆÙ…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø¹Ø§Ù…Ù„ÙŠÙ†</li>
                            <li>Ø§Ù„ØªØ®Ø·ÙŠØ· (ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø®Ø§Ø·Ø± ÙˆØ§Ù„ÙØ±ØµØŒ Ø§Ù„Ø£Ù‡Ø¯Ø§Ù)</li>
                            <li>Ø§Ù„Ø¯Ø¹Ù… (Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ØŒ Ø§Ù„ÙƒÙØ§Ø¡Ø©ØŒ Ø§Ù„ÙˆØ¹ÙŠØŒ Ø§Ù„Ø§ØªØµØ§Ù„ØŒ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ÙˆØ«Ù‚Ø©)</li>
                            <li>Ø§Ù„ØªØ´ØºÙŠÙ„ (Ø§Ù„ØªØ®Ø·ÙŠØ· ÙˆØ§Ù„ØªØ­ÙƒÙ… Ø§Ù„ØªØ´ØºÙŠÙ„ÙŠØŒ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØºÙŠÙŠØ±ØŒ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§ØªØŒ Ø§Ù„Ù…Ù‚Ø§ÙˆÙ„ÙˆÙ†ØŒ Ø§Ù„Ø§Ø³ØªØ¹Ø¯Ø§Ø¯ Ù„Ù„Ø·ÙˆØ§Ø±Ø¦)</li>
                            <li>ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø£Ø¯Ø§Ø¡ (Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© ÙˆØ§Ù„Ù‚ÙŠØ§Ø³ØŒ ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø§Ù…ØªØ«Ø§Ù„ØŒ Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØŒ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©)</li>
                            <li>Ø§Ù„ØªØ­Ø³ÙŠÙ† (Ø¹Ø¯Ù… Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© ÙˆØ§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„ØªØµØ­ÙŠØ­ÙŠØ©ØŒ Ø§Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù…Ø³ØªÙ…Ø±)</li>
                        </ul>
                        <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-blue-50 border border-blue-200 rounded p-4">
                                <h4 class="font-semibold text-blue-800 mb-2">Ø§Ù„Ø£Ù‡Ø¯Ø§Ù (${objectives.length})</h4>
                                <p class="text-sm text-gray-700 mb-3">Ø¥Ø¯Ø§Ø±Ø© Ø£Ù‡Ø¯Ø§Ù Ø§Ù„Ø³Ù„Ø§Ù…Ø© ÙˆØ§Ù„ØµØ­Ø© Ø§Ù„Ù…Ù‡Ù†ÙŠØ©</p>
                                <button class="btn-secondary w-full" onclick="ISO.showHSEObjectiveForm()">
                                    <i class="fas fa-bullseye ml-2"></i>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ù‡Ø¯Ø§Ù
                                </button>
                            </div>
                            <div class="bg-green-50 border border-green-200 rounded p-4">
                                <h4 class="font-semibold text-green-800 mb-2">ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø§Ù„Ù…Ø®Ø§Ø·Ø± (${riskAssessments.length})</h4>
                                <p class="text-sm text-gray-700 mb-3">ØªÙ‚ÙŠÙŠÙ… Ù…Ø®Ø§Ø·Ø± Ø§Ù„Ø³Ù„Ø§Ù…Ø© ÙˆØ§Ù„ØµØ­Ø© Ø§Ù„Ù…Ù‡Ù†ÙŠØ©</p>
                                <button class="btn-secondary w-full" onclick="ISO.showHSERiskAssessmentForm()">
                                    <i class="fas fa-shield-alt ml-2"></i>ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…Ø®Ø§Ø·Ø±
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    },

    async renderISO14001() {
        const aspects = AppState.appData.environmentalAspects || [];
        const monitoring = AppState.appData.environmentalMonitoring || [];
        
        return `
            <div class="content-card">
                <div class="card-header">
                    <h2 class="card-title"><i class="fas fa-leaf ml-2"></i>ISO 14001 - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ¦Ø©</h2>
                </div>
                <div class="card-body">
                    <div class="space-y-4">
                        <p class="text-gray-700">
                            ÙŠØ­Ø¯Ø¯ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… Ù…ØªØ·Ù„Ø¨Ø§Øª Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ¦Ø© (EMS) ÙˆÙÙ‚Ù‹Ø§ Ù„Ù…Ø¹ÙŠØ§Ø± ISO 14001.
                            ÙŠÙ‡Ø¯Ù Ø¥Ù„Ù‰ Ù…Ø³Ø§Ø¹Ø¯Ø© Ø§Ù„Ù…Ù†Ø¸Ù…Ø§Øª Ø¹Ù„Ù‰ ØªØ­Ø³ÙŠÙ† Ø£Ø¯Ø§Ø¦Ù‡Ø§ Ø§Ù„Ø¨ÙŠØ¦ÙŠ Ù…Ù† Ø®Ù„Ø§Ù„ Ø¥Ø¯Ø§Ø±Ø© Ù…Ø³Ø¤ÙˆÙ„ÙŠØ§ØªÙ‡Ø§ Ø§Ù„Ø¨ÙŠØ¦ÙŠØ©
                            Ø¨Ø·Ø±ÙŠÙ‚Ø© Ù…Ù†Ù‡Ø¬ÙŠØ© ØªØ³Ø§Ù‡Ù… ÙÙŠ Ø±ÙƒÙŠØ²Ø© Ø§Ù„Ø§Ø³ØªØ¯Ø§Ù…Ø©.
                        </p>
                        <h3 class="font-semibold text-lg mt-4 mb-2">Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©:</h3>
                        <ul class="list-disc list-inside text-gray-700 space-y-2">
                            <li>Ø§Ù„Ø³ÙŠØ§Ù‚ Ø§Ù„ØªÙ†Ø¸ÙŠÙ…ÙŠ</li>
                            <li>Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©</li>
                            <li>Ø§Ù„ØªØ®Ø·ÙŠØ· (ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¬ÙˆØ§Ù†Ø¨ Ø§Ù„Ø¨ÙŠØ¦ÙŠØ©ØŒ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„Ø§Ù…ØªØ«Ø§Ù„ÙŠØ©ØŒ Ø§Ù„Ø£Ù‡Ø¯Ø§Ù Ø§Ù„Ø¨ÙŠØ¦ÙŠØ©)</li>
                            <li>Ø§Ù„Ø¯Ø¹Ù… (Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ØŒ Ø§Ù„ÙƒÙØ§Ø¡Ø©ØŒ Ø§Ù„ÙˆØ¹ÙŠØŒ Ø§Ù„Ø§ØªØµØ§Ù„ØŒ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ÙˆØ«Ù‚Ø©)</li>
                            <li>Ø§Ù„ØªØ´ØºÙŠÙ„ (Ø§Ù„ØªØ®Ø·ÙŠØ· ÙˆØ§Ù„ØªØ­ÙƒÙ… Ø§Ù„ØªØ´ØºÙŠÙ„ÙŠØŒ Ø§Ù„Ø§Ø³ØªØ¹Ø¯Ø§Ø¯ Ù„Ù„Ø·ÙˆØ§Ø±Ø¦ ÙˆØ§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ù„Ù‡Ø§)</li>
                            <li>ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø£Ø¯Ø§Ø¡ (Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© ÙˆØ§Ù„Ù‚ÙŠØ§Ø³ØŒ ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø§Ù…ØªØ«Ø§Ù„ØŒ Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØŒ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©)</li>
                            <li>Ø§Ù„ØªØ­Ø³ÙŠÙ† (Ø¹Ø¯Ù… Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© ÙˆØ§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„ØªØµØ­ÙŠØ­ÙŠØ©ØŒ Ø§Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù…Ø³ØªÙ…Ø±)</li>
                        </ul>
                        <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-green-50 border border-green-200 rounded p-4">
                                <h4 class="font-semibold text-green-800 mb-2">Ø§Ù„Ø¬ÙˆØ§Ù†Ø¨ Ø§Ù„Ø¨ÙŠØ¦ÙŠØ© (${aspects.length})</h4>
                                <p class="text-sm text-gray-700 mb-3">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬ÙˆØ§Ù†Ø¨ Ø§Ù„Ø¨ÙŠØ¦ÙŠØ© ÙˆØªØ£Ø«ÙŠØ±Ø§ØªÙ‡Ø§</p>
                                <button class="btn-secondary w-full" onclick="ISO.showEnvironmentalAspectsForm()">
                                    <i class="fas fa-globe ml-2"></i>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬ÙˆØ§Ù†Ø¨ Ø§Ù„Ø¨ÙŠØ¦ÙŠØ©
                                </button>
                            </div>
                            <div class="bg-blue-50 border border-blue-200 rounded p-4">
                                <h4 class="font-semibold text-blue-800 mb-2">Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø¨ÙŠØ¦ÙŠØ© (${monitoring.length})</h4>
                                <p class="text-sm text-gray-700 mb-3">ØªØªØ¨Ø¹ ÙˆÙ…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø¨ÙŠØ¦ÙŠ</p>
                                <button class="btn-secondary w-full" onclick="ISO.showEnvironmentalMonitoringForm()">
                                    <i class="fas fa-chart-line ml-2"></i>Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø¨ÙŠØ¦ÙŠØ©
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    },

    async renderAudit() {
        const audits = AppState.appData.hseAudits || [];
        const nonConformities = AppState.appData.hseNonConformities || [];
        const actions = AppState.appData.hseCorrectiveActions || [];

        return `
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="content-card">
                    <div class="card-header">
                        <div class="flex items-center justify-between">
                            <h2 class="card-title"><i class="fas fa-clipboard-check ml-2"></i>Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚</h2>
                            <button class="btn-primary" onclick="ISO.showAuditForm()">
                                <i class="fas fa-plus ml-2"></i>Ø¥Ø¶Ø§ÙØ© ØªØ¯Ù‚ÙŠÙ‚
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        ${audits.length === 0 ? '<div class="empty-state"><p class="text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª ØªØ¯Ù‚ÙŠÙ‚ Ù…Ø³Ø¬Ù„Ø©</p></div>' : `
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                        <th>Ø§Ù„Ù†ÙˆØ¹</th>
                                        <th>Ø§Ù„Ù…Ø¯Ù‚Ù‚</th>
                                        <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                        <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${audits.map(audit => `
                                        <tr>
                                            <td>${Utils.formatDate(audit.date)}</td>
                                            <td>${Utils.escapeHTML(audit.type)}</td>
                                            <td>${Utils.escapeHTML(audit.auditor)}</td>
                                            <td><span class="badge badge-${audit.status === 'Ù…ÙƒØªÙ…Ù„' ? 'success' : 'warning'}">${audit.status}</span></td>
                                            <td>
                                                <button onclick="ISO.viewAudit('${audit.id}')" class="btn-icon btn-icon-info"><i class="fas fa-eye"></i></button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        `}
                    </div>
                </div>
                
                <div class="content-card">
                    <div class="card-header">
                        <div class="flex items-center justify-between">
                            <h2 class="card-title"><i class="fas fa-times-circle ml-2"></i>Ø¹Ø¯Ù… Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© ÙˆØ§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„ØªØµØ­ÙŠØ­ÙŠØ©</h2>
                            <button class="btn-primary" onclick="ISO.showNonConformityForm()">
                                <i class="fas fa-plus ml-2"></i>Ø¥Ø¶Ø§ÙØ© Ø¹Ø¯Ù… Ù…Ø·Ø§Ø¨Ù‚Ø©
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        ${nonConformities.length === 0 && actions.length === 0 ? '<div class="empty-state"><p class="text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ø¯Ù… Ù…Ø·Ø§Ø¨Ù‚Ø© Ø£Ùˆ Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª ØªØµØ­ÙŠØ­ÙŠØ©</p></div>' : `
                            <h3 class="font-semibold text-md mb-2">Ø¹Ø¯Ù… Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© (${nonConformities.length})</h3>
                            ${nonConformities.length === 0 ? '<p class="text-gray-500 text-sm">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ø¯Ù… Ù…Ø·Ø§Ø¨Ù‚Ø© Ù…Ø³Ø¬Ù„Ø©</p>' : `
                                <table class="data-table mb-4">
                                    <thead>
                                        <tr>
                                            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                            <th>Ø§Ù„ÙˆØµÙ</th>
                                            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                            <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${nonConformities.map(nc => `
                                            <tr>
                                                <td>${Utils.formatDate(nc.date)}</td>
                                                <td>${Utils.escapeHTML(nc.description.substring(0, 50))}...</td>
                                                <td><span class="badge badge-${nc.status === 'Ù…ØºÙ„Ù‚' ? 'success' : 'danger'}">${nc.status}</span></td>
                                                <td>
                                                    <button onclick="ISO.viewNonConformity('${nc.id}')" class="btn-icon btn-icon-info"><i class="fas fa-eye"></i></button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            `}

                            <h3 class="font-semibold text-md mb-2 mt-6">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„ØªØµØ­ÙŠØ­ÙŠØ© (${actions.length})</h3>
                            ${actions.length === 0 ? '<p class="text-gray-500 text-sm">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª ØªØµØ­ÙŠØ­ÙŠØ© Ù…Ø³Ø¬Ù„Ø©</p>' : `
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Ø§Ù„ÙˆØµÙ</th>
                                            <th>Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</th>
                                            <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</th>
                                            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                            <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${actions.map(action => `
                                            <tr>
                                                <td>${Utils.escapeHTML(action.description.substring(0, 50))}...</td>
                                                <td>${Utils.escapeHTML(action.responsible)}</td>
                                                <td>${Utils.formatDate(action.dueDate)}</td>
                                                <td><span class="badge badge-${action.status === 'Ù…ÙƒØªÙ…Ù„' ? 'success' : 'warning'}">${action.status}</span></td>
                                                <td>
                                                    <button onclick="ISO.viewCorrectiveAction('${action.id}')" class="btn-icon btn-icon-info"><i class="fas fa-eye"></i></button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            `}
                        `}
                    </div>
                </div>
            </div>
        `;
    },

    async showHSEObjectiveForm(data = null) {
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h2 class="modal-title">${data ? 'ØªØ¹Ø¯ÙŠÙ„ Ù‡Ø¯Ù' : 'Ø¥Ø¶Ø§ÙØ© Ù‡Ø¯Ù HSE Ø¬Ø¯ÙŠØ¯'}</h2>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="hse-objective-form" class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„Ù‡Ø¯Ù *</label>
                            <input type="text" id="objective-name" required class="form-input" 
                                value="${Utils.escapeHTML(data?.name || '')}" placeholder="Ù…Ø«Ø§Ù„: ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø¥ØµØ§Ø¨Ø§Øª Ø¨Ù†Ø³Ø¨Ø© 20%">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„ÙˆØµÙ *</label>
                            <textarea id="objective-description" required class="form-input" rows="4" 
                                placeholder="ÙˆØµÙ ØªÙØµÙŠÙ„ÙŠ Ù„Ù„Ù‡Ø¯Ù">${Utils.escapeHTML(data?.description || '')}</textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ *</label>
                            <input type="date" id="objective-due-date" required class="form-input" 
                                value="${data?.dueDate ? new Date(data.dueDate).toISOString().slice(0, 10) : ''}">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ *</label>
                            <input type="text" id="objective-responsible" required class="form-input" 
                                value="${Utils.escapeHTML(data?.responsible || '')}" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="this.closest('.modal-overlay').remove()">Ø¥Ù„ØºØ§Ø¡</button>
                    <button type="button" id="save-objective-btn" class="btn-primary">Ø­ÙØ¸</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);

        const saveBtn = modal.querySelector('#save-objective-btn');
        saveBtn.addEventListener('click', () => this.handleHSEObjectiveSubmit(data?.id, modal));

        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
        });
    },

    async handleHSEObjectiveSubmit(editId = null, modal) {
        const formData = {
            id: editId || Utils.generateId('HSE_OBJ'),
            name: document.getElementById('objective-name').value.trim(),
            description: document.getElementById('objective-description').value.trim(),
            dueDate: new Date(document.getElementById('objective-due-date').value).toISOString(),
            responsible: document.getElementById('objective-responsible').value.trim(),
            status: editId ? AppState.appData.hseObjectives.find(o => o.id === editId)?.status || 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°' : 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°',
            createdAt: editId ? AppState.appData.hseObjectives.find(o => o.id === editId)?.createdAt : new Date().toISOString(),
            updatedAt: new Date().toISOString()
        };

        if (!AppState.appData.hseObjectives) {
            AppState.appData.hseObjectives = [];
        }

        Loading.show();
        try {
            if (editId) {
                const index = AppState.appData.hseObjectives.findIndex(o => o.id === editId);
                if (index !== -1) AppState.appData.hseObjectives[index] = formData;
                Notification.success('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‡Ø¯Ù Ø¨Ù†Ø¬Ø§Ø­');
            } else {
                AppState.appData.hseObjectives.push(formData);
                Notification.success('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‡Ø¯Ù Ø¨Ù†Ø¬Ø§Ø­');
            }

            DataManager.save();
            await GoogleIntegration.autoSave('HSEObjectives', AppState.appData.hseObjectives);

            Loading.hide();
            modal.remove();
            this.load();
        } catch (error) {
            Loading.hide();
            Notification.error('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
        }
    },

    async showHSERiskAssessmentForm(data = null) {
        Notification.info('Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ù†Ù…ÙˆØ°Ø¬ ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…Ø®Ø§Ø·Ø± HSE Ù‚Ø±ÙŠØ¨Ø§Ù‹');
    },

    async showEnvironmentalAspectsForm(data = null) {
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h2 class="modal-title">${data ? 'ØªØ¹Ø¯ÙŠÙ„ Ø¬Ø§Ù†Ø¨ Ø¨ÙŠØ¦ÙŠ' : 'Ø¥Ø¶Ø§ÙØ© Ø¬Ø§Ù†Ø¨ Ø¨ÙŠØ¦ÙŠ Ø¬Ø¯ÙŠØ¯'}</h2>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="environmental-aspect-form" class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ø³Ù… Ø§Ù„Ø¬Ø§Ù†Ø¨ Ø§Ù„Ø¨ÙŠØ¦ÙŠ *</label>
                            <input type="text" id="aspect-name" required class="form-input" 
                                value="${Utils.escapeHTML(data?.name || '')}" placeholder="Ù…Ø«Ø§Ù„: Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ Ø§Ù„Ù…ÙŠØ§Ù‡">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„ÙˆØµÙ *</label>
                            <textarea id="aspect-description" required class="form-input" rows="4" 
                                placeholder="ÙˆØµÙ ØªÙØµÙŠÙ„ÙŠ Ù„Ù„Ø¬Ø§Ù†Ø¨ Ø§Ù„Ø¨ÙŠØ¦ÙŠ">${Utils.escapeHTML(data?.description || '')}</textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„ØªØ£Ø«ÙŠØ± *</label>
                            <select id="aspect-impact" required class="form-input">
                                <option value="">Ø§Ø®ØªØ± Ø§Ù„ØªØ£Ø«ÙŠØ±</option>
                                <option value="Ù…Ù†Ø®ÙØ¶" ${data?.impact === 'Ù…Ù†Ø®ÙØ¶' ? 'selected' : ''}>Ù…Ù†Ø®ÙØ¶</option>
                                <option value="Ù…ØªÙˆØ³Ø·" ${data?.impact === 'Ù…ØªÙˆØ³Ø·' ? 'selected' : ''}>Ù…ØªÙˆØ³Ø·</option>
                                <option value="Ø¹Ø§Ù„ÙŠ" ${data?.impact === 'Ø¹Ø§Ù„ÙŠ' ? 'selected' : ''}>Ø¹Ø§Ù„ÙŠ</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="this.closest('.modal-overlay').remove()">Ø¥Ù„ØºØ§Ø¡</button>
                    <button type="button" id="save-aspect-btn" class="btn-primary">Ø­ÙØ¸</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);

        const saveBtn = modal.querySelector('#save-aspect-btn');
        saveBtn.addEventListener('click', () => this.handleEnvironmentalAspectsSubmit(data?.id, modal));

        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
        });
    },

    async handleEnvironmentalAspectsSubmit(editId = null, modal) {
        const formData = {
            id: editId || Utils.generateId('ENV_ASP'),
            name: document.getElementById('aspect-name').value.trim(),
            description: document.getElementById('aspect-description').value.trim(),
            impact: document.getElementById('aspect-impact').value,
            createdAt: editId ? AppState.appData.environmentalAspects.find(a => a.id === editId)?.createdAt : new Date().toISOString(),
            updatedAt: new Date().toISOString()
        };

        if (!AppState.appData.environmentalAspects) {
            AppState.appData.environmentalAspects = [];
        }

        Loading.show();
        try {
            if (editId) {
                const index = AppState.appData.environmentalAspects.findIndex(a => a.id === editId);
                if (index !== -1) AppState.appData.environmentalAspects[index] = formData;
                Notification.success('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø§Ù†Ø¨ Ø§Ù„Ø¨ÙŠØ¦ÙŠ Ø¨Ù†Ø¬Ø§Ø­');
            } else {
                AppState.appData.environmentalAspects.push(formData);
                Notification.success('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¬Ø§Ù†Ø¨ Ø§Ù„Ø¨ÙŠØ¦ÙŠ Ø¨Ù†Ø¬Ø§Ø­');
            }

            DataManager.save();
            await GoogleIntegration.autoSave('EnvironmentalAspects', AppState.appData.environmentalAspects);

            Loading.hide();
            modal.remove();
            this.load();
        } catch (error) {
            Loading.hide();
            Notification.error('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
        }
    },

    async showEnvironmentalMonitoringForm(data = null) {
        Notification.info('Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø¨ÙŠØ¦ÙŠØ© Ù‚Ø±ÙŠØ¨Ø§Ù‹');
    },

    async showAuditForm(data = null) {
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h2 class="modal-title">${data ? 'ØªØ¹Ø¯ÙŠÙ„ ØªØ¯Ù‚ÙŠÙ‚' : 'Ø¥Ø¶Ø§ÙØ© ØªØ¯Ù‚ÙŠÙ‚ Ø¬Ø¯ÙŠØ¯'}</h2>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="audit-form" class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ù†ÙˆØ¹ Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚ *</label>
                            <select id="audit-type" required class="form-input">
                                <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù†ÙˆØ¹</option>
                                <option value="ØªØ¯Ù‚ÙŠÙ‚ Ø¯Ø§Ø®Ù„ÙŠ" ${data?.type === 'ØªØ¯Ù‚ÙŠÙ‚ Ø¯Ø§Ø®Ù„ÙŠ' ? 'selected' : ''}>ØªØ¯Ù‚ÙŠÙ‚ Ø¯Ø§Ø®Ù„ÙŠ</option>
                                <option value="ØªØ¯Ù‚ÙŠÙ‚ Ø®Ø§Ø±Ø¬ÙŠ" ${data?.type === 'ØªØ¯Ù‚ÙŠÙ‚ Ø®Ø§Ø±Ø¬ÙŠ' ? 'selected' : ''}>ØªØ¯Ù‚ÙŠÙ‚ Ø®Ø§Ø±Ø¬ÙŠ</option>
                                <option value="Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¥Ø¯Ø§Ø±Ø©" ${data?.type === 'Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¥Ø¯Ø§Ø±Ø©' ? 'selected' : ''}>Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¥Ø¯Ø§Ø±Ø©</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚ *</label>
                            <input type="date" id="audit-date" required class="form-input" 
                                value="${data?.date ? new Date(data.date).toISOString().slice(0, 10) : ''}">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„Ù…Ø¯Ù‚Ù‚ *</label>
                            <input type="text" id="audit-auditor" required class="form-input" 
                                value="${Utils.escapeHTML(data?.auditor || '')}" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ù‚Ù‚">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„Ø­Ø§Ù„Ø© *</label>
                            <select id="audit-status" required class="form-input">
                                <option value="Ù…Ø®Ø·Ø·" ${data?.status === 'Ù…Ø®Ø·Ø·' ? 'selected' : ''}>Ù…Ø®Ø·Ø·</option>
                                <option value="Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°" ${data?.status === 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°' ? 'selected' : ''}>Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</option>
                                <option value="Ù…ÙƒØªÙ…Ù„" ${data?.status === 'Ù…ÙƒØªÙ…Ù„' ? 'selected' : ''}>Ù…ÙƒØªÙ…Ù„</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„ÙˆØµÙ</label>
                            <textarea id="audit-description" class="form-input" rows="4" 
                                placeholder="ÙˆØµÙ Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚">${Utils.escapeHTML(data?.description || '')}</textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="this.closest('.modal-overlay').remove()">Ø¥Ù„ØºØ§Ø¡</button>
                    <button type="button" id="save-audit-btn" class="btn-primary">Ø­ÙØ¸</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);

        const saveBtn = modal.querySelector('#save-audit-btn');
        saveBtn.addEventListener('click', () => this.handleAuditSubmit(data?.id, modal));

        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
        });
    },

    async handleAuditSubmit(editId = null, modal) {
        const formData = {
            id: editId || Utils.generateId('HSE_AUDIT'),
            type: document.getElementById('audit-type').value,
            date: new Date(document.getElementById('audit-date').value).toISOString(),
            auditor: document.getElementById('audit-auditor').value.trim(),
            status: document.getElementById('audit-status').value,
            description: document.getElementById('audit-description').value.trim(),
            createdAt: editId ? AppState.appData.hseAudits.find(a => a.id === editId)?.createdAt : new Date().toISOString(),
            updatedAt: new Date().toISOString()
        };

        if (!AppState.appData.hseAudits) {
            AppState.appData.hseAudits = [];
        }

        Loading.show();
        try {
            if (editId) {
                const index = AppState.appData.hseAudits.findIndex(a => a.id === editId);
                if (index !== -1) AppState.appData.hseAudits[index] = formData;
                Notification.success('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚ Ø¨Ù†Ø¬Ø§Ø­');
            } else {
                AppState.appData.hseAudits.push(formData);
                Notification.success('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚ Ø¨Ù†Ø¬Ø§Ø­');
            }

            DataManager.save();
            await GoogleIntegration.autoSave('HSEAudits', AppState.appData.hseAudits);

            Loading.hide();
            modal.remove();
            this.load();
        } catch (error) {
            Loading.hide();
            Notification.error('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
        }
    },

    async viewAudit(id) {
        const audit = AppState.appData.hseAudits.find(a => a.id === id);
        if (!audit) {
            Notification.error('Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
            return;
        }
        
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h2 class="modal-title">ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚</h2>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="space-y-3">
                        <div><strong>Ø§Ù„Ù†ÙˆØ¹:</strong> ${Utils.escapeHTML(audit.type)}</div>
                        <div><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${Utils.formatDate(audit.date)}</div>
                        <div><strong>Ø§Ù„Ù…Ø¯Ù‚Ù‚:</strong> ${Utils.escapeHTML(audit.auditor)}</div>
                        <div><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> <span class="badge badge-${audit.status === 'Ù…ÙƒØªÙ…Ù„' ? 'success' : 'warning'}">${audit.status}</span></div>
                        <div><strong>Ø§Ù„ÙˆØµÙ:</strong> ${Utils.escapeHTML(audit.description || '-')}</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="this.closest('.modal-overlay').remove()">Ø¥ØºÙ„Ø§Ù‚</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
        });
    },

    async showNonConformityForm(data = null) {
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h2 class="modal-title">${data ? 'ØªØ¹Ø¯ÙŠÙ„ Ø¹Ø¯Ù… Ù…Ø·Ø§Ø¨Ù‚Ø©' : 'Ø¥Ø¶Ø§ÙØ© Ø¹Ø¯Ù… Ù…Ø·Ø§Ø¨Ù‚Ø© Ø¬Ø¯ÙŠØ¯Ø©'}</h2>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="non-conformity-form" class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">ØªØ§Ø±ÙŠØ® Ø¹Ø¯Ù… Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© *</label>
                            <input type="date" id="nc-date" required class="form-input" 
                                value="${data?.date ? new Date(data.date).toISOString().slice(0, 10) : ''}">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„ÙˆØµÙ *</label>
                            <textarea id="nc-description" required class="form-input" rows="4" 
                                placeholder="ÙˆØµÙ ØªÙØµÙŠÙ„ÙŠ Ù„Ø¹Ø¯Ù… Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©">${Utils.escapeHTML(data?.description || '')}</textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„Ø­Ø§Ù„Ø© *</label>
                            <select id="nc-status" required class="form-input">
                                <option value="Ù…ÙØªÙˆØ­Ø©" ${data?.status === 'Ù…ÙØªÙˆØ­Ø©' ? 'selected' : ''}>Ù…ÙØªÙˆØ­Ø©</option>
                                <option value="Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©" ${data?.status === 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©' ? 'selected' : ''}>Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</option>
                                <option value="Ù…ØºÙ„Ù‚" ${data?.status === 'Ù…ØºÙ„Ù‚' ? 'selected' : ''}>Ù…ØºÙ„Ù‚</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="this.closest('.modal-overlay').remove()">Ø¥Ù„ØºØ§Ø¡</button>
                    <button type="button" id="save-nc-btn" class="btn-primary">Ø­ÙØ¸</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);

        const saveBtn = modal.querySelector('#save-nc-btn');
        saveBtn.addEventListener('click', () => this.handleNonConformitySubmit(data?.id, modal));

        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
        });
    },

    async handleNonConformitySubmit(editId = null, modal) {
        const formData = {
            id: editId || Utils.generateId('HSE_NC'),
            date: new Date(document.getElementById('nc-date').value).toISOString(),
            description: document.getElementById('nc-description').value.trim(),
            status: document.getElementById('nc-status').value,
            createdAt: editId ? AppState.appData.hseNonConformities.find(nc => nc.id === editId)?.createdAt : new Date().toISOString(),
            updatedAt: new Date().toISOString()
        };

        if (!AppState.appData.hseNonConformities) {
            AppState.appData.hseNonConformities = [];
        }

        Loading.show();
        try {
            if (editId) {
                const index = AppState.appData.hseNonConformities.findIndex(nc => nc.id === editId);
                if (index !== -1) AppState.appData.hseNonConformities[index] = formData;
                Notification.success('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ù… Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ø¨Ù†Ø¬Ø§Ø­');
            } else {
                AppState.appData.hseNonConformities.push(formData);
                Notification.success('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø¹Ø¯Ù… Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ø¨Ù†Ø¬Ø§Ø­');
            }

            DataManager.save();
            await GoogleIntegration.autoSave('HSENonConformities', AppState.appData.hseNonConformities);

            Loading.hide();
            modal.remove();
            this.load();
        } catch (error) {
            Loading.hide();
            Notification.error('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
        }
    },

    async viewNonConformity(id) {
        const nc = AppState.appData.hseNonConformities.find(n => n.id === id);
        if (!nc) {
            Notification.error('Ø¹Ø¯Ù… Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
            return;
        }
        
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h2 class="modal-title">ØªÙØ§ØµÙŠÙ„ Ø¹Ø¯Ù… Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©</h2>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="space-y-3">
                        <div><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${Utils.formatDate(nc.date)}</div>
                        <div><strong>Ø§Ù„ÙˆØµÙ:</strong> ${Utils.escapeHTML(nc.description)}</div>
                        <div><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> <span class="badge badge-${nc.status === 'Ù…ØºÙ„Ù‚' ? 'success' : 'danger'}">${nc.status}</span></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="this.closest('.modal-overlay').remove()">Ø¥ØºÙ„Ø§Ù‚</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
        });
    },

    async showCorrectiveActionForm(data = null) {
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h2 class="modal-title">${data ? 'ØªØ¹Ø¯ÙŠÙ„ Ø¥Ø¬Ø±Ø§Ø¡ ØªØµØ­ÙŠØ­ÙŠ' : 'Ø¥Ø¶Ø§ÙØ© Ø¥Ø¬Ø±Ø§Ø¡ ØªØµØ­ÙŠØ­ÙŠ Ø¬Ø¯ÙŠØ¯'}</h2>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="corrective-action-form" class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„ÙˆØµÙ *</label>
                            <textarea id="ca-description" required class="form-input" rows="4" 
                                placeholder="ÙˆØµÙ ØªÙØµÙŠÙ„ÙŠ Ù„Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„ØªØµØ­ÙŠØ­ÙŠ">${Utils.escapeHTML(data?.description || '')}</textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ *</label>
                            <input type="text" id="ca-responsible" required class="form-input" 
                                value="${Utils.escapeHTML(data?.responsible || '')}" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ *</label>
                            <input type="date" id="ca-due-date" required class="form-input" 
                                value="${data?.dueDate ? new Date(data.dueDate).toISOString().slice(0, 10) : ''}">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„Ø­Ø§Ù„Ø© *</label>
                            <select id="ca-status" required class="form-input">
                                <option value="Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°" ${data?.status === 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°' ? 'selected' : ''}>Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</option>
                                <option value="Ù…ÙƒØªÙ…Ù„" ${data?.status === 'Ù…ÙƒØªÙ…Ù„' ? 'selected' : ''}>Ù…ÙƒØªÙ…Ù„</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="this.closest('.modal-overlay').remove()">Ø¥Ù„ØºØ§Ø¡</button>
                    <button type="button" id="save-ca-btn" class="btn-primary">Ø­ÙØ¸</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);

        const saveBtn = modal.querySelector('#save-ca-btn');
        saveBtn.addEventListener('click', () => this.handleCorrectiveActionSubmit(data?.id, modal));

        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
        });
    },

    async handleCorrectiveActionSubmit(editId = null, modal) {
        const formData = {
            id: editId || Utils.generateId('HSE_CA'),
            description: document.getElementById('ca-description').value.trim(),
            responsible: document.getElementById('ca-responsible').value.trim(),
            dueDate: new Date(document.getElementById('ca-due-date').value).toISOString(),
            status: document.getElementById('ca-status').value,
            createdAt: editId ? AppState.appData.hseCorrectiveActions.find(ca => ca.id === editId)?.createdAt : new Date().toISOString(),
            updatedAt: new Date().toISOString()
        };

        if (!AppState.appData.hseCorrectiveActions) {
            AppState.appData.hseCorrectiveActions = [];
        }

        Loading.show();
        try {
            if (editId) {
                const index = AppState.appData.hseCorrectiveActions.findIndex(ca => ca.id === editId);
                if (index !== -1) AppState.appData.hseCorrectiveActions[index] = formData;
                Notification.success('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„ØªØµØ­ÙŠØ­ÙŠ Ø¨Ù†Ø¬Ø§Ø­');
            } else {
                AppState.appData.hseCorrectiveActions.push(formData);
                Notification.success('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„ØªØµØ­ÙŠØ­ÙŠ Ø¨Ù†Ø¬Ø§Ø­');
            }

            DataManager.save();
            await GoogleIntegration.autoSave('HSECorrectiveActions', AppState.appData.hseCorrectiveActions);

            Loading.hide();
            modal.remove();
            this.load();
        } catch (error) {
            Loading.hide();
            Notification.error('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
        }
    },

    async viewCorrectiveAction(id) {
        const ca = AppState.appData.hseCorrectiveActions.find(c => c.id === id);
        if (!ca) {
            Notification.error('Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„ØªØµØ­ÙŠØ­ÙŠ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
            return;
        }
        
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h2 class="modal-title">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„ØªØµØ­ÙŠØ­ÙŠ</h2>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="space-y-3">
                        <div><strong>Ø§Ù„ÙˆØµÙ:</strong> ${Utils.escapeHTML(ca.description)}</div>
                        <div><strong>Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„:</strong> ${Utils.escapeHTML(ca.responsible)}</div>
                        <div><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡:</strong> ${Utils.formatDate(ca.dueDate)}</div>
                        <div><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> <span class="badge badge-${ca.status === 'Ù…ÙƒØªÙ…Ù„' ? 'success' : 'warning'}">${ca.status}</span></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="this.closest('.modal-overlay').remove()">Ø¥ØºÙ„Ø§Ù‚</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
        });
    }
};

// ===== Emergency Module (ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø·ÙˆØ§Ø±Ø¦) =====
const Emergency = {
    async load() {
        const section = document.getElementById('emergency-section');
        if (!section) {
            console.error('âŒ Ù‚Ø³Ù… emergency-section ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!');
            return;
        }

        section.innerHTML = `
            <div class="section-header">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="section-title">
                            <i class="fas fa-exclamation-triangle ml-3"></i>
                            ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø·ÙˆØ§Ø±Ø¦
                        </h1>
                        <p class="section-subtitle">Ø¥Ø¯Ø§Ø±Ø© ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ ÙˆØ®Ø·Ø· Ø§Ù„Ø·ÙˆØ§Ø±Ø¦</p>
                    </div>
                    <div class="flex gap-2">
                        <button id="add-plan-btn" class="btn-secondary">
                            <i class="fas fa-file-alt ml-2"></i>
                            Ø¥Ø¶Ø§ÙØ© Ø®Ø·Ø© Ø·ÙˆØ§Ø±Ø¦
                        </button>
                        <button id="add-alert-btn" class="btn-primary">
                            <i class="fas fa-bell ml-2"></i>
                            Ø¥Ø¶Ø§ÙØ© ØªÙ†Ø¨ÙŠÙ‡ Ø·ÙˆØ§Ø±Ø¦
                        </button>
                    </div>
                </div>
            </div>
            <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="content-card">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-bell ml-2"></i>Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©</h2>
                    </div>
                    <div class="card-body" id="alerts-container">
                        ${await this.renderAlerts()}
                    </div>
                </div>
                <div class="content-card">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-file-alt ml-2"></i>Ø®Ø·Ø· Ø§Ù„Ø·ÙˆØ§Ø±Ø¦</h2>
                    </div>
                    <div class="card-body" id="plans-container">
                        ${await this.renderPlans()}
                    </div>
                </div>
            </div>
        `;
        this.setupEventListeners();
    },

    async renderAlerts() {
        const alerts = (AppState.appData.emergencyAlerts || []).filter(a => a.status !== 'Ù…ØºÙ„Ù‚').slice(0, 5);
        if (alerts.length === 0) {
            return '<div class="empty-state"><p class="text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ù†Ø´Ø·Ø©</p></div>';
        }
        return alerts.map(alert => `
            <div class="border rounded-lg p-4 mb-3 ${alert.severity === 'Ø¹Ø§Ù„ÙŠØ©' ? 'border-red-500 bg-red-50' : alert.severity === 'Ù…ØªÙˆØ³Ø·Ø©' ? 'border-yellow-500 bg-yellow-50' : 'border-blue-500 bg-blue-50'}">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="font-semibold">${Utils.escapeHTML(alert.title || '')}</h3>
                    <span class="badge badge-${alert.severity === 'Ø¹Ø§Ù„ÙŠØ©' ? 'danger' : alert.severity === 'Ù…ØªÙˆØ³Ø·Ø©' ? 'warning' : 'info'}">${alert.severity || ''}</span>
                </div>
                <p class="text-sm text-gray-600 mb-2">${Utils.escapeHTML(alert.description || '').substring(0, 100)}</p>
                <div class="flex items-center justify-between text-xs text-gray-500">
                    <span>${Utils.formatDate(alert.date)}</span>
                    <button onclick="Emergency.viewAlert('${alert.id}')" class="text-blue-600 hover:text-blue-800">Ø¹Ø±Ø¶</button>
                </div>
            </div>
        `).join('');
    },

    async renderPlans() {
        const plans = (AppState.appData.emergencyPlans || []).slice(0, 5);
        if (plans.length === 0) {
            return '<div class="empty-state"><p class="text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø®Ø·Ø· Ø·ÙˆØ§Ø±Ø¦</p></div>';
        }
        return plans.map(plan => `
            <div class="border rounded-lg p-4 mb-3 hover:shadow-md transition-shadow">
                <h3 class="font-semibold mb-2">${Utils.escapeHTML(plan.name || '')}</h3>
                <p class="text-sm text-gray-600 mb-2">${Utils.escapeHTML(plan.description || '').substring(0, 100)}</p>
                <div class="flex items-center justify-between text-xs text-gray-500">
                    <span>${plan.type || ''}</span>
                    <button onclick="Emergency.viewPlan('${plan.id}')" class="text-blue-600 hover:text-blue-800">Ø¹Ø±Ø¶</button>
                </div>
            </div>
        `).join('');
    },

    setupEventListeners() {
        setTimeout(() => {
            const addAlertBtn = document.getElementById('add-alert-btn');
            const addPlanBtn = document.getElementById('add-plan-btn');
            if (addAlertBtn) addAlertBtn.addEventListener('click', () => this.showAlertForm());
            if (addPlanBtn) addPlanBtn.addEventListener('click', () => this.showPlanForm());
        }, 100);
    },

    async showAlertForm(data = null) {
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h2 class="modal-title">${data ? 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡' : 'Ø¥Ø¶Ø§ÙØ© ØªÙ†Ø¨ÙŠÙ‡ Ø·ÙˆØ§Ø±Ø¦'}</h2>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="alert-form" class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ *</label>
                            <input type="text" id="alert-title" required class="form-input" 
                                value="${Utils.escapeHTML(data?.title || '')}" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„ÙˆØµÙ *</label>
                            <textarea id="alert-description" required class="form-input" rows="4" 
                                placeholder="ÙˆØµÙ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡">${Utils.escapeHTML(data?.description || '')}</textarea>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„Ø®Ø·ÙˆØ±Ø© *</label>
                                <select id="alert-severity" required class="form-input">
                                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø®Ø·ÙˆØ±Ø©</option>
                                    <option value="Ø¹Ø§Ù„ÙŠØ©" ${data?.severity === 'Ø¹Ø§Ù„ÙŠØ©' ? 'selected' : ''}>Ø¹Ø§Ù„ÙŠØ©</option>
                                    <option value="Ù…ØªÙˆØ³Ø·Ø©" ${data?.severity === 'Ù…ØªÙˆØ³Ø·Ø©' ? 'selected' : ''}>Ù…ØªÙˆØ³Ø·Ø©</option>
                                    <option value="Ù…Ù†Ø®ÙØ¶Ø©" ${data?.severity === 'Ù…Ù†Ø®ÙØ¶Ø©' ? 'selected' : ''}>Ù…Ù†Ø®ÙØ¶Ø©</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„Ø­Ø§Ù„Ø© *</label>
                                <select id="alert-status" required class="form-input">
                                    <option value="Ù†Ø´Ø·" ${data?.status === 'Ù†Ø´Ø·' ? 'selected' : ''}>Ù†Ø´Ø·</option>
                                    <option value="Ù…ØºÙ„Ù‚" ${data?.status === 'Ù…ØºÙ„Ù‚' ? 'selected' : ''}>Ù…ØºÙ„Ù‚</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„ØªØ§Ø±ÙŠØ® *</label>
                            <input type="date" id="alert-date" required class="form-input" 
                                value="${data?.date ? new Date(data.date).toISOString().split('T')[0] : new Date().toISOString().split('T')[0]}">
                        </div>
                        <div class="flex items-center justify-end gap-3 pt-4 border-t">
                            <button type="button" class="btn-secondary" onclick="this.closest('.modal-overlay').remove()">Ø¥Ù„ØºØ§Ø¡</button>
                            <button type="submit" class="btn-primary">Ø­ÙØ¸</button>
                        </div>
                    </form>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        
        const form = document.getElementById('alert-form');
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            this.handleAlertSubmit(data?.id, modal);
        });
        
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
        });
    },

    async showPlanForm(data = null) {
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h2 class="modal-title">${data ? 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø®Ø·Ø©' : 'Ø¥Ø¶Ø§ÙØ© Ø®Ø·Ø© Ø·ÙˆØ§Ø±Ø¦'}</h2>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="plan-form" class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ø³Ù… Ø§Ù„Ø®Ø·Ø© *</label>
                            <input type="text" id="plan-name" required class="form-input" 
                                value="${Utils.escapeHTML(data?.name || '')}" placeholder="Ø§Ø³Ù… Ø®Ø·Ø© Ø§Ù„Ø·ÙˆØ§Ø±Ø¦">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„Ù†ÙˆØ¹ *</label>
                            <select id="plan-type" required class="form-input">
                                <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù†ÙˆØ¹</option>
                                <option value="Ø­Ø±ÙŠÙ‚" ${data?.type === 'Ø­Ø±ÙŠÙ‚' ? 'selected' : ''}>Ø­Ø±ÙŠÙ‚</option>
                                <option value="Ø²Ù„Ø²Ø§Ù„" ${data?.type === 'Ø²Ù„Ø²Ø§Ù„' ? 'selected' : ''}>Ø²Ù„Ø²Ø§Ù„</option>
                                <option value="ÙÙŠØ¶Ø§Ù†Ø§Øª" ${data?.type === 'ÙÙŠØ¶Ø§Ù†Ø§Øª' ? 'selected' : ''}>ÙÙŠØ¶Ø§Ù†Ø§Øª</option>
                                <option value="Ø­Ø§Ø¯Ø« ÙƒÙŠÙ…ÙŠØ§Ø¦ÙŠ" ${data?.type === 'Ø­Ø§Ø¯Ø« ÙƒÙŠÙ…ÙŠØ§Ø¦ÙŠ' ? 'selected' : ''}>Ø­Ø§Ø¯Ø« ÙƒÙŠÙ…ÙŠØ§Ø¦ÙŠ</option>
                                <option value="Ø£Ø®Ø±Ù‰" ${data?.type === 'Ø£Ø®Ø±Ù‰' ? 'selected' : ''}>Ø£Ø®Ø±Ù‰</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„ÙˆØµÙ *</label>
                            <textarea id="plan-description" required class="form-input" rows="6" 
                                placeholder="ÙˆØµÙ Ø®Ø·Ø© Ø§Ù„Ø·ÙˆØ§Ø±Ø¦">${Utils.escapeHTML(data?.description || '')}</textarea>
                        </div>
                        <div class="flex items-center justify-end gap-3 pt-4 border-t">
                            <button type="button" class="btn-secondary" onclick="this.closest('.modal-overlay').remove()">Ø¥Ù„ØºØ§Ø¡</button>
                            <button type="submit" class="btn-primary">Ø­ÙØ¸</button>
                        </div>
                    </form>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        
        const form = document.getElementById('plan-form');
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            this.handlePlanSubmit(data?.id, modal);
        });
        
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
        });
    },

    async handleAlertSubmit(editId, modal) {
        const formData = {
            id: editId || Utils.generateId('ALERT'),
            title: document.getElementById('alert-title').value.trim(),
            description: document.getElementById('alert-description').value.trim(),
            severity: document.getElementById('alert-severity').value,
            status: document.getElementById('alert-status').value,
            date: new Date(document.getElementById('alert-date').value).toISOString(),
            createdAt: editId ? AppState.appData.emergencyAlerts.find(a => a.id === editId)?.createdAt : new Date().toISOString(),
            updatedAt: new Date().toISOString()
        };

        Loading.show();
        try {
            if (editId) {
                const index = AppState.appData.emergencyAlerts.findIndex(a => a.id === editId);
                if (index !== -1) AppState.appData.emergencyAlerts[index] = formData;
                Notification.success('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø¨Ù†Ø¬Ø§Ø­');
            } else {
                AppState.appData.emergencyAlerts.push(formData);
                Notification.success('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø¨Ù†Ø¬Ø§Ø­');
                
                // Ø¥Ø±Ø³Ø§Ù„ Ø¥ÙŠÙ…ÙŠÙ„ Ù„Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙÙ‚Ø·
                await this.sendAlertEmail(formData);
            }

            DataManager.save();
            await GoogleIntegration.autoSave('EmergencyAlerts', AppState.appData.emergencyAlerts);
            
            Loading.hide();
            modal.remove();
            this.load();
        } catch (error) {
            Loading.hide();
            Notification.error('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
        }
    },

    async sendAlertEmail(alert) {
        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„Ø§Øª Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
        const notificationEmails = AppState.notificationEmails || [];
        if (notificationEmails.length === 0) {
            console.log('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥ÙŠÙ…ÙŠÙ„Ø§Øª Ù„Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª');
            return;
        }

        try {
            // ÙÙŠ Ø§Ù„Ø¥Ù†ØªØ§Ø¬ØŒ ÙŠØ¬Ø¨ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø®Ø¯Ù…Ø© Ø¥Ø±Ø³Ø§Ù„ Ø¥ÙŠÙ…ÙŠÙ„Ø§Øª ÙØ¹Ù„ÙŠØ© (Ù…Ø«Ù„ SendGrid, AWS SES, etc.)
            // Ù‡Ù†Ø§ Ø³Ù†Ø¹Ø±Ø¶ ÙÙ‚Ø· Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­
            const emailSubject = `ØªÙ†Ø¨ÙŠÙ‡ Ø·ÙˆØ§Ø±Ø¦: ${alert.title}`;
            const emailBody = `
                <h2>ØªÙ†Ø¨ÙŠÙ‡ Ø·ÙˆØ§Ø±Ø¦</h2>
                <p><strong>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</strong> ${alert.title}</p>
                <p><strong>Ø§Ù„ÙˆØµÙ:</strong> ${alert.description}</p>
                <p><strong>Ø§Ù„Ø®Ø·ÙˆØ±Ø©:</strong> ${alert.severity}</p>
                <p><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${Utils.formatDate(alert.date)}</p>
            `;
            
            console.log('ğŸ“§ Ø¥Ø±Ø³Ø§Ù„ Ø¥ÙŠÙ…ÙŠÙ„ Ù„Ù„ØªÙ†Ø¨ÙŠÙ‡:', {
                to: notificationEmails,
                subject: emailSubject,
                body: emailBody
            });
            
            // ÙÙŠ Ø§Ù„Ø¥Ù†ØªØ§Ø¬ØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø®Ø¯Ù…Ø© Ø¥Ø±Ø³Ø§Ù„ Ø¥ÙŠÙ…ÙŠÙ„Ø§Øª ÙØ¹Ù„ÙŠØ© Ù‡Ù†Ø§
            // Ù…Ø«Ø§Ù„: await EmailService.send({ to: notificationEmails, subject: emailSubject, body: emailBody });
            
            Notification.success(`ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø¥Ù„Ù‰ ${notificationEmails.length} Ø¥ÙŠÙ…ÙŠÙ„`);
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„:', error);
            Notification.warning('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ù„ÙƒÙ† ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„');
        }
    },

    async handlePlanSubmit(editId, modal) {
        const formData = {
            id: editId || Utils.generateId('PLAN'),
            name: document.getElementById('plan-name').value.trim(),
            type: document.getElementById('plan-type').value,
            description: document.getElementById('plan-description').value.trim(),
            createdAt: editId ? AppState.appData.emergencyPlans.find(p => p.id === editId)?.createdAt : new Date().toISOString(),
            updatedAt: new Date().toISOString()
        };

        Loading.show();
        try {
            if (editId) {
                const index = AppState.appData.emergencyPlans.findIndex(p => p.id === editId);
                if (index !== -1) AppState.appData.emergencyPlans[index] = formData;
                Notification.success('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø®Ø·Ø© Ø¨Ù†Ø¬Ø§Ø­');
            } else {
                AppState.appData.emergencyPlans.push(formData);
                Notification.success('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø®Ø·Ø© Ø¨Ù†Ø¬Ø§Ø­');
            }

            DataManager.save();
            await GoogleIntegration.autoSave('EmergencyPlans', AppState.appData.emergencyPlans);
            
            Loading.hide();
            modal.remove();
            this.load();
        } catch (error) {
            Loading.hide();
            Notification.error('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
        }
    },

    async viewAlert(id) {
        const alert = AppState.appData.emergencyAlerts.find(a => a.id === id);
        if (!alert) return;
        
        Notification.info(`Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡: ${alert.title}`);
    },

    async viewPlan(id) {
        const plan = AppState.appData.emergencyPlans.find(p => p.id === id);
        if (!plan) return;
        
        Notification.info(`Ø§Ù„Ø®Ø·Ø©: ${plan.name}`);
    }
};

// ===== Action Tracking Register Module (Ø³Ø¬Ù„ Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª) =====
const ActionTrackingRegister = {
    async load() {
        const section = document.getElementById('action-tracking-section');
        if (!section) {
            console.error('âŒ Ù‚Ø³Ù… action-tracking-section ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!');
            return;
        }

        section.innerHTML = `
            <div class="section-header">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="section-title">
                            <i class="fas fa-clipboard-list ml-3"></i>
                            Ø³Ø¬Ù„ Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª
                        </h1>
                        <p class="section-subtitle">ØªØ³Ø¬ÙŠÙ„ ÙˆÙ…ØªØ§Ø¨Ø¹Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª ÙˆØ§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª ÙˆØ§Ù„Ø­ÙˆØ§Ø¯Ø« Ø§Ù„ÙˆØ´ÙŠÙƒØ© ÙˆØ§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ© ÙˆÙ†Ù‚Ø§Ø· Ø§Ø¬ØªÙ…Ø§Ø¹Ø§Øª Ø§Ù„Ø³Ù„Ø§Ù…Ø© ÙˆØ§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø§Øª</p>
                    </div>
                    <button id="add-action-btn" class="btn-primary">
                        <i class="fas fa-plus ml-2"></i>
                        Ø¥Ø¶Ø§ÙØ© Ø¥Ø¬Ø±Ø§Ø¡ Ø¬Ø¯ÙŠØ¯
                    </button>
                </div>
            </div>
            <div class="mt-6">
                ${await this.renderList()}
            </div>
        `;
        this.setupEventListeners();
        await this.loadActionList();
    },

    async renderList() {
        return `
            <div class="content-card">
                <div class="card-header">
                    <div class="flex items-center justify-between">
                        <h2 class="card-title"><i class="fas fa-list ml-2"></i>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</h2>
                        <div class="flex items-center gap-4">
                            <input type="text" id="action-search" class="form-input" style="max-width: 300px;" placeholder="Ø§Ù„Ø¨Ø­Ø«...">
                            <select id="action-filter-type" class="form-input" style="max-width: 200px;">
                                <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹</option>
                                <option value="Ø¥Ø¬Ø±Ø§Ø¡">Ø¥Ø¬Ø±Ø§Ø¡</option>
                                <option value="Ù…Ù„Ø§Ø­Ø¸Ø©">Ù…Ù„Ø§Ø­Ø¸Ø©</option>
                                <option value="Ø­Ø§Ø¯Ø« ÙˆØ´ÙŠÙƒ">Ø­Ø§Ø¯Ø« ÙˆØ´ÙŠÙƒ</option>
                                <option value="Ù…Ù„Ø§Ø­Ø¸Ø© ÙŠÙˆÙ…ÙŠØ©">Ù…Ù„Ø§Ø­Ø¸Ø© ÙŠÙˆÙ…ÙŠØ©</option>
                                <option value="Ù†Ù‚Ø·Ø© Ø§Ø¬ØªÙ…Ø§Ø¹ Ø³Ù„Ø§Ù…Ø©">Ù†Ù‚Ø·Ø© Ø§Ø¬ØªÙ…Ø§Ø¹ Ø³Ù„Ø§Ù…Ø©</option>
                                <option value="Ù…Ø±Ø§Ø¬Ø¹Ø©">Ù…Ø±Ø§Ø¬Ø¹Ø©</option>
                            </select>
                            <select id="action-filter-status" class="form-input" style="max-width: 200px;">
                                <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
                                <option value="Ù…ÙØªÙˆØ­">Ù…ÙØªÙˆØ­</option>
                                <option value="Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°">Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</option>
                                <option value="Ù…ÙƒØªÙ…Ù„">Ù…ÙƒØªÙ…Ù„</option>
                                <option value="Ù…ØºÙ„Ù‚">Ù…ØºÙ„Ù‚</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div id="action-table-container">
                        <div class="empty-state">
                            <i class="fas fa-spinner fa-spin text-4xl text-gray-300 mb-4"></i>
                            <p class="text-gray-500">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
                        </div>
                    </div>
                </div>
            </div>
        `;
    },

    async loadActionList() {
        const container = document.getElementById('action-table-container');
        if (!container) return;
        const items = AppState.appData.actionTrackingRegister || [];
        
        if (items.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-clipboard-list text-4xl text-gray-300 mb-4"></i>
                    <p class="text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ù…Ø³Ø¬Ù„Ø©</p>
                    <button id="add-action-empty-btn" class="btn-primary mt-4">
                        <i class="fas fa-plus ml-2"></i>
                        Ø¥Ø¶Ø§ÙØ© Ø¥Ø¬Ø±Ø§Ø¡ Ø¬Ø¯ÙŠØ¯
                    </button>
                </div>
            `;
            const addBtn = document.getElementById('add-action-empty-btn');
            if (addBtn) addBtn.addEventListener('click', () => this.showActionForm());
            return;
        }

        const searchTerm = (document.getElementById('action-search')?.value || '').toLowerCase();
        const typeFilter = document.getElementById('action-filter-type')?.value || '';
        const statusFilter = document.getElementById('action-filter-status')?.value || '';

        const filteredItems = this.filterItems(searchTerm, typeFilter, statusFilter);

        if (filteredItems.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-search text-4xl text-gray-300 mb-4"></i>
                    <p class="text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù„Ù„Ø¨Ø­Ø«</p>
                </div>
            `;
            return;
        }

        container.innerHTML = `
            <div class="overflow-x-auto">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Ø±Ù‚Ù… Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th>
                            <th>Ø§Ù„Ù†ÙˆØ¹</th>
                            <th>Ø§Ù„Ù…ØµØ¯Ø±</th>
                            <th>Ø§Ù„ÙˆØµÙ</th>
                            <th>Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</th>
                            <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</th>
                            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                            <th>Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©</th>
                            <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filteredItems.map(action => `
                            <tr>
                                <td>${Utils.escapeHTML(action.id || '')}</td>
                                <td>
                                    <span class="badge badge-info">${Utils.escapeHTML(action.type || '')}</span>
                                </td>
                                <td>${Utils.escapeHTML(action.source || '')}</td>
                                <td>${Utils.escapeHTML((action.description || '').substring(0, 50))}${(action.description || '').length > 50 ? '...' : ''}</td>
                                <td>${Utils.escapeHTML(action.responsible || '')}</td>
                                <td>${action.dueDate ? Utils.formatDate(action.dueDate) : '-'}</td>
                                <td>
                                    <span class="badge badge-${action.status === 'Ù…ÙƒØªÙ…Ù„' ? 'success' : action.status === 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°' ? 'warning' : action.status === 'Ù…ØºÙ„Ù‚' ? 'secondary' : 'info'}">
                                        ${Utils.escapeHTML(action.status || '')}
                                    </span>
                                </td>
                                <td>
                                    <span class="badge badge-${action.priority === 'Ø¹Ø§Ù„ÙŠ' ? 'danger' : action.priority === 'Ù…ØªÙˆØ³Ø·' ? 'warning' : 'info'}">
                                        ${Utils.escapeHTML(action.priority || '')}
                                    </span>
                                </td>
                                <td>
                                    <button onclick="ActionTrackingRegister.viewAction('${action.id}')" class="btn-icon btn-icon-primary" title="Ø¹Ø±Ø¶">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button onclick="ActionTrackingRegister.editEntry('${action.id}')" class="btn-icon btn-icon-info" title="ØªØ¹Ø¯ÙŠÙ„">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button onclick="ActionTrackingRegister.deleteEntry('${action.id}')" class="btn-icon btn-icon-danger" title="Ø­Ø°Ù">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
    },

    filterItems(searchTerm, typeFilter, statusFilter) {
        const items = AppState.appData.actionTrackingRegister || [];
        
        return items.filter(action => {
            const matchesSearch = !searchTerm || 
                (action.description || '').toLowerCase().includes(searchTerm) ||
                (action.responsible || '').toLowerCase().includes(searchTerm) ||
                (action.source || '').toLowerCase().includes(searchTerm) ||
                (action.id || '').toLowerCase().includes(searchTerm);
            
            const matchesType = !typeFilter || action.type === typeFilter;
            const matchesStatus = !statusFilter || action.status === statusFilter;
            
            return matchesSearch && matchesType && matchesStatus;
        });
    },

    setupEventListeners() {
        setTimeout(() => {
            const addBtn = document.getElementById('add-action-btn');
            if (addBtn) addBtn.addEventListener('click', () => this.showActionForm());

            const searchInput = document.getElementById('action-search');
            if (searchInput) {
                searchInput.addEventListener('input', () => this.loadActionList());
            }

            const typeFilter = document.getElementById('action-filter-type');
            if (typeFilter) {
                typeFilter.addEventListener('change', () => this.loadActionList());
            }

            const statusFilter = document.getElementById('action-filter-status');
            if (statusFilter) {
                statusFilter.addEventListener('change', () => this.loadActionList());
            }
        }, 100);
    },

    async showActionForm(actionData = null) {
        const isEdit = !!actionData;
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 800px;">
                <div class="modal-header">
                    <h2 class="modal-title">${isEdit ? 'ØªØ¹Ø¯ÙŠÙ„ Ø¥Ø¬Ø±Ø§Ø¡' : 'Ø¥Ø¶Ø§ÙØ© Ø¥Ø¬Ø±Ø§Ø¡ Ø¬Ø¯ÙŠØ¯'}</h2>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="action-form" class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„Ù†ÙˆØ¹ *</label>
                                <select id="action-type" required class="form-input">
                                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù†ÙˆØ¹</option>
                                    <option value="Ø¥Ø¬Ø±Ø§Ø¡" ${actionData?.type === 'Ø¥Ø¬Ø±Ø§Ø¡' ? 'selected' : ''}>Ø¥Ø¬Ø±Ø§Ø¡</option>
                                    <option value="Ù…Ù„Ø§Ø­Ø¸Ø©" ${actionData?.type === 'Ù…Ù„Ø§Ø­Ø¸Ø©' ? 'selected' : ''}>Ù…Ù„Ø§Ø­Ø¸Ø©</option>
                                    <option value="Ø­Ø§Ø¯Ø« ÙˆØ´ÙŠÙƒ" ${actionData?.type === 'Ø­Ø§Ø¯Ø« ÙˆØ´ÙŠÙƒ' ? 'selected' : ''}>Ø­Ø§Ø¯Ø« ÙˆØ´ÙŠÙƒ</option>
                                    <option value="Ù…Ù„Ø§Ø­Ø¸Ø© ÙŠÙˆÙ…ÙŠØ©" ${actionData?.type === 'Ù…Ù„Ø§Ø­Ø¸Ø© ÙŠÙˆÙ…ÙŠØ©' ? 'selected' : ''}>Ù…Ù„Ø§Ø­Ø¸Ø© ÙŠÙˆÙ…ÙŠØ©</option>
                                    <option value="Ù†Ù‚Ø·Ø© Ø§Ø¬ØªÙ…Ø§Ø¹ Ø³Ù„Ø§Ù…Ø©" ${actionData?.type === 'Ù†Ù‚Ø·Ø© Ø§Ø¬ØªÙ…Ø§Ø¹ Ø³Ù„Ø§Ù…Ø©' ? 'selected' : ''}>Ù†Ù‚Ø·Ø© Ø§Ø¬ØªÙ…Ø§Ø¹ Ø³Ù„Ø§Ù…Ø©</option>
                                    <option value="Ù…Ø±Ø§Ø¬Ø¹Ø©" ${actionData?.type === 'Ù…Ø±Ø§Ø¬Ø¹Ø©' ? 'selected' : ''}>Ù…Ø±Ø§Ø¬Ø¹Ø©</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„Ù…ØµØ¯Ø± *</label>
                                <select id="action-source" required class="form-input">
                                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…ØµØ¯Ø±</option>
                                    <option value="Ø­Ø§Ø¯Ø«" ${actionData?.source === 'Ø­Ø§Ø¯Ø«' ? 'selected' : ''}>Ø­Ø§Ø¯Ø«</option>
                                    <option value="Ø­Ø§Ø¯Ø« ÙˆØ´ÙŠÙƒ" ${actionData?.source === 'Ø­Ø§Ø¯Ø« ÙˆØ´ÙŠÙƒ' ? 'selected' : ''}>Ø­Ø§Ø¯Ø« ÙˆØ´ÙŠÙƒ</option>
                                    <option value="Ù…Ù„Ø§Ø­Ø¸Ø© ÙŠÙˆÙ…ÙŠØ©" ${actionData?.source === 'Ù…Ù„Ø§Ø­Ø¸Ø© ÙŠÙˆÙ…ÙŠØ©' ? 'selected' : ''}>Ù…Ù„Ø§Ø­Ø¸Ø© ÙŠÙˆÙ…ÙŠØ©</option>
                                    <option value="Ø§Ø¬ØªÙ…Ø§Ø¹ Ø³Ù„Ø§Ù…Ø©" ${actionData?.source === 'Ø§Ø¬ØªÙ…Ø§Ø¹ Ø³Ù„Ø§Ù…Ø©' ? 'selected' : ''}>Ø§Ø¬ØªÙ…Ø§Ø¹ Ø³Ù„Ø§Ù…Ø©</option>
                                    <option value="Ù…Ø±Ø§Ø¬Ø¹Ø©" ${actionData?.source === 'Ù…Ø±Ø§Ø¬Ø¹Ø©' ? 'selected' : ''}>Ù…Ø±Ø§Ø¬Ø¹Ø©</option>
                                    <option value="Ø¢Ø®Ø±" ${actionData?.source === 'Ø¢Ø®Ø±' ? 'selected' : ''}>Ø¢Ø®Ø±</option>
                                </select>
                            </div>
                            <div class="col-span-2">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„ÙˆØµÙ *</label>
                                <textarea id="action-description" required class="form-input" rows="4" placeholder="ÙˆØµÙ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø£Ùˆ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©...">${actionData?.description || ''}</textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ *</label>
                                <input type="text" id="action-responsible" required class="form-input"
                                    value="${actionData?.responsible || ''}" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚ *</label>
                                <input type="date" id="action-due-date" required class="form-input"
                                    value="${actionData?.dueDate ? new Date(actionData.dueDate).toISOString().slice(0, 10) : ''}">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„Ø­Ø§Ù„Ø© *</label>
                                <select id="action-status" required class="form-input">
                                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø­Ø§Ù„Ø©</option>
                                    <option value="Ù…ÙØªÙˆØ­" ${actionData?.status === 'Ù…ÙØªÙˆØ­' ? 'selected' : ''}>Ù…ÙØªÙˆØ­</option>
                                    <option value="Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°" ${actionData?.status === 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°' ? 'selected' : ''}>Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</option>
                                    <option value="Ù…ÙƒØªÙ…Ù„" ${actionData?.status === 'Ù…ÙƒØªÙ…Ù„' ? 'selected' : ''}>Ù…ÙƒØªÙ…Ù„</option>
                                    <option value="Ù…ØºÙ„Ù‚" ${actionData?.status === 'Ù…ØºÙ„Ù‚' ? 'selected' : ''}>Ù…ØºÙ„Ù‚</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© *</label>
                                <select id="action-priority" required class="form-input">
                                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©</option>
                                    <option value="Ø¹Ø§Ù„ÙŠ" ${actionData?.priority === 'Ø¹Ø§Ù„ÙŠ' ? 'selected' : ''}>Ø¹Ø§Ù„ÙŠ</option>
                                    <option value="Ù…ØªÙˆØ³Ø·" ${actionData?.priority === 'Ù…ØªÙˆØ³Ø·' ? 'selected' : ''}>Ù…ØªÙˆØ³Ø·</option>
                                    <option value="Ù…Ù†Ø®ÙØ¶" ${actionData?.priority === 'Ù…Ù†Ø®ÙØ¶' ? 'selected' : ''}>Ù…Ù†Ø®ÙØ¶</option>
                                </select>
                            </div>
                            <div class="col-span-2">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                                <textarea id="action-notes" class="form-input" rows="3" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©...">${actionData?.notes || ''}</textarea>
                            </div>
                        </div>
                        <div class="flex items-center justify-end gap-4 pt-4 border-t">
                            <button type="button" class="btn-secondary" onclick="this.closest('.modal-overlay').remove()">Ø¥Ù„ØºØ§Ø¡</button>
                            <button type="submit" class="btn-primary">
                                <i class="fas fa-save ml-2"></i>${isEdit ? 'Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª' : 'Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡'}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        
        const form = modal.querySelector('#action-form');
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            await this.handleSubmit(e, actionData, modal);
        });
        
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
        });
    },

    async handleSubmit(e, actionData, modal) {
        e.preventDefault();
        
        const formData = {
            id: actionData?.id || Utils.generateId('ACTION'),
            type: document.getElementById('action-type').value,
            source: document.getElementById('action-source').value,
            description: document.getElementById('action-description').value.trim(),
            responsible: document.getElementById('action-responsible').value.trim(),
            dueDate: new Date(document.getElementById('action-due-date').value).toISOString(),
            status: document.getElementById('action-status').value,
            priority: document.getElementById('action-priority').value,
            notes: document.getElementById('action-notes').value.trim(),
            createdAt: actionData?.createdAt || new Date().toISOString(),
            updatedAt: new Date().toISOString()
        };
        
        Loading.show();
        try {
            if (actionData) {
                const index = AppState.appData.actionTrackingRegister.findIndex(a => a.id === actionData.id);
                if (index !== -1) AppState.appData.actionTrackingRegister[index] = formData;
            } else {
                AppState.appData.actionTrackingRegister.push(formData);
            }
            DataManager.save();
            // Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙÙŠ Google Sheets
            await GoogleIntegration.autoSave('ActionTrackingRegister', AppState.appData.actionTrackingRegister);
            Loading.hide();
            Notification.success(`ØªÙ… ${actionData ? 'ØªØ­Ø¯ÙŠØ«' : 'Ø¥Ø¶Ø§ÙØ©'} Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø¨Ù†Ø¬Ø§Ø­`);
            modal.remove();
            await this.load();
        } catch (error) {
            Loading.hide();
            Notification.error('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
        }
    },

    async editEntry(id) {
        const action = AppState.appData.actionTrackingRegister.find(a => a.id === id);
        if (!action) {
            Notification.error('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡');
            return;
        }
        await this.showActionForm(action);
    },

    async deleteEntry(id) {
        if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ØŸ')) return;
        
        Loading.show();
        try {
            AppState.appData.actionTrackingRegister = AppState.appData.actionTrackingRegister.filter(a => a.id !== id);
            DataManager.save();
            // Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙÙŠ Google Sheets
            await GoogleIntegration.autoSave('ActionTrackingRegister', AppState.appData.actionTrackingRegister);
            Loading.hide();
            Notification.success('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø¨Ù†Ø¬Ø§Ø­');
            await this.load();
        } catch (error) {
            Loading.hide();
            Notification.error('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
        }
    },

    async viewAction(id) {
        const action = AppState.appData.actionTrackingRegister.find(a => a.id === id);
        if (!action) {
            Notification.error('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡');
            return;
        }
        
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 700px;">
                <div class="modal-header">
                    <h2 class="modal-title">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</h2>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm font-semibold text-gray-600">Ø±Ù‚Ù… Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡:</label>
                                <p class="text-gray-800">${Utils.escapeHTML(action.id || '')}</p>
                            </div>
                            <div>
                                <label class="text-sm font-semibold text-gray-600">Ø§Ù„Ù†ÙˆØ¹:</label>
                                <p class="text-gray-800">
                                    <span class="badge badge-info">${Utils.escapeHTML(action.type || '')}</span>
                                </p>
                            </div>
                            <div>
                                <label class="text-sm font-semibold text-gray-600">Ø§Ù„Ù…ØµØ¯Ø±:</label>
                                <p class="text-gray-800">${Utils.escapeHTML(action.source || '')}</p>
                            </div>
                            <div>
                                <label class="text-sm font-semibold text-gray-600">Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„:</label>
                                <p class="text-gray-800">${Utils.escapeHTML(action.responsible || '')}</p>
                            </div>
                            <div>
                                <label class="text-sm font-semibold text-gray-600">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚:</label>
                                <p class="text-gray-800">${action.dueDate ? Utils.formatDate(action.dueDate) : '-'}</p>
                            </div>
                            <div>
                                <label class="text-sm font-semibold text-gray-600">Ø§Ù„Ø­Ø§Ù„Ø©:</label>
                                <p class="text-gray-800">
                                    <span class="badge badge-${action.status === 'Ù…ÙƒØªÙ…Ù„' ? 'success' : action.status === 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°' ? 'warning' : action.status === 'Ù…ØºÙ„Ù‚' ? 'secondary' : 'info'}">
                                        ${Utils.escapeHTML(action.status || '')}
                                    </span>
                                </p>
                            </div>
                            <div>
                                <label class="text-sm font-semibold text-gray-600">Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©:</label>
                                <p class="text-gray-800">
                                    <span class="badge badge-${action.priority === 'Ø¹Ø§Ù„ÙŠ' ? 'danger' : action.priority === 'Ù…ØªÙˆØ³Ø·' ? 'warning' : 'info'}">
                                        ${Utils.escapeHTML(action.priority || '')}
                                    </span>
                                </p>
                            </div>
                            <div>
                                <label class="text-sm font-semibold text-gray-600">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡:</label>
                                <p class="text-gray-800">${action.createdAt ? Utils.formatDate(action.createdAt) : '-'}</p>
                            </div>
                            <div class="col-span-2">
                                <label class="text-sm font-semibold text-gray-600">Ø§Ù„ÙˆØµÙ:</label>
                                <p class="text-gray-800">${Utils.escapeHTML(action.description || '')}</p>
                            </div>
                            ${action.notes ? `
                                <div class="col-span-2">
                                    <label class="text-sm font-semibold text-gray-600">Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</label>
                                    <p class="text-gray-800">${Utils.escapeHTML(action.notes || '')}</p>
                                </div>
                            ` : ''}
                        </div>
                        <div class="flex items-center justify-end gap-4 pt-4 border-t">
                            <button type="button" class="btn-secondary" onclick="this.closest('.modal-overlay').remove()">Ø¥ØºÙ„Ø§Ù‚</button>
                            <button type="button" class="btn-primary" onclick="ActionTrackingRegister.editEntry('${action.id}'); this.closest('.modal-overlay').remove();">
                                <i class="fas fa-edit ml-2"></i>ØªØ¹Ø¯ÙŠÙ„
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
        });
    }
};

// ===== Environmental Sustainability Module (Ø§Ù„Ø§Ø³ØªØ¯Ø§Ù…Ø© Ø§Ù„Ø¨ÙŠØ¦ÙŠØ©) =====
const Sustainability = {
    currentTab: 'initiatives',
    
    async load() {
        const section = document.getElementById('sustainability-section');
        if (!section) return;

        section.innerHTML = `
            <div class="section-header">
                <h1 class="section-title">
                    <i class="fas fa-leaf ml-3"></i>
                    Ø§Ù„Ø§Ø³ØªØ¯Ø§Ù…Ø© Ø§Ù„Ø¨ÙŠØ¦ÙŠØ©
                </h1>
                <p class="section-subtitle">Ø¥Ø¯Ø§Ø±Ø© Ù…Ø¨Ø§Ø¯Ø±Ø§Øª Ø§Ù„Ø§Ø³ØªØ¯Ø§Ù…Ø© Ø§Ù„Ø¨ÙŠØ¦ÙŠØ© ÙˆØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø£Ø¯Ø§Ø¡</p>
            </div>
            
            <div class="mt-6 grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-green-50 border border-green-200 rounded-lg p-4 text-center hover:shadow-md transition-shadow">
                    <div class="text-3xl font-bold text-green-600 mb-2">${(AppState.appData.sustainability || []).length}</div>
                    <div class="text-sm text-gray-700 font-semibold"><i class="fas fa-seedling ml-1"></i>Ø§Ù„Ù…Ø¨Ø§Ø¯Ø±Ø§Øª</div>
                </div>
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-center hover:shadow-md transition-shadow cursor-pointer" onclick="Sustainability.showCarbonFootprintTab()">
                    <div class="text-3xl font-bold text-blue-600 mb-2">${this.calculateTotalCarbonFootprint()} Ø·Ù†</div>
                    <div class="text-sm text-gray-700 font-semibold"><i class="fas fa-cloud ml-1"></i>Ø§Ù„Ø¨ØµÙ…Ø© Ø§Ù„ÙƒØ±Ø¨ÙˆÙ†ÙŠØ©</div>
                </div>
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 text-center hover:shadow-md transition-shadow cursor-pointer" onclick="Sustainability.showEnergyEfficiencyTab()">
                    <div class="text-3xl font-bold text-yellow-600 mb-2">${this.calculateEnergyEfficiency()}%</div>
                    <div class="text-sm text-gray-700 font-semibold"><i class="fas fa-bolt ml-1"></i>ÙƒÙØ§Ø¡Ø© Ø§Ù„Ø·Ø§Ù‚Ø©</div>
                </div>
                <div class="bg-purple-50 border border-purple-200 rounded-lg p-4 text-center hover:shadow-md transition-shadow cursor-pointer" onclick="Sustainability.showRecyclingTab()">
                    <div class="text-3xl font-bold text-purple-600 mb-2">${this.calculateRecyclingRate()}%</div>
                    <div class="text-sm text-gray-700 font-semibold"><i class="fas fa-recycle ml-1"></i>Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¯ÙˆÙŠØ±</div>
                </div>
            </div>

            <div class="mt-6">
                <div class="flex gap-2 mb-6 border-b">
                    <button class="tab-btn ${this.currentTab === 'initiatives' ? 'active' : ''}" data-tab="initiatives">
                        <i class="fas fa-seedling ml-2"></i>Ù…Ø¨Ø§Ø¯Ø±Ø§Øª Ø§Ù„Ø§Ø³ØªØ¯Ø§Ù…Ø©
                    </button>
                    <button class="tab-btn ${this.currentTab === 'carbon' ? 'active' : ''}" data-tab="carbon">
                        <i class="fas fa-cloud ml-2"></i>Ø§Ù„Ø¨ØµÙ…Ø© Ø§Ù„ÙƒØ±Ø¨ÙˆÙ†ÙŠØ©
                    </button>
                    <button class="tab-btn ${this.currentTab === 'waste' ? 'active' : ''}" data-tab="waste">
                        <i class="fas fa-trash-alt ml-2"></i>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†ÙØ§ÙŠØ§Øª
                    </button>
                    <button class="tab-btn ${this.currentTab === 'energy' ? 'active' : ''}" data-tab="energy">
                        <i class="fas fa-bolt ml-2"></i>ÙƒÙØ§Ø¡Ø© Ø§Ù„Ø·Ø§Ù‚Ø©
                    </button>
                    <button class="tab-btn ${this.currentTab === 'water' ? 'active' : ''}" data-tab="water">
                        <i class="fas fa-tint ml-2"></i>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙŠØ§Ù‡
                    </button>
                    <button class="tab-btn ${this.currentTab === 'recycling' ? 'active' : ''}" data-tab="recycling">
                        <i class="fas fa-recycle ml-2"></i>Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¯ÙˆÙŠØ±
                    </button>
                </div>
                <div id="sustainability-content">
                    ${await this.renderContent()}
                </div>
            </div>
        `;
        this.setupEventListeners();
    },

    setupEventListeners() {
        setTimeout(() => {
            const tabs = document.querySelectorAll('#sustainability-section .tab-btn');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    this.currentTab = tab.getAttribute('data-tab');
                    this.load();
                });
            });

            const addBtn = document.getElementById('add-sustainability-initiative-btn');
            if (addBtn) addBtn.addEventListener('click', () => this.showInitiativeForm());
        }, 100);
    },

    async renderContent() {
        switch(this.currentTab) {
            case 'initiatives':
                return await this.renderInitiativesTab();
            case 'carbon':
                return await this.renderCarbonFootprintTab();
            case 'waste':
                return await this.renderWasteManagementTab();
            case 'energy':
                return await this.renderEnergyEfficiencyTab();
            case 'water':
                return await this.renderWaterManagementTab();
            case 'recycling':
                return await this.renderRecyclingTab();
            default:
                return await this.renderInitiativesTab();
        }
    },

    calculateTotalCarbonFootprint() {
        const carbonData = AppState.appData.carbonFootprint || [];
        const total = carbonData.reduce((sum, record) => sum + (parseFloat(record.co2Equivalent) || 0), 0);
        return total.toFixed(2);
    },

    calculateEnergyEfficiency() {
        const energyData = AppState.appData.energyEfficiency || [];
        if (energyData.length === 0) return '0';
        const avgEfficiency = energyData.reduce((sum, record) => sum + (parseFloat(record.efficiencyPercentage) || 0), 0) / energyData.length;
        return avgEfficiency.toFixed(1);
    },

    calculateRecyclingRate() {
        const recyclingData = AppState.appData.recyclingPrograms || [];
        if (recyclingData.length === 0) return '0';
        const avgRate = recyclingData.reduce((sum, record) => sum + (parseFloat(record.recyclingRate) || 0), 0) / recyclingData.length;
        return avgRate.toFixed(1);
    },

    showCarbonFootprintTab() {
        this.currentTab = 'carbon';
        this.load();
    },

    showEnergyEfficiencyTab() {
        this.currentTab = 'energy';
        this.load();
    },

    showRecyclingTab() {
        this.currentTab = 'recycling';
        this.load();
    },

    async renderInitiativesTab() {
        const initiatives = AppState.appData.sustainability || [];
        return `
            <div class="content-card">
                <div class="card-header">
                    <div class="flex items-center justify-between">
                        <h2 class="card-title"><i class="fas fa-seedling ml-2"></i>Ù…Ø¨Ø§Ø¯Ø±Ø§Øª Ø§Ù„Ø§Ø³ØªØ¯Ø§Ù…Ø©</h2>
                        <button id="add-sustainability-initiative-btn" class="btn-primary">
                            <i class="fas fa-plus ml-2"></i>Ø¥Ø¶Ø§ÙØ© Ù…Ø¨Ø§Ø¯Ø±Ø© Ø¬Ø¯ÙŠØ¯Ø©
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    ${initiatives.length === 0 ? `
                        <div class="empty-state">
                            <i class="fas fa-seedling text-4xl text-green-400 mb-4"></i>
                            <p class="text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨Ø§Ø¯Ø±Ø§Øª Ø§Ø³ØªØ¯Ø§Ù…Ø© Ø­Ø§Ù„ÙŠØ§Ù‹. Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ø¶Ø§ÙØ© Ù…Ø¨Ø§Ø¯Ø±Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©.</p>
                        </div>
                    ` : `
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø¨Ø§Ø¯Ø±Ø©</th>
                                    <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡</th>
                                    <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                    <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${initiatives.map(init => `
                                    <tr>
                                        <td>${Utils.escapeHTML(init.name || '')}</td>
                                        <td>${Utils.formatDate(init.startDate)}</td>
                                        <td><span class="badge badge-${init.status === 'Ù…ÙƒØªÙ…Ù„Ø©' ? 'success' : init.status === 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°' ? 'warning' : 'info'}">${init.status}</span></td>
                                        <td>
                                            <button onclick="Sustainability.viewInitiative('${init.id}')" class="btn-icon btn-icon-info"><i class="fas fa-eye"></i></button>
                                            <button onclick="Sustainability.editInitiative('${init.id}')" class="btn-icon btn-icon-primary"><i class="fas fa-edit"></i></button>
                                            <button onclick="Sustainability.deleteInitiative('${init.id}')" class="btn-icon btn-icon-danger"><i class="fas fa-trash"></i></button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `}
                </div>
            </div>
        `;
    },

    async renderCarbonFootprintTab() {
        const carbonData = AppState.appData.carbonFootprint || [];
        return `
            <div class="content-card">
                <div class="card-header">
                    <div class="flex items-center justify-between">
                        <h2 class="card-title"><i class="fas fa-cloud ml-2"></i>Ø§Ù„Ø¨ØµÙ…Ø© Ø§Ù„ÙƒØ±Ø¨ÙˆÙ†ÙŠØ©</h2>
                        <button class="btn-primary" onclick="Sustainability.showCarbonFootprintForm()">
                            <i class="fas fa-plus ml-2"></i>Ø¥Ø¶Ø§ÙØ© Ù‚ÙŠØ§Ø³
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <p class="text-gray-700 mb-4">
                        <i class="fas fa-info-circle ml-2 text-blue-600"></i>
                        ØªØªØ¨Ø¹ Ø§Ù„Ø¨ØµÙ…Ø© Ø§Ù„ÙƒØ±Ø¨ÙˆÙ†ÙŠØ© Ù„Ù…ØµÙ†Ø¹ Ø§Ù„ØµÙ†Ø§Ø¹Ø§Øª Ø§Ù„ØºØ°Ø§Ø¦ÙŠØ© ÙŠØ³Ø§Ø¹Ø¯ ÙÙŠ ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø§Ù†Ø¨Ø¹Ø§Ø«Ø§Øª ÙˆØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø¨ÙŠØ¦ÙŠ.
                    </p>
                    ${carbonData.length === 0 ? `
                        <div class="empty-state">
                            <i class="fas fa-cloud text-4xl text-blue-400 mb-4"></i>
                            <p class="text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¨ØµÙ…Ø© Ø§Ù„ÙƒØ±Ø¨ÙˆÙ†ÙŠØ©. Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ø¶Ø§ÙØ© Ù‚ÙŠØ§Ø³Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©.</p>
                        </div>
                    ` : `
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                    <th>Ø§Ù„Ù…ØµØ¯Ø±</th>
                                    <th>ÙƒÙ…ÙŠØ© CO2 (Ø·Ù†)</th>
                                    <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${carbonData.map(record => `
                                    <tr>
                                        <td>${Utils.formatDate(record.date)}</td>
                                        <td>${Utils.escapeHTML(record.source || '')}</td>
                                        <td>${parseFloat(record.co2Equivalent || 0).toFixed(2)}</td>
                                        <td>
                                            <button onclick="Sustainability.viewCarbonFootprint('${record.id}')" class="btn-icon btn-icon-info"><i class="fas fa-eye"></i></button>
                                            <button onclick="Sustainability.editCarbonFootprint('${record.id}')" class="btn-icon btn-icon-primary"><i class="fas fa-edit"></i></button>
                                            <button onclick="Sustainability.deleteCarbonFootprint('${record.id}')" class="btn-icon btn-icon-danger"><i class="fas fa-trash"></i></button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `}
                </div>
            </div>
        `;
    },

    async renderWasteManagementTab() {
        const wasteData = AppState.appData.wasteManagement || [];
        return `
            <div class="content-card">
                <div class="card-header">
                    <div class="flex items-center justify-between">
                        <h2 class="card-title"><i class="fas fa-trash-alt ml-2"></i>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†ÙØ§ÙŠØ§Øª</h2>
                        <button class="btn-primary" onclick="Sustainability.showWasteManagementForm()">
                            <i class="fas fa-plus ml-2"></i>Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <p class="text-gray-700 mb-4">
                        <i class="fas fa-info-circle ml-2 text-green-600"></i>
                        Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†ÙØ§ÙŠØ§Øª ÙÙŠ Ù…ØµÙ†Ø¹ Ø§Ù„ØµÙ†Ø§Ø¹Ø§Øª Ø§Ù„ØºØ°Ø§Ø¦ÙŠØ© ØªØ´Ù…Ù„ Ø§Ù„Ù†ÙØ§ÙŠØ§Øª Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©ØŒ Ø§Ù„Ø¨Ù„Ø§Ø³ØªÙŠÙƒØŒ Ø§Ù„Ø²Ø¬Ø§Ø¬ØŒ ÙˆØ§Ù„ÙˆØ±Ù‚.
                    </p>
                    ${wasteData.length === 0 ? `
                        <div class="empty-state">
                            <i class="fas fa-trash-alt text-4xl text-green-400 mb-4"></i>
                            <p class="text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†ÙØ§ÙŠØ§Øª. Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©.</p>
                        </div>
                    ` : `
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                    <th>Ù†ÙˆØ¹ Ø§Ù„Ù†ÙØ§ÙŠØ©</th>
                                    <th>Ø§Ù„ÙƒÙ…ÙŠØ© (ÙƒØ¬Ù…)</th>
                                    <th>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</th>
                                    <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${wasteData.map(record => `
                                    <tr>
                                        <td>${Utils.formatDate(record.date)}</td>
                                        <td>${Utils.escapeHTML(record.wasteType || '')}</td>
                                        <td>${parseFloat(record.quantity || 0).toFixed(2)}</td>
                                        <td>${Utils.escapeHTML(record.disposalMethod || '')}</td>
                                            <td>
                                                <button onclick="Sustainability.viewWasteManagement('${record.id}')" class="btn-icon btn-icon-info"><i class="fas fa-eye"></i></button>
                                                <button onclick="Sustainability.editWasteManagement('${record.id}')" class="btn-icon btn-icon-primary"><i class="fas fa-edit"></i></button>
                                                <button onclick="Sustainability.deleteWasteManagement('${record.id}')" class="btn-icon btn-icon-danger"><i class="fas fa-trash"></i></button>
                                            </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `}
                </div>
            </div>
        `;
    },

    async renderEnergyEfficiencyTab() {
        const energyData = AppState.appData.energyEfficiency || [];
        return `
            <div class="content-card">
                <div class="card-header">
                    <div class="flex items-center justify-between">
                        <h2 class="card-title"><i class="fas fa-bolt ml-2"></i>ÙƒÙØ§Ø¡Ø© Ø§Ù„Ø·Ø§Ù‚Ø©</h2>
                        <button class="btn-primary" onclick="Sustainability.showEnergyEfficiencyForm()">
                            <i class="fas fa-plus ml-2"></i>Ø¥Ø¶Ø§ÙØ© Ù‚ÙŠØ§Ø³
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <p class="text-gray-700 mb-4">
                        <i class="fas fa-info-circle ml-2 text-yellow-600"></i>
                        Ù…Ø±Ø§Ù‚Ø¨Ø© ÙƒÙØ§Ø¡Ø© Ø§Ù„Ø·Ø§Ù‚Ø© ÙÙŠ Ø®Ø·ÙˆØ· Ø§Ù„Ø¥Ù†ØªØ§Ø¬ ÙˆØ§Ù„Ù…Ø±Ø§ÙÙ‚ ÙŠØ³Ø§Ø¹Ø¯ ÙÙŠ ØªÙ‚Ù„ÙŠÙ„ Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ Ø§Ù„Ø·Ø§Ù‚Ø© ÙˆØ§Ù„ØªÙƒØ§Ù„ÙŠÙ.
                    </p>
                    ${energyData.length === 0 ? `
                        <div class="empty-state">
                            <i class="fas fa-bolt text-4xl text-yellow-400 mb-4"></i>
                            <p class="text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„ÙƒÙØ§Ø¡Ø© Ø§Ù„Ø·Ø§Ù‚Ø©. Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ø¶Ø§ÙØ© Ù‚ÙŠØ§Ø³Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©.</p>
                        </div>
                    ` : `
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                    <th>Ø§Ù„Ù‚Ø³Ù…/Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</th>
                                    <th>Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ Ø§Ù„Ø·Ø§Ù‚Ø© (ÙƒÙŠÙ„ÙˆÙˆØ§Øª)</th>
                                    <th>Ø§Ù„ÙƒÙØ§Ø¡Ø© (%)</th>
                                    <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${energyData.map(record => `
                                    <tr>
                                        <td>${Utils.formatDate(record.date)}</td>
                                        <td>${Utils.escapeHTML(record.department || '')}</td>
                                        <td>${parseFloat(record.energyConsumption || 0).toFixed(2)}</td>
                                        <td><span class="badge badge-${parseFloat(record.efficiencyPercentage) >= 80 ? 'success' : parseFloat(record.efficiencyPercentage) >= 60 ? 'warning' : 'danger'}">${parseFloat(record.efficiencyPercentage || 0).toFixed(1)}%</span></td>
                                            <td>
                                                <button onclick="Sustainability.viewEnergyEfficiency('${record.id}')" class="btn-icon btn-icon-info"><i class="fas fa-eye"></i></button>
                                                <button onclick="Sustainability.editEnergyEfficiency('${record.id}')" class="btn-icon btn-icon-primary"><i class="fas fa-edit"></i></button>
                                                <button onclick="Sustainability.deleteEnergyEfficiency('${record.id}')" class="btn-icon btn-icon-danger"><i class="fas fa-trash"></i></button>
                                            </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `}
                </div>
            </div>
        `;
    },

    async renderWaterManagementTab() {
        const waterData = AppState.appData.waterManagement || [];
        return `
            <div class="content-card">
                <div class="card-header">
                    <div class="flex items-center justify-between">
                        <h2 class="card-title"><i class="fas fa-tint ml-2"></i>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙŠØ§Ù‡</h2>
                        <button class="btn-primary" onclick="Sustainability.showWaterManagementForm()">
                            <i class="fas fa-plus ml-2"></i>Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <p class="text-gray-700 mb-4">
                        <i class="fas fa-info-circle ml-2 text-blue-600"></i>
                        Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙŠØ§Ù‡ ÙÙŠ Ù…ØµÙ†Ø¹ Ø§Ù„ØµÙ†Ø§Ø¹Ø§Øª Ø§Ù„ØºØ°Ø§Ø¦ÙŠØ© ØªØ´Ù…Ù„ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø§Ø³ØªÙ‡Ù„Ø§ÙƒØŒ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¯ÙˆÙŠØ±ØŒ ÙˆÙ…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…ÙŠØ§Ù‡ Ø§Ù„Ø¹Ø§Ø¯Ù…Ø©.
                    </p>
                    ${waterData.length === 0 ? `
                        <div class="empty-state">
                            <i class="fas fa-tint text-4xl text-blue-400 mb-4"></i>
                            <p class="text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙŠØ§Ù‡. Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©.</p>
                        </div>
                    ` : `
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                    <th>Ù†ÙˆØ¹ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…</th>
                                    <th>Ø§Ù„ÙƒÙ…ÙŠØ© (Ù…Â³)</th>
                                    <th>Ù…ØµØ¯Ø± Ø§Ù„Ù…Ø§Ø¡</th>
                                    <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${waterData.map(record => `
                                    <tr>
                                        <td>${Utils.formatDate(record.date)}</td>
                                        <td>${Utils.escapeHTML(record.usageType || '')}</td>
                                        <td>${parseFloat(record.quantity || 0).toFixed(2)}</td>
                                        <td>${Utils.escapeHTML(record.waterSource || '')}</td>
                                            <td>
                                                <button onclick="Sustainability.viewWaterManagement('${record.id}')" class="btn-icon btn-icon-info"><i class="fas fa-eye"></i></button>
                                                <button onclick="Sustainability.editWaterManagement('${record.id}')" class="btn-icon btn-icon-primary"><i class="fas fa-edit"></i></button>
                                                <button onclick="Sustainability.deleteWaterManagement('${record.id}')" class="btn-icon btn-icon-danger"><i class="fas fa-trash"></i></button>
                                            </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `}
                </div>
            </div>
        `;
    },

    async renderRecyclingTab() {
        const recyclingData = AppState.appData.recyclingPrograms || [];
        return `
            <div class="content-card">
                <div class="card-header">
                    <div class="flex items-center justify-between">
                        <h2 class="card-title"><i class="fas fa-recycle ml-2"></i>Ø¨Ø±Ø§Ù…Ø¬ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¯ÙˆÙŠØ±</h2>
                        <button class="btn-primary" onclick="Sustainability.showRecyclingForm()">
                            <i class="fas fa-plus ml-2"></i>Ø¥Ø¶Ø§ÙØ© Ø¨Ø±Ù†Ø§Ù…Ø¬
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <p class="text-gray-700 mb-4">
                        <i class="fas fa-info-circle ml-2 text-purple-600"></i>
                        Ø¨Ø±Ø§Ù…Ø¬ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¯ÙˆÙŠØ± ØªØ´Ù…Ù„ ØªØ¯ÙˆÙŠØ± Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø®Ø§Ù…ØŒ Ø§Ù„Ù†ÙØ§ÙŠØ§Øª Ø§Ù„Ù‚Ø§Ø¨Ù„Ø© Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¯ÙˆÙŠØ±ØŒ ÙˆØ§Ù„ØªÙ‚Ù„ÙŠÙ„ Ù…Ù† Ø§Ù„Ù‡Ø¯Ø± ÙÙŠ Ø§Ù„Ø¥Ù†ØªØ§Ø¬.
                    </p>
                    ${recyclingData.length === 0 ? `
                        <div class="empty-state">
                            <i class="fas fa-recycle text-4xl text-purple-400 mb-4"></i>
                            <p class="text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ø±Ø§Ù…Ø¬ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¯ÙˆÙŠØ±. Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ø¶Ø§ÙØ© Ø¨Ø±Ø§Ù…Ø¬ Ø¬Ø¯ÙŠØ¯Ø©.</p>
                        </div>
                    ` : `
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Ø§Ø³Ù… Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬</th>
                                    <th>Ù†ÙˆØ¹ Ø§Ù„Ù…ÙˆØ§Ø¯</th>
                                    <th>Ù†Ø³Ø¨Ø© Ø§Ù„ØªØ¯ÙˆÙŠØ± (%)</th>
                                    <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                    <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${recyclingData.map(record => `
                                    <tr>
                                        <td>${Utils.escapeHTML(record.programName || '')}</td>
                                        <td>${Utils.escapeHTML(record.materialType || '')}</td>
                                        <td><span class="badge badge-${parseFloat(record.recyclingRate) >= 50 ? 'success' : 'warning'}">${parseFloat(record.recyclingRate || 0).toFixed(1)}%</span></td>
                                        <td><span class="badge badge-${record.status === 'Ù†Ø´Ø·' ? 'success' : 'info'}">${record.status || ''}</span></td>
                                            <td>
                                                <button onclick="Sustainability.viewRecycling('${record.id}')" class="btn-icon btn-icon-info"><i class="fas fa-eye"></i></button>
                                                <button onclick="Sustainability.editRecycling('${record.id}')" class="btn-icon btn-icon-primary"><i class="fas fa-edit"></i></button>
                                                <button onclick="Sustainability.deleteRecycling('${record.id}')" class="btn-icon btn-icon-danger"><i class="fas fa-trash"></i></button>
                                            </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `}
                </div>
            </div>
        `;
    },

    async showCarbonFootprintForm(data = null) {
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h2 class="modal-title">${data ? 'ØªØ¹Ø¯ÙŠÙ„ Ù‚ÙŠØ§Ø³ Ø§Ù„Ø¨ØµÙ…Ø© Ø§Ù„ÙƒØ±Ø¨ÙˆÙ†ÙŠØ©' : 'Ø¥Ø¶Ø§ÙØ© Ù‚ÙŠØ§Ø³ Ø§Ù„Ø¨ØµÙ…Ø© Ø§Ù„ÙƒØ±Ø¨ÙˆÙ†ÙŠØ©'}</h2>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="carbon-footprint-form" class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„ØªØ§Ø±ÙŠØ® *</label>
                            <input type="date" id="carbon-date" required class="form-input" 
                                value="${data?.date ? new Date(data.date).toISOString().slice(0, 10) : ''}">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„Ù…ØµØ¯Ø± *</label>
                            <select id="carbon-source" required class="form-input">
                                <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…ØµØ¯Ø±</option>
                                <option value="Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ Ø§Ù„Ø·Ø§Ù‚Ø©" ${data?.source === 'Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ Ø§Ù„Ø·Ø§Ù‚Ø©' ? 'selected' : ''}>Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ Ø§Ù„Ø·Ø§Ù‚Ø©</option>
                                <option value="Ø§Ù„Ù†Ù‚Ù„ ÙˆØ§Ù„Ù…ÙˆØ§ØµÙ„Ø§Øª" ${data?.source === 'Ø§Ù„Ù†Ù‚Ù„ ÙˆØ§Ù„Ù…ÙˆØ§ØµÙ„Ø§Øª' ? 'selected' : ''}>Ø§Ù„Ù†Ù‚Ù„ ÙˆØ§Ù„Ù…ÙˆØ§ØµÙ„Ø§Øª</option>
                                <option value="Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ØµÙ†Ø§Ø¹ÙŠØ©" ${data?.source === 'Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ØµÙ†Ø§Ø¹ÙŠØ©' ? 'selected' : ''}>Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ØµÙ†Ø§Ø¹ÙŠØ©</option>
                                <option value="Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†ÙØ§ÙŠØ§Øª" ${data?.source === 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†ÙØ§ÙŠØ§Øª' ? 'selected' : ''}>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†ÙØ§ÙŠØ§Øª</option>
                                <option value="Ø£Ø®Ø±Ù‰" ${data?.source === 'Ø£Ø®Ø±Ù‰' ? 'selected' : ''}>Ø£Ø®Ø±Ù‰</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">ÙƒÙ…ÙŠØ© CO2 (Ø·Ù†) *</label>
                            <input type="number" id="carbon-co2" required step="0.01" class="form-input" 
                                value="${data?.co2Equivalent || ''}" placeholder="0.00">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„ÙˆØµÙ</label>
                            <textarea id="carbon-description" class="form-input" rows="3" 
                                placeholder="ÙˆØµÙ ØªÙØµÙŠÙ„ÙŠ">${Utils.escapeHTML(data?.description || '')}</textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="this.closest('.modal-overlay').remove()">Ø¥Ù„ØºØ§Ø¡</button>
                    <button type="button" id="save-carbon-btn" class="btn-primary">Ø­ÙØ¸</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);

        const saveBtn = modal.querySelector('#save-carbon-btn');
        saveBtn.addEventListener('click', () => this.handleCarbonFootprintSubmit(data?.id, modal));

        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
        });
    },

    async handleCarbonFootprintSubmit(editId = null, modal) {
        const formData = {
            id: editId || Utils.generateId('CARBON'),
            date: new Date(document.getElementById('carbon-date').value).toISOString(),
            source: document.getElementById('carbon-source').value,
            co2Equivalent: parseFloat(document.getElementById('carbon-co2').value),
            description: document.getElementById('carbon-description').value.trim(),
            createdAt: editId ? AppState.appData.carbonFootprint.find(c => c.id === editId)?.createdAt : new Date().toISOString(),
            updatedAt: new Date().toISOString()
        };

        if (!AppState.appData.carbonFootprint) {
            AppState.appData.carbonFootprint = [];
        }

        Loading.show();
        try {
            if (editId) {
                const index = AppState.appData.carbonFootprint.findIndex(c => c.id === editId);
                if (index !== -1) AppState.appData.carbonFootprint[index] = formData;
                Notification.success('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ÙŠØ§Ø³ Ø¨Ù†Ø¬Ø§Ø­');
            } else {
                AppState.appData.carbonFootprint.push(formData);
                Notification.success('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚ÙŠØ§Ø³ Ø¨Ù†Ø¬Ø§Ø­');
            }

            DataManager.save();
            await GoogleIntegration.autoSave('CarbonFootprint', AppState.appData.carbonFootprint);

            Loading.hide();
            modal.remove();
            this.load();
        } catch (error) {
            Loading.hide();
            Notification.error('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
        }
    },

    async viewCarbonFootprint(id) {
        const record = AppState.appData.carbonFootprint.find(c => c.id === id);
        if (!record) {
            Notification.error('Ø§Ù„Ù‚ÙŠØ§Ø³ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
            return;
        }
        
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h2 class="modal-title">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¨ØµÙ…Ø© Ø§Ù„ÙƒØ±Ø¨ÙˆÙ†ÙŠØ©</h2>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="space-y-3">
                        <div><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${Utils.formatDate(record.date)}</div>
                        <div><strong>Ø§Ù„Ù…ØµØ¯Ø±:</strong> ${Utils.escapeHTML(record.source)}</div>
                        <div><strong>ÙƒÙ…ÙŠØ© CO2:</strong> ${parseFloat(record.co2Equivalent || 0).toFixed(2)} Ø·Ù†</div>
                        <div><strong>Ø§Ù„ÙˆØµÙ:</strong> ${Utils.escapeHTML(record.description || '-')}</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="this.closest('.modal-overlay').remove()">Ø¥ØºÙ„Ø§Ù‚</button>
                    <button type="button" class="btn-primary" onclick="Sustainability.editCarbonFootprint('${record.id}'); this.closest('.modal-overlay').remove();">ØªØ¹Ø¯ÙŠÙ„</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
        });
    },

    async editCarbonFootprint(id) {
        const record = AppState.appData.carbonFootprint.find(c => c.id === id);
        if (!record) {
            Notification.error('Ø§Ù„Ù‚ÙŠØ§Ø³ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
            return;
        }
        this.showCarbonFootprintForm(record);
    },

    async deleteCarbonFootprint(id) {
        if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù‚ÙŠØ§Ø³ØŸ')) return;
        
        Loading.show();
        try {
            AppState.appData.carbonFootprint = AppState.appData.carbonFootprint.filter(c => c.id !== id);
            DataManager.save();
            await GoogleIntegration.autoSave('CarbonFootprint', AppState.appData.carbonFootprint);
            Notification.success('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù‚ÙŠØ§Ø³ Ø¨Ù†Ø¬Ø§Ø­');
            this.load();
        } catch (error) {
            Notification.error('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
        } finally {
            Loading.hide();
        }
    },

    async showWasteManagementForm(data = null) {
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h2 class="modal-title">${data ? 'ØªØ¹Ø¯ÙŠÙ„ Ø³Ø¬Ù„ Ø§Ù„Ù†ÙØ§ÙŠØ§Øª' : 'Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ Ø§Ù„Ù†ÙØ§ÙŠØ§Øª'}</h2>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="waste-management-form" class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„ØªØ§Ø±ÙŠØ® *</label>
                            <input type="date" id="waste-date" required class="form-input" 
                                value="${data?.date ? new Date(data.date).toISOString().slice(0, 10) : ''}">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ù†ÙˆØ¹ Ø§Ù„Ù†ÙØ§ÙŠØ© *</label>
                            <select id="waste-type" required class="form-input">
                                <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù†ÙˆØ¹</option>
                                <option value="Ù†ÙØ§ÙŠØ§Øª Ø¹Ø¶ÙˆÙŠØ©" ${data?.wasteType === 'Ù†ÙØ§ÙŠØ§Øª Ø¹Ø¶ÙˆÙŠØ©' ? 'selected' : ''}>Ù†ÙØ§ÙŠØ§Øª Ø¹Ø¶ÙˆÙŠØ©</option>
                                <option value="Ø¨Ù„Ø§Ø³ØªÙŠÙƒ" ${data?.wasteType === 'Ø¨Ù„Ø§Ø³ØªÙŠÙƒ' ? 'selected' : ''}>Ø¨Ù„Ø§Ø³ØªÙŠÙƒ</option>
                                <option value="Ø²Ø¬Ø§Ø¬" ${data?.wasteType === 'Ø²Ø¬Ø§Ø¬' ? 'selected' : ''}>Ø²Ø¬Ø§Ø¬</option>
                                <option value="ÙˆØ±Ù‚" ${data?.wasteType === 'ÙˆØ±Ù‚' ? 'selected' : ''}>ÙˆØ±Ù‚</option>
                                <option value="Ù…Ø¹Ø¯Ù†" ${data?.wasteType === 'Ù…Ø¹Ø¯Ù†' ? 'selected' : ''}>Ù…Ø¹Ø¯Ù†</option>
                                <option value="Ø£Ø®Ø±Ù‰" ${data?.wasteType === 'Ø£Ø®Ø±Ù‰' ? 'selected' : ''}>Ø£Ø®Ø±Ù‰</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„ÙƒÙ…ÙŠØ© (ÙƒØ¬Ù…) *</label>
                            <input type="number" id="waste-quantity" required step="0.01" class="form-input" 
                                value="${data?.quantity || ''}" placeholder="0.00">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© *</label>
                            <select id="waste-disposal" required class="form-input">
                                <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø·Ø±ÙŠÙ‚Ø©</option>
                                <option value="Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¯ÙˆÙŠØ±" ${data?.disposalMethod === 'Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¯ÙˆÙŠØ±' ? 'selected' : ''}>Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¯ÙˆÙŠØ±</option>
                                <option value="Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ Ø³Ù…Ø§Ø¯" ${data?.disposalMethod === 'Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ Ø³Ù…Ø§Ø¯' ? 'selected' : ''}>Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ Ø³Ù…Ø§Ø¯</option>
                                <option value="Ø§Ù„Ø­Ø±Ù‚" ${data?.disposalMethod === 'Ø§Ù„Ø­Ø±Ù‚' ? 'selected' : ''}>Ø§Ù„Ø­Ø±Ù‚</option>
                                <option value="Ø§Ù„Ø·Ù…Ø± Ø§Ù„ØµØ­ÙŠ" ${data?.disposalMethod === 'Ø§Ù„Ø·Ù…Ø± Ø§Ù„ØµØ­ÙŠ' ? 'selected' : ''}>Ø§Ù„Ø·Ù…Ø± Ø§Ù„ØµØ­ÙŠ</option>
                                <option value="Ø£Ø®Ø±Ù‰" ${data?.disposalMethod === 'Ø£Ø®Ø±Ù‰' ? 'selected' : ''}>Ø£Ø®Ø±Ù‰</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="this.closest('.modal-overlay').remove()">Ø¥Ù„ØºØ§Ø¡</button>
                    <button type="button" id="save-waste-btn" class="btn-primary">Ø­ÙØ¸</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);

        const saveBtn = modal.querySelector('#save-waste-btn');
        saveBtn.addEventListener('click', () => this.handleWasteManagementSubmit(data?.id, modal));

        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
        });
    },

    async handleWasteManagementSubmit(editId = null, modal) {
        const formData = {
            id: editId || Utils.generateId('WASTE'),
            date: new Date(document.getElementById('waste-date').value).toISOString(),
            wasteType: document.getElementById('waste-type').value,
            quantity: parseFloat(document.getElementById('waste-quantity').value),
            disposalMethod: document.getElementById('waste-disposal').value,
            createdAt: editId ? AppState.appData.wasteManagement.find(w => w.id === editId)?.createdAt : new Date().toISOString(),
            updatedAt: new Date().toISOString()
        };

        if (!AppState.appData.wasteManagement) {
            AppState.appData.wasteManagement = [];
        }

        Loading.show();
        try {
            if (editId) {
                const index = AppState.appData.wasteManagement.findIndex(w => w.id === editId);
                if (index !== -1) AppState.appData.wasteManagement[index] = formData;
                Notification.success('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¬Ù„ Ø¨Ù†Ø¬Ø§Ø­');
            } else {
                AppState.appData.wasteManagement.push(formData);
                Notification.success('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø¬Ù„ Ø¨Ù†Ø¬Ø§Ø­');
            }

            DataManager.save();
            await GoogleIntegration.autoSave('WasteManagement', AppState.appData.wasteManagement);

            Loading.hide();
            modal.remove();
            this.load();
        } catch (error) {
            Loading.hide();
            Notification.error('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
        }
    },

    async viewWasteManagement(id) {
        const record = AppState.appData.wasteManagement.find(w => w.id === id);
        if (!record) {
            Notification.error('Ø§Ù„Ø³Ø¬Ù„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
            return;
        }
        
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h2 class="modal-title">ØªÙØ§ØµÙŠÙ„ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†ÙØ§ÙŠØ§Øª</h2>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="space-y-3">
                        <div><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${Utils.formatDate(record.date)}</div>
                        <div><strong>Ù†ÙˆØ¹ Ø§Ù„Ù†ÙØ§ÙŠØ©:</strong> ${Utils.escapeHTML(record.wasteType)}</div>
                        <div><strong>Ø§Ù„ÙƒÙ…ÙŠØ©:</strong> ${parseFloat(record.quantity || 0).toFixed(2)} ÙƒØ¬Ù…</div>
                        <div><strong>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©:</strong> ${Utils.escapeHTML(record.disposalMethod)}</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="this.closest('.modal-overlay').remove()">Ø¥ØºÙ„Ø§Ù‚</button>
                    <button type="button" class="btn-primary" onclick="Sustainability.editWasteManagement('${record.id}'); this.closest('.modal-overlay').remove();">ØªØ¹Ø¯ÙŠÙ„</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
        });
    },

    async editWasteManagement(id) {
        const record = AppState.appData.wasteManagement.find(w => w.id === id);
        if (!record) {
            Notification.error('Ø§Ù„Ø³Ø¬Ù„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
            return;
        }
        this.showWasteManagementForm(record);
    },

    async deleteWasteManagement(id) {
        if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„ØŸ')) return;
        
        Loading.show();
        try {
            AppState.appData.wasteManagement = AppState.appData.wasteManagement.filter(w => w.id !== id);
            DataManager.save();
            await GoogleIntegration.autoSave('WasteManagement', AppState.appData.wasteManagement);
            Notification.success('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ Ø¨Ù†Ø¬Ø§Ø­');
            this.load();
        } catch (error) {
            Notification.error('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
        } finally {
            Loading.hide();
        }
    },

    async showEnergyEfficiencyForm(data = null) {
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h2 class="modal-title">${data ? 'ØªØ¹Ø¯ÙŠÙ„ Ù‚ÙŠØ§Ø³ ÙƒÙØ§Ø¡Ø© Ø§Ù„Ø·Ø§Ù‚Ø©' : 'Ø¥Ø¶Ø§ÙØ© Ù‚ÙŠØ§Ø³ ÙƒÙØ§Ø¡Ø© Ø§Ù„Ø·Ø§Ù‚Ø©'}</h2>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="energy-efficiency-form" class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„ØªØ§Ø±ÙŠØ® *</label>
                            <input type="date" id="energy-date" required class="form-input" 
                                value="${data?.date ? new Date(data.date).toISOString().slice(0, 10) : ''}">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„Ù‚Ø³Ù…/Ø§Ù„Ù…Ù†Ø·Ù‚Ø© *</label>
                            <input type="text" id="energy-department" required class="form-input" 
                                value="${Utils.escapeHTML(data?.department || '')}" placeholder="Ù…Ø«Ø§Ù„: Ø®Ø· Ø§Ù„Ø¥Ù†ØªØ§Ø¬ 1">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ Ø§Ù„Ø·Ø§Ù‚Ø© (ÙƒÙŠÙ„ÙˆÙˆØ§Øª) *</label>
                            <input type="number" id="energy-consumption" required step="0.01" class="form-input" 
                                value="${data?.energyConsumption || ''}" placeholder="0.00">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„ÙƒÙØ§Ø¡Ø© (%) *</label>
                            <input type="number" id="energy-efficiency" required step="0.1" min="0" max="100" class="form-input" 
                                value="${data?.efficiencyPercentage || ''}" placeholder="0.0">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                            <textarea id="energy-notes" class="form-input" rows="3" 
                                placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©">${Utils.escapeHTML(data?.notes || '')}</textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="this.closest('.modal-overlay').remove()">Ø¥Ù„ØºØ§Ø¡</button>
                    <button type="button" id="save-energy-btn" class="btn-primary">Ø­ÙØ¸</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);

        const saveBtn = modal.querySelector('#save-energy-btn');
        saveBtn.addEventListener('click', () => this.handleEnergyEfficiencySubmit(data?.id, modal));

        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
        });
    },

    async handleEnergyEfficiencySubmit(editId = null, modal) {
        const formData = {
            id: editId || Utils.generateId('ENERGY'),
            date: new Date(document.getElementById('energy-date').value).toISOString(),
            department: document.getElementById('energy-department').value.trim(),
            energyConsumption: parseFloat(document.getElementById('energy-consumption').value),
            efficiencyPercentage: parseFloat(document.getElementById('energy-efficiency').value),
            notes: document.getElementById('energy-notes').value.trim(),
            createdAt: editId ? AppState.appData.energyEfficiency.find(e => e.id === editId)?.createdAt : new Date().toISOString(),
            updatedAt: new Date().toISOString()
        };

        if (!AppState.appData.energyEfficiency) {
            AppState.appData.energyEfficiency = [];
        }

        Loading.show();
        try {
            if (editId) {
                const index = AppState.appData.energyEfficiency.findIndex(e => e.id === editId);
                if (index !== -1) AppState.appData.energyEfficiency[index] = formData;
                Notification.success('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ÙŠØ§Ø³ Ø¨Ù†Ø¬Ø§Ø­');
            } else {
                AppState.appData.energyEfficiency.push(formData);
                Notification.success('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚ÙŠØ§Ø³ Ø¨Ù†Ø¬Ø§Ø­');
            }

            DataManager.save();
            await GoogleIntegration.autoSave('EnergyEfficiency', AppState.appData.energyEfficiency);

            Loading.hide();
            modal.remove();
            this.load();
        } catch (error) {
            Loading.hide();
            Notification.error('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
        }
    },

    async viewEnergyEfficiency(id) {
        const record = AppState.appData.energyEfficiency.find(e => e.id === id);
        if (!record) {
            Notification.error('Ø§Ù„Ù‚ÙŠØ§Ø³ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
            return;
        }
        
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h2 class="modal-title">ØªÙØ§ØµÙŠÙ„ ÙƒÙØ§Ø¡Ø© Ø§Ù„Ø·Ø§Ù‚Ø©</h2>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="space-y-3">
                        <div><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${Utils.formatDate(record.date)}</div>
                        <div><strong>Ø§Ù„Ù‚Ø³Ù…/Ø§Ù„Ù…Ù†Ø·Ù‚Ø©:</strong> ${Utils.escapeHTML(record.department)}</div>
                        <div><strong>Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ Ø§Ù„Ø·Ø§Ù‚Ø©:</strong> ${parseFloat(record.energyConsumption || 0).toFixed(2)} ÙƒÙŠÙ„ÙˆÙˆØ§Øª</div>
                        <div><strong>Ø§Ù„ÙƒÙØ§Ø¡Ø©:</strong> ${parseFloat(record.efficiencyPercentage || 0).toFixed(1)}%</div>
                        ${record.notes ? `<div><strong>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong> ${Utils.escapeHTML(record.notes)}</div>` : ''}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="this.closest('.modal-overlay').remove()">Ø¥ØºÙ„Ø§Ù‚</button>
                    <button type="button" class="btn-primary" onclick="Sustainability.editEnergyEfficiency('${record.id}'); this.closest('.modal-overlay').remove();">ØªØ¹Ø¯ÙŠÙ„</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
        });
    },

    async editEnergyEfficiency(id) {
        const record = AppState.appData.energyEfficiency.find(e => e.id === id);
        if (!record) {
            Notification.error('Ø§Ù„Ù‚ÙŠØ§Ø³ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
            return;
        }
        this.showEnergyEfficiencyForm(record);
    },

    async deleteEnergyEfficiency(id) {
        if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù‚ÙŠØ§Ø³ØŸ')) return;
        
        Loading.show();
        try {
            AppState.appData.energyEfficiency = AppState.appData.energyEfficiency.filter(e => e.id !== id);
            DataManager.save();
            await GoogleIntegration.autoSave('EnergyEfficiency', AppState.appData.energyEfficiency);
            Notification.success('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù‚ÙŠØ§Ø³ Ø¨Ù†Ø¬Ø§Ø­');
            this.load();
        } catch (error) {
            Notification.error('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
        } finally {
            Loading.hide();
        }
    },

    async showWaterManagementForm(data = null) {
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h2 class="modal-title">${data ? 'ØªØ¹Ø¯ÙŠÙ„ Ø³Ø¬Ù„ Ø§Ù„Ù…ÙŠØ§Ù‡' : 'Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ Ø§Ù„Ù…ÙŠØ§Ù‡'}</h2>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="water-management-form" class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„ØªØ§Ø±ÙŠØ® *</label>
                            <input type="date" id="water-date" required class="form-input" 
                                value="${data?.date ? new Date(data.date).toISOString().slice(0, 10) : ''}">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ù†ÙˆØ¹ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… *</label>
                            <select id="water-usage-type" required class="form-input">
                                <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù†ÙˆØ¹</option>
                                <option value="Ø§Ù„Ø¥Ù†ØªØ§Ø¬" ${data?.usageType === 'Ø§Ù„Ø¥Ù†ØªØ§Ø¬' ? 'selected' : ''}>Ø§Ù„Ø¥Ù†ØªØ§Ø¬</option>
                                <option value="Ø§Ù„ØªÙ†Ø¸ÙŠÙ" ${data?.usageType === 'Ø§Ù„ØªÙ†Ø¸ÙŠÙ' ? 'selected' : ''}>Ø§Ù„ØªÙ†Ø¸ÙŠÙ</option>
                                <option value="Ø§Ù„ØªØ¨Ø±ÙŠØ¯" ${data?.usageType === 'Ø§Ù„ØªØ¨Ø±ÙŠØ¯' ? 'selected' : ''}>Ø§Ù„ØªØ¨Ø±ÙŠØ¯</option>
                                <option value="Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¹Ø§Ù…" ${data?.usageType === 'Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¹Ø§Ù…' ? 'selected' : ''}>Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¹Ø§Ù…</option>
                                <option value="Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¯ÙˆÙŠØ±" ${data?.usageType === 'Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¯ÙˆÙŠØ±' ? 'selected' : ''}>Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¯ÙˆÙŠØ±</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„ÙƒÙ…ÙŠØ© (Ù…Â³) *</label>
                            <input type="number" id="water-quantity" required step="0.01" class="form-input" 
                                value="${data?.quantity || ''}" placeholder="0.00">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ù…ØµØ¯Ø± Ø§Ù„Ù…Ø§Ø¡ *</label>
                            <select id="water-source" required class="form-input">
                                <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…ØµØ¯Ø±</option>
                                <option value="Ø§Ù„Ø´Ø¨ÙƒØ© Ø§Ù„Ø¹Ø§Ù…Ø©" ${data?.waterSource === 'Ø§Ù„Ø´Ø¨ÙƒØ© Ø§Ù„Ø¹Ø§Ù…Ø©' ? 'selected' : ''}>Ø§Ù„Ø´Ø¨ÙƒØ© Ø§Ù„Ø¹Ø§Ù…Ø©</option>
                                <option value="Ø§Ù„Ø¢Ø¨Ø§Ø±" ${data?.waterSource === 'Ø§Ù„Ø¢Ø¨Ø§Ø±' ? 'selected' : ''}>Ø§Ù„Ø¢Ø¨Ø§Ø±</option>
                                <option value="Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¯ÙˆÙŠØ±" ${data?.waterSource === 'Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¯ÙˆÙŠØ±' ? 'selected' : ''}>Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¯ÙˆÙŠØ±</option>
                                <option value="Ø£Ø®Ø±Ù‰" ${data?.waterSource === 'Ø£Ø®Ø±Ù‰' ? 'selected' : ''}>Ø£Ø®Ø±Ù‰</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="this.closest('.modal-overlay').remove()">Ø¥Ù„ØºØ§Ø¡</button>
                    <button type="button" id="save-water-btn" class="btn-primary">Ø­ÙØ¸</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);

        const saveBtn = modal.querySelector('#save-water-btn');
        saveBtn.addEventListener('click', () => this.handleWaterManagementSubmit(data?.id, modal));

        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
        });
    },

    async handleWaterManagementSubmit(editId = null, modal) {
        const formData = {
            id: editId || Utils.generateId('WATER'),
            date: new Date(document.getElementById('water-date').value).toISOString(),
            usageType: document.getElementById('water-usage-type').value,
            quantity: parseFloat(document.getElementById('water-quantity').value),
            waterSource: document.getElementById('water-source').value,
            createdAt: editId ? AppState.appData.waterManagement.find(w => w.id === editId)?.createdAt : new Date().toISOString(),
            updatedAt: new Date().toISOString()
        };

        if (!AppState.appData.waterManagement) {
            AppState.appData.waterManagement = [];
        }

        Loading.show();
        try {
            if (editId) {
                const index = AppState.appData.waterManagement.findIndex(w => w.id === editId);
                if (index !== -1) AppState.appData.waterManagement[index] = formData;
                Notification.success('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¬Ù„ Ø¨Ù†Ø¬Ø§Ø­');
            } else {
                AppState.appData.waterManagement.push(formData);
                Notification.success('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø¬Ù„ Ø¨Ù†Ø¬Ø§Ø­');
            }

            DataManager.save();
            await GoogleIntegration.autoSave('WaterManagement', AppState.appData.waterManagement);

            Loading.hide();
            modal.remove();
            this.load();
        } catch (error) {
            Loading.hide();
            Notification.error('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
        }
    },

    async viewWaterManagement(id) {
        const record = AppState.appData.waterManagement.find(w => w.id === id);
        if (!record) {
            Notification.error('Ø§Ù„Ø³Ø¬Ù„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
            return;
        }
        
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h2 class="modal-title">ØªÙØ§ØµÙŠÙ„ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙŠØ§Ù‡</h2>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="space-y-3">
                        <div><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${Utils.formatDate(record.date)}</div>
                        <div><strong>Ù†ÙˆØ¹ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…:</strong> ${Utils.escapeHTML(record.usageType)}</div>
                        <div><strong>Ø§Ù„ÙƒÙ…ÙŠØ©:</strong> ${parseFloat(record.quantity || 0).toFixed(2)} Ù…Â³</div>
                        <div><strong>Ù…ØµØ¯Ø± Ø§Ù„Ù…Ø§Ø¡:</strong> ${Utils.escapeHTML(record.waterSource)}</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="this.closest('.modal-overlay').remove()">Ø¥ØºÙ„Ø§Ù‚</button>
                    <button type="button" class="btn-primary" onclick="Sustainability.editWaterManagement('${record.id}'); this.closest('.modal-overlay').remove();">ØªØ¹Ø¯ÙŠÙ„</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
        });
    },

    async editWaterManagement(id) {
        const record = AppState.appData.waterManagement.find(w => w.id === id);
        if (!record) {
            Notification.error('Ø§Ù„Ø³Ø¬Ù„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
            return;
        }
        this.showWaterManagementForm(record);
    },

    async deleteWaterManagement(id) {
        if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„ØŸ')) return;
        
        Loading.show();
        try {
            AppState.appData.waterManagement = AppState.appData.waterManagement.filter(w => w.id !== id);
            DataManager.save();
            await GoogleIntegration.autoSave('WaterManagement', AppState.appData.waterManagement);
            Notification.success('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ Ø¨Ù†Ø¬Ø§Ø­');
            this.load();
        } catch (error) {
            Notification.error('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
        } finally {
            Loading.hide();
        }
    },

    async showRecyclingForm(data = null) {
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h2 class="modal-title">${data ? 'ØªØ¹Ø¯ÙŠÙ„ Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¯ÙˆÙŠØ±' : 'Ø¥Ø¶Ø§ÙØ© Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¯ÙˆÙŠØ±'}</h2>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="recycling-form" class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ø³Ù… Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ *</label>
                            <input type="text" id="recycling-name" required class="form-input" 
                                value="${Utils.escapeHTML(data?.programName || '')}" placeholder="Ù…Ø«Ø§Ù„: Ø¨Ø±Ù†Ø§Ù…Ø¬ ØªØ¯ÙˆÙŠØ± Ø§Ù„Ø¨Ù„Ø§Ø³ØªÙŠÙƒ">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ù†ÙˆØ¹ Ø§Ù„Ù…ÙˆØ§Ø¯ *</label>
                            <select id="recycling-material" required class="form-input">
                                <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù†ÙˆØ¹</option>
                                <option value="Ø¨Ù„Ø§Ø³ØªÙŠÙƒ" ${data?.materialType === 'Ø¨Ù„Ø§Ø³ØªÙŠÙƒ' ? 'selected' : ''}>Ø¨Ù„Ø§Ø³ØªÙŠÙƒ</option>
                                <option value="ÙˆØ±Ù‚" ${data?.materialType === 'ÙˆØ±Ù‚' ? 'selected' : ''}>ÙˆØ±Ù‚</option>
                                <option value="Ø²Ø¬Ø§Ø¬" ${data?.materialType === 'Ø²Ø¬Ø§Ø¬' ? 'selected' : ''}>Ø²Ø¬Ø§Ø¬</option>
                                <option value="Ù…Ø¹Ø¯Ù†" ${data?.materialType === 'Ù…Ø¹Ø¯Ù†' ? 'selected' : ''}>Ù…Ø¹Ø¯Ù†</option>
                                <option value="Ù†ÙØ§ÙŠØ§Øª Ø¹Ø¶ÙˆÙŠØ©" ${data?.materialType === 'Ù†ÙØ§ÙŠØ§Øª Ø¹Ø¶ÙˆÙŠØ©' ? 'selected' : ''}>Ù†ÙØ§ÙŠØ§Øª Ø¹Ø¶ÙˆÙŠØ©</option>
                                <option value="Ø£Ø®Ø±Ù‰" ${data?.materialType === 'Ø£Ø®Ø±Ù‰' ? 'selected' : ''}>Ø£Ø®Ø±Ù‰</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ù†Ø³Ø¨Ø© Ø§Ù„ØªØ¯ÙˆÙŠØ± (%) *</label>
                            <input type="number" id="recycling-rate" required step="0.1" min="0" max="100" class="form-input" 
                                value="${data?.recyclingRate || ''}" placeholder="0.0">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„Ø­Ø§Ù„Ø© *</label>
                            <select id="recycling-status" required class="form-input">
                                <option value="Ù†Ø´Ø·" ${data?.status === 'Ù†Ø´Ø·' ? 'selected' : ''}>Ù†Ø´Ø·</option>
                                <option value="Ù…ØªÙˆÙ‚Ù" ${data?.status === 'Ù…ØªÙˆÙ‚Ù' ? 'selected' : ''}>Ù…ØªÙˆÙ‚Ù</option>
                                <option value="Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±" ${data?.status === 'Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±' ? 'selected' : ''}>Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„ÙˆØµÙ</label>
                            <textarea id="recycling-description" class="form-input" rows="3" 
                                placeholder="ÙˆØµÙ ØªÙØµÙŠÙ„ÙŠ Ù„Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬">${Utils.escapeHTML(data?.description || '')}</textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="this.closest('.modal-overlay').remove()">Ø¥Ù„ØºØ§Ø¡</button>
                    <button type="button" id="save-recycling-btn" class="btn-primary">Ø­ÙØ¸</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);

        const saveBtn = modal.querySelector('#save-recycling-btn');
        saveBtn.addEventListener('click', () => this.handleRecyclingSubmit(data?.id, modal));

        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
        });
    },

    async handleRecyclingSubmit(editId = null, modal) {
        const formData = {
            id: editId || Utils.generateId('RECYCLE'),
            programName: document.getElementById('recycling-name').value.trim(),
            materialType: document.getElementById('recycling-material').value,
            recyclingRate: parseFloat(document.getElementById('recycling-rate').value),
            status: document.getElementById('recycling-status').value,
            description: document.getElementById('recycling-description').value.trim(),
            createdAt: editId ? AppState.appData.recyclingPrograms.find(r => r.id === editId)?.createdAt : new Date().toISOString(),
            updatedAt: new Date().toISOString()
        };

        if (!AppState.appData.recyclingPrograms) {
            AppState.appData.recyclingPrograms = [];
        }

        Loading.show();
        try {
            if (editId) {
                const index = AppState.appData.recyclingPrograms.findIndex(r => r.id === editId);
                if (index !== -1) AppState.appData.recyclingPrograms[index] = formData;
                Notification.success('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø¨Ù†Ø¬Ø§Ø­');
            } else {
                AppState.appData.recyclingPrograms.push(formData);
                Notification.success('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø¨Ù†Ø¬Ø§Ø­');
            }

            DataManager.save();
            await GoogleIntegration.autoSave('RecyclingPrograms', AppState.appData.recyclingPrograms);

            Loading.hide();
            modal.remove();
            this.load();
        } catch (error) {
            Loading.hide();
            Notification.error('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
        }
    },

    async viewRecycling(id) {
        const record = AppState.appData.recyclingPrograms.find(r => r.id === id);
        if (!record) {
            Notification.error('Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
            return;
        }
        
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h2 class="modal-title">ØªÙØ§ØµÙŠÙ„ Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¯ÙˆÙŠØ±</h2>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="space-y-3">
                        <div><strong>Ø§Ø³Ù… Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬:</strong> ${Utils.escapeHTML(record.programName)}</div>
                        <div><strong>Ù†ÙˆØ¹ Ø§Ù„Ù…ÙˆØ§Ø¯:</strong> ${Utils.escapeHTML(record.materialType)}</div>
                        <div><strong>Ù†Ø³Ø¨Ø© Ø§Ù„ØªØ¯ÙˆÙŠØ±:</strong> ${parseFloat(record.recyclingRate || 0).toFixed(1)}%</div>
                        <div><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> <span class="badge badge-${record.status === 'Ù†Ø´Ø·' ? 'success' : 'info'}">${record.status}</span></div>
                        ${record.description ? `<div><strong>Ø§Ù„ÙˆØµÙ:</strong> ${Utils.escapeHTML(record.description)}</div>` : ''}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="this.closest('.modal-overlay').remove()">Ø¥ØºÙ„Ø§Ù‚</button>
                    <button type="button" class="btn-primary" onclick="Sustainability.editRecycling('${record.id}'); this.closest('.modal-overlay').remove();">ØªØ¹Ø¯ÙŠÙ„</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
        });
    },

    async editRecycling(id) {
        const record = AppState.appData.recyclingPrograms.find(r => r.id === id);
        if (!record) {
            Notification.error('Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
            return;
        }
        this.showRecyclingForm(record);
    },

    async deleteRecycling(id) {
        if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ØŸ')) return;
        
        Loading.show();
        try {
            AppState.appData.recyclingPrograms = AppState.appData.recyclingPrograms.filter(r => r.id !== id);
            DataManager.save();
            await GoogleIntegration.autoSave('RecyclingPrograms', AppState.appData.recyclingPrograms);
            Notification.success('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø¨Ù†Ø¬Ø§Ø­');
            this.load();
        } catch (error) {
            Notification.error('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
        } finally {
            Loading.hide();
        }
    },

    async showInitiativeForm(data = null) {
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h2 class="modal-title">${data ? 'ØªØ¹Ø¯ÙŠÙ„ Ù…Ø¨Ø§Ø¯Ø±Ø©' : 'Ø¥Ø¶Ø§ÙØ© Ù…Ø¨Ø§Ø¯Ø±Ø© Ø§Ø³ØªØ¯Ø§Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©'}</h2>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="sustainability-initiative-form" class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ø³Ù… Ø§Ù„Ù…Ø¨Ø§Ø¯Ø±Ø© *</label>
                            <input type="text" id="initiative-name" required class="form-input" 
                                value="${Utils.escapeHTML(data?.name || '')}" placeholder="Ù…Ø«Ø§Ù„: Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¯ÙˆÙŠØ± Ø§Ù„Ù…ÙŠØ§Ù‡">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„ÙˆØµÙ *</label>
                            <textarea id="initiative-description" required class="form-input" rows="4" 
                                placeholder="ÙˆØµÙ ØªÙØµÙŠÙ„ÙŠ Ù„Ù„Ù…Ø¨Ø§Ø¯Ø±Ø©">${Utils.escapeHTML(data?.description || '')}</textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡ *</label>
                            <input type="date" id="initiative-start-date" required class="form-input" 
                                value="${data?.startDate ? new Date(data.startDate).toISOString().slice(0, 10) : ''}">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„Ø­Ø§Ù„Ø© *</label>
                            <select id="initiative-status" required class="form-input">
                                <option value="Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°" ${data?.status === 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°' ? 'selected' : ''}>Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</option>
                                <option value="Ù…ÙƒØªÙ…Ù„Ø©" ${data?.status === 'Ù…ÙƒØªÙ…Ù„Ø©' ? 'selected' : ''}>Ù…ÙƒØªÙ…Ù„Ø©</option>
                                <option value="Ù…Ø®Ø·Ø· Ù„Ù‡Ø§" ${data?.status === 'Ù…Ø®Ø·Ø· Ù„Ù‡Ø§' ? 'selected' : ''}>Ù…Ø®Ø·Ø· Ù„Ù‡Ø§</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="this.closest('.modal-overlay').remove()">Ø¥Ù„ØºØ§Ø¡</button>
                    <button type="button" id="save-initiative-btn" class="btn-primary">Ø­ÙØ¸</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);

        const saveBtn = modal.querySelector('#save-initiative-btn');
        saveBtn.addEventListener('click', () => this.handleSubmit(data?.id, modal));

        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
        });
    },

    async handleSubmit(editId = null, modal) {
        const formData = {
            id: editId || Utils.generateId('SUSTAIN'),
            name: document.getElementById('initiative-name').value.trim(),
            description: document.getElementById('initiative-description').value.trim(),
            startDate: new Date(document.getElementById('initiative-start-date').value).toISOString(),
            status: document.getElementById('initiative-status').value,
            createdAt: editId ? AppState.appData.sustainability.find(s => s.id === editId)?.createdAt : new Date().toISOString(),
            updatedAt: new Date().toISOString()
        };

        if (!AppState.appData.sustainability) {
            AppState.appData.sustainability = [];
        }

        Loading.show();
        try {
            if (editId) {
                const index = AppState.appData.sustainability.findIndex(s => s.id === editId);
                if (index !== -1) AppState.appData.sustainability[index] = formData;
                Notification.success('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¨Ø§Ø¯Ø±Ø© Ø¨Ù†Ø¬Ø§Ø­');
            } else {
                AppState.appData.sustainability.push(formData);
                Notification.success('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¨Ø§Ø¯Ø±Ø© Ø¨Ù†Ø¬Ø§Ø­');
            }

            DataManager.save();
            await GoogleIntegration.autoSave('Sustainability', AppState.appData.sustainability);

            Loading.hide();
            modal.remove();
            this.load();
        } catch (error) {
            Loading.hide();
            Notification.error('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
        }
    },

    async viewInitiative(id) {
        const init = AppState.appData.sustainability.find(s => s.id === id);
        if (!init) {
            Notification.error('Ø§Ù„Ù…Ø¨Ø§Ø¯Ø±Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
            return;
        }
        
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h2 class="modal-title">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø¨Ø§Ø¯Ø±Ø©</h2>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="space-y-3">
                        <div><strong>Ø§Ø³Ù… Ø§Ù„Ù…Ø¨Ø§Ø¯Ø±Ø©:</strong> ${Utils.escapeHTML(init.name)}</div>
                        <div><strong>Ø§Ù„ÙˆØµÙ:</strong> ${Utils.escapeHTML(init.description)}</div>
                        <div><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡:</strong> ${Utils.formatDate(init.startDate)}</div>
                        <div><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> <span class="badge badge-${init.status === 'Ù…ÙƒØªÙ…Ù„Ø©' ? 'success' : init.status === 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°' ? 'warning' : 'info'}">${init.status}</span></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="this.closest('.modal-overlay').remove()">Ø¥ØºÙ„Ø§Ù‚</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
        });
    },

    async editInitiative(id) {
        const init = AppState.appData.sustainability.find(s => s.id === id);
        if (!init) {
            Notification.error('Ø§Ù„Ù…Ø¨Ø§Ø¯Ø±Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
            return;
        }
        this.showInitiativeForm(init);
    },

    async deleteInitiative(id) {
        if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¨Ø§Ø¯Ø±Ø©ØŸ')) return;
        
        Loading.show();
        try {
            AppState.appData.sustainability = AppState.appData.sustainability.filter(s => s.id !== id);
            DataManager.save();
            await GoogleIntegration.autoSave('Sustainability', AppState.appData.sustainability);
            Notification.success('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø¨Ø§Ø¯Ø±Ø© Ø¨Ù†Ø¬Ø§Ø­');
            this.load();
        } catch (error) {
            Notification.error('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
        } finally {
            Loading.hide();
        }
    }
};

// ===== Relations Module (Ø±Ø¨Ø· Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø¨Ø¨Ø¹Ø¶Ù‡Ø§) =====
const Relations = {
    /**
     * Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù…ÙˆØ¸Ù Ù…Ø¹ÙŠÙ†
     */
    getEmployeeData(employeeCode) {
        // Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ Ø£Ùˆ ID
        return {
            trainings: AppState.appData.training.filter(t => {
                if (t.participants && Array.isArray(t.participants)) {
                    return t.participants.some(p => p.code === employeeCode || p.employeeNumber === employeeCode);
                }
                return t.employeeId === employeeCode || t.employeeCode === employeeCode;
            }),
            violations: AppState.appData.violations.filter(v => 
                v.employeeCode === employeeCode || v.employeeNumber === employeeCode || v.employeeId === employeeCode
            ),
            incidents: AppState.appData.incidents.filter(i => 
                i.employeeCode === employeeCode || i.employeeNumber === employeeCode
            ),
            ppe: AppState.appData.ppe.filter(p => 
                p.employeeCode === employeeCode || p.employeeNumber === employeeCode || p.employeeId === employeeCode
            ),
            clinicVisits: AppState.appData.clinicVisits.filter(c => 
                c.employeeCode === employeeCode || c.employeeNumber === employeeCode || c.employeeId === employeeCode
            ),
            sickLeave: AppState.appData.sickLeave.filter(s => 
                s.employeeCode === employeeCode || s.employeeNumber === employeeCode || s.employeeId === employeeCode
            )
        };
    },
    
    /**
     * ØªØ­Ù„ÙŠÙ„ Ø´Ø§Ù…Ù„ Ù„Ù„Ø­ÙˆØ§Ø¯Ø« ÙˆØ§Ù„Ø¥ØµØ§Ø¨Ø§Øª
     */
    analyzeIncidentsAndInjuries(employeeCode) {
        const data = this.getEmployeeData(employeeCode);
        const analysis = {
            totalIncidents: data.incidents.length,
            totalViolations: data.violations.length,
            totalPPE: data.ppe.length,
            totalTraining: data.trainings.length,
            severityDistribution: {
                high: data.incidents.filter(i => i.severity === 'Ø¹Ø§Ù„ÙŠØ©').length,
                medium: data.incidents.filter(i => i.severity === 'Ù…ØªÙˆØ³Ø·Ø©').length,
                low: data.incidents.filter(i => i.severity === 'Ù…Ù†Ø®ÙØ¶Ø©').length
            },
            violationTypes: {},
            trainingCount: data.trainings.length,
            clinicVisits: data.clinicVisits.length,
            sickLeave: data.sickLeave.length
        };
        
        // ØªØ­Ù„ÙŠÙ„ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª
        data.violations.forEach(v => {
            analysis.violationTypes[v.violationType] = (analysis.violationTypes[v.violationType] || 0) + 1;
        });
        
        return analysis;
    },

    /**
     * Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù„Ø§Ù‚Ø© Ø¨ÙŠÙ† Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª ÙˆØ§Ù„ØªØ¯Ø±ÙŠØ¨ ÙˆÙ…Ù‡Ù…Ø§Øª Ø§Ù„ÙˆÙ‚Ø§ÙŠØ©
     */
    getEmployeeRelations(employeeCode) {
        const data = this.getEmployeeData(employeeCode);
        
        return {
            violationsTrainingGap: this.analyzeViolationsTrainingGap(data.violations, data.trainings),
            violationsPPEGap: this.analyzeViolationsPPEGap(data.violations, data.ppe),
            recommendations: this.generateRecommendations(data)
        };
    },
    
    /**
     * ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙØ¬ÙˆØ© Ø¨ÙŠÙ† Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª ÙˆØ§Ù„ØªØ¯Ø±ÙŠØ¨
     */
    analyzeViolationsTrainingGap(violations, trainings) {
        const violationTypes = violations.map(v => v.violationType || '').filter(v => v);
        const trainingTopics = trainings.flatMap(t => {
            if (t.topics && Array.isArray(t.topics)) return t.topics;
            if (t.name) return [t.name];
            return [];
        });
        
        const gaps = [];
        violationTypes.forEach(vType => {
            const hasRelatedTraining = trainingTopics.some(topic => 
                topic.toLowerCase().includes(vType.toLowerCase()) || 
                vType.toLowerCase().includes(topic.toLowerCase())
            );
            
            if (!hasRelatedTraining && vType) {
                gaps.push({
                    violationType: vType,
                    recommendation: `ÙŠÙÙ†ØµØ­ Ø¨ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ù…ÙˆØ¸Ù Ø¹Ù„Ù‰: ${vType}`
                });
            }
        });
        
        return gaps;
    },
    
    /**
     * ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙØ¬ÙˆØ© Ø¨ÙŠÙ† Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª ÙˆÙ…Ù‡Ù…Ø§Øª Ø§Ù„ÙˆÙ‚Ø§ÙŠØ©
     */
    analyzeViolationsPPEGap(violations, ppeRecords) {
        const ppeTypes = ppeRecords.map(p => p.equipmentType || '').filter(t => t);
        const ppeViolations = violations.filter(v => 
            (v.violationType || '').toLowerCase().includes('Ù…Ø¹Ø¯Ø§Øª Ø§Ù„ÙˆÙ‚Ø§ÙŠØ©') || 
            (v.violationType || '').toLowerCase().includes('ppe')
        );
        
        const gaps = [];
        ppeViolations.forEach(v => {
            const violationPPEType = this.extractPPETypeFromViolation(v.violationType);
            const hasPPE = ppeTypes.some(ppe => 
                ppe.toLowerCase().includes((violationPPEType || '').toLowerCase())
            );
            
            if (!hasPPE && violationPPEType) {
                gaps.push({
                    violationType: v.violationType,
                    missingPPE: violationPPEType,
                    recommendation: `ÙŠÙÙ†ØµØ­ Ø¨ØªÙˆÙÙŠØ±: ${violationPPEType} Ù„Ù„Ù…ÙˆØ¸Ù`
                });
            }
        });
        
        return gaps;
    },
    
    /**
     * Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù†ÙˆØ¹ Ù…Ù‡Ù…Ø§Øª Ø§Ù„ÙˆÙ‚Ø§ÙŠØ© Ù…Ù† Ù†ÙˆØ¹ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©
     */
    extractPPETypeFromViolation(violationType) {
        if (!violationType) return null;
        
        const ppeTypes = ['Ø®ÙˆØ°Ø©', 'Ù†Ø¸Ø§Ø±Ø§Øª', 'Ù‚ÙØ§Ø²Ø§Øª', 'Ø£Ø­Ø°ÙŠØ©', 'Ù‚Ù†Ø§Ø¹', 'Ø³Ù…Ø§Ø¹Ø§Øª', 'Ø­Ø²Ø§Ù…', 'Ø¨Ø¯Ù„Ø©'];
        return ppeTypes.find(type => violationType.includes(type)) || null;
    },
    
    /**
     * ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙˆØµÙŠØ§Øª Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
     */
    generateRecommendations(data) {
        const recommendations = [];
        
        if (data.violations.length > 3) {
            recommendations.push({
                type: 'warning',
                message: 'Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª Ù…Ø±ØªÙØ¹. ÙŠÙˆØµÙ‰ Ø¨Ù…Ø±Ø§Ø¬Ø¹Ø© Ø´Ø§Ù…Ù„Ø© ÙˆØ¥Ø¬Ø±Ø§Ø¡ ØªØ¯Ø±ÙŠØ¨ Ø¥Ø¶Ø§ÙÙŠ'
            });
        }
        
        if (data.incidents.length > 0 && data.trainings.length === 0) {
            recommendations.push({
                type: 'critical',
                message: 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø­ÙˆØ§Ø¯Ø« Ù„Ù„Ù…ÙˆØ¸Ù Ø¨Ø¯ÙˆÙ† Ø£ÙŠ ØªØ¯Ø±ÙŠØ¨. ÙŠÙˆØµÙ‰ Ø¨ØªØ¯Ø±ÙŠØ¨ Ø¹Ø§Ø¬Ù„'
            });
        }
        
        if (data.violations.some(v => 
            (v.violationType || '').toLowerCase().includes('Ù…Ø¹Ø¯Ø§Øª Ø§Ù„ÙˆÙ‚Ø§ÙŠØ©')
        ) && data.ppe.length === 0) {
            recommendations.push({
                type: 'critical',
                message: 'ÙŠÙˆØ¬Ø¯ Ù…Ø®Ø§Ù„ÙØ§Øª Ù…ØªØ¹Ù„Ù‚Ø© Ø¨Ù…Ø¹Ø¯Ø§Øª Ø§Ù„ÙˆÙ‚Ø§ÙŠØ© Ø¨Ø¯ÙˆÙ† Ø§Ø³ØªÙ„Ø§Ù…Ø§Øª. ÙŠÙˆØµÙ‰ Ø¨ØªÙˆÙÙŠØ± Ù…Ù‡Ù…Ø§Øª Ø§Ù„ÙˆÙ‚Ø§ÙŠØ©'
            });
        }
        
        return recommendations;
    },
    
    /**
     * Ø¹Ø±Ø¶ ØªÙ‚Ø±ÙŠØ± Ø´Ø§Ù…Ù„ Ù„Ù„Ù…ÙˆØ¸Ù
     */
    async showEmployeeRelationsReport(employeeCode) {
        const employee = AppState.appData.employees.find(e => 
            e.employeeNumber === employeeCode || 
            e.sapId === employeeCode || 
            e.id === employeeCode
        );
        
        if (!employee) {
            Notification.error('Ø§Ù„Ù…ÙˆØ¸Ù ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
            return;
        }
        
        const data = this.getEmployeeData(employeeCode);
        const relations = this.getEmployeeRelations(employeeCode);
        
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 900px;">
                <div class="modal-header">
                    <h2 class="modal-title">
                        <i class="fas fa-chart-line ml-2"></i>
                        ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¹Ù„Ø§Ù‚Ø§Øª: ${Utils.escapeHTML(employee.name || employeeCode)}
                    </h2>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="space-y-6">
                        <div class="grid grid-cols-4 gap-4">
                            <div class="content-card text-center">
                                <div class="text-2xl font-bold text-blue-600">${data.incidents.length}</div>
                                <div class="text-sm text-gray-600">Ø­ÙˆØ§Ø¯Ø«</div>
                            </div>
                            <div class="content-card text-center">
                                <div class="text-2xl font-bold text-red-600">${data.violations.length}</div>
                                <div class="text-sm text-gray-600">Ù…Ø®Ø§Ù„ÙØ§Øª</div>
                            </div>
                            <div class="content-card text-center">
                                <div class="text-2xl font-bold text-green-600">${data.trainings.length}</div>
                                <div class="text-sm text-gray-600">ØªØ¯Ø±ÙŠØ¨Ø§Øª</div>
                            </div>
                            <div class="content-card text-center">
                                <div class="text-2xl font-bold text-purple-600">${data.ppe.length}</div>
                                <div class="text-sm text-gray-600">Ù…Ù‡Ù…Ø§Øª ÙˆÙ‚Ø§ÙŠØ©</div>
                            </div>
                        </div>
                        
                        ${relations.violationsTrainingGap.length > 0 ? `
                            <div class="content-card">
                                <h3 class="text-lg font-semibold mb-3">
                                    <i class="fas fa-exclamation-triangle text-yellow-600 ml-2"></i>
                                    ÙØ¬ÙˆØ§Øª Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ù…ØªØ¹Ù„Ù‚Ø© Ø¨Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª
                                </h3>
                                <ul class="list-disc mr-6 space-y-2">
                                    ${relations.violationsTrainingGap.map(gap => `
                                        <li class="text-sm">${Utils.escapeHTML(gap.recommendation)}</li>
                                    `).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        
                        ${relations.violationsPPEGap.length > 0 ? `
                            <div class="content-card">
                                <h3 class="text-lg font-semibold mb-3">
                                    <i class="fas fa-shield-alt text-red-600 ml-2"></i>
                                    ÙØ¬ÙˆØ§Øª Ù…Ù‡Ù…Ø§Øª Ø§Ù„ÙˆÙ‚Ø§ÙŠØ© Ø§Ù„Ù…ØªØ¹Ù„Ù‚Ø© Ø¨Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª
                                </h3>
                                <ul class="list-disc mr-6 space-y-2">
                                    ${relations.violationsPPEGap.map(gap => `
                                        <li class="text-sm">${Utils.escapeHTML(gap.recommendation)}</li>
                                    `).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        
                        ${relations.recommendations.length > 0 ? `
                            <div class="content-card">
                                <h3 class="text-lg font-semibold mb-3">
                                    <i class="fas fa-lightbulb text-blue-600 ml-2"></i>
                                    Ø§Ù„ØªÙˆØµÙŠØ§Øª
                                </h3>
                                <ul class="space-y-2">
                                    ${relations.recommendations.map(rec => `
                                        <li class="p-3 rounded border-l-4 ${
                                            rec.type === 'critical' ? 'bg-red-50 border-red-500' :
                                            rec.type === 'warning' ? 'bg-yellow-50 border-yellow-500' :
                                            'bg-blue-50 border-blue-500'
                                        }">
                                            <div class="flex items-start">
                                                <i class="fas fa-${
                                                    rec.type === 'critical' ? 'exclamation-circle text-red-600' :
                                                    rec.type === 'warning' ? 'exclamation-triangle text-yellow-600' :
                                                    'info-circle text-blue-600'
                                                } ml-2 mt-1"></i>
                                                <span class="text-sm">${Utils.escapeHTML(rec.message)}</span>
                                            </div>
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        
                        ${relations.violationsTrainingGap.length === 0 && relations.violationsPPEGap.length === 0 && relations.recommendations.length === 0 ? `
                            <div class="content-card text-center py-8">
                                <i class="fas fa-check-circle text-green-500 text-4xl mb-4"></i>
                                <p class="text-gray-600">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙˆØµÙŠØ§Øª. Ø§Ù„Ù…ÙˆØ¸Ù ÙÙŠ Ø­Ø§Ù„Ø© Ø¬ÙŠØ¯Ø©!</p>
                            </div>
                        ` : ''}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="this.closest('.modal-overlay').remove()">Ø¥ØºÙ„Ø§Ù‚</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
        });
    },

    /**
     * Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ÙˆØ¸Ù ÙÙŠ ØµÙØ­Ø© ÙˆØ§Ø­Ø¯Ø©
     */
    async showEmployeeProfile(employeeId, employeeName) {
        const data = this.getEmployeeData(employeeId);
        const relations = this.getEmployeeRelations(employeeId);
        
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 1000px;">
                <div class="modal-header">
                    <h2 class="modal-title">Ù…Ù„Ù Ø§Ù„Ù…ÙˆØ¸Ù: ${Utils.escapeHTML(employeeName)}</h2>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div class="content-card">
                            <h3 class="card-title">Ø§Ù„ØªØ¯Ø±ÙŠØ¨Ø§Øª (${data.trainings.length})</h3>
                            <div class="card-body">
                                ${data.trainings.length > 0 ? 
                                    data.trainings.map(t => `<p>${Utils.escapeHTML(t.name || '')}</p>`).join('') : 
                                    '<p class="text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ¯Ø±ÙŠØ¨Ø§Øª</p>'}
                            </div>
                        </div>
                        <div class="content-card">
                            <h3 class="card-title">Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª (${data.violations.length})</h3>
                            <div class="card-body">
                                ${data.violations.length > 0 ? 
                                    data.violations.map(v => `<p>${Utils.escapeHTML(v.violationType || '')}</p>`).join('') : 
                                    '<p class="text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø®Ø§Ù„ÙØ§Øª</p>'}
                            </div>
                        </div>
                        <div class="content-card">
                            <h3 class="card-title">Ø§Ù„Ø­ÙˆØ§Ø¯Ø« (${data.incidents.length})</h3>
                            <div class="card-body">
                                ${data.incidents.length > 0 ? 
                                    data.incidents.map(i => `<p>${Utils.escapeHTML(i.title || '')}</p>`).join('') : 
                                    '<p class="text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­ÙˆØ§Ø¯Ø«</p>'}
                            </div>
                        </div>
                        <div class="content-card">
                            <h3 class="card-title">Ù…Ù‡Ù…Ø§Øª Ø§Ù„ÙˆÙ‚Ø§ÙŠØ© (${data.ppe.length})</h3>
                            <div class="card-body">
                                ${data.ppe.length > 0 ? 
                                    data.ppe.map(p => `<p>${Utils.escapeHTML(p.equipmentType || '')}</p>`).join('') : 
                                    '<p class="text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ø³ØªÙ„Ø§Ù…Ø§Øª</p>'}
                            </div>
                        </div>
                    </div>
                    ${relations.recommendations.length > 0 ? `
                        <div class="content-card mt-4">
                            <h3 class="card-title">Ø§Ù„ØªÙˆØµÙŠØ§Øª</h3>
                            <div class="card-body">
                                ${relations.recommendations.map(rec => `
                                    <p class="p-2 rounded mb-2 ${
                                        rec.type === 'critical' ? 'bg-red-50 text-red-800' :
                                        rec.type === 'warning' ? 'bg-yellow-50 text-yellow-800' :
                                        'bg-blue-50 text-blue-800'
                                    }">
                                        ${Utils.escapeHTML(rec.message)}
                                    </p>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
                <div class="modal-footer">
                    <button type="button" onclick="Relations.showEmployeeRelationsReport('${employeeId}'); this.closest('.modal-overlay').remove();" class="btn-primary">
                        <i class="fas fa-chart-line ml-2"></i>Ø¹Ø±Ø¶ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¹Ù„Ø§Ù‚Ø§Øª
                    </button>
                    <button class="btn-secondary" onclick="this.closest('.modal-overlay').remove()">Ø¥ØºÙ„Ø§Ù‚</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
        });
    }
};

// ===== AI Assistant Module (Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ) =====
const AIAssistant = {
    async analyzeData(dataType) {
        try {
            Loading.show();
            
            let analysis = '';
            let recommendations = [];
            
            switch(dataType) {
                case 'incidents':
                    const incidents = AppState.appData.incidents || [];
                    const highSeverity = incidents.filter(i => i.severity === 'Ø¹Ø§Ù„ÙŠØ©').length;
                    const recentIncidents = incidents.filter(i => {
                        const date = new Date(i.date || i.createdAt);
                        const daysAgo = (Date.now() - date.getTime()) / (1000 * 60 * 60 * 24);
                        return daysAgo <= 30;
                    }).length;
                    
                    analysis = `ØªÙ… ØªØ­Ù„ÙŠÙ„ ${incidents.length} Ø­Ø§Ø¯Ø«.`;
                    analysis += `\n- Ø§Ù„Ø­ÙˆØ§Ø¯Ø« Ø¹Ø§Ù„ÙŠØ© Ø§Ù„Ø®Ø·ÙˆØ±Ø©: ${highSeverity}`;
                    analysis += `\n- Ø§Ù„Ø­ÙˆØ§Ø¯Ø« Ø®Ù„Ø§Ù„ Ø¢Ø®Ø± 30 ÙŠÙˆÙ…: ${recentIncidents}`;
                    
                    if (highSeverity > incidents.length * 0.2) {
                        recommendations.push({
                            type: 'critical',
                            message: 'Ù†Ø³Ø¨Ø© Ø§Ù„Ø­ÙˆØ§Ø¯Ø« Ø¹Ø§Ù„ÙŠØ© Ø§Ù„Ø®Ø·ÙˆØ±Ø© Ù…Ø±ØªÙØ¹Ø©. ÙŠÙˆØµÙ‰ Ø¨Ù…Ø±Ø§Ø¬Ø¹Ø© Ø´Ø§Ù…Ù„Ø© Ù„Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„Ø§Øª Ø§Ù„Ø³Ù„Ø§Ù…Ø©'
                        });
                    }
                    
                    if (recentIncidents > 5) {
                        recommendations.push({
                            type: 'warning',
                            message: 'Ø¹Ø¯Ø¯ Ø§Ù„Ø­ÙˆØ§Ø¯Ø« ÙÙŠ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø£Ø®ÙŠØ± Ù…Ø±ØªÙØ¹. ÙŠÙˆØµÙ‰ Ø¨Ø²ÙŠØ§Ø¯Ø© Ø§Ù„ØªØ¯Ø±ÙŠØ¨ ÙˆØ§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©'
                        });
                    }
                    break;
                    
                case 'training':
                    const trainings = AppState.appData.training || [];
                    const completed = trainings.filter(t => t.status === 'Ù…ÙƒØªÙ…Ù„').length;
                    const upcoming = trainings.filter(t => t.status === 'Ù…Ø®Ø·Ø·').length;
                    const totalParticipants = trainings.reduce((sum, t) => sum + (t.participants?.length || t.participantsCount || 0), 0);
                    
                    analysis = `ØªÙ… ØªØ­Ù„ÙŠÙ„ ${trainings.length} Ø¨Ø±Ù†Ø§Ù…Ø¬ ØªØ¯Ø±ÙŠØ¨ÙŠ.`;
                    analysis += `\n- Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©: ${completed}`;
                    analysis += `\n- Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„Ù…Ø®Ø·Ø·Ø©: ${upcoming}`;
                    analysis += `\n- Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†: ${totalParticipants}`;
                    
                    if (upcoming > completed) {
                        recommendations.push({
                            type: 'info',
                            message: 'Ù‡Ù†Ø§Ùƒ Ø¨Ø±Ø§Ù…Ø¬ ØªØ¯Ø±ÙŠØ¨ÙŠØ© Ù…Ø®Ø·Ø·Ø© Ø£ÙƒØ«Ø± Ù…Ù† Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©. ØªØ£ÙƒØ¯ Ù…Ù† Ù…ØªØ§Ø¨Ø¹Ø© ØªÙ†ÙÙŠØ°Ù‡Ø§'
                        });
                    }
                    break;
                    
                case 'risk':
                    const risks = AppState.appData.riskAssessments || [];
                    const highRisk = risks.filter(r => {
                        const level = parseInt(r.riskLevel || '0');
                        return level > 10;
                    }).length;
                    
                    analysis = `ØªÙ… ØªØ­Ù„ÙŠÙ„ ${risks.length} ØªÙ‚ÙŠÙŠÙ… Ù…Ø®Ø§Ø·Ø±.`;
                    analysis += `\n- Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø¹Ø§Ù„ÙŠØ© Ø§Ù„Ù…Ø®Ø§Ø·Ø±: ${highRisk}`;
                    
                    if (highRisk > 0) {
                        recommendations.push({
                            type: 'critical',
                            message: 'ÙŠÙˆØ¬Ø¯ ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ù…Ø®Ø§Ø·Ø± Ø¹Ø§Ù„ÙŠØ©. ÙŠÙˆØµÙ‰ Ø¨Ù…Ø±Ø§Ø¬Ø¹Ø© ÙÙˆØ±ÙŠØ© ÙˆØ§ØªØ®Ø§Ø° Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª ØªØµØ­ÙŠØ­ÙŠØ©'
                        });
                    }
                    break;
                    
                case 'comprehensive':
                    const allIncidents = AppState.appData.incidents || [];
                    const allTrainings = AppState.appData.training || [];
                    const allRisks = AppState.appData.riskAssessments || [];
                    const violations = AppState.appData.violations || [];
                    
                    analysis = `ØªØ­Ù„ÙŠÙ„ Ø´Ø§Ù…Ù„ Ù„Ù„Ù†Ø¸Ø§Ù…:\n`;
                    analysis += `- Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­ÙˆØ§Ø¯Ø«: ${allIncidents.length}\n`;
                    analysis += `- Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ¯Ø±ÙŠØ¨Ø§Øª: ${allTrainings.length}\n`;
                    analysis += `- Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø§Ù„Ù…Ø®Ø§Ø·Ø±: ${allRisks.length}\n`;
                    analysis += `- Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ§Øª: ${violations.length}\n`;
                    
                    // ØªØ­Ù„ÙŠÙ„ Ø´Ø§Ù…Ù„
                    const incidentsRate = allIncidents.length / 30; // Ù…Ø¹Ø¯Ù„ ÙŠÙˆÙ…ÙŠ
                    if (incidentsRate > 0.5) {
                        recommendations.push({
                            type: 'warning',
                            message: 'Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø­ÙˆØ§Ø¯Ø« Ù…Ø±ØªÙØ¹. ÙŠÙˆØµÙ‰ Ø¨ØªØ¹Ø²ÙŠØ² Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„Ø³Ù„Ø§Ù…Ø©'
                        });
                    }
                    
                    const trainingCompletion = allTrainings.filter(t => t.status === 'Ù…ÙƒØªÙ…Ù„').length / (allTrainings.length || 1);
                    if (trainingCompletion < 0.7) {
                        recommendations.push({
                            type: 'warning',
                            message: 'Ù†Ø³Ø¨Ø© Ø¥ØªÙ…Ø§Ù… Ø§Ù„ØªØ¯Ø±ÙŠØ¨Ø§Øª Ù…Ù†Ø®ÙØ¶Ø©. ÙŠÙˆØµÙ‰ Ø¨Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„Ù…Ø®Ø·Ø·Ø©'
                        });
                    }
                    break;
            }
            
            Loading.hide();
            
            // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px;">
                    <div class="modal-header">
                        <h2 class="modal-title">
                            <i class="fas fa-robot ml-2"></i>
                            ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
                        </h2>
                        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="space-y-4">
                            <div class="content-card">
                                <h3 class="card-title">Ø§Ù„ØªØ­Ù„ÙŠÙ„</h3>
                                <div class="card-body">
                                    <pre class="whitespace-pre-wrap text-sm">${Utils.escapeHTML(analysis)}</pre>
                                </div>
                            </div>
                            
                            ${recommendations.length > 0 ? `
                                <div class="content-card">
                                    <h3 class="card-title">Ø§Ù„ØªÙˆØµÙŠØ§Øª</h3>
                                    <div class="card-body space-y-2">
                                        ${recommendations.map(rec => `
                                            <div class="p-3 rounded border-l-4 ${
                                                rec.type === 'critical' ? 'bg-red-50 border-red-500' :
                                                rec.type === 'warning' ? 'bg-yellow-50 border-yellow-500' :
                                                'bg-blue-50 border-blue-500'
                                            }">
                                                <div class="flex items-start">
                                                    <i class="fas fa-${
                                                        rec.type === 'critical' ? 'exclamation-circle text-red-600' :
                                                        rec.type === 'warning' ? 'exclamation-triangle text-yellow-600' :
                                                        'info-circle text-blue-600'
                                                    } ml-2 mt-1"></i>
                                                    <span class="text-sm">${Utils.escapeHTML(rec.message)}</span>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn-secondary" onclick="this.closest('.modal-overlay').remove()">Ø¥ØºÙ„Ø§Ù‚</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
            
        } catch (error) {
            Loading.hide();
            console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
            Notification.error('ÙØ´Ù„ Ø§Ù„ØªØ­Ù„ÙŠÙ„: ' + error.message);
        }
    },
    
    async load() {
        const section = document.getElementById('ai-assistant-section');
        if (!section) return;
        
        section.innerHTML = `
            <div class="section-header">
                <h1 class="section-title">
                    <i class="fas fa-robot ml-3"></i>
                    Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
                </h1>
                <p class="section-subtitle">ØªØ­Ù„ÙŠÙ„ Ø°ÙƒÙŠ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØªÙˆØµÙŠØ§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ©</p>
            </div>
            <div class="mt-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="content-card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="fas fa-exclamation-triangle ml-2"></i>
                                ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø­ÙˆØ§Ø¯Ø«
                            </h2>
                        </div>
                        <div class="card-body">
                            <p class="text-gray-600 mb-4">ØªØ­Ù„ÙŠÙ„ Ø´Ø§Ù…Ù„ Ù„Ù„Ø­ÙˆØ§Ø¯Ø« Ù…Ø¹ ØªÙˆØµÙŠØ§Øª Ø°ÙƒÙŠØ©</p>
                            <button onclick="AIAssistant.analyzeData('incidents')" class="btn-primary w-full">
                                <i class="fas fa-brain ml-2"></i>
                                ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø­ÙˆØ§Ø¯Ø«
                            </button>
                        </div>
                    </div>
                    
                    <div class="content-card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="fas fa-graduation-cap ml-2"></i>
                                ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªØ¯Ø±ÙŠØ¨Ø§Øª
                            </h2>
                        </div>
                        <div class="card-body">
                            <p class="text-gray-600 mb-4">ØªØ­Ù„ÙŠÙ„ Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ ÙˆØ§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†</p>
                            <button onclick="AIAssistant.analyzeData('training')" class="btn-primary w-full">
                                <i class="fas fa-brain ml-2"></i>
                                ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªØ¯Ø±ÙŠØ¨Ø§Øª
                            </button>
                        </div>
                    </div>
                    
                    <div class="content-card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="fas fa-shield-alt ml-2"></i>
                                ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø®Ø§Ø·Ø±
                            </h2>
                        </div>
                        <div class="card-body">
                            <p class="text-gray-600 mb-4">ØªØ­Ù„ÙŠÙ„ ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø§Ù„Ù…Ø®Ø§Ø·Ø± ÙˆØ§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</p>
                            <button onclick="AIAssistant.analyzeData('risk')" class="btn-primary w-full">
                                <i class="fas fa-brain ml-2"></i>
                                ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø®Ø§Ø·Ø±
                            </button>
                        </div>
                    </div>
                    
                    <div class="content-card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <i class="fas fa-chart-line ml-2"></i>
                                ØªØ­Ù„ÙŠÙ„ Ø´Ø§Ù…Ù„
                            </h2>
                        </div>
                        <div class="card-body">
                            <p class="text-gray-600 mb-4">ØªØ­Ù„ÙŠÙ„ Ø´Ø§Ù…Ù„ Ù„Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</p>
                            <button onclick="AIAssistant.analyzeData('comprehensive')" class="btn-primary w-full">
                                <i class="fas fa-brain ml-2"></i>
                                ØªØ­Ù„ÙŠÙ„ Ø´Ø§Ù…Ù„
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
};

// ===== Risk Assessment Module (ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…Ø®Ø§Ø·Ø±) =====
const RiskAssessment = {
    async load() {
        const section = document.getElementById('risk-assessment-section');
        if (!section) return;

        section.innerHTML = `
            <div class="section-header">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="section-title">
                            <i class="fas fa-shield-alt ml-3"></i>
                            ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…Ø®Ø§Ø·Ø±
                        </h1>
                        <p class="section-subtitle">ØªØ³Ø¬ÙŠÙ„ ÙˆØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…Ø®Ø§Ø·Ø± ÙÙŠ Ø¨ÙŠØ¦Ø© Ø§Ù„Ø¹Ù…Ù„</p>
                    </div>
                    <button id="add-risk-assessment-btn" class="btn-primary">
                        <i class="fas fa-plus ml-2"></i>
                        Ø¥Ø¶Ø§ÙØ© ØªÙ‚ÙŠÙŠÙ… Ø¬Ø¯ÙŠØ¯
                    </button>
                </div>
            </div>
            <div id="risk-assessment-content" class="mt-6">
                ${await this.renderList()}
            </div>
        `;
        this.setupEventListeners();
        this.loadRiskAssessmentsList();
    },

    async renderList() {
        return `
            <div class="content-card">
                <div class="card-header">
                    <div class="flex items-center justify-between">
                        <h2 class="card-title"><i class="fas fa-list ml-2"></i>Ø³Ø¬Ù„ ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø§Ù„Ù…Ø®Ø§Ø·Ø±</h2>
                        <button id="export-risk-excel-btn" class="btn-success">
                            <i class="fas fa-file-excel ml-2"></i>ØªØµØ¯ÙŠØ± Excel
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="risk-assessment-table-container">
                        <div class="empty-state">
                            <i class="fas fa-spinner fa-spin text-4xl text-gray-300 mb-4"></i>
                            <p class="text-gray-500">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
                        </div>
                    </div>
                </div>
            </div>
        `;
    },

    async loadRiskAssessmentsList() {
        const container = document.getElementById('risk-assessment-table-container');
        if (!container) return;
        
        const assessments = AppState.appData.riskAssessments || [];
        
        if (assessments.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-shield-alt text-4xl text-gray-300 mb-4"></i>
                    <p class="text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ù…Ø®Ø§Ø·Ø±</p>
                    <button id="add-risk-assessment-empty-btn" class="btn-primary mt-4">
                        <i class="fas fa-plus ml-2"></i>
                        Ø¥Ø¶Ø§ÙØ© ØªÙ‚ÙŠÙŠÙ… Ø¬Ø¯ÙŠØ¯
                    </button>
                </div>
            `;
            return;
        }

        container.innerHTML = `
            <div class="table-wrapper" style="overflow-x: auto;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Ø§Ù„Ù†Ø´Ø§Ø·/Ø§Ù„Ù…Ù‡Ù…Ø©</th>
                            <th>Ø§Ù„Ù…ÙˆÙ‚Ø¹</th>
                            <th>Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…Ø®Ø§Ø·Ø±</th>
                            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                            <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${assessments.map(assessment => `
                            <tr>
                                <td>${Utils.escapeHTML(assessment.activity || '')}</td>
                                <td>${Utils.escapeHTML(assessment.location || '')}</td>
                                <td>
                                    <span class="badge badge-${this.getRiskLevelBadgeClass(assessment.riskLevel)}">
                                        ${assessment.riskLevel || '-'}
                                    </span>
                                </td>
                                <td>${assessment.date ? Utils.formatDate(assessment.date) : '-'}</td>
                                <td>
                                    <span class="badge badge-${assessment.status === 'Ù…ÙƒØªÙ…Ù„' ? 'success' : 'warning'}">
                                        ${assessment.status || '-'}
                                    </span>
                                </td>
                                <td>
                                    <div class="flex items-center gap-2">
                                        <button onclick="RiskAssessment.viewAssessment('${assessment.id}')" class="btn-icon btn-icon-info">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button onclick="RiskAssessment.editAssessment('${assessment.id}')" class="btn-icon btn-icon-primary">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button onclick="RiskAssessment.deleteAssessment('${assessment.id}')" class="btn-icon btn-icon-danger">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
    },

    getRiskLevelBadgeClass(riskLevel) {
        if (!riskLevel) return 'secondary';
        const level = parseInt(riskLevel);
        if (level <= 5) return 'success';
        if (level <= 10) return 'info';
        if (level <= 15) return 'warning';
        return 'danger';
    },

    setupEventListeners() {
        setTimeout(() => {
            const addBtn = document.getElementById('add-risk-assessment-btn');
            const addEmptyBtn = document.getElementById('add-risk-assessment-empty-btn');
            if (addBtn) addBtn.addEventListener('click', () => this.showForm());
            if (addEmptyBtn) addEmptyBtn.addEventListener('click', () => this.showForm());
            
            // Export Excel button
            const exportExcelBtn = document.getElementById('export-risk-excel-btn');
            if (exportExcelBtn) {
                exportExcelBtn.addEventListener('click', () => this.exportToExcel());
            }
        }, 100);
    },
    
    async exportToExcel() {
        try {
            Loading.show();
            
            if (typeof XLSX === 'undefined') {
                Loading.hide();
                Notification.error('Ù…ÙƒØªØ¨Ø© SheetJS ØºÙŠØ± Ù…Ø­Ù…Ù‘Ù„Ø©. ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©');
                return;
            }
            
            const assessments = AppState.appData.riskAssessments || [];
            
            const excelData = assessments.map(risk => ({
                'Ø§Ù„Ù†Ø´Ø§Ø·/Ø§Ù„Ù…Ù‡Ù…Ø©': risk.activity || '',
                'Ø§Ù„Ù…ÙˆÙ‚Ø¹': risk.location || '',
                'Ø§Ù„ØªØ§Ø±ÙŠØ®': risk.date ? Utils.formatDate(risk.date) : '',
                'Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…Ø®Ø§Ø·Ø±': risk.riskLevel || '',
                'Ø§Ù„Ø­Ø§Ù„Ø©': risk.status || '',
                'Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„ØªØµØ­ÙŠØ­ÙŠØ©': risk.correctiveActions || '',
                'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡': risk.createdAt ? Utils.formatDate(risk.createdAt) : ''
            }));
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(excelData);
            
            ws['!cols'] = [
                { wch: 30 }, // Ø§Ù„Ù†Ø´Ø§Ø·
                { wch: 20 }, // Ø§Ù„Ù…ÙˆÙ‚Ø¹
                { wch: 15 }, // Ø§Ù„ØªØ§Ø±ÙŠØ®
                { wch: 15 }, // Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…Ø®Ø§Ø·Ø±
                { wch: 15 }, // Ø§Ù„Ø­Ø§Ù„Ø©
                { wch: 50 }, // Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„ØªØµØ­ÙŠØ­ÙŠØ©
                { wch: 15 }  // ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡
            ];
            
            XLSX.utils.book_append_sheet(wb, ws, 'ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…Ø®Ø§Ø·Ø±');
            
            const date = new Date().toISOString().slice(0, 10);
            const filename = `Ø³Ø¬Ù„_ØªÙ‚ÙŠÙŠÙ…_Ø§Ù„Ù…Ø®Ø§Ø·Ø±_${date}.xlsx`;
            
            XLSX.writeFile(wb, filename);
            
            Loading.hide();
            Notification.success('ØªÙ… ØªØµØ¯ÙŠØ± Ø³Ø¬Ù„ ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…Ø®Ø§Ø·Ø± Ø¨Ù†Ø¬Ø§Ø­');
        } catch (error) {
            Loading.hide();
            console.error('Ø®Ø·Ø£ ÙÙŠ ØªØµØ¯ÙŠØ± Excel:', error);
            Notification.error('ÙØ´Ù„ ØªØµØ¯ÙŠØ± Excel: ' + error.message);
        }
    },

    async showForm(data = null) {
        const isEdit = !!data;
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 900px;">
                <div class="modal-header">
                    <h2 class="modal-title">${isEdit ? 'ØªØ¹Ø¯ÙŠÙ„ ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…Ø®Ø§Ø·Ø±' : 'Ø¥Ø¶Ø§ÙØ© ØªÙ‚ÙŠÙŠÙ… Ù…Ø®Ø§Ø·Ø± Ø¬Ø¯ÙŠØ¯'}</h2>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="risk-assessment-form" class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„Ù†Ø´Ø§Ø·/Ø§Ù„Ù…Ù‡Ù…Ø© *</label>
                                <input type="text" id="risk-activity" required class="form-input"
                                    value="${Utils.escapeHTML(data?.activity || '')}" placeholder="ÙˆØµÙ Ø§Ù„Ù†Ø´Ø§Ø·">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„Ù…ÙˆÙ‚Ø¹ *</label>
                                <input type="text" id="risk-location" required class="form-input"
                                    value="${Utils.escapeHTML(data?.location || '')}" placeholder="Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù…Ù„">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„ØªØ§Ø±ÙŠØ® *</label>
                                <input type="date" id="risk-date" required class="form-input"
                                    value="${data?.date ? new Date(data.date).toISOString().slice(0, 10) : ''}">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„Ø­Ø§Ù„Ø© *</label>
                                <select id="risk-status" required class="form-input">
                                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø­Ø§Ù„Ø©</option>
                                    <option value="Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©" ${data?.status === 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©' ? 'selected' : ''}>Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</option>
                                    <option value="Ù…ÙƒØªÙ…Ù„" ${data?.status === 'Ù…ÙƒØªÙ…Ù„' ? 'selected' : ''}>Ù…ÙƒØªÙ…Ù„</option>
                                    <option value="ÙŠØªØ·Ù„Ø¨ Ø¥Ø¬Ø±Ø§Ø¡" ${data?.status === 'ÙŠØªØ·Ù„Ø¨ Ø¥Ø¬Ø±Ø§Ø¡' ? 'selected' : ''}>ÙŠØªØ·Ù„Ø¨ Ø¥Ø¬Ø±Ø§Ø¡</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="border-t pt-4 mt-4">
                            <h3 class="text-lg font-semibold mb-3">Ù…ØµÙÙˆÙØ© ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…Ø®Ø§Ø·Ø±</h3>
                            <div id="risk-matrix-container">
                                ${typeof RiskMatrix !== 'undefined' ? RiskMatrix.generate('risk-assessment-matrix') : ''}
                            </div>
                            <div class="mt-4">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…Ø®Ø§Ø·Ø±</label>
                                <input type="text" id="risk-level" readonly class="form-input" style="background-color: #f3f4f6;"
                                    value="${data?.riskLevel || ''}" placeholder="Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯Ù‡ Ù…Ù† Ø§Ù„Ù…ØµÙÙˆÙØ©">
                            </div>
                        </div>
                        
                        <div class="col-span-2">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„ØªØµØ­ÙŠØ­ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©</label>
                            <textarea id="risk-corrective-actions" class="form-input" rows="4"
                                placeholder="ÙˆØµÙ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„ØªØµØ­ÙŠØ­ÙŠØ©">${Utils.escapeHTML(data?.correctiveActions || '')}</textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="this.closest('.modal-overlay').remove()">Ø¥Ù„ØºØ§Ø¡</button>
                    <button type="submit" form="risk-assessment-form" class="btn-primary">Ø­ÙØ¸</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        
        // Setup risk matrix click handler
        setTimeout(() => {
            if (typeof RiskMatrix !== 'undefined') {
                const matrix = document.getElementById('risk-assessment-matrix');
                if (matrix) {
                    matrix.querySelectorAll('td').forEach(cell => {
                        cell.addEventListener('click', () => {
                            const result = RiskMatrix.selectCell('risk-assessment-matrix', 
                                parseInt(cell.closest('tr').rowIndex - 1),
                                parseInt(cell.cellIndex - 1));
                            if (result) {
                                document.getElementById('risk-level').value = result.riskLevel;
                            }
                        });
                    });
                }
            }
        }, 100);
        
        const form = modal.querySelector('#risk-assessment-form');
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            this.handleSubmit(data?.id, modal);
        });
        
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
        });
    },

    async handleSubmit(editId, modal) {
        const formData = {
            id: editId || Utils.generateId('RISK'),
            activity: document.getElementById('risk-activity').value.trim(),
            location: document.getElementById('risk-location').value.trim(),
            date: new Date(document.getElementById('risk-date').value).toISOString(),
            status: document.getElementById('risk-status').value,
            riskLevel: document.getElementById('risk-level').value,
            correctiveActions: document.getElementById('risk-corrective-actions').value.trim(),
            createdAt: editId ? AppState.appData.riskAssessments?.find(r => r.id === editId)?.createdAt : new Date().toISOString(),
            updatedAt: new Date().toISOString()
        };

        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…ØµÙÙˆÙØ©
        if (!AppState.appData.riskAssessments) {
            AppState.appData.riskAssessments = [];
        }

        Loading.show();
        try {
            if (editId) {
                const index = AppState.appData.riskAssessments.findIndex(r => r.id === editId);
                if (index !== -1) AppState.appData.riskAssessments[index] = formData;
                Notification.success('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø¨Ù†Ø¬Ø§Ø­');
            } else {
                AppState.appData.riskAssessments.push(formData);
                Notification.success('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø¨Ù†Ø¬Ø§Ø­');
            }

            DataManager.save();
            await GoogleIntegration.autoSave('RiskAssessments', AppState.appData.riskAssessments);
            
            Loading.hide();
            modal.remove();
            this.load();
        } catch (error) {
            Loading.hide();
            Notification.error('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
        }
    },

    async editAssessment(id) {
        const assessment = AppState.appData.riskAssessments.find(r => r.id === id);
        if (assessment) await this.showForm(assessment);
    },

    async viewAssessment(id) {
        const assessment = AppState.appData.riskAssessments.find(r => r.id === id);
        if (!assessment) return;

        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 700px;">
                <div class="modal-header">
                    <h2 class="modal-title">ØªÙØ§ØµÙŠÙ„ ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…Ø®Ø§Ø·Ø±</h2>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="space-y-3">
                        <div><strong>Ø§Ù„Ù†Ø´Ø§Ø·:</strong> ${Utils.escapeHTML(assessment.activity || '')}</div>
                        <div><strong>Ø§Ù„Ù…ÙˆÙ‚Ø¹:</strong> ${Utils.escapeHTML(assessment.location || '')}</div>
                        <div><strong>Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…Ø®Ø§Ø·Ø±:</strong> 
                            <span class="badge badge-${this.getRiskLevelBadgeClass(assessment.riskLevel)}">
                                ${assessment.riskLevel || '-'}
                            </span>
                        </div>
                        <div><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${Utils.formatDate(assessment.date)}</div>
                        <div><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> ${Utils.escapeHTML(assessment.status || '')}</div>
                        <div><strong>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„ØªØµØ­ÙŠØ­ÙŠØ©:</strong><br>${Utils.escapeHTML(assessment.correctiveActions || '')}</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="this.closest('.modal-overlay').remove()">Ø¥ØºÙ„Ø§Ù‚</button>
                    <button type="button" onclick="RiskAssessment.editAssessment('${assessment.id}'); this.closest('.modal-overlay').remove();" class="btn-primary">ØªØ¹Ø¯ÙŠÙ„</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
        });
    },

    async deleteAssessment(id) {
        if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…ØŸ')) return;
        Loading.show();
        try {
            AppState.appData.riskAssessments = AppState.appData.riskAssessments.filter(r => r.id !== id);
            DataManager.save();
            Loading.hide();
            Notification.success('ØªÙ… Ø­Ø°Ù Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø¨Ù†Ø¬Ø§Ø­');
            this.load();
        } catch (error) {
            Loading.hide();
            Notification.error('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
        }
    }
};

// ===== SOP-JHA Module (ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø³Ù„Ø§Ù…Ø© SOP-JHA) =====
const SOPJHA = {
    async load() {
        const section = document.getElementById('sop-jha-section');
        if (!section) return;

        section.innerHTML = `
            <div class="section-header">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="section-title">
                            <i class="fas fa-file-contract ml-3"></i>
                            ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø³Ù„Ø§Ù…Ø© SOP-JHA
                        </h1>
                        <p class="section-subtitle">Ø¥Ø¯Ø§Ø±Ø© ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø³Ù„Ø§Ù…Ø© ÙˆØ¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ø¢Ù…Ù†Ø© (SOP/JHA)</p>
                    </div>
                    <button id="add-sop-jha-btn" class="btn-primary">
                        <i class="fas fa-plus ml-2"></i>
                        Ø¥Ø¶Ø§ÙØ© ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©
                    </button>
                </div>
            </div>
            <div id="sop-jha-content" class="mt-6">
                ${await this.renderList()}
            </div>
        `;
        this.setupEventListeners();
        this.loadSOPJHAList();
    },

    async renderList() {
        return `
            <div class="content-card">
                <div class="card-header">
                    <h2 class="card-title"><i class="fas fa-list ml-2"></i>Ù‚Ø§Ø¦Ù…Ø© ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø³Ù„Ø§Ù…Ø©</h2>
                </div>
                <div class="card-body">
                    <div id="sop-jha-table-container">
                        <div class="empty-state">
                            <i class="fas fa-spinner fa-spin text-4xl text-gray-300 mb-4"></i>
                            <p class="text-gray-500">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
                        </div>
                    </div>
                </div>
            </div>
        `;
    },

    async loadSOPJHAList() {
        const container = document.getElementById('sop-jha-table-container');
        if (!container) return;
        
        const items = AppState.appData.sopJHA || [];
        
        if (items.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-file-contract text-4xl text-gray-300 mb-4"></i>
                    <p class="text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø³Ù„Ø§Ù…Ø©</p>
                    <button id="add-sop-jha-empty-btn" class="btn-primary mt-4">
                        <i class="fas fa-plus ml-2"></i>
                        Ø¥Ø¶Ø§ÙØ© ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©
                    </button>
                </div>
            `;
            return;
        }

        container.innerHTML = `
            <div class="table-wrapper" style="overflow-x: auto;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Ø§Ù„Ù†ÙˆØ¹</th>
                            <th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
                            <th>Ø§Ù„Ù‚Ø³Ù…</th>
                            <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØµØ¯Ø§Ø±</th>
                            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                            <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${items.map(item => `
                            <tr>
                                <td>
                                    <span class="badge badge-${item.type === 'SOP' ? 'info' : 'warning'}">
                                        ${item.type || 'SOP'}
                                    </span>
                                </td>
                                <td>${Utils.escapeHTML(item.title || '')}</td>
                                <td>${Utils.escapeHTML(item.department || '')}</td>
                                <td>${item.issueDate ? Utils.formatDate(item.issueDate) : '-'}</td>
                                <td>
                                    <span class="badge badge-${item.status === 'Ù†Ø´Ø·' ? 'success' : 'warning'}">
                                        ${item.status || '-'}
                                    </span>
                                </td>
                                <td>
                                    <div class="flex items-center gap-2">
                                        <button onclick="SOPJHA.viewSOPJHA('${item.id}')" class="btn-icon btn-icon-info" title="Ø¹Ø±Ø¶">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button onclick="SOPJHA.exportPDF('${item.id}')" class="btn-icon btn-icon-success" title="ØªØµØ¯ÙŠØ± PDF">
                                            <i class="fas fa-file-pdf"></i>
                                        </button>
                                        <button onclick="SOPJHA.editSOPJHA('${item.id}')" class="btn-icon btn-icon-primary" title="ØªØ¹Ø¯ÙŠÙ„">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button onclick="SOPJHA.deleteSOPJHA('${item.id}')" class="btn-icon btn-icon-danger" title="Ø­Ø°Ù">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
    },

    setupEventListeners() {
        setTimeout(() => {
            const addBtn = document.getElementById('add-sop-jha-btn');
            const addEmptyBtn = document.getElementById('add-sop-jha-empty-btn');
            if (addBtn) addBtn.addEventListener('click', () => this.showForm());
            if (addEmptyBtn) addEmptyBtn.addEventListener('click', () => this.showForm());
        }, 100);
    },

    async showForm(data = null) {
        const isEdit = !!data;
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 900px;">
                <div class="modal-header">
                    <h2 class="modal-title">${isEdit ? 'ØªØ¹Ø¯ÙŠÙ„ ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø³Ù„Ø§Ù…Ø©' : 'Ø¥Ø¶Ø§ÙØ© ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø³Ù„Ø§Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©'}</h2>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="sop-jha-form" class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„Ù†ÙˆØ¹ *</label>
                                <select id="sop-type" required class="form-input">
                                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù†ÙˆØ¹</option>
                                    <option value="SOP" ${data?.type === 'SOP' ? 'selected' : ''}>SOP - Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠØ©</option>
                                    <option value="JHA" ${data?.type === 'JHA' ? 'selected' : ''}>JHA - ØªØ­Ù„ÙŠÙ„ Ù…Ø®Ø§Ø·Ø± Ø§Ù„ÙˆØ¸ÙŠÙØ©</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† *</label>
                                <input type="text" id="sop-title" required class="form-input"
                                    value="${Utils.escapeHTML(data?.title || '')}" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„Ù‚Ø³Ù… *</label>
                                <input type="text" id="sop-department" required class="form-input"
                                    value="${Utils.escapeHTML(data?.department || '')}" placeholder="Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø¹Ù†ÙŠ">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØµØ¯Ø§Ø± *</label>
                                <input type="date" id="sop-issue-date" required class="form-input"
                                    value="${data?.issueDate ? new Date(data.issueDate).toISOString().slice(0, 10) : ''}">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„Ø­Ø§Ù„Ø© *</label>
                                <select id="sop-status" required class="form-input">
                                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø­Ø§Ù„Ø©</option>
                                    <option value="Ù†Ø´Ø·" ${data?.status === 'Ù†Ø´Ø·' ? 'selected' : ''}>Ù†Ø´Ø·</option>
                                    <option value="Ù…Ø±Ø§Ø¬Ø¹Ø©" ${data?.status === 'Ù…Ø±Ø§Ø¬Ø¹Ø©' ? 'selected' : ''}>Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</option>
                                    <option value="Ù…Ù†ØªÙ‡ÙŠ" ${data?.status === 'Ù…Ù†ØªÙ‡ÙŠ' ? 'selected' : ''}>Ù…Ù†ØªÙ‡ÙŠ</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„Ù†Ø³Ø®Ø©</label>
                                <input type="text" id="sop-version" class="form-input"
                                    value="${Utils.escapeHTML(data?.version || '1.0')}" placeholder="1.0">
                            </div>
                        </div>
                        
                        <div class="col-span-2">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„ÙˆØµÙ / Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª *</label>
                            <textarea id="sop-procedures" required class="form-input" rows="8"
                                placeholder="ÙˆØµÙ ØªÙØµÙŠÙ„ÙŠ Ù„Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª ÙˆØ§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª">${Utils.escapeHTML(data?.procedures || '')}</textarea>
                        </div>
                        
                        <div class="col-span-2">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„Ù…Ø®Ø§Ø·Ø± Ø§Ù„Ù…Ø­ØªÙ…Ù„Ø©</label>
                            <textarea id="sop-hazards" class="form-input" rows="4"
                                placeholder="ÙˆØµÙ Ø§Ù„Ù…Ø®Ø§Ø·Ø± Ø§Ù„Ù…Ø­ØªÙ…Ù„Ø© ÙˆØ·Ø±Ù‚ Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹Ù‡Ø§">${Utils.escapeHTML(data?.hazards || '')}</textarea>
                        </div>
                        
                        <div class="col-span-2">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ù…Ù‡Ù…Ø§Øª Ø§Ù„ÙˆÙ‚Ø§ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©</label>
                            <div id="sop-ppe-matrix">
                                ${typeof PPEMatrix !== 'undefined' ? PPEMatrix.generate('sop-ppe-matrix') : ''}
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="this.closest('.modal-overlay').remove()">Ø¥Ù„ØºØ§Ø¡</button>
                    <button type="submit" form="sop-jha-form" class="btn-primary">Ø­ÙØ¸</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        
        const form = modal.querySelector('#sop-jha-form');
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            this.handleSubmit(data?.id, modal);
        });
        
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
        });
    },

    async handleSubmit(editId, modal) {
        const formData = {
            id: editId || Utils.generateId('SOP'),
            type: document.getElementById('sop-type').value,
            title: document.getElementById('sop-title').value.trim(),
            department: document.getElementById('sop-department').value.trim(),
            issueDate: new Date(document.getElementById('sop-issue-date').value).toISOString(),
            status: document.getElementById('sop-status').value,
            version: document.getElementById('sop-version').value.trim(),
            procedures: document.getElementById('sop-procedures').value.trim(),
            hazards: document.getElementById('sop-hazards').value.trim(),
            requiredPPE: typeof PPEMatrix !== 'undefined' ? PPEMatrix.getSelected() : [],
            createdAt: editId ? AppState.appData.sopJHA?.find(s => s.id === editId)?.createdAt : new Date().toISOString(),
            updatedAt: new Date().toISOString()
        };

        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…ØµÙÙˆÙØ©
        if (!AppState.appData.sopJHA) {
            AppState.appData.sopJHA = [];
        }

        Loading.show();
        try {
            if (editId) {
                const index = AppState.appData.sopJHA.findIndex(s => s.id === editId);
                if (index !== -1) AppState.appData.sopJHA[index] = formData;
                Notification.success('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
            } else {
                AppState.appData.sopJHA.push(formData);
                Notification.success('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
            }

            DataManager.save();
            await GoogleIntegration.autoSave('SOPJHA', AppState.appData.sopJHA);
            
            Loading.hide();
            modal.remove();
            this.load();
        } catch (error) {
            Loading.hide();
            Notification.error('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
        }
    },

    async editSOPJHA(id) {
        const item = AppState.appData.sopJHA.find(s => s.id === id);
        if (item) await this.showForm(item);
    },

    async viewSOPJHA(id) {
        const item = AppState.appData.sopJHA.find(s => s.id === id);
        if (!item) return;

        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 800px;">
                <div class="modal-header">
                    <h2 class="modal-title">${item.type}: ${Utils.escapeHTML(item.title)}</h2>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div><strong>Ø§Ù„Ù†ÙˆØ¹:</strong> ${Utils.escapeHTML(item.type || '')}</div>
                            <div><strong>Ø§Ù„Ù‚Ø³Ù…:</strong> ${Utils.escapeHTML(item.department || '')}</div>
                            <div><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØµØ¯Ø§Ø±:</strong> ${Utils.formatDate(item.issueDate)}</div>
                            <div><strong>Ø§Ù„Ù†Ø³Ø®Ø©:</strong> ${Utils.escapeHTML(item.version || '')}</div>
                            <div><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> 
                                <span class="badge badge-${item.status === 'Ù†Ø´Ø·' ? 'success' : 'warning'}">
                                    ${item.status || '-'}
                                </span>
                            </div>
                        </div>
                        <div><strong>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª:</strong><br><div class="p-3 bg-gray-50 rounded">${Utils.escapeHTML(item.procedures || '')}</div></div>
                        ${item.hazards ? `<div><strong>Ø§Ù„Ù…Ø®Ø§Ø·Ø±:</strong><br><div class="p-3 bg-red-50 rounded">${Utils.escapeHTML(item.hazards)}</div></div>` : ''}
                        ${item.requiredPPE && item.requiredPPE.length > 0 ? `
                            <div><strong>Ù…Ù‡Ù…Ø§Øª Ø§Ù„ÙˆÙ‚Ø§ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:</strong><br>
                                ${item.requiredPPE.map(ppe => `<span class="badge badge-info mr-2">${ppe}</span>`).join('')}
                            </div>
                        ` : ''}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="this.closest('.modal-overlay').remove()">Ø¥ØºÙ„Ø§Ù‚</button>
                    <button type="button" onclick="SOPJHA.exportPDF('${item.id}');" class="btn-success">
                        <i class="fas fa-file-pdf ml-2"></i>ØªØµØ¯ÙŠØ± PDF
                    </button>
                    <button type="button" onclick="SOPJHA.editSOPJHA('${item.id}'); this.closest('.modal-overlay').remove();" class="btn-primary">ØªØ¹Ø¯ÙŠÙ„</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
        });
    },

    async deleteSOPJHA(id) {
        if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§ØªØŸ')) return;
        Loading.show();
        try {
            AppState.appData.sopJHA = AppState.appData.sopJHA.filter(s => s.id !== id);
            DataManager.save();
            Loading.hide();
            Notification.success('ØªÙ… Ø­Ø°Ù Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
            this.load();
        } catch (error) {
            Loading.hide();
            Notification.error('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
        }
    },
    
    async exportPDF(id) {
        const item = AppState.appData.sopJHA.find(s => s.id === id);
        if (!item) {
            Notification.error('Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
            return;
        }
        
        try {
            Loading.show();
            
            const formCode = item.isoCode || item.id?.substring(0, 12) || 'SOP-UNKNOWN';
            const formTitle = `${item.type}: ${item.title || 'ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø³Ù„Ø§Ù…Ø©'}`;
            
            const content = `
                <table>
                    <tr><th>Ø§Ù„Ù†ÙˆØ¹</th><td>${Utils.escapeHTML(item.type || 'N/A')}</td></tr>
                    <tr><th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th><td>${Utils.escapeHTML(item.title || 'N/A')}</td></tr>
                    <tr><th>Ø§Ù„Ù‚Ø³Ù…</th><td>${Utils.escapeHTML(item.department || 'N/A')}</td></tr>
                    <tr><th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØµØ¯Ø§Ø±</th><td>${item.issueDate ? Utils.formatDate(item.issueDate) : 'N/A'}</td></tr>
                    <tr><th>Ø§Ù„Ù†Ø³Ø®Ø©</th><td>${Utils.escapeHTML(item.version || 'N/A')}</td></tr>
                    <tr><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><td>${Utils.escapeHTML(item.status || 'N/A')}</td></tr>
                </table>
                <div class="section-title">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª / Ø§Ù„ÙˆØµÙ:</div>
                <div class="description">${Utils.escapeHTML(item.procedures || 'N/A')}</div>
                ${item.hazards ? `
                    <div class="section-title">Ø§Ù„Ù…Ø®Ø§Ø·Ø± Ø§Ù„Ù…Ø­ØªÙ…Ù„Ø©:</div>
                    <div class="description">${Utils.escapeHTML(item.hazards)}</div>
                ` : ''}
                ${item.requiredPPE && item.requiredPPE.length > 0 ? `
                    <div class="section-title">Ù…Ù‡Ù…Ø§Øª Ø§Ù„ÙˆÙ‚Ø§ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:</div>
                    <table>
                        <tr>
                            <th>Ù†ÙˆØ¹ Ù…Ù‡Ù…Ø§Øª Ø§Ù„ÙˆÙ‚Ø§ÙŠØ©</th>
                            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                        </tr>
                        ${item.requiredPPE.map(ppe => `
                            <tr>
                                <td>${Utils.escapeHTML(ppe)}</td>
                                <td>âœ“ Ù…Ø·Ù„ÙˆØ¨</td>
                            </tr>
                        `).join('')}
                    </table>
                ` : ''}
            `;
            
            const htmlContent = typeof FormHeader !== 'undefined' && FormHeader.generatePDFHTML
                ? FormHeader.generatePDFHTML(formCode, formTitle, content, true, true)
                : `<html><body>${content}</body></html>`;
            
            const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const printWindow = window.open(url, '_blank');
            
            if (printWindow) {
                printWindow.onload = () => {
                    setTimeout(() => {
                        printWindow.print();
                        setTimeout(() => {
                            URL.revokeObjectURL(url);
                            Loading.hide();
                            Notification.success('ØªÙ… ÙØªØ­ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©/Ø§Ù„Ø­ÙØ¸ ÙƒÙ€ PDF');
                        }, 1000);
                    }, 500);
                };
            } else {
                Loading.hide();
                Notification.error('ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ù„Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±');
            }
        } catch (error) {
            Loading.hide();
            console.error('Ø®Ø·Ø£ ÙÙŠ ØªØµØ¯ÙŠØ± PDF:', error);
            Notification.error('ÙØ´Ù„ ØªØµØ¯ÙŠØ± PDF: ' + error.message);
        }
    }
};

// ===== Legal Documents Module (Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠØ© ÙˆØ§Ù„ØªØ´Ø±ÙŠØ¹ÙŠØ©) =====
const LegalDocuments = {
    async load() {
        const section = document.getElementById('legal-documents-section');
        if (!section) return;
        
        section.innerHTML = `
            <div class="section-header">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="section-title">
                            <i class="fas fa-gavel ml-3"></i>
                            Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠØ© ÙˆØ§Ù„ØªØ´Ø±ÙŠØ¹ÙŠØ©
                        </h1>
                        <p class="section-subtitle">Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠØ© ÙˆÙØªØ±Ø© ØµÙ„Ø§Ø­ÙŠØªÙ‡Ø§ ÙˆØ§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª</p>
                    </div>
                    <div class="flex gap-2">
                        <button id="check-legal-updates-btn" class="btn-warning">
                            <i class="fas fa-sync-alt ml-2"></i>
                            Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠØ©
                        </button>
                        <button id="add-legal-document-btn" class="btn-primary">
                            <i class="fas fa-plus ml-2"></i>
                            Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ†Ø¯ Ù‚Ø§Ù†ÙˆÙ†ÙŠ
                        </button>
                    </div>
                </div>
            </div>
            <div id="legal-documents-content" class="mt-6">
                ${await this.renderList()}
            </div>
        `;
        this.setupEventListeners();
        this.loadLegalDocumentsList();
        this.checkExpiringDocuments();
    },
    
    async renderList() {
        return `
            <div class="content-card">
                <div class="card-header">
                    <div class="flex items-center justify-between">
                        <h2 class="card-title"><i class="fas fa-list ml-2"></i>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠØ©</h2>
                        <button id="export-legal-excel-btn" class="btn-success">
                            <i class="fas fa-file-excel ml-2"></i>ØªØµØ¯ÙŠØ± Excel
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="legal-documents-table-container">
                        <div class="empty-state">
                            <i class="fas fa-spinner fa-spin text-4xl text-gray-300 mb-4"></i>
                            <p class="text-gray-500">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="content-card mt-6">
                <div class="card-header">
                    <h2 class="card-title"><i class="fas fa-link ml-2"></i>Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠØ©</h2>
                </div>
                <div class="card-body">
                    <div class="space-y-4">
                        <div class="bg-blue-50 border border-blue-200 rounded p-4">
                            <p class="text-sm text-blue-800 mb-3">
                                <i class="fas fa-info-circle ml-2"></i>
                                <strong>Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª:</strong> ÙŠÙ…ÙƒÙ†Ùƒ Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠØ© ÙˆØ§Ù„ØªØ´Ø±ÙŠØ¹ÙŠØ© Ø¹Ø¨Ø± Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„ØªØ´Ø±ÙŠØ¹Ø§Øª ÙˆØ§Ù„Ù‚ÙˆØ§Ù†ÙŠÙ† Ø§Ù„Ø±Ø³Ù…ÙŠØ©
                            </p>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        <i class="fas fa-globe ml-2"></i>
                                        Ø±Ø§Ø¨Ø· Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„ØªØ´Ø±ÙŠØ¹Ø§Øª
                                    </label>
                                    <input type="url" id="legal-portal-url" class="form-input" 
                                        value="${AppState.legalPortalUrl || ''}" 
                                        placeholder="https://example.com/legal-portal">
                                    <p class="text-xs text-gray-500 mt-1">Ø±Ø§Ø¨Ø· Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„ØªØ´Ø±ÙŠØ¹Ø§Øª Ø§Ù„Ø±Ø³Ù…ÙŠØ© Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                        <i class="fas fa-bell ml-2"></i>
                                        ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="legal-auto-notify" class="rounded border-gray-300 text-blue-600"
                                            ${AppState.legalAutoNotify ? 'checked' : ''}>
                                        <span class="mr-2 text-sm text-gray-700">ØªÙ†Ø¨ÙŠÙ‡ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ ÙˆØ¬ÙˆØ¯ ØªØ­Ø¯ÙŠØ«Ø§Øª</span>
                                    </label>
                                </div>
                            </div>
                            <div class="mt-4">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <i class="fas fa-keywords ml-2"></i>
                                    ÙƒÙ„Ù…Ø§Øª Ù…ÙØªØ§Ø­ÙŠØ© Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©
                                </label>
                                <textarea id="legal-keywords" class="form-input" rows="3"
                                    placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…ÙØªØ§Ø­ÙŠØ© Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø© (Ù…ÙØµÙˆÙ„Ø© Ø¨ÙÙˆØ§ØµÙ„)">${(AppState.legalKeywords || []).join(', ')}</textarea>
                                <p class="text-xs text-gray-500 mt-1">Ù…Ø«Ø§Ù„: Ø³Ù„Ø§Ù…Ø© Ù…Ù‡Ù†ÙŠØ©ØŒ Ø¨ÙŠØ¦Ø©ØŒ ØµØ­Ø©ØŒ ØªØ´Ø±ÙŠØ¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„</p>
                            </div>
                            <button type="button" id="save-legal-settings-btn" class="btn-primary mt-3">
                                <i class="fas fa-save ml-2"></i>Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    },
    
    async loadLegalDocumentsList() {
        const container = document.getElementById('legal-documents-table-container');
        if (!container) return;
        
        const documents = AppState.appData.legalDocuments || [];
        
        if (documents.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-gavel text-4xl text-gray-300 mb-4"></i>
                    <p class="text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø³ØªÙ†Ø¯Ø§Øª Ù‚Ø§Ù†ÙˆÙ†ÙŠØ©</p>
                    <button id="add-legal-document-empty-btn" class="btn-primary mt-4">
                        <i class="fas fa-plus ml-2"></i>
                        Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ†Ø¯ Ù‚Ø§Ù†ÙˆÙ†ÙŠ
                    </button>
                </div>
            `;
            return;
        }
        
        container.innerHTML = `
            <div class="table-wrapper" style="overflow-x: auto;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ÙƒÙˆØ¯ ISO</th>
                            <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ†Ø¯</th>
                            <th>Ø§Ù„Ù†ÙˆØ¹</th>
                            <th>Ø±Ù‚Ù… Ø§Ù„Ù…Ø³ØªÙ†Ø¯</th>
                            <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØµØ¯Ø§Ø±</th>
                            <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</th>
                            <th>Ù…Ø¯Ø© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© (Ø£ÙŠØ§Ù…)</th>
                            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                            <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${documents.map(doc => {
                            const expiryDate = new Date(doc.expiryDate);
                            const today = new Date();
                            const daysRemaining = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));
                            const isExpired = expiryDate < today;
                            const isExpiringSoon = daysRemaining <= doc.alertDays && daysRemaining > 0;
                            
                            return `
                            <tr class="${isExpired ? 'bg-red-50' : isExpiringSoon ? 'bg-yellow-50' : ''}">
                                <td>${Utils.escapeHTML(doc.isoCode || '')}</td>
                                <td>${Utils.escapeHTML(doc.documentName || '')}</td>
                                <td>${Utils.escapeHTML(doc.documentType || '')}</td>
                                <td>${Utils.escapeHTML(doc.documentNumber || '')}</td>
                                <td>${doc.issueDate ? Utils.formatDate(doc.issueDate) : '-'}</td>
                                <td>${doc.expiryDate ? Utils.formatDate(doc.expiryDate) : '-'}</td>
                                <td>
                                    <span class="${isExpired ? 'text-red-600 font-bold' : isExpiringSoon ? 'text-yellow-600 font-bold' : 'text-green-600'}">
                                        ${isExpired ? 'Ù…Ù†ØªÙ‡ÙŠ' : isExpiringSoon ? `${daysRemaining} ÙŠÙˆÙ…` : `${daysRemaining} ÙŠÙˆÙ…`}
                                    </span>
                                </td>
                                <td>
                                    <span class="badge badge-${isExpired ? 'danger' : isExpiringSoon ? 'warning' : 'success'}">
                                        ${isExpired ? 'Ù…Ù†ØªÙ‡ÙŠ' : isExpiringSoon ? 'Ù‚Ø§Ø±Ø¨ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡' : 'Ù†Ø´Ø·'}
                                    </span>
                                </td>
                                <td>
                                    <div class="flex items-center gap-2">
                                        <button onclick="LegalDocuments.viewDocument('${doc.id}')" class="btn-icon btn-icon-info" title="Ø¹Ø±Ø¶">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button onclick="LegalDocuments.exportPDF('${doc.id}')" class="btn-icon btn-icon-success" title="ØªØµØ¯ÙŠØ± PDF">
                                            <i class="fas fa-file-pdf"></i>
                                        </button>
                                        <button onclick="LegalDocuments.editDocument('${doc.id}')" class="btn-icon btn-icon-primary" title="ØªØ¹Ø¯ÙŠÙ„">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button onclick="LegalDocuments.deleteDocument('${doc.id}')" class="btn-icon btn-icon-danger" title="Ø­Ø°Ù">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
        `;
    },
    
    setupEventListeners() {
        setTimeout(() => {
            const addBtn = document.getElementById('add-legal-document-btn');
            const addEmptyBtn = document.getElementById('add-legal-document-empty-btn');
            if (addBtn) addBtn.addEventListener('click', () => this.showForm());
            if (addEmptyBtn) addEmptyBtn.addEventListener('click', () => this.showForm());
            
            const exportExcelBtn = document.getElementById('export-legal-excel-btn');
            if (exportExcelBtn) {
                exportExcelBtn.addEventListener('click', () => this.exportToExcel());
            }
            
            const checkUpdatesBtn = document.getElementById('check-legal-updates-btn');
            if (checkUpdatesBtn) {
                checkUpdatesBtn.addEventListener('click', () => this.checkLegalUpdates());
            }
            
            const saveSettingsBtn = document.getElementById('save-legal-settings-btn');
            if (saveSettingsBtn) {
                saveSettingsBtn.addEventListener('click', () => this.saveLegalSettings());
            }
        }, 100);
    },
    
    async showForm(data = null) {
        const isEdit = !!data;
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 900px;">
                <div class="modal-header">
                    <h2 class="modal-title">${isEdit ? 'ØªØ¹Ø¯ÙŠÙ„ Ù…Ø³ØªÙ†Ø¯ Ù‚Ø§Ù†ÙˆÙ†ÙŠ' : 'Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ†Ø¯ Ù‚Ø§Ù†ÙˆÙ†ÙŠ Ø¬Ø¯ÙŠØ¯'}</h2>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="legal-document-form" class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ†Ø¯ *</label>
                                <input type="text" id="legal-doc-name" required class="form-input"
                                    value="${Utils.escapeHTML(data?.documentName || '')}" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠ">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ØªÙ†Ø¯ *</label>
                                <select id="legal-doc-type" required class="form-input">
                                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù†ÙˆØ¹</option>
                                    <option value="ØªØ±Ø®ÙŠØµ" ${data?.documentType === 'ØªØ±Ø®ÙŠØµ' ? 'selected' : ''}>ØªØ±Ø®ÙŠØµ</option>
                                    <option value="Ø´Ù‡Ø§Ø¯Ø©" ${data?.documentType === 'Ø´Ù‡Ø§Ø¯Ø©' ? 'selected' : ''}>Ø´Ù‡Ø§Ø¯Ø©</option>
                                    <option value="Ø¹Ù‚Ø¯" ${data?.documentType === 'Ø¹Ù‚Ø¯' ? 'selected' : ''}>Ø¹Ù‚Ø¯</option>
                                    <option value="ÙˆØ«ÙŠÙ‚Ø© Ù‚Ø§Ù†ÙˆÙ†ÙŠØ©" ${data?.documentType === 'ÙˆØ«ÙŠÙ‚Ø© Ù‚Ø§Ù†ÙˆÙ†ÙŠØ©' ? 'selected' : ''}>ÙˆØ«ÙŠÙ‚Ø© Ù‚Ø§Ù†ÙˆÙ†ÙŠØ©</option>
                                    <option value="ØªØ´Ø±ÙŠØ¹" ${data?.documentType === 'ØªØ´Ø±ÙŠØ¹' ? 'selected' : ''}>ØªØ´Ø±ÙŠØ¹</option>
                                    <option value="Ù„ÙˆØ§Ø¦Ø­" ${data?.documentType === 'Ù„ÙˆØ§Ø¦Ø­' ? 'selected' : ''}>Ù„ÙˆØ§Ø¦Ø­</option>
                                    <option value="Ø£Ø®Ø±Ù‰" ${data?.documentType === 'Ø£Ø®Ø±Ù‰' ? 'selected' : ''}>Ø£Ø®Ø±Ù‰</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø±Ù‚Ù… Ø§Ù„Ù…Ø³ØªÙ†Ø¯ *</label>
                                <input type="text" id="legal-doc-number" required class="form-input"
                                    value="${Utils.escapeHTML(data?.documentNumber || '')}" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù…Ø³ØªÙ†Ø¯">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„ØµØ§Ø¯Ø± Ø¹Ù† *</label>
                                <input type="text" id="legal-doc-issued-by" required class="form-input"
                                    value="${Utils.escapeHTML(data?.issuedBy || '')}" placeholder="Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„ØµØ§Ø¯Ø±Ø©">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØµØ¯Ø§Ø± *</label>
                                <input type="date" id="legal-doc-issue-date" required class="form-input"
                                    value="${data?.issueDate ? new Date(data.issueDate).toISOString().slice(0, 10) : ''}">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ *</label>
                                <input type="date" id="legal-doc-expiry-date" required class="form-input"
                                    value="${data?.expiryDate ? new Date(data.expiryDate).toISOString().slice(0, 10) : ''}">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø¹Ø¯Ø¯ Ø£ÙŠØ§Ù… Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ù‚Ø¨Ù„ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ *</label>
                                <input type="number" id="legal-doc-alert-days" required class="form-input"
                                    value="${data?.alertDays || 30}" min="1" placeholder="30">
                                <p class="text-xs text-gray-500 mt-1">Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ ØªÙ†Ø¨ÙŠÙ‡ Ù‚Ø¨Ù„ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¯Ø¯ Ù…Ù† Ø§Ù„Ø£ÙŠØ§Ù…</p>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„Ø­Ø§Ù„Ø© *</label>
                                <select id="legal-doc-status" required class="form-input">
                                    <option value="Ù†Ø´Ø·" ${data?.status === 'Ù†Ø´Ø·' || !data ? 'selected' : ''}>Ù†Ø´Ø·</option>
                                    <option value="Ù…Ù†ØªÙ‡ÙŠ" ${data?.status === 'Ù…Ù†ØªÙ‡ÙŠ' ? 'selected' : ''}>Ù…Ù†ØªÙ‡ÙŠ</option>
                                    <option value="Ù…Ù„ØºÙŠ" ${data?.status === 'Ù…Ù„ØºÙŠ' ? 'selected' : ''}>Ù…Ù„ØºÙŠ</option>
                                </select>
                            </div>
                            <div class="col-span-2">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„ÙˆØµÙ / Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                                <textarea id="legal-doc-description" class="form-input" rows="4"
                                    placeholder="ÙˆØµÙ Ø§Ù„Ù…Ø³ØªÙ†Ø¯ Ø£Ùˆ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©">${Utils.escapeHTML(data?.description || '')}</textarea>
                            </div>
                            <div class="col-span-2">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <i class="fas fa-link ml-2"></i>
                                    Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø³ØªÙ†Ø¯ (Ø¥Ù† ÙˆØ¬Ø¯)
                                </label>
                                <input type="url" id="legal-doc-link" class="form-input"
                                    value="${Utils.escapeHTML(data?.documentLink || '')}" placeholder="https://example.com/document">
                            </div>
                        </div>
                        <div class="flex items-center justify-end gap-4 pt-4 border-t">
                            <button type="button" class="btn-secondary" onclick="this.closest('.modal-overlay').remove()">Ø¥Ù„ØºØ§Ø¡</button>
                            <button type="submit" class="btn-primary">
                                <i class="fas fa-save ml-2"></i>${isEdit ? 'Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª' : 'Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªÙ†Ø¯'}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        
        const form = modal.querySelector('#legal-document-form');
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            this.handleSubmit(data?.id, modal);
        });
        
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
        });
    },
    
    async handleSubmit(editId, modal) {
        if (!AppState.appData.legalDocuments) {
            AppState.appData.legalDocuments = [];
        }
        
        const formData = {
            id: editId || Utils.generateId('LEGAL'),
            isoCode: generateISOCode('LEGAL', AppState.appData.legalDocuments),
            documentName: document.getElementById('legal-doc-name').value.trim(),
            documentType: document.getElementById('legal-doc-type').value,
            documentNumber: document.getElementById('legal-doc-number').value.trim(),
            issuedBy: document.getElementById('legal-doc-issued-by').value.trim(),
            issueDate: new Date(document.getElementById('legal-doc-issue-date').value).toISOString(),
            expiryDate: new Date(document.getElementById('legal-doc-expiry-date').value).toISOString(),
            alertDays: parseInt(document.getElementById('legal-doc-alert-days').value) || 30,
            status: document.getElementById('legal-doc-status').value,
            description: document.getElementById('legal-doc-description').value.trim(),
            documentLink: document.getElementById('legal-doc-link').value.trim(),
            createdAt: editId ? AppState.appData.legalDocuments?.find(d => d.id === editId)?.createdAt : new Date().toISOString(),
            updatedAt: new Date().toISOString()
        };
        
        Loading.show();
        try {
            if (editId) {
                const index = AppState.appData.legalDocuments.findIndex(d => d.id === editId);
                if (index !== -1) {
                    AppState.appData.legalDocuments[index] = formData;
                    Notification.success('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³ØªÙ†Ø¯ Ø¨Ù†Ø¬Ø§Ø­');
                }
            } else {
                AppState.appData.legalDocuments.push(formData);
                Notification.success('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªÙ†Ø¯ Ø¨Ù†Ø¬Ø§Ø­');
            }
            
            DataManager.save();
            await GoogleIntegration.autoSave('LegalDocuments', AppState.appData.legalDocuments);
            
            Loading.hide();
            modal.remove();
            this.load();
        } catch (error) {
            Loading.hide();
            Notification.error('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
        }
    },
    
    async editDocument(id) {
        const document = AppState.appData.legalDocuments?.find(d => d.id === id);
        if (document) await this.showForm(document);
    },
    
    async viewDocument(id) {
        const doc = AppState.appData.legalDocuments?.find(d => d.id === id);
        if (!doc) {
            Notification.error('Ø§Ù„Ù…Ø³ØªÙ†Ø¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
            return;
        }
        
        const expiryDate = new Date(doc.expiryDate);
        const today = new Date();
        const daysRemaining = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));
        const isExpired = expiryDate < today;
        const isExpiringSoon = daysRemaining <= doc.alertDays && daysRemaining > 0;
        
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 800px;">
                <div class="modal-header">
                    <h2 class="modal-title">${Utils.escapeHTML(doc.documentName || '')}</h2>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm font-semibold text-gray-600">ÙƒÙˆØ¯ ISO:</label>
                                <p class="text-gray-800 font-mono">${Utils.escapeHTML(doc.isoCode || '')}</p>
                            </div>
                            <div>
                                <label class="text-sm font-semibold text-gray-600">Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ØªÙ†Ø¯:</label>
                                <p class="text-gray-800">${Utils.escapeHTML(doc.documentType || '')}</p>
                            </div>
                            <div>
                                <label class="text-sm font-semibold text-gray-600">Ø±Ù‚Ù… Ø§Ù„Ù…Ø³ØªÙ†Ø¯:</label>
                                <p class="text-gray-800">${Utils.escapeHTML(doc.documentNumber || '')}</p>
                            </div>
                            <div>
                                <label class="text-sm font-semibold text-gray-600">Ø§Ù„ØµØ§Ø¯Ø± Ø¹Ù†:</label>
                                <p class="text-gray-800">${Utils.escapeHTML(doc.issuedBy || '')}</p>
                            </div>
                            <div>
                                <label class="text-sm font-semibold text-gray-600">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØµØ¯Ø§Ø±:</label>
                                <p class="text-gray-800">${doc.issueDate ? Utils.formatDate(doc.issueDate) : '-'}</p>
                            </div>
                            <div>
                                <label class="text-sm font-semibold text-gray-600">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡:</label>
                                <p class="text-gray-800">${doc.expiryDate ? Utils.formatDate(doc.expiryDate) : '-'}</p>
                            </div>
                            <div>
                                <label class="text-sm font-semibold text-gray-600">Ù…Ø¯Ø© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©:</label>
                                <p class="text-gray-800 ${isExpired ? 'text-red-600 font-bold' : isExpiringSoon ? 'text-yellow-600 font-bold' : 'text-green-600'}">
                                    ${isExpired ? 'Ù…Ù†ØªÙ‡ÙŠ' : `${daysRemaining} ÙŠÙˆÙ…`}
                                </p>
                            </div>
                            <div>
                                <label class="text-sm font-semibold text-gray-600">Ø§Ù„Ø­Ø§Ù„Ø©:</label>
                                <span class="badge badge-${isExpired ? 'danger' : isExpiringSoon ? 'warning' : 'success'}">
                                    ${doc.status || '-'}
                                </span>
                            </div>
                        </div>
                        ${doc.description ? `
                            <div>
                                <label class="text-sm font-semibold text-gray-600">Ø§Ù„ÙˆØµÙ:</label>
                                <p class="text-gray-800 whitespace-pre-wrap">${Utils.escapeHTML(doc.description)}</p>
                            </div>
                        ` : ''}
                        ${doc.documentLink ? `
                            <div>
                                <label class="text-sm font-semibold text-gray-600">Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø³ØªÙ†Ø¯:</label>
                                <a href="${Utils.escapeHTML(doc.documentLink)}" target="_blank" class="text-blue-600 hover:underline">
                                    ${Utils.escapeHTML(doc.documentLink)}
                                    <i class="fas fa-external-link-alt mr-2"></i>
                                </a>
                            </div>
                        ` : ''}
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" onclick="this.closest('.modal-overlay').remove()">Ø¥ØºÙ„Ø§Ù‚</button>
                    <button class="btn-success" onclick="LegalDocuments.exportPDF('${doc.id}');">
                        <i class="fas fa-file-pdf ml-2"></i>ØªØµØ¯ÙŠØ± PDF
                    </button>
                    <button class="btn-primary" onclick="LegalDocuments.editDocument('${doc.id}'); this.closest('.modal-overlay').remove();">
                        <i class="fas fa-edit ml-2"></i>ØªØ¹Ø¯ÙŠÙ„
                    </button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
        });
    },
    
    async deleteDocument(id) {
        if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªÙ†Ø¯ØŸ')) return;
        Loading.show();
        try {
            AppState.appData.legalDocuments = AppState.appData.legalDocuments.filter(d => d.id !== id);
            DataManager.save();
            Loading.hide();
            Notification.success('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªÙ†Ø¯ Ø¨Ù†Ø¬Ø§Ø­');
            this.load();
        } catch (error) {
            Loading.hide();
            Notification.error('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
        }
    },
    
    async exportPDF(id) {
        const doc = AppState.appData.legalDocuments?.find(d => d.id === id);
        if (!doc) {
            Notification.error('Ø§Ù„Ù…Ø³ØªÙ†Ø¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
            return;
        }
        
        try {
            Loading.show();
            
            const formCode = doc.isoCode || doc.documentNumber || doc.id?.substring(0, 12) || 'LEGAL-UNKNOWN';
            const formTitle = 'Ø§Ù„Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠ';
            
            const expiryDate = new Date(doc.expiryDate);
            const today = new Date();
            const daysRemaining = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));
            const isExpired = expiryDate < today;
            const isExpiringSoon = daysRemaining <= doc.alertDays && daysRemaining > 0;
            
            const content = `
                <table>
                    <tr><th>ÙƒÙˆØ¯ ISO</th><td>${Utils.escapeHTML(doc.isoCode || 'N/A')}</td></tr>
                    <tr><th>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ†Ø¯</th><td>${Utils.escapeHTML(doc.documentName || 'N/A')}</td></tr>
                    <tr><th>Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ØªÙ†Ø¯</th><td>${Utils.escapeHTML(doc.documentType || 'N/A')}</td></tr>
                    <tr><th>Ø±Ù‚Ù… Ø§Ù„Ù…Ø³ØªÙ†Ø¯</th><td>${Utils.escapeHTML(doc.documentNumber || 'N/A')}</td></tr>
                    <tr><th>Ø§Ù„ØµØ§Ø¯Ø± Ø¹Ù†</th><td>${Utils.escapeHTML(doc.issuedBy || 'N/A')}</td></tr>
                    <tr><th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØµØ¯Ø§Ø±</th><td>${doc.issueDate ? Utils.formatDate(doc.issueDate) : 'N/A'}</td></tr>
                    <tr><th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</th><td>${doc.expiryDate ? Utils.formatDate(doc.expiryDate) : 'N/A'}</td></tr>
                    <tr><th>Ù…Ø¯Ø© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©</th><td class="${isExpired ? 'text-red-600 font-bold' : isExpiringSoon ? 'text-yellow-600 font-bold' : 'text-green-600'}">${isExpired ? 'Ù…Ù†ØªÙ‡ÙŠ' : `${daysRemaining} ÙŠÙˆÙ…`}</td></tr>
                    <tr><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><td>${Utils.escapeHTML(doc.status || 'N/A')}</td></tr>
                </table>
                ${doc.description ? `
                    <div class="section-title">Ø§Ù„ÙˆØµÙ:</div>
                    <div class="description">${Utils.escapeHTML(doc.description)}</div>
                ` : ''}
                ${doc.documentLink ? `
                    <div class="section-title">Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø³ØªÙ†Ø¯:</div>
                    <div class="description"><a href="${Utils.escapeHTML(doc.documentLink)}" target="_blank">${Utils.escapeHTML(doc.documentLink)}</a></div>
                ` : ''}
            `;
            
            const htmlContent = typeof FormHeader !== 'undefined' && FormHeader.generatePDFHTML
                ? FormHeader.generatePDFHTML(formCode, formTitle, content, true, true)
                : `<html><body>${content}</body></html>`;
            
            const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const printWindow = window.open(url, '_blank');
            
            if (printWindow) {
                printWindow.onload = () => {
                    setTimeout(() => {
                        printWindow.print();
                        setTimeout(() => {
                            URL.revokeObjectURL(url);
                            Loading.hide();
                            Notification.success('ØªÙ… ÙØªØ­ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©/Ø§Ù„Ø­ÙØ¸ ÙƒÙ€ PDF');
                        }, 1000);
                    }, 500);
                };
            } else {
                Loading.hide();
                Notification.error('ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ù„Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±');
            }
        } catch (error) {
            Loading.hide();
            console.error('Ø®Ø·Ø£ ÙÙŠ ØªØµØ¯ÙŠØ± PDF:', error);
            Notification.error('ÙØ´Ù„ ØªØµØ¯ÙŠØ± PDF: ' + error.message);
        }
    },
    
    async exportToExcel() {
        try {
            Loading.show();
            
            if (typeof XLSX === 'undefined') {
                Loading.hide();
                Notification.error('Ù…ÙƒØªØ¨Ø© SheetJS ØºÙŠØ± Ù…Ø­Ù…Ù‘Ù„Ø©. ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©');
                return;
            }
            
            const documents = AppState.appData.legalDocuments || [];
            
            const excelData = documents.map(doc => {
                const expiryDate = new Date(doc.expiryDate);
                const today = new Date();
                const daysRemaining = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));
                const isExpired = expiryDate < today;
                
                return {
                    'ÙƒÙˆØ¯ ISO': doc.isoCode || '',
                    'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ†Ø¯': doc.documentName || '',
                    'Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ØªÙ†Ø¯': doc.documentType || '',
                    'Ø±Ù‚Ù… Ø§Ù„Ù…Ø³ØªÙ†Ø¯': doc.documentNumber || '',
                    'Ø§Ù„ØµØ§Ø¯Ø± Ø¹Ù†': doc.issuedBy || '',
                    'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØµØ¯Ø§Ø±': doc.issueDate ? Utils.formatDate(doc.issueDate) : '',
                    'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡': doc.expiryDate ? Utils.formatDate(doc.expiryDate) : '',
                    'Ù…Ø¯Ø© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©': isExpired ? 'Ù…Ù†ØªÙ‡ÙŠ' : `${daysRemaining} ÙŠÙˆÙ…`,
                    'Ø§Ù„Ø­Ø§Ù„Ø©': doc.status || '',
                    'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡': doc.createdAt ? Utils.formatDate(doc.createdAt) : ''
                };
            });
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(excelData);
            
            ws['!cols'] = [
                { wch: 15 }, { wch: 30 }, { wch: 20 }, { wch: 20 }, { wch: 25 }, 
                { wch: 15 }, { wch: 15 }, { wch: 20 }, { wch: 15 }, { wch: 15 }
            ];
            
            XLSX.utils.book_append_sheet(wb, ws, 'Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠØ©');
            
            const date = new Date().toISOString().slice(0, 10);
            const filename = `Ø³Ø¬Ù„_Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª_Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠØ©_${date}.xlsx`;
            
            XLSX.writeFile(wb, filename);
            
            Loading.hide();
            Notification.success('ØªÙ… ØªØµØ¯ÙŠØ± Ø³Ø¬Ù„ Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­');
        } catch (error) {
            Loading.hide();
            console.error('Ø®Ø·Ø£ ÙÙŠ ØªØµØ¯ÙŠØ± Excel:', error);
            Notification.error('ÙØ´Ù„ ØªØµØ¯ÙŠØ± Excel: ' + error.message);
        }
    },
    
    checkExpiringDocuments() {
        const documents = AppState.appData.legalDocuments || [];
        const today = new Date();
        const alerts = [];
        
        documents.forEach(doc => {
            if (doc.status === 'Ù†Ø´Ø·' && doc.expiryDate) {
                const expiryDate = new Date(doc.expiryDate);
                const daysRemaining = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));
                
                if (daysRemaining <= doc.alertDays && daysRemaining > 0) {
                    alerts.push({
                        type: 'warning',
                        message: `Ù…Ø³ØªÙ†Ø¯ Ù‚Ø§Ù†ÙˆÙ†ÙŠ "${doc.documentName}" Ø³ÙŠÙ†ØªÙ‡ÙŠ Ø®Ù„Ø§Ù„ ${daysRemaining} ÙŠÙˆÙ…`
                    });
                } else if (daysRemaining <= 0) {
                    alerts.push({
                        type: 'critical',
                        message: `Ù…Ø³ØªÙ†Ø¯ Ù‚Ø§Ù†ÙˆÙ†ÙŠ "${doc.documentName}" Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©!`
                    });
                }
            }
        });
        
        // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù„Ù„Ø¥ÙŠÙ…ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ø³Ø¬Ù„Ø©
        if (alerts.length > 0 && AppState.notificationEmails && AppState.notificationEmails.length > 0) {
            this.sendEmailNotifications(alerts);
        }
        
        // Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
        alerts.forEach(alert => {
            if (alert.type === 'critical') {
                Notification.error(alert.message);
            } else {
                Notification.warning(alert.message);
            }
        });
    },
    
    async sendEmailNotifications(alerts) {
        // ÙÙŠ Ø§Ù„Ø¥Ù†ØªØ§Ø¬ØŒ ÙŠØ¬Ø¨ Ø¥Ø±Ø³Ø§Ù„ Ø¥ÙŠÙ…ÙŠÙ„Ø§Øª ÙØ¹Ù„ÙŠØ©
        console.log('Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù„Ø¥ÙŠÙ…ÙŠÙ„Ø§Øª:', AppState.notificationEmails);
        console.log('Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª:', alerts);
        
        // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© ØªÙƒØ§Ù…Ù„ Ù…Ø¹ Ø®Ø¯Ù…Ø© Ø¥Ø±Ø³Ø§Ù„ Ø¥ÙŠÙ…ÙŠÙ„Ø§Øª Ù‡Ù†Ø§
        if (AppState.notificationEmails && AppState.notificationEmails.length > 0) {
            Notification.success(`ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù‚Ø§Ù†ÙˆÙ†ÙŠØ© Ø¥Ù„Ù‰ ${AppState.notificationEmails.length} Ø¥ÙŠÙ…ÙŠÙ„`);
        }
    },
    
    async checkLegalUpdates() {
        Loading.show();
        try {
            const portalUrl = document.getElementById('legal-portal-url')?.value || AppState.legalPortalUrl;
            const keywords = (document.getElementById('legal-keywords')?.value || '').split(',').map(k => k.trim()).filter(k => k);
            
            if (!portalUrl) {
                Loading.hide();
                Notification.warning('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ø§Ø¨Ø· Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„ØªØ´Ø±ÙŠØ¹Ø§Øª Ø£ÙˆÙ„Ø§Ù‹');
                return;
            }
            
            // ÙÙŠ Ø§Ù„Ø¥Ù†ØªØ§Ø¬ØŒ ÙŠØ¬Ø¨ Ø¥Ø¬Ø±Ø§Ø¡ ÙØ­Øµ ÙØ¹Ù„ÙŠ Ù…Ù† Ø§Ù„Ø¨ÙˆØ§Ø¨Ø©
            // Ù‡Ù†Ø§ Ø³Ù†Ø¹Ø±Ø¶ ÙÙ‚Ø· Ø¥Ø´Ø¹Ø§Ø± ØªØ¬Ø±ÙŠØ¨ÙŠ
            await new Promise(resolve => setTimeout(resolve, 1500));
            
            Loading.hide();
            Notification.success(`ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠØ©. ${keywords.length > 0 ? `ØªÙ… Ø§Ù„Ø¨Ø­Ø« Ø¹Ù†: ${keywords.join(', ')}` : 'Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ ÙƒÙ„Ù…Ø§Øª Ù…ÙØªØ§Ø­ÙŠØ©'}`);
            
            // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø·Ù‚ ÙØ¹Ù„ÙŠ Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ù‡Ù†Ø§
            // Ù…Ø«Ù„: Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ API Ø£Ùˆ ÙØ­Øµ ØµÙØ­Ø© ÙˆÙŠØ¨
            
        } catch (error) {
            Loading.hide();
            Notification.error('ÙØ´Ù„ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª: ' + error.message);
        }
    },
    
    saveLegalSettings() {
        const portalUrl = document.getElementById('legal-portal-url')?.value.trim();
        const keywordsText = document.getElementById('legal-keywords')?.value || '';
        const autoNotify = document.getElementById('legal-auto-notify')?.checked || false;
        
        AppState.legalPortalUrl = portalUrl;
        AppState.legalKeywords = keywordsText.split(',').map(k => k.trim()).filter(k => k);
        AppState.legalAutoNotify = autoNotify;
        
        DataManager.save();
        Notification.success('ØªÙ… Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­');
    }
};

// ===== SAP Integration Module =====
const SAPIntegration = {
    config: {
        enabled: false,
        apiUrl: '',
        apiKey: ''
    },

    async load() {
        // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© ÙˆØ§Ø¬Ù‡Ø© Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª SAP Integration Ù‡Ù†Ø§
        console.log('SAP Integration Module loaded');
    },

    async syncWithSAP() {
        if (!this.config.enabled) {
            Notification.error('SAP Integration ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„');
            return;
        }

        Loading.show();
        try {
            // ÙƒÙˆØ¯ Ø§Ù„ØªÙƒØ§Ù…Ù„ Ù…Ø¹ SAP
            // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© API calls Ù‡Ù†Ø§
            Loading.hide();
            Notification.success('ØªÙ…Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹ SAP Ø¨Ù†Ø¬Ø§Ø­');
        } catch (error) {
            Loading.hide();
            Notification.error('ÙØ´Ù„Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹ SAP: ' + error.message);
        }
    }
};

// ===== Global Functions (for onclick handlers) =====
function showSection(sectionName) {
    UI.showSection(sectionName);
}

        function logout() {
    if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) {
        Auth.logout();
    }
}

function togglePasswordVisibility() {
    UI.togglePasswordVisibility();
}

// ===== Helper Functions =====
/**
 * Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§ÙØªØ±Ø§Ø¶ÙŠÙŠÙ† Ø¹Ù†Ø¯ Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø¨ÙŠØ§Ù†Ø§Øª
 */
function createDefaultUsers() {
    if (AppState.appData.users && AppState.appData.users.length > 0) {
        console.log('â„¹ï¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ù…ÙˆØ¬ÙˆØ¯ÙˆÙ† Ø¨Ø§Ù„ÙØ¹Ù„ØŒ Ù„Ù† ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§ÙØªØ±Ø§Ø¶ÙŠÙŠÙ†');
        return;
    }
    
    console.log('ğŸ”§ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§ÙØªØ±Ø§Ø¶ÙŠÙŠÙ†...');
    
    const defaultUsers = [
        {
            id: Utils.generateId('USER'),
            email: 'admin@americana.com',
            name: 'Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…',
            password: 'admin123', // ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…Ø´ÙØ±Ø© Ù„Ù„Ø¨Ø¯Ø§ÙŠØ© (ÙŠØ¬Ø¨ ØªØºÙŠÙŠØ±Ù‡Ø§ Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„)
            role: 'admin',
            department: 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†Ø¸Ø§Ù…',
            active: true,
            permissions: {}, // Ø§Ù„Ù…Ø¯ÙŠØ± Ù„Ø¯ÙŠÙ‡ ØµÙ„Ø§Ø­ÙŠØ§Øª ÙƒØ§Ù…Ù„Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
            passwordChanged: false, // Ù„Ù… ÙŠØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ø¹Ø¯
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString(),
            lastLogin: null,
            lastLogout: null,
            isOnline: false,
            loginHistory: []
        },
        {
            id: Utils.generateId('USER'),
            email: 'safety@americana.com',
            name: 'Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ø³Ù„Ø§Ù…Ø©',
            password: 'safety123', // ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…Ø´ÙØ±Ø© Ù„Ù„Ø¨Ø¯Ø§ÙŠØ© (ÙŠØ¬Ø¨ ØªØºÙŠÙŠØ±Ù‡Ø§ Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„)
            role: 'safety_officer',
            department: 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³Ù„Ø§Ù…Ø©',
            active: true,
            passwordChanged: false, // Ù„Ù… ÙŠØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ø¹Ø¯
            permissions: {
                'dashboard': true,
                'incidents': true,
                'nearmiss': true,
                'ptw': true,
                'training': true,
                'clinic': true,
                'fire-equipment': true,
                'ppe': true,
                'violations': true,
                'contractors': true,
                'employees': true,
                'behavior-monitoring': true,
                'chemical-safety': true,
                'daily-observations': true,
                'emergency': true,
                'action-tracking': true
            },
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString(),
            lastLogin: null,
            lastLogout: null,
            isOnline: false,
            loginHistory: []
        }
    ];
    
    AppState.appData.users = defaultUsers;
    DataManager.save();
    
    console.log('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§ÙØªØ±Ø§Ø¶ÙŠÙŠÙ†:', defaultUsers.map(u => u.email).join(', '));
    console.warn('âš ï¸ ØªØ­Ø°ÙŠØ± Ø£Ù…Ù†ÙŠ: ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¨ÙƒÙ„Ù…Ø§Øª Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…Ø´ÙØ±Ø©. ÙŠÙØ±Ø¬Ù‰ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„!');
}

// ===== Event Listeners =====
document.addEventListener('DOMContentLoaded', async function() {
    console.log('ğŸš€ Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚...');
    
    // ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Google Ø£ÙˆÙ„Ø§Ù‹
    DataManager.loadGoogleConfig();
    
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© (ÙƒÙ†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©)
    DataManager.load();

    // Ø¥Ø°Ø§ ÙƒØ§Ù† Google Sheets Ù…ÙØ¹Ù‘Ù„ ÙˆÙ…ÙÙƒÙˆÙ‘Ù†ØŒ Ù†Ø­Ù…Ù‘Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù†Ù‡ Ø£ÙˆÙ„Ø§Ù‹ (Ù‚Ø¨Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„)
    // Ù‡Ø°Ø§ ÙŠØ¶Ù…Ù† Ø£Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙŠØ±ÙˆÙ† Ù†ÙØ³ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Google Sheets
    // Ù‡Ø°Ø§ Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø¬Ø¯Ø¯ Ø§Ù„Ø°ÙŠÙ† Ù„Ø§ ÙŠÙ…Ù„ÙƒÙˆÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ©
    if (AppState.googleConfig.appsScript.enabled && AppState.googleConfig.sheets.spreadsheetId) {
        try {
            console.log('ğŸ”„ Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Google Sheets Ø£ÙˆÙ„Ø§Ù‹ (Ù‚Ø¨Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„)...');
            await GoogleIntegration.syncData();
            console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Google Sheets Ø¨Ù†Ø¬Ø§Ø­ Ù‚Ø¨Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„');
            console.log('ğŸ“Š Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©:', Object.keys(AppState.appData).filter(key => Array.isArray(AppState.appData[key]) && AppState.appData[key].length > 0));
        } catch (error) {
            console.warn('âš ï¸ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Google SheetsØŒ Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©:', error);
            // Ø¥Ø°Ø§ ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„ØŒ Ù†ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ©
            const hasLocalData = Object.keys(AppState.appData).some(key => 
                Array.isArray(AppState.appData[key]) && AppState.appData[key].length > 0
            );
            if (!hasLocalData) {
                console.warn('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ©ØŒ Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§ÙØªØ±Ø§Ø¶ÙŠÙŠÙ†');
                // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§ÙØªØ±Ø§Ø¶ÙŠÙŠÙ†
                createDefaultUsers();
            }
        }
    } else {
        console.log('â„¹ï¸ Google Sheets ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„ØŒ Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© ÙÙ‚Ø·');
        // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Google Sheets Ù…ÙØ¹Ù‘Ù„ØŒ Ù†ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ©
        const hasLocalData = Object.keys(AppState.appData).some(key => 
            Array.isArray(AppState.appData[key]) && AppState.appData[key].length > 0
        );
        if (!hasLocalData || (AppState.appData.users && AppState.appData.users.length === 0)) {
            console.warn('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ© ÙˆÙ„Ø§ Google Sheets Ù…ÙØ¹Ù‘Ù„ØŒ Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§ÙØªØ±Ø§Ø¶ÙŠÙŠÙ†');
            // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§ÙØªØ±Ø§Ø¶ÙŠÙŠÙ†
            createDefaultUsers();
        }
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø­ÙÙˆØ¸ - Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø§Ù„Ø© Ø¹Ù†Ø¯ Refresh
    if (Auth.checkRememberedUser()) {
        console.log('âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­ÙÙˆØ¸ØŒ Ø¹Ø±Ø¶ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ');
        
        // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ Ù…Ù† sessionStorage Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
        const savedSection = sessionStorage.getItem('hse_current_section');
        if (savedSection) {
            AppState.currentSection = savedSection;
            setTimeout(() => {
                UI.showSection(savedSection);
            }, 100);
        }
        
        UI.showMainApp();
    } else {
        console.log('ğŸ” Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­ÙÙˆØ¸ØŒ Ø¹Ø±Ø¶ Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„');
        UI.showLoginScreen();
    }
    
    // Ø­ÙØ¸ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ±Ù‡ Ù„Ù…Ù†Ø¹ ÙÙ‚Ø¯Ø§Ù† Ø§Ù„Ø­Ø§Ù„Ø© Ø¹Ù†Ø¯ Refresh
    const originalShowSection = UI.showSection.bind(UI);
    UI.showSection = function(sectionName) {
        sessionStorage.setItem('hse_current_section', sectionName);
        AppState.currentSection = sectionName;
        return originalShowSection(sectionName);
    };

    // Ù…Ø¹Ø§Ù„Ø¬ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ - Ø§Ø³ØªØ®Ø¯Ø§Ù… setTimeout Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† DOM Ø¬Ø§Ù‡Ø²
    setTimeout(() => {
    const loginForm = document.getElementById('login-form');
    if (loginForm) {
            console.log('âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù†Ù…ÙˆØ°Ø¬ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«');
            
            // Ø¥Ø²Ø§Ù„Ø© Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© (Ø¥Ù† ÙˆØ¬Ø¯Øª)
            const newLoginForm = loginForm.cloneNode(true);
            loginForm.parentNode.replaceChild(newLoginForm, loginForm);
            
            // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù…Ø¨Ø§Ø´Ø±Ø©
            newLoginForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('ğŸ“ ØªÙ… Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„');
                
                const formData = new FormData(e.target);
                const email = formData.get('username');
                const password = formData.get('password');
                const remember = formData.get('remember') === 'on';

                console.log('ğŸ“Š Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ù…ÙˆØ°Ø¬:', { email, passwordLength: password?.length, remember });

                if (!email || !password) {
                    console.warn('âš ï¸ Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©');
                    Notification.error('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±');
                    return;
                }

                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
                if (!Utils.isValidEmail(email)) {
                    console.warn('âš ï¸ Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­');
                    Notification.error('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØµØ­ÙŠØ­');
                    return;
                }

                // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„ Ø³Ø±ÙŠØ¹Ø© Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Loading.show()
                const submitBtn = newLoginForm.querySelector('button[type="submit"]');
                if (!submitBtn) {
                    console.error('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„');
                    return;
                }
                
                const originalBtnText = submitBtn.innerHTML;
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin ml-2"></i> Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...';
            
                try {
                    console.log('ğŸ”„ Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...');
                    const loginResult = await Auth.login(email.trim(), password, remember);
                    console.log('ğŸ“‹ Ù†ØªÙŠØ¬Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„:', loginResult);
                    
                    if (loginResult && loginResult.success) {
                        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„ ÙˆØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
                        if (loginResult.requiresPasswordChange) {
                            // Ø¥Ø¸Ù‡Ø§Ø± Ù†Ù…ÙˆØ°Ø¬ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
                            submitBtn.innerHTML = '<i class="fas fa-check ml-2"></i> Ù†Ø¬Ø­ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...';
                            setTimeout(() => {
                                UI.showChangePasswordModal(loginResult.isFirstLogin); // true = Ø£ÙˆÙ„ Ù…Ø±Ø©
                                submitBtn.disabled = false;
                                submitBtn.innerHTML = originalBtnText;
                            }, 500);
                        } else {
                            // ØªØ­Ø¯ÙŠØ« Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø¥Ø´Ø§Ø±Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù†Ø¬Ø§Ø­
                            submitBtn.innerHTML = '<i class="fas fa-check ml-2"></i> Ù†Ø¬Ø­ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...';
                            setTimeout(() => {
                                UI.showMainApp();
                                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
                                submitBtn.disabled = false;
                                submitBtn.innerHTML = originalBtnText;
                            }, 500);
                        }
                    } else {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalBtnText;
                        console.warn('âš ï¸ ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„');
                    }
                } catch (error) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnText;
                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„:', error);
                    Notification.error('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: ' + (error.message || error));
                }
            });
            
            // ØªÙØ¹ÙŠÙ„ Ø²Ø± Ø¥Ø¸Ù‡Ø§Ø± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
            const passwordToggleBtn = document.getElementById('password-toggle-btn');
            if (passwordToggleBtn) {
                passwordToggleBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    UI.togglePasswordVisibility();
                });
                console.log('âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ Ø²Ø± Ø¥Ø¸Ù‡Ø§Ø± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±');
            }
            
            // ØªÙØ¹ÙŠÙ„ Ø±Ø§Ø¨Ø· Ø§Ø³ØªØ¹Ø§Ø¯Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
            const forgotPasswordLink = document.getElementById('forgot-password-link');
            if (forgotPasswordLink) {
                forgotPasswordLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    UI.showForgotPasswordModal();
                });
                console.log('âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ Ø±Ø§Ø¨Ø· Ø§Ø³ØªØ¹Ø§Ø¯Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±');
            }
            
            // Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø¨Ø§Ø´Ø± Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØµØ­ÙŠØ­Ø©
            // ØªÙ… Ø¥Ø²Ø§Ù„Ø© validUsers Ù„Ø£Ø³Ø¨Ø§Ø¨ Ø£Ù…Ù†ÙŠØ© - Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            console.log('ğŸ” Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ø§Ù„Ù…ØªØ§Ø­ÙˆÙ† ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', (AppState.appData.users || []).length);
        } else {
            console.error('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù†Ù…ÙˆØ°Ø¬ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„!');
            console.error('âŒ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù†ØµØ± Ù…Ø±Ø© Ø£Ø®Ø±Ù‰...');
            setTimeout(() => {
                const retryForm = document.getElementById('login-form');
                if (retryForm) {
                    console.log('âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ ÙÙŠ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©');
                    // Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
                    const newRetryForm = retryForm.cloneNode(true);
                    retryForm.parentNode.replaceChild(newRetryForm, retryForm);
                    newRetryForm.addEventListener('submit', async function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        const formData = new FormData(e.target);
                        const email = formData.get('username');
                        const password = formData.get('password');
                        const remember = formData.get('remember') === 'on';
                        
                        if (!email || !password) {
                            Notification.error('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±');
                            return;
                        }
                        
                        const submitBtn = newRetryForm.querySelector('button[type="submit"]');
                        if (submitBtn) {
                            const originalBtnText = submitBtn.innerHTML;
                            submitBtn.disabled = true;
                            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin ml-2"></i> Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...';
                            
                            try {
                                const loginResult = await Auth.login(email.trim(), password, remember);
                                if (loginResult && loginResult.success) {
                                    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„ ÙˆØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
                                    if (loginResult.requiresPasswordChange) {
                                        submitBtn.innerHTML = '<i class="fas fa-check ml-2"></i> Ù†Ø¬Ø­ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...';
                                        setTimeout(() => {
                                            UI.showChangePasswordModal(loginResult.isFirstLogin); // true = Ø£ÙˆÙ„ Ù…Ø±Ø©
                                            submitBtn.disabled = false;
                                            submitBtn.innerHTML = originalBtnText;
                                        }, 500);
                                    } else {
                                        submitBtn.innerHTML = '<i class="fas fa-check ml-2"></i> Ù†Ø¬Ø­ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...';
                                        setTimeout(() => {
                                            UI.showMainApp();
                                            submitBtn.disabled = false;
                                            submitBtn.innerHTML = originalBtnText;
                                        }, 500);
                                    }
                                } else {
                                    submitBtn.disabled = false;
                                    submitBtn.innerHTML = originalBtnText;
                                }
                            } catch (error) {
                                submitBtn.disabled = false;
                                submitBtn.innerHTML = originalBtnText;
                                Notification.error('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: ' + (error.message || error));
                            }
                        }
                    });
                } else {
                    console.error('âŒ Ù„Ø§ ÙŠØ²Ø§Ù„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
                }
            }, 1000);
        }
    }, 100);

    // Ø¥Ø¹Ø¯Ø§Ø¯ event listeners Ù„Ù„ØªÙ†Ù‚Ù„ (Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø¹Ø¯Ø§Ø¯Ù‡Ø§ Ø¹Ù†Ø¯ showMainApp)
    // Ù†Ø³ØªØ®Ø¯Ù… event delegation Ù„Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø®ÙÙŠØ©
    document.addEventListener('click', function(e) {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ù…Ø¶ØºÙˆØ· Ø¹Ù„ÙŠÙ‡ Ù‡Ùˆ nav-item
        const navItem = e.target.closest('.nav-item');
        if (navItem) {
            e.preventDefault();
            e.stopPropagation();
            const section = navItem.getAttribute('data-section');
            if (section) {
                UI.showSection(section);
            }
            return;
        }

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ù…Ø¶ØºÙˆØ· Ø¹Ù„ÙŠÙ‡ Ù‡Ùˆ logout-btn
        const logoutBtn = e.target.closest('#logout-btn');
        if (logoutBtn) {
            e.preventDefault();
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) {
                Auth.logout();
            }
            return;
        }
    });

    // Ø¥Ø¶Ø§ÙØ© event listener Ù„Ø²Ø± Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
    const passwordToggleBtn = document.getElementById('password-toggle-btn');
    if (passwordToggleBtn) {
        passwordToggleBtn.addEventListener('click', function(e) {
            e.preventDefault();
            UI.togglePasswordVisibility();
        });
    }
    
    // Ù…Ø¹Ø§Ù„Ø¬ Ø§Ø³ØªØ¹Ø§Ø¯Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
    const forgotPasswordLink = document.getElementById('forgot-password-link');
    if (forgotPasswordLink) {
        forgotPasswordLink.addEventListener('click', function(e) {
            e.preventDefault();
            UI.showForgotPasswordModal();
        });
    }
    
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ø¹Ø§Ø± Ù…Ù† localStorage
    const loadCompanyLogo = () => {
        const savedLogo = localStorage.getItem('company_logo');
        const logoImg = document.getElementById('company-logo');
        const defaultIcon = document.getElementById('default-logo-icon');
        const loginTitle = document.getElementById('login-title');
        
        if (savedLogo && logoImg && defaultIcon) {
            logoImg.src = savedLogo;
            logoImg.onload = function() {
                logoImg.style.display = 'block';
                defaultIcon.style.display = 'none';
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ø¹Ø§Ø±
                if (loginTitle) {
                    loginTitle.textContent = 'Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³Ù„Ø§Ù…Ø© ÙˆØ§Ù„ØµØ­Ø© Ø§Ù„Ù…Ù‡Ù†ÙŠØ©';
                }
            };
            logoImg.onerror = function() {
                // ÙÙŠ Ø­Ø§Ù„Ø© ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ø¹Ø§Ø±ØŒ Ù†Ø¹Ø±Ø¶ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
                logoImg.style.display = 'none';
                defaultIcon.style.display = 'block';
                console.warn('âš ï¸ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø´Ø¹Ø§Ø± Ø§Ù„Ø´Ø±ÙƒØ©');
            };
        } else if (loginTitle && !savedLogo) {
            // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø´Ø¹Ø§Ø±ØŒ Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙƒØ§Ù…Ù„
            loginTitle.textContent = 'Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³Ù„Ø§Ù…Ø© ÙˆØ§Ù„ØµØ­Ø© Ø§Ù„Ù…Ù‡Ù†ÙŠØ©';
        }
    };
    
    loadCompanyLogo();
    
    // Ù…Ø±Ø§Ù‚Ø¨Ø© ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„Ø´Ø¹Ø§Ø± ÙÙŠ localStorage
    window.addEventListener('storage', function(e) {
        if (e.key === 'company_logo') {
            loadCompanyLogo();
        }
    });
    
    // ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„Ù„ØºØ§Øª
    if (typeof i18n !== 'undefined') {
        i18n.init();
        i18n.updateAllUI();
    }
    
    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø²Ø± ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù„ØºØ©
    const langToggle = document.getElementById('language-toggle');
    if (langToggle) {
        langToggle.addEventListener('click', () => {
            const currentLang = i18n?.currentLanguage || 'ar';
            const newLang = currentLang === 'ar' ? 'en' : 'ar';
            if (i18n) {
                i18n.setLanguage(newLang);
                i18n.updateAllUI();
                const langText = document.getElementById('current-lang-text');
                if (langText) {
                    langText.textContent = newLang === 'ar' ? 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©' : 'English';
                }
                Notification.success(newLang === 'ar' ? 'ØªÙ… Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ù„Ù„Ø¹Ø±Ø¨ÙŠØ©' : 'Switched to English');
            }
        });
    }
    
    // ===== Theme Manager (Dark Mode) =====
    const ThemeManager = {
        /**
         * ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ
         */
        init() {
            // Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø­ÙÙˆØ¸ Ù…Ù† localStorage
            const savedTheme = localStorage.getItem('theme') || 'light';
            this.setTheme(savedTheme);
            
            // Ø¥Ø¹Ø¯Ø§Ø¯ Ø²Ø± Ø§Ù„ØªØ¨Ø¯ÙŠÙ„
            const themeToggle = document.getElementById('theme-toggle');
            if (themeToggle) {
                themeToggle.addEventListener('click', () => {
                    this.toggleTheme();
                });
            }
            
            console.log('âœ… ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ');
        },
        
        /**
         * ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ
         */
        toggleTheme() {
            const currentTheme = document.body.getAttribute('data-theme') || 'light';
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            this.setTheme(newTheme);
        },
        
        /**
         * ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ
         */
        setTheme(theme) {
            // ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙˆØ¶Ø¹ Ø¹Ù„Ù‰ body
            document.body.setAttribute('data-theme', theme);
            
            // Ø­ÙØ¸ Ø§Ù„ÙˆØ¶Ø¹ ÙÙŠ localStorage
            localStorage.setItem('theme', theme);
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© ÙÙŠ Ø§Ù„Ù€ sidebar
            const themeIcon = document.getElementById('theme-icon');
            const themeText = document.getElementById('theme-text');
            
            if (themeIcon) {
                if (theme === 'dark') {
                    themeIcon.className = 'fas fa-sun';
                    if (themeText) {
                        themeText.textContent = 'Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù†Ù‡Ø§Ø±ÙŠ';
                    }
                } else {
                    themeIcon.className = 'fas fa-moon';
                    if (themeText) {
                        themeText.textContent = 'Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ';
                    }
                }
            }
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø±
            const headerThemeIcon = document.getElementById('header-theme-icon');
            if (headerThemeIcon) {
                if (theme === 'dark') {
                    headerThemeIcon.className = 'fas fa-sun';
                } else {
                    headerThemeIcon.className = 'fas fa-moon';
                }
            }
            
            // ØªØ­Ø¯ÙŠØ« meta theme-color
            const metaThemeColor = document.querySelector('meta[name="theme-color"]');
            if (metaThemeColor) {
                metaThemeColor.setAttribute('content', theme === 'dark' ? '#1a1a1a' : '#3B82F6');
            }
            
            console.log(`âœ… ØªÙ… Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¥Ù„Ù‰ Ø§Ù„ÙˆØ¶Ø¹ ${theme === 'dark' ? 'Ø§Ù„Ù„ÙŠÙ„ÙŠ' : 'Ø§Ù„Ù†Ù‡Ø§Ø±ÙŠ'}`);
        },
        
        /**
         * Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ
         */
        getCurrentTheme() {
            return document.body.getAttribute('data-theme') || 'light';
        }
    };
    
    // ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ
    ThemeManager.init();
    
    // ===== Notifications System =====
    const NotificationsManager = {
        /**
         * Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©
         */
        countNotifications() {
            const alerts = (AppState.appData.emergencyAlerts || []).filter(a => a.status !== 'Ù…ØºÙ„Ù‚');
            const incidents = (AppState.appData.incidents || []).filter(i => i.status === 'Ù…ÙØªÙˆØ­' || i.status === 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©');
            const ptw = (AppState.appData.ptw || []).filter(p => {
                const expiryDate = p.expiryDate ? new Date(p.expiryDate) : null;
                const now = new Date();
                const daysUntilExpiry = expiryDate ? Math.ceil((expiryDate - now) / (1000 * 60 * 60 * 24)) : null;
                return p.status !== 'Ù…ØºÙ„Ù‚' && daysUntilExpiry !== null && daysUntilExpiry <= 7 && daysUntilExpiry > 0;
            });
            
            return alerts.length + incidents.length + ptw.length;
        },
        
        /**
         * ØªØ­Ø¯ÙŠØ« Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
         */
        updateBadge() {
            const count = this.countNotifications();
            const badge = document.getElementById('notifications-badge');
            const headerBadge = document.getElementById('header-notifications-badge');
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ø§Ø±Ø© ÙÙŠ Ø§Ù„Ù€ sidebar
            if (badge) {
                if (count > 0) {
                    badge.textContent = count > 99 ? '99+' : count.toString();
                    badge.style.display = 'flex';
                    badge.classList.add('show');
                } else {
                    badge.style.display = 'none';
                    badge.classList.remove('show');
                }
            }
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ø§Ø±Ø© ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø±
            if (headerBadge) {
                if (count > 0) {
                    headerBadge.textContent = count > 99 ? '99+' : count.toString();
                    headerBadge.style.display = 'flex';
                } else {
                    headerBadge.style.display = 'none';
                }
            }
        },
        
        /**
         * Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
         */
        showNotifications() {
            const alerts = (AppState.appData.emergencyAlerts || []).filter(a => a.status !== 'Ù…ØºÙ„Ù‚');
            const incidents = (AppState.appData.incidents || []).filter(i => i.status === 'Ù…ÙØªÙˆØ­' || i.status === 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©');
            const ptw = (AppState.appData.ptw || []).filter(p => {
                const expiryDate = p.expiryDate ? new Date(p.expiryDate) : null;
                const now = new Date();
                const daysUntilExpiry = expiryDate ? Math.ceil((expiryDate - now) / (1000 * 60 * 60 * 24)) : null;
                return p.status !== 'Ù…ØºÙ„Ù‚' && daysUntilExpiry !== null && daysUntilExpiry <= 7 && daysUntilExpiry > 0;
            });
            
            if (alerts.length === 0 && incidents.length === 0 && ptw.length === 0) {
                Notification.info('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©');
                return;
            }
            
            let message = `Ù„Ø¯ÙŠÙƒ ${this.countNotifications()} Ø¥Ø´Ø¹Ø§Ø± Ø¬Ø¯ÙŠØ¯:\n\n`;
            if (alerts.length > 0) {
                message += `â€¢ ${alerts.length} ØªÙ†Ø¨ÙŠÙ‡ Ø·ÙˆØ§Ø±Ø¦ Ù†Ø´Ø·\n`;
            }
            if (incidents.length > 0) {
                message += `â€¢ ${incidents.length} Ø­Ø§Ø¯Ø« Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©\n`;
            }
            if (ptw.length > 0) {
                message += `â€¢ ${ptw.length} ØªØµØ±ÙŠØ­ Ø¹Ù…Ù„ Ù‚Ø§Ø±Ø¨ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡\n`;
            }
            
            if (confirm(message + '\nÙ‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Ù‚Ø³Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§ØªØŸ')) {
                UI.showSection('emergency');
            }
        },
        
        /**
         * ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
         */
        init() {
            this.updateBadge();
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ©
            setInterval(() => {
                this.updateBadge();
            }, 30000);
            
            // Ø¥Ø¶Ø§ÙØ© event listener Ù„Ø²Ø± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙÙŠ Ø§Ù„Ù€ sidebar
            const notificationsBtn = document.getElementById('notifications-btn');
            if (notificationsBtn) {
                notificationsBtn.addEventListener('click', () => {
                    this.showNotifications();
                });
            }
            
            // Ø¥Ø¹Ø¯Ø§Ø¯ Ø²Ø± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø±
            setTimeout(() => {
                const headerNotificationsBtn = document.getElementById('header-notifications-btn');
                if (headerNotificationsBtn) {
                    headerNotificationsBtn.addEventListener('click', () => {
                        this.showNotifications();
                    });
                }
            }, 500);
        }
    };
    
    // ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
    NotificationsManager.init();
    
    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù‡ÙŠØ¯Ø± Ù„Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ
    setTimeout(() => {
        const headerThemeToggle = document.getElementById('header-theme-toggle');
        if (headerThemeToggle) {
            headerThemeToggle.addEventListener('click', () => {
                ThemeManager.toggleTheme();
            });
        }
    }, 500);
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    const originalUpdateKPIs = Dashboard.updateKPIs;
    Dashboard.updateKPIs = function() {
        if (originalUpdateKPIs) originalUpdateKPIs.call(this);
        if (typeof NotificationsManager !== 'undefined') {
            NotificationsManager.updateBadge();
        }
    };
    
    // Ø¥ØµÙ„Ø§Ø­ Ù…Ø´ÙƒÙ„Ø© CORS Ù…Ø¹ manifest.json (Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„Ù…Ù„Ù Ù…Ø­Ù„ÙŠØ§Ù‹)
    const manifestLink = document.querySelector('link[rel="manifest"]');
    if (manifestLink && window.location.protocol === 'file:') {
        // Ø¥Ø²Ø§Ù„Ø© manifest link Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„Ù…Ù„Ù Ù…Ø­Ù„ÙŠØ§Ù‹ Ù„ØªØ¬Ù†Ø¨ Ø®Ø·Ø£ CORS
        manifestLink.remove();
        console.log('â„¹ï¸ ØªÙ… Ø¥Ø²Ø§Ù„Ø© manifest.json Ù„ØªØ¬Ù†Ø¨ Ù…Ø´ÙƒÙ„Ø© CORS Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„Ù…Ù„Ù Ù…Ø­Ù„ÙŠØ§Ù‹');
    }
});
// ===== Half-Yearly Statistics Module (Ø§Ù„Ø§Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù†ØµÙ Ø³Ù†ÙˆÙŠØ©) =====
const HalfYearlyStatistics = {
    currentForm: 'work-injuries', // Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶
    
    async load() {
        const section = document.getElementById('half-yearly-statistics-section');
        if (!section) {
            console.error('âŒ Ù‚Ø³Ù… half-yearly-statistics-section ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!');
            return;
        }

        section.innerHTML = `
            <div class="section-header">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="section-title">
                            <i class="fas fa-chart-bar ml-3"></i>
                            Ø§Ù„Ø§Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù†ØµÙ Ø³Ù†ÙˆÙŠØ©
                        </h1>
                        <p class="section-subtitle">Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ© Ø§Ù„Ø±Ø³Ù…ÙŠØ© Ù„Ù„Ø³Ù„Ø§Ù…Ø© ÙˆØ§Ù„ØµØ­Ø© Ø§Ù„Ù…Ù‡Ù†ÙŠØ© (ÙƒÙ„ 6 Ø£Ø´Ù‡Ø±)</p>
                    </div>
                </div>
            </div>
            <div class="mt-6">
                ${await this.renderMainContent()}
            </div>
        `;
        this.setupEventListeners();
    },

    async renderMainContent() {
        return `
            <div class="content-card">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-file-alt ml-2"></i>
                        Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ©
                    </h2>
                </div>
                <div class="card-body">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                        <button onclick="HalfYearlyStatistics.showForm('work-injuries')" class="btn-primary p-6 text-center hover:shadow-lg transition-shadow">
                            <i class="fas fa-user-injured text-3xl mb-3"></i>
                            <div class="font-bold text-lg">Ù†Ù…ÙˆØ°Ø¬ Ø¥ØµØ§Ø¨Ø§Øª Ø§Ù„Ø¹Ù…Ù„</div>
                            <div class="text-sm text-gray-600 mt-2">Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø­ØµØ§Ø¡ Ø±Ù‚Ù… (2)</div>
                        </button>
                        <button onclick="HalfYearlyStatistics.showForm('ordinary-diseases')" class="btn-primary p-6 text-center hover:shadow-lg transition-shadow">
                            <i class="fas fa-heartbeat text-3xl mb-3"></i>
                            <div class="font-bold text-lg">Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø£Ù…Ø±Ø§Ø¶ Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©</div>
                            <div class="text-sm text-gray-600 mt-2">Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø­ØµØ§Ø¡ Ø±Ù‚Ù… (5)</div>
                        </button>
                        <button onclick="HalfYearlyStatistics.showForm('occupational-diseases')" class="btn-primary p-6 text-center hover:shadow-lg transition-shadow">
                            <i class="fas fa-stethoscope text-3xl mb-3"></i>
                            <div class="font-bold text-lg">Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø£Ù…Ø±Ø§Ø¶ Ø§Ù„Ù…Ù‡Ù†ÙŠØ©</div>
                            <div class="text-sm text-gray-600 mt-2">Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø­ØµØ§Ø¡ Ø±Ù‚Ù… (3)</div>
                        </button>
                        <button onclick="HalfYearlyStatistics.showForm('serious-accidents')" class="btn-primary p-6 text-center hover:shadow-lg transition-shadow">
                            <i class="fas fa-exclamation-triangle text-3xl mb-3"></i>
                            <div class="font-bold text-lg">Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø­ÙˆØ§Ø¯Ø« Ø§Ù„Ø¬Ø³ÙŠÙ…Ø©</div>
                            <div class="text-sm text-gray-600 mt-2">Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø­ØµØ§Ø¦ÙŠ Ø±Ù‚Ù… (4)</div>
                        </button>
                        <button onclick="HalfYearlyStatistics.showForm('statistics-appendix')" class="btn-primary p-6 text-center hover:shadow-lg transition-shadow">
                            <i class="fas fa-calculator text-3xl mb-3"></i>
                            <div class="font-bold text-lg">Ù…Ù„Ø­Ù‚ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ©</div>
                            <div class="text-sm text-gray-600 mt-2">Ø­Ø³Ø§Ø¨Ø§Øª Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªÙƒØ±Ø§Ø± ÙˆØ§Ù„Ø´Ø¯Ø©</div>
                        </button>
                    </div>
                    <div id="half-yearly-statistics-form-content"></div>
                </div>
            </div>
        `;
    },

    setupEventListeners() {
        // Event listeners will be set up in showForm
    },

    async showForm(formType) {
        this.currentForm = formType;
        const content = document.getElementById('half-yearly-statistics-form-content');
        if (!content) return;

        switch(formType) {
            case 'work-injuries':
                content.innerHTML = await this.renderWorkInjuriesForm();
                break;
            case 'ordinary-diseases':
                content.innerHTML = await this.renderOrdinaryDiseasesForm();
                break;
            case 'occupational-diseases':
                content.innerHTML = await this.renderOccupationalDiseasesForm();
                break;
            case 'serious-accidents':
                content.innerHTML = await this.renderSeriousAccidentsForm();
                break;
            case 'statistics-appendix':
                content.innerHTML = await this.renderStatisticsAppendixForm();
                break;
        }
        this.setupFormEventListeners(formType);
    },

    setupFormEventListeners(formType) {
        setTimeout(() => {
            // Save button
            const saveBtn = document.getElementById('save-statistics-btn');
            if (saveBtn) {
                saveBtn.addEventListener('click', () => this.handleSave(formType));
            }

            // Export PDF button
            const exportBtn = document.getElementById('export-statistics-pdf-btn');
            if (exportBtn) {
                exportBtn.addEventListener('click', () => this.handleExportPDF(formType));
            }

            // Print button
            const printBtn = document.getElementById('print-statistics-btn');
            if (printBtn) {
                printBtn.addEventListener('click', () => this.handlePrint(formType));
            }

            // Auto-calculate totals for ordinary diseases form
            if (formType === 'ordinary-diseases') {
                const inputs = ['ordinary-internal-cases', 'ordinary-internal-days', 'ordinary-surgery-cases', 
                               'ordinary-surgery-days', 'chronic-internal-cases', 'chronic-internal-days', 
                               'chronic-surgery-cases', 'chronic-surgery-days'];
                inputs.forEach(id => {
                    const input = document.getElementById(id);
                    if (input) {
                        input.addEventListener('input', () => this.updateOrdinaryDiseasesTotals());
                    }
                });
                this.updateOrdinaryDiseasesTotals();
            }

            // Auto-calculate for statistics appendix
            if (formType === 'statistics-appendix') {
                const inputs = ['num-workers', 'days-6-months', 'official-holidays', 'weekly-holidays', 
                               'total-leaves', 'hours-per-day', 'num-injuries', 'days-interruption'];
                inputs.forEach(id => {
                    const input = document.getElementById(id);
                    if (input) {
                        input.addEventListener('input', () => this.updateStatisticsAppendixCalculations());
                    }
                });
                this.updateStatisticsAppendixCalculations();
            }

            // Auto-calculate employee total
            if (formType === 'work-injuries') {
                const maleInput = document.getElementById('employee-males');
                const femaleInput = document.getElementById('employee-females');
                const minorInput = document.getElementById('employee-minors');
                const totalInput = document.getElementById('employee-total');
                
                const updateTotal = () => {
                    if (totalInput) {
                        const total = (parseInt(maleInput?.value) || 0) + 
                                     (parseInt(femaleInput?.value) || 0) + 
                                     (parseInt(minorInput?.value) || 0);
                        totalInput.value = total;
                    }
                };
                
                if (maleInput) maleInput.addEventListener('input', updateTotal);
                if (femaleInput) femaleInput.addEventListener('input', updateTotal);
                if (minorInput) minorInput.addEventListener('input', updateTotal);
                updateTotal();
            }
        }, 100);
    },

    updateOrdinaryDiseasesTotals() {
        const ordinaryInternal = parseInt(document.getElementById('ordinary-internal-cases')?.value) || 0;
        const ordinarySurgery = parseInt(document.getElementById('ordinary-surgery-cases')?.value) || 0;
        const ordinaryInternalDays = parseInt(document.getElementById('ordinary-internal-days')?.value) || 0;
        const ordinarySurgeryDays = parseInt(document.getElementById('ordinary-surgery-days')?.value) || 0;
        
        const chronicInternal = parseInt(document.getElementById('chronic-internal-cases')?.value) || 0;
        const chronicSurgery = parseInt(document.getElementById('chronic-surgery-cases')?.value) || 0;
        const chronicInternalDays = parseInt(document.getElementById('chronic-internal-days')?.value) || 0;
        const chronicSurgeryDays = parseInt(document.getElementById('chronic-surgery-days')?.value) || 0;

        const ordinaryTotalCases = document.getElementById('ordinary-total-cases');
        const ordinaryTotalDays = document.getElementById('ordinary-total-days');
        const chronicTotalCases = document.getElementById('chronic-total-cases');
        const chronicTotalDays = document.getElementById('chronic-total-days');

        if (ordinaryTotalCases) ordinaryTotalCases.value = ordinaryInternal + ordinarySurgery;
        if (ordinaryTotalDays) ordinaryTotalDays.value = ordinaryInternalDays + ordinarySurgeryDays;
        if (chronicTotalCases) chronicTotalCases.value = chronicInternal + chronicSurgery;
        if (chronicTotalDays) chronicTotalDays.value = chronicInternalDays + chronicSurgeryDays;
    },

    updateStatisticsAppendixCalculations() {
        const data = {
            numWorkers: parseInt(document.getElementById('num-workers')?.value) || 0,
            days6Months: parseInt(document.getElementById('days-6-months')?.value) || 180,
            officialHolidays: parseInt(document.getElementById('official-holidays')?.value) || 0,
            weeklyHolidays: parseInt(document.getElementById('weekly-holidays')?.value) || 0,
            totalLeaves: parseInt(document.getElementById('total-leaves')?.value) || 0,
            hoursPerDay: parseInt(document.getElementById('hours-per-day')?.value) || 8,
            numInjuries: parseInt(document.getElementById('num-injuries')?.value) || 0,
            daysInterruption: parseInt(document.getElementById('days-interruption')?.value) || 0
        };

        const totalDaysOutput = document.getElementById('total-days-output');
        const actualDaysOutput = document.getElementById('actual-days-output');
        const avgDaysOutput = document.getElementById('avg-days-output');
        const avgHoursOutput = document.getElementById('avg-hours-output');
        const frequencyRateOutput = document.getElementById('frequency-rate-output');
        const severityRateOutput = document.getElementById('severity-rate-output');

        if (totalDaysOutput) totalDaysOutput.textContent = this.calculateTotalDays(data);
        if (actualDaysOutput) actualDaysOutput.textContent = this.calculateActualDays(data);
        if (avgDaysOutput) avgDaysOutput.textContent = this.calculateAvgDays(data);
        if (avgHoursOutput) avgHoursOutput.textContent = this.calculateAvgHours(data);
        if (frequencyRateOutput) frequencyRateOutput.textContent = this.calculateFrequencyRate(data);
        if (severityRateOutput) severityRateOutput.textContent = this.calculateSeverityRate(data);
    },

    async renderWorkInjuriesForm() {
        const data = this.getFormData('workInjuries');
        const employees = AppState.appData.employees || [];
        const employeeCount = {
            males: employees.filter(e => e.gender === 'Ø°ÙƒØ±' || e.gender === 'male').length,
            females: employees.filter(e => e.gender === 'Ø£Ù†Ø«Ù‰' || e.gender === 'female').length,
            minors: employees.filter(e => e.age && parseInt(e.age) < 18).length,
            total: employees.length
        };

        return `
            <div class="mt-6 border-t pt-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold">Ø¥Ø­ØµØ§Ø¦ÙŠØ© Ø¥ØµØ§Ø¨Ø§Øª Ø§Ù„Ø¹Ù…Ù„ (1) - Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø­ØµØ§Ø¡ Ø±Ù‚Ù… (2)</h3>
                    <div class="flex gap-2">
                        <button id="save-statistics-btn" class="btn-primary">
                            <i class="fas fa-save ml-2"></i>Ø­ÙØ¸
                        </button>
                        <button id="export-statistics-pdf-btn" class="btn-success">
                            <i class="fas fa-file-pdf ml-2"></i>ØªØµØ¯ÙŠØ± PDF
                        </button>
                        <button id="print-statistics-btn" class="btn-secondary">
                            <i class="fas fa-print ml-2"></i>Ø·Ø¨Ø§Ø¹Ø©
                        </button>
                    </div>
                </div>
                
                <form id="work-injuries-form" class="space-y-6">
                    <!-- Header Section -->
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø¹Ù† Ø§Ù„ÙØªØ±Ø© Ù…Ù† *</label>
                                <input type="date" id="period-from" required class="form-input"
                                    value="${data?.periodFrom || ''}">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø¥Ù„Ù‰ *</label>
                                <input type="date" id="period-to" required class="form-input"
                                    value="${data?.periodTo || ''}">
                            </div>
                        </div>
                    </div>

                    <!-- Establishment Information -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©</label>
                            <input type="text" id="governorate" class="form-input"
                                value="${data?.governorate || ''}" placeholder="Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø´Ø£Ø© *</label>
                            <input type="text" id="establishment-name" required class="form-input"
                                value="${data?.establishmentName || ''}" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø´Ø£Ø©">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø§Ù‚ØªØµØ§Ø¯ÙŠ</label>
                            <input type="text" id="economic-activity" class="form-input"
                                value="${data?.economicActivity || ''}" placeholder="Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø§Ù‚ØªØµØ§Ø¯ÙŠ">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ£Ù…ÙŠÙ†ÙŠ</label>
                            <input type="text" id="insurance-number" class="form-input"
                                value="${data?.insuranceNumber || ''}" placeholder="Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ£Ù…ÙŠÙ†ÙŠ">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
                            <input type="text" id="address" class="form-input"
                                value="${data?.address || ''}" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ø±Ù‚Ù… Ø§Ù„ØªÙ„ÙŠÙÙˆÙ†</label>
                            <input type="text" id="phone-number" class="form-input"
                                value="${data?.phoneNumber || ''}" placeholder="Ø±Ù‚Ù… Ø§Ù„ØªÙ„ÙŠÙÙˆÙ†">
                        </div>
                    </div>

                    <!-- Employee Count -->
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <h4 class="font-bold mb-3">Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ø§Ù„</h4>
                        <div class="grid grid-cols-4 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø°ÙƒÙˆØ±</label>
                                <input type="number" id="employee-males" class="form-input"
                                    value="${data?.employeeMales || employeeCount.males}" min="0">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø¥Ù†Ø§Ø«</label>
                                <input type="number" id="employee-females" class="form-input"
                                    value="${data?.employeeFemales || employeeCount.females}" min="0">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø£Ø­Ø¯Ø§Ø«</label>
                                <input type="number" id="employee-minors" class="form-input"
                                    value="${data?.employeeMinors || employeeCount.minors}" min="0">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„Ø¬Ù…Ù„Ø©</label>
                                <input type="number" id="employee-total" class="form-input" readonly
                                    value="${data?.employeeTotal || employeeCount.total}">
                            </div>
                        </div>
                    </div>

                    <!-- Work Hours -->
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                        <h4 class="font-bold mb-3">(1) Ù…ØªÙˆØ³Ø· Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„ÙØ¹Ù„ÙŠØ© Ù„Ù„Ø¹Ø§Ù…Ù„ Ø§Ù„ÙˆØ§Ø­Ø¯</h4>
                        <div class="space-y-3">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„ÙˆØ±Ø¯ÙŠØ§Øª Ù…Ù†</label>
                                    <input type="time" id="shift-from-1" class="form-input"
                                        value="${data?.shiftFrom1 || ''}">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Ø¥Ù„Ù‰</label>
                                    <input type="time" id="shift-to-1" class="form-input"
                                        value="${data?.shiftTo1 || ''}">
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„ÙˆØ±Ø¯ÙŠØ§Øª Ù…Ù†</label>
                                    <input type="time" id="shift-from-2" class="form-input"
                                        value="${data?.shiftFrom2 || ''}">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Ø¥Ù„Ù‰</label>
                                    <input type="time" id="shift-to-2" class="form-input"
                                        value="${data?.shiftTo2 || ''}">
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„ÙˆØ±Ø¯ÙŠØ§Øª Ù…Ù†</label>
                                    <input type="time" id="shift-from-3" class="form-input"
                                        value="${data?.shiftFrom3 || ''}">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Ø¥Ù„Ù‰</label>
                                    <input type="time" id="shift-to-3" class="form-input"
                                        value="${data?.shiftTo3 || ''}">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Injuries Table -->
                    <div class="bg-white border border-gray-200 rounded-lg p-4">
                        <h4 class="font-bold mb-3">Ø¬Ø¯ÙˆÙ„ Ø¥ØµØ§Ø¨Ø§Øª Ø§Ù„Ø¹Ù…Ù„</h4>
                        <div class="overflow-x-auto">
                            <table class="data-table w-full">
                                <thead>
                                    <tr>
                                        <th>Ù…</th>
                                        <th>Ø§Ø³Ù… Ø§Ù„Ù…ØµØ§Ø¨</th>
                                        <th>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ£Ù…ÙŠÙ†ÙŠ</th>
                                        <th>Ø§Ù„Ù†ÙˆØ¹</th>
                                        <th>Ø§Ù„Ø³Ù†</th>
                                        <th>ØªØ§Ø±ÙŠØ® ÙˆÙ‚ÙˆØ¹ Ø§Ù„Ø­Ø§Ø¯Ø«</th>
                                        <th>ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¹Ù„Ø§Ø¬</th>
                                        <th>Ù…Ø¯Ø© Ø§Ù„Ø¥Ù†Ù‚Ø·Ø§Ø¹ Ø¨Ø§Ù„ÙŠÙˆÙ…</th>
                                        <th>ÙƒÙŠÙÙŠØ© Ø§Ù„Ø¥ØµØ§Ø¨Ø©</th>
                                        <th>ÙˆØ³ÙŠÙ„Ø© Ø§Ù„Ø¥ØµØ§Ø¨Ø©</th>
                                        <th>Ø§Ù„Ø¹Ø¶Ùˆ Ø§Ù„Ù…ØµØ§Ø¨</th>
                                        <th>Ø§Ù„Ù†ØªÙŠØ¬Ø©</th>
                                        <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                    </tr>
                                </thead>
                                <tbody id="work-injuries-table-body">
                                    ${this.renderWorkInjuriesTable(data?.injuries || [])}
                                </tbody>
                            </table>
                        </div>
                        <button type="button" onclick="HalfYearlyStatistics.addInjuryRow()" class="btn-secondary mt-4">
                            <i class="fas fa-plus ml-2"></i>Ø¥Ø¶Ø§ÙØ© Ø¥ØµØ§Ø¨Ø©
                        </button>
                    </div>

                    <!-- Summary Section -->
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                        <h4 class="font-bold mb-3">Ù…Ù„Ø®Øµ Ø§Ù„Ù…ØµØ§Ø¨ÙŠÙ†</h4>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø£) Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…ØµØ§Ø¨ÙŠÙ† Ø®Ù„Ø§Ù„ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</label>
                                <textarea id="current-period-injured" class="form-input" rows="4"
                                    placeholder="Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…ØµØ§Ø¨ÙŠÙ†...">${data?.currentPeriodInjured || ''}</textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø¨) Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…ØµØ§Ø¨ÙŠÙ† Ø®Ù„Ø§Ù„ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</label>
                                <textarea id="previous-period-injured" class="form-input" rows="4"
                                    placeholder="Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…ØµØ§Ø¨ÙŠÙ†...">${data?.previousPeriodInjured || ''}</textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Signature Section -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø³Ø¦ÙˆÙ„</label>
                            <input type="text" id="responsible-manager" class="form-input"
                                value="${data?.responsibleManager || ''}" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø³Ø¦ÙˆÙ„">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ù…Ø¯ÙŠØ± Ø§Ù„Ø³Ù„Ø§Ù…Ø© ÙˆØ§Ù„ØµØ­Ø© Ø§Ù„Ù…Ù‡Ù†ÙŠØ©</label>
                            <input type="text" id="hse-manager" class="form-input"
                                value="${data?.hseManager || ''}" placeholder="Ø§Ø³Ù… Ù…Ø¯ÙŠØ± Ø§Ù„Ø³Ù„Ø§Ù…Ø© ÙˆØ§Ù„ØµØ­Ø© Ø§Ù„Ù…Ù‡Ù†ÙŠØ©">
                        </div>
                    </div>
                </form>
            </div>
        `;
    },

    renderWorkInjuriesTable(injuries) {
        if (injuries.length === 0) {
            return '<tr><td colspan="13" class="text-center text-gray-500 py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥ØµØ§Ø¨Ø§Øª Ù…Ø³Ø¬Ù„Ø©</td></tr>';
        }
        return injuries.map((injury, index) => `
            <tr data-index="${index}">
                <td>${index + 1}</td>
                <td><input type="text" class="form-input" value="${Utils.escapeHTML(injury.injuredName || '')}" data-field="injuredName"></td>
                <td><input type="text" class="form-input" value="${Utils.escapeHTML(injury.insuranceNumber || '')}" data-field="insuranceNumber"></td>
                <td>
                    <select class="form-input" data-field="gender">
                        <option value="Ø°ÙƒØ±" ${injury.gender === 'Ø°ÙƒØ±' ? 'selected' : ''}>Ø°ÙƒØ±</option>
                        <option value="Ø£Ù†Ø«Ù‰" ${injury.gender === 'Ø£Ù†Ø«Ù‰' ? 'selected' : ''}>Ø£Ù†Ø«Ù‰</option>
                    </select>
                </td>
                <td><input type="number" class="form-input" value="${injury.age || ''}" data-field="age" min="0"></td>
                <td><input type="date" class="form-input" value="${injury.accidentDate || ''}" data-field="accidentDate"></td>
                <td><input type="date" class="form-input" value="${injury.treatmentEndDate || ''}" data-field="treatmentEndDate"></td>
                <td><input type="number" class="form-input" value="${injury.absenceDays || ''}" data-field="absenceDays" min="0"></td>
                <td><input type="text" class="form-input" value="${Utils.escapeHTML(injury.howInjuryOccurred || '')}" data-field="howInjuryOccurred"></td>
                <td><input type="text" class="form-input" value="${Utils.escapeHTML(injury.meansOfInjury || '')}" data-field="meansOfInjury"></td>
                <td><input type="text" class="form-input" value="${Utils.escapeHTML(injury.injuredBodyPart || '')}" data-field="injuredBodyPart"></td>
                <td>
                    <select class="form-input" data-field="result">
                        <option value="">Ø§Ø®ØªØ±</option>
                        <option value="Ø´ÙØ§Ø¡ ØªØ­Øª Ø§Ù„Ø¹Ù„Ø§Ø¬" ${injury.result === 'Ø´ÙØ§Ø¡ ØªØ­Øª Ø§Ù„Ø¹Ù„Ø§Ø¬' ? 'selected' : ''}>Ø´ÙØ§Ø¡ ØªØ­Øª Ø§Ù„Ø¹Ù„Ø§Ø¬</option>
                        <option value="Ø´ÙØ§Ø¡ Ø¨Ø¯ÙˆÙ† Ø¹Ø¬Ø²" ${injury.result === 'Ø´ÙØ§Ø¡ Ø¨Ø¯ÙˆÙ† Ø¹Ø¬Ø²' ? 'selected' : ''}>Ø´ÙØ§Ø¡ Ø¨Ø¯ÙˆÙ† Ø¹Ø¬Ø²</option>
                        <option value="Ø´ÙØ§Ø¡ Ø¨Ø¹Ø¬Ø²" ${injury.result === 'Ø´ÙØ§Ø¡ Ø¨Ø¹Ø¬Ø²' ? 'selected' : ''}>Ø´ÙØ§Ø¡ Ø¨Ø¹Ø¬Ø²</option>
                        <option value="ÙˆÙØ§Ø©" ${injury.result === 'ÙˆÙØ§Ø©' ? 'selected' : ''}>ÙˆÙØ§Ø©</option>
                    </select>
                </td>
                <td>
                    <button type="button" onclick="HalfYearlyStatistics.removeInjuryRow(${index})" class="btn-icon btn-icon-danger">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    },

    addInjuryRow() {
        const tbody = document.getElementById('work-injuries-table-body');
        if (!tbody) return;
        
        const newRow = document.createElement('tr');
        const index = tbody.querySelectorAll('tr').length;
        newRow.setAttribute('data-index', index);
        newRow.innerHTML = `
            <td>${index + 1}</td>
            <td><input type="text" class="form-input" data-field="injuredName"></td>
            <td><input type="text" class="form-input" data-field="insuranceNumber"></td>
            <td>
                <select class="form-input" data-field="gender">
                    <option value="Ø°ÙƒØ±">Ø°ÙƒØ±</option>
                    <option value="Ø£Ù†Ø«Ù‰">Ø£Ù†Ø«Ù‰</option>
                </select>
            </td>
            <td><input type="number" class="form-input" data-field="age" min="0"></td>
            <td><input type="date" class="form-input" data-field="accidentDate"></td>
            <td><input type="date" class="form-input" data-field="treatmentEndDate"></td>
            <td><input type="number" class="form-input" data-field="absenceDays" min="0"></td>
            <td><input type="text" class="form-input" data-field="howInjuryOccurred"></td>
            <td><input type="text" class="form-input" data-field="meansOfInjury"></td>
            <td><input type="text" class="form-input" data-field="injuredBodyPart"></td>
            <td>
                <select class="form-input" data-field="result">
                    <option value="">Ø§Ø®ØªØ±</option>
                    <option value="Ø´ÙØ§Ø¡ ØªØ­Øª Ø§Ù„Ø¹Ù„Ø§Ø¬">Ø´ÙØ§Ø¡ ØªØ­Øª Ø§Ù„Ø¹Ù„Ø§Ø¬</option>
                    <option value="Ø´ÙØ§Ø¡ Ø¨Ø¯ÙˆÙ† Ø¹Ø¬Ø²">Ø´ÙØ§Ø¡ Ø¨Ø¯ÙˆÙ† Ø¹Ø¬Ø²</option>
                    <option value="Ø´ÙØ§Ø¡ Ø¨Ø¹Ø¬Ø²">Ø´ÙØ§Ø¡ Ø¨Ø¹Ø¬Ø²</option>
                    <option value="ÙˆÙØ§Ø©">ÙˆÙØ§Ø©</option>
                </select>
            </td>
            <td>
                <button type="button" onclick="HalfYearlyStatistics.removeInjuryRow(${index})" class="btn-icon btn-icon-danger">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
        tbody.appendChild(newRow);
        this.updateRowNumbers();
    },

    removeInjuryRow(index) {
        const tbody = document.getElementById('work-injuries-table-body');
        if (!tbody) return;
        
        const row = tbody.querySelector(`tr[data-index="${index}"]`);
        if (row) {
            row.remove();
            this.updateRowNumbers();
        }
    },

    updateRowNumbers() {
        const tbody = document.getElementById('work-injuries-table-body');
        if (!tbody) return;
        
        const rows = tbody.querySelectorAll('tr');
        rows.forEach((row, index) => {
            row.setAttribute('data-index', index);
            const firstCell = row.querySelector('td:first-child');
            if (firstCell) firstCell.textContent = index + 1;
            
            const deleteBtn = row.querySelector('button[onclick]');
            if (deleteBtn) {
                deleteBtn.setAttribute('onclick', `HalfYearlyStatistics.removeInjuryRow(${index})`);
            }
        });
    },

    getFormData(formType) {
        const stats = AppState.appData.halfYearlyStatistics || {};
        switch(formType) {
            case 'workInjuries':
                return stats.workInjuries?.[0] || {};
            case 'ordinaryDiseases':
                return stats.ordinaryDiseases?.[0] || {};
            case 'occupationalDiseases':
                return stats.occupationalDiseases?.[0] || {};
            case 'seriousAccidents':
                return stats.seriousAccidents?.[0] || {};
            case 'statisticsAppendix':
                return stats.statisticsAppendix || {};
            default:
                return {};
        }
    },

    async handleSave(formType) {
        Loading.show();
        try {
            const formData = this.collectFormData(formType);
            
            if (!AppState.appData.halfYearlyStatistics) {
                AppState.appData.halfYearlyStatistics = {
                    workInjuries: [],
                    ordinaryDiseases: [],
                    occupationalDiseases: [],
                    seriousAccidents: [],
                    statisticsAppendix: {}
                };
            }

            switch(formType) {
                case 'work-injuries':
                    const existingIndex = AppState.appData.halfYearlyStatistics.workInjuries.findIndex(f => f.id === formData.id);
                    if (existingIndex >= 0) {
                        AppState.appData.halfYearlyStatistics.workInjuries[existingIndex] = formData;
                    } else {
                        AppState.appData.halfYearlyStatistics.workInjuries.push(formData);
                    }
                    break;
                case 'ordinary-diseases':
                    const ordIndex = AppState.appData.halfYearlyStatistics.ordinaryDiseases.findIndex(f => f.id === formData.id);
                    if (ordIndex >= 0) {
                        AppState.appData.halfYearlyStatistics.ordinaryDiseases[ordIndex] = formData;
                    } else {
                        AppState.appData.halfYearlyStatistics.ordinaryDiseases.push(formData);
                    }
                    break;
                case 'occupational-diseases':
                    const occIndex = AppState.appData.halfYearlyStatistics.occupationalDiseases.findIndex(f => f.id === formData.id);
                    if (occIndex >= 0) {
                        AppState.appData.halfYearlyStatistics.occupationalDiseases[occIndex] = formData;
                    } else {
                        AppState.appData.halfYearlyStatistics.occupationalDiseases.push(formData);
                    }
                    break;
                case 'serious-accidents':
                    const accIndex = AppState.appData.halfYearlyStatistics.seriousAccidents.findIndex(f => f.id === formData.id);
                    if (accIndex >= 0) {
                        AppState.appData.halfYearlyStatistics.seriousAccidents[accIndex] = formData;
                    } else {
                        AppState.appData.halfYearlyStatistics.seriousAccidents.push(formData);
                    }
                    break;
                case 'statistics-appendix':
                    AppState.appData.halfYearlyStatistics.statisticsAppendix = formData;
                    break;
            }

            await DataManager.save();
            await GoogleIntegration.autoSave('HalfYearlyStatistics', AppState.appData.halfYearlyStatistics);
            Loading.hide();
            Notification.success('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
        } catch (error) {
            Loading.hide();
            Notification.error('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
        }
    },

    collectFormData(formType) {
        const baseData = {
            id: Utils.generateId('HYS'),
            formType: formType,
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
        };

        switch(formType) {
            case 'work-injuries':
                const tbody = document.getElementById('work-injuries-table-body');
                const injuries = [];
                if (tbody) {
                    tbody.querySelectorAll('tr').forEach(row => {
                        const inputs = row.querySelectorAll('input, select');
                        const injury = {};
                        inputs.forEach(input => {
                            const field = input.getAttribute('data-field');
                            if (field) {
                                if (input.type === 'number') {
                                    injury[field] = parseInt(input.value) || 0;
                                } else if (input.type === 'date') {
                                    injury[field] = input.value || '';
                                } else {
                                    injury[field] = input.value.trim();
                                }
                            }
                        });
                        if (injury.injuredName || injury.insuranceNumber) {
                            injuries.push(injury);
                        }
                    });
                }

                return {
                    ...baseData,
                    periodFrom: document.getElementById('period-from')?.value || '',
                    periodTo: document.getElementById('period-to')?.value || '',
                    governorate: document.getElementById('governorate')?.value.trim() || '',
                    establishmentName: document.getElementById('establishment-name')?.value.trim() || '',
                    economicActivity: document.getElementById('economic-activity')?.value.trim() || '',
                    insuranceNumber: document.getElementById('insurance-number')?.value.trim() || '',
                    address: document.getElementById('address')?.value.trim() || '',
                    phoneNumber: document.getElementById('phone-number')?.value.trim() || '',
                    employeeMales: parseInt(document.getElementById('employee-males')?.value) || 0,
                    employeeFemales: parseInt(document.getElementById('employee-females')?.value) || 0,
                    employeeMinors: parseInt(document.getElementById('employee-minors')?.value) || 0,
                    employeeTotal: parseInt(document.getElementById('employee-total')?.value) || 0,
                    shiftFrom1: document.getElementById('shift-from-1')?.value || '',
                    shiftTo1: document.getElementById('shift-to-1')?.value || '',
                    shiftFrom2: document.getElementById('shift-from-2')?.value || '',
                    shiftTo2: document.getElementById('shift-to-2')?.value || '',
                    shiftFrom3: document.getElementById('shift-from-3')?.value || '',
                    shiftTo3: document.getElementById('shift-to-3')?.value || '',
                    injuries: injuries,
                    currentPeriodInjured: document.getElementById('current-period-injured')?.value.trim() || '',
                    previousPeriodInjured: document.getElementById('previous-period-injured')?.value.trim() || '',
                    responsibleManager: document.getElementById('responsible-manager')?.value.trim() || '',
                    hseManager: document.getElementById('hse-manager')?.value.trim() || ''
                };
            case 'ordinary-diseases':
                return {
                    ...baseData,
                    periodFrom: document.getElementById('period-from')?.value || '',
                    periodTo: document.getElementById('period-to')?.value || '',
                    establishmentName: document.getElementById('establishment-name')?.value.trim() || '',
                    governorate: document.getElementById('governorate')?.value.trim() || '',
                    ordinaryInternalCases: parseInt(document.getElementById('ordinary-internal-cases')?.value) || 0,
                    ordinaryInternalDays: parseInt(document.getElementById('ordinary-internal-days')?.value) || 0,
                    ordinarySurgeryCases: parseInt(document.getElementById('ordinary-surgery-cases')?.value) || 0,
                    ordinarySurgeryDays: parseInt(document.getElementById('ordinary-surgery-days')?.value) || 0,
                    chronicInternalCases: parseInt(document.getElementById('chronic-internal-cases')?.value) || 0,
                    chronicInternalDays: parseInt(document.getElementById('chronic-internal-days')?.value) || 0,
                    chronicSurgeryCases: parseInt(document.getElementById('chronic-surgery-cases')?.value) || 0,
                    chronicSurgeryDays: parseInt(document.getElementById('chronic-surgery-days')?.value) || 0,
                    hseManager: document.getElementById('hse-manager')?.value.trim() || '',
                    establishmentDoctor: document.getElementById('establishment-doctor')?.value.trim() || '',
                    responsibleManager: document.getElementById('responsible-manager')?.value.trim() || ''
                };
            case 'occupational-diseases':
                const diseasesTbody = document.getElementById('occupational-diseases-table-body');
                const diseases = [];
                if (diseasesTbody) {
                    diseasesTbody.querySelectorAll('tr').forEach(row => {
                        const inputs = row.querySelectorAll('input, select');
                        const disease = {};
                        inputs.forEach(input => {
                            const field = input.getAttribute('data-field');
                            if (field) {
                                if (input.type === 'number') {
                                    disease[field] = parseInt(input.value) || 0;
                                } else {
                                    disease[field] = input.value.trim();
                                }
                            }
                        });
                        if (disease.workerName || disease.insuranceNumber) {
                            diseases.push(disease);
                        }
                    });
                }
                return {
                    ...baseData,
                    periodFrom: document.getElementById('period-from')?.value || '',
                    periodTo: document.getElementById('period-to')?.value || '',
                    establishmentName: document.getElementById('establishment-name')?.value.trim() || '',
                    governorate: document.getElementById('governorate')?.value.trim() || '',
                    diseases: diseases,
                    hseManager: document.getElementById('hse-manager')?.value.trim() || '',
                    establishmentDoctor: document.getElementById('establishment-doctor')?.value.trim() || '',
                    responsibleManager: document.getElementById('responsible-manager')?.value.trim() || ''
                };
            case 'serious-accidents':
                const accidentsTbody = document.getElementById('serious-accidents-table-body');
                const accidents = [];
                if (accidentsTbody) {
                    accidentsTbody.querySelectorAll('tr').forEach(row => {
                        const inputs = row.querySelectorAll('input');
                        const accident = {};
                        inputs.forEach(input => {
                            const field = input.getAttribute('data-field');
                            if (field) {
                                if (input.type === 'number') {
                                    accident[field] = parseInt(input.value) || 0;
                                } else if (input.type === 'date' || input.type === 'time') {
                                    accident[field] = input.value || '';
                                } else {
                                    accident[field] = input.value.trim();
                                }
                            }
                        });
                        if (accident.accidentDate || accident.accidentType) {
                            accidents.push(accident);
                        }
                    });
                }
                return {
                    ...baseData,
                    periodFrom: document.getElementById('period-from')?.value || '',
                    periodTo: document.getElementById('period-to')?.value || '',
                    establishmentName: document.getElementById('establishment-name')?.value.trim() || '',
                    address: document.getElementById('address')?.value.trim() || '',
                    accidents: accidents,
                    hseManager: document.getElementById('hse-manager')?.value.trim() || '',
                    establishmentDoctor: document.getElementById('establishment-doctor')?.value.trim() || '',
                    responsibleManager: document.getElementById('responsible-manager')?.value.trim() || ''
                };
            case 'statistics-appendix':
                const appendixData = {
                    numWorkers: parseInt(document.getElementById('num-workers')?.value) || 0,
                    days6Months: parseInt(document.getElementById('days-6-months')?.value) || 180,
                    officialHolidays: parseInt(document.getElementById('official-holidays')?.value) || 0,
                    weeklyHolidays: parseInt(document.getElementById('weekly-holidays')?.value) || 0,
                    totalLeaves: parseInt(document.getElementById('total-leaves')?.value) || 0,
                    hoursPerDay: parseInt(document.getElementById('hours-per-day')?.value) || 8,
                    numInjuries: parseInt(document.getElementById('num-injuries')?.value) || 0,
                    daysInterruption: parseInt(document.getElementById('days-interruption')?.value) || 0,
                    safetyOfficer: document.getElementById('safety-officer')?.value.trim() || '',
                    responsibleManager: document.getElementById('responsible-manager')?.value.trim() || ''
                };
                return {
                    ...baseData,
                    ...appendixData,
                    totalDaysOutput: document.getElementById('total-days-output')?.textContent || '',
                    actualDaysOutput: document.getElementById('actual-days-output')?.textContent || '',
                    avgDaysOutput: document.getElementById('avg-days-output')?.textContent || '',
                    avgHoursOutput: document.getElementById('avg-hours-output')?.textContent || '',
                    frequencyRateOutput: document.getElementById('frequency-rate-output')?.textContent || '',
                    severityRateOutput: document.getElementById('severity-rate-output')?.textContent || ''
                };
            default:
                return baseData;
        }
    },

    async handleExportPDF(formType) {
        // Implementation for PDF export
        Notification.info('Ù‚Ø±ÙŠØ¨Ø§Ù‹: ØªØµØ¯ÙŠØ± PDF');
    },

    async handlePrint(formType) {
        window.print();
    },

    // ===== Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø£Ù…Ø±Ø§Ø¶ Ø§Ù„Ø¹Ø§Ø¯ÙŠØ© =====
    async renderOrdinaryDiseasesForm() {
        const data = this.getFormData('ordinaryDiseases');
        
        return `
            <div class="mt-6 border-t pt-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold">Ø¥Ø­ØµØ§Ø¦ÙŠØ© Ø§Ù„Ø£Ù…Ø±Ø§Ø¶ Ø§Ù„Ø¹Ø§Ø¯ÙŠØ© ÙˆØ§Ù„Ù…Ø²Ù…Ù†Ø© - Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø­ØµØ§Ø¡ Ø±Ù‚Ù… (5)</h3>
                    <div class="flex gap-2">
                        <button id="save-statistics-btn" class="btn-primary">
                            <i class="fas fa-save ml-2"></i>Ø­ÙØ¸
                        </button>
                        <button id="export-statistics-pdf-btn" class="btn-success">
                            <i class="fas fa-file-pdf ml-2"></i>ØªØµØ¯ÙŠØ± PDF
                        </button>
                        <button id="print-statistics-btn" class="btn-secondary">
                            <i class="fas fa-print ml-2"></i>Ø·Ø¨Ø§Ø¹Ø©
                        </button>
                    </div>
                </div>
                
                <form id="ordinary-diseases-form" class="space-y-6">
                    <!-- Header Section -->
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø¹Ù† Ø§Ù„ÙØªØ±Ø© Ù…Ù† *</label>
                                <input type="date" id="period-from" required class="form-input"
                                    value="${data?.periodFrom || ''}">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø¥Ù„Ù‰ *</label>
                                <input type="date" id="period-to" required class="form-input"
                                    value="${data?.periodTo || ''}">
                            </div>
                        </div>
                    </div>

                    <!-- Establishment Information -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø´Ø£Ø© *</label>
                            <input type="text" id="establishment-name" required class="form-input"
                                value="${data?.establishmentName || ''}" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø´Ø£Ø©">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©</label>
                            <input type="text" id="governorate" class="form-input"
                                value="${data?.governorate || ''}" placeholder="Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©">
                        </div>
                    </div>

                    <!-- Diseases Table -->
                    <div class="bg-white border border-gray-200 rounded-lg p-4">
                        <h4 class="font-bold mb-3">Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ù…Ø±Ø§Ø¶ Ø§Ù„Ø¹Ø§Ø¯ÙŠØ© ÙˆØ§Ù„Ù…Ø²Ù…Ù†Ø©</h4>
                        <div class="overflow-x-auto">
                            <table class="data-table w-full">
                                <thead>
                                    <tr>
                                        <th rowspan="2">Ø§Ù„Ø¨ÙŠØ§Ù†</th>
                                        <th colspan="2">Ø§Ù„Ø£Ù…Ø±Ø§Ø¶ Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©</th>
                                        <th colspan="2">Ø§Ù„Ø£Ù…Ø±Ø§Ø¶ Ø§Ù„Ù…Ø²Ù…Ù†Ø©</th>
                                    </tr>
                                    <tr>
                                        <th>Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø§Ù„Ø§Øª</th>
                                        <th>Ø£ÙŠØ§Ù… Ø§Ù„Ø§Ù†Ù‚Ø·Ø§Ø¹</th>
                                        <th>Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø§Ù„Ø§Øª</th>
                                        <th>Ø£ÙŠØ§Ù… Ø§Ù„Ø§Ù†Ù‚Ø·Ø§Ø¹</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td class="font-semibold bg-gray-100">Ø¨Ø§Ø·Ù†ÙŠ</td>
                                        <td><input type="number" id="ordinary-internal-cases" class="form-input" value="${data?.ordinaryInternalCases || 0}" min="0"></td>
                                        <td><input type="number" id="ordinary-internal-days" class="form-input" value="${data?.ordinaryInternalDays || 0}" min="0"></td>
                                        <td><input type="number" id="chronic-internal-cases" class="form-input" value="${data?.chronicInternalCases || 0}" min="0"></td>
                                        <td><input type="number" id="chronic-internal-days" class="form-input" value="${data?.chronicInternalDays || 0}" min="0"></td>
                                    </tr>
                                    <tr>
                                        <td class="font-semibold bg-gray-100">Ø¬Ø±Ø§Ø­Ø©</td>
                                        <td><input type="number" id="ordinary-surgery-cases" class="form-input" value="${data?.ordinarySurgeryCases || 0}" min="0"></td>
                                        <td><input type="number" id="ordinary-surgery-days" class="form-input" value="${data?.ordinarySurgeryDays || 0}" min="0"></td>
                                        <td><input type="number" id="chronic-surgery-cases" class="form-input" value="${data?.chronicSurgeryCases || 0}" min="0"></td>
                                        <td><input type="number" id="chronic-surgery-days" class="form-input" value="${data?.chronicSurgeryDays || 0}" min="0"></td>
                                    </tr>
                                    <tr>
                                        <td class="font-semibold bg-gray-100">Ø§Ù„Ø¬Ù…Ù„Ø©</td>
                                        <td><input type="number" id="ordinary-total-cases" class="form-input" readonly value="${(data?.ordinaryInternalCases || 0) + (data?.ordinarySurgeryCases || 0)}"></td>
                                        <td><input type="number" id="ordinary-total-days" class="form-input" readonly value="${(data?.ordinaryInternalDays || 0) + (data?.ordinarySurgeryDays || 0)}"></td>
                                        <td><input type="number" id="chronic-total-cases" class="form-input" readonly value="${(data?.chronicInternalCases || 0) + (data?.chronicSurgeryCases || 0)}"></td>
                                        <td><input type="number" id="chronic-total-days" class="form-input" readonly value="${(data?.chronicInternalDays || 0) + (data?.chronicSurgeryDays || 0)}"></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Notes Section -->
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <h4 class="font-bold mb-2">Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</h4>
                        <ul class="list-disc list-inside text-sm text-gray-700 space-y-1">
                            <li>Ø£Ù…Ø±Ø§Ø¶ Ø§Ù„Ø¨Ø§Ø·Ù†ÙŠ: ØªØ´Ù…Ù„ Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø£Ù…Ø±Ø§Ø¶ Ø§Ù„Ø¬Ù„Ø¯ÙŠØ©</li>
                            <li>Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø¬Ø±Ø§Ø­Ø©: ØªØ´Ù…Ù„ Ø§Ù„Ø¹ÙŠÙˆÙ† ÙˆØ§Ù„Ø£Ø³Ù†Ø§Ù† ÙˆØ§Ù„Ø£Ù†Ù ÙˆØ§Ù„Ø£Ø°Ù† ÙˆØ§Ù„Ø­Ù†Ø¬Ø±Ø©</li>
                        </ul>
                    </div>

                    <!-- Signature Section -->
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ù…Ø¯ÙŠØ± Ø§Ù„Ø³Ù„Ø§Ù…Ø© ÙˆØ§Ù„ØµØ­Ø© Ø§Ù„Ù…Ù‡Ù†ÙŠØ©</label>
                            <input type="text" id="hse-manager" class="form-input"
                                value="${data?.hseManager || ''}" placeholder="Ø§Ø³Ù… Ù…Ø¯ÙŠØ± Ø§Ù„Ø³Ù„Ø§Ù…Ø©">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ø·Ø¨ÙŠØ¨ Ø§Ù„Ù…Ù†Ø´Ø£Ø©</label>
                            <input type="text" id="establishment-doctor" class="form-input"
                                value="${data?.establishmentDoctor || ''}" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø¨ÙŠØ¨">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø³Ø¦ÙˆÙ„</label>
                            <input type="text" id="responsible-manager" class="form-input"
                                value="${data?.responsibleManager || ''}" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø³Ø¦ÙˆÙ„">
                        </div>
                    </div>
                </form>
            </div>
        `;
    },

    // ===== Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø£Ù…Ø±Ø§Ø¶ Ø§Ù„Ù…Ù‡Ù†ÙŠØ© =====
    async renderOccupationalDiseasesForm() {
        const data = this.getFormData('occupationalDiseases');
        
        return `
            <div class="mt-6 border-t pt-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold">Ø¥Ø­ØµØ§Ø¦ÙŠØ© Ø§Ù„Ø£Ù…Ø±Ø§Ø¶ Ø§Ù„Ù…Ù‡Ù†ÙŠØ© - Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø­ØµØ§Ø¡ Ø±Ù‚Ù… (3)</h3>
                    <div class="flex gap-2">
                        <button id="save-statistics-btn" class="btn-primary">
                            <i class="fas fa-save ml-2"></i>Ø­ÙØ¸
                        </button>
                        <button id="export-statistics-pdf-btn" class="btn-success">
                            <i class="fas fa-file-pdf ml-2"></i>ØªØµØ¯ÙŠØ± PDF
                        </button>
                        <button id="print-statistics-btn" class="btn-secondary">
                            <i class="fas fa-print ml-2"></i>Ø·Ø¨Ø§Ø¹Ø©
                        </button>
                    </div>
                </div>
                
                <form id="occupational-diseases-form" class="space-y-6">
                    <!-- Header Section -->
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø¹Ù† Ø§Ù„ÙØªØ±Ø© Ù…Ù† *</label>
                                <input type="date" id="period-from" required class="form-input"
                                    value="${data?.periodFrom || ''}">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø¥Ù„Ù‰ *</label>
                                <input type="date" id="period-to" required class="form-input"
                                    value="${data?.periodTo || ''}">
                            </div>
                        </div>
                    </div>

                    <!-- Establishment Information -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø´Ø£Ø© *</label>
                            <input type="text" id="establishment-name" required class="form-input"
                                value="${data?.establishmentName || ''}" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø´Ø£Ø©">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©</label>
                            <input type="text" id="governorate" class="form-input"
                                value="${data?.governorate || ''}" placeholder="Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©">
                        </div>
                    </div>

                    <!-- Diseases Table -->
                    <div class="bg-white border border-gray-200 rounded-lg p-4">
                        <h4 class="font-bold mb-3">Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ù…Ø±Ø§Ø¶ Ø§Ù„Ù…Ù‡Ù†ÙŠØ©</h4>
                        <div class="overflow-x-auto">
                            <table class="data-table w-full">
                                <thead>
                                    <tr>
                                        <th>Ù…</th>
                                        <th>Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ù…Ù„</th>
                                        <th>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ£Ù…ÙŠÙ†ÙŠ</th>
                                        <th>Ø§Ù„Ù†ÙˆØ¹</th>
                                        <th>Ø§Ù„Ø³Ù†</th>
                                        <th>Ø§Ù„Ù…Ù‡Ù†Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</th>
                                        <th>Ù…Ø¯Ø© Ù…Ø²Ø§ÙˆÙ„Ø© Ø§Ù„Ù…Ù‡Ù†Ø©</th>
                                        <th>Ù†ÙˆØ¹ Ø§Ù„Ù…Ø±Ø¶ Ø§Ù„Ù…Ù‡Ù†ÙŠ</th>
                                        <th>Ù…Ø¯Ø© Ø§Ù„Ø§Ù†Ù‚Ø·Ø§Ø¹ Ø¨Ø§Ù„ÙŠÙˆÙ…</th>
                                        <th>Ø§Ù„Ù†ØªÙŠØ¬Ø©</th>
                                        <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
                                        <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                    </tr>
                                </thead>
                                <tbody id="occupational-diseases-table-body">
                                    ${this.renderOccupationalDiseasesTable(data?.diseases || [])}
                                </tbody>
                            </table>
                        </div>
                        <button type="button" onclick="HalfYearlyStatistics.addOccupationalDiseaseRow()" class="btn-secondary mt-4">
                            <i class="fas fa-plus ml-2"></i>Ø¥Ø¶Ø§ÙØ© Ù…Ø±Ø¶ Ù…Ù‡Ù†ÙŠ
                        </button>
                    </div>

                    <!-- Signature Section -->
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ù…Ø¯ÙŠØ± Ø§Ù„Ø³Ù„Ø§Ù…Ø© ÙˆØ§Ù„ØµØ­Ø© Ø§Ù„Ù…Ù‡Ù†ÙŠØ©</label>
                            <input type="text" id="hse-manager" class="form-input"
                                value="${data?.hseManager || ''}" placeholder="Ø§Ø³Ù… Ù…Ø¯ÙŠØ± Ø§Ù„Ø³Ù„Ø§Ù…Ø©">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ø·Ø¨ÙŠØ¨ Ø§Ù„Ù…Ù†Ø´Ø£Ø©</label>
                            <input type="text" id="establishment-doctor" class="form-input"
                                value="${data?.establishmentDoctor || ''}" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø¨ÙŠØ¨">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø³Ø¦ÙˆÙ„</label>
                            <input type="text" id="responsible-manager" class="form-input"
                                value="${data?.responsibleManager || ''}" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø³Ø¦ÙˆÙ„">
                        </div>
                    </div>
                </form>
            </div>
        `;
    },

    renderOccupationalDiseasesTable(diseases) {
        if (diseases.length === 0) {
            return '<tr><td colspan="12" class="text-center text-gray-500 py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù…Ø±Ø§Ø¶ Ù…Ù‡Ù†ÙŠØ© Ù…Ø³Ø¬Ù„Ø©</td></tr>';
        }
        return diseases.map((disease, index) => `
            <tr data-index="${index}">
                <td>${index + 1}</td>
                <td><input type="text" class="form-input" value="${Utils.escapeHTML(disease.workerName || '')}" data-field="workerName"></td>
                <td><input type="text" class="form-input" value="${Utils.escapeHTML(disease.insuranceNumber || '')}" data-field="insuranceNumber"></td>
                <td>
                    <select class="form-input" data-field="gender">
                        <option value="Ø°ÙƒØ±" ${disease.gender === 'Ø°ÙƒØ±' ? 'selected' : ''}>Ø°ÙƒØ±</option>
                        <option value="Ø£Ù†Ø«Ù‰" ${disease.gender === 'Ø£Ù†Ø«Ù‰' ? 'selected' : ''}>Ø£Ù†Ø«Ù‰</option>
                    </select>
                </td>
                <td><input type="number" class="form-input" value="${disease.age || ''}" data-field="age" min="0"></td>
                <td><input type="text" class="form-input" value="${Utils.escapeHTML(disease.currentOccupation || '')}" data-field="currentOccupation"></td>
                <td><input type="text" class="form-input" value="${Utils.escapeHTML(disease.occupationDuration || '')}" data-field="occupationDuration"></td>
                <td><input type="text" class="form-input" value="${Utils.escapeHTML(disease.diseaseType || '')}" data-field="diseaseType"></td>
                <td><input type="number" class="form-input" value="${disease.absenceDays || ''}" data-field="absenceDays" min="0"></td>
                <td>
                    <select class="form-input" data-field="result">
                        <option value="">Ø§Ø®ØªØ±</option>
                        <option value="ØªØ­Øª Ø§Ù„Ø¹Ù„Ø§Ø¬" ${disease.result === 'ØªØ­Øª Ø§Ù„Ø¹Ù„Ø§Ø¬' ? 'selected' : ''}>ØªØ­Øª Ø§Ù„Ø¹Ù„Ø§Ø¬</option>
                        <option value="Ø´ÙØ§Ø¡ Ø¨Ø¯ÙˆÙ† Ø¹Ø¬Ø²" ${disease.result === 'Ø´ÙØ§Ø¡ Ø¨Ø¯ÙˆÙ† Ø¹Ø¬Ø²' ? 'selected' : ''}>Ø´ÙØ§Ø¡ Ø¨Ø¯ÙˆÙ† Ø¹Ø¬Ø²</option>
                        <option value="Ø´ÙØ§Ø¡ Ø¨Ø¹Ø¬Ø²" ${disease.result === 'Ø´ÙØ§Ø¡ Ø¨Ø¹Ø¬Ø²' ? 'selected' : ''}>Ø´ÙØ§Ø¡ Ø¨Ø¹Ø¬Ø²</option>
                        <option value="ÙˆÙØ§Ø©" ${disease.result === 'ÙˆÙØ§Ø©' ? 'selected' : ''}>ÙˆÙØ§Ø©</option>
                    </select>
                </td>
                <td><input type="text" class="form-input" value="${Utils.escapeHTML(disease.notes || '')}" data-field="notes"></td>
                <td>
                    <button type="button" onclick="HalfYearlyStatistics.removeOccupationalDiseaseRow(${index})" class="btn-icon btn-icon-danger">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    },

    addOccupationalDiseaseRow() {
        const tbody = document.getElementById('occupational-diseases-table-body');
        if (!tbody) return;
        
        const newRow = document.createElement('tr');
        const index = tbody.querySelectorAll('tr').length;
        newRow.setAttribute('data-index', index);
        newRow.innerHTML = `
            <td>${index + 1}</td>
            <td><input type="text" class="form-input" data-field="workerName"></td>
            <td><input type="text" class="form-input" data-field="insuranceNumber"></td>
            <td>
                <select class="form-input" data-field="gender">
                    <option value="Ø°ÙƒØ±">Ø°ÙƒØ±</option>
                    <option value="Ø£Ù†Ø«Ù‰">Ø£Ù†Ø«Ù‰</option>
                </select>
            </td>
            <td><input type="number" class="form-input" data-field="age" min="0"></td>
            <td><input type="text" class="form-input" data-field="currentOccupation"></td>
            <td><input type="text" class="form-input" data-field="occupationDuration"></td>
            <td><input type="text" class="form-input" data-field="diseaseType"></td>
            <td><input type="number" class="form-input" data-field="absenceDays" min="0"></td>
            <td>
                <select class="form-input" data-field="result">
                    <option value="">Ø§Ø®ØªØ±</option>
                    <option value="ØªØ­Øª Ø§Ù„Ø¹Ù„Ø§Ø¬">ØªØ­Øª Ø§Ù„Ø¹Ù„Ø§Ø¬</option>
                    <option value="Ø´ÙØ§Ø¡ Ø¨Ø¯ÙˆÙ† Ø¹Ø¬Ø²">Ø´ÙØ§Ø¡ Ø¨Ø¯ÙˆÙ† Ø¹Ø¬Ø²</option>
                    <option value="Ø´ÙØ§Ø¡ Ø¨Ø¹Ø¬Ø²">Ø´ÙØ§Ø¡ Ø¨Ø¹Ø¬Ø²</option>
                    <option value="ÙˆÙØ§Ø©">ÙˆÙØ§Ø©</option>
                </select>
            </td>
            <td><input type="text" class="form-input" data-field="notes"></td>
            <td>
                <button type="button" onclick="HalfYearlyStatistics.removeOccupationalDiseaseRow(${index})" class="btn-icon btn-icon-danger">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
        tbody.appendChild(newRow);
        this.updateOccupationalDiseaseRowNumbers();
    },

    removeOccupationalDiseaseRow(index) {
        const tbody = document.getElementById('occupational-diseases-table-body');
        if (!tbody) return;
        
        const row = tbody.querySelector(`tr[data-index="${index}"]`);
        if (row) {
            row.remove();
            this.updateOccupationalDiseaseRowNumbers();
        }
    },

    updateOccupationalDiseaseRowNumbers() {
        const tbody = document.getElementById('occupational-diseases-table-body');
        if (!tbody) return;
        
        const rows = tbody.querySelectorAll('tr');
        rows.forEach((row, index) => {
            row.setAttribute('data-index', index);
            const firstCell = row.querySelector('td:first-child');
            if (firstCell) firstCell.textContent = index + 1;
            
            const deleteBtn = row.querySelector('button[onclick]');
            if (deleteBtn) {
                deleteBtn.setAttribute('onclick', `HalfYearlyStatistics.removeOccupationalDiseaseRow(${index})`);
            }
        });
    },

    // ===== Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø­ÙˆØ§Ø¯Ø« Ø§Ù„Ø¬Ø³ÙŠÙ…Ø© =====
    async renderSeriousAccidentsForm() {
        const data = this.getFormData('seriousAccidents');
        
        return `
            <div class="mt-6 border-t pt-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold">Ø¥Ø­ØµØ§Ø¦ÙŠØ© Ø§Ù„Ø­ÙˆØ§Ø¯Ø« Ø§Ù„Ø¬Ø³ÙŠÙ…Ø© - Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø­ØµØ§Ø¦ÙŠ Ø±Ù‚Ù… (4)</h3>
                    <div class="flex gap-2">
                        <button id="save-statistics-btn" class="btn-primary">
                            <i class="fas fa-save ml-2"></i>Ø­ÙØ¸
                        </button>
                        <button id="export-statistics-pdf-btn" class="btn-success">
                            <i class="fas fa-file-pdf ml-2"></i>ØªØµØ¯ÙŠØ± PDF
                        </button>
                        <button id="print-statistics-btn" class="btn-secondary">
                            <i class="fas fa-print ml-2"></i>Ø·Ø¨Ø§Ø¹Ø©
                        </button>
                    </div>
                </div>
                
                <form id="serious-accidents-form" class="space-y-6">
                    <!-- Header Section -->
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø¹Ù† Ø§Ù„ÙØªØ±Ø© Ù…Ù† *</label>
                                <input type="date" id="period-from" required class="form-input"
                                    value="${data?.periodFrom || ''}">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø¥Ù„Ù‰ *</label>
                                <input type="date" id="period-to" required class="form-input"
                                    value="${data?.periodTo || ''}">
                            </div>
                        </div>
                    </div>

                    <!-- Establishment Information -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø´Ø£Ø© *</label>
                            <input type="text" id="establishment-name" required class="form-input"
                                value="${data?.establishmentName || ''}" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø´Ø£Ø©">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
                            <input type="text" id="address" class="form-input"
                                value="${data?.address || ''}" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù†Ø´Ø£Ø©">
                        </div>
                    </div>

                    <!-- Accidents Table -->
                    <div class="bg-white border border-gray-200 rounded-lg p-4">
                        <h4 class="font-bold mb-3">Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­ÙˆØ§Ø¯Ø« Ø§Ù„Ø¬Ø³ÙŠÙ…Ø©</h4>
                        <div class="overflow-x-auto">
                            <table class="data-table w-full">
                                <thead>
                                    <tr>
                                        <th>Ù…</th>
                                        <th>ØªØ§Ø±ÙŠØ® ÙˆÙ‚ÙˆØ¹ Ø§Ù„Ø­Ø§Ø¯Ø«</th>
                                        <th>ÙˆÙ‚Øª ÙˆÙ‚ÙˆØ¹ Ø§Ù„Ø­Ø§Ø¯Ø«</th>
                                        <th>Ù†ÙˆØ¹ Ø§Ù„Ø­Ø§Ø¯Ø«</th>
                                        <th colspan="2">Ø§Ù„Ø®Ø³Ø§Ø¦Ø± Ø§Ù„Ø¨Ø´Ø±ÙŠØ©</th>
                                        <th colspan="3">Ù‚ÙŠÙ…Ø© Ø§Ù„Ø®Ø³Ø§Ø¦Ø± Ø§Ù„Ù…Ø§Ø¯ÙŠØ© (Ø¨Ø§Ù„Ø¬Ù†ÙŠÙ‡)</th>
                                        <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                    </tr>
                                    <tr>
                                        <th colspan="4"></th>
                                        <th>ÙˆÙØ§Ø©</th>
                                        <th>Ø¹Ø¬Ø²</th>
                                        <th>Ù…Ø¨Ø§Ù†ÙŠ</th>
                                        <th>Ø¢Ù„Ø§Øª</th>
                                        <th>Ù…ÙˆØ§Ø¯ Ø¥Ù†ØªØ§Ø¬</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="serious-accidents-table-body">
                                    ${this.renderSeriousAccidentsTable(data?.accidents || [])}
                                </tbody>
                            </table>
                        </div>
                        <button type="button" onclick="HalfYearlyStatistics.addSeriousAccidentRow()" class="btn-secondary mt-4">
                            <i class="fas fa-plus ml-2"></i>Ø¥Ø¶Ø§ÙØ© Ø­Ø§Ø¯Ø«
                        </button>
                    </div>

                    <!-- Signature Section -->
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ù…Ø¯ÙŠØ± Ø§Ù„Ø³Ù„Ø§Ù…Ø© ÙˆØ§Ù„ØµØ­Ø© Ø§Ù„Ù…Ù‡Ù†ÙŠØ©</label>
                            <input type="text" id="hse-manager" class="form-input"
                                value="${data?.hseManager || ''}" placeholder="Ø§Ø³Ù… Ù…Ø¯ÙŠØ± Ø§Ù„Ø³Ù„Ø§Ù…Ø©">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ø·Ø¨ÙŠØ¨ Ø§Ù„Ù…Ù†Ø´Ø£Ø©</label>
                            <input type="text" id="establishment-doctor" class="form-input"
                                value="${data?.establishmentDoctor || ''}" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø¨ÙŠØ¨">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø³Ø¦ÙˆÙ„</label>
                            <input type="text" id="responsible-manager" class="form-input"
                                value="${data?.responsibleManager || ''}" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø³Ø¦ÙˆÙ„">
                        </div>
                    </div>
                </form>
            </div>
        `;
    },

    renderSeriousAccidentsTable(accidents) {
        if (accidents.length === 0) {
            return '<tr><td colspan="10" class="text-center text-gray-500 py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­ÙˆØ§Ø¯Ø« Ø¬Ø³ÙŠÙ…Ø© Ù…Ø³Ø¬Ù„Ø©</td></tr>';
        }
        return accidents.map((accident, index) => `
            <tr data-index="${index}">
                <td>${index + 1}</td>
                <td><input type="date" class="form-input" value="${accident.accidentDate || ''}" data-field="accidentDate"></td>
                <td><input type="time" class="form-input" value="${accident.accidentTime || ''}" data-field="accidentTime"></td>
                <td><input type="text" class="form-input" value="${Utils.escapeHTML(accident.accidentType || '')}" data-field="accidentType"></td>
                <td><input type="number" class="form-input" value="${accident.deaths || 0}" data-field="deaths" min="0"></td>
                <td><input type="number" class="form-input" value="${accident.disabilities || 0}" data-field="disabilities" min="0"></td>
                <td><input type="number" class="form-input" value="${accident.buildingsLoss || 0}" data-field="buildingsLoss" min="0"></td>
                <td><input type="number" class="form-input" value="${accident.machineryLoss || 0}" data-field="machineryLoss" min="0"></td>
                <td><input type="number" class="form-input" value="${accident.productionLoss || 0}" data-field="productionLoss" min="0"></td>
                <td>
                    <button type="button" onclick="HalfYearlyStatistics.removeSeriousAccidentRow(${index})" class="btn-icon btn-icon-danger">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    },

    addSeriousAccidentRow() {
        const tbody = document.getElementById('serious-accidents-table-body');
        if (!tbody) return;
        
        const newRow = document.createElement('tr');
        const index = tbody.querySelectorAll('tr').length;
        newRow.setAttribute('data-index', index);
        newRow.innerHTML = `
            <td>${index + 1}</td>
            <td><input type="date" class="form-input" data-field="accidentDate"></td>
            <td><input type="time" class="form-input" data-field="accidentTime"></td>
            <td><input type="text" class="form-input" data-field="accidentType"></td>
            <td><input type="number" class="form-input" data-field="deaths" value="0" min="0"></td>
            <td><input type="number" class="form-input" data-field="disabilities" value="0" min="0"></td>
            <td><input type="number" class="form-input" data-field="buildingsLoss" value="0" min="0"></td>
            <td><input type="number" class="form-input" data-field="machineryLoss" value="0" min="0"></td>
            <td><input type="number" class="form-input" data-field="productionLoss" value="0" min="0"></td>
            <td>
                <button type="button" onclick="HalfYearlyStatistics.removeSeriousAccidentRow(${index})" class="btn-icon btn-icon-danger">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
        tbody.appendChild(newRow);
        this.updateSeriousAccidentRowNumbers();
    },

    removeSeriousAccidentRow(index) {
        const tbody = document.getElementById('serious-accidents-table-body');
        if (!tbody) return;
        
        const row = tbody.querySelector(`tr[data-index="${index}"]`);
        if (row) {
            row.remove();
            this.updateSeriousAccidentRowNumbers();
        }
    },

    updateSeriousAccidentRowNumbers() {
        const tbody = document.getElementById('serious-accidents-table-body');
        if (!tbody) return;
        
        const rows = tbody.querySelectorAll('tr');
        rows.forEach((row, index) => {
            row.setAttribute('data-index', index);
            const firstCell = row.querySelector('td:first-child');
            if (firstCell) firstCell.textContent = index + 1;
            
            const deleteBtn = row.querySelector('button[onclick]');
            if (deleteBtn) {
                deleteBtn.setAttribute('onclick', `HalfYearlyStatistics.removeSeriousAccidentRow(${index})`);
            }
        });
    },

    // ===== Ù…Ù„Ø­Ù‚ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ© =====
    async renderStatisticsAppendixForm() {
        const data = this.getFormData('statisticsAppendix');
        
        return `
            <div class="mt-6 border-t pt-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold">Ù…Ù„Ø­Ù‚ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ© - Ø­Ø³Ø§Ø¨Ø§Øª Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªÙƒØ±Ø§Ø± ÙˆØ§Ù„Ø´Ø¯Ø©</h3>
                    <div class="flex gap-2">
                        <button id="save-statistics-btn" class="btn-primary">
                            <i class="fas fa-save ml-2"></i>Ø­ÙØ¸
                        </button>
                        <button id="export-statistics-pdf-btn" class="btn-success">
                            <i class="fas fa-file-pdf ml-2"></i>ØªØµØ¯ÙŠØ± PDF
                        </button>
                        <button id="print-statistics-btn" class="btn-secondary">
                            <i class="fas fa-print ml-2"></i>Ø·Ø¨Ø§Ø¹Ø©
                        </button>
                    </div>
                </div>
                
                <form id="statistics-appendix-form" class="space-y-6">
                    <!-- Input Data -->
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                        <h4 class="font-bold mb-3">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ø®Ù„Ø©</h4>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ø§Ù…Ù„ÙŠÙ† *</label>
                                <input type="number" id="num-workers" required class="form-input"
                                    value="${data?.numWorkers || 0}" min="0">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø£ÙŠØ§Ù… 6 Ø£Ø´Ù‡Ø±</label>
                                <input type="number" id="days-6-months" class="form-input"
                                    value="${data?.days6Months || 180}" min="0">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„Ø¹Ø·Ù„Ø§Øª Ø§Ù„Ø±Ø³Ù…ÙŠØ©</label>
                                <input type="number" id="official-holidays" class="form-input"
                                    value="${data?.officialHolidays || 0}" min="0">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„Ø¹Ø·Ù„Ø§Øª Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©</label>
                                <input type="number" id="weekly-holidays" class="form-input"
                                    value="${data?.weeklyHolidays || 0}" min="0">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª</label>
                                <input type="number" id="total-leaves" class="form-input"
                                    value="${data?.totalLeaves || 0}" min="0">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø¹Ø¯Ø¯ Ø³Ø§Ø¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…</label>
                                <input type="number" id="hours-per-day" class="form-input"
                                    value="${data?.hoursPerDay || 8}" min="0">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø¹Ø¯Ø¯ Ø§Ù„Ø¥ØµØ§Ø¨Ø§Øª</label>
                                <input type="number" id="num-injuries" class="form-input"
                                    value="${data?.numInjuries || 0}" min="0">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Ø£ÙŠØ§Ù… Ø§Ù„Ø§Ù†Ù‚Ø·Ø§Ø¹</label>
                                <input type="number" id="days-interruption" class="form-input"
                                    value="${data?.daysInterruption || 0}" min="0">
                            </div>
                        </div>
                    </div>

                    <!-- Calculated Results -->
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <h4 class="font-bold mb-3">Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø­Ø³ÙˆØ¨Ø©</h4>
                        <div class="space-y-4">
                            <div class="bg-white p-3 rounded border">
                                <h5 class="font-semibold mb-2">Ø£ÙˆÙ„Ø§Ù‹: Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„ÙƒÙ„ÙŠØ© Ø®Ù„Ø§Ù„ 6 Ø£Ø´Ù‡Ø±</h5>
                                <p class="text-sm text-gray-600 mb-1">Ø£ÙŠØ§Ù… 6 Ø£Ø´Ù‡Ø± - (Ø§Ù„Ø¹Ø·Ù„Ø§Øª Ø§Ù„Ø±Ø³Ù…ÙŠØ© + Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©) Ã— Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ø§Ù…Ù„ÙŠÙ†</p>
                                <p class="text-lg font-bold text-blue-600" id="total-days-output">${this.calculateTotalDays(data) || '0 ÙŠÙˆÙ…Ø§Ù‹'}</p>
                            </div>
                            <div class="bg-white p-3 rounded border">
                                <h5 class="font-semibold mb-2">Ø«Ø§Ù†ÙŠØ§Ù‹: Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„ÙØ¹Ù„ÙŠØ©</h5>
                                <p class="text-sm text-gray-600 mb-1">Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„ÙƒÙ„ÙŠØ© - Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¬Ø§Ø²Ø§Øª ÙˆØ§Ù„Ø£Ø°ÙˆÙ†Ø§Øª</p>
                                <p class="text-lg font-bold text-blue-600" id="actual-days-output">${this.calculateActualDays(data) || '0 ÙŠÙˆÙ…Ø§Ù‹'}</p>
                            </div>
                            <div class="bg-white p-3 rounded border">
                                <h5 class="font-semibold mb-2">Ø«Ø§Ù„Ø«Ø§Ù‹: Ù…ØªÙˆØ³Ø· Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„ÙØ¹Ù„ÙŠØ© Ù„Ù„Ø¹Ø§Ù…Ù„ Ø§Ù„ÙˆØ§Ø­Ø¯</h5>
                                <p class="text-sm text-gray-600 mb-1">Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„ÙØ¹Ù„ÙŠØ© Ã· Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ø§Ù…Ù„ÙŠÙ†</p>
                                <p class="text-lg font-bold text-blue-600" id="avg-days-output">${this.calculateAvgDays(data) || '0 ÙŠÙˆÙ…Ø§Ù‹'}</p>
                            </div>
                            <div class="bg-white p-3 rounded border">
                                <h5 class="font-semibold mb-2">Ø±Ø§Ø¨Ø¹Ø§Ù‹: Ù…ØªÙˆØ³Ø· Ø§Ù„Ø³Ø§Ø¹Ø§Øª Ø§Ù„ÙØ¹Ù„ÙŠØ© Ù„Ù„Ø¹Ø§Ù…Ù„ Ø§Ù„ÙˆØ§Ø­Ø¯</h5>
                                <p class="text-sm text-gray-600 mb-1">Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„ÙØ¹Ù„ÙŠØ© Ã— Ø¹Ø¯Ø¯ Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„ Ù„Ù„ÙŠÙˆÙ… Ø§Ù„ÙˆØ§Ø­Ø¯ Ã· Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„ÙƒÙ„ÙŠØ©</p>
                                <p class="text-lg font-bold text-blue-600" id="avg-hours-output">${this.calculateAvgHours(data) || '0 Ø³Ø§Ø¹Ø©'}</p>
                            </div>
                            <div class="bg-white p-3 rounded border">
                                <h5 class="font-semibold mb-2">Ø®Ø§Ù…Ø³Ø§Ù‹: Ù…Ø¹Ø¯Ù„ ØªÙƒØ±Ø§Ø± Ø§Ù„Ø¥ØµØ§Ø¨Ø©</h5>
                                <p class="text-sm text-gray-600 mb-1">Ø¹Ø¯Ø¯ Ø§Ù„Ø¥ØµØ§Ø¨Ø§Øª Ã— Ù…Ù„ÙŠÙˆÙ† Ã· (Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ø§Ù…Ù„ÙŠÙ† Ã— Ø¹Ø¯Ø¯ Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„ÙŠÙˆÙ…ÙŠ Ã— Ø¹Ø¯Ø¯ Ø£ÙŠØ§Ù… Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„ÙØ¹Ù„ÙŠØ©)</p>
                                <p class="text-lg font-bold text-blue-600" id="frequency-rate-output">${this.calculateFrequencyRate(data) || '0 Ø¥ØµØ§Ø¨Ø© Ù„ÙƒÙ„ Ù…Ù„ÙŠÙˆÙ† Ø³Ø§Ø¹Ø© Ø¹Ù…Ù„'}</p>
                            </div>
                            <div class="bg-white p-3 rounded border">
                                <h5 class="font-semibold mb-2">Ø³Ø§Ø¯Ø³Ø§Ù‹: Ù…Ø¹Ø¯Ù„ Ø´Ø¯Ø© Ø§Ù„Ø¥ØµØ§Ø¨Ø©</h5>
                                <p class="text-sm text-gray-600 mb-1">Ø¹Ø¯Ø¯ Ø£ÙŠØ§Ù… Ø§Ù„Ø§Ù†Ù‚Ø·Ø§Ø¹ Ã— Ù…Ù„ÙŠÙˆÙ† Ã· (Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ø§Ù…Ù„ÙŠÙ† Ã— Ø¹Ø¯Ø¯ Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„ÙŠÙˆÙ…ÙŠ Ã— Ø¹Ø¯Ø¯ Ø£ÙŠØ§Ù… Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„ÙØ¹Ù„ÙŠØ©)</p>
                                <p class="text-lg font-bold text-blue-600" id="severity-rate-output">${this.calculateSeverityRate(data) || '0 ÙŠÙˆÙ… Ù„ÙƒÙ„ Ù…Ù„ÙŠÙˆÙ† Ø³Ø§Ø¹Ø© Ø¹Ù…Ù„'}</p>
                            </div>
                        </div>
                    </div>

                    <!-- Signature Section -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ù…Ø³Ø¦ÙˆÙ„ Ø§Ù„Ø³Ù„Ø§Ù…Ø© ÙˆØ§Ù„ØµØ­Ø© Ø§Ù„Ù…Ù‡Ù†ÙŠØ©</label>
                            <input type="text" id="safety-officer" class="form-input"
                                value="${data?.safetyOfficer || ''}" placeholder="Ø§Ø³Ù… Ù…Ø³Ø¦ÙˆÙ„ Ø§Ù„Ø³Ù„Ø§Ù…Ø©">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø³Ø¦ÙˆÙ„</label>
                            <input type="text" id="responsible-manager" class="form-input"
                                value="${data?.responsibleManager || ''}" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø³Ø¦ÙˆÙ„">
                        </div>
                    </div>
                </form>
            </div>
        `;
    },

    calculateTotalDays(data) {
        const numWorkers = parseInt(data?.numWorkers) || 0;
        const days6Months = parseInt(data?.days6Months) || 180;
        const officialHolidays = parseInt(data?.officialHolidays) || 0;
        const weeklyHolidays = parseInt(data?.weeklyHolidays) || 0;
        const total = (days6Months - (officialHolidays + weeklyHolidays)) * numWorkers;
        return total.toFixed(0) + ' ÙŠÙˆÙ…Ø§Ù‹';
    },

    calculateActualDays(data) {
        const totalDays = this.parseDays(this.calculateTotalDays(data));
        const totalLeaves = parseInt(data?.totalLeaves) || 0;
        const actual = totalDays - totalLeaves;
        return actual.toFixed(0) + ' ÙŠÙˆÙ…Ø§Ù‹';
    },

    calculateAvgDays(data) {
        const actualDays = this.parseDays(this.calculateActualDays(data));
        const numWorkers = parseInt(data?.numWorkers) || 0;
        if (numWorkers === 0) return '0 ÙŠÙˆÙ…Ø§Ù‹';
        const avg = actualDays / numWorkers;
        return avg.toFixed(2) + ' ÙŠÙˆÙ…Ø§Ù‹';
    },

    calculateAvgHours(data) {
        const actualDays = this.parseDays(this.calculateActualDays(data));
        const totalDays = this.parseDays(this.calculateTotalDays(data));
        const hoursPerDay = parseInt(data?.hoursPerDay) || 8;
        if (totalDays === 0) return '0 Ø³Ø§Ø¹Ø©';
        const avg = (actualDays * hoursPerDay) / totalDays;
        return avg.toFixed(2) + ' Ø³Ø§Ø¹Ø©';
    },

    calculateFrequencyRate(data) {
        const numInjuries = parseInt(data?.numInjuries) || 0;
        const numWorkers = parseInt(data?.numWorkers) || 0;
        const hoursPerDay = parseInt(data?.hoursPerDay) || 8;
        const actualDays = this.parseDays(this.calculateActualDays(data));
        const denominator = numWorkers * hoursPerDay * actualDays;
        if (denominator === 0) return '0 Ø¥ØµØ§Ø¨Ø© Ù„ÙƒÙ„ Ù…Ù„ÙŠÙˆÙ† Ø³Ø§Ø¹Ø© Ø¹Ù…Ù„';
        const rate = (numInjuries * 1000000) / denominator;
        return rate.toFixed(2) + ' Ø¥ØµØ§Ø¨Ø© Ù„ÙƒÙ„ Ù…Ù„ÙŠÙˆÙ† Ø³Ø§Ø¹Ø© Ø¹Ù…Ù„';
    },

    calculateSeverityRate(data) {
        const daysInterruption = parseInt(data?.daysInterruption) || 0;
        const numWorkers = parseInt(data?.numWorkers) || 0;
        const hoursPerDay = parseInt(data?.hoursPerDay) || 8;
        const actualDays = this.parseDays(this.calculateActualDays(data));
        const denominator = numWorkers * hoursPerDay * actualDays;
        if (denominator === 0) return '0 ÙŠÙˆÙ… Ù„ÙƒÙ„ Ù…Ù„ÙŠÙˆÙ† Ø³Ø§Ø¹Ø© Ø¹Ù…Ù„';
        const rate = (daysInterruption * 1000000) / denominator;
        return rate.toFixed(2) + ' ÙŠÙˆÙ… Ù„ÙƒÙ„ Ù…Ù„ÙŠÙˆÙ† Ø³Ø§Ø¹Ø© Ø¹Ù…Ù„';
    },

    parseDays(daysString) {
        if (!daysString) return 0;
        const match = daysString.match(/(\d+(?:\.\d+)?)/);
        return match ? parseFloat(match[1]) : 0;
    }
};

